<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>

<body>
    <script type="module">

        import { getState, setState } from "../../lib/es6_global/src/core/StateSystem.js";
        import { stateData } from "../../lib/es6_global/src/core/StateData.js";


        import { setMainConfig } from "../../lib/es6_global/src/core/Main.js";

        import { startDirector } from "../../lib/es6_global/src/core/Director.js";

        import { createBoxGeometry, setBoxGeometryConfigData } from "../../lib/es6_global/src/component/geometry/BoxGeometry.js";


        import { createMeshRenderer } from "../../lib/es6_global/src/component/renderer/MeshRenderer.js";

        import { createBasicMaterial } from "../../lib/es6_global/src/component/material/BasicMaterial.js";


        import { setTransformParent, getTransformPosition, getTransformLocalPosition, setTransformLocalPosition, setTransformPosition } from "../../lib/es6_global/src/component/transform/Transform.js";


        import { setCameraControllerPerspectiveCamera, createCameraController } from "../../lib/es6_global/src/component/cameraController/CameraController.js";
        import { setPerspectiveCameraNear, setPerspectiveCameraFar, setPerspectiveCameraFovy, setPerspectiveCameraAspect } from "../../lib/es6_global/src/component/cameraController/PerspectiveCamera.js";


        import { getGameObjectTransformComponent, addGameObjectCameraControllerComponent, addGameObjectMaterialComponent, addGameObjectGeometryComponent, addGameObjectMeshRendererComponent, createGameObject } from "../../lib/es6_global/src/core/gameObject/GameObject.js";


        window.onload = function () {
            var state = setMainConfig({
                isTest: false
            });

            initSample(state);



            function initSample(state) {
                var [state, box1] = createBox(state);
                var [state, box2] = createBox(state);

                var boxes = [];
                var state$ = state;
                for (let i = 0; i < 5000; i++) {
                    var [state$, box] = createBox(state$);
                    boxes.push(box);
                }

                state = state$;


                var transform = getGameObjectTransformComponent(box1, state);

                state = setTransformLocalPosition(transform, [20, 0, 0], state);




                var [state, camera] = createCamera(state);

                // setData(boxes);
                state = setParent(boxes, state);

                startDirector(state);
            }

            let _getRandom = function (num) {
                return Math.floor(Math.random() * num);
            }

            let _setData = (boxes) => {
                var state = getState(stateData);
                boxes.forEach(function (box) {
                    var transform = getGameObjectTransformComponent(box, state);


                    var pos = getTransformPosition(transform, state);
                    var localPos = getTransformLocalPosition(transform, state);


                    // var state$ = state;



                    if (pos[0] >= 500) {
                        state = setTransformLocalPosition(transform, [100, localPos[1], localPos[2]], state);

                    }
                    else if (pos[0] < 500) {
                        state = setTransformPosition(transform, [pos[0] + 10, pos[1], pos[2]], state);
                    }
                });

                setState(stateData, state);
            };

            function setData(boxes) {
                setInterval(() => _setData(boxes), 16);
            };

            function getRandomParentIndex(num) {
                return Math.floor(Math.random() * num);
            }


            function setParent(boxes, state) {
                // var state = getState(stateData);

                for (var i = 1, len = 10; i < len; i++) {
                    var box = boxes[i];

                    state = setTransformParent(boxes[i - 1], box, state)
                }

                // setState(stateData, state);

                setInterval(() => {
                    var state = getState(stateData);

                    var box = boxes[i];

                    state = setTransformParent(boxes[getRandomParentIndex(10)], box, state);

                    setState(stateData, state);

                    _setData(boxes);
                }, 16);

                return state
            }


            function createBox(state) {
                var [state, material] = createBasicMaterial(state);

                var [state, meshRenderer] = createMeshRenderer(state);

                var [state, obj] = createGameObject(state);

                state = addGameObjectMaterialComponent(obj, material, state);
                state = addGameObjectMeshRendererComponent(obj, meshRenderer, state);



                var [state, geometry] = createBoxGeometry(state);

                state = setBoxGeometryConfigData(geometry, {
                    width: 5,
                    height: 5,
                    depth: 5
                }, state);



                state = addGameObjectGeometryComponent(obj, geometry, state);

                return [state, obj];

            }

            function createCamera(state) {

                var [state, cameraController] = createCameraController(state);

                state = setPerspectiveCameraNear(cameraController, 0.1, state);
                state = setPerspectiveCameraFar(cameraController, 2000, state);
                state = setPerspectiveCameraFovy(cameraController, 60, state);
                state = setPerspectiveCameraAspect(cameraController, 1.0, state);


                state = setCameraControllerPerspectiveCamera(cameraController, state);



                var [state, obj] = createGameObject(state);

                state = addGameObjectCameraControllerComponent(obj, cameraController, state);

                var transform = getGameObjectTransformComponent(obj, state);

                state = setTransformLocalPosition(transform, [0, 0, 1500], state);

                return [state, obj];
            }
        }
    </script>
</body>

</html>