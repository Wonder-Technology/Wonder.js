<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>

<body>
    <script type="module">

        import { scheduleLoop } from "../../lib/es6_global/src/core/api/Scheduler.js";


        import { setMainConfig } from "../../lib/es6_global/src/core/api/Main.js";

        import { startDirector } from "../../lib/es6_global/src/core/api/Director.js";

        import { createBoxGeometry, setBoxGeometryConfigData } from "../../lib/es6_global/src/ecs/component/api/geometry/BoxGeometry.js";




        // import { setGeometryGroup } from "../../lib/es6_global/src/ecs/component/geometry/Geometry.js";

        import { createMeshRenderer } from "../../lib/es6_global/src/ecs/component/api/meshRenderer/MeshRenderer.js";

        import { createBasicMaterial } from "../../lib/es6_global/src/ecs/component/api/material/BasicMaterial.js";


        import { setTransformParent, getTransformLocalPositionTuple, getTransformPositionTypeArray, getTransformPositionTuple, getTransformLocalPositionTypeArray, setTransformLocalPositionByTypeArray, setTransformLocalPositionByTuple, setTransformPositionByTuple, setTransformPositionByTypeArray } from "../../lib/es6_global/src/ecs/component/api/transform/Transform.js";


        import { setCameraControllerPerspectiveCamera, createCameraController } from "../../lib/es6_global/src/ecs/component/api/cameraController/CameraController.js";
        import { setPerspectiveCameraNear, setPerspectiveCameraFar, setPerspectiveCameraFovy, setPerspectiveCameraAspect } from "../../lib/es6_global/src/ecs/component/api/cameraController/PerspectiveCamera.js";


        import { markModelMatrixIsStatic, getObjectInstanceList, createSourceInstance, createInstance } from "../../lib/es6_global/src/ecs/component/api/instance/SourceInstance.js";



        import { addGameObjectSourceInstanceComponent, getGameObjectSourceInstanceComponent, cloneGameObject, batchDisposeGameObject, disposeGameObject, initGameObject, getGameObjectTransformComponent, addGameObjectCameraControllerComponent, addGameObjectMaterialComponent, addGameObjectGeometryComponent, addGameObjectMeshRendererComponent, createGameObject } from "../../lib/es6_global/src/ecs/admin/api/GameObject.js";

        window.onload = function () {
            var state = setMainConfig({
                isTest: false,
                //                 bufferConfig:{
                // geometryDataBufferCount:50000,
                // basicMaterialDataBufferCount:50000,
                // transformDataBufferCount:50000,
                // meshRendererDataBufferCount:50000
                // // geometryDataBufferCount:200,
                //                 }
            });

            initSample(state);


            function createBoxes(count, state) {
                var boxes = [];
                // var state$ = state;

                var [state, box] = createBox(state);


                // for (let i = 0; i < count; i++) {
                //     // var [state$, box] = createBox(state$);


                //     var [state, newBoxes] = cloneGameObject(box, 2000, state);

                //     boxes.push(box);
                // }

                // return [state, boxes];



                var [state, newBoxes] = cloneGameObject(box, count, state);


                let flatten = (arr) => {
                    return arr.reduce((a, b) => {
                        let arr = a.concat(b);
                        return arr;
                    }, []);
                };
                newBoxes = flatten(newBoxes);

                return [state, newBoxes];

            }


            function createBoxesWithoutClone(count, state) {
                var boxes = [];
                // var state$ = state;

                // var [state, box] = createBox(state);


                for (let i = 0; i < count; i++) {
                    var [state, box] = createBox(state);


                    // var [state, newBoxes] = cloneGameObject(box, 2000, state);

                    boxes.push(box);
                }

                return [state, boxes];
            }



            function setPosition(boxes, state) {
                var playgroundSize = 500;

                for (let i = 0, len = boxes.length; i < len; i++) {
                    let box = boxes[i];
                    // state = initGameObject(box, state);


                    var transform = getGameObjectTransformComponent(box, state);


                    // var pos = getTransformPositionTuple(transform, state);
                    var localPos = getTransformLocalPositionTuple(transform, state);

                    state = setTransformLocalPositionByTuple(transform, [Math.random() * 2 * playgroundSize - playgroundSize, Math.random() * 2 * playgroundSize - playgroundSize, Math.random() * 2 * playgroundSize - playgroundSize], state);


                    // console.log(getTransformLocalPositionTuple(transform, state));
                }

                return [state, boxes];
            }

            function initSample(state) {
                // var [state, boxes] = createBoxes(19997, state);
                var [state, boxes] = createBoxes(2, state);


                var [state, boxes] = setPosition(boxes, state);




                var [state, camera] = createCamera(state);

                // state = setData(boxes, state);
                // state = setParent(boxes, state);
                state = createAndDisposeGameObjects(boxes, state);

                startDirector(state);
            }

            let _getRandom = function (num) {
                return Math.floor(Math.random() * num);
            }

            let _setData = (boxes, state) => {
                boxes.forEach(function (box) {
                    var transform = getGameObjectTransformComponent(box, state);


                    var pos = getTransformPositionTuple(transform, state);
                    var localPos = getTransformLocalPositionTuple(transform, state);

                    if (pos[0] >= 500) {
                        state = setTransformLocalPositionByTuple(transform, [100, localPos[1], localPos[2]], state);

                    }
                    else if (pos[0] < 500) {
                        state = setTransformPositionByTuple(transform, [pos[0] + 10, pos[1], pos[2]], state);
                    }
                });

                return state;
            };

            function setData(boxes, state) {
                return scheduleLoop((elapsed, state) => _setData(boxes, state), state)
            };

            function getRandomParentIndex(num) {
                return Math.floor(Math.random() * num);
            }


            function setParent(boxes, state) {
                for (var i = 1, len = 10; i < len; i++) {
                    var box = boxes[i];

                    state = setTransformParent(boxes[i - 1], box, state)
                }

                return scheduleLoop((elapsed, state) => {
                    var box = boxes[i];

                    state = setTransformParent(boxes[getRandomParentIndex(10)], box, state);

                    return _setData(boxes, state);
                }, state)
            }

            window.newBoxes$ = null;

            function createAndDisposeGameObjects(boxes, state) {
                // var state = boxes.reduce((state, box) => {
                //     return disposeGameObject(box, state);
                // }, state);

                // window.newBoxes$ = boxes;
                // window.boxes = boxes.slice(0, 1000);
                window.sourceBox = boxes[0];
                window.boxes = [];

                // var index = 0;

                return scheduleLoop((elapsed, state) => {

                    // var state = window.boxes.reduce((state, box) => {
                    //     // if(index > 1000){
                    //     //     return state;
                    //     // }
                    //     // index += 1;
                    //     return disposeGameObject(box, state);
                    // }, state);


                    // var state = state;

                    for(let i = 0, len = window.boxes.length; i < len; i++){
                        let box = window.boxes[i];
                        state = disposeGameObject(box, state);
                    }

                    // var state = batchDisposeGameObject(window.boxes, state);


                    // var state = window.boxes.reduce((state, box) => {
                    //     // if(index > 1000){
                    //     //     return state;
                    //     // }
                    //     // index += 1;
                    //     return disposeGameObject(box, state);
                    // }, state);

                    // todo fix!

                    var [state, newBoxes] = createBoxesWithoutClone(2000, state);

                    // var [state, newBoxes] = cloneGameObject(window.sourceBox, 5000, state);
                    // let flatten = (arr) => {
                    //     return arr.reduce((a, b) => {
                    //         let arr = a.concat(b);
                    //         return arr;
                    //     }, []);
                    // };
                    // newBoxes = flatten(newBoxes);


                    var [state, newBoxes] = setPosition(newBoxes, state);



                    window.boxes = newBoxes;

                    // return newBoxes.reduce((state, box) => {
                    //     return initGameObject(box, state);
                    // }, state);



                    for (let i = 0, len = newBoxes.length; i < len; i++) {
                        let box = newBoxes[i];
                        state = initGameObject(box, state);
                    }

                    return state;

                }, state)
            }

            function createBox(state) {
                var [state, material] = createBasicMaterial(state);

                var [state, meshRenderer] = createMeshRenderer(state);

                var [state, obj] = createGameObject(state);

                state = addGameObjectMaterialComponent(obj, material, state);
                state = addGameObjectMeshRendererComponent(obj, meshRenderer, state);


                var [state, geometry] = createBoxGeometry(state);

                state = setBoxGeometryConfigData(geometry, {
                    width: 5,
                    height: 5,
                    depth: 5
                }, state);

                // state = setGeometryGroup(geometry, 1, state);



                state = addGameObjectGeometryComponent(obj, geometry, state);

                return [state, obj];

            }

            function createCamera(state) {

                var [state, cameraController] = createCameraController(state);

                state = setPerspectiveCameraNear(cameraController, 0.1, state);
                state = setPerspectiveCameraFar(cameraController, 2000, state);
                state = setPerspectiveCameraFovy(cameraController, 60, state);
                state = setPerspectiveCameraAspect(cameraController, 1.0, state);


                state = setCameraControllerPerspectiveCamera(cameraController, state);



                var [state, obj] = createGameObject(state);

                state = addGameObjectCameraControllerComponent(obj, cameraController, state);

                var transform = getGameObjectTransformComponent(obj, state);

                state = setTransformLocalPositionByTuple(transform, [0, 0, 1500], state);

                return [state, obj];
            }
        }
    </script>
</body>

</html>