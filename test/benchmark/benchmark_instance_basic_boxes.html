<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>

<body>
    <script type="module">
        import { scheduleLoop } from "../../lib/es6_global/src/core/scheduler/Scheduler.js";


        import { setMainConfig } from "../../lib/es6_global/src/core/Main.js";

        import { startDirector } from "../../lib/es6_global/src/core/Director.js";

        import { createBoxGeometry, setBoxGeometryConfigData } from "../../lib/es6_global/src/component/geometry/BoxGeometry.js";




        // import { setGeometryGroup } from "../../lib/es6_global/src/component/geometry/Geometry.js";

        import { createMeshRenderer } from "../../lib/es6_global/src/component/meshRenderer/MeshRenderer.js";

        import { createBasicMaterial } from "../../lib/es6_global/src/component/material/BasicMaterial.js";


        import { setTransformParent, getTransformPositionTypeArray, getTransformPositionTuple, getTransformLocalPositionTypeArray, setTransformLocalPositionByTypeArray, setTransformLocalPositionByTuple, setTransformPositionByTuple, setTransformPositionByTypeArray } from "../../lib/es6_global/src/component/transform/Transform.js";


        import { setCameraControllerPerspectiveCamera, createCameraController } from "../../lib/es6_global/src/component/cameraController/CameraController.js";
        import { setPerspectiveCameraNear, setPerspectiveCameraFar, setPerspectiveCameraFovy, setPerspectiveCameraAspect } from "../../lib/es6_global/src/component/cameraController/PerspectiveCamera.js";


        import { markModelMatrixIsStatic, getObjectInstanceList, createSourceInstance, createInstance } from "../../lib/es6_global/src/component/instance/SourceInstance.js";



        import { addGameObjectSourceInstanceComponent, getGameObjectSourceInstanceComponent, cloneGameObject, batchDisposeGameObject, disposeGameObject, initGameObject, getGameObjectTransformComponent, addGameObjectCameraControllerComponent, addGameObjectMaterialComponent, addGameObjectGeometryComponent, addGameObjectMeshRendererComponent, createGameObject } from "../../lib/es6_global/src/core/gameObject/GameObject.js";


        window.onload = function () {
            var state = setMainConfig({
                isTest: false,
                bufferConfig: {
                    // geometryDataBufferCount:500000,
                    // basicMaterialDataBufferCount:500000,
                    // transformDataBufferCount: 500000,
                    // meshRendererDataBufferCount:500000
                    // geometryDataBufferCount:200,
                }
            });

            initSample(state);


            function createBoxes(count, state) {
                var boxes = [];

                var [state, box, objectInstanceArr] = createBox(count, state);

                boxes.push(box);

                return [state, boxes];
            }

            function createBoxesWithHierachy(count, state) {
                var boxes = [];


                var [state, box1, objectInstanceArr1] = createBox(count, state);
                var [state, box2, objectInstanceArr2] = createBox(count, state);




                var box1Transform = getGameObjectTransformComponent(box1, state);
                var box2Transform = getGameObjectTransformComponent(box2, state);



                state = setTransformParent(box1Transform, box2Transform, state);


                for (let i = 0, len = objectInstanceArr1.length; i < len; i++) {
                    let instance1 = objectInstanceArr1[i];
                    let instance2 = objectInstanceArr2[i];


                    var t1 = getGameObjectTransformComponent(instance1, state);
                    var t2 = getGameObjectTransformComponent(instance2, state);


                    state = setTransformParent(t1, t2, state);
                }



                //                     state = setTransformParent(objectInstanceArr1[0], objectInstanceArr2[0], state);


                // var t1 = getGameObjectTransformComponent(box1, state);

                //                     state = setTransformLocalPositionByTuple(t1, [50,0,0], state);


                // var t2 = getGameObjectTransformComponent(box2, state);

                //                     state = setTransformLocalPositionByTuple(t2, [100,0,0], state);


                // // var o1 = getGameObjectTransformComponent(objectInstanceArr1[0], state);

                // //                     state = setTransformLocalPositionByTuple(o1, [0,50,0], state);

                // var o2 = getGameObjectTransformComponent(objectInstanceArr2[0], state);

                //                     state = setTransformLocalPositionByTuple(o2, [0,100,0], state);



                boxes.push(box1, box2);

                return [state, boxes];
            }



            function setPosition(boxes, state) {
                var playgroundSize = 300;

                for (let i = 0, len = boxes.length; i < len; i++) {
                    let box = boxes[i];
                    // state = initGameObject(box, state);

                    let sourceInstance = getGameObjectSourceInstanceComponent(box, state);

                    let objectInstanceList = getObjectInstanceList(sourceInstance, state);



                    for (let i = 0, len = objectInstanceList.length; i < len; i++) {
                        let objectInstance = objectInstanceList[i];

                        var transform = getGameObjectTransformComponent(objectInstance, state);


                        // var pos = getTransformPositionTuple(transform, state);

                        var localPos = getTransformLocalPositionTypeArray(transform, state);

                        state = setTransformLocalPositionByTuple(transform, [Math.random() * 2 * playgroundSize - playgroundSize, Math.random() * 2 * playgroundSize - playgroundSize, Math.random() * 2 * playgroundSize - playgroundSize], state);

                        // state = setTransformLocalPositionByTuple(transform, [0,0,0], state);


                        // console.log(getTransformLocalPositionTypeArayr(transform, state));


                    }


                }

                return [state, boxes];
            }

            function initSample(state) {
                // var [state, boxes] = createBoxes(60000, state);
                var [state, boxes] = createBoxesWithHierachy(30000, state);


                var [state, boxes] = setPosition(boxes, state);




                var [state, camera] = createCamera(state);

                state = setData(boxes, state);
                // state = createAndDisposeGameObjects(boxes, state);

                startDirector(state);
            }

            let _getRandom = function (num) {
                return Math.floor(Math.random() * num);
            }

            let _setData = (boxes, state) => {
                var playgroundSize = 300;

                for (let i = 0, len = boxes.length; i < len; i++) {
                    let box = boxes[i];

                    let sourceInstance = getGameObjectSourceInstanceComponent(box, state);

                    let objectInstanceList = getObjectInstanceList(sourceInstance, state);



                    for (let i = 0, len = objectInstanceList.length; i < len; i++) {
                        let objectInstance = objectInstanceList[i];

                        var transform = getGameObjectTransformComponent(objectInstance, state);


                        var pos = getTransformPositionTuple(transform, state);

                        var localPos = getTransformLocalPositionTypeArray(transform, state);

                        if (pos[0] >= 500) {
                            state = setTransformLocalPositionByTuple(transform, [100, localPos[1], localPos[2]], state);

                        }
                        else if (pos[0] < 500) {
                            state = setTransformPositionByTuple(transform, [pos[0] + 10, pos[1], pos[2]], state);
                        }


                        // var pos = getTransformPositionTypeArray(transform, state);

                        // var localPos = getTransformLocalPositionTypeArray(transform, state);

                        // if (pos[0] >= 500) {
                        //     state = setTransformLocalPositionByTypeArray(transform, [100, localPos[1], localPos[2]], state);

                        // }
                        // else if (pos[0] < 500) {
                        //     state = setTransformPositionByTypeArray(transform, [pos[0] + 10, pos[1], pos[2]], state);
                        // }
                    }
                }

                return state;
            };

            function setData(boxes, state) {
                return scheduleLoop((elapsed, state) => _setData(boxes, state), state)
            };

            function getRandomParentIndex(num) {
                return Math.floor(Math.random() * num);
            }


            function setParent(boxes, state) {
                for (var i = 1, len = 10; i < len; i++) {
                    var box = boxes[i];

                    state = setTransformParent(boxes[i - 1], box, state)
                }

                return scheduleLoop((elapsed, state) => {
                    var box = boxes[i];

                    state = setTransformParent(boxes[getRandomParentIndex(10)], box, state);

                    return _setData(boxes, state);
                }, state)
            }

            window.newBoxes$ = null;

            function createAndDisposeGameObjects(boxes, state) {
                // var state = boxes.reduce((state, box) => {
                //     return disposeGameObject(box, state);
                // }, state);

                // window.newBoxes$ = boxes;
                // window.boxes = boxes.slice(0, 1000);
                window.sourceBox = boxes[0];
                window.boxes = [];

                // var index = 0;

                return scheduleLoop((elapsed, state) => {

                    // var state = window.boxes.reduce((state, box) => {
                    //     // if(index > 1000){
                    //     //     return state;
                    //     // }
                    //     // index += 1;
                    //     return disposeGameObject(box, state);
                    // }, state);


                    // var state = state;

                    // for(let i = 0, len = window.boxes.length; i < len; i++){
                    //     let box = window.boxes[i];
                    //     state = disposeGameObject(box, state);
                    // }

                    var state = batchDisposeGameObject(window.boxes, state);


                    // var state = window.boxes.reduce((state, box) => {
                    //     // if(index > 1000){
                    //     //     return state;
                    //     // }
                    //     // index += 1;
                    //     return disposeGameObject(box, state);
                    // }, state);


                    // var [state, newBoxes] = createBoxes(2000, state);

                    var [state, newBoxes] = cloneGameObject(window.sourceBox, 4000, state);
                    let flatten = (arr) => {
                        return arr.reduce((a, b) => {
                            let arr = a.concat(b);
                            return arr;
                        }, []);
                    };
                    newBoxes = flatten(newBoxes);


                    var [state, newBoxes] = setPosition(newBoxes, state);



                    window.boxes = newBoxes;

                    // return newBoxes.reduce((state, box) => {
                    //     return initGameObject(box, state);
                    // }, state);



                    for (let i = 0, len = newBoxes.length; i < len; i++) {
                        let box = newBoxes[i];
                        state = initGameObject(box, state);
                    }

                    return state;

                }, state)
            }

            function createBox(count, state) {
                var [state, material] = createBasicMaterial(state);

                var [state, meshRenderer] = createMeshRenderer(state);

                var [state, obj] = createGameObject(state);

                state = addGameObjectMaterialComponent(obj, material, state);
                state = addGameObjectMeshRendererComponent(obj, meshRenderer, state);



                var [state, geometry] = createBoxGeometry(state);

                state = setBoxGeometryConfigData(geometry, {
                    width: 5,
                    height: 5,
                    depth: 5
                }, state);




                state = addGameObjectGeometryComponent(obj, geometry, state);




                var [state, sourceInstance] = createSourceInstance(state);


                var state = markModelMatrixIsStatic(sourceInstance, false, state);

                // setTimeout(() => {

                //     scheduleLoop((elapsed, state) => {
                //         return markModelMatrixIsStatic(sourceInstance, false, state)
                //     }, state);

                // }, 1000);


                // setTimeout(() => {

                //     scheduleLoop((elapsed, state) => {
                //         return markModelMatrixIsStatic(sourceInstance, true, state)
                //     }, state);

                // }, 3000);



                var state =
                    addGameObjectSourceInstanceComponent(obj, sourceInstance, state);



                var objectInstanceGameObjectArr = [];

                for (let i = 0; i < count; i++) {
                    // state = initGameObject(box, state);


                    var [state, objectInstanceGameObject] =
                        createInstance(sourceInstance, state);

                    objectInstanceGameObjectArr.push(objectInstanceGameObject);
                }






                return [state, obj, objectInstanceGameObjectArr];

            }

            function createCamera(state) {

                var [state, cameraController] = createCameraController(state);

                state = setPerspectiveCameraNear(cameraController, 0.1, state);
                state = setPerspectiveCameraFar(cameraController, 2000, state);
                state = setPerspectiveCameraFovy(cameraController, 60, state);
                state = setPerspectiveCameraAspect(cameraController, 1.0, state);


                state = setCameraControllerPerspectiveCamera(cameraController, state);



                var [state, obj] = createGameObject(state);

                state = addGameObjectCameraControllerComponent(obj, cameraController, state);

                var transform = getGameObjectTransformComponent(obj, state);

                state = setTransformLocalPositionByTuple(transform, [0, 0, 1500], state);

                return [state, obj];
            }
        }
    </script>
</body>

</html>