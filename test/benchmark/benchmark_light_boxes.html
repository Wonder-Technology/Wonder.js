<!DOCTYPE html>
<html>

<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>

<body>
    <script src="../../dist/wd.js"></script>
    <script>


        window.onload = function () {
            var state = wd.setMainConfig({
                isDebug: false
            });

            wd.load("../../data/", state).then(function (state) {
                console.log("complete", state);
                initSample(state);
            });



            function createBoxes(count, state) {
                var boxes = [];

                var [state, box] = createBox(state);


                var [state, newBoxes] = wd.cloneGameObject(box, count, true, state);


                let flatten = (arr) => {
                    return arr.reduce((a, b) => {
                        let arr = a.concat(b);
                        return arr;
                    }, []);
                };
                newBoxes = flatten(newBoxes);

                return [state, newBoxes];
            }

            function createBasicBox(state) {
                var [state, material] = wd.createBasicMaterial(state);

                state = wd.setBasicMaterialColor(material, [0.0, 0.5, 0.2], state);

                var [state, meshRenderer] = wd.createMeshRenderer(state);

                var [state, obj] = wd.createGameObject(state);

                state = wd.addGameObjectBasicMaterialComponent(obj, material, state);
                state = wd.addGameObjectMeshRendererComponent(obj, meshRenderer, state);


                var [state, geometry] = wd.createBoxGeometry(state);

                state = wd.setBoxGeometryConfigData(geometry, {
                    width: 5,
                    height: 5,
                    depth: 5
                }, state);




                state = wd.addGameObjectGeometryComponent(obj, geometry, state);

                return [state, obj];

            }

            function initSample(state) {
                // var [state, box1] = createBox(state);


                // var [state, box2] = createBasicBox(state);


                // var transform = wd.getGameObjectTransformComponent(box2, state);

                // state = wd.setTransformLocalPosition(transform, [10, 0, 0], state);

                // var [state, box2] = createBox(state);

                // var [state, boxes] = createBoxes(20000, state);
                var [state, boxes] = createBoxes(1, state);


                // var [state, boxes, objectInstanceArr] = createInstanceBoxes(1, 20000, state);
                // var [state, boxes, objectInstanceArr] = createInstanceBoxesWithHierachy(10000, state);



                // var [state, boxes] = setPosition(boxes, state);
                // var [state, objectInstanceArr] = setPosition(objectInstanceArr, state);


                var [state, ambientLight] = createAmbientLight(state);
                // // var [state, directionLight] = createDirectionLight(state);
                // // var [state, directionLight] = createDirectionLight(state);
                // // var [state, directionLight] = createDirectionLight(state);
                // // var [state, directionLight] = createDirectionLight(state);


                var [state, directionLightObj] = createDirectionLight(state);


                var transform = wd.getGameObjectTransformComponent(directionLightObj, state);

                state = wd.setTransformLocalPosition(transform, [-200, 0, 200], state);





                var [state, lightObj] = createPointLight(state);


                var transform = wd.getGameObjectTransformComponent(lightObj, state);

                state = wd.setTransformLocalPosition(transform, [300, 0, 500], state);



                var [state, camera] = createCamera(state);


                // state = createAndDisposeGameObjects(boxes, state);
                // state = setInstanceData(boxes, state);
                // state = createAndDisposeSourceInstanceGameObjects(boxes, state);
                state = createAndDisposeObjectInstanceGameObjects(boxes, state);




                wd.startDirector(state);
            }




            let setInstanceData = (boxes, state) => {
                return wd.addLogicUpdateJob("updateJob1", "", function (elapsed, state) {

                    var playgroundSize = 300;

                    for (let i = 0, len = boxes.length; i < len; i++) {
                        let box = boxes[i];

                        let sourceInstance = wd.getGameObjectSourceInstanceComponent(box, state);

                        let objectInstanceArray = wd.getSourceInstanceObjectInstanceArray(sourceInstance, state);



                        for (let i = 0, len = objectInstanceArray.length; i < len; i++) {
                            let objectInstance = objectInstanceArray[i];

                            var transform = wd.getGameObjectTransformComponent(objectInstance, state);


                            var pos = wd.getTransformPosition(transform, state);

                            var localPos = wd.getTransformLocalPosition(transform, state);

                            if (pos[0] >= 500) {
                                state = wd.setTransformLocalPosition(transform, [100, localPos[1], localPos[2]], state);

                            }
                            else if (pos[0] < 500) {
                                state = wd.setTransformPosition(transform, [pos[0] + 10, pos[1], pos[2]], state);
                            }
                        }
                    }

                    return state;
                }, state);
            };



            function createInstanceBox(count, state) {
                var [state, material] = wd.createLightMaterial(state);


                state = wd.setLightMaterialDiffuseColor(material, [0.0, 0.5, 0.2], state);



                var [state, obj] = wd.createGameObject(state);

                state = wd.addGameObjectLightMaterialComponent(obj, material, state);






                // var [state, material] = wd.createBasicMaterial(state);





                // var [state, obj] = wd.createGameObject(state);

                // state = wd.addGameObjectBasicMaterialComponent(obj, material, state);







                var [state, meshRenderer] = wd.createMeshRenderer(state);


                state = wd.addGameObjectMeshRendererComponent(obj, meshRenderer, state);



                var [state, geometry] = wd.createBoxGeometry(state);

                state = wd.setBoxGeometryConfigData(geometry, {
                    width: 5,
                    height: 5,
                    depth: 5
                }, state);




                state = wd.addGameObjectGeometryComponent(obj, geometry, state);




                var [state, sourceInstance] = wd.createSourceInstance(state);


                var state = wd.markSourceInstanceModelMatrixIsStatic(sourceInstance, false, state);
                // var state = wd.markSourceInstanceModelMatrixIsStatic(sourceInstance, true, state);

                // setTimeout(() => {

                //     scheduleLoop((elapsed, state) => {
                //         return markSourceInstanceModelMatrixIsStatic(sourceInstance, false, state)
                //     }, state);

                // }, 1000);


                // setTimeout(() => {

                //     scheduleLoop((elapsed, state) => {
                //         return markSourceInstanceModelMatrixIsStatic(sourceInstance, true, state)
                //     }, state);

                // }, 3000);



                var state =
                    wd.addGameObjectSourceInstanceComponent(obj, sourceInstance, state);



                var objectInstanceGameObjectArr = [];

                for (let i = 0; i < count; i++) {
                    // state = initGameObject(box, state);


                    var [state, objectInstanceGameObject] =
                        wd.createSourceInstanceObjectInstance(sourceInstance, state);

                    objectInstanceGameObjectArr.push(objectInstanceGameObject);
                }






                return [state, obj, objectInstanceGameObjectArr];

            }


            function createInstanceBoxes(sourceInstanceGameObjectCount, objectInstanceGameObjectCount, state) {
                var boxes = [];

                for (let i = 0; i < sourceInstanceGameObjectCount; i++) {
                    var [state, box, objectInstanceArr] = createInstanceBox(objectInstanceGameObjectCount, state);

                    boxes.push(box);
                }


                return [state, boxes, objectInstanceArr];
            }



            function createInstanceBoxesWithHierachy(count, state) {
                var boxes = [];


                var [state, box1, objectInstanceArr1] = createInstanceBox(count, state);
                var [state, box2, objectInstanceArr2] = createInstanceBox(count, state);




                var box1Transform = wd.getGameObjectTransformComponent(box1, state);
                var box2Transform = wd.getGameObjectTransformComponent(box2, state);



                state = wd.setTransformParent(box1Transform, box2Transform, state);


                for (let i = 0, len = objectInstanceArr1.length; i < len; i++) {
                    let instance1 = objectInstanceArr1[i];
                    let instance2 = objectInstanceArr2[i];


                    var t1 = wd.getGameObjectTransformComponent(instance1, state);
                    var t2 = wd.getGameObjectTransformComponent(instance2, state);


                    state = wd.setTransformParent(t1, t2, state);
                }



                //                     state = setTransformParent(objectInstanceArr1[0], objectInstanceArr2[0], state);


                // var t1 = getGameObjectTransformComponent(box1, state);

                //                     state = setTransformLocalPosition(t1, [50,0,0], state);


                // var t2 = getGameObjectTransformComponent(box2, state);

                //                     state = setTransformLocalPosition(t2, [100,0,0], state);


                // // var o1 = getGameObjectTransformComponent(objectInstanceArr1[0], state);

                // //                     state = setTransformLocalPosition(o1, [0,50,0], state);

                // var o2 = getGameObjectTransformComponent(objectInstanceArr2[0], state);

                //                     state = setTransformLocalPosition(o2, [0,100,0], state);



                boxes.push(box1, box2);


                var objectInstanceArr = [];

                objectInstanceArr.concat(objectInstanceArr1, objectInstanceArr2);

                return [state, boxes, objectInstanceArr];

            }


            function createAndDisposeSourceInstanceGameObjects(boxes, state) {
                window.boxes = [];


                return wd.addLogicUpdateJob("updateJob1", "", function (elapsed, state) {
                    // for (let i = 0, len = window.boxes.length; i < len; i++) {
                    //     let box = window.boxes[i];
                    //     state = disposeGameObject(box, state);
                    // }

                    var state = wd.batchDisposeGameObject(window.boxes, state);



                    var [state, newBoxes, objectInstanceArr] = createInstanceBoxes(300, 10, state);


                    var [state, newBoxes] = setPosition(newBoxes, state);



                    window.boxes = newBoxes;



                    for (let i = 0, len = newBoxes.length; i < len; i++) {
                        let box = newBoxes[i];
                        state = wd.initGameObject(box, state);
                    }

                    return state;

                }, state)
            }



            function createAndDisposeObjectInstanceGameObjects(boxes, state) {
                window.boxes = [];


                return wd.addLogicUpdateJob("updateJob1", "", function (elapsed, state) {
                    for (let i = 0, len = window.boxes.length; i < len; i++) {
                        let box = window.boxes[i];
                        state = wd.disposeGameObject(box, state);
                    }

                    // var state = batchDisposeGameObject(window.boxes, state);



                    var [state, newBoxes, objectInstanceArr] = createInstanceBoxes(1, 5000, state);


                    var [state, newBoxes] = setPosition(newBoxes, state);



                    window.boxes = newBoxes;



                    for (let i = 0, len = newBoxes.length; i < len; i++) {
                        let box = newBoxes[i];
                        state = wd.initGameObject(box, state);
                    }

                    return state;

                }, state)
            }

            function createAndDisposeGameObjects(boxes, state) {
                window.sourceBox = boxes[0];
                window.boxes = [];



                return wd.addLogicUpdateJob("updateJob1", "", function (elapsed, state) {
                    console.log("updateJob1", elapsed);



                    // for(let i = 0, len = window.boxes.length; i < len; i++){
                    //     let box = window.boxes[i];
                    //     state = disposeGameObject(box, state);
                    // }

                    var state = wd.batchDisposeGameObject(window.boxes, state);


                    // var [state, newBoxes] = createBoxesWithoutClone(2000, state);

                    var [state, newBoxes] = wd.cloneGameObject(window.sourceBox, 5000, true, state);

                    let flatten = (arr) => {
                        return arr.reduce((a, b) => {
                            let arr = a.concat(b);
                            return arr;
                        }, []);
                    };
                    newBoxes = flatten(newBoxes);


                    var [state, newBoxes] = setPosition(newBoxes, state);



                    window.boxes = newBoxes;



                    for (let i = 0, len = newBoxes.length; i < len; i++) {
                        let box = newBoxes[i];
                        state = wd.initGameObject(box, state);
                    }

                    return state;


                }, state);




            }




            function setPosition(boxes, state) {
                var playgroundSize = 500;

                for (let i = 0, len = boxes.length; i < len; i++) {
                    let box = boxes[i];
                    // state = initGameObject(box, state);


                    var transform = wd.getGameObjectTransformComponent(box, state);


                    // var pos = getTransformPosition(transform, state);
                    var localPos = wd.getTransformLocalPosition(transform, state);

                    state = wd.setTransformLocalPosition(transform, [Math.random() * 2 * playgroundSize - playgroundSize, Math.random() * 2 * playgroundSize - playgroundSize, Math.random() * 2 * playgroundSize - playgroundSize], state);


                    // console.log(getTransformLocalPosition(transform, state));
                }

                return [state, boxes];
            }


            function createBox(state) {
                var [state, material] = wd.createLightMaterial(state);

                state = wd.setLightMaterialDiffuseColor(material, [0.0, 0.5, 0.2], state);

                var [state, meshRenderer] = wd.createMeshRenderer(state);

                var [state, obj] = wd.createGameObject(state);

                state = wd.addGameObjectLightMaterialComponent(obj, material, state);
                state = wd.addGameObjectMeshRendererComponent(obj, meshRenderer, state);


                var [state, geometry] = wd.createBoxGeometry(state);

                state = wd.setBoxGeometryConfigData(geometry, {
                    width: 5,
                    height: 5,
                    depth: 5
                }, state);




                state = wd.addGameObjectGeometryComponent(obj, geometry, state);

                return [state, obj];

            }


            function createAmbientLight(state) {
                var [state, light] = wd.createAmbientLight(state);

                var state = wd.setAmbientLightColor(light, [1.0, 1.0, 1.0], state);



                var [state, obj] = wd.createGameObject(state);



                state = wd.addGameObjectAmbientLightComponent(obj, light, state);

                return [state, obj];
            }

            function createDirectionLight(state) {
                var [state, light] = wd.createDirectionLight(state);

                var state = wd.setDirectionLightColor(light, [1.0, 0.0, 0.0], state);



                var [state, obj] = wd.createGameObject(state);



                var transform = wd.getGameObjectTransformComponent(obj, state);

                state = wd.setTransformLocalPosition(transform, [0, 0, 30], state);


                state = wd.addGameObjectDirectionLightComponent(obj, light, state);

                return [state, obj];
            }


            function createPointLight(state) {
                var [state, light] = wd.createPointLight(state);

                var state = wd.setPointLightColor(light, [1.0, 0.0, 1.0], state);
                var state = wd.setPointLightRangeLevel(light, 11, state);




                var [state, obj] = wd.createGameObject(state);





                state = wd.addGameObjectPointLightComponent(obj, light, state);




                var [state, material] = wd.createLightMaterial(state);

                state = wd.setLightMaterialDiffuseColor(material, [1.0, 0.5, 0.2], state);

                var [state, meshRenderer] = wd.createMeshRenderer(state);

                state = wd.addGameObjectLightMaterialComponent(obj, material, state);
                state = wd.addGameObjectMeshRendererComponent(obj, meshRenderer, state);


                var [state, geometry] = wd.createBoxGeometry(state);

                state = wd.setBoxGeometryConfigData(geometry, {
                    width: 2,
                    height: 2,
                    depth: 2
                }, state);




                state = wd.addGameObjectGeometryComponent(obj, geometry, state);
















                return [state, obj];
            }

            function createCamera(state) {

                var [state, cameraController] = wd.createCameraController(state);

                state = wd.setPerspectiveCameraNear(cameraController, 0.1, state);
                state = wd.setPerspectiveCameraFar(cameraController, 2000, state);
                state = wd.setPerspectiveCameraFovy(cameraController, 60, state);
                state = wd.setPerspectiveCameraAspect(cameraController, 1.0, state);


                state = wd.setCameraControllerPerspectiveCamera(cameraController, state);



                var [state, obj] = wd.createGameObject(state);

                state = wd.addGameObjectCameraControllerComponent(obj, cameraController, state);

                var transform = wd.getGameObjectTransformComponent(obj, state);

                state = wd.setTransformLocalPosition(transform, [0, 0, 1500], state);
                // state = wd.setTransformLocalPosition(transform, [0, 0, 15], state);

                return [state, obj];
            }
        }
    </script>
</body>

</html>