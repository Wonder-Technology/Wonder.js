!function(t,e){"undefined"!=typeof module&&module.exports?module.exports.browser=e():"function"==typeof define&&define.amd?define(e):this[t]=e()}("bowser",function(){function t(t){function n(e){var n=t.match(e);return n&&n.length>1&&n[1]||""}var r,o=n(/(ipod|iphone|ipad)/i).toLowerCase(),i=/like android/i.test(t),a=!i&&/android/i.test(t),s=n(/version\/(\d+(\.\d+)?)/i),c=/tablet/i.test(t),u=!c&&/[^-]mobi/i.test(t);/opera|opr/i.test(t)?r={name:"Opera",opera:e,version:s||n(/(?:opera|opr)[\s\/](\d+(\.\d+)?)/i)}:/windows phone/i.test(t)?r={name:"Windows Phone",windowsphone:e,msie:e,version:n(/iemobile\/(\d+(\.\d+)?)/i)}:/msie|trident/i.test(t)?r={name:"Internet Explorer",msie:e,version:n(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:/chrome|crios|crmo/i.test(t)?r={name:"Chrome",chrome:e,version:n(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:o?(r={name:"iphone"==o?"iPhone":"ipad"==o?"iPad":"iPod"},s&&(r.version=s)):/sailfish/i.test(t)?r={name:"Sailfish",sailfish:e,version:n(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(t)?r={name:"SeaMonkey",seamonkey:e,version:n(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel/i.test(t)?(r={name:"Firefox",firefox:e,version:n(/(?:firefox|iceweasel)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(t)&&(r.firefoxos=e)):/silk/i.test(t)?r={name:"Amazon Silk",silk:e,version:n(/silk\/(\d+(\.\d+)?)/i)}:a?r={name:"Android",version:s}:/phantom/i.test(t)?r={name:"PhantomJS",phantom:e,version:n(/phantomjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(t)||/rim\stablet/i.test(t)?r={name:"BlackBerry",blackberry:e,version:s||n(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:/(web|hpw)os/i.test(t)?(r={name:"WebOS",webos:e,version:s||n(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(t)&&(r.touchpad=e)):r=/bada/i.test(t)?{name:"Bada",bada:e,version:n(/dolfin\/(\d+(\.\d+)?)/i)}:/tizen/i.test(t)?{name:"Tizen",tizen:e,version:n(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||s}:/safari/i.test(t)?{name:"Safari",safari:e,version:s}:{},/(apple)?webkit/i.test(t)?(r.name=r.name||"Webkit",r.webkit=e,!r.version&&s&&(r.version=s)):!r.opera&&/gecko\//i.test(t)&&(r.name=r.name||"Gecko",r.gecko=e,r.version=r.version||n(/gecko\/(\d+(\.\d+)?)/i)),a||r.silk?r.android=e:o&&(r[o]=e,r.ios=e);var l="";o?(l=n(/os (\d+([_\s]\d+)*) like mac os x/i),l=l.replace(/[_\s]/g,".")):a?l=n(/android[ \/-](\d+(\.\d+)*)/i):r.windowsphone?l=n(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):r.webos?l=n(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):r.blackberry?l=n(/rim\stablet\sos\s(\d+(\.\d+)*)/i):r.bada?l=n(/bada\/(\d+(\.\d+)*)/i):r.tizen&&(l=n(/tizen[\/\s](\d+(\.\d+)*)/i)),l&&(r.osversion=l);var h=l.split(".")[0];return c||"ipad"==o||a&&(3==h||4==h&&!u)||r.silk?r.tablet=e:(u||"iphone"==o||"ipod"==o||a||r.blackberry||r.webos||r.bada)&&(r.mobile=e),r.msie&&r.version>=10||r.chrome&&r.version>=20||r.firefox&&r.version>=20||r.safari&&r.version>=6||r.opera&&r.version>=10||r.ios&&r.osversion&&r.osversion.split(".")[0]>=6||r.blackberry&&r.version>=10.1?r.a=e:r.msie&&r.version<10||r.chrome&&r.version<20||r.firefox&&r.version<20||r.safari&&r.version<6||r.opera&&r.version<10||r.ios&&r.osversion&&r.osversion.split(".")[0]<6?r.c=e:r.x=e,r}var e=!0,n=t("undefined"!=typeof navigator?navigator.userAgent:"");return n._detect=t,n}),function(){"use strict";function t(t){return"function"==typeof t||"object"==typeof t&&null!==t}function e(t){return"function"==typeof t}function n(t){return"object"==typeof t&&null!==t}function r(){}function o(t,e){for(var n=0,r=t.length;r>n;n++)if(t[n]===e)return n;return-1}function i(t){var e=t._promiseCallbacks;return e||(e=t._promiseCallbacks={}),e}function a(t,e){return"onerror"===t?void Ct.on("error",e):2!==arguments.length?Ct[t]:void(Ct[t]=e)}function s(){setTimeout(function(){for(var t,e=0;e<wt.length;e++){t=wt[e];var n=t.payload;n.guid=n.key+n.id,n.childGuid=n.key+n.childId,n.error&&(n.stack=n.error.stack),Ct.trigger(t.name,t.payload)}wt.length=0},50)}function c(t,e,n){1===wt.push({name:t,payload:{key:e._guidKey,id:e._id,eventName:t,detail:e._result,childId:n&&n._id,label:e._label,timeStamp:mt(),error:Ct["instrument-with-stack"]?new Error(e._label):null}})&&s()}function u(){return new TypeError("A promises callback cannot return that same promise.")}function l(){}function h(t){try{return t.then}catch(e){return Dt.error=e,Dt}}function p(t,e,n,r){try{t.call(e,n,r)}catch(o){return o}}function f(t,e,n){Ct.async(function(t){var r=!1,o=p(n,e,function(n){r||(r=!0,e!==n?y(t,n):m(t,n))},function(e){r||(r=!0,v(t,e))},"Settle: "+(t._label||" unknown promise"));!r&&o&&(r=!0,v(t,o))},t)}function d(t,e){e._state===Ot?m(t,e._result):e._state===St?(e._onError=null,v(t,e._result)):b(e,void 0,function(n){e!==n?y(t,n):m(t,n)},function(e){v(t,e)})}function _(t,n){if(n.constructor===t.constructor)d(t,n);else{var r=h(n);r===Dt?v(t,Dt.error):void 0===r?m(t,n):e(r)?f(t,n,r):m(t,n)}}function y(e,n){e===n?m(e,n):t(n)?_(e,n):m(e,n)}function g(t){t._onError&&t._onError(t._result),C(t)}function m(t,e){t._state===Tt&&(t._result=e,t._state=Ot,0===t._subscribers.length?Ct.instrument&&Et("fulfilled",t):Ct.async(C,t))}function v(t,e){t._state===Tt&&(t._state=St,t._result=e,Ct.async(g,t))}function b(t,e,n,r){var o=t._subscribers,i=o.length;t._onError=null,o[i]=e,o[i+Ot]=n,o[i+St]=r,0===i&&t._state&&Ct.async(C,t)}function C(t){var e=t._subscribers,n=t._state;if(Ct.instrument&&Et(n===Ot?"fulfilled":"rejected",t),0!==e.length){for(var r,o,i=t._result,a=0;a<e.length;a+=3)r=e[a],o=e[a+n],r?T(n,r,o,i):o(i);t._subscribers.length=0}}function w(){this.error=null}function E(t,e){try{return t(e)}catch(n){return xt.error=n,xt}}function T(t,n,r,o){var i,a,s,c,l=e(r);if(l){if(i=E(r,o),i===xt?(c=!0,a=i.error,i=null):s=!0,n===i)return void v(n,u())}else i=o,s=!0;n._state!==Tt||(l&&s?y(n,i):c?v(n,a):t===Ot?m(n,i):t===St&&v(n,i))}function O(t,e){var n=!1;try{e(function(e){n||(n=!0,y(t,e))},function(e){n||(n=!0,v(t,e))})}catch(r){v(t,r)}}function S(t,e,n){return t===Ot?{state:"fulfilled",value:n}:{state:"rejected",reason:n}}function D(t,e,n,r){this._instanceConstructor=t,this.promise=new t(l,r),this._abortOnReject=n,this._validateInput(e)?(this._input=e,this.length=e.length,this._remaining=e.length,this._init(),0===this.length?m(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&m(this.promise,this._result))):v(this.promise,this._validationError())}function x(t,e){return new Lt(this,t,!0,e).promise}function L(t,e){function n(t){y(i,t)}function r(t){v(i,t)}var o=this,i=new o(l,e);if(!gt(t))return v(i,new TypeError("You must pass an array to race.")),i;for(var a=t.length,s=0;i._state===Tt&&a>s;s++)b(o.resolve(t[s]),void 0,n,r);return i}function M(t,e){var n=this;if(t&&"object"==typeof t&&t.constructor===n)return t;var r=new n(l,e);return y(r,t),r}function A(t,e){var n=this,r=new n(l,e);return v(r,t),r}function F(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function R(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function P(t,n){this._id=Nt++,this._label=n,this._state=void 0,this._result=void 0,this._subscribers=[],Ct.instrument&&Et("created",this),l!==t&&(e(t)||F(),this instanceof P||R(),O(this,t))}function N(t,e,n){this._superConstructor(t,e,!1,n)}function U(t,e){return new N(Ut,t,e).promise}function j(t,e){return Ut.all(t,e)}function I(t,e){Jt[Gt]=t,Jt[Gt+1]=e,Gt+=2,2===Gt&&It()}function B(){var t=process.nextTick,e=process.versions.node.match(/^(?:(\d+)\.)?(?:(\d+)\.)?(\*|\d+)$/);return Array.isArray(e)&&"0"===e[1]&&"10"===e[2]&&(t=setImmediate),function(){t(W)}}function V(){return function(){jt(W)}}function G(){var t=0,e=new zt(W),n=document.createTextNode("");return e.observe(n,{characterData:!0}),function(){n.data=t=++t%2}}function H(){var t=new MessageChannel;return t.port1.onmessage=W,function(){t.port2.postMessage(0)}}function k(){return function(){setTimeout(W,1)}}function W(){for(var t=0;Gt>t;t+=2){var e=Jt[t],n=Jt[t+1];e(n),Jt[t]=void 0,Jt[t+1]=void 0}Gt=0}function z(){try{var t=require,e=t("vertx");return jt=e.runOnLoop||e.runOnContext,V()}catch(n){return k()}}function q(t){var e={};return e.promise=new Ut(function(t,n){e.resolve=t,e.reject=n},t),e}function X(t,n,r){return Ut.all(t,r).then(function(t){if(!e(n))throw new TypeError("You must pass a function as filter's second argument.");for(var o=t.length,i=new Array(o),a=0;o>a;a++)i[a]=n(t[a]);return Ut.all(i,r).then(function(e){for(var n=new Array(o),r=0,i=0;o>i;i++)e[i]&&(n[r]=t[i],r++);return n.length=r,n})})}function J(t,e,n){this._superConstructor(t,e,!0,n)}function K(t,e,n){this._superConstructor(t,e,!1,n)}function Y(t,e){return new K(Ut,t,e).promise}function Q(t,e){return new Qt(Ut,t,e).promise}function $(t,n,r){return Ut.all(t,r).then(function(t){if(!e(n))throw new TypeError("You must pass a function as map's second argument.");for(var o=t.length,i=new Array(o),a=0;o>a;a++)i[a]=n(t[a]);return Ut.all(i,r)})}function Z(){this.value=void 0}function tt(t){try{return t.then}catch(e){return ee.value=e,ee}}function et(t,e,n){try{t.apply(e,n)}catch(r){return ee.value=r,ee}}function nt(t,e){for(var n,r,o={},i=t.length,a=new Array(i),s=0;i>s;s++)a[s]=t[s];for(r=0;r<e.length;r++)n=e[r],o[n]=a[r+1];return o}function rt(t){for(var e=t.length,n=new Array(e-1),r=1;e>r;r++)n[r-1]=t[r];return n}function ot(t,e){return{then:function(n,r){return t.call(e,n,r)}}}function it(t,e){var n=function(){for(var n,r=this,o=arguments.length,i=new Array(o+1),a=!1,s=0;o>s;++s){if(n=arguments[s],!a){if(a=ct(n),a===ne){var c=new Ut(l);return v(c,ne.value),c}a&&a!==!0&&(n=ot(a,n))}i[s]=n}var u=new Ut(l);return i[o]=function(t,n){t?v(u,t):void 0===e?y(u,n):e===!0?y(u,rt(arguments)):gt(e)?y(u,nt(arguments,e)):y(u,n)},a?st(u,i,t,r):at(u,i,t,r)};return n.__proto__=t,n}function at(t,e,n,r){var o=et(n,r,e);return o===ee&&v(t,o.value),t}function st(t,e,n,r){return Ut.all(e).then(function(e){var o=et(n,r,e);return o===ee&&v(t,o.value),t})}function ct(t){return t&&"object"==typeof t?t.constructor===Ut?!0:tt(t):!1}function ut(t,e){return Ut.race(t,e)}function lt(t,e){return Ut.reject(t,e)}function ht(t,e){return Ut.resolve(t,e)}function pt(t){throw setTimeout(function(){throw t}),t}function ft(t,e){Ct.async(t,e)}function dt(){Ct.on.apply(Ct,arguments)}function _t(){Ct.off.apply(Ct,arguments)}var yt;yt=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};var gt=yt,mt=Date.now||function(){return(new Date).getTime()},vt=Object.create||function(t){if(arguments.length>1)throw new Error("Second argument not supported");if("object"!=typeof t)throw new TypeError("Argument must be an object");return r.prototype=t,new r},bt={mixin:function(t){return t.on=this.on,t.off=this.off,t.trigger=this.trigger,t._promiseCallbacks=void 0,t},on:function(t,e){var n,r=i(this);n=r[t],n||(n=r[t]=[]),-1===o(n,e)&&n.push(e)},off:function(t,e){var n,r,a=i(this);return e?(n=a[t],r=o(n,e),void(-1!==r&&n.splice(r,1))):void(a[t]=[])},trigger:function(t,e){var n,r,o=i(this);if(n=o[t])for(var a=0;a<n.length;a++)(r=n[a])(e)}},Ct={instrument:!1};bt.mixin(Ct);var wt=[],Et=c,Tt=void 0,Ot=1,St=2,Dt=new w,xt=new w,Lt=D;D.prototype._validateInput=function(t){return gt(t)},D.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")},D.prototype._init=function(){this._result=new Array(this.length)},D.prototype._enumerate=function(){for(var t=this.length,e=this.promise,n=this._input,r=0;e._state===Tt&&t>r;r++)this._eachEntry(n[r],r)},D.prototype._eachEntry=function(t,e){var r=this._instanceConstructor;n(t)?t.constructor===r&&t._state!==Tt?(t._onError=null,this._settledAt(t._state,e,t._result)):this._willSettleAt(r.resolve(t),e):(this._remaining--,this._result[e]=this._makeResult(Ot,e,t))},D.prototype._settledAt=function(t,e,n){var r=this.promise;r._state===Tt&&(this._remaining--,this._abortOnReject&&t===St?v(r,n):this._result[e]=this._makeResult(t,e,n)),0===this._remaining&&m(r,this._result)},D.prototype._makeResult=function(t,e,n){return n},D.prototype._willSettleAt=function(t,e){var n=this;b(t,void 0,function(t){n._settledAt(Ot,e,t)},function(t){n._settledAt(St,e,t)})};var Mt=x,At=L,Ft=M,Rt=A,Pt="rsvp_"+mt()+"-",Nt=0,Ut=P;P.cast=Ft,P.all=Mt,P.race=At,P.resolve=Ft,P.reject=Rt,P.prototype={constructor:P,_guidKey:Pt,_onError:function(t){Ct.async(function(e){setTimeout(function(){e._onError&&Ct.trigger("error",t)},0)},this)},then:function(t,e,n){var r=this,o=r._state;if(o===Ot&&!t||o===St&&!e)return Ct.instrument&&Et("chained",this,this),this;r._onError=null;var i=new this.constructor(l,n),a=r._result;if(Ct.instrument&&Et("chained",r,i),o){var s=arguments[o-1];Ct.async(function(){T(o,i,s,a)})}else b(r,i,t,e);return i},"catch":function(t,e){return this.then(null,t,e)},"finally":function(t,e){var n=this.constructor;return this.then(function(e){return n.resolve(t()).then(function(){return e})},function(e){return n.resolve(t()).then(function(){throw e})},e)}},N.prototype=vt(Lt.prototype),N.prototype._superConstructor=Lt,N.prototype._makeResult=S,N.prototype._validationError=function(){return new Error("allSettled must be called with an array")};var jt,It,Bt=U,Vt=j,Gt=0,Ht=({}.toString,I),kt="undefined"!=typeof window?window:void 0,Wt=kt||{},zt=Wt.MutationObserver||Wt.WebKitMutationObserver,qt="undefined"!=typeof process&&"[object process]"==={}.toString.call(process),Xt="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,Jt=new Array(1e3);It=qt?B():zt?G():Xt?H():void 0===kt&&"function"==typeof require?z():k();var Kt=q,Yt=X,Qt=J;J.prototype=vt(Lt.prototype),J.prototype._superConstructor=Lt,J.prototype._init=function(){this._result={}},J.prototype._validateInput=function(t){return t&&"object"==typeof t},J.prototype._validationError=function(){return new Error("Promise.hash must be called with an object")},J.prototype._enumerate=function(){var t=this.promise,e=this._input,n=[];for(var r in e)t._state===Tt&&Object.prototype.hasOwnProperty.call(e,r)&&n.push({position:r,entry:e[r]});var o=n.length;this._remaining=o;for(var i,a=0;t._state===Tt&&o>a;a++)i=n[a],this._eachEntry(i.entry,i.position)},K.prototype=vt(Qt.prototype),K.prototype._superConstructor=Lt,K.prototype._makeResult=S,K.prototype._validationError=function(){return new Error("hashSettled must be called with an object")};var $t=Y,Zt=Q,te=$,ee=new Z,ne=new Z,re=it,oe=ut,ie=lt,ae=ht,se=pt;Ct.async=Ht;if("undefined"!=typeof window&&"object"==typeof window.__PROMISE_INSTRUMENTATION__){var ce=window.__PROMISE_INSTRUMENTATION__;a("instrument",!0);for(var ue in ce)ce.hasOwnProperty(ue)&&dt(ue,ce[ue])}var le={race:oe,Promise:Ut,allSettled:Bt,hash:Zt,hashSettled:$t,denodeify:re,on:dt,off:_t,map:te,filter:Yt,resolve:ae,reject:ie,all:Vt,rethrow:se,defer:Kt,EventTarget:bt,configure:a,async:ft};"function"==typeof define&&define.amd?define(function(){return le}):"undefined"!=typeof module&&module.exports?module.exports=le:"undefined"!=typeof this&&(this.RSVP=le)}.call(this);var wdCb;!function(t){var e=Math.pow(2,53)-1,n=function(){function t(){}return t.isArray=function(t){var n=t&&t.length;return"number"==typeof n&&n>=0&&e>=n},t.isArrayExactly=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isNumber=function(t){return"number"==typeof t},t.isNumberExactly=function(t){return"[object Number]"===Object.prototype.toString.call(t)},t.isString=function(t){return"string"==typeof t},t.isStringExactly=function(t){return"[object String]"===Object.prototype.toString.call(t)},t.isBoolean=function(t){return t===!0||t===!1||"[boolect Boolean]"===toString.call(t)},t.isDom=function(t){return!(!t||1!==t.nodeType)},t.isObject=function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},t.isDirectObject=function(t){return"[object Object]"===Object.prototype.toString.call(t)},t.isHostMethod=function(t,e){var n=typeof t[e];return"function"===n||"object"===n&&!!t[e]||"unknown"===n},t.isNodeJs=function(){return("undefined"!=typeof global&&global.module||"undefined"!=typeof module)&&"undefined"!=typeof module.exports},t.isFunction=function(t){return!0},t}();t.JudgeUtils=n,"function"!=typeof/./&&"object"!=typeof Int8Array?n.isFunction=function(t){return"function"==typeof t}:n.isFunction=function(t){return"[object Function]"===Object.prototype.toString.call(t)}}(wdCb||(wdCb={}));var wdCb;!function(t){Object.defineProperty(t,"root",{get:function(){return t.JudgeUtils.isNodeJs()?global:window}})}(wdCb||(wdCb={}));var wdCb;!function(t){if("performance"in t.root==!1&&(t.root.performance={}),Date.now=Date.now||function(){return(new Date).getTime()},"now"in t.root.performance==!1){var e=t.root.performance.timing&&t.root.performance.timing.navigationStart?performance.timing.navigationStart:Date.now();t.root.performance.now=function(){return Date.now()-e}}}(wdCb||(wdCb={}));var wdCb;!function(t){t.$BREAK={"break":!0},t.$REMOVE=void 0}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.log=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];this._exec("log",e)||t.root.alert(e.join(",")),this._exec("trace",e)},e.assert=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];t&&(this._exec("assert",arguments,1)||this.log.apply(this,Array.prototype.slice.call(arguments,1)))},e.error=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(t)throw new Error(Array.prototype.slice.call(arguments,1).join("\n"))},e.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=this._exec("warn",arguments);n?this._exec("trace",["warn trace"]):this.log.apply(this,arguments)},e._exec=function(e,n,r){return void 0===r&&(r=0),t.root.console&&t.root.console[e]?(t.root.console[e].apply(t.root.console,Array.prototype.slice.call(n,r)),!0):!1},e.info={INVALID_PARAM:"invalid parameter",ABSTRACT_ATTRIBUTE:"abstract attribute need override",ABSTRACT_METHOD:"abstract method need override",helperFunc:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n="";return t.forEach(function(t){n+=String(t)+" "}),n.slice(0,-1)},assertion:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(2===t.length)return this.helperFunc(t[0],t[1]);if(3===t.length)return this.helperFunc(t[1],t[0],t[2]);throw new Error("args.length must <= 3")},FUNC_INVALID:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("invalid"),this.assertion.apply(this,t)},FUNC_MUST:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must"),this.assertion.apply(this,t)},FUNC_MUST_BE:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must be"),this.assertion.apply(this,t)},FUNC_MUST_NOT_BE:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must not be"),this.assertion.apply(this,t)},FUNC_SHOULD:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("should"),this.assertion.apply(this,t)},FUNC_SHOULD_NOT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("should not"),this.assertion.apply(this,t)},FUNC_SUPPORT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("support"),this.assertion.apply(this,t)},FUNC_NOT_SUPPORT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("not support"),this.assertion.apply(this,t)},FUNC_MUST_DEFINE:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must define"),this.assertion.apply(this,t)},FUNC_MUST_NOT_DEFINE:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must not define"),this.assertion.apply(this,t)},FUNC_UNKNOW:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("unknow"),this.assertion.apply(this,t)},FUNC_EXPECT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("expect"),this.assertion.apply(this,t)},FUNC_UNEXPECT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("unexpect"),this.assertion.apply(this,t)},FUNC_NOT_EXIST:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("not exist"),this.assertion.apply(this,t)}},e}();t.Log=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){this.children=null}return e.prototype.getCount=function(){return this.children.length},e.prototype.hasChild=function(t){for(var e=null,n=this.children,r=0,o=n.length;o>r;r++){if(e=n[r],t.uid&&e.uid&&t.uid==e.uid)return!0;if(t===e)return!0}return!1},e.prototype.hasChildWithFunc=function(t){for(var e=0,n=this.children.length;n>e;e++)if(t(this.children[e],e))return!0;return!1},e.prototype.getChildren=function(){return this.children},e.prototype.getChild=function(t){return this.children[t]},e.prototype.addChild=function(t){return this.children.push(t),this},e.prototype.addChildren=function(n){if(t.JudgeUtils.isArray(n)){var r=n;this.children=this.children.concat(r)}else if(n instanceof e){var r=n;this.children=this.children.concat(r.getChildren())}else{var o=n;this.addChild(o)}return this},e.prototype.unShiftChild=function(t){this.children.unshift(t)},e.prototype.removeAllChildren=function(){return this.children=[],this},e.prototype.forEach=function(t,e){return this._forEach(this.children,t,e),this},e.prototype.toArray=function(){return this.children},e.prototype.copyChildren=function(){return this.children.slice(0)},e.prototype.removeChildHelper=function(e){var n=null;if(t.JudgeUtils.isFunction(e)){var r=e;n=this._removeChild(this.children,r)}else n=e.uid?this._removeChild(this.children,function(t){return t.uid?t.uid===e.uid:!1}):this._removeChild(this.children,function(t){return t===e});return n},e.prototype._forEach=function(e,n,r){var o=r||t.root,i=0,a=e.length;for(i=0;a>i&&n.call(o,e[i],i)!==t.$BREAK;i++);},e.prototype._removeChild=function(t,e){var n=this,r=[],o=[];return this._forEach(t,function(t,i){e.call(n,t)?r.push(t):o.push(t)}),this.children=o,r},e}();t.List=e}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdCb;!function(t){var e=function(e){function n(t){void 0===t&&(t=[]),e.call(this),this.children=t}return __extends(n,e),n.create=function(t){void 0===t&&(t=[]);var e=new this(t);return e},n.prototype.copy=function(e){return void 0===e&&(e=!1),e?n.create(t.ExtendUtils.extendDeep(this.children)):n.create(t.ExtendUtils.extend([],this.children))},n.prototype.filter=function(t){for(var e=this.children,r=[],o=null,i=0,a=e.length;a>i;i++)o=e[i],t.call(e,o,i)&&r.push(o);return n.create(r)},n.prototype.findOne=function(e){var n=this.children,r=null;return this.forEach(function(o,i){return e.call(n,o,i)?(r=o,t.$BREAK):void 0}),r},n.prototype.reverse=function(){return n.create(this.copyChildren().reverse())},n.prototype.removeChild=function(t){return n.create(this.removeChildHelper(t))},n.prototype.sort=function(t,e){return void 0===e&&(e=!1),e?(this.children.sort(t),this):n.create(this.copyChildren().sort(t))},n.prototype.map=function(e){var r=[];return this.forEach(function(n,o){var i=e(n,o);i!==t.$REMOVE&&r.push(i)}),n.create(r)},n.prototype.removeRepeatItems=function(){var t=n.create();return this.forEach(function(e){t.hasChild(e)||t.addChild(e)}),t},n}(t.List);t.Collection=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(t){void 0===t&&(t={}),this._children=null,this._children=t}return e.create=function(t){void 0===t&&(t={});var e=new this(t);return e},e.prototype.getChildren=function(){return this._children},e.prototype.getCount=function(){var t=0,e=this._children,n=null;for(n in e)e.hasOwnProperty(n)&&t++;return t},e.prototype.getKeys=function(){var e=t.Collection.create(),n=this._children,r=null;for(r in n)n.hasOwnProperty(r)&&e.addChild(r);return e},e.prototype.getValues=function(){var e=t.Collection.create(),n=this._children,r=null;for(r in n)n.hasOwnProperty(r)&&e.addChild(n[r]);return e},e.prototype.getChild=function(t){return this._children[t]},e.prototype.setValue=function(t,e){return this._children[t]=e,this},e.prototype.addChild=function(t,e){return this._children[t]=e,this},e.prototype.addChildren=function(t){var n=null,r=null;r=t instanceof e?t.getChildren():t;for(n in r)r.hasOwnProperty(n)&&this.addChild(n,r[n])},e.prototype.appendChild=function(e,n){if(this._children[e]instanceof t.Collection){var r=this._children[e];r.addChild(n)}else this._children[e]=t.Collection.create().addChild(n);return this},e.prototype.removeChild=function(e){var n=[];if(t.JudgeUtils.isString(e)){var r=e;n.push(this._children[r]),this._children[r]=void 0,delete this._children[r]}else if(t.JudgeUtils.isFunction(e)){var o=e,i=this;this.forEach(function(t,e){o(t,e)&&(n.push(i._children[e]),i._children[e]=void 0,delete i._children[e])})}return t.Collection.create(n)},e.prototype.removeAllChildren=function(){this._children={}},e.prototype.hasChild=function(t){return void 0!==this._children[t]},e.prototype.hasChildWithFunc=function(e){var n=!1;return this.forEach(function(r,o){return e(r,o)?(n=!0,t.$BREAK):void 0}),n},e.prototype.forEach=function(e,n){var r=this._children;for(var o in r)if(r.hasOwnProperty(o)&&e.call(n,r[o],o)===t.$BREAK)break;return this},e.prototype.filter=function(t){var n={},r=this._children,o=null;for(var i in r)r.hasOwnProperty(i)&&(o=r[i],t.call(r,o,i)&&(n[i]=o));return e.create(n)},e.prototype.findOne=function(e){var n=[],r=this,o=this._children;return this.forEach(function(i,a){return e.call(o,i,a)?(n=[a,r.getChild(a)],t.$BREAK):void 0}),n},e.prototype.map=function(n){var r={};return this.forEach(function(e,o){var i=n(e,o);i!==t.$REMOVE&&(t.Log.error(!t.JudgeUtils.isArray(i)||2!==i.length,t.Log.info.FUNC_MUST_BE("iterator","[key, value]")),r[i[0]]=i[1])}),e.create(r)},e.prototype.toCollection=function(){var e=t.Collection.create();return this.forEach(function(n,r){n instanceof t.Collection?e.addChildren(n):e.addChild(n)}),e},e.prototype.toArray=function(){var e=[];return this.forEach(function(n,r){n instanceof t.Collection?e=e.concat(n.getChildren()):e.push(n)}),e},e}();t.Hash=e}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdCb;!function(t){var e=function(t){function e(e){void 0===e&&(e=[]),t.call(this),this.children=e}return __extends(e,t),e.create=function(t){void 0===t&&(t=[]);var e=new this(t);return e},Object.defineProperty(e.prototype,"front",{get:function(){return this.children[this.children.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rear",{get:function(){return this.children[0]},enumerable:!0,configurable:!0}),e.prototype.push=function(t){this.children.unshift(t)},e.prototype.pop=function(){return this.children.pop()},e.prototype.clear=function(){this.removeAllChildren()},e}(t.List);t.Queue=e}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdCb;!function(t){var e=function(t){function e(e){void 0===e&&(e=[]),t.call(this),this.children=e}return __extends(e,t),e.create=function(t){void 0===t&&(t=[]);var e=new this(t);return e},Object.defineProperty(e.prototype,"top",{get:function(){return this.children[this.children.length-1]},enumerable:!0,configurable:!0}),e.prototype.push=function(t){this.children.push(t)},e.prototype.pop=function(){return this.children.pop()},e.prototype.clear=function(){this.removeAllChildren()},e}(t.List);t.Stack=e}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var AjaxUtils=function(){function AjaxUtils(){}return AjaxUtils.ajax=function(conf){var type=conf.type,url=conf.url,data=conf.data,dataType=conf.dataType,success=conf.success,error=conf.error,xhr=null,self=this;if(null===type&&(type="get"),null===dataType&&(dataType="text"),xhr=this._createAjax(error))try{xhr.open(type,url,!0),this._isSoundFile(dataType)&&(xhr.responseType="arraybuffer"),"GET"===type||"get"===type?xhr.send(null):("POST"===type||"post"===type)&&(xhr.setRequestHeader("content-type","application/x-www-form-urlencoded"),xhr.send(data)),xhr.onreadystatechange=function(){4!==xhr.readyState||200!==xhr.status&&!self._isLocalFile(xhr.status)||("text"===dataType||"TEXT"===dataType?null!==success&&success(xhr.responseText):"xml"===dataType||"XML"===dataType?null!==success&&success(xhr.responseXML):"json"===dataType||"JSON"===dataType?null!==success&&success(eval("("+xhr.responseText+")")):self._isSoundFile(dataType)&&null!==success&&success(xhr.response))}}catch(e){error(xhr,e)}},AjaxUtils._createAjax=function(t){var e=null;try{e=new ActiveXObject("microsoft.xmlhttp")}catch(n){try{e=new XMLHttpRequest}catch(r){return t(e,{message:"您的浏览器不支持ajax，请更换！"}),null}}return e},AjaxUtils._isLocalFile=function(t){return document.URL.contain("file://")&&0===t},AjaxUtils._isSoundFile=function(t){return"arraybuffer"===t},AjaxUtils}();wdCb.AjaxUtils=AjaxUtils}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.removeRepeatItems=function(t,e){void 0===e&&(e=function(t,e){return t===e});var n=[],r=this;return t.forEach(function(t){r.contain(n,function(n){return e(n,t)})||n.push(t)}),n},e.contain=function(e,n){if(t.JudgeUtils.isFunction(n))for(var r=n,o=0,i=e.length;i>o;o++){var a=e[o];if(r.call(null,a,o))return!0}else for(var o=0,i=e.length;i>o;o++){var a=e[o];if(n===a||a.contain&&a.contain(n))return!0}return!1},e}();t.ArrayUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.toString=function(e){return t.JudgeUtils.isNumber(e)?String(e):t.JudgeUtils.isFunction(e)?this._convertCodeToString(e):t.JudgeUtils.isDirectObject(e)||t.JudgeUtils.isArray(e)?JSON.stringify(e):String(e)},e._convertCodeToString=function(t){return t.toString().split("\n").slice(1,-1).join("\n")+"\n"},e}();t.ConvertUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.bindEvent=function(t,e){return function(n){return e.call(t,n)}},e.addEvent=function(e,n,r){t.JudgeUtils.isHostMethod(e,"addEventListener")?e.addEventListener(n,r,!1):t.JudgeUtils.isHostMethod(e,"attachEvent")?e.attachEvent("on"+n,r):e["on"+n]=r},e.removeEvent=function(e,n,r){t.JudgeUtils.isHostMethod(e,"removeEventListener")?e.removeEventListener(n,r,!1):t.JudgeUtils.isHostMethod(e,"detachEvent")?e.detachEvent("on"+n,r):e["on"+n]=null},e}();t.EventUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.extendDeep=function(t,e,n){void 0===n&&(n=function(t,e){return!0});var r=null,o=0,i=Object.prototype.toString,a="[object Array]",s="[object Object]",c="",u=null;if(i.call(t)===a)for(u=e||[],r=0,o=t.length;o>r;r++)n(t[r],r)&&(c=i.call(t[r]),c===a||c===s?(u[r]=c===a?[]:{},arguments.callee(t[r],u[r])):u[r]=t[r]);else if(i.call(t)===s){u=e||{};for(r in t)n(t[r],r)&&(c=i.call(t[r]),c===a||c===s?(u[r]=c===a?[]:{},arguments.callee(t[r],u[r])):u[r]=t[r])}else u=t;return u},e.extend=function(t,e){var n="";for(n in e)t[n]=e[n];return t},e.copyPublicAttri=function(e){var n={};return this.extendDeep(e,n,function(e,n){return"_"!==n.slice(0,1)&&!t.JudgeUtils.isFunction(e)}),n},e}();t.ExtendUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,n=function(){function t(){}return t.basename=function(t,e){var n=this._splitPath(t)[2];return e&&n.substr(-1*e.length)===e&&(n=n.substr(0,n.length-e.length)),n},t.changeExtname=function(t,e){var e=e||"",n=t.indexOf("?"),r="";return n>0&&(r=t.substring(n),t=t.substring(0,n)),n=t.lastIndexOf("."),0>n?t+e+r:t.substring(0,n)+e+r;
},t.changeBasename=function(t,e,n){void 0===n&&(n=!1);var r=null,o=null,i=null;return 0==e.indexOf(".")?this.changeExtname(t,e):(r=t.indexOf("?"),o="",i=n?this.extname(t):"",r>0&&(o=t.substring(r),t=t.substring(0,r)),r=t.lastIndexOf("/"),r=0>=r?0:r+1,t.substring(0,r)+e+i+o)},t.extname=function(t){return this._splitPath(t)[3]},t.dirname=function(t){var e=this._splitPath(t),n=e[0],r=e[1];return n||r?(r&&(r=r.substr(0,r.length-1)),n+r):"."},t._splitPath=function(t){return e.exec(t).slice(1)},t}();t.PathUtils=n}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function t(){}return t.bind=function(t,e){return function(){return e.apply(t,arguments)}},t}();t.FunctionUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];return this._doms=null,t.JudgeUtils.isDom(e[0])?this._doms=[e[0]]:this._isDomEleStr(e[0])?this._doms=[this._buildDom(e[0])]:this._doms=document.querySelectorAll(e[0]),this}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=new this(t[0]);return n},e.prototype.get=function(t){return this._doms[t]},e.prototype.prepend=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;n=this._buildDom(t[0]);for(var r=0,o=this._doms;r<o.length;r++){var i=o[r];1===i.nodeType&&i.insertBefore(n,i.firstChild)}return this},e.prototype.prependTo=function(t){var n=null;n=e.create(t);for(var r=0,o=this._doms;r<o.length;r++){var i=o[r];1===i.nodeType&&n.prepend(i)}return this},e.prototype.remove=function(){for(var t=0,e=this._doms;t<e.length;t++){var n=e[t];n&&n.parentNode&&"BODY"!=n.tagName&&n.parentNode.removeChild(n)}return this},e.prototype.css=function(t,e){for(var n=0,r=this._doms;n<r.length;n++){var o=r[n];o.style[t]=e}},e.prototype.attr=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(1===t.length){var n=t[0];return this.get(0).getAttribute(n)}for(var r=t[0],o=t[1],i=0,a=this._doms;i<a.length;i++){var s=a[i];s.setAttribute(r,o)}},e.prototype._isDomEleStr=function(t){return null!==t.match(/<(\w+)[^>]*><\/\1>/)},e.prototype._buildDom=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.JudgeUtils.isString(e[0])){var r=this._createElement("div"),o=e[0];return r.innerHTML=o,r.firstChild}return e[0]},e.prototype._createElement=function(t){return document.createElement(t)},e}();t.DomQuery=e}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.isPromise=function(e){return!!e&&!t.isFunction.call(this,e.subscribe)&&t.isFunction.call(this,e.then)},e.isEqual=function(t,e){return t.uid===e.uid},e.isIObserver=function(t){return t.next&&t.error&&t.completed},e}(wdCb.JudgeUtils);t.JudgeUtils=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.fromNodeCallback=function(e,n){return function(){for(var r=[],o=0;o<arguments.length;o++)r[o-0]=arguments[o];return t.createStream(function(t){var o=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return e?void t.error(e):(n.length<=1?t.next.apply(t,n):t.next(n),void t.completed())};r.push(o),e.apply(n,r)})}},t.fromStream=function(e,n){return void 0===n&&(n="end"),e.pause(),t.createStream(function(t){var r=function(e){t.next(e)},o=function(e){t.error(e)},i=function(){t.completed()};return e.addListener("data",r),e.addListener("error",o),e.addListener(n,i),e.resume(),function(){e.removeListener("data",r),e.removeListener("error",o),e.removeListener(n,i)}})},t.fromReadableStream=function(e){return t.fromStream(e,"end")},t.fromWritableStream=function(e){return t.fromStream(e,"finish")},t.fromTransformStream=function(e){return t.fromStream(e,"finish")}}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(e){this._uid=null,this._uid=e+String(t.UID++)}return Object.defineProperty(t.prototype,"uid",{get:function(){return this._uid},set:function(t){this._uid=t},enumerable:!0,configurable:!0}),t.UID=1,t}();t.Entity=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(){}return t.isTest=!1,t}();t.Main=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){function e(t,e){void 0===e&&(e="contract error"),u.error(!t,e)}function n(e){return function(n,r,o){var i=o.value;return o.value=function(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];return t.Main.isTest&&e.apply(this,n),i.apply(this,n)},o}}function r(e){return function(n,r,o){var i=o.value;return o.value=function(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];var o=i.apply(this,n),a=[o].concat(n);return t.Main.isTest&&e.apply(this,a),o},o}}function o(e){return function(n,r,o){var i=o.get;return o.get=function(){return t.Main.isTest&&e.call(this),i.call(this)},o}}function i(e){return function(n,r,o){var i=o.set;return o.set=function(n){t.Main.isTest&&e.call(this,n),i.call(this,n)},o}}function a(e){return function(n,r,o){var i=o.get;return o.get=function(){var n=i.call(this);return t.Main.isTest&&e.call(this,n),n},o}}function s(e){return function(n,r,o){var i=o.set;return o.set=function(n){var r=i.call(this,n),o=[r,n];t.Main.isTest&&e.apply(this,o)},o}}function c(e){return function(n){t.Main.isTest&&e(n)}}var u=wdCb.Log;t.assert=e,t.require=n,t.ensure=r,t.requireGetter=o,t.requireSetter=i,t.ensureGetter=a,t.ensureSetter=s,t.invariant=c}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(t){this._disposeHandler=null,this._disposeHandler=t}return t.create=function(t){void 0===t&&(t=function(){});var e=new this(t);return e},t.prototype.setDisposeHandler=function(t){this._disposeHandler=t},t.prototype.dispose=function(){this._disposeHandler()},t}();t.SingleDisposable=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(t){this._group=wdCb.Collection.create(),t&&this._group.addChild(t)}return t.create=function(t){var e=new this(t);return e},t.prototype.add=function(t){return this._group.addChild(t),this},t.prototype.dispose=function(){this._group.forEach(function(t){t.dispose()})},t}();t.GroupDisposable=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(t,e){this._subject=null,this._observer=null,this._subject=t,this._observer=e}return t.create=function(t,e){var n=new this(t,e);return n},t.prototype.dispose=function(){this._subject.remove(this._observer),this._observer.dispose()},t}();t.InnerSubscription=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(){this._container=wdCb.Collection.create()}return t.create=function(){var t=new this;return t},t.prototype.addChild=function(t){this._container.addChild(t)},t.prototype.dispose=function(){this._container.forEach(function(t){t.dispose()})},t}();t.InnerSubscriptionGroup=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){Object.defineProperty(t,"root",{get:function(){return t.JudgeUtils.isNodeJs()?global:window}})}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.ABSTRACT_ATTRIBUTE=null}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.root.RSVP&&(t.root.RSVP.onerror=function(t){throw t},t.root.RSVP.on("error",t.root.RSVP.onerror))}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wdFrp;!function(t){var e=wdCb.Log,n=function(n){function r(e){n.call(this,"Stream"),this.scheduler=t.ABSTRACT_ATTRIBUTE,this.subscribeFunc=null,this.subscribeFunc=e||function(){}}return __extends(r,n),r.prototype.buildStream=function(e){return t.SingleDisposable.create(this.subscribeFunc(e)||function(){})},r.prototype["do"]=function(e,n,r){return t.DoStream.create(this,e,n,r)},r.prototype.map=function(e){return t.MapStream.create(this,e)},r.prototype.flatMap=function(t){return this.map(t).mergeAll()},r.prototype.mergeAll=function(){return t.MergeAllStream.create(this)},r.prototype.takeUntil=function(e){return t.TakeUntilStream.create(this,e)},r.prototype.take=function(e){void 0===e&&(e=1);var n=this;return 0===e?t.empty():t.createStream(function(t){n.subscribe(function(n){e>0&&t.next(n),e--,0>=e&&t.completed()},function(e){t.error(e)},function(){t.completed()})})},r.prototype.takeLast=function(e){void 0===e&&(e=1);var n=this;return 0===e?t.empty():t.createStream(function(t){var r=[];n.subscribe(function(t){r.push(t),r.length>e&&r.shift()},function(e){t.error(e)},function(){for(;r.length>0;)t.next(r.shift());t.completed()})})},r.prototype.takeWhile=function(e,n){void 0===n&&(n=this);var r=this,o=null;return o=wdCb.FunctionUtils.bind(n,e),t.createStream(function(t){var e=0,n=!1;r.subscribe(function(i){if(o(i,e++,r))try{t.next(i),n=!0}catch(a){return void t.error(a)}else n&&t.completed()},function(e){t.error(e)},function(){t.completed()})})},r.prototype.filter=function(e,n){if(void 0===n&&(n=this),this instanceof t.FilterStream){var r=this;return r.internalFilter(e,n)}return t.FilterStream.create(this,e,n)},r.prototype.filterWithState=function(e,n){if(void 0===n&&(n=this),this instanceof t.FilterStream){var r=this;return r.internalFilter(e,n)}return t.FilterWithStateStream.create(this,e,n)},r.prototype.concat=function(){var e=null;return e=t.JudgeUtils.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments,0),e.unshift(this),t.ConcatStream.create(e)},r.prototype.merge=function(){var e=null,n=null;return e=t.JudgeUtils.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments,0),e.unshift(this),n=t.fromArray(e).mergeAll()},r.prototype.repeat=function(e){return void 0===e&&(e=-1),t.RepeatStream.create(this,e)},r.prototype.ignoreElements=function(){return t.IgnoreElementsStream.create(this)},r.prototype.handleSubject=function(t){return this._isSubject(t)?(this._setSubject(t),!0):!1},r.prototype._isSubject=function(e){return e instanceof t.Subject},r.prototype._setSubject=function(t){t.source=this},__decorate([t.require(function(n){void 0===n&&(n=1),t.assert(n>=0,e.info.FUNC_SHOULD("count",">= 0"))})],r.prototype,"take",null),__decorate([t.require(function(n){void 0===n&&(n=1),t.assert(n>=0,e.info.FUNC_SHOULD("count",">= 0"))})],r.prototype,"takeLast",null),r}(t.Entity);t.Stream=n}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.root.requestNextAnimationFrame=function(){var e=void 0,n=void 0,r=null,o=t.root.navigator&&t.root.navigator.userAgent,i=0,a=this;return n=function(e){e=t.root.performance.now(),a.callback(e)},t.root.requestAnimationFrame?requestAnimationFrame:(t.root.webkitRequestAnimationFrame&&(e=t.root.webkitRequestAnimationFrame,t.root.webkitRequestAnimationFrame=function(t,r){return a.callback=t,e(n,r)}),t.root.msRequestAnimationFrame&&(e=t.root.msRequestAnimationFrame,t.root.msRequestAnimationFrame=function(t){return a.callback=t,e(n)}),t.root.mozRequestAnimationFrame&&(i=o.indexOf("rv:"),-1!=o.indexOf("Gecko")&&(r=o.substr(i+3,3),"2.0"===r&&(t.root.mozRequestAnimationFrame=void 0))),t.root.webkitRequestAnimationFrame||t.root.mozRequestAnimationFrame||t.root.oRequestAnimationFrame||t.root.msRequestAnimationFrame||function(e,n){var r,o;t.root.setTimeout(function(){r=t.root.performance.now(),e(r),o=t.root.performance.now(),a.timeout=1e3/60-(o-r)},a.timeout)})}(),t.root.cancelNextRequestAnimationFrame=t.root.cancelRequestAnimationFrame||t.root.webkitCancelAnimationFrame||t.root.webkitCancelRequestAnimationFrame||t.root.mozCancelRequestAnimationFrame||t.root.oCancelRequestAnimationFrame||t.root.msCancelRequestAnimationFrame||clearTimeout;var e=function(){function e(){this._requestLoopId=null}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=new this;return n},Object.defineProperty(e.prototype,"requestLoopId",{get:function(){return this._requestLoopId},set:function(t){this._requestLoopId=t},enumerable:!0,configurable:!0}),e.prototype.publishRecursive=function(t,e,n){n(e)},e.prototype.publishInterval=function(e,n,r,o){return t.root.setInterval(function(){n=o(n)},r)},e.prototype.publishIntervalRequest=function(e,n){var r=this,o=function(e){var i=n(e);i||(r._requestLoopId=t.root.requestNextAnimationFrame(o))};this._requestLoopId=t.root.requestNextAnimationFrame(o)},e}();t.Scheduler=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.call(this,"Observer"),this._isDisposed=null,this.onUserNext=null,this.onUserError=null,this.onUserCompleted=null,this._isStop=!1,this._disposable=null,1===e.length){var r=e[0];this.onUserNext=function(t){r.next(t)},this.onUserError=function(t){r.error(t)},this.onUserCompleted=function(){r.completed()}}else{var o=e[0],i=e[1],a=e[2];this.onUserNext=o||function(t){},this.onUserError=i||function(t){throw t},this.onUserCompleted=a||function(){}}}return __extends(e,t),Object.defineProperty(e.prototype,"isDisposed",{get:function(){return this._isDisposed},set:function(t){this._isDisposed=t},enumerable:!0,configurable:!0}),e.prototype.next=function(t){return this._isStop?void 0:this.onNext(t)},e.prototype.error=function(t){this._isStop||(this._isStop=!0,this.onError(t))},e.prototype.completed=function(){this._isStop||(this._isStop=!0,this.onCompleted())},e.prototype.dispose=function(){this._isStop=!0,this._isDisposed=!0,this._disposable&&this._disposable.dispose()},e.prototype.setDisposable=function(t){this._disposable=t},e}(t.Entity);t.Observer=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function e(){this._source=null,this._observer=new t.SubjectObserver}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"source",{get:function(){return this._source},set:function(t){this._source=t},enumerable:!0,configurable:!0}),e.prototype.subscribe=function(e,n,r){var o=e instanceof t.Observer?e:t.AutoDetachObserver.create(e,n,r);return this._observer.addChild(o),t.InnerSubscription.create(this,o)},e.prototype.next=function(t){this._observer.next(t)},e.prototype.error=function(t){this._observer.error(t)},e.prototype.completed=function(){this._observer.completed()},e.prototype.start=function(){this._source&&this._observer.setDisposable(this._source.buildStream(this))},e.prototype.remove=function(t){this._observer.removeChild(t)},e.prototype.dispose=function(){this._observer.dispose()},e}();t.Subject=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(){e.call(this,"GeneratorSubject"),this._isStart=!1,this.observer=new t.SubjectObserver}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"isStart",{get:function(){return this._isStart},set:function(t){this._isStart=t},enumerable:!0,configurable:!0}),n.prototype.onBeforeNext=function(t){},n.prototype.onAfterNext=function(t){},n.prototype.onIsCompleted=function(t){return!1},n.prototype.onBeforeError=function(t){},n.prototype.onAfterError=function(t){},n.prototype.onBeforeCompleted=function(){},n.prototype.onAfterCompleted=function(){},n.prototype.subscribe=function(e,n,r){var o=e instanceof t.Observer?e:t.AutoDetachObserver.create(e,n,r);return this.observer.addChild(o),t.InnerSubscription.create(this,o)},n.prototype.next=function(t){if(this._isStart&&!this.observer.isEmpty())try{this.onBeforeNext(t),this.observer.next(t),this.onAfterNext(t),this.onIsCompleted(t)&&this.completed()}catch(e){this.error(e)}},n.prototype.error=function(t){this._isStart&&!this.observer.isEmpty()&&(this.onBeforeError(t),this.observer.error(t),this.onAfterError(t))},n.prototype.completed=function(){this._isStart&&!this.observer.isEmpty()&&(this.onBeforeCompleted(),this.observer.completed(),this.onAfterCompleted())},n.prototype.toStream=function(){var e=this,n=null;return n=t.AnonymousStream.create(function(t){e.subscribe(t)})},n.prototype.start=function(){var e=this;this._isStart=!0,this.observer.setDisposable(t.SingleDisposable.create(function(){e.dispose()}))},n.prototype.stop=function(){this._isStart=!1},n.prototype.remove=function(t){this.observer.removeChild(t)},n.prototype.dispose=function(){this.observer.dispose()},n}(t.Entity);t.GeneratorSubject=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e,n){return new this(t,e,n)},e.prototype.onNext=function(t){this.onUserNext(t)},e.prototype.onError=function(t){this.onUserError(t)},e.prototype.onCompleted=function(){this.onUserCompleted()},e}(t.Observer);t.AnonymousObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return 1===t.length?new this(t[0]):new this(t[0],t[1],t[2])},e.prototype.dispose=function(){return this.isDisposed?void wdCb.Log.log("only can dispose once"):void t.prototype.dispose.call(this)},e.prototype.onNext=function(t){try{this.onUserNext(t)}catch(e){this.onError(e)}},e.prototype.onError=function(t){try{this.onUserError(t)}catch(e){throw e}finally{this.dispose()}},e.prototype.onCompleted=function(){try{this.onUserCompleted(),this.dispose()}catch(t){throw t}},e}(t.Observer);t.AutoDetachObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e,n){t.call(this,null,null,null),this._currentObserver=null,this._selector=null,this._currentObserver=e,this._selector=n}return __extends(e,t),e.create=function(t,e){return new this(t,e)},e.prototype.onNext=function(t){var e=null;try{e=this._selector(t)}catch(n){this._currentObserver.error(n)}finally{this._currentObserver.next(e)}},e.prototype.onError=function(t){this._currentObserver.error(t)},e.prototype.onCompleted=function(){this._currentObserver.completed()},e}(t.Observer);t.MapObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e,n){t.call(this,null,null,null),this._currentObserver=null,this._prevObserver=null,this._currentObserver=e,this._prevObserver=n}return __extends(e,t),e.create=function(t,e){return new this(t,e)},e.prototype.onNext=function(t){try{this._prevObserver.next(t)}catch(e){this._prevObserver.error(e),this._currentObserver.error(e)}finally{this._currentObserver.next(t)}},e.prototype.onError=function(t){try{this._prevObserver.error(t)}catch(e){}finally{this._currentObserver.error(t)}},e.prototype.onCompleted=function(){try{this._prevObserver.completed()}catch(t){this._prevObserver.error(t),this._currentObserver.error(t)}finally{this._currentObserver.completed()}},e}(t.Observer);t.DoObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function r(t,n,r){e.call(this,null,null,null),this._currentObserver=null,this._done=!1,this._streamGroup=null,this._groupDisposable=null,this._currentObserver=t,this._streamGroup=n,this._groupDisposable=r}return __extends(r,e),r.create=function(t,e,n){return new this(t,e,n)},Object.defineProperty(r.prototype,"currentObserver",{get:function(){return this._currentObserver},set:function(t){this._currentObserver=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"done",{get:function(){return this._done},set:function(t){this._done=t},enumerable:!0,configurable:!0}),r.prototype.onNext=function(e){wdCb.Log.error(!(e instanceof t.Stream||t.JudgeUtils.isPromise(e)),wdCb.Log.info.FUNC_MUST_BE("innerSource","Stream or Promise")),t.JudgeUtils.isPromise(e)&&(e=t.fromPromise(e)),this._streamGroup.addChild(e),this._groupDisposable.add(e.buildStream(n.create(this,this._streamGroup,e)))},r.prototype.onError=function(t){this._currentObserver.error(t)},r.prototype.onCompleted=function(){this.done=!0,0===this._streamGroup.getCount()&&this._currentObserver.completed()},r}(t.Observer);t.MergeAllObserver=e;var n=function(e){function n(t,n,r){e.call(this,null,null,null),this._parent=null,this._streamGroup=null,this._currentStream=null,this._parent=t,this._streamGroup=n,this._currentStream=r}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.onNext=function(t){this._parent.currentObserver.next(t)},n.prototype.onError=function(t){this._parent.currentObserver.error(t)},n.prototype.onCompleted=function(){var e=this._currentStream,n=this._parent;this._streamGroup.removeChild(function(n){return t.JudgeUtils.isEqual(n,e)}),this._isAsync()&&0===this._streamGroup.getCount()&&n.currentObserver.completed()},n.prototype._isAsync=function(){return this._parent.done},n}(t.Observer)}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e){t.call(this,null,null,null),this._prevObserver=null,this._prevObserver=e}return __extends(e,t),e.create=function(t){return new this(t)},e.prototype.onNext=function(t){this._prevObserver.completed()},e.prototype.onError=function(t){this._prevObserver.error(t)},e.prototype.onCompleted=function(){},e}(t.Observer);t.TakeUntilObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e,n){t.call(this,null,null,null),this.currentObserver=null,this._startNextStream=null,this.currentObserver=e,this._startNextStream=n}return __extends(e,t),e.create=function(t,e){return new this(t,e)},e.prototype.onNext=function(t){this.currentObserver.next(t)},e.prototype.onError=function(t){this.currentObserver.error(t)},e.prototype.onCompleted=function(){this._startNextStream()},e}(t.Observer);t.ConcatObserver=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function e(){this.observers=wdCb.Collection.create(),this._disposable=null}return e.prototype.isEmpty=function(){return 0===this.observers.getCount()},e.prototype.next=function(t){this.observers.forEach(function(e){e.next(t)})},e.prototype.error=function(t){this.observers.forEach(function(e){e.error(t)})},e.prototype.completed=function(){this.observers.forEach(function(t){t.completed()})},e.prototype.addChild=function(t){this.observers.addChild(t),t.setDisposable(this._disposable)},e.prototype.removeChild=function(e){this.observers.removeChild(function(n){return t.JudgeUtils.isEqual(n,e)})},e.prototype.dispose=function(){this.observers.forEach(function(t){t.dispose()}),this.observers.removeAllChildren()},e.prototype.setDisposable=function(t){this.observers.forEach(function(e){e.setDisposable(t)}),this._disposable=t},e}();t.SubjectObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e){t.call(this,null,null,null),this._currentObserver=null,this._currentObserver=e}return __extends(e,t),e.create=function(t){return new this(t)},e.prototype.onNext=function(t){},e.prototype.onError=function(t){this._currentObserver.error(t)},e.prototype.onCompleted=function(){this._currentObserver.completed()},e}(t.Observer);t.IgnoreElementsObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(t){function e(e,n,r){t.call(this,null,null,null),this.prevObserver=null,this.source=null,this.i=0,this.predicate=null,this.prevObserver=e,this.predicate=n,this.source=r}return __extends(e,t),e.create=function(t,e,n){return new this(t,e,n)},e.prototype.onNext=function(t){try{this.predicate(t,this.i++,this.source)&&this.prevObserver.next(t)}catch(e){this.prevObserver.error(e)}},e.prototype.onError=function(t){this.prevObserver.error(t)},e.prototype.onCompleted=function(){this.prevObserver.completed()},e}(t.Observer);t.FilterObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._isTrigger=!1}return __extends(n,e),n.create=function(t,e,n){return new this(t,e,n)},n.prototype.onNext=function(e){var n=null;try{this.predicate(e,this.i++,this.source)?(n=this._isTrigger?{value:e,state:t.FilterState.TRIGGER}:{value:e,state:t.FilterState.ENTER},this.prevObserver.next(n),this._isTrigger=!0):(this._isTrigger&&(n={value:e,state:t.FilterState.LEAVE},this.prevObserver.next(n)),this._isTrigger=!1)}catch(r){this.prevObserver.error(r)}},n}(t.FilterObserver);t.FilterWithStateObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.subscribe=function(e,n,r){var o=null;if(!this.handleSubject(e))return o=e instanceof t.Observer?t.AutoDetachObserver.create(e):t.AutoDetachObserver.create(e,n,r),o.setDisposable(this.buildStream(o)),o},n.prototype.buildStream=function(t){return e.prototype.buildStream.call(this,t),this.subscribeCore(t)},n}(t.Stream);t.BaseStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(n,r,o,i){e.call(this,null),this._source=null,this._observer=null,this._source=n,this._observer=t.AnonymousObserver.create(r,o,i),this.scheduler=this._source.scheduler}return __extends(n,e),n.create=function(t,e,n,r){var o=new this(t,e,n,r);return o},n.prototype.subscribeCore=function(e){return this._source.buildStream(t.DoObserver.create(e,this._observer))},n}(t.BaseStream);t.DoStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._source=null,this._selector=null,this._source=t,this.scheduler=this._source.scheduler,this._selector=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){return this._source.buildStream(t.MapObserver.create(e,this._selector))},n}(t.BaseStream);t.MapStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._array=null,this._array=t,this.scheduler=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){function n(t){o>t?(e.next(r[t]),arguments.callee(t+1)):e.completed()}var r=this._array,o=r.length;return this.scheduler.publishRecursive(e,0,n),t.SingleDisposable.create()},n}(t.BaseStream);t.FromArrayStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._promise=null,this._promise=t,this.scheduler=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){return this._promise.then(function(t){e.next(t),e.completed()},function(t){e.error(t)},e),t.SingleDisposable.create()},n}(t.BaseStream);t.FromPromiseStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._addHandler=null,this._removeHandler=null,this._addHandler=t,this._removeHandler=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){function n(t){e.next(t)}var r=this;return this._addHandler(n),t.SingleDisposable.create(function(){r._removeHandler(n)})},n}(t.BaseStream);t.FromEventPatternStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(n){e.call(this,n),this.scheduler=t.Scheduler.create()}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.subscribe=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;if(e[0]instanceof t.Subject){var o=e[0];return void this.handleSubject(o)}if(t.JudgeUtils.isIObserver(e[0]))r=t.AutoDetachObserver.create(e[0]);else{var i=e[0],a=e[1]||null,s=e[2]||null;r=t.AutoDetachObserver.create(i,a,s)}return r.setDisposable(this.buildStream(r)),r},n}(t.Stream);t.AnonymousStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._interval=null,this._interval=t,this.scheduler=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n.initWhenCreate(),n},n.prototype.initWhenCreate=function(){this._interval=this._interval<=0?1:this._interval},n.prototype.subscribeCore=function(e){var n=null;return n=this.scheduler.publishInterval(e,0,this._interval,function(t){
return e.next(t),t+1}),t.SingleDisposable.create(function(){t.root.clearInterval(n)})},n}(t.BaseStream);t.IntervalStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t){e.call(this,null),this._isEnd=!1,this.scheduler=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.subscribeCore=function(e){var n=this;return this.scheduler.publishIntervalRequest(e,function(t){return e.next(t),n._isEnd}),t.SingleDisposable.create(function(){t.root.cancelNextRequestAnimationFrame(n.scheduler.requestLoopId),n._isEnd=!0})},n}(t.BaseStream);t.IntervalRequestStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t){e.call(this,null),this._source=null,this._observer=null,this._source=t,this.scheduler=this._source.scheduler}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.subscribeCore=function(e){var n=wdCb.Collection.create(),r=t.GroupDisposable.create();return this._source.buildStream(t.MergeAllObserver.create(e,n,r)),r},n}(t.BaseStream);t.MergeAllStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(n,r){e.call(this,null),this._source=null,this._otherStream=null,this._source=n,this._otherStream=t.JudgeUtils.isPromise(r)?t.fromPromise(r):r,this.scheduler=this._source.scheduler}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){var n=t.GroupDisposable.create(),r=t.AutoDetachObserver.create(e),o=null;return o=this._source.buildStream(e),n.add(o),r.setDisposable(o),n.add(this._otherStream.buildStream(t.TakeUntilObserver.create(r))),n},n}(t.BaseStream);t.TakeUntilStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(n){e.call(this,null),this._sources=wdCb.Collection.create();var r=this;this.scheduler=n[0].scheduler,n.forEach(function(e){t.JudgeUtils.isPromise(e)?r._sources.addChild(t.fromPromise(e)):r._sources.addChild(e)})}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.subscribeCore=function(e){function n(a){return a===o?void e.completed():void i.add(r._sources.getChild(a).buildStream(t.ConcatObserver.create(e,function(){n(a+1)})))}var r=this,o=this._sources.getCount(),i=t.GroupDisposable.create();return this.scheduler.publishRecursive(e,0,n),t.GroupDisposable.create(i)},n}(t.BaseStream);t.ConcatStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this._source=null,this._count=null,this._source=t,this._count=n,this.scheduler=this._source.scheduler}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){function n(i){return 0===i?void e.completed():void o.add(r._source.buildStream(t.ConcatObserver.create(e,function(){n(i-1)})))}var r=this,o=t.GroupDisposable.create();return this.scheduler.publishRecursive(e,this._count,n),t.GroupDisposable.create(o)},n}(t.BaseStream);t.RepeatStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t){e.call(this,null),this._source=null,this._source=t,this.scheduler=this._source.scheduler}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.subscribeCore=function(e){return this._source.buildStream(t.IgnoreElementsObserver.create(e))},n}(t.BaseStream);t.IgnoreElementsStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t){e.call(this,null),this._buildStreamFunc=null,this._buildStreamFunc=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.subscribeCore=function(e){var n=t.GroupDisposable.create();return n.add(this._buildStreamFunc().buildStream(e)),n},n}(t.BaseStream);t.DeferStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n,r){e.call(this,null),this.predicate=null,this._source=null,this._source=t,this.predicate=wdCb.FunctionUtils.bind(r,n)}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.subscribeCore=function(t){return this._source.subscribe(this.createObserver(t))},n.prototype.internalFilter=function(t,e){return this.createStreamForInternalFilter(this._source,this._innerPredicate(t,this),e)},n.prototype.createObserver=function(e){return t.FilterObserver.create(e,this.predicate,this)},n.prototype.createStreamForInternalFilter=function(t,e,r){return n.create(t,e,r)},n.prototype._innerPredicate=function(t,e){var n=this;return function(r,o,i){return e.predicate(r,o,i)&&t.call(n,r,o,i)}},n}(t.BaseStream);t.FilterStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.createObserver=function(e){return t.FilterWithStateObserver.create(e,this.predicate,this)},n.prototype.createStreamForInternalFilter=function(t,e,r){return n.create(t,e,r)},n}(t.FilterStream);t.FilterWithStateStream=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.createStream=function(e){return t.AnonymousStream.create(e)},t.fromArray=function(e,n){return void 0===n&&(n=t.Scheduler.create()),t.FromArrayStream.create(e,n)},t.fromPromise=function(e,n){return void 0===n&&(n=t.Scheduler.create()),t.FromPromiseStream.create(e,n)},t.fromEventPattern=function(e,n){return t.FromEventPatternStream.create(e,n)},t.interval=function(e,n){return void 0===n&&(n=t.Scheduler.create()),t.IntervalStream.create(e,n)},t.intervalRequest=function(e){return void 0===e&&(e=t.Scheduler.create()),t.IntervalRequestStream.create(e)},t.empty=function(){return t.createStream(function(t){t.completed()})},t.callFunc=function(e,n){return void 0===n&&(n=t.root),t.createStream(function(t){try{t.next(e.call(n,null))}catch(r){t.error(r)}t.completed()})},t.judge=function(t,e,n){return t()?e():n()},t.defer=function(e){return t.DeferStream.create(e)},t.just=function(e){return t.createStream(function(t){t.next(e),t.completed()})}}(wdFrp||(wdFrp={}));var wdFrp;!function(t){!function(t){t[t.TRIGGER=0]="TRIGGER",t[t.ENTER=1]="ENTER",t[t.LEAVE=2]="LEAVE"}(t.FilterState||(t.FilterState={}));t.FilterState}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(t,e){return t===e},n=function(){function t(t,n,r,o){this._time=null,this._value=null,this._actionType=null,this._comparer=null,this._time=t,this._value=n,this._actionType=r,this._comparer=o||e}return t.create=function(t,e,n,r){var o=new this(t,e,n,r);return o},Object.defineProperty(t.prototype,"time",{get:function(){return this._time},set:function(t){this._time=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"value",{get:function(){return this._value},set:function(t){this._value=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"actionType",{get:function(){return this._actionType},set:function(t){this._actionType=t},enumerable:!0,configurable:!0}),t.prototype.equals=function(t){return this._time===t.time&&this._comparer(this._value,t.value)},t}();t.Record=n}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t){e.call(this,null,null,null),this._messages=[],this._scheduler=null,this._scheduler=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},Object.defineProperty(n.prototype,"messages",{get:function(){return this._messages},set:function(t){this._messages=t},enumerable:!0,configurable:!0}),n.prototype.onNext=function(e){var n=null;n=t.JudgeUtils.isDirectObject(e)?t.Record.create(this._scheduler.clock,e,t.ActionType.NEXT,function(t,e){var n=!0;for(var r in t)if(t.hasOwnProperty(r)&&t[r]!==e[r]){n=!1;break}return n}):t.Record.create(this._scheduler.clock,e,t.ActionType.NEXT),this._messages.push(n)},n.prototype.onError=function(e){this._messages.push(t.Record.create(this._scheduler.clock,e,t.ActionType.ERROR))},n.prototype.onCompleted=function(){this._messages.push(t.Record.create(this._scheduler.clock,null,t.ActionType.COMPLETED))},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._scheduler.remove(this)},n.prototype.copy=function(){var t=n.create(this._scheduler);return t.messages=this._messages,t},n}(t.Observer);t.MockObserver=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(t,e){this._messages=[],this._scheduler=null,this._scheduler=t,this._messages=e}return t.create=function(t,e){var n=new this(t,e);return n},t.prototype.then=function(t,e,n){this._scheduler.setStreamMap(n,this._messages)},t}();t.MockPromise=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=200,n=1e3,r=function(r){function o(t){r.call(this),this._clock=null,this._isReset=!1,this._isDisposed=!1,this._timerMap=wdCb.Hash.create(),this._streamMap=wdCb.Hash.create(),this._subscribedTime=null,this._disposedTime=null,this._observer=null,this._isReset=t}return __extends(o,r),o.next=function(e,n){return t.JudgeUtils.isDirectObject(n)?t.Record.create(e,n,t.ActionType.NEXT,function(t,e){var n=!0;for(var r in t)if(t.hasOwnProperty(r)&&t[r]!==e[r]){n=!1;break}return n}):t.Record.create(e,n,t.ActionType.NEXT)},o.error=function(e,n){return t.Record.create(e,n,t.ActionType.ERROR)},o.completed=function(e){return t.Record.create(e,null,t.ActionType.COMPLETED)},o.create=function(t){void 0===t&&(t=!1);var e=new this(t);return e},Object.defineProperty(o.prototype,"clock",{get:function(){return this._clock},set:function(t){this._clock=t},enumerable:!0,configurable:!0}),o.prototype.setStreamMap=function(e,n){var r=this;n.forEach(function(n){var o=null;switch(n.actionType){case t.ActionType.NEXT:o=function(){e.next(n.value)};break;case t.ActionType.ERROR:o=function(){e.error(n.value)};break;case t.ActionType.COMPLETED:o=function(){e.completed()};break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("actionType"))}r._streamMap.addChild(String(n.time),o)})},o.prototype.remove=function(t){this._isDisposed=!0},o.prototype.publishRecursive=function(t,e,n){var r=this,o=null,i=null;this._setClock(),o=t.next,i=t.completed,t.next=function(e){o.call(t,e),r._tick(1)},t.completed=function(){i.call(t),r._tick(1)},n(e)},o.prototype.publishInterval=function(t,e,n,r){var i=10,a=[];for(this._setClock();i>0&&!this._isDisposed;)this._tick(n),a.push(o.next(this._clock,e)),e++,i--;return this.setStreamMap(t,a),NaN},o.prototype.publishIntervalRequest=function(t,e){var n=10,r=[],i=100,a=0;for(this._setClock();n>0&&!this._isDisposed;)this._tick(i),r.push(o.next(this._clock,a)),a++,n--;return this.setStreamMap(t,r),NaN},o.prototype._setClock=function(){this._isReset&&(this._clock=this._subscribedTime)},o.prototype.startWithTime=function(t,e,n){var r,o,i=this.createObserver(),a=this;return this._subscribedTime=e,this._disposedTime=n,this._clock=e,this._runAt(e,function(){r=t(),o=r.subscribe(i)}),this._runAt(n,function(){o.dispose(),a._isDisposed=!0}),this._observer=i,this.start(),i},o.prototype.startWithSubscribe=function(t,r){return void 0===r&&(r=e),this.startWithTime(t,r,n)},o.prototype.startWithDispose=function(t,r){return void 0===r&&(r=n),this.startWithTime(t,e,r)},o.prototype.publicAbsolute=function(t,e){this._runAt(t,function(){e()})},o.prototype.start=function(){for(var t=this._getMinAndMaxTime(),e=t[0],n=t[1],r=e;n>=r;)this._clock=r,this._exec(r,this._timerMap),this._clock=r,this._runStream(r),r++,n=this._getMinAndMaxTime()[1]},o.prototype.createStream=function(e){return t.TestStream.create(Array.prototype.slice.call(arguments,0),this)},o.prototype.createObserver=function(){return t.MockObserver.create(this)},o.prototype.createResolvedPromise=function(e,n){return t.MockPromise.create(this,[o.next(e,n),o.completed(e+1)])},o.prototype.createRejectPromise=function(e,n){return t.MockPromise.create(this,[o.error(e,n)])},o.prototype._getMinAndMaxTime=function(){var t=this._timerMap.getKeys().addChildren(this._streamMap.getKeys());return t=t.map(function(t){return Number(t)}).toArray(),[Math.min.apply(Math,t),Math.max.apply(Math,t)]},o.prototype._exec=function(t,e){var n=e.getChild(String(t));n&&n()},o.prototype._runStream=function(t){var e=this._streamMap.getChild(String(t));e&&e()},o.prototype._runAt=function(t,e){this._timerMap.addChild(String(t),e)},o.prototype._tick=function(t){this._clock+=t},o}(t.Scheduler);t.TestScheduler=r}(wdFrp||(wdFrp={}));var wdFrp;!function(t){!function(t){t[t.NEXT=0]="NEXT",t[t.ERROR=1]="ERROR",t[t.COMPLETED=2]="COMPLETED"}(t.ActionType||(t.ActionType={}));t.ActionType}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wdFrp;!function(t){var e=function(e){function n(t,n){e.call(this,null),this.scheduler=null,this._messages=null,this._messages=t,this.scheduler=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.subscribeCore=function(e){return this.scheduler.setStreamMap(e,this._messages),t.SingleDisposable.create()},n}(t.BaseStream);t.TestStream=e}(wdFrp||(wdFrp={}));var wd;!function(t){t.DebugConfig={isTest:!1,debugCollision:!1,showDebugPanel:!1}}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.clear=function(){this.count.renderGameObjects=0,this.count.drawCalls=0},e.init=function(){var e=this;this._startLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.STARTLOOP).subscribe(function(){t.DebugConfig.showDebugPanel&&(console.log("totalGameObjects:"+e.count.totalGameObjects+", renderGameObjects:"+e.count.renderGameObjects+", drawCalls:"+e.count.drawCalls),console.log("fps:"+e.during.fps),e.clear())})},e.dispose=function(){this._startLoopSubscription.dispose()},e.count={get totalGameObjects(){var e=0;return t.Director.getInstance().scene.getChildren().forEach(function(n){return n.hasComponent(t.SpacePartition)?void(e+=n.getComponent(t.SpacePartition).getChildren().getCount()):void e++}),e},renderGameObjects:0,drawCalls:0},e.during={get fps(){return t.Director.getInstance().fps}},e._startLoopSubscription=null,e}();t.DebugStatistics=e}(wd||(wd={}));var wdFrp;!function(t){t.fromCollection=function(e,n){void 0===n&&(n=t.Scheduler.create());var r=e.toArray();return 0===r.length?t.empty():t.fromArray(r,n)}}(wdFrp||(wdFrp={}));var wd;!function(t){function e(e,n){void 0===n&&(n="contract error"),t.Log.error(!e,n)}function n(e){return function(n,r,o){var i=o.value;return o.value=function(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];return t.Main.isTest&&e.apply(this,n),i.apply(this,n)},o}}function r(e){return function(n,r,o){var i=o.value;return o.value=function(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];var o=i.apply(this,n);if(t.Main.isTest){var a=[o].concat(n);e.apply(this,a)}return o},o}}function o(e){return function(n,r,o){var i=o.get;return o.get=function(){return t.Main.isTest&&e.call(this),i.call(this)},o}}function i(e){return function(n,r,o){var i=o.set;return o.set=function(n){t.Main.isTest&&e.call(this,n),i.call(this,n)},o}}function a(e){return function(n,r,o){var i=o.get;return o.get=function(){var n=i.call(this);return t.Main.isTest&&e.call(this,n),n},o}}function s(e){return function(n,r,o){var i=o.set;return o.set=function(n){var r=i.call(this,n);if(t.Main.isTest){var o=[r,n];e.apply(this,o)}},o}}function c(e){return function(n){t.Main.isTest&&e(n)}}t.assert=e,t.require=n,t.ensure=r,t.requireGetter=o,t.requireSetter=i,t.ensureGetter=a,t.ensureSetter=s,t.invariant=c}(wd||(wd={}));var wd;!function(t){function e(t,e,n){return function(r,o,i){var a=i.get;return i.get=function(){var r=null;return t.call(this)?e.call(this):(r=a.call(this),n.call(this,r),r)},i}}function n(t,e,n){return function(r,o,i){var a=i.value;return i.value=function(){for(var r=[],o=0;o<arguments.length;o++)r[o-0]=arguments[o];var i=null;return t.apply(this,r)?e.apply(this,r):(i=a.apply(this,r),n.apply(this,[i].concat(r)),i)},i}}t.cacheGetter=e,t.cache=n}(wd||(wd={}));var wd;!function(t){function e(t,e,n){return n}t.virtual=e}(wd||(wd={}));var wd;!function(t){function e(t){return function(e,n,r){var i=r.get,a=r.set;return r.get=function(){if(this.isPhysicsEngineAdapterExist()){var e=this.getPhysicsEngineAdapter()["get"+t](this.entityObject);return null!==e?e:this["_"+o(t)]}return i.call(this)},r.set=function(e){a.call(this,e),this.isPhysicsEngineAdapterExist()&&this.getPhysicsEngineAdapter()["set"+t](this.entityObject,e)},r}}function n(e){return function(n,i,a){var s=a.get,c=a.set;return a.get=function(){var n=t.Director.getInstance().scene;if(r(n)){var i=n.physicsEngineAdapter["get"+e]();return null!==i?i:this["_"+o(e)]}return s.call(this)},a.set=function(n){var o=t.Director.getInstance().scene;c.call(this,n),r(o)&&o.physicsEngineAdapter["set"+e](n)},a}}function r(t){return t.physicsEngineAdapter&&t.physicsEngineAdapter.world}function o(t){var e=t.slice(0,1);return""+e.toLowerCase()+t.slice(1)}t.operateBodyDataGetterAndSetter=e,t.operateWorldDataGetterAndSetter=n}(wd||(wd={}));var wd;!function(t){function e(e){return function(n){t.Script.addScript(e,n)}}t.script=e}(wd||(wd={}));var wd;!function(t){function e(t){return function(e,n,r){var o=r.value;return r.value=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];return this[t]?void 0:(this[t]=!0,o.apply(this,e))},r}}t.execOnlyOnce=e}(wd||(wd={}));var wd;!function(t){t.ABSTRACT_ATTRIBUTE=null}(wd||(wd={}));var wd;!function(t){t.DEG_TO_RAD=Math.PI/180,t.RAD_TO_DEG=180/Math.PI}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=new Float32Array(2),t.length>0&&(this.values[0]=t[0],this.values[1]=t[1])}return t.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;return n=0===t.length?new this:new this(t[0],t[1])},Object.defineProperty(t.prototype,"x",{get:function(){return this.values[0]},set:function(t){this.values[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.values[1]},set:function(t){this.values[1]=t},enumerable:!0,configurable:!0}),t.prototype.set=function(t,e){this.x=t,this.y=e},t.prototype.add=function(t){return this.values[0]=this.values[0]+t.values[0],this.values[1]=this.values[1]+t.values[1],this},t.prototype.mul=function(t){return this.values[0]=this.values[0]*t.values[0],this.values[1]=this.values[1]*t.values[1],this},t.prototype.copy=function(){return t.create(this.x,this.y)},t}();t.Vector2=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=null,this.values=new Float32Array(3),t.length>0&&(this.values[0]=t[0],this.values[1]=t[1],this.values[2]=t[2])}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;return n=0===t.length?new this:new this(t[0],t[1],t[2])},Object.defineProperty(e.prototype,"x",{get:function(){return this.values[0]},set:function(t){this.values[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.values[1]},set:function(t){this.values[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this.values[2]},set:function(t){this.values[2]=t},enumerable:!0,configurable:!0}),e.prototype.normalize=function(){var t=this.values,e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return 0===e?(t[0]=0,t[1]=0,t[2]=0,this):(t[0]=t[0]/e,t[1]=t[1]/e,t[2]=t[2]/e,t[0]===-0&&(t[0]=0),t[1]===-0&&(t[1]=0),t[2]===-0&&(t[2]=0),this)},e.prototype.isZero=function(){var t=this.values;return 0===t[0]&&0===t[1]&&0===t[2]},e.prototype.scale=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=this.values;if(1===t.length){var r=t[0];n[0]*=r,n[1]*=r,n[2]*=r}else if(3===t.length){var o=t[0],i=t[1],a=t[2];n[0]*=o,n[1]*=i,n[2]*=a}return this},e.prototype.set=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(3===t.length)this.x=t[0],this.y=t[1],this.z=t[2];else{var n=t[0];this.x=n.x,this.y=n.y,this.z=n.z}},e.prototype.sub=function(t){return this.values[0]=this.values[0]-t.values[0],this.values[1]=this.values[1]-t.values[1],this.values[2]=this.values[2]-t.values[2],this},e.prototype.sub2=function(t,e){return this.values[0]=t.values[0]-e.values[0],this.values[1]=t.values[1]-e.values[1],this.values[2]=t.values[2]-e.values[2],this},e.prototype.add=function(t){return this.values[0]=this.values[0]+t.values[0],this.values[1]=this.values[1]+t.values[1],this.values[2]=this.values[2]+t.values[2],this},e.prototype.add2=function(t,e){return this.values[0]=t.values[0]+e.values[0],this.values[1]=t.values[1]+e.values[1],this.values[2]=t.values[2]+e.values[2],this},e.prototype.mul=function(t){return this.values[0]=this.values[0]*t.values[0],this.values[1]=this.values[1]*t.values[1],this.values[2]=this.values[2]*t.values[2],this},e.prototype.mul2=function(t,e){return this.values[0]=t.values[0]*e.values[0],this.values[1]=t.values[1]*e.values[1],this.values[2]=t.values[2]*e.values[2],this},e.prototype.reverse=function(){return this.values[0]=-this.values[0],this.values[1]=-this.values[1],this.values[2]=-this.values[2],this},e.prototype.copy=function(){var t=e.create(),n=0,r=this.values.length;for(n=0;r>n;n++)t.values[n]=this.values[n];return t},e.prototype.toVector4=function(){return t.Vector4.create(this.values[0],this.values[1],this.values[2],1)},e.prototype.length=function(){var t=this.values;return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},e.prototype.cross=function(t,e){var n,r,o,i,a,s,c,u,l;return n=t.values,r=e.values,o=this.values,i=n[0],a=n[1],s=n[2],c=r[0],u=r[1],l=r[2],o[0]=a*l-u*s,o[1]=s*c-l*i,o[2]=i*u-c*a,this},e.prototype.lerp=function(t,e,n){var r=t.values,o=e.values,i=this.values;return i[0]=r[0]+n*(o[0]-r[0]),i[1]=r[1]+n*(o[1]-r[1]),i[2]=r[2]+n*(o[2]-r[2]),this},e.prototype.dot=function(t){var e=this.values,n=t.values;return e[0]*n[0]+e[1]*n[1]+e[2]*n[2]},e.prototype.min=function(t){return this.x>t.x&&(this.x=t.x),this.y>t.y&&(this.y=t.y),this.z>t.z&&(this.z=t.z),this},e.prototype.max=function(t){return this.x<t.x&&(this.x=t.x),this.y<t.y&&(this.y=t.y),this.z<t.z&&(this.z=t.z),this},e.prototype.isEqual=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},e.prototype.toArray=function(){return[this.x,this.y,this.z]},e.prototype.applyMatrix4=function(t){var e=this.x,n=this.y,r=this.z,o=t.values;return this.x=o[0]*e+o[4]*n+o[8]*r+o[12],this.y=o[1]*e+o[5]*n+o[9]*r+o[13],this.z=o[2]*e+o[6]*n+o[10]*r+o[14],this},e.prototype.distanceTo=function(t){return Math.sqrt(this.distanceToSquared(t))},e.prototype.distanceToSquared=function(t){var e=this.x-t.x,n=this.y-t.y,r=this.z-t.z;return Math.pow(e,2)+Math.pow(n,2)+Math.pow(r,2)},e.up=e.create(0,1,0),e.forward=e.create(0,0,1),e.right=e.create(1,0,0),e}();t.Vector3=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=new Float32Array(4),t.length>0&&(this.values[0]=t[0],this.values[1]=t[1],this.values[2]=t[2],this.values[3]=t[3])}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;return n=0===t.length?new this:new this(t[0],t[1],t[2],t[3])},Object.defineProperty(e.prototype,"x",{get:function(){return this.values[0]},set:function(t){this.values[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.values[1]},set:function(t){this.values[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this.values[2]},set:function(t){this.values[2]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"w",{get:function(){return this.values[3]},set:function(t){this.values[3]=t},enumerable:!0,configurable:!0}),e.prototype.normalize=function(){var t=this.values,n=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3]);return 0===n?e.create(0,0,0,0):(t[0]=t[0]/n,t[1]=t[1]/n,t[2]=t[2]/n,t[3]=t[3]/n,this)},e.prototype.copy=function(){return this.copyHelper(e.create())},e.prototype.toVector3=function(){return t.Vector3.create(this.values[0],this.values[1],this.values[2])},e.prototype.multiplyScalar=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},e.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},e.prototype.set=function(t,e,n,r){this.x=t,this.y=e,this.z=n,this.w=r},e.prototype.copyHelper=function(t){var e=t,n=0,r=this.values.length;for(n=0;r>n;n++)e.values[n]=this.values[n];return e},e}();t.Vector4=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=null,this._matrixArr=null,1===t.length?this.values=t[0]:this.values=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._matrixArr=[]}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;return n=0===t.length?new this:new this(t[0])},e.prototype.push=function(){this._matrixArr.push(this.values)},e.prototype.pop=function(){this.values=this._matrixArr.pop()},e.prototype.set=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=this.values,r=null;if(1===t.length){var o=t[0];r=o.values}else r=[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]];return n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=r[4],n[5]=r[5],n[6]=r[6],n[7]=r[7],n[8]=r[8],n[9]=r[9],n[10]=r[10],n[11]=r[11],n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15],this},e.prototype.setIdentity=function(){var t=this.values;return t[0]=1,t[4]=0,t[8]=0,t[12]=0,t[1]=0,t[5]=1,t[9]=0,t[13]=0,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1,this},e.prototype.invert=function(){var t,e,n,r,o,i,a,s,c,u,l,h,p,f,d,_,y,g,m,v,b,C,w,E,T,O,S,D,x,L;return L=this.values,t=L[0],e=L[1],n=L[2],r=L[3],o=L[4],i=L[5],a=L[6],s=L[7],c=L[8],u=L[9],l=L[10],h=L[11],p=L[12],f=L[13],d=L[14],_=L[15],y=t*i-e*o,g=t*a-n*o,m=t*s-r*o,v=e*a-n*i,b=e*s-r*i,C=n*s-r*a,w=c*f-u*p,E=c*d-l*p,T=c*_-h*p,O=u*d-l*f,S=u*_-h*f,D=l*_-h*d,x=1/(y*D-g*S+m*O+v*T-b*E+C*w),L[0]=(i*D-a*S+s*O)*x,L[1]=(-e*D+n*S-r*O)*x,L[2]=(f*C-d*b+_*v)*x,L[3]=(-u*C+l*b-h*v)*x,L[4]=(-o*D+a*T-s*E)*x,L[5]=(t*D-n*T+r*E)*x,L[6]=(-p*C+d*m-_*g)*x,L[7]=(c*C-l*m+h*g)*x,L[8]=(o*S-i*T+s*w)*x,L[9]=(-t*S+e*T-r*w)*x,L[10]=(p*b-f*m+_*y)*x,L[11]=(-c*b+u*m-h*y)*x,L[12]=(-o*O+i*E-a*w)*x,L[13]=(t*O-e*E+n*w)*x,L[14]=(-p*v+f*g-d*y)*x,L[15]=(c*v-u*g+l*y)*x,this},e.prototype.invertTo3x3=function(){var e,n,r,o,i,a,s,c,u,l,h,p,f,d=t.Matrix3.create();return l=this.values,h=d.values,e=l[10]*l[5]-l[6]*l[9],n=-l[10]*l[1]+l[2]*l[9],r=l[6]*l[1]-l[2]*l[5],o=-l[10]*l[4]+l[6]*l[8],i=l[10]*l[0]-l[2]*l[8],a=-l[6]*l[0]+l[2]*l[4],s=l[9]*l[4]-l[5]*l[8],c=-l[9]*l[0]+l[1]*l[8],u=l[5]*l[0]-l[1]*l[4],p=l[0]*e+l[1]*o+l[2]*s,0===p?(t.Log.warn("can't invert matrix, determinant is 0"),d):(f=1/p,h[0]=f*e,h[1]=f*n,h[2]=f*r,h[3]=f*o,h[4]=f*i,h[5]=f*a,h[6]=f*s,h[7]=f*c,h[8]=f*u,d)},e.prototype.transpose=function(){var t,e=this.values;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},e.prototype.setTranslate=function(t,e,n){var r=this.values;return r[0]=1,r[4]=0,r[8]=0,r[12]=t,r[1]=0,r[5]=1,r[9]=0,r[13]=e,r[2]=0,r[6]=0,r[10]=1,r[14]=n,r[3]=0,r[7]=0,r[11]=0,r[15]=1,this},e.prototype.translate=function(t,n,r){return this.applyMatrix(e.create().setTranslate(t,n,r)),this},e.prototype.setRotate=function(t,e,n,r){var o,i,a,s,c,u,l,h,p,f,d,_,t=Math.PI*t/180;return o=this.values,i=Math.sin(t),a=Math.cos(t),0!==e&&0===n&&0===r?(0>e&&(i=-i),o[0]=1,o[4]=0,o[8]=0,o[12]=0,o[1]=0,o[5]=a,o[9]=-i,o[13]=0,o[2]=0,o[6]=i,o[10]=a,o[14]=0,o[3]=0,o[7]=0,o[11]=0,o[15]=1):0===e&&0!==n&&0===r?(0>n&&(i=-i),o[0]=a,o[4]=0,o[8]=i,o[12]=0,o[1]=0,o[5]=1,o[9]=0,o[13]=0,o[2]=-i,o[6]=0,o[10]=a,o[14]=0,o[3]=0,o[7]=0,o[11]=0,o[15]=1):0===e&&0===n&&0!==r?(0>r&&(i=-i),o[0]=a,o[4]=-i,o[8]=0,o[12]=0,o[1]=i,o[5]=a,o[9]=0,o[13]=0,o[2]=0,o[6]=0,o[10]=1,o[14]=0,o[3]=0,o[7]=0,o[11]=0,o[15]=1):(s=Math.sqrt(e*e+n*n+r*r),1!==s&&(c=1/s,e*=c,n*=c,r*=c),u=1-a,l=e*n,h=n*r,p=r*e,f=e*i,d=n*i,_=r*i,o[0]=e*e*u+a,o[1]=l*u+_,o[2]=p*u-d,o[3]=0,o[4]=l*u-_,o[5]=n*n*u+a,o[6]=h*u+f,o[7]=0,o[8]=p*u+d,o[9]=h*u-f,o[10]=r*r*u+a,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1),this},e.prototype.rotate=function(){for(var t=[],n=0;n<arguments.length;n++)t[n-0]=arguments[n];var r=t[0];if(2===t.length){var o=t[1];this.applyMatrix(e.create().setRotate(r,o.values[0],o.values[1],o.values[2]))}else if(4===t.length){var i=t[1],a=t[2],s=t[3];this.applyMatrix(e.create().setRotate(r,i,a,s))}return this},e.prototype.setScale=function(t,e,n){var r=this.values;return r[0]=t,r[4]=0,r[8]=0,r[12]=0,r[1]=0,r[5]=e,r[9]=0,r[13]=0,r[2]=0,r[6]=0,r[10]=n,r[14]=0,r[3]=0,r[7]=0,r[11]=0,r[15]=1,this},e.prototype.scale=function(t,n,r){return this.applyMatrix(e.create().setScale(t,n,r)),this},e.prototype.setLookAt=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r,o,i,a,s,c;3===e.length?(a=e[0],s=e[1],c=e[2]):9===e.length&&(a=t.Vector3.create(e[0],e[1],e[2]),s=t.Vector3.create(e[3],e[4],e[5]),c=t.Vector3.create(e[6],e[7],e[8])),r=t.Vector3.create(),i=a.copy().sub(s).normalize(),o=c.copy().normalize(),r.cross(o,i).normalize(),o.cross(i,r);var u=this.values;return u[0]=r.x,u[1]=r.y,u[2]=r.z,u[3]=0,u[4]=o.x,u[5]=o.y,u[6]=o.z,u[7]=0,u[8]=i.x,u[9]=i.y,u[10]=i.z,u[11]=0,u[12]=a.x,u[13]=a.y,u[14]=a.z,u[15]=1,this},e.prototype.lookAt=function(){for(var t=[],n=0;n<arguments.length;n++)t[n-0]=arguments[n];var r=e.create();
return this.applyMatrix(r.setLookAt.apply(r,t)),this},e.prototype.setOrtho=function(t,e,n,r,o,i){var a,s,c,u=this.values;return a=1/(e-t),s=1/(r-n),c=1/(i-o),u[0]=2*a,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*s,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=-2*c,u[11]=0,u[12]=-(e+t)*a,u[13]=-(r+n)*s,u[14]=-(i+o)*c,u[15]=1,this},e.prototype.ortho=function(t,n,r,o,i,a){return this.applyMatrix(e.create().setOrtho(t,n,r,o,i,a)),this},e.prototype.setPerspective=function(e,n,r,o){var i=null,a=null,s=null,c=null,e=Math.PI*e/180/2;return s=Math.sin(e),t.Log.error(0===s,t.Log.info.FUNC_MUST_NOT_BE("frustum","null")),a=1/(o-r),c=Math.cos(e)/s,i=this.values,i[0]=c/n,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=c,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=-(o+r)*a,i[11]=-1,i[12]=0,i[13]=0,i[14]=-2*r*o*a,i[15]=0,this},e.prototype.perspective=function(t,n,r,o){return this.applyMatrix(e.create().setPerspective(t,n,r,o)),this},e.prototype.applyMatrix=function(t,e){void 0===e&&(e=!1);var n=this,r=t.copy();return e?r.multiply(n):(this.values=r.multiply(n).values,this)},e.prototype.multiply=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null,r=null,o=null;o=this.values,1===t.length?(n=this.values,r=t[0].values):2===t.length&&(n=t[0].values,r=t[1].values);var i=n[0],a=n[1],s=n[2],c=n[3],u=n[4],l=n[5],h=n[6],p=n[7],f=n[8],d=n[9],_=n[10],y=n[11],g=n[12],m=n[13],v=n[14],b=n[15],C=r[0],w=r[1],E=r[2],T=r[3],O=r[4],S=r[5],D=r[6],x=r[7],L=r[8],M=r[9],A=r[10],F=r[11],R=r[12],P=r[13],N=r[14],U=r[15];return o[0]=C*i+w*u+E*f+T*g,o[1]=C*a+w*l+E*d+T*m,o[2]=C*s+w*h+E*_+T*v,o[3]=C*c+w*p+E*y+T*b,o[4]=O*i+S*u+D*f+x*g,o[5]=O*a+S*l+D*d+x*m,o[6]=O*s+S*h+D*_+x*v,o[7]=O*c+S*p+D*y+x*b,o[8]=L*i+M*u+A*f+F*g,o[9]=L*a+M*l+A*d+F*m,o[10]=L*s+M*h+A*_+F*v,o[11]=L*c+M*p+A*y+F*b,o[12]=R*i+P*u+N*f+U*g,o[13]=R*a+P*l+N*d+U*m,o[14]=R*s+P*h+N*_+U*v,o[15]=R*c+P*p+N*y+U*b,this},e.prototype.multiplyVector4=function(e){var n=this.values,r=e.values,o=[];return o[0]=r[0]*n[0]+r[1]*n[4]+r[2]*n[8]+r[3]*n[12],o[1]=r[0]*n[1]+r[1]*n[5]+r[2]*n[9]+r[3]*n[13],o[2]=r[0]*n[2]+r[1]*n[6]+r[2]*n[10]+r[3]*n[14],o[3]=r[0]*n[3]+r[1]*n[7]+r[2]*n[11]+r[3]*n[15],t.Vector4.create(o[0],o[1],o[2],o[3])},e.prototype.multiplyVector3=function(e){var n=this.values,r=e.values,o=[];return o[0]=r[0]*n[0]+r[1]*n[4]+r[2]*n[8],o[1]=r[0]*n[1]+r[1]*n[5]+r[2]*n[9],o[2]=r[0]*n[2]+r[1]*n[6]+r[2]*n[10],t.Vector3.create(o[0],o[1],o[2])},e.prototype.multiplyPoint=function(e){var n=this.values,r=e.values,o=[];return o[0]=r[0]*n[0]+r[1]*n[4]+r[2]*n[8]+n[12],o[1]=r[0]*n[1]+r[1]*n[5]+r[2]*n[9]+n[13],o[2]=r[0]*n[2]+r[1]*n[6]+r[2]*n[10]+n[14],t.Vector3.create(o[0],o[1],o[2])},e.prototype.copy=function(){var t=e.create(),n=0,r=this.values.length;for(n=0;r>n;n++)t.values[n]=this.values[n];return t},e.prototype.getX=function(){return t.Vector3.create(this.values[0],this.values[1],this.values[2])},e.prototype.getY=function(){return t.Vector3.create(this.values[4],this.values[5],this.values[6])},e.prototype.getZ=function(){return t.Vector3.create(this.values[8],this.values[9],this.values[10])},e.prototype.getTranslation=function(){return t.Vector3.create(this.values[12],this.values[13],this.values[14])},e.prototype.getScale=function(){return t.Vector3.create(this.getX().length(),this.getY().length(),this.getZ().length())},e.prototype.getRotation=function(){return t.Quaternion.create().setFromMatrix(this)},e.prototype.getEulerAngles=function(){var e,n,r,o,i,a,s,c,u=this.getScale();return o=u.x,i=u.y,a=u.z,s=this.values,n=Math.asin(-s[2]/o),c=.5*Math.PI,c>n?n>-c?(e=Math.atan2(s[6]/i,s[10]/a),r=Math.atan2(s[1]/o,s[0]/o)):(r=0,e=-Math.atan2(s[4]/i,s[5]/i)):(r=0,e=Math.atan2(s[4]/i,s[5]/i)),t.Vector3.create(e,n,r).scale(t.RAD_TO_DEG)},e.prototype.setTRS=function(t,e,n){var r,o,i,a,s,c,u,l,h,p,f,d,_,y,g,m,v,b,C,w,E,T,O;return r=t.x,o=t.y,i=t.z,a=e.x,s=e.y,c=e.z,u=e.w,l=n.x,h=n.y,p=n.z,f=a+a,d=s+s,_=c+c,y=a*f,g=a*d,m=a*_,v=s*d,b=s*_,C=c*_,w=u*f,E=u*d,T=u*_,O=this.values,O[0]=(1-(v+C))*l,O[1]=(g+T)*l,O[2]=(m-E)*l,O[3]=0,O[4]=(g-T)*h,O[5]=(1-(y+C))*h,O[6]=(b+w)*h,O[7]=0,O[8]=(m+E)*p,O[9]=(b-w)*p,O[10]=(1-(y+v))*p,O[11]=0,O[12]=r,O[13]=o,O[14]=i,O[15]=1,this},__decorate([t.require(function(e,n,r,o,i,a){t.assert(e!==n&&r!==o&&i!==a,t.Log.info.FUNC_MUST_NOT_BE("frustum","null"))})],e.prototype,"setOrtho",null),__decorate([t.require(function(e,n,r,o){t.assert(r!==o&&0!==n,t.Log.info.FUNC_MUST_NOT_BE("frustum","null")),t.assert(r>0,t.Log.info.FUNC_MUST("near","> 0")),t.assert(o>0,t.Log.info.FUNC_MUST("far","> 0"))})],e.prototype,"setPerspective",null),e}();t.Matrix4=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=null,1===t.length?this.values=t[0]:this.values=new Float32Array([1,0,0,0,1,0,0,0,1])}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;return n=0===t.length?new this:new this(t[0])},Object.defineProperty(e.prototype,"a",{get:function(){return this.values[0]},set:function(t){this.values[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"c",{get:function(){return this.values[1]},set:function(t){this.values[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"b",{get:function(){return this.values[3]},set:function(t){this.values[3]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"d",{get:function(){return this.values[4]},set:function(t){this.values[4]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tx",{get:function(){return this.values[6]},set:function(t){this.values[6]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ty",{get:function(){return this.values[7]},set:function(t){this.values[7]=t},enumerable:!0,configurable:!0}),e.prototype.setIdentity=function(){var t=this.values;return t[0]=1,t[3]=0,t[6]=0,t[1]=0,t[4]=1,t[7]=0,t[2]=0,t[5]=0,t[8]=1,this},e.prototype.invert=function(){var t=this.values[0],e=this.values[1],n=this.values[3],r=this.values[4],o=this.values[6],i=this.values[7],a=t*r-e*n;return this.values[0]=r/a,this.values[1]=-e/a,this.values[3]=-n/a,this.values[4]=t/a,this.values[6]=(n*i-r*o)/a,this.values[7]=-(t*i-e*o)/a,this},e.prototype.multiplyScalar=function(t){var e=this.values;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this},e.prototype.multiplyVector2=function(e){var n=e.x,r=e.y,o=t.Vector2.create(),i=this.values;return o.x=i[0]*n+i[3]*r,o.y=i[1]*n+i[4]*r,o},e.prototype.multiplyPoint=function(e){var n=e.x,r=e.y,o=t.Vector2.create(),i=this.values;return o.x=i[0]*n+i[3]*r+this.tx,o.y=i[1]*n+i[4]*r+this.ty,o},e.prototype.multiply=function(t){var e=this.a*t.a+this.c*t.b,n=this.b*t.a+this.d*t.b,r=this.a*t.c+this.c*t.d,o=this.b*t.c+this.d*t.d,i=this.a*t.tx+this.c*t.ty+this.tx,a=this.b*t.tx+this.d*t.ty+this.ty;return this.a=e,this.b=n,this.c=r,this.d=o,this.tx=i,this.ty=a,this},e.prototype.transpose=function(){var t,e=this.values;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},e.prototype.copy=function(){return e.create().set(this)},e.prototype.set=function(t){var e=this.values,n=t.values;return e[0]=n[0],e[3]=n[3],e[6]=n[6],e[1]=n[1],e[4]=n[4],e[7]=n[7],e[2]=n[2],e[5]=n[5],e[8]=n[8],this},e.prototype.setTS=function(t,e){this.setPosition(t.x,t.y),this.setScale(e.x,e.y)},e.prototype.rotate=function(e){var n=e*t.DEG_TO_RAD,r=Math.cos(n),o=Math.sin(n),i=this.a*r+this.c*o,a=this.b*r+this.d*o,s=this.a*-o+this.c*r,c=this.b*-o+this.d*r;return this.a=i,this.b=a,this.c=s,this.d=c,this},e.prototype.setRotation=function(e){var n=e*t.DEG_TO_RAD,r=Math.cos(n),o=Math.sin(n),i=this.values;return i[0]=r,i[1]=-o,i[3]=o,i[4]=r,this},e.prototype.translate=function(t,e){this.tx+=this.a*t+this.c*e,this.ty+=this.b*t+this.d*e},e.prototype.setPosition=function(t,e){this.tx=t,this.ty=e},e.prototype.scale=function(t,e){return this.a*=t,this.b*=t,this.c*=e,this.d*=e,this},e.prototype.setScale=function(t,e){var n=this.values;return n[0]=t,n[4]=e,this},e.prototype.getTranslation=function(){return t.Vector2.create(this.tx,this.ty)},e.prototype.getScale=function(){return t.Vector2.create(Math.sqrt(this.a*this.a+this.b*this.b),Math.sqrt(this.c*this.c+this.d*this.d))},e.prototype.getRotation=function(){return this._getSkewX()},e.prototype.getSkew=function(){return t.Vector2.create(this._getSkewX(),this._getSkewY())},e.prototype._getDeltaTransformPoint=function(t,e){return{x:e.x*t.a+e.y*t.c+0,y:e.x*t.b+e.y*t.d+0}},e.prototype._getSkewX=function(){var t=this._getDeltaTransformPoint(this,{x:0,y:1});return 180/Math.PI*Math.atan2(t.y,t.x)-90},e.prototype._getSkewY=function(){var t=this._getDeltaTransformPoint(this,{x:1,y:0});return 180/Math.PI*Math.atan2(t.y,t.x)},e}();t.Matrix3=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===r&&(r=1),this.x=null,this.y=null,this.z=null,this.w=null,this.x=t,this.y=e,this.z=n,this.w=r}return e.create=function(t,e,n,r){var o=new this(t,e,n,r);return o},e.prototype.setFromEulerAngles=function(e){var n,r,o,i,a,s,c,u=e.x,l=e.y,h=e.z;return c=.5*t.DEG_TO_RAD,u*=c,l*=c,h*=c,n=Math.sin(u),r=Math.cos(u),o=Math.sin(l),i=Math.cos(l),a=Math.sin(h),s=Math.cos(h),this.x=n*i*s-r*o*a,this.y=r*o*s+n*i*a,this.z=r*i*a-n*o*s,this.w=r*i*s+n*o*a,this},e.prototype.multiply=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n,r,o,i,a,s,c,u,l,h,p=this;return 1===t.length?(l=this,h=t[0]):2===t.length&&(l=t[0],h=t[1]),n=l.x,r=l.y,o=l.z,i=l.w,a=h.x,s=h.y,c=h.z,u=h.w,p.x=i*a+n*u+r*c-o*s,p.y=i*s+r*u+o*a-n*c,p.z=i*c+o*u+n*s-r*a,p.w=i*u-n*a-r*s-o*c,p},e.prototype.setFromMatrix=function(t){var e,n,r,o,i,a,s,c,u,l,h,p,f,d,_,y;return y=t.values,e=y[0],n=y[1],r=y[2],o=y[4],i=y[5],a=y[6],s=y[8],c=y[9],u=y[10],f=1/Math.sqrt(e*e+n*n+r*r),d=1/Math.sqrt(o*o+i*i+a*a),_=1/Math.sqrt(s*s+c*c+u*u),e*=f,n*=f,r*=f,o*=d,i*=d,a*=d,s*=_,c*=_,u*=_,l=e+i+u,l>=0?(h=Math.sqrt(l+1),this.w=.5*h,h=.5/h,this.x=(a-c)*h,this.y=(s-r)*h,this.z=(n-o)*h):e>i?e>u?(p=e-(i+u)+1,p=Math.sqrt(p),this.x=.5*p,p=.5/p,this.w=(a-c)*p,this.y=(n+o)*p,this.z=(r+s)*p):(p=u-(e+i)+1,p=Math.sqrt(p),this.z=.5*p,p=.5/p,this.w=(n-o)*p,this.x=(s+r)*p,this.y=(c+a)*p):i>u?(p=i-(u+e)+1,p=Math.sqrt(p),this.y=.5*p,p=.5/p,this.w=(s-r)*p,this.z=(a+c)*p,this.x=(o+n)*p):(p=u-(e+i)+1,p=Math.sqrt(p),this.z=.5*p,p=.5/p,this.w=(n-o)*p,this.x=(s+r)*p,this.y=(c+a)*p),this},e.prototype.setFromAxisAngle=function(e,n){var r,o;return n=n.normalize(),e*=.5*t.DEG_TO_RAD,r=Math.sin(e),o=Math.cos(e),this.x=r*n.x,this.y=r*n.y,this.z=r*n.z,this.w=o,this},e.prototype.invert=function(){return this.conjugate().normalize()},e.prototype.conjugate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},e.prototype.clone=function(){return e.create(this.x,this.y,this.z,this.w)},e.prototype.copy=function(){return e.create(this.x,this.y,this.z,this.w)},e.prototype.normalize=function(){var t=this.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},e.prototype.length=function(){var t,e,n,r;return t=this.x,e=this.y,n=this.z,r=this.w,Math.sqrt(t*t+e*e+n*n+r*r)},e.prototype.multiplyVector3=function(e){var n=this,r=e.x,o=e.y,i=e.z,a=n.x,s=n.y,c=n.z,u=n.w,l=u*r+s*i-c*o,h=u*o+c*r-a*i,p=u*i+a*o-s*r,f=-a*r-s*o-c*i;return t.Vector3.create(l*u+f*-a+h*-c-p*-s,h*u+f*-s+p*-a-l*-c,p*u+f*-c+l*-s-h*-a)},e.prototype.set=function(t,e,n,r){this.x=t,this.y=e,this.z=n,this.w=r},e.prototype.sub=function(t){var e=t.copy().invert().multiply(this);return this.set(e.x,e.y,e.z,e.w),this},e.prototype.getEulerAngles=function(){var e,n,r,o,i,a,s,c;return o=this.x,i=this.y,a=this.z,s=this.w,c=2*(s*i-o*a),-.99999>=c?(e=2*Math.atan2(o,s),n=-Math.PI/2,r=0):c>=.99999?(e=2*Math.atan2(o,s),n=Math.PI/2,r=0):(e=Math.atan2(2*(s*o+i*a),1-2*(o*o+i*i)),n=Math.asin(c),r=Math.atan2(2*(s*a+o*i),1-2*(i*i+a*a))),t.Vector3.create(e,n,r).scale(t.RAD_TO_DEG)},e.prototype.slerp=function(t,n,r){var o,i,a=r,s=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w,c=!1;if(0>s&&(c=!0,s=-s),s>.999999)i=1-a,o=c?-a:a;else{var u=Math.acos(s),l=1/Math.sin(u);i=Math.sin((1-a)*u)*l,o=c?-Math.sin(a*u)*l:Math.sin(a*u)*l}return e.create(i*t.x+o*n.x,i*t.y+o*n.y,i*t.z+o*n.z,i*t.w+o*n.w)},e}();t.Quaternion=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(e,n,r,o){this.normal=t.Vector3.create(0,1,0),this.d=0,this.normal=t.Vector3.create(e,n,r),this.d=o}return e.create=function(t,e,n,r){var o=new this(t,e,n,r);return o},e.prototype.getReflectionMatrix=function(){this.normalize();var e=this.normal.x,n=this.normal.y,r=this.normal.z,o=-2*e,i=-2*n,a=-2*r,s=t.Matrix4.create();return s.values[0]=o*e+1,s.values[1]=i*e,s.values[2]=a*e,s.values[3]=0,s.values[4]=o*n,s.values[5]=i*n+1,s.values[6]=a*n,s.values[7]=0,s.values[8]=o*r,s.values[9]=i*r,s.values[10]=a*r+1,s.values[11]=0,s.values[12]=o*this.d,s.values[13]=i*this.d,s.values[14]=a*this.d,s.values[15]=1,s},e.prototype.normalize=function(){var t=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),e=0;return 0!==t&&(e=1/t),this.normal.x*=e,this.normal.y*=e,this.normal.z*=e,this.d*=e,this},e.prototype.copy=function(){return e.create(this.normal.x,this.normal.y,this.normal.z,this.d)},e.prototype.dotCoordinate=function(t){return this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z+this.d},e}();t.Plane=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e){this._origin=null,this._direction=null,this._origin=t,this._direction=e}return e.create=function(t,e){var n=new this(t,e);return n},e.prototype.isIntersectWithAABB=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,o=null,i=t.Vector3.create(),a=null,s=null,c=t.Vector3.create(),u=t.Vector3.create(),l=this._origin,h=this._direction;if(1===e.length){var p=e[0];r=p.center,o=p.halfExtents}else if(2===e.length){var f=e[0],d=e[1];r=t.AABBShape.getCenter(f,d),o=t.AABBShape.getHalfExtents(f,d)}return i.sub2(l,r),a=t.Vector3.create(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z)),u.mul2(i,h),a.x>o.x&&u.x>=0?!1:a.y>o.y&&u.y>=0?!1:a.z>o.z&&u.z>=0?!1:(s=t.Vector3.create(Math.abs(h.x),Math.abs(h.y),Math.abs(h.z)),c.cross(h,i),c.set(Math.abs(c.x),Math.abs(c.y),Math.abs(c.z)),c.x>o.y*s.z+o.z*s.y?!1:c.y>o.x*s.z+o.z*s.x?!1:c.z>o.x*s.y+o.y*s.x?!1:!0)},e.prototype.isIntersectWithSphere=function(e){var n=e.center,r=e.radius,o=t.Vector3.create(),i=0,a=0,s=0,c=0,u=this._origin,l=this._direction;return o.sub2(u,n),o.dot(o)<r*r?!0:(i=l.dot(l),a=2*l.dot(o),s=n.dot(n),s+=u.dot(u),s-=2*n.dot(u),s-=r*r,c=a*a-4*i*s,0>c?!1:!0)},e}();t.Ray=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this.uid=null,this._tagList=wdCb.Collection.create(),this.uid=t._count,t._count+=1}return t.prototype.addTag=function(t){this._tagList.addChild(t)},t.prototype.removeTag=function(t){this._tagList.removeChild(t)},t.prototype.getTagList=function(){return this._tagList},t.prototype.hasTag=function(t){return this._tagList.hasChild(t)},t.prototype.containTag=function(t){return this._tagList.hasChildWithFunc(function(e){return e.indexOf(t)>-1})},t._count=1,t}();t.Entity=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.entityObject=null}return __extends(n,e),n.prototype.init=function(){},n.prototype.dispose=function(){},Object.defineProperty(n.prototype,"transform",{get:function(){return this.entityObject?this.entityObject.transform:null},enumerable:!0,configurable:!0}),n.prototype.addToObject=function(t){this.entityObject&&this.entityObject.removeComponent(this),this.entityObject=t},n.prototype.removeFromObject=function(t){this.entityObject=null},__decorate([t.virtual],n.prototype,"init",null),__decorate([t.virtual],n.prototype,"dispose",null),n}(t.Entity);t.Component=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(){function t(){this._scheduleCount=0,this._schedules=wdCb.Hash.create()}return t.create=function(){var t=new this;return t},t.prototype.update=function(t){var e=this;this._schedules.forEach(function(n,r){n.isStop||n.isPause||(n.update(t),n.isFinish&&e.remove(r))})},t.prototype.scheduleLoop=function(t,e){return void 0===e&&(e=[]),this._schedule(i,Array.prototype.slice.call(arguments,0))},t.prototype.scheduleFrame=function(t,e,n){return void 0===e&&(e=1),this._schedule(a,Array.prototype.slice.call(arguments,0))},t.prototype.scheduleInterval=function(t,e,n){return void 0===e&&(e=0),this._schedule(o,Array.prototype.slice.call(arguments,0))},t.prototype.scheduleTime=function(t,e,n){return void 0===e&&(e=0),this._schedule(r,Array.prototype.slice.call(arguments,0))},t.prototype.pause=function(t){if(0===arguments.length){var e=this;this._schedules.forEach(function(t,n){e.pause(n)})}else if(1===arguments.length){var n=this._schedules.getChild(arguments[0]);n.pause()}},t.prototype.resume=function(t){if(0===arguments.length){var e=this;this._schedules.forEach(function(t,n){e.resume(n)})}else if(1===arguments.length){var n=this._schedules.getChild(arguments[0]);n.resume()}},t.prototype.start=function(t){if(0===arguments.length){var e=this;this._schedules.forEach(function(t,n){e.start(n)})}else if(1===arguments.length){var n=this._schedules.getChild(arguments[0]);n.start()}},t.prototype.stop=function(t){if(0===arguments.length){var e=this;this._schedules.forEach(function(t,n){e.stop(n)})}else if(1===arguments.length){var n=this._schedules.getChild(arguments[0]);n.stop()}},t.prototype.has=function(t){return!!this._schedules.hasChild(t)},t.prototype.remove=function(t){this._schedules.removeChild(t)},t.prototype.removeAll=function(){this._schedules.removeAllChildren()},t.prototype._schedule=function(t,e){var n=this._buildId();return this._schedules.setValue(n,t.create.apply(t,e)),n},t.prototype._buildId=function(){return"Schedule_"+this._scheduleCount++},t}();t.Scheduler=e;var n=function(){function e(e,n){this.isPause=!1,this.isStop=!1,this.pauseTime=null,this.pauseElapsed=null,this.startTime=null,this.isFinish=!1,this.task=null,this.args=null,this.timeController=t.CommonTimeController.create(),this.task=e,this.args=n}return e.prototype.pause=function(){this.isPause=!0,this.timeController.pause()},e.prototype.resume=function(){this.isPause=!1,this.timeController.resume()},e.prototype.start=function(){this.isStop=!1,this.timeController.start()},e.prototype.stop=function(){this.isStop=!0,this.timeController.stop()},e.prototype.finish=function(){this.isFinish=!0},e}(),r=function(t){function e(e,n,r){void 0===n&&(n=0),void 0===r&&(r=[]),t.call(this,e,r),this._time=null,this._time=n}return __extends(e,t),e.create=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=[]);var r=new this(t,e,n);return r},e.prototype.update=function(t){var e=this.timeController.computeElapseTime(t);e>=this._time&&(this.task.apply(this,this.args),this.finish())},e}(n),o=function(t){function e(e,n,r){void 0===n&&(n=0),void 0===r&&(r=[]),t.call(this,e,r),this._intervalTime=null,this._elapsed=0,this._intervalTime=n}return __extends(e,t),e.create=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=[]);var r=new this(t,e,n);return r},e.prototype.update=function(t){var e=this.timeController.computeElapseTime(t);e-this._elapsed>=this._intervalTime&&(this.task.apply(this,this.args),this._elapsed=e)},e.prototype.start=function(){t.prototype.start.call(this),this._elapsed=0},e}(n),i=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e){void 0===e&&(e=[]);var n=new this(t,e);return n},e.prototype.update=function(t){this.task.apply(this,this.args)},e}(n),a=function(t){function e(e,n,r){void 0===n&&(n=1),void 0===r&&(r=[]),t.call(this,e,r),this._frame=null,this._frame=n}return __extends(e,t),e.create=function(t,e,n){void 0===e&&(e=1),void 0===n&&(n=[]);var r=new this(t,e,n);return r},e.prototype.update=function(t){this._frame--,this._frame<=0&&(this.task.apply(this,this.args),this.finish())},e}(n)}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e;!function(t){t[t.NORMAL=0]="NORMAL",t[t.STOP=1]="STOP",t[t.PAUSE=2]="PAUSE"}(e||(e={}));var n=function(){function n(){this.scene=null,this.scheduler=null,this.renderer=null,this.domEventManager=t.DomEventManager.create(),this._gameLoop=null,this._eventSubscription=null,this._gameState=e.NORMAL,this._timeController=t.DirectorTimeController.create()}return n.getInstance=function(){return null===this._instance&&(this._instance=new this,this._instance.initWhenCreate()),this._instance},Object.defineProperty(n.prototype,"gameTime",{get:function(){return this._timeController.gameTime},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"fps",{get:function(){return this._timeController.fps},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isNormal",{get:function(){return this._gameState===e.NORMAL},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isStop",{get:function(){return this._gameState===e.STOP},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isPause",{get:function(){return this._gameState===e.PAUSE},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isTimeChange",{get:function(){return this._timeController.isTimeChange},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"elapsed",{get:function(){return this._timeController.elapsed},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"view",{get:function(){return t.DeviceManager.getInstance().view},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){this.scene=t.SceneDispatcher.create(),this.scheduler=t.Scheduler.create(),this.renderer=t.WebGLRenderer.create()},n.prototype.start=function(){this._gameState=e.NORMAL,this._startLoop()},n.prototype.stop=function(){this._gameLoop&&this._gameLoop.dispose(),this._gameState=e.STOP,this._timeController.stop(),this.scheduler.stop(),this._eventSubscription&&this._eventSubscription.dispose()},n.prototype.pause=function(){this._gameState!==e.PAUSE&&(this._gameState=e.PAUSE,this._timeController.pause(),this.scheduler.pause())},n.prototype.resume=function(){this._gameState=e.NORMAL,this._timeController.resume(),this.scheduler.resume()},n.prototype.getDeltaTime=function(){return this._timeController.deltaTime},n.prototype.initUIObjectScene=function(){var t=this.scene.uiObjectScene;this._initDomEvent(),t.onEnter(),t.init()},n.prototype.runUIObjectScene=function(e){var n=this.scene.uiObjectScene;t.EventManager.trigger(n,t.CustomEvent.create(t.EEngineEvent.STARTLOOP)),n.update(e),t.EventManager.trigger(n,t.CustomEvent.create(t.EEngineEvent.ENDLOOP))},n.prototype._startLoop=function(){var t=this;this._gameLoop=this._buildInitStream().ignoreElements().concat(this._buildLoopStream()).subscribe(function(e){t._loopBody(e)})},n.prototype._buildInitStream=function(){var t=this;return wdFrp.callFunc(function(){t._init()},this)},n.prototype._init=function(){this._initGameObjectScene(),this.initUIObjectScene(),t.DebugStatistics.init()},n.prototype._initGameObjectScene=function(){var e=this.scene.gameObjectScene;this._initDomEvent(),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.BEFORE_GAMEOBJECT_INIT)),e.onEnter(),e.init(),this.renderer.init(),this._timeController.start(),this.scheduler.start(),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.AFTER_GAMEOBJECT_INIT)),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.AFTER_GAMEOBJECT_INIT_RIGIDBODY_ADD_CONSTRAINT))},n.prototype._buildLoopStream=function(){return wdFrp.intervalRequest()},n.prototype._loopBody=function(t){var n=null;return this._gameState===e.PAUSE||this._gameState===e.STOP?!1:(n=this._timeController.computeElapseTime(t),this._run(n),!0)},n.prototype._run=function(t){this._runGameObjectScene(t),this.runUIObjectScene(t)},n.prototype._runGameObjectScene=function(e){var n=this.scene.gameObjectScene;this._timeController.tick(e),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.STARTLOOP)),this.scheduler.update(e),n.update(e),n.render(this.renderer),this.renderer.clear(),this.renderer.hasCommand()&&this.renderer.render(),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.ENDLOOP))},n.prototype._initDomEvent=function(){this._eventSubscription=this.domEventManager.initDomEvent()},n._instance=null,__decorate([t.execOnlyOnce("_isInitUIScene")],n.prototype,"initUIObjectScene",null),__decorate([t.execOnlyOnce("_isInitDomEvent")],n.prototype,"_initDomEvent",null),n}();t.Director=n}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return Object.defineProperty(e,"isTest",{get:function(){return this._isTest},set:function(t){this._isTest=t,wdFrp.Main.isTest=t},enumerable:!0,configurable:!0}),e.setConfig=function(e){var n=e.canvasId,r=e.isTest,o=void 0===r?t.DebugConfig.isTest:r,i=e.screenSize,a=void 0===i?t.EScreenSize.FULL:i;return this.isTest=o,this.screenSize=a,this._canvasId=n,this},e.init=function(){return t.DeviceManager.getInstance().createGL(this._canvasId),t.DeviceManager.getInstance().setScreen(),t.GPUDetector.getInstance().detect(),this},e._isTest=!1,e.screenSize=null,e._canvasId=null,e}();t.Main=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.designatedTriggerList=null,this._lastTriggerList=null,this._isDragEventTriggering=!1,this._triggerListOfDragEvent=null}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"scene",{get:function(){return t.Director.getInstance().scene},enumerable:!0,configurable:!0}),e.prototype.initDomEvent=function(){var e=this;return wdFrp.fromArray([t.EventManager.fromEvent(t.EEventName.CLICK),t.EventManager.fromEvent(t.EEventName.MOUSEDOWN),t.EventManager.fromEvent(t.EEventName.MOUSEUP),t.EventManager.fromEvent(t.EEventName.MOUSEWHEEL),this._buildMouseDragStream()]).mergeAll().filter(function(e){return!t.Director.getInstance().isPause}).map(function(t){var n=e._getMouseEventTriggerList(t);return e._isDragEventTriggering&&(e._triggerListOfDragEvent=n),e._getMouseEventTriggerListData(t,n)}).merge(this._buildMouseMoveStream()).subscribe(function(t){var n=t[0],r=t[1];n.forEach(function(t){e._trigger(r.copy(),t)})})},e.prototype._buildMouseDragStream=function(){var e=this;return t.EventManager.fromEvent(document,t.EEventName.MOUSEDOWN).flatMap(function(n){return t.EventManager.fromEvent(document,t.EEventName.MOUSEMOVE).takeUntil(t.EventManager.fromEvent(document,t.EEventName.MOUSEUP)["do"](function(t){e._isDragEventTriggering=!1}))}).map(function(n){return n.name=t.EEventName.MOUSEDRAG,e._isDragEventTriggering=!0,n})},e.prototype._buildMouseMoveStream=function(){var e=this;return t.EventManager.fromEvent(t.EEventName.MOUSEMOVE).filter(function(e){return!t.Director.getInstance().isPause}).map(function(t){var n=null;n=e.designatedTriggerList?e.designatedTriggerList:e._isDragEventTriggering?e._triggerListOfDragEvent:e._getMouseEventTriggerList(t);var r=e._getMouseOverAndMouseOutObject(n,e._lastTriggerList),o=r.mouseoverObjects,i=r.mouseoutObjects;return e._setMouseOverTag(o),e._setMouseOutTag(i),e._lastTriggerList=n.copy(),n=i.addChildren(n),e._getMouseEventTriggerListData(t,n)})},e.prototype._getMouseOverAndMouseOutObject=function(e,n){var r=wdCb.Collection.create(),o=wdCb.Collection.create();return n?(n.forEach(function(n){e.hasChildWithFunc(function(e){return t.JudgeUtils.isEqual(e,n)})||o.addChild(n)}),e.forEach(function(e){n.hasChildWithFunc(function(n){return t.JudgeUtils.isEqual(e,n)})||r.addChild(e)})):r=e,{mouseoverObjects:r,mouseoutObjects:o}},e.prototype._setMouseOverTag=function(t){t.forEach(function(t){t.addTag(n.MOUSE_OVER)})},e.prototype._setMouseOutTag=function(t){t.forEach(function(t){t.addTag(n.MOUSE_OUT)})},e.prototype._setEventNameByEventTag=function(e,r){return e.hasTag(n.MOUSE_OVER)?r.name=t.EEventName.MOUSEOVER:e.hasTag(n.MOUSE_OUT)&&(r.name=t.EEventName.MOUSEOUT),r},e.prototype._removeEventTag=function(t){t.removeTag(n.MOUSE_OVER),t.removeTag(n.MOUSE_OUT)},e.prototype._trigger=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0],o=e[1],i=!1,a=null,s=null,c=null;3===e.length&&e[2]?(i=!0,a=r):(a=this._setEventNameByEventTag(o,r),this._removeEventTag(o)),c=t.EventTriggerTable.getScriptHandlerName(a.name),s=t.CustomEvent.create(t.EEngineEvent[t.EventTriggerTable.getScriptEngineEvent(a.name)]),s.getDataFromDomEvent(a),t.EventManager.trigger(o,s,a,i),a.getDataFromCustomEvent(s),o.execEventScript(c,a),!a.isStopPropagation&&o.bubbleParent&&this._trigger(a.copy(),o.bubbleParent,!0)},e.prototype._getMouseEventTriggerList=function(t){var e=null,n=null,r=null;return this.designatedTriggerList?this.designatedTriggerList:(r=wdCb.Collection.create(),e=this._findTopGameObject(t,this.scene.gameObjectScene),n=this._findTopUIObject(t,this.scene.uiObjectScene),e&&r.addChild(e),n&&r.addChild(n),this._isSceneAsTopOne(t,r)&&r.addChild(this.scene),r)},e.prototype._isSceneAsTopOne=function(t,e){return this._isTriggerScene(t)&&0===e.getCount()},e.prototype._findTopGameObject=function(t,e){var n=this;return this._findTriggerGameObjectList(t,e).sort(function(t,e){return n._getDistanceToCamera(t)-n._getDistanceToCamera(e)}).getChild(0)},e.prototype._getDistanceToCamera=function(e){return e.transform.position.copy().sub(t.Director.getInstance().scene.currentCamera.transform.position).length()},e.prototype._findTopUIObject=function(t,e){return this._findTriggerUIObjectList(t,e).sort(function(t,e){return e.transform.zIndex-t.transform.zIndex}).getChild(0)},e.prototype._findTriggerGameObjectList=function(e,n){var r=wdCb.Collection.create(),o=this,i=function(n){n.hasComponent(t.SpacePartition)?n.getSpacePartition().getIntersectListWithRay(e).forEach(function(t){o._addTriggerObjectByQueryDetector(t,e,r)}):(o._addTriggerObjectByQueryDetector(n,e,r),n.forEach(function(t){i(t)}))};return n.forEach(function(t){i(t)}),r},e.prototype._findTriggerUIObjectList=function(t,e){var n=wdCb.Collection.create(),r=this,o=function(e){r._addTriggerObjectByQueryDetector(e,t,n),e.forEach(function(t){o(t)})};return e.forEach(function(t){o(t)}),n},e.prototype._addTriggerObjectByQueryDetector=function(e,n,r){if(e.hasComponent(t.EventTriggerDetector)){var o=e.getComponent(t.EventTriggerDetector);o.isTrigger(n)&&r.addChild(e)}},e.prototype._isTriggerScene=function(e){var n=this.scene.getComponent(t.EventTriggerDetector);return n.isTrigger(e)},e.prototype._getMouseEventTriggerListData=function(t,e){return[e,t]},e}();t.DomEventManager=e;var n;!function(t){t[t.MOUSE_OVER="MOUSE_OVER"]="MOUSE_OVER",t[t.MOUSE_OUT="MOUSE_OUT"]="MOUSE_OUT"}(n||(n={}))}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);
return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._scriptList=wdCb.Hash.create(),this._bubbleParent=null,this._transform=null,this.name=null,this.parent=null,this.isVisible=!0,this.actionManager=t.ActionManager.create(),this.children=wdCb.Collection.create(),this.startLoopHandler=null,this.endLoopHandler=null,this.components=wdCb.Collection.create(),this._scriptExecuteHistory=wdCb.Hash.create(),this._hasComponentCache=wdCb.Hash.create(),this._getComponentCache=wdCb.Hash.create(),this._rendererComponent=null,this._animation=null,this._collider=null,this._componentChangeSubscription=null}return __extends(n,e),Object.defineProperty(n.prototype,"scriptList",{get:function(){return this._scriptList},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bubbleParent",{get:function(){return this._bubbleParent?this._bubbleParent:this.parent},set:function(t){this._bubbleParent=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"transform",{get:function(){return this._transform},set:function(t){t&&(this._transform&&this.removeComponent(this._transform),this.addComponent(t),this._transform=t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"componentDirty",{set:function(t){t===!0&&this.clearCache()},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){this.transform=this.createTransform()},n.prototype.init=function(){var e=this,n=this;return this.startLoopHandler=wdCb.FunctionUtils.bind(this,function(){e.onStartLoop()}),this.endLoopHandler=wdCb.FunctionUtils.bind(this,function(){e.onEndLoop()}),this.bindStartLoopEvent(),this.bindEndLoopEvent(),this._componentChangeSubscription=t.EventManager.fromEvent(this,t.EEngineEvent.COMPONENT_CHANGE).subscribe(function(){n._onComponentChange()}),this.initComponent(),this.forEach(function(t){t.init()}),this.afterInitChildren(),this},n.prototype.onStartLoop=function(){this.execScript("onStartLoop")},n.prototype.onEndLoop=function(){this.execScript("onEndLoop")},n.prototype.onEnter=function(){},n.prototype.onExit=function(){this.execScript("onExit")},n.prototype.onDispose=function(){this.execScript("onDispose")},n.prototype.dispose=function(){var e=null;this.onDispose(),this.parent&&(this.parent.removeChild(this),this.parent=null),t.EventManager.off(this),t.EventManager.off(t.EEngineEvent.STARTLOOP,this.startLoopHandler),t.EventManager.off(t.EEngineEvent.ENDLOOP,this.endLoopHandler),this._componentChangeSubscription&&this._componentChangeSubscription.dispose(),e=this.removeAllComponent(),e.forEach(function(t){t.dispose()}),this.forEach(function(t){t.dispose()})},n.prototype.hasChild=function(t){return this.children.hasChild(t)},n.prototype.addChild=function(t){return t.parent&&t.parent.removeChild(t),t.parent=this,t.transform.parent=this.transform,this.children.addChild(t),t.onEnter(),this},n.prototype.addChildren=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.children.addChildren(t[0]),this},n.prototype.forEach=function(t){return this.children.forEach(t),this},n.prototype.filter=function(t){return this.children.filter(t)},n.prototype.sort=function(t,e){return void 0===e&&(e=!1),this.children.sort(t,e)},n.prototype.getChildren=function(){return this.children},n.prototype.getChild=function(t){return this.children.getChild(t)},n.prototype.findChildByUid=function(t){return this.children.findOne(function(e){return e.uid===t})},n.prototype.findChildByTag=function(t){return this.children.findOne(function(e){return e.hasTag(t)})},n.prototype.findChildByName=function(t){return this.children.findOne(function(e){return e.name.search(t)>-1})},n.prototype.findChildrenByName=function(t){return this.children.filter(function(e){return e.name.search(t)>-1})},n.prototype.getComponent=function(t){return this.components.findOne(function(e){return e instanceof t})},n.prototype.findComponentByUid=function(t){return this.components.findOne(function(e){return e.uid===t})},n.prototype.getFirstComponent=function(){return this.components.getChild(0)},n.prototype.forEachComponent=function(t){return this.components.forEach(t),this},n.prototype.removeChild=function(t){return t.onExit(),this.children.removeChild(t),t.parent=null,this},n.prototype.hasComponent=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this._getHasComponentCacheKey(e[0]),o=this._hasComponentCache.getChild(r);if(void 0!==o)return o;if(t.JudgeUtils.isComponenet(e[0])){var i=e[0];o=this.components.hasChild(i)}else{var a=e[0];o=this.components.hasChildWithFunc(function(t){return t instanceof a})}return this._hasComponentCache.addChild(r,o),o},n.prototype.addComponent=function(e){return this.hasComponent(e)?(t.Log.assert(!1,"the component already exist"),this):(e instanceof t.RendererComponent?this._rendererComponent=e:e instanceof t.Animation?this._animation=e:e instanceof t.Collider&&(this._collider=e),this.components.addChild(e),e.addToObject(this),this.componentDirty=!0,this)},n.prototype.removeComponent=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return r=e[0]instanceof t.Component?e[0]:this.getComponent(e[0]),this.components.removeChild(r),this._removeComponentHandler(r),this.componentDirty=!0,this},n.prototype.removeAllComponent=function(){var t=this,e=wdCb.Collection.create();return this.components.forEach(function(n){t._removeComponentHandler(n),e.addChild(n)},this),this.components.removeAllChildren(),this.componentDirty=!0,e},n.prototype.render=function(e,n){var r=null,o=null;this.isVisible&&(r=this._getGeometry(),o=this._getRendererComponent(),o&&r&&(o.render(e,r,n),t.DebugStatistics.count.renderGameObjects++),this.getRenderList().forEach(function(t){t.render(e,n)}))},n.prototype.update=function(t){var e=this._getAnimation(),n=this._getCollider();e&&e.update(t),this.actionManager.update(t),this.execScript("update",t),n&&n.update(t),this.beforeUpdateChildren(t),this.forEach(function(e){e.update(t)})},n.prototype.execScript=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=t[0],r=this;if(1===t.length)this._scriptList.forEach(function(t,e){t[n]&&t[n](),r._addToScriptExecuteHistory(e,n)});else if(2===t.length){var o=t[1];this._scriptList.forEach(function(t,e){t[n]&&t[n](o),r._addToScriptExecuteHistory(e,n)})}else if(3===t.length){var i=t[1],a=t[2];this._scriptList.forEach(function(t,e){a&&r._isScriptExecuted(e,n)||(t[n]&&t[n](i),r._addToScriptExecuteHistory(e,n))})}},n.prototype.execEventScript=function(t,e){this._scriptList.forEach(function(n){n[t]&&(e?n[t](e):n[t]())})},n.prototype.getComponentCount=function(t){return this.components.filter(function(e){return e instanceof t}).getCount()},n.prototype.beforeUpdateChildren=function(t){},n.prototype.afterInitChildren=function(){},n.prototype.bindStartLoopEvent=function(){t.EventManager.on(t.EEngineEvent.STARTLOOP,this.startLoopHandler)},n.prototype.bindEndLoopEvent=function(){t.EventManager.on(t.EEngineEvent.ENDLOOP,this.endLoopHandler)},n.prototype.getRenderList=function(){return this.isVisible?this.children:null},n.prototype.initComponent=function(){this.hasComponent(t.Geometry)&&this.getComponent(t.Geometry).init(),this.components.filter(function(e){return!(e instanceof t.Geometry)}).forEach(function(t){t.init()})},n.prototype.getAllChildren=function(){var t=wdCb.Collection.create(),e=function(n){t.addChildren(n.getChildren()),n.forEach(function(t){e(t)})};return e(this),t},n.prototype.clearCache=function(){this._hasComponentCache.removeAllChildren(),this._getComponentCache.removeAllChildren()},n.prototype._getGeometry=function(){return this.getComponent(t.Geometry)},n.prototype._getAnimation=function(){return this._animation},n.prototype._getRendererComponent=function(){return this._rendererComponent},n.prototype._getCollider=function(){return this._collider},n.prototype._removeComponentHandler=function(t){t.removeFromObject(this)},n.prototype._addToScriptExecuteHistory=function(t,e){this._scriptExecuteHistory.addChild(this._buildScriptHistoryKey(t,e),!0)},n.prototype._isScriptExecuted=function(t,e){return this._scriptExecuteHistory.getChild(this._buildScriptHistoryKey(t,e))},n.prototype._buildScriptHistoryKey=function(t,e){return t+"_"+e},n.prototype._getHasComponentCacheKey=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.JudgeUtils.isComponenet(e[0])){var r=e[0];return String(r.uid)}var o=e[0];return o.name},n.prototype._onComponentChange=function(){this.clearCache()},__decorate([t.virtual],n.prototype,"initWhenCreate",null),__decorate([t.cache(function(t){return this._getComponentCache.hasChild(t.name)},function(t){return this._getComponentCache.getChild(t.name)},function(t,e){this._getComponentCache.addChild(e.name,t)})],n.prototype,"getComponent",null),__decorate([t.virtual],n.prototype,"beforeUpdateChildren",null),__decorate([t.virtual],n.prototype,"afterInitChildren",null),__decorate([t.virtual],n.prototype,"bindStartLoopEvent",null),__decorate([t.virtual],n.prototype,"bindEndLoopEvent",null),__decorate([t.virtual],n.prototype,"getRenderList",null),__decorate([t.require(function(){t.assert(this.getComponentCount(t.Geometry)<=1,t.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 geometry component"))})],n.prototype,"_getGeometry",null),__decorate([t.require(function(){t.assert(this.getComponentCount(t.Animation)<=1,t.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 animation component"))})],n.prototype,"_getAnimation",null),__decorate([t.require(function(){t.assert(this.getComponentCount(t.RendererComponent)<=1,t.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 rendererComponent"))})],n.prototype,"_getRendererComponent",null),__decorate([t.require(function(){t.assert(this.getComponentCount(t.Collider)<=1,t.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 collider component"))})],n.prototype,"_getCollider",null),__decorate([t.ensure(function(e){t.assert(t.JudgeUtils.isString(e),t.Log.info.FUNC_SHOULD("key:"+e,"be string"))})],n.prototype,"_getHasComponentCacheKey",null),n}(t.Entity);t.EntityObject=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.name="uiObject"+String(this.uid),this.uiManager=t.UIManager.create(this)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.beforeUpdateChildren=function(t){this.uiManager.update(t)},n.prototype.createTransform=function(){return t.RectTransform.create()},n.prototype.addComponent=function(t){return e.prototype.addComponent.call(this,t),this},n.prototype.addChild=function(t){return e.prototype.addChild.call(this,t),this},__decorate([t.require(function(e){e instanceof t.UI&&t.assert(!this.getComponent(t.UI),t.Log.info.FUNC_SHOULD("only has one UI component"))})],n.prototype,"addComponent",null),__decorate([t.require(function(e){t.assert(this.getComponent(t.UIRenderer)===e.getComponent(t.UIRenderer),t.Log.info.FUNC_MUST_BE("the UIRenderer of UIObject and its children","the same one"))})],n.prototype,"addChild",null),n}(t.EntityObject);t.UIObject=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.name="gameObject"+String(this.uid)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.getSpacePartition=function(){return this.getComponent(t.SpacePartition)},n.prototype.getComponent=function(n){if(this._isGeometry(n)){var r=this.getComponent(t.LODController);if(r&&r.activeGeometry)return r.activeGeometry}return e.prototype.getComponent.call(this,n)},n.prototype.update=function(n){var r=this.getComponent(t.LODController);r&&r.update(n),e.prototype.update.call(this,n)},n.prototype.createTransform=function(){return t.ThreeDTransform.create()},n.prototype.getRenderList=function(){return this.hasComponent(t.Octree)?this.getSpacePartition().getRenderListByFrustumCull():this.children},n.prototype.afterInitChildren=function(){return this.hasComponent(t.Octree)?this.getSpacePartition().build():void 0},n.prototype._isGeometry=function(t){return"Geometry"===t.name},n}(t.EntityObject);t.GameObject=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.name="scene"+String(this.uid),this.uiObjectScene=t.UIObjectScene.create(),this.gameObjectScene=t.GameObjectScene.create()}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"scriptList",{get:function(){return this.gameObjectScene.scriptList},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"actionManager",{get:function(){return this.gameObjectScene.actionManager},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"ambientLight",{get:function(){return this.gameObjectScene.ambientLight},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"directionLights",{get:function(){return this.gameObjectScene.directionLights},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pointLights",{get:function(){return this.gameObjectScene.pointLights},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"side",{get:function(){return this.gameObjectScene.side},set:function(t){this.gameObjectScene.side=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"shadowMap",{get:function(){return this.gameObjectScene.shadowMap},set:function(t){this.gameObjectScene.shadowMap=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"shader",{get:function(){return this.gameObjectScene.shader},set:function(t){this.gameObjectScene.shader=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currentCamera",{get:function(){return this.gameObjectScene.currentCamera},set:function(t){this.gameObjectScene.currentCamera=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isUseProgram",{get:function(){return this.gameObjectScene.isUseProgram},set:function(t){this.gameObjectScene.isUseProgram=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"physics",{get:function(){return this.gameObjectScene.physics},set:function(t){this.gameObjectScene.physics=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"physicsEngineAdapter",{get:function(){return this.gameObjectScene.physicsEngineAdapter},set:function(t){this.gameObjectScene.physicsEngineAdapter=t},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){e.prototype.initWhenCreate.call(this),this.addComponent(t.SceneEventTriggerDetector.create())},n.prototype.useProgram=function(t){this.gameObjectScene.useProgram(t)},n.prototype.unUseProgram=function(){this.gameObjectScene.unUseProgram()},n.prototype.addChild=function(e){return e instanceof t.GameObject?this.gameObjectScene.addChild(e):e instanceof t.UIObject&&this.uiObjectScene.addChild(e),e.parent=this,this},n.prototype.addRenderTargetRenderer=function(t){return this.gameObjectScene.addRenderTargetRenderer(t)},n.prototype.removeRenderTargetRenderer=function(t){this.gameObjectScene.removeRenderTargetRenderer(t)},n.prototype.dispose=function(){this.gameObjectScene.dispose(),this.uiObjectScene.dispose()},n.prototype.hasChild=function(e){return e instanceof t.GameObject?this.gameObjectScene.hasChild(e):e instanceof t.UIObject?this.uiObjectScene.hasChild(e):void 0},n.prototype.addChildren=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(e[0]instanceof t.EntityObject){var r=e[0];this.addChild(r)}if(e[0]instanceof wdCb.Collection){var o=e[0],i=this;o.forEach(function(t){i.addChild(t)})}else if(t.JudgeUtils.isArrayExactly(e[0]))for(var o=e[0],a=0,s=o;a<s.length;a++){var r=s[a];this.addChild(r)}return this},n.prototype.getChildren=function(){return this.gameObjectScene.getChildren().addChildren(this.uiObjectScene.getChildren())},n.prototype.findChildByUid=function(t){var e=this.gameObjectScene.findChildByUid(t);return e||(e=this.uiObjectScene.findChildByUid(t)),e},n.prototype.findChildByTag=function(t){var e=this.gameObjectScene.findChildByTag(t);return e||(e=this.uiObjectScene.findChildByTag(t)),e},n.prototype.findChildByName=function(t){var e=this.gameObjectScene.findChildByName(t);return e||(e=this.uiObjectScene.findChildByName(t)),e},n.prototype.findChildrenByName=function(t){return this.gameObjectScene.findChildrenByName(t).addChildren(this.uiObjectScene.findChildrenByName(t))},n.prototype.removeChild=function(e){return e instanceof t.GameObject?this.gameObjectScene.removeChild(e):e instanceof t.UIObject?this.uiObjectScene.removeChild(e):void 0},n.prototype.onStartLoop=function(){this.gameObjectScene.onStartLoop(),this.uiObjectScene.onStartLoop()},n.prototype.onEndLoop=function(){this.gameObjectScene.onEndLoop(),this.uiObjectScene.onEndLoop()},n.prototype.onEnter=function(){this.gameObjectScene.onEnter(),this.uiObjectScene.onEnter()},n.prototype.onExit=function(){this.gameObjectScene.onExit(),this.uiObjectScene.onExit()},n.prototype.onDispose=function(){this.gameObjectScene.onDispose(),this.uiObjectScene.onDispose()},n.prototype.execScript=function(t,e){this.gameObjectScene.execScript.apply(this.gameObjectScene,arguments)},n.prototype.execEventScript=function(t,e){this.gameObjectScene.execEventScript.apply(this.gameObjectScene,arguments)},n.prototype.createTransform=function(){return null},n}(t.EntityObject);t.SceneDispatcher=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.EntityObject);t.Scene=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._currentCamera=null,this.side=null,this.shadowMap=o.create(this),this.shader=null,this.isUseProgram=!1,this.physics=n.create(),this.physicsEngineAdapter=null,this._lightManager=t.LightManager.create(),this._renderTargetRenderers=wdCb.Collection.create(),this._collisionDetector=t.CollisionDetector.create(),this._cameraList=wdCb.Collection.create()}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(r.prototype,"ambientLight",{get:function(){return this._lightManager.ambientLight},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"directionLights",{get:function(){return this._lightManager.directionLights},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pointLights",{get:function(){return this._lightManager.pointLights},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"currentCamera",{get:function(){return this._currentCamera||this._cameraList.getChild(0)},set:function(e){if(t.JudgeUtils.isNumber(e)){var n=e;this._currentCamera=this._cameraList.getChild(n)}else if(e instanceof t.GameObject){var r=e;this._currentCamera=r}},enumerable:!0,configurable:!0}),r.prototype.init=function(){return this.physics.enable&&(this.physicsEngineAdapter=t.PhysicsEngineFactory.create(this.physics.engine),this.physicsEngineAdapter.init()),e.prototype.init.call(this),this._renderTargetRenderers.forEach(function(t){return t.init()}),this},r.prototype.useProgram=function(t){this.isUseProgram=!0,this.shader=t},r.prototype.unUseProgram=function(){this.isUseProgram=!1},r.prototype.addChild=function(t){var n=this._getCameras(t),r=this._getLights(t);return n.getCount()>0&&this._cameraList.addChildren(n),r.getCount()>0&&this._lightManager.addChildren(r),e.prototype.addChild.call(this,t)},r.prototype.addRenderTargetRenderer=function(t){this._renderTargetRenderers.addChild(t)},r.prototype.removeRenderTargetRenderer=function(t){this._renderTargetRenderers.removeChild(t)},r.prototype.update=function(t){var n=this._getCurrentCameraComponent();this.physics.enable&&this.physicsEngineAdapter.update(t),n&&n.update(t),e.prototype.update.call(this,t),this._collisionDetector.detect(this)},r.prototype.render=function(t){var n=this;this._renderTargetRenderers.forEach(function(e){e.render(t,n.currentCamera)}),e.prototype.render.call(this,t,this.currentCamera)},r.prototype.createTransform=function(){return null},r.prototype._getCameras=function(t){return this._find(t,this._isCamera)},r.prototype._getLights=function(t){return this._find(t,this._isLight)},r.prototype._find=function(t,e){var n=this,r=wdCb.Collection.create(),o=function(t){e.call(n,t)&&r.addChild(t),t.forEach(function(t){o(t)})};return o(t),r},r.prototype._isCamera=function(e){return e.hasComponent(t.CameraController)},r.prototype._isLight=function(e){return e.hasComponent(t.Light)},r.prototype._getCurrentCameraComponent=function(){return this.currentCamera?this.currentCamera.getComponent(t.CameraController):null},__decorate([t.requireSetter(function(e){if(t.JudgeUtils.isNumber(e)){var n=e;t.assert(!!this._cameraList.getChild(n),t.Log.info.FUNC_NOT_EXIST("current camera in cameraList"))}})],r.prototype,"currentCamera",null),r}(t.Scene);t.GameObjectScene=e;var n=function(){function e(){this._gravity=t.Vector3.create(0,-9.8,0),this.enable=!1,this.engine=t.EPhysicsEngineType.CANNON,this.iterations=10}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"gravity",{get:function(){return this._gravity},set:function(t){this._gravity=t},enumerable:!0,configurable:!0}),__decorate([t.operateWorldDataGetterAndSetter("Gravity")],e.prototype,"gravity",null),e}();t.PhysicsConfig=n,function(t){t[t.NONE=0]="NONE",t[t.PCF=1]="PCF"}(t.EShadowMapSoftType||(t.EShadowMapSoftType={}));var r=t.EShadowMapSoftType,o=function(){function e(t){this._scene=null,this._enable=!0,this._softType=r.NONE,this._scene=t}return e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"enable",{get:function(){return this._enable},set:function(t){this._enable=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"softType",{get:function(){return this._softType},set:function(e){e!==this._softType&&(t.EventManager.broadcast(this._scene,t.CustomEvent.create(t.EEngineEvent.SHADOWMAP_SOFTTYPE_CHANGE)),this._softType=e)},enumerable:!0,configurable:!0}),e}();t.ShadowMapModel=o}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.onEndLoop=function(){e.prototype.onEndLoop.call(this),this._resetAllTransformState(),this._resetAllRendererClearCanvasFlag()},n.prototype.onStartLoop=function(){e.prototype.onStartLoop.call(this),this._sortSiblingChildren()},n.prototype.createTransform=function(){return null},n.prototype.beforeUpdateChildren=function(e){var n=this;this._resetAllRendererState(),this.forEach(function(e){var r=n._getUIRenderer(e);r.dirty?(r.isClearCanvas||(r.clearCanvas(),r.dirtyDuringCurrentLoop=!1),r.state=t.EUIRendererState.DIRTY,r.resetDirty()):r.state!==t.EUIRendererState.DIRTY&&(r.state=t.EUIRendererState.NOT_DIRTY)})},n.prototype.bindStartLoopEvent=function(){t.EventManager.on(this,t.EEngineEvent.STARTLOOP,this.startLoopHandler)},n.prototype.bindEndLoopEvent=function(){t.EventManager.on(this,t.EEngineEvent.ENDLOOP,this.endLoopHandler)},n.prototype._getUIRenderer=function(e){return e.getComponent(t.UIRenderer)},n.prototype._resetAllRendererClearCanvasFlag=function(){var t=this;this.forEach(function(e){var n=t._getUIRenderer(e);n.isClearCanvas=!1})},n.prototype._resetAllRendererState=function(){var e=this;this.forEach(function(n){var r=e._getUIRenderer(n);r.state=t.EUIRendererState.NORMAL})},n.prototype._resetAllTransformState=function(){var t=this,e=function(n){t._isNotDirtyDuringThisLoop(t._getUIRenderer(n))&&t._resetTransformFlag(n),n.forEach(function(t){e(t)})};this.forEach(function(t){e(t)})},n.prototype._isNotDirtyDuringThisLoop=function(t){return!t.dirtyDuringCurrentLoop},n.prototype._resetTransformFlag=function(t){var e=t.transform;e.isTranslate=!1,e.isScale=!1,e.isRotate=!1},n.prototype._sortSiblingChildren=function(){var t=function(e){e.sort(function(t,e){return t.transform.zIndex-e.transform.zIndex},!0),e.forEach(function(e){t(e)})};t(this)},__decorate([t.require(function(e){this.forEach(function(e){t.assert(e instanceof t.UIObject,t.Log.info.FUNC_MUST_BE("child","UIObject")),t.assert(e.hasComponent(t.UI),t.Log.info.FUNC_SHOULD("UIObject","contain ui component"))})})],n.prototype,"beforeUpdateChildren",null),__decorate([t.require(function(e){t.assert(e.getComponentCount(t.UIRenderer)<=1,t.Log.info.FUNC_SHOULD_NOT("uiObject","contain more than 1 uiRenderer component"))})],n.prototype,"_getUIRenderer",null),__decorate([t.ensure(function(){var e=this;this.getAllChildren().forEach(function(n){var r=e._getUIRenderer(n);t.assert(!r.isClearCanvas,t.Log.info.FUNC_SHOULD("reset all UIRenderers->isClearCanvas"))})})],n.prototype,"_resetAllRendererClearCanvasFlag",null),__decorate([t.ensure(function(){var e=this;this.getAllChildren().forEach(function(n){var r=e._getUIRenderer(n);t.assert(r.state===t.EUIRendererState.NORMAL,t.Log.info.FUNC_SHOULD("reset all UIRenderers->state"))})})],n.prototype,"_resetAllRendererState",null),n}(t.Scene);t.UIObjectScene=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this._lastCollideObjects=null,this._collisionTable=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},e.prototype.detect=function(e){var r=e.filter(function(e){return e.hasComponent(t.Collider)||t.JudgeUtils.isSpacePartitionObject(e)}),o=this;this._clearCollisionTable(),r.forEach(function(e){if(!e.hasComponent(t.RigidBody)){var i=o._getCollideObjects(e,r),a=i.targetCollideObjects,s=i.sourceCollideObjects;s.forEach(function(t){a.getCount()>0?(o._isCollisionStart(t)?(t.execScript("onCollisionStart",a),t.execScript("onContact",a),o._triggerCollisionEventOfCollideObjectWhichHasRigidBody(a,t,["onCollisionStart","onContact"])):(t.execScript("onContact",a),o._triggerCollisionEventOfCollideObjectWhichHasRigidBody(a,t,["onContact"])),t.addTag(n.COLLIDED),o._lastCollideObjects=a):(o._isCollisionEnd(t)&&(t.execScript("onCollisionEnd"),o._triggerCollisionEventOfCollideObjectWhichHasRigidBody(o._lastCollideObjects,t,["onCollisionEnd"])),t.removeTag(n.COLLIDED))})}})},e.prototype._getCollideObjects=function(e,n){var r=wdCb.Collection.create(),o=wdCb.Collection.create(),i=this,a=null;return t.JudgeUtils.isSpacePartitionObject(e)?(n.forEach(function(n){t.JudgeUtils.isSelf(e,n)||(t.JudgeUtils.isSpacePartitionObject(n)?i._getCollideObjectsWithSpacePartition(n.getSpacePartition(),e.getSpacePartition(),r,o):i._getCollideObjectsWithSpacePartition(n,e.getSpacePartition(),r,o))}),this._recordCollisionTargets(r,o),{targetCollideObjects:r.removeRepeatItems(),sourceCollideObjects:o.removeRepeatItems()}):(a=e.getComponent(t.Collider),n.forEach(function(n){t.JudgeUtils.isSelf(e,n)||(t.JudgeUtils.isSpacePartitionObject(n)?i._getCollideObjectsWithSpacePartition(n.getSpacePartition(),a,e,r,o):i._getCollideObjectsByGameObjectToGameObject(e,a,n,r))}),o.addChild(e),r.getCount()>0&&this._recordCollisionTargets(r,o),{targetCollideObjects:r.removeRepeatItems(),sourceCollideObjects:o.removeRepeatItems()})},e.prototype._getCollideObjectsByGameObjectToGameObject=function(t,e,r,o){this._isTargetCollidedWithSourceInCurrentFrame(t,r)?o.addChild(r):this._isNotTransform(t)&&this._isNotTransform(r)&&!t.hasTag(n.COLLIDED)||!e.isCollide(r)||o.addChild(r)},e.prototype._clearCollisionTable=function(){this._collisionTable.removeAllChildren()},e.prototype._isTargetCollidedWithSourceInCurrentFrame=function(e,n){var r=this._collisionTable.getChild(String(n.uid));return r?r.hasChildWithFunc(function(n){return t.JudgeUtils.isEqual(n,e)}):!1},e.prototype._recordCollisionTargets=function(t,e){var n=this._collisionTable;e.forEach(function(e){t.forEach(function(t){n.appendChild(String(e.uid),t)})})},e.prototype._getCollideObjectsWithSpacePartition=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(4===e.length){if(e[0]instanceof t.GameObject&&e[1]instanceof t.SpacePartition){var r=e[0],o=e[1],i=e[2],a=e[3],s=r.getComponent(t.Collider),c=this;o.getCollideObjects(s.shape).forEach(function(t){c._getCollideObjectsByGameObjectToGameObject(r,s,t,a)}),a.getCount()>0&&i.addChild(r),a.removeAllChildren(),a.addChildren(o.getChildren())}else if(e[0]instanceof t.SpacePartition&&e[1]instanceof t.SpacePartition){var u=e[0],o=e[1],l=e[2],h=e[3],p=this;o.getChildren().forEach(function(e){var n=e.getComponent(t.Collider);p._getCollideObjectsWithSpacePartition(u,n,e,l,h)})}}else if(5===e.length){var f=e[0],d=e[1],_=e[2],y=e[3],g=e[4],m=this;if(!d)return;return f.getCollideObjects(d.shape).forEach(function(t){m._getCollideObjectsByGameObjectToGameObject(_,d,t,y)}),void g.addChild(_)}},e.prototype._isCollisionStart=function(t){return!t.hasTag(n.COLLIDED)},e.prototype._isCollisionEnd=function(t){return t.hasTag(n.COLLIDED)},e.prototype._triggerCollisionEventOfCollideObjectWhichHasRigidBody=function(e,n,r){e.filter(function(e){return e.hasComponent(t.RigidBody)}).forEach(function(t){for(var e=0,o=r;e<o.length;e++){var i=o[e];t.execScript(i,wdCb.Collection.create([n]))}})},e.prototype._isNotTransform=function(t){return!t.transform.isTransform},__decorate([t.require(function(e,n){n.forEach(function(e){t.assert(e instanceof t.GameObject,t.Log.info.FUNC_SHOULD("targetObject","be GameObject"))})})],e.prototype,"_getCollideObjects",null),__decorate([t.require(function(e,n,r,o){t.assert(e instanceof t.GameObject&&r instanceof t.GameObject,t.Log.info.FUNC_SHOULD("sourceObject and targetObject","be GameObject"));
})],e.prototype,"_getCollideObjectsByGameObjectToGameObject",null),e}();t.CollisionDetector=e;var n;!function(t){t[t.COLLIDED="COLLIDED"]="COLLIDED"}(n||(n={}))}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this.listenerMap=wdCb.Hash.create()}return t.prototype.hasChild=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=t[0],r=t[1],o=this.listenerMap.getChild(this.buildKey(n,r));return o&&o.getCount()>0},t.prototype.hasChildWithFunc=function(t){return this.listenerMap.hasChildWithFunc(t)},t.prototype.appendChild=function(t,e,n){this.listenerMap.appendChild(this.buildKey(t,e),n)},t.prototype.filter=function(t){return this.listenerMap.filter(t)},t.prototype.forEach=function(t){return this.listenerMap.forEach(t)},t.prototype.getEventNameFromKey=function(t){var e=this.getEventSeparator();return t.indexOf(e)>-1?t.split(e)[1]:t},t.prototype.isEventName=function(t,e){return t.indexOf(""+this.getEventSeparator()+e)>-1||t===e},t}();t.EventListenerMap=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.getChild=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this;if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];return this.listenerMap.getChild(o)}if(1===e.length&&e[0]instanceof t.EntityObject){var i=e[0];return this.listenerMap.filter(function(t,e){return r.isTarget(e,i,t)})}if(2===e.length){var a=e[0],o=e[1];return this.listenerMap.getChild(this.buildKey(a,o))}},n.prototype.removeChild=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this;if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];this.listenerMap.removeChild(function(t,e){return r.isEventName(e,o)})}else if(1===e.length&&e[0]instanceof t.EntityObject){var i=e[0];this.listenerMap.removeChild(function(t,e){return r.isTarget(e,i,t)})}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var a=e[0],s=e[1],c=null;this.listenerMap.hasChild(a)&&(c=this.listenerMap.getChild(a),wdCb.Collection.create().addChild(c.removeChild(function(t){return t.originHandler===s})),0===c.getCount()&&this.listenerMap.removeChild(a))}else if(2===e.length&&t.JudgeUtils.isNumber(e[0])){var u=e[0],a=e[1];this.listenerMap.removeChild(this.buildKey(u,a))}else if(2===e.length&&e[0]instanceof t.EntityObject){var l=e[0],a=e[1];this.listenerMap.removeChild(this.buildKey(l,a))}else if(3===e.length&&e[0]instanceof t.EntityObject){var a=e[1],h=e[2];this.listenerMap.forEach(function(t,e){return t.removeChild(function(t){return t.originHandler===h}),0===t.getCount()?wdCb.$REMOVE:void 0})}},n.prototype.getUidFromKey=function(t){var e=""+n.eventSeparator;return t.indexOf(e)>-1?Number(t.split(e)[0]):null},n.prototype.isTarget=function(t,e,n){return t.indexOf(this._buildKeyPrefix(e.uid))>-1&&void 0!==n},n.prototype.getEventSeparator=function(){return""+n.eventSeparator},n.prototype.buildKey=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.JudgeUtils.isNumber(e[0])){var r=e[0],o=e[1];return this._buildKeyWithUid(r,o)}if(e[0]instanceof t.EntityObject){var i=e[0],o=e[1];return this._buildKeyWithUid(i.uid,o)}if(null===e[0]){var o=e[1];return o}},n.prototype._buildKeyWithUid=function(t,e){return""+this._buildKeyPrefix(t)+n.eventSeparator+e},n.prototype._buildKeyPrefix=function(t){return""+String(t)},n.eventSeparator="@",n}(t.EventListenerMap);t.CustomEventListenerMap=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.getChild=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(1===t.length){var n=t[0];return this.listenerMap.getChild(n)}if(2===t.length){var r=t[0],n=t[1];return this.listenerMap.getChild(this.buildKey(r,n))}},n.prototype.removeChild=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this,o=null;if(1===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0];o=this._getEventDataOffDataList(i,this.listenerMap.removeChild(function(t,e){return r.isEventName(e,i)}))}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var a=e[0],s=e[1],c=wdCb.Collection.create();this.listenerMap.forEach(function(t,e){if(r.isEventName(e,a)){var n=t.removeChild(function(t){return t.originHandler===s});if(n.getCount()>0&&c.addChild(n),0===t.getCount())return wdCb.$REMOVE}}),o=this._getEventDataOffDataList(a,c)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var u=e[0],l=e[1];o=this._getEventDataOffDataList(l,this.listenerMap.removeChild(this.buildKey(u,l)))}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var l=e[1],h=wdCb.Collection.create(),p=e[2];this.listenerMap.forEach(function(t,e){var n=t.removeChild(function(t){return t.originHandler===p});return n.getCount()>0&&h.addChild(n),0===t.getCount()?wdCb.$REMOVE:void 0}),o=this._getEventDataOffDataList(l,h)}return o},n.prototype.isDom=function(t,e,n){return t.indexOf(this._buildKeyPrefix(e))>-1&&void 0!==n},n.prototype.getEventSeparator=function(){return""+n.eventSeparator},n.prototype.buildKey=function(t,e){return""+this._buildKeyPrefix(t)+n.eventSeparator+e},n.prototype._buildKeyPrefix=function(t){return t.id?""+t.tagName+t.id:""+t.tagName},n.prototype._getEventDataOffDataList=function(t,e){return e.map(function(e){return e.map(function(e){return{dom:e.dom,eventName:t,domHandler:e.domHandler}})})},n.eventSeparator="@",n}(t.EventListenerMap);t.DomEventListenerMap=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.MOUSE=0]="MOUSE",t[t.KEYBOARD=1]="KEYBOARD",t[t.CUSTOM=2]="CUSTOM"}(t.EEventType||(t.EEventType={}));t.EEventType}(wd||(wd={}));var wd;!function(t){var e;!function(t){t[t.FALLBACK="fallback"]="FALLBACK",t[t.FIREFOX="firefox"]="FIREFOX",t[t.CHROME="chrome"]="CHROME"}(e||(e={})),function(t){t[t.CLICK="click"]="CLICK",t[t.MOUSEOVER="mouseover"]="MOUSEOVER",t[t.MOUSEUP="mouseup"]="MOUSEUP",t[t.MOUSEOUT="mouseout"]="MOUSEOUT",t[t.MOUSEMOVE="mousemove"]="MOUSEMOVE",t[t.MOUSEDOWN="mousedown"]="MOUSEDOWN",t[t.MOUSEWHEEL="mousewheel|DOMMouseScroll*"+e.FIREFOX]="MOUSEWHEEL",t[t.MOUSEDRAG="mousedrag"]="MOUSEDRAG",t[t.KEYDOWN="keydown"]="KEYDOWN",t[t.KEYUP="keyup"]="KEYUP",t[t.KEYPRESS="keypress"]="KEYPRESS"}(t.EEventName||(t.EEventName={}));var n=(t.EEventName,"|"),r="*",o=function(){function t(){}return t.handleEventName=function(t){for(var e=t,r=null,o=[],i=null,a=0,s=e.split(n);a<s.length;a++){var c=s[a];this._isFallbackEventName(c)?r=c:o.push(c)}return i=this._getSpecifyBrowserEventName(o),null!==i?i:r},t._isFallbackEventName=function(t){return 1===t.split(r).length},t._getSpecifyBrowserEventName=function(t){for(var n=null,o=0,i=t;o<i.length;o++){var a=i[o],s=a.split(r),c=s[0],u=s[1];switch(u){case e.CHROME:bowser.chrome&&(n=c);break;case e.FIREFOX:bowser.firefox&&(n=c)}if(n)break}return n},t}();t.EventNameHandler=o}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BROADCAST=0]="BROADCAST",t[t.EMIT=1]="EMIT"}(t.EEventPhase||(t.EEventPhase={}));t.EEventPhase}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create();e.addChild(t.EEventName.CLICK,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEOVER,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEOUT,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEMOVE,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEDOWN,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEUP,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEWHEEL,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEDRAG,t.EEventType.MOUSE),e.addChild(t.EEventName.KEYDOWN,t.EEventType.KEYBOARD),e.addChild(t.EEventName.KEYPRESS,t.EEventType.KEYBOARD),e.addChild(t.EEventName.KEYUP,t.EEventType.KEYBOARD);var n=function(){function n(){}return n.getEventType=function(n){var r=e.getChild(n);return void 0===r&&(r=t.EEventType.CUSTOM),r},n}();t.EventTable=n}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this.p_type=null,this.name=null,this.currentTarget=null,this.isStopPropagation=!1,this.phase=null,this.name=t}return Object.defineProperty(e.prototype,"type",{get:function(){return t.Log.error(null===this.p_type,t.Log.info.ABSTRACT_ATTRIBUTE),this.p_type},enumerable:!0,configurable:!0}),e.prototype.stopPropagation=function(){this.isStopPropagation=!0},e.prototype.copyMember=function(t,e,n){return n.forEach(function(n){t[n]=e[n]}),t},e}();t.Event=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(t,n){e.call(this,n),this._event=null,this.event=t}return __extends(n,e),Object.defineProperty(n.prototype,"event",{get:function(){return this._event},set:function(e){this._event=e||t.root.event},enumerable:!0,configurable:!0}),n.prototype.preventDefault=function(){var t=this._event;bowser.msie&&Number(bowser.version)<=8?t.returnValue=!1:t.preventDefault()},n.prototype.getDataFromCustomEvent=function(t){this.target=t.target,this.currentTarget=t.currentTarget,this.isStopPropagation=t.isStopPropagation},n}(t.Event);t.DomEvent=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._location=null,this._locationInView=null,this._button=null,this.lastX=null,this.lastY=null,this.p_type=t.EEventType.MOUSE}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},Object.defineProperty(n.prototype,"location",{get:function(){var e=null,n=this.event;return this._location?this._location:(e=t.Point.create(),bowser.msie?(e.x=n.clientX+document.body.scrollLeft||document.documentElement.scrollLeft,e.y=n.clientY+document.body.scrollTop||document.documentElement.scrollTop):(e.x=n.pageX,e.y=n.pageY),e)},set:function(t){this._location=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"locationInView",{get:function(){var e=null,n=null;return this._locationInView?this._locationInView:(e=this.location,n=t.DeviceManager.getInstance().view.offset,t.Point.create(e.x-n.x,e.y-n.y))},set:function(t){this._locationInView=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"button",{get:function(){var e=this.event,n=null;if(this._button)return this._button;if(bowser.msie)switch(e.button){case 1:n=t.EMouseButton.LEFT;break;case 4:n=t.EMouseButton.RIGHT;break;case 2:n=t.EMouseButton.CENTER;break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("multi mouse button"))}else switch(e.button){case 0:n=t.EMouseButton.LEFT;break;case 1:n=t.EMouseButton.RIGHT;break;case 2:n=t.EMouseButton.CENTER;break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("multi mouse button"))}return n},set:function(t){this._button=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"wheel",{get:function(){var t=this.event;return t.detail?-1*t.detail:t.wheelDelta?t.wheelDelta/120:0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"movementDelta",{get:function(){var t=this.event,e=null,n=null;if(this._isPointerLocked())e=t.movementX||t.webkitMovementX||t.mozMovementX||0,n=t.movementY||t.webkitMovementY||t.mozMovementY||0;else{var r=this.location,o=this.lastX,i=this.lastY;null===o&&null===i?(e=0,n=0):(e=r.x-o,n=r.y-i)}return{x:e,y:n}},enumerable:!0,configurable:!0}),n.prototype.copy=function(){var t=n.create(this.event,this.name);return this.copyMember(t,this,["target","currentTarget","isStopPropagation","phase","lastX","lastY"])},n.prototype._isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)},n}(t.DomEvent);t.MouseEvent=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},n={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},r=function(r){function o(){r.apply(this,arguments),this.p_type=t.EEventType.KEYBOARD,this.keyState=null}return __extends(o,r),o.create=function(t,e){var n=new this(t,e);return n},Object.defineProperty(o.prototype,"ctrlKey",{get:function(){return this.event.ctrlKey},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"altKey",{get:function(){return this.event.altKey},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"shiftKey",{get:function(){return this.event.shiftKey},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"metaKey",{get:function(){return this.event.metaKey},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"keyCode",{get:function(){return this.event.keyCode},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"key",{get:function(){var t=e[this.keyCode],r=null;return t?t:(r=String.fromCharCode(this.keyCode).toLowerCase(),this.shiftKey?n[r]:r)},enumerable:!0,configurable:!0}),o.prototype.copy=function(){var t=o.create(this.event,this.name);return this.copyMember(t,this,["target","currentTarget","isStopPropagation","phase","altKey","shiftKey","ctrlKey","metaKey","keyCode","key"])},o}(t.DomEvent);t.KeyboardEvent=r}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.userData=null,this.p_type=t.EEventType.CUSTOM}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.copyPublicAttri=function(e,n){return wdCb.ExtendUtils.extend(e,function(e,n){return"_"!==n.slice(0,1)&&!t.JudgeUtils.isFunction(e)}),e},n.prototype.copy=function(){var t=n.create(this.name);return this.copyMember(t,this,["target","currentTarget","isStopPropagation","phase"])},n.prototype.getDataFromDomEvent=function(t){this.target=t.target,this.currentTarget=t.currentTarget,this.isStopPropagation=t.isStopPropagation},n}(t.Event);t.CustomEvent=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.CENTER=2]="CENTER"}(t.EMouseButton||(t.EMouseButton={}));t.EMouseButton}(wd||(wd={}));var wd;!function(t){var e=function(){function t(t){this.eventType=null,this.priority=null,this.handlerDataList=wdCb.Collection.create(),this.eventType=t.eventType,this.priority=t.priority||1}return t.create=function(t){var e=new this(t);return e.initWhenCreate(t),e},t.prototype.initWhenCreate=function(t){this._setHandlerDataList(t)},t.prototype._setHandlerDataList=function(t){var e=null,n=/on\w+/;for(e in t)t.hasOwnProperty(e)&&n.test(e)&&this.handlerDataList.addChild({eventName:this._parseEventName(e),handler:t[e]})},t.prototype._parseEventName=function(t){return t.slice(2).toLowerCase()},t}();t.EventListener=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t}();t.EventHandler=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.off=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this,o=t.DomEventRegister.getInstance(),i=null;i=o.remove.apply(o,e),i&&i.forEach(function(t){t.forEach(function(t){r._unBind(t.dom,t.eventName,t.domHandler)})})},n.prototype.trigger=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,o=null,i=null,a=null;1===e.length?(o=e[0],r=this.getDefaultDom()):(r=e[0],o=e[1]),i=o.name,a=t.DomEventRegister.getInstance().getEventRegisterDataList(r,i),null!==a&&0!==a.getCount()&&a.forEach(function(t){var e=o.copy();t.handler(e,t.eventData)})},n.prototype.clearHandler=function(){},n.prototype.buildDomHandler=function(e,n){var r=this,o=t.root;return wdCb.EventUtils.bindEvent(o,function(t){r.triggerDomEvent(e,t,n)})},n.prototype.handler=function(e,n,r,o){var i=null,a=r;r=this.addEngineHandler(n,r),i=t.DomEventRegister.getInstance().isBinded(e,n)?t.DomEventRegister.getInstance().getDomHandler(e,n):this._bind(e,n),t.DomEventRegister.getInstance().register(e,n,this.createEventData(),r,a,i,o)},n.prototype._bind=function(e,n){var r=null;return r=this.buildDomHandler(e,n),wdCb.EventUtils.addEvent(e,t.EventNameHandler.handleEventName(n),r),r},n.prototype._unBind=function(e,n,r){wdCb.EventUtils.removeEvent(e,t.EventNameHandler.handleEventName(n),r)},__decorate([t.virtual],n.prototype,"clearHandler",null),n}(t.EventHandler);t.DomEventHandler=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.on=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null,r=null,o=null,i=null;3===t.length?(n=this.getDefaultDom(),r=t[0],o=t[1],i=t[2]):(n=t[0],r=t[1],o=t[2],i=t[3]),this.handler(n,r,o,i)},n.prototype.getDefaultDom=function(){return document.body},n.prototype.triggerDomEvent=function(e,n,r){var o=this._createEventObject(e,n,r);t.EventManager.trigger(e,o)},n.prototype.addEngineHandler=function(e,n){var r=null;switch(e){case t.EEventName.MOUSEMOVE:r=this._handleMove(n);break;default:r=n}return r},n.prototype.createEventData=function(){var t=wdCb.Hash.create();return t.addChild("lastX",null),t.addChild("lastY",null),t},n.prototype._handleMove=function(t){var e=this;return function(n,r){e._copyEventDataToEventObject(n,r),t(n),e._saveLocation(n,r)}},n.prototype._createEventObject=function(e,n,r){var o=t.MouseEvent.create(n?n:t.root.event,r);return o.target=e,o},n.prototype._copyEventDataToEventObject=function(t,e){t.lastX=e.getChild("lastX"),t.lastY=e.getChild("lastY")},n.prototype._saveLocation=function(t,e){var n=t.location;e.addChild("lastX",n.x),e.addChild("lastY",n.y)},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(4===e.length){var r=e[0];t.assert(t.JudgeUtils.isDom(r),t.Log.info.FUNC_MUST_BE("first param","HTMLElement"))}})],n.prototype,"on",null),n}(t.DomEventHandler);t.MouseEventHandler=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.on=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,o=null,i=null;3===e.length?(r=e[0],o=e[1],i=e[2]):(t.Log.warn("keyboard event can only bind on document.body"),r=e[1],o=e[2],i=e[3]),this.handler(this.getDefaultDom(),r,o,i)},n.prototype.triggerDomEvent=function(e,n,r){var o=this._createEventObject(e,n,r);t.EventManager.trigger(e,o)},n.prototype.getDefaultDom=function(){return document.body},n.prototype.addEngineHandler=function(e,n){var r=null;switch(e){case t.EEventName.KEYDOWN:r=this._handleKeyDown(n);break;case t.EEventName.KEYUP:r=this._handleKeyUp(n);break;default:r=n}return r},n.prototype.createEventData=function(){var t=wdCb.Hash.create();return t.addChild("keyState",{}),t},n.prototype._handleKeyDown=function(t){var e=this;return function(n,r){var o=r.getChild("keyState");e._setKeyStateAllFalse(o),o[n.key]=!0,e._copyEventDataToEventObject(n,r),t(n)}},n.prototype._handleKeyUp=function(t){var e=this;return function(n,r){e._setKeyStateAllFalse(r.getChild("keyState")),e._copyEventDataToEventObject(n,r),t(n)}},n.prototype._copyEventDataToEventObject=function(t,e){t.keyState=e.getChild("keyState")},n.prototype._setKeyStateAllFalse=function(t){for(var e in t)t.hasOwnProperty(e)&&(t[e]=!1)},n.prototype._createEventObject=function(e,n,r){var o=t.KeyboardEvent.create(n?n:t.root.event,r);return o.target=e,o},n._instance=null,n}(t.DomEventHandler);t.KeyboardEventHandler=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.on=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(3===e.length){var r=e[0],o=e[1],i=o,a=e[2];t.CustomEventRegister.getInstance().register(null,r,o,i,null,a)}else if(4===e.length){var s=e[0],r=e[1],o=e[2],i=o,a=e[3];t.CustomEventRegister.getInstance().register(s,r,o,i,null,a)}},n.prototype.off=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.CustomEventRegister.getInstance();r.remove.apply(r,e)},n.prototype.trigger=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null;if(1===t.length||2===t.length){var r=null;return 1===t.length?n=t[0]:(n=t[0],r=t[1]),this._triggerEventHandler(n,r)}if(3===t.length||4===t.length){var o=null,r=null,i=null;return 3===t.length?(o=t[0],n=t[1],i=t[2]):(o=t[0],n=t[1],r=t[2],i=t[3]),this._triggerTargetAndEventHandler(o,n,r,i)}},n.prototype._triggerEventHandler=function(e,n){var r=null,o=this;return r=t.CustomEventRegister.getInstance().getEventRegisterDataList(e.name),null===r||0===r.getCount()?!1:(r.forEach(function(t){e.currentTarget=t.target,e.target=t.target,o._setUserData(e,n),t.handler(e)}),!0)},n.prototype._triggerTargetAndEventHandler=function(e,n,r,o){var i=null,a=!1,s=this;return o||(n.target=e),i=t.CustomEventRegister.getInstance().getEventRegisterDataList(e,n.name),null===i||0===i.getCount()?!1:(i.forEach(function(t){n.currentTarget=t.target,s._setUserData(n,r),t.handler(n),n.isStopPropagation&&(a=!0)}),a)},n.prototype._setUserData=function(t,e){e&&(t.userData=e)},n._instance=null,n}(t.EventHandler);t.CustomEventHandler=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t}();t.EventDispatcher=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.trigger=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e.length;if(1===r){var o=e[0],i=o.type;return t.EventHandlerFactory.createEventHandler(i).trigger(o)}if(2===r&&t.EventUtils.isEvent(e[0])){var a=e[0],s=e[1],i=a.type;return t.EventHandlerFactory.createEventHandler(i).trigger(a,s)}if(2===r&&t.EventUtils.isEntityObject(e[0])||3===r&&t.JudgeUtils.isBoolean(e[2])){var c=e[0],u=e[1],l=void 0===e[2]?!1:e[2],i=u.type;return t.EventHandlerFactory.createEventHandler(i).trigger(c,u,l)}if(3===r||4===r){var c=e[0],h=e[1],s=e[2],l=void 0===e[3]?!1:e[3],i=h.type;return t.EventHandlerFactory.createEventHandler(i).trigger(c,h,s,l)}},n.prototype.emit=function(e,n,r){var o=!1;if(e){n.phase=t.EEventPhase.EMIT,n.target=e;do{if(o=this._triggerWithUserData(e,n,r,!0))break;e=e.bubbleParent}while(e)}},n.prototype.broadcast=function(e,n,r){var o=this,i=function(t){var e=t.getChildren();0!==e.getCount()&&e.forEach(function(t){o._triggerWithUserData(t,n,r,!0),i(t)})};e&&(n.phase=t.EEventPhase.BROADCAST,n.target=e,this._triggerWithUserData(e,n,r,!0),i(e))},n.prototype._triggerWithUserData=function(t,e,n,r){return n?this.trigger(t,e,n,r):this.trigger(t,e,r)},n._instance=null,n}(t.EventDispatcher);t.CustomEventDispatcher=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.trigger=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(1===e.length){var r=e[0],o=r.type;t.EventHandlerFactory.createEventHandler(o).trigger(r)}else if(2===e.length){var i=e[0],a=e[1],o=a.type;t.EventHandlerFactory.createEventHandler(o).trigger(i,a)}},n._instance=null,n}(t.EventDispatcher);t.DomEventDispatcher=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.listenerMap=t.ABSTRACT_ATTRIBUTE}return e.prototype.getEventRegisterDataList=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=this.listenerMap.getChild.apply(this.listenerMap,t);return n?n.sort(function(t,e){return e.priority-t.priority}):null},e.prototype.filter=function(t){return this.listenerMap.filter(t)},e.prototype.forEach=function(t){return this.listenerMap.forEach(t)},e.prototype.getChild=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.listenerMap.getChild.apply(this.listenerMap,Array.prototype.slice.call(arguments,0))},e.prototype.getEventNameFromKey=function(t){return this.listenerMap.getEventNameFromKey(t)},e}();t.EventRegister=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.listenerMap=t.CustomEventListenerMap.create()}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.register=function(t,e,n,r,o,i){this.listenerMap.appendChild(t,e,{target:t,eventName:e,handler:n,originHandler:r,domHandler:o,priority:i})},n.prototype.remove=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0];if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];this.listenerMap.removeChild(o)}else if(1===e.length&&e[0]instanceof t.EntityObject)this.listenerMap.removeChild(r),this._handleAfterAllEventHandlerRemoved(r);else if(2===e.length&&t.JudgeUtils.isFunction(e[1])){var o=e[0],i=e[1];this.listenerMap.removeChild(o,i)}else if(2===e.length&&t.JudgeUtils.isNumber(e[0])){var a=e[0],o=e[1];this.listenerMap.removeChild(a,o)}else(2===e.length&&e[0]instanceof t.EntityObject||3===e.length)&&(this.listenerMap.removeChild.apply(this.listenerMap,e),this._isAllEventHandlerRemoved(r)&&this._handleAfterAllEventHandlerRemoved(r))},n.prototype.setBubbleParent=function(t,e){t.bubbleParent=e},n.prototype.getUidFromKey=function(t){return this.listenerMap.getUidFromKey(t)},n.prototype.isTarget=function(t,e,n){return this.listenerMap.isTarget(t,e,n)},n.prototype._isAllEventHandlerRemoved=function(t){return!this.listenerMap.hasChildWithFunc(function(e,n){return n.indexOf(String(t.uid))>-1&&e&&e.getCount()>0})},n.prototype._handleAfterAllEventHandlerRemoved=function(t){this.setBubbleParent(t,null)},n._instance=null,n}(t.EventRegister);t.CustomEventRegister=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.listenerMap=t.DomEventListenerMap.create()}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.register=function(t,e,n,r,o,i,a){this.listenerMap.appendChild(t,e,{dom:t,eventName:e,eventData:n,handler:r,originHandler:o,domHandler:i,priority:a})},n.prototype.remove=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];r=this.listenerMap.removeChild(o)}else if(2===e.length&&t.JudgeUtils.isFunction(e[1])){var o=e[0],i=e[1];r=this.listenerMap.removeChild(o,i)}else(2===e.length&&t.JudgeUtils.isDom(e[0])||3===e.length)&&(r=this.listenerMap.removeChild.apply(this.listenerMap,e));return r},n.prototype.isBinded=function(t,e){return this.listenerMap.hasChild(t,e)},n.prototype.isDom=function(t,e,n){return this.listenerMap.isDom(t,e,n)},n.prototype.getDomHandler=function(t,e){var n=this.getChild(t,e);return n&&n.getCount()>0?n.getChild(0).domHandler:void 0},n._instance=null,n}(t.EventRegister);t.DomEventRegister=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t}();t.EventBinder=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.on=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(2===e.length){var r=e[0],o=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(r)).on(r,o);
}else if(3===e.length&&t.JudgeUtils.isString(e[0])){var r=e[0],o=e[1],i=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(r)).on(r,o,i)}else if(3===e.length&&e[0]instanceof t.EntityObject){var a=e[0],r=e[1],o=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(r)).on(a,r,o)}else if(4===e.length){var a=e[0],r=e[1],o=e[2],i=e[3];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(r)).on(a,r,o,i)}},n.prototype.off=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.CustomEventRegister.getInstance();if(0===e.length)r.forEach(function(e,n){var o=r.getEventNameFromKey(n),i=r.getUidFromKey(n);i?t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(i,o):t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(o)});else if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];r.forEach(function(e,n){var i=r.getEventNameFromKey(n);i===o&&t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(o)})}else if(1===e.length&&e[0]instanceof t.EntityObject){var i=e[0];r.forEach(function(e,n){var o=r.getEventNameFromKey(n);r.isTarget(n,i,e)&&t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(i,o)})}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var a=e[0],s=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(a,s)}else if(2===e.length&&e[0]instanceof t.EntityObject){var c=e[0],a=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(c,a)}else if(3===e.length&&e[0]instanceof t.EntityObject){var c=e[0],a=e[1],s=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(c,a,s)}},n.prototype._checkEventSeparator=function(e){t.assert(-1===e.indexOf(t.CustomEventListenerMap.eventSeparator),t.Log.info.FUNC_SHOULD_NOT("eventName","contain "+t.CustomEventListenerMap.eventSeparator))},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(1===e.length);else if(2===e.length){var r=e[0];this._checkEventSeparator(r)}else if(3===e.length&&t.JudgeUtils.isString(e[0])){var r=e[0];this._checkEventSeparator(r)}else if(3===e.length&&e[0]instanceof t.EntityObject){var r=e[1];this._checkEventSeparator(r)}else if(4===e.length){var r=e[1];this._checkEventSeparator(r)}})],n.prototype,"on",null),n}(t.EventBinder);t.CustomEventBinder=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.on=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(1===e.length){var r=e[0]instanceof t.EventListener?e[0]:t.EventListener.create(e[0]);r.handlerDataList.forEach(function(e){t.EventHandlerFactory.createEventHandler(r.eventType).on(e.eventName,e.handler,r.priority)})}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0],i=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).on(o,i)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var a=e[0],s=e[0]instanceof t.EventListener?e[0]:t.EventListener.create(e[0]);s.handlerDataList.forEach(function(e){t.EventHandlerFactory.createEventHandler(s.eventType).on(a,e.eventName,e.handler,s.priority)})}else if(3===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0],i=e[1],c=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).on(o,i,c)}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var u=e[0],o=e[1],i=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).on(u,o,i)}else if(4===e.length){var u=e[0],o=e[1],i=e[2],c=e[3];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).on(u,o,i,c)}},n.prototype.off=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.DomEventRegister.getInstance();if(0===e.length)r.forEach(function(e,n){var o=r.getEventNameFromKey(n);t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(o)});else if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];r.forEach(function(e,n){var i=r.getEventNameFromKey(n);i===o&&t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(o)})}else if(1===e.length&&t.JudgeUtils.isDom(e[0])){var i=e[0];r.forEach(function(e,n){var o=r.getEventNameFromKey(n);r.isDom(n,i,e)&&t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(i,o)})}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var a=e[0],s=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(a,s)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var c=e[0],a=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(c,a)}else if(3===e.length){var c=e[0],a=e[1],s=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(c,a,s)}},n.prototype._checkEventSeparator=function(e){t.assert(-1===e.indexOf(t.DomEventListenerMap.eventSeparator),t.Log.info.FUNC_SHOULD_NOT("eventName","contain "+t.DomEventListenerMap.eventSeparator))},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(1===e.length);else if(2===e.length);else if(3===e.length&&t.JudgeUtils.isString(e[0])){var r=e[0];this._checkEventSeparator(r)}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var r=e[1];this._checkEventSeparator(r)}else if(4===e.length){var r=e[1];this._checkEventSeparator(r)}})],n.prototype,"on",null),n}(t.EventBinder);t.DomEventBinder=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.createEventHandler=function(e){var n=null;switch(e){case t.EEventType.MOUSE:n=t.MouseEventHandler.getInstance();break;case t.EEventType.KEYBOARD:n=t.KeyboardEventHandler.getInstance();break;case t.EEventType.CUSTOM:n=t.CustomEventHandler.getInstance();break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("eventType"))}return n},e}();t.EventHandlerFactory=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.createEventBinder=function(e){var n=null,r=t.EventTable.getEventType(e);switch(r){case t.EEventType.MOUSE:case t.EEventType.KEYBOARD:n=t.DomEventBinder.getInstance();break;case t.EEventType.CUSTOM:n=t.CustomEventBinder.getInstance();break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("eventName:"+e))}return n},e}();t.EventBinderFactory=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.createEventDispatcher=function(e){var n=null,r=e.type;switch(r){case t.EEventType.MOUSE:case t.EEventType.KEYBOARD:n=t.DomEventDispatcher.getInstance();break;case t.EEventType.CUSTOM:n=t.CustomEventDispatcher.getInstance();break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("event:"+e))}return n},e}();t.EventDispatcherFactory=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.isEvent=function(t){return t&&void 0!==t.currentTarget},t.isEntityObject=function(t){return t&&void 0!==t.scriptList},t}();t.EventUtils=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){}return e.on=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(1===e.length){var r=e[0],o=t.DomEventBinder.getInstance();o.on(r)}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0],a=e[1],s=1,o=t.EventBinderFactory.createEventBinder(i);o.on(i,a,s)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var c=e[0],r=e[1],o=t.DomEventBinder.getInstance();o.on(c,r)}else if(3===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0],a=e[1],s=e[2],o=t.EventBinderFactory.createEventBinder(i);o.on(i,a,s)}else if(3===e.length&&e[0]instanceof t.EntityObject){var u=e[0],i=e[1],a=e[2],s=1,o=t.CustomEventBinder.getInstance();o.on(u,i,a,s)}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var c=e[0],i=e[1],a=e[2],s=1,o=t.DomEventBinder.getInstance();o.on(c,i,a,s)}else if(4===e.length&&e[0]instanceof t.EntityObject){var u=e[0],i=e[1],a=e[2],s=e[3],o=t.CustomEventBinder.getInstance();o.on(u,i,a,s)}else if(4===e.length&&t.JudgeUtils.isDom(e[0])){var c=e[0],i=e[1],a=e[2],s=e[3],o=t.DomEventBinder.getInstance();o.on(c,i,a,s)}},e.off=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(0===e.length){var r=t.CustomEventBinder.getInstance(),o=t.DomEventBinder.getInstance();r.off(),o.off()}else if(1===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0],a=t.EventBinderFactory.createEventBinder(i);a.off(i)}else if(1===e.length&&e[0]instanceof t.EntityObject){var i=e[0],a=t.CustomEventBinder.getInstance();a.off(i)}else if(1===e.length&&t.JudgeUtils.isDom(e[0])){var i=e[0],a=t.DomEventBinder.getInstance();a.off(i)}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0],s=e[1],a=t.EventBinderFactory.createEventBinder(i);a.off(i,s)}else if(2===e.length&&e[0]instanceof t.EntityObject){var c=e[0],i=e[1],a=t.CustomEventBinder.getInstance();a.off(c,i)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var u=e[0],i=e[1],a=t.DomEventBinder.getInstance();a.off(u,i)}else if(3===e.length&&e[0]instanceof t.EntityObject){var c=e[0],i=e[1],s=e[2],a=t.CustomEventBinder.getInstance();a.off(c,i,s)}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var u=e[0],i=e[1],s=e[2],a=t.DomEventBinder.getInstance();a.off(u,i,s)}},e.trigger=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e.length;if(1===r){var o=e[0],i=t.EventDispatcherFactory.createEventDispatcher(o);i.trigger(o)}else if(2===r&&t.EventUtils.isEvent(e[0])){var a=e[0],s=e[1],i=t.CustomEventDispatcher.getInstance();i.trigger(a,s)}else if(2===r&&t.EventUtils.isEntityObject(e[0])){var c=e[0],u=e[1],i=t.CustomEventDispatcher.getInstance();if(!c)return;i.trigger(c,u)}else if(2===r){var l=e[0],h=e[1],i=t.DomEventDispatcher.getInstance();if(!l)return;i.trigger(l,h)}else if(3===r){var c=e[0],p=e[1],s=e[2],i=t.CustomEventDispatcher.getInstance();if(!c)return;i.trigger(c,p,s)}else if(4===r){var c=e[0],f=e[1],s=e[2],d=e[3],i=t.CustomEventDispatcher.getInstance();if(!c)return;i.trigger(c,f,s,d)}},e.broadcast=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.CustomEventDispatcher.getInstance();r.broadcast.apply(r,e)},e.emit=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.CustomEventDispatcher.getInstance();r.emit.apply(r,e)},e.fromEvent=function(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];var o=null,i=null;if(1===n.length){var a=n[0];o=function(t){e.on(a,t)},i=function(t){e.off(a,t)}}else if(2===n.length&&t.JudgeUtils.isNumber(n[1])){var s=n[0],c=n[1];o=function(t){e.on(s,t,c)},i=function(t){e.off(s,t)}}else if(2===n.length){var u=n[1];o=function(t){e.on(n[0],u,t)},i=function(t){e.off(n[0],u,t)}}else if(3===n.length){var l=n[1],h=n[2];o=function(t){e.on(n[0],l,t,h)},i=function(t){e.off(n[0],l,t)}}return wdFrp.fromEventPattern(o,i)},e.setBubbleParent=function(e,n){t.CustomEventRegister.getInstance().setBubbleParent(e,n)},__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(e[0]instanceof t.EntityObject){var r=e[1];t.assert(t.EventTable.getEventType(r)===t.EEventType.CUSTOM,t.Log.info.FUNC_MUST_BE("event","custom event"))}else if(t.JudgeUtils.isDom(e[0])){var r=e[1],o=t.EventTable.getEventType(r);t.assert(o===t.EEventType.MOUSE||o===t.EEventType.KEYBOARD,t.Log.info.FUNC_MUST_BE("event","dom event"))}})],e,"on",null),__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(e.length>2&&e[0]instanceof t.EntityObject){var r=e[1];t.assert(t.EventTable.getEventType(r)===t.EEventType.CUSTOM,t.Log.info.FUNC_MUST_BE("event","custom event"))}else if(e.length>2&&t.JudgeUtils.isDom(e[0])){var r=e[1],o=t.EventTable.getEventType(r);t.assert(o===t.EEventType.MOUSE||o===t.EEventType.KEYBOARD,t.Log.info.FUNC_MUST_BE("event","dom event"))}})],e,"off",null),__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(2===e.length&&e[0]instanceof t.Event){var r=e[0];t.assert(r instanceof t.CustomEvent,t.Log.info.FUNC_MUST_BE("event type","CUSTOM"))}else if(2===e.length&&e[0]instanceof t.EntityObject);else if(2===e.length)e[0]&&t.assert(t.JudgeUtils.isDom(e[0]),t.Log.info.FUNC_MUST_BE("the first param","dom"));else if(e[0]instanceof t.EntityObject){var o=e[1];t.assert(o instanceof t.CustomEvent,t.Log.info.FUNC_MUST_BE("event type","CUSTOM"))}})],e,"trigger",null),__decorate([t.require(function(e,n,r){t.assert(n instanceof t.CustomEvent,t.Log.info.FUNC_MUST_BE("eventObject","CustomEvent"))})],e,"broadcast",null),__decorate([t.require(function(e,n,r){t.assert(n instanceof t.CustomEvent,t.Log.info.FUNC_MUST_BE("eventObject","CustomEvent"))})],e,"emit",null),__decorate([t.require(function(e,n){t.assert(e instanceof t.EntityObject,"only EntityObject can setBubleParent")})],e,"setBubbleParent",null),e}();t.EventManager=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.STARTLOOP="wd_startLoop"]="STARTLOOP",t[t.ENDLOOP="wd_endLoop"]="ENDLOOP",t[t.BEFORE_GAMEOBJECT_INIT="wd_beforeGameObjectInit"]="BEFORE_GAMEOBJECT_INIT",t[t.AFTER_GAMEOBJECT_INIT="wd_afterGameObjectInit"]="AFTER_GAMEOBJECT_INIT",t[t.AFTER_GAMEOBJECT_INIT_RIGIDBODY_ADD_CONSTRAINT="wd_afterGameObjectInit_rigidBowd_addConstraint"]="AFTER_GAMEOBJECT_INIT_RIGIDBODY_ADD_CONSTRAINT",t[t.MOUSE_CLICK="wd_mouseclick"]="MOUSE_CLICK",t[t.MOUSE_DOWN="wd_mousedown"]="MOUSE_DOWN",t[t.MOUSE_UP="wd_mouseup"]="MOUSE_UP",t[t.MOUSE_MOVE="wd_mousemove"]="MOUSE_MOVE",t[t.MOUSE_OVER="wd_mouseover"]="MOUSE_OVER",t[t.MOUSE_OUT="wd_mouseout"]="MOUSE_OUT",t[t.MOUSE_WHEEL="wd_mousewheel"]="MOUSE_WHEEL",t[t.MOUSE_DRAG="wd_mousedrag"]="MOUSE_DRAG",t[t.MATERIAL_CHANGE="wd_material_change"]="MATERIAL_CHANGE",t[t.MATERIAL_COLOR_CHANGE="wd_material_color_change"]="MATERIAL_COLOR_CHANGE",t[t.UI_WIDTH_CHANGE="wd_ui_width_change"]="UI_WIDTH_CHANGE",t[t.UI_HEIGHT_CHANGE="wd_ui_height_change"]="UI_HEIGHT_CHANGE",t[t.TRANSFORM_TRANSLATE="wd_transform_translate"]="TRANSFORM_TRANSLATE",t[t.TRANSFORM_ROTATE="wd_transform_rotate"]="TRANSFORM_ROTATE",t[t.TRANSFORM_SCALE="wd_transform_scale"]="TRANSFORM_SCALE",t[t.SHADOWMAP_SOFTTYPE_CHANGE="wd_shadowMap_softType_change"]="SHADOWMAP_SOFTTYPE_CHANGE",t[t.COMPONENT_CHANGE="wd_component_change"]="COMPONENT_CHANGE"}(t.EEngineEvent||(t.EEngineEvent={}));t.EEngineEvent}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.activeGeometry=null,this._levelList=wdCb.Collection.create(),this._originGeometry=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.init=function(){var n=this.entityObject;this.activeGeometry=n.getComponent(t.Geometry),this._originGeometry=this.activeGeometry,this._levelList.filter(function(t){var e=t.geometry;t.distanceBetweenCameraAndObject;return!!e}).forEach(function(t){var e=t.geometry;t.distanceBetweenCameraAndObject;e.entityObject=n,e.init(),e.createBuffersFromGeometryData()}),e.prototype.init.call(this)},n.prototype.addGeometryLevel=function(t,e){this._levelList.addChild({distanceBetweenCameraAndObject:t,geometry:e}),this._levelList.sort(function(t,e){return e.distanceBetweenCameraAndObject-t.distanceBetweenCameraAndObject},!0)},n.prototype.update=function(e){var n=t.Vector3.create().sub2(t.Director.getInstance().scene.currentCamera.transform.position,this.entityObject.transform.position).length(),r=!0,o=null;return this._levelList.forEach(function(t){var e=t.geometry,i=t.distanceBetweenCameraAndObject;return n>=i?(o=e,r=!1,wdCb.$BREAK):void 0}),o===t.ELODGeometryState.INVISIBLE?(this.activeGeometry=null,void(this.entityObject.isVisible=!1)):(this.entityObject.isVisible=!0,void(o&&!t.JudgeUtils.isEqual(o,this.activeGeometry)?(this.activeGeometry=o,t.EventManager.trigger(this.entityObject,t.CustomEvent.create(t.EEngineEvent.COMPONENT_CHANGE))):r&&(this.activeGeometry=this._originGeometry)))},n}(t.Component);t.LODController=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.INVISIBLE=0]="INVISIBLE"}(t.ELODGeometryState||(t.ELODGeometryState={}));t.ELODGeometryState}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.Component);t.EventTriggerDetector=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.isTrigger=function(e){var n=this.entityObject.transform,r=n.width,o=n.height,i=n.position,a=e.locationInView,s=null;return s=t.Vector2.create(i.x-r/2,i.y-o/2),t.EventTriggerDetectorUtils.isInRect(a,s,r,o)},n}(t.EventTriggerDetector);t.UIEventTriggerDetector=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.isTrigger=function(e){var n=t.Director.getInstance().scene,r=n.currentCamera.getComponent(t.CameraController),o=e.locationInView;return r.isIntersectWithRay(this.entityObject,o.x,o.y)},n}(t.EventTriggerDetector);t.RayCasterEventTriggerDetector=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.isTrigger=function(e){var n=t.DeviceManager.getInstance().view,r=n.width,o=n.height,i=e.locationInView,a=t.Vector2.create(0,0);return t.EventTriggerDetectorUtils.isInRect(i,a,r,o)},n}(t.EventTriggerDetector);t.SceneEventTriggerDetector=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.isInRect=function(t,e,n,r){return t.x>=e.x&&t.x<=e.x+n&&t.y>=e.y&&t.y<=e.y+r},t}();t.EventTriggerDetectorUtils=e}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create(),n=wdCb.Hash.create();e.addChild(t.EEventName.CLICK,"onMouseClick"),e.addChild(t.EEventName.MOUSEOVER,"onMouseOver"),e.addChild(t.EEventName.MOUSEOUT,"onMouseOut"),e.addChild(t.EEventName.MOUSEMOVE,"onMouseMove"),e.addChild(t.EEventName.MOUSEDOWN,"onMouseDown"),e.addChild(t.EEventName.MOUSEUP,"onMouseUp"),e.addChild(t.EEventName.MOUSEWHEEL,"onMouseWheel"),e.addChild(t.EEventName.MOUSEDRAG,"onMouseDrag"),n.addChild(t.EEventName.CLICK,"MOUSE_CLICK"),n.addChild(t.EEventName.MOUSEDOWN,"MOUSE_DOWN"),n.addChild(t.EEventName.MOUSEUP,"MOUSE_UP"),n.addChild(t.EEventName.MOUSEMOVE,"MOUSE_MOVE"),n.addChild(t.EEventName.MOUSEOVER,"MOUSE_OVER"),n.addChild(t.EEventName.MOUSEOUT,"MOUSE_OUT"),n.addChild(t.EEventName.MOUSEWHEEL,"MOUSE_WHEEL"),n.addChild(t.EEventName.MOUSEDRAG,"MOUSE_DRAG");var r=function(){function t(){}return t.getScriptHandlerName=function(t){var n=e.getChild(t);return n},t.getScriptEngineEvent=function(t){var e=n.getChild(t);return e},t}();t.EventTriggerTable=r}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(t){void 0===t&&(t=null),e.call(this),this.url=null,this.url=t}return __extends(n,e),n.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(0===t.length)return new this;if(1===t.length){var n=t[0];return new this(n)}},n.addScript=function(t,e){this.scriptList.push({name:t,"class":e})},n.prototype.createLoadJsStream=function(){return t.Log.error(!this.url,t.Log.info.FUNC_MUST_DEFINE("url")),t.LoaderManager.getInstance().load(this.url).map(function(){return n.scriptList.pop()})},n.prototype.addToObject=function(t){var n=this;e.prototype.addToObject.call(this,t),this.createLoadJsStream().subscribe(function(e){n._handlerAfterLoadedScript(e,t)})},n.prototype._handlerAfterLoadedScript=function(e,n){this._addScriptToEntityObject(n,e),n.execScript("onEnter",null,!0),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.BEFORE_GAMEOBJECT_INIT)),n.execScript("init",null,!0),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.AFTER_GAMEOBJECT_INIT)),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.AFTER_GAMEOBJECT_INIT_RIGIDBODY_ADD_CONSTRAINT))},n.prototype._addScriptToEntityObject=function(t,e){t.scriptList.addChild(e.name,new e["class"](t))},n.scriptList=wdCb.Stack.create(),n}(t.Component);t.Script=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.p_parent=null,this._isTranslate=!1,this._isRotate=!1,this._isScale=!1,this.dirtyLocal=!0,this.children=wdCb.Collection.create()}return __extends(n,e),Object.defineProperty(n.prototype,"parent",{get:function(){return this.p_parent},set:function(t){this.setParent(t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isTransform",{get:function(){return this.isTranslate||this.isRotate||this.isScale},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isTranslate",{get:function(){return this._isTranslate},set:function(e){this._setGlobalTransformState(t.ETransformState.ISTRANSLATE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isRotate",{get:function(){return this._isRotate},set:function(e){this._setGlobalTransformState(t.ETransformState.ISROTATE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isScale",{get:function(){return this._isScale},set:function(e){this._setGlobalTransformState(t.ETransformState.ISSCALE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isLocalTranslate",{set:function(e){this._setLocalTransformState(t.ETransformState.ISLOCALTRANSLATE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isLocalRotate",{set:function(e){this._setLocalTransformState(t.ETransformState.ISLOCALROTATE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isLocalScale",{set:function(e){this._setLocalTransformState(t.ETransformState.ISLOCALSCALE,e)},enumerable:!0,configurable:!0}),n.prototype.addChild=function(t){this.children.addChild(t)},n.prototype.removeChild=function(t){this.children.removeChild(t)},n.prototype.setChildrenTransformState=function(t,e){e&&this.children.forEach(function(e){e[t]=!0})},n.prototype.handleWhenSetTransformState=function(t){},n.prototype.setParent=function(t){return this.p_parent&&this.p_parent.removeChild(this),t?(this.p_parent=t,void this.p_parent.addChild(this)):void(this.p_parent=null)},n.prototype.getMatrix=function(t,e){var n=wdCb.Collection.create(),r=this.p_parent;for(n.addChild(this);null!==r;)n.addChild(r),r=r.parent;return n.reverse().forEach(function(e){e[t]()}),this[e]},n.prototype._setGlobalTransformState=function(t,e){this["_"+t]=e,e&&(this.dirtyLocal=!0,this.clearCache(),this.handleWhenSetTransformState(t)),e&&this.setChildrenTransformState(t,e)},n.prototype._setLocalTransformState=function(t,e){e&&(this.dirtyLocal=!0,this.clearCache()),e&&this.setChildrenTransformState(t,e)},__decorate([t.virtual],n.prototype,"handleWhenSetTransformState",null),n}(t.Component);t.Transform=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._localToWorldMatrix=null,this._position=t.Vector3.create(),this._rotation=t.Quaternion.create(0,0,0,1),this._scale=t.Vector3.create(1,1,1),this._eulerAngles=null,this._localPosition=t.Vector3.create(0,0,0),this._localRotation=t.Quaternion.create(0,0,0,1),this._localEulerAngles=null,this._localScale=t.Vector3.create(1,1,1),this.dirtyWorld=null,this._localToParentMatrix=t.Matrix4.create(),this._endLoopSubscription=null,this._localToWorldMatrixCache=null,this._positionCache=null,this._rotationCache=null,this._scaleCache=null,this._eulerAnglesCache=null,this._localEulerAnglesCache=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"localToWorldMatrix",{get:function(){return this.getMatrix("sync","_localToWorldMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"position",{get:function(){return this._position=this.localToWorldMatrix.getTranslation(),this._position},set:function(t){null===this.p_parent?this._localPosition=t.copy():this._localPosition=this.p_parent.localToWorldMatrix.copy().invert().multiplyPoint(t),this.isTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rotation",{get:function(){return this._rotation.setFromMatrix(this.localToWorldMatrix),this._rotation},set:function(t){null===this.p_parent?this._localRotation=t.copy():this._localRotation=this.p_parent.rotation.copy().invert().multiply(t),this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scale",{get:function(){return this._scale=this.localToWorldMatrix.getScale(),this._scale},set:function(t){null===this.p_parent?this._localScale=t.copy():this._localScale=this.p_parent.localToWorldMatrix.copy().invert().multiplyVector3(t),this.isScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"eulerAngles",{get:function(){return this._eulerAngles=this.localToWorldMatrix.getEulerAngles(),this._eulerAngles},set:function(t){this._localRotation.setFromEulerAngles(t),null!==this.p_parent&&(this._localRotation=this.p_parent.rotation.copy().invert().multiply(this._localRotation)),this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localPosition",{get:function(){return this._localPosition},set:function(t){this._localPosition=t.copy(),this.isLocalTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localRotation",{get:function(){return this._localRotation},set:function(t){this._localRotation=t.copy(),this.isLocalRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localEulerAngles",{get:function(){return this._localEulerAngles=this._localRotation.getEulerAngles(),this._localEulerAngles},set:function(t){this._localRotation.setFromEulerAngles(t),this.isLocalRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localScale",{get:function(){return this._localScale},set:function(t){this._localScale=t.copy(),this.isLocalScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"up",{get:function(){return this.localToWorldMatrix.getY().normalize()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this.localToWorldMatrix.getX().normalize()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"forward",{get:function(){return this.localToWorldMatrix.getZ().normalize().scale(-1)},enumerable:!0,configurable:!0}),n.prototype.init=function(){var e=this;this._endLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.ENDLOOP).subscribe(function(){e._resetTransformFlag()})},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._endLoopSubscription&&this._endLoopSubscription.dispose()},n.prototype.sync=function(){this.dirtyLocal&&(this._localToParentMatrix.setTRS(this._localPosition,this._localRotation,this._localScale),this.dirtyLocal=!1,this.dirtyWorld=!0),this.dirtyWorld&&(null===this.p_parent?this._localToWorldMatrix=this._localToParentMatrix.copy():this._localToWorldMatrix=this.p_parent.localToWorldMatrix.copy().multiply(this._localToParentMatrix),this.dirtyWorld=!1,this.children.forEach(function(t){t.dirtyWorld=!0}))},n.prototype.translateLocal=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return r=3===e.length?t.Vector3.create(e[0],e[1],e[2]):e[0],this._localPosition=this._localPosition.add(this._localRotation.multiplyVector3(r)),this.isTranslate=!0,this},n.prototype.translate=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return r=3===e.length?t.Vector3.create(e[0],e[1],e[2]):e[0],this.position=r.add(this.position),this},n.prototype.rotate=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,o=t.Quaternion.create();return r=3===e.length?t.Vector3.create(e[0],e[1],e[2]):e[0],o.setFromEulerAngles(r),null===this.p_parent?this._localRotation=o.multiply(this._localRotation):(o=this.p_parent.rotation.copy().invert().multiply(o),this._localRotation=o.multiply(this.rotation)),this.isRotate=!0,this},n.prototype.rotateLocal=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,o=t.Quaternion.create();return r=3===e.length?t.Vector3.create(e[0],e[1],e[2]):e[0],o.setFromEulerAngles(r),this._localRotation.multiply(o),this.isRotate=!0,this},n.prototype.rotateAround=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,o=null,i=null,a=null,s=null;return 3===e.length?(r=e[0],o=e[1],i=e[2]):(r=e[0],o=t.Vector3.create(e[1],e[2],e[3]),i=t.Vector3.create(e[4],e[5],e[6])),a=t.Quaternion.create().setFromAxisAngle(r,i),s=this.position.copy().sub(o),s=a.multiplyVector3(s),this.position=o.add(s),this.rotation=a.multiply(this.rotation),this},n.prototype.lookAt=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,o=null;return 1===e.length?(r=e[0],o=t.Vector3.up):2===e.length?(r=e[0],o=e[1]):3===e.length?(r=t.Vector3.create(e[0],e[1],e[2]),o=t.Vector3.up):(r=t.Vector3.create(e[0],e[1],e[2]),
o=t.Vector3.create(e[3],e[4],e[5])),this.rotation=t.Quaternion.create().setFromMatrix(t.Matrix4.create().setLookAt(this.position,r,o)),this},n.prototype.clearCache=function(){this._localToWorldMatrixCache=null,this._positionCache=null,this._rotationCache=null,this._scaleCache=null,this._eulerAnglesCache=null,this._localEulerAnglesCache=null},n.prototype.handleWhenSetTransformState=function(e){var n=null;switch(e){case t.ETransformState.ISTRANSLATE:n=t.EEngineEvent.TRANSFORM_TRANSLATE;break;case t.ETransformState.ISROTATE:n=t.EEngineEvent.TRANSFORM_ROTATE;break;case t.ETransformState.ISSCALE:n=t.EEngineEvent.TRANSFORM_SCALE;break;default:t.Log.error(!0,t.Log.info.FUNC_UNKNOW("transformState:"+e))}t.EventManager.trigger(this.entityObject,t.CustomEvent.create(n))},n.prototype._resetTransformFlag=function(){this.isTranslate=!1,this.isScale=!1,this.isRotate=!1},__decorate([t.cacheGetter(function(){return null!==this._localToWorldMatrixCache},function(){return this._localToWorldMatrixCache},function(t){this._localToWorldMatrixCache=t})],n.prototype,"localToWorldMatrix",null),__decorate([t.cacheGetter(function(){return null!==this._positionCache},function(){return this._positionCache},function(t){this._positionCache=t})],n.prototype,"position",null),__decorate([t.cacheGetter(function(){return null!==this._rotationCache},function(){return this._rotationCache},function(t){this._rotationCache=t})],n.prototype,"rotation",null),__decorate([t.cacheGetter(function(){return null!==this._scaleCache},function(){return this._scaleCache},function(t){this._scaleCache=t})],n.prototype,"scale",null),__decorate([t.cacheGetter(function(){return null!==this._eulerAnglesCache},function(){return this._eulerAnglesCache},function(t){this._eulerAnglesCache=t})],n.prototype,"eulerAngles",null),__decorate([t.cacheGetter(function(){return null!==this._localEulerAnglesCache},function(){return this._localEulerAnglesCache},function(t){this._localEulerAnglesCache=t})],n.prototype,"localEulerAngles",null),n}(t.Transform);t.ThreeDTransform=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._rotationMatrix=null,this._localPositionAndScaleMatrix=t.Matrix3.create(),this._position=t.Vector2.create(),this._rotation=0,this._scale=t.Vector2.create(1,1),this._localPosition=t.Vector2.create(0,0),this._localScale=t.Vector2.create(1,1),this._anchorX=t.Vector2.create(.5,.5),this._anchorY=t.Vector2.create(.5,.5),this._width=null,this._height=null,this.dirtyRotation=!0,this.dirtyPositionAndScale=!0,this.pivot=t.Vector2.create(0,0),this.zIndex=1,this._localRotationMatrix=t.Matrix3.create(),this._localToParentMatrix=t.Matrix3.create(),this._rotationMatrixCache=null,this._localPositionAndScaleMatrixCache=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"rotationMatrix",{get:function(){return this.getMatrix("syncRotation","_rotationMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localPositionAndScaleMatrix",{get:function(){return this.getMatrix("syncPositionAndScale","_localPositionAndScaleMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"position",{get:function(){return this._position=this.localPositionAndScaleMatrix.getTranslation(),this._position},set:function(t){null===this.p_parent?this._localPosition=t.copy():this._localPosition=this.p_parent.localPositionAndScaleMatrix.copy().invert().multiplyPoint(t),this.isTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rotation",{get:function(){return this._rotation=this.rotationMatrix.getRotation(),this._rotation},set:function(t){this.resetRotation(),this.rotate(t),this.dirtyRotation=!0,this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"scale",{get:function(){return this._scale=this.localPositionAndScaleMatrix.getScale(),this._scale},set:function(t){null===this.p_parent?this._localScale=t.copy():this._localScale=this.p_parent.localPositionAndScaleMatrix.copy().invert().multiplyVector2(t),this.isScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localPosition",{get:function(){return this._localPosition},set:function(t){this._localPosition=t.copy(),this.isLocalTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"localScale",{get:function(){return this._localScale},set:function(t){this._localScale=t.copy(),this.isLocalScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"anchorX",{get:function(){return this._anchorX},set:function(e){var n=null;if(this._anchorX=e,e.x===e.y){var r=(e.x-.5)*this._getParentWidth();return void(this.position=t.Vector2.create(this._getParentPosition().x+r,this.position.y))}n=this._getParentWidth(),this.position=t.Vector2.create(this._getParentPosition().x+(e.x+e.y-1)/2*n,this.position.y),this.width=n/this._getParentScale().x*(e.y-e.x)*this.scale.x},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"anchorY",{get:function(){return this._anchorY},set:function(e){var n=null;if(this._anchorY=e,e.x===e.y){var r=(e.x-.5)*this._getParentHeight();return void(this.position=t.Vector2.create(this.position.x,this._getParentPosition().y+r))}n=this._getParentHeight(),this.position=t.Vector2.create(this.position.x,this._getParentPosition().y+(e.x+e.y-1)/2*n),this.height=n/this._getParentScale().y*(e.y-e.x)*this.scale.y},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"width",{get:function(){return this._width*this.scale.x},set:function(e){e!==this._width&&(this._width=e,this.entityObject&&t.EventManager.trigger(this.entityObject,t.CustomEvent.create(t.EEngineEvent.UI_WIDTH_CHANGE)))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"height",{get:function(){return this._height*this.scale.y},set:function(e){e!==this._height&&(this._height=e,this.entityObject&&t.EventManager.trigger(this.entityObject,t.CustomEvent.create(t.EEngineEvent.UI_HEIGHT_CHANGE)))},enumerable:!0,configurable:!0}),n.prototype.init=function(){},n.prototype.dispose=function(){},n.prototype.syncRotation=function(){this.dirtyRotation&&(null===this.p_parent?this._rotationMatrix=this._localRotationMatrix.copy():this._rotationMatrix=this.p_parent.rotationMatrix.copy().multiply(this._localRotationMatrix),this.children.forEach(function(t){t.dirtyRotation=!0}))},n.prototype.syncPositionAndScale=function(){this.dirtyLocal&&(this._localToParentMatrix.setTS(this._localPosition,this._localScale),this.dirtyLocal=!1,this.dirtyPositionAndScale=!0),this.dirtyPositionAndScale&&(null===this.p_parent?this._localPositionAndScaleMatrix=this._localToParentMatrix.copy():this._localPositionAndScaleMatrix=this.p_parent.localPositionAndScaleMatrix.copy().multiply(this._localToParentMatrix),this.dirtyLocal=!1,this.children.forEach(function(t){t.dirtyPositionAndScale=!0}))},n.prototype.translate=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return r=2===e.length?t.Vector2.create(e[0],e[1]):e[0],this.position=r.add(this.position),this},n.prototype.rotate=function(t){var e=this.position;return this.rotateAround(t,e.x+this.pivot.x,e.y-this.pivot.y),this.dirtyRotation=!0,this.isRotate=!0,this},n.prototype.rotateAround=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,o=null,i=null,a=null;return 2===e.length?(r=e[0],o=e[1]):(r=e[0],o=t.Vector2.create(e[1],e[2])),i=o.x,a=o.y,this._translateInRotationMatrix(i,a),this._rotateAroundCanvasOriginPoint(r),this._translateInRotationMatrix(-i,-a),this},n.prototype._translateInRotationMatrix=function(t,e){return this._localRotationMatrix.translate(t,e),this},n.prototype.resetPosition=function(){this.position=t.Vector2.create(0,0)},n.prototype.resetScale=function(){this.scale=t.Vector2.create(1,1)},n.prototype.resetRotation=function(){this._localRotationMatrix.setIdentity()},n.prototype.handleWhenSetTransformState=function(e){var n=null;switch(e){case t.ETransformState.ISTRANSLATE:n=t.EEngineEvent.TRANSFORM_TRANSLATE;break;case t.ETransformState.ISROTATE:n=t.EEngineEvent.TRANSFORM_ROTATE;break;case t.ETransformState.ISSCALE:n=t.EEngineEvent.TRANSFORM_SCALE;break;default:t.Log.error(!0,t.Log.info.FUNC_UNKNOW("transformState:"+e))}t.EventManager.trigger(this.entityObject,t.CustomEvent.create(n))},n.prototype.clearCache=function(){this._rotationMatrixCache=null,this._localPositionAndScaleMatrixCache=null},n.prototype._rotateAroundCanvasOriginPoint=function(t){return this._localRotationMatrix.rotate(t),this.dirtyRotation=!0,this},n.prototype._getParentWidth=function(){return null===this.p_parent?t.DeviceManager.getInstance().view.width:this.p_parent.width},n.prototype._getParentHeight=function(){return null===this.p_parent?t.DeviceManager.getInstance().view.height:this.p_parent.height},n.prototype._getParentPosition=function(){if(null===this.p_parent){var e=t.DeviceManager.getInstance().view;return t.Vector2.create(e.width/2,e.height/2)}return this.p_parent.position},n.prototype._getParentScale=function(){return null===this.p_parent?t.Vector2.create(1,1):this.p_parent.scale},__decorate([t.cacheGetter(function(){return null!==this._rotationMatrixCache},function(){return this._rotationMatrixCache},function(t){this._rotationMatrixCache=t})],n.prototype,"rotationMatrix",null),__decorate([t.cacheGetter(function(){return null!==this._localPositionAndScaleMatrixCache},function(){return this._localPositionAndScaleMatrixCache},function(t){this._localPositionAndScaleMatrixCache=t})],n.prototype,"localPositionAndScaleMatrix",null),__decorate([t.requireSetter(function(e){t.assert(e.x<=e.y,t.Log.info.FUNC_SHOULD("minX","<= maxY")),t.assert(e.x>=0&&e.x<=1,t.Log.info.FUNC_SHOULD("minX",">= 0 && <= 1")),t.assert(e.y>=0&&e.y<=1,t.Log.info.FUNC_SHOULD("maxX",">= 0 && <= 1"))})],n.prototype,"anchorX",null),__decorate([t.requireSetter(function(e){t.assert(e.x<=e.y,t.Log.info.FUNC_SHOULD("minY","<= maxY")),t.assert(e.x>=0&&e.x<=1,t.Log.info.FUNC_SHOULD("minY",">= 0 && <= 1")),t.assert(e.y>=0&&e.y<=1,t.Log.info.FUNC_SHOULD("maxY",">= 0 && <= 1"))})],n.prototype,"anchorY",null),n}(t.Transform);t.RectTransform=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.ISTRANSLATE="isTranslate"]="ISTRANSLATE",t[t.ISROTATE="isRotate"]="ISROTATE",t[t.ISSCALE="isScale"]="ISSCALE",t[t.ISLOCALTRANSLATE="isLocalTranslate"]="ISLOCALTRANSLATE",t[t.ISLOCALROTATE="isLocalRotate"]="ISLOCALROTATE",t[t.ISLOCALSCALE="isLocalScale"]="ISLOCALSCALE"}(t.ETransformState||(t.ETransformState={}));t.ETransformState}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this.list=wdCb.Collection.create()}return t.prototype.addChild=function(t){this.hasChild(t)||this.list.addChild(t)},t.prototype.removeChild=function(t){this.list.removeChild(t)},t.prototype.hasChild=function(t){return this.list.hasChild(t)},t}();t.ComponentContainer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.update=function(t){var e=[];this.list.forEach(function(n){return n.isFinish?void e.push(n):void(n.isStop||n.isPause||n.update(t))});for(var n=0,r=e;n<r.length;n++){var o=r[n];o.entityObject.removeComponent(o)}},e}(t.ComponentContainer);t.ActionManager=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(t){e.call(this),this._uiObject=null,this._uiObject=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.update=function(t){0!==this.list.getCount()&&this._isDirty()&&this.list.forEach(function(e){e.update(t)})},n.prototype._isDirty=function(){return this._uiObject.getComponent(t.UIRenderer).state===t.EUIRendererState.DIRTY},__decorate([t.require(function(e){t.assert(this.list.getCount()<=1,t.Log.info.FUNC_SHOULD("only contain one ui component"))})],n.prototype,"update",null),n}(t.ComponentContainer);t.UIManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._lights=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"ambientLight",{get:function(){return this._lights.getChild(t.AmbientLight.type)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"directionLights",{get:function(){return this._lights.getChild(t.DirectionLight.type)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pointLights",{get:function(){return this._lights.getChild(t.PointLight.type)},enumerable:!0,configurable:!0}),e.prototype.addChild=function(e){e.hasComponent(t.AmbientLight)?this._lights.addChild(t.AmbientLight.type,e):e.hasComponent(t.DirectionLight)?this._lights.appendChild(t.DirectionLight.type,e):e.hasComponent(t.PointLight)?this._lights.appendChild(t.PointLight.type,e):t.Log.error(!0,t.Log.info.FUNC_INVALID("light"))},e.prototype.addChildren=function(t){var e=this;t.forEach(function(t){e.addChild(t)})},e}();t.LightManager=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.isFrameChange=!1,this.state=n.DEFAULT,this.pauseTime=null,this.resumeTime=null,this.pauseDuration=null,this.frameCount=null,this._isResume=!1}return __extends(r,e),Object.defineProperty(r.prototype,"isStart",{get:function(){return this.state===n.RUN},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isStop",{get:function(){return this.state===n.STOP},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isPause",{get:function(){return this.state===n.PAUSE},enumerable:!0,configurable:!0}),r.prototype.pause=function(){this.state=n.PAUSE,this.pauseTime=this.getPauseTime()},r.prototype.resume=function(){this.state=n.RUN,this._isResume=!0,this.resumeTime=this.getResumeTime()},r.prototype.stop=function(){this.state=n.STOP},r.prototype.update=function(t){if(this.state!==n.DEFAULT&&!this.isStop){if(this.isPause)return void this.handleWhenPause(t);this._isResume&&(this._isResume=!1,this.continueFromPausePoint(t)),this.handleBeforeJudgeWhetherCurrentFrameFinish(t),this.isCurrentFrameFinish(t)?this.handleWhenCurrentFrameFinish(t):this.isFrameChange=!1,this.handleAfterJudgeWhetherCurrentFrameFinish(t)}},r.prototype.getPauseTime=function(){return this.getCurrentTime()},r.prototype.getResumeTime=function(){return this.getCurrentTime()},r.prototype.getCurrentTime=function(){return t.Director.getInstance().elapsed},r.prototype.continueFromPausePoint=function(t){this.pauseDuration+=this.resumeTime-this.pauseTime},r}(t.Component);t.Animation=e,function(t){t[t.DEFAULT=0]="DEFAULT",t[t.RUN=1]="RUN",t[t.STOP=2]="STOP",t[t.PAUSE=3]="PAUSE"}(t.EAnimationState||(t.EAnimationState={}));var n=t.EAnimationState}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.interpolation=0,this.currentFrame=0,this.duration=null,this.fps=null,this.currentAnimName=null,this._prevFrameEndTime=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"nextFrame",{get:function(){var t=this.currentFrame+1;return t>=this.frameCount&&(t=0),t},enumerable:!0,configurable:!0}),n.prototype.init=function(){},n.prototype.dispose=function(){},n.prototype.play=function(e,n){var r=this.entityObject.getComponent(t.ModelGeometry);this.currentAnimName=e,this.fps=n,this.duration=1/n*1e3,this.frameCount=r.morphTargets.getChild(e).getCount(),this.resetAnim(),this.state=t.EAnimationState.RUN},n.prototype.handleWhenPause=function(t){},n.prototype.handleWhenCurrentFrameFinish=function(t){this.isFrameChange=!0,this._prevFrameEndTime=t-this.pauseDuration-(t-this.pauseDuration)%this.duration,this.currentFrame++,this._isFinishAllFrames()&&(this.currentFrame=0)},n.prototype.handleBeforeJudgeWhetherCurrentFrameFinish=function(t){null===this._prevFrameEndTime&&(this._prevFrameEndTime=this.getCurrentTime())},n.prototype.isCurrentFrameFinish=function(t){return t-this._prevFrameEndTime-this.pauseDuration>this.duration},n.prototype.handleAfterJudgeWhetherCurrentFrameFinish=function(t){this._computeInterpolation(t)},n.prototype.resetAnim=function(){this._prevFrameEndTime=null,this.currentFrame=0,this.pauseDuration=0},n.prototype._computeInterpolation=function(t){this.interpolation=this.fps*(t-this._prevFrameEndTime-this.pauseDuration)/1e3},n.prototype._isFinishAllFrames=function(){return this.currentFrame>=this.frameCount},__decorate([t.require(function(e,n){var r=this.entityObject.getComponent(t.ModelGeometry);t.assert(r,t.Log.info.FUNC_SHOULD("this entityObject","add ModelGeometry component")),t.assert(r.morphTargets.getChild(e)&&r.morphTargets.getChild(e).getCount()>0,t.Log.info.FUNC_NOT_EXIST('"'+e+'" animation'))}),t.ensure(function(){t.assert(this.frameCount>1,t.Log.info.FUNC_SHOULD("frames.count","> 1"))})],n.prototype,"play",null),__decorate([t.require(function(e){t.assert(e-this._prevFrameEndTime-this.pauseDuration>=0,t.Log.info.FUNC_SHOULD("elapsedTime of current frame:"+(e-this._prevFrameEndTime-this.pauseDuration),">= 0"))})],n.prototype,"isCurrentFrameFinish",null),__decorate([t.ensure(function(){var e=this.interpolation;t.assert(e>=0&&1>=e,t.Log.info.FUNC_SHOULD("interpolation("+e,">= 0 && <= 1"))})],n.prototype,"_computeInterpolation",null),n}(t.Animation);t.MorphAnimation=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.data=null,this._currentFrame=null,this._currentAnimName=null,this._beginElapsedTimeOfFirstFrame=null,this._prevFrameTime=null,this._currentAnimData=null,this._currentFrameData=null,this._prevFrameData=null,this._startFrameDataMap=wdCb.Hash.create()}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.init=function(){},n.prototype.dispose=function(){},n.prototype.play=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.JudgeUtils.isNumber(e[0])){var r=e[0],o=0,i=this;this.data.forEach(function(t,e){return r===o?(i._currentAnimName=e,i._currentAnimData=t,wdCb.$BREAK):void o++})}else if(t.JudgeUtils.isString(e[0])){var a=e[0];this._currentAnimName=a,this._currentAnimData=this.data.getChild(a)}this.resetAnim(),this._saveStartFrameData(this.entityObject.transform),this.frameCount=this._currentAnimData.getCount(),this.state=t.EAnimationState.RUN},n.prototype.handleWhenPause=function(t){},n.prototype.handleWhenCurrentFrameFinish=function(t){this.isFrameChange=!0,this._updateFrame(t),this._saveStartFrameData(this._prevFrameData)},n.prototype.handleBeforeJudgeWhetherCurrentFrameFinish=function(t){null===this._beginElapsedTimeOfFirstFrame&&(this._beginElapsedTimeOfFirstFrame=this.getCurrentTime())},n.prototype.isCurrentFrameFinish=function(t){return t-this._beginElapsedTimeOfFirstFrame-this.pauseDuration>this._currentFrameData.time},n.prototype.handleAfterJudgeWhetherCurrentFrameFinish=function(t){this._updateTargets(t)},n.prototype.resetAnim=function(){this._beginElapsedTimeOfFirstFrame=null,this._prevFrameTime=0,this.pauseDuration=0,this._currentFrame=0,this._prevFrameData=null,this._updateCurrentFrameData(),this._startFrameDataMap.removeAllChildren()},n.prototype._updateTargets=function(e){var n=this,r=this.entityObject.transform,o=this._startFrameDataMap;this._currentFrameData.targets.forEach(function(i){var a=i.data,s=o.getChild(i.target),c=n._computeInterpolation(e,i.interpolationMethod);switch(i.target){case t.EArticulatedAnimationTarget.TRANSLATION:r.localPosition=t.Vector3.create().lerp(s,a,c);break;case t.EArticulatedAnimationTarget.ROTATION:r.localRotation=t.Quaternion.create().slerp(s,a,c);break;case t.EArticulatedAnimationTarget.SCALE:r.localScale=t.Vector3.create().lerp(s,a,c);break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("EArticulatedAnimationTarget:"+i.target))}})},n.prototype._computeInterpolation=function(e,n){var r=null;switch(n){case t.EKeyFrameInterpolation.LINEAR:r=this._currentFrameData.time-this._prevFrameTime===0?1:(e-this._beginElapsedTimeOfFirstFrame-this.pauseDuration-this._prevFrameTime)/(this._currentFrameData.time-this._prevFrameTime);break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("interpolationMethod:"+n))}return r},n.prototype._saveStartFrameData=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this._startFrameDataMap;if(this._isFrameData(e[0])){var o=e[0];o.targets.forEach(function(t){r.addChild(t.target,t.data)})}else{var i=e[0];r.addChild(t.EArticulatedAnimationTarget.TRANSLATION,i.localPosition),r.addChild(t.EArticulatedAnimationTarget.ROTATION,i.localRotation),r.addChild(t.EArticulatedAnimationTarget.SCALE,i.localScale)}},n.prototype._updateCurrentFrameData=function(){this._currentFrameData=this._currentAnimData.getChild(this._currentFrame)},n.prototype._updateFrame=function(t){this._updateCurrentFrameIndex(t),this._isFinishAllFrames()?(this._currentFrame=0,this._beginElapsedTimeOfFirstFrame=this._getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames(t),this._prevFrameTime=0,this._prevFrameData=this._currentAnimData.getChild(this.frameCount-1),this._updateCurrentFrameData()):this._prevFrameTime=this._currentAnimData.getChild(this._currentFrame-1).time},n.prototype._getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames=function(t){return t-t%this._currentAnimData.getChild(this.frameCount-1).time},n.prototype._isFinishAllFrames=function(){return this._currentFrame>=this.frameCount},n.prototype._updateCurrentFrameIndex=function(t){do this._currentFrame++,this._prevFrameData=this._currentFrameData,this._updateCurrentFrameData();while(!this._isFinishAllFrames()&&this.isCurrentFrameFinish(t))},n.prototype._isFrameData=function(t){return void 0!==t.time&&void 0!==t.targets},__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(t.JudgeUtils.isNumber(e[0])){var r=e[0];t.assert(this.data.getCount()>=r+1,t.Log.info.FUNC_NOT_EXIST("animation index:"+r))}else if(t.JudgeUtils.isString(e[0])){var o=e[0];t.assert(this.data.hasChild(o),t.Log.info.FUNC_NOT_EXIST("animation name:"+o))}}),t.ensure(function(){t.assert(!!this._currentAnimData,t.Log.info.FUNC_NOT_EXIST("animation name:"+this._currentAnimName)),this._currentAnimData.forEach(function(e){t.assert(e.time>=0,t.Log.info.FUNC_SHOULD("time",">= 0")),t.assert(e.targets.getCount()>0,t.Log.info.FUNC_SHOULD("ArticulatedAnimationFrameData->targets.getCount()","> 0")),e.targets.forEach(function(e){var n=e.data;switch(e.target){case t.EArticulatedAnimationTarget.TRANSLATION:t.assert(n instanceof t.Vector3,t.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget === TRANSLATION, its data","Vector3"));break;case t.EArticulatedAnimationTarget.ROTATION:t.assert(n instanceof t.Quaternion,t.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget ===ROTATION, its data","Quaternion"));break;case t.EArticulatedAnimationTarget.SCALE:t.assert(n instanceof t.Vector3,t.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget === SCALE, its data","Vector3"));break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("EArticulatedAnimationTarget:"+e.target))}})})})],n.prototype,"play",null),__decorate([t.require(function(e){t.assert(e-this._beginElapsedTimeOfFirstFrame-this.pauseDuration>=0,t.Log.info.FUNC_SHOULD("elapsedTime of current frame:"+(e-this._beginElapsedTimeOfFirstFrame-this.pauseDuration),">= 0"))})],n.prototype,"isCurrentFrameFinish",null),__decorate([t.ensure(function(e,n,r){t.assert(e>=0&&1>=e,t.Log.info.FUNC_SHOULD("interpolation:"+e,">= 0 && <= 1"))})],n.prototype,"_computeInterpolation",null),__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(this._isFrameData(e[0])){var r=e[0];t.assert(null!==this._currentFrameData,t.Log.info.FUNC_SHOULD("set currentFrameData")),this._currentFrameData.targets.forEach(function(e,n){t.assert(r.targets.getChild(n).target===e.target,t.Log.info.FUNC_SHOULD("the current frame and the start frame","modify the same targets"))})}})],n.prototype,"_saveStartFrameData",null),__decorate([t.require(function(e){var n=this._currentAnimData.getChild(this.frameCount-1).time;t.assert(e>=n,t.Log.info.FUNC_SHOULD("elapsedTime:"+e,">= lastEndFrameTime:"+n))})],n.prototype,"_getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames",null),n}(t.Animation);t.ArticulatedAnimation=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.LINEAR=0]="LINEAR"}(t.EKeyFrameInterpolation||(t.EKeyFrameInterpolation={}));t.EKeyFrameInterpolation}(wd||(wd={}));var wd;!function(t){!function(t){t[t.TRANSLATION="position"]="TRANSLATION",t[t.ROTATION="rotation"]="ROTATION",t[t.SCALE="scale"]="SCALE"}(t.EArticulatedAnimationTarget||(t.EArticulatedAnimationTarget={}));t.EArticulatedAnimationTarget}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._material=null,this.buffers=null,this.drawMode=t.EDrawMode.TRIANGLES}return __extends(n,e),Object.defineProperty(n.prototype,"material",{get:function(){return this._material},set:function(e){t.JudgeUtils.isEqual(e,this._material)||(this._material=e,this._material.geometry=this,this.entityObject&&t.EventManager.trigger(this.entityObject,t.CustomEvent.create(t.EEngineEvent.MATERIAL_CHANGE)))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"geometryData",{get:function(){return this.buffers.geometryData},enumerable:!0,configurable:!0}),n.prototype.init=function(){var t=null,e=this.computeData(),n=e.vertices,r=e.faces,o=e.texCoords,i=e.colors,a=e.morphTargets;this.buffers=this.createBufferContainer(),t=this.createGeometryData(n,r,o,i,a),this.buffers.geometryData=t,this.buffers.init(),this._material.init(),this.computeNormals()},n.prototype.hasFaceNormals=function(){return this.buffers.geometryData.hasFaceNormals()},n.prototype.hasVertexNormals=function(){return this.buffers.geometryData.hasVertexNormals()},n.prototype.isSmoothShading=function(){return this._material.shading===t.EShading.SMOOTH},n.prototype.dispose=function(){this.buffers.dispose(),this._material.dispose()},n.prototype.computeFaceNormals=function(){this.buffers.geometryData.computeFaceNormals()},n.prototype.computeVertexNormals=function(){this.buffers.geometryData.computeVertexNormals()},n.prototype.createBuffersFromGeometryData=function(){this.buffers.createBuffersFromGeometryData()},n.prototype.computeNormals=function(){this.isSmoothShading()?this.hasVertexNormals()||this.computeVertexNormals():this.hasFaceNormals()||this.computeFaceNormals()},n.prototype.createBufferContainer=function(){return t.CommonBufferContainer.create(this.entityObject)},n.prototype.createGeometryData=function(t,e,n,r,o){return this.createCommonGeometryData(t,e,n,r)},n.prototype.createCommonGeometryData=function(e,n,r,o){var i=t.CommonGeometryData.create(this);return i.vertices=e,i.faces=n,i.texCoords=r,i.colors=o,i},__decorate([t.ensure(function(){var e=this.buffers.geometryData;t.assert(e.vertices.length>0,t.Log.info.FUNC_MUST("vertices.count","> 0")),t.assert(3*e.faces.length===e.indices.length,t.Log.info.FUNC_SHOULD("faces.count","be "+e.indices.length/3+", but actual is "+e.faces.length))})],n.prototype,"init",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],n.prototype,"hasFaceNormals",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],n.prototype,"hasVertexNormals",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],n.prototype,"computeFaceNormals",null),__decorate([t.require(function(){t.assert(!!this.buffers,t.Log.info.FUNC_NOT_EXIST("buffers"))})],n.prototype,"createBuffersFromGeometryData",null),__decorate([t.virtual],n.prototype,"computeNormals",null),__decorate([t.virtual],n.prototype,"createBufferContainer",null),__decorate([t.virtual],n.prototype,"createGeometryData",null),n}(t.Component);t.Geometry=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){}return e.convertToFaces=function(e,n){for(var r=this.hasData(n),o=[],i=0,a=e.length;a>i;i+=3){var s=e[i],c=e[i+1],u=e[i+2],l=t.Face3.create(s,c,u);r&&(l.vertexNormals.addChildren([this.getThreeComponent(n,s),this.getThreeComponent(n,c),this.getThreeComponent(n,u)]),l.faceNormal=l.vertexNormals.getChild(0).copy()),o.push(l)}return o},e.hasData=function(t){return t&&(t.length&&t.length>0||t.getCount&&t.getCount()>0)},e.getThreeComponent=function(e,n){var r=3*n;return t.Vector3.create(e[r],e[r+1],e[r+2])},e.iterateThreeComponent=function(e,n){
for(var r=0,o=e.length;o>r;r+=3)n(t.Vector3.create(e[r],e[r+1],e[r+2]))},e.setThreeComponent=function(e,n,r){n instanceof t.Vector3?(e[3*r]=n.x,e[3*r+1]=n.y,e[3*r+2]=n.z):(e[3*r]=n[0],e[3*r+1]=n[1],e[3*r+2]=n[2])},__decorate([t.require(function(e){e&&t.assert(e instanceof wdCb.Collection||e instanceof wdCb.Hash||t.JudgeUtils.isArrayExactly(e),t.Log.info.FUNC_SHOULD("data","be Array or Collection or Hash"))})],e,"hasData",null),__decorate([t.require(function(e,n){t.assert(e.length%3===0,t.Log.info.FUNC_SHOULD("dataArr.length","times of three"))})],e,"iterateThreeComponent",null),e}();t.GeometryUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._vertices=[],this._texCoords=[],this._colors=[],this._indices=[],this._normals=[]}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"vertices",{get:function(){return this._vertices},set:function(e){this._vertices=e,this.buffers&&(this.buffers.geometryData.vertices=e,this.buffers.removeCache(t.EBufferDataType.VERTICE))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"texCoords",{get:function(){return this._texCoords},set:function(e){this._texCoords=e,this.buffers&&(this.buffers.geometryData.texCoords=e,this.buffers.removeCache(t.EBufferDataType.TEXCOORD))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"colors",{get:function(){return this._colors},set:function(e){this._colors=e,this.buffers&&(this.buffers.geometryData.colors=e,this.buffers.removeCache(t.EBufferDataType.COLOR))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"indices",{get:function(){return this._indices},set:function(e){this._indices=e,this.buffers&&(this.buffers.geometryData.faces=t.GeometryUtils.convertToFaces(e,this.normals),this.buffers.removeCache(t.EBufferDataType.INDICE))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"normals",{get:function(){return this._normals},set:function(e){this._normals=e,this.buffers&&(this.buffers.geometryData.faces=t.GeometryUtils.convertToFaces(this.indices,e),this.buffers.removeCache(t.EBufferDataType.NORMAL))},enumerable:!0,configurable:!0}),n.prototype.computeData=function(){return{vertices:this.vertices,faces:t.GeometryUtils.convertToFaces(this.indices,this.normals),texCoords:this.texCoords,colors:this.colors}},n}(t.Geometry);t.CustomGeometry=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.vertices=null,this.colors=null,this.texCoords=null,this.faces=null,this.morphTargets=null,this.morphFaceNormals=wdCb.Hash.create(),this.morphVertexNormals=wdCb.Hash.create()}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.hasAnimation=function(){return this._hasMorphTargets()&&this.entityObject&&this.entityObject.hasComponent(t.MorphAnimation)},n.prototype.hasMorphFaceNormals=function(){return this.buffers.geometryData.hasMorphFaceNormals()},n.prototype.hasMorphVertexNormals=function(){return this.buffers.geometryData.hasMorphVertexNormals()},n.prototype.computeMorphNormals=function(){this.buffers.geometryData.computeMorphNormals()},n.prototype.computeNormals=function(){e.prototype.computeNormals.call(this),this._hasMorphTargets()&&(this.isSmoothShading()?this.hasMorphVertexNormals()||this.computeMorphNormals():this.hasMorphFaceNormals()||this.computeMorphNormals())},n.prototype.computeData=function(){return{vertices:this.vertices,faces:this.faces,texCoords:this.texCoords,colors:this.colors,morphTargets:this.morphTargets}},n.prototype.createBufferContainer=function(){return this.hasAnimation()?t.MorphBufferContainer.create(this.entityObject,this.entityObject.getComponent(t.MorphAnimation)):t.CommonBufferContainer.create(this.entityObject)},n.prototype.createGeometryData=function(e,n,r,o,i){if(this.hasAnimation()){var a=t.MorphGeometryData.create(this);return a.vertices=e,a.faces=n,a.texCoords=r,a.colors=o,a.morphTargets=i,a}return this.createCommonGeometryData(e,n,r,o)},n.prototype._hasMorphTargets=function(){return this.morphTargets&&this.morphTargets.getCount()>0},__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],n.prototype,"hasMorphFaceNormals",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],n.prototype,"hasMorphVertexNormals",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],n.prototype,"computeMorphNormals",null),__decorate([t.require(function(){this.hasAnimation()&&t.assert(this.entityObject.getComponent(t.MorphAnimation),t.Log.info.FUNC_SHOULD("entityObject with ModelGeometry","add MorphAnimation component"))})],n.prototype,"createBufferContainer",null),n}(t.Geometry);t.ModelGeometry=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.width=null,this.height=null,this.depth=null,this.widthSegments=1,this.heightSegments=1,this.depthSegments=1}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.computeData=function(){function e(e,n,r){var o,i,a,s,c=p.length/3;for(a=0;n>=a;a++)for(s=0;r>=s;s++){var y=t.Vector3.create(),g=t.Vector3.create(),m=t.Vector3.create(),v=t.Vector3.create();y.lerp(h[u[e][0]],h[u[e][1]],a/n),g.lerp(h[u[e][0]],h[u[e][2]],s/r),m.sub2(g,h[u[e][0]]),v.add2(y,m),o=a/n,i=s/r,p.push(v.x,v.y,v.z),f.push(l[e][0],l[e][1],l[e][2]),d.push(o,i),n>a&&r>s&&(_.push(c+s+a*(n+1),c+s+(a+1)*(n+1),c+s+a*(n+1)+1),_.push(c+s+(a+1)*(n+1),c+s+(a+1)*(n+1)+1,c+s+a*(n+1)+1))}}var n=this.width,r=this.height,o=this.depth,i=this.widthSegments,a=this.heightSegments,s=this.depthSegments,c={FRONT:0,BACK:1,TOP:2,BOTTOM:3,RIGHT:4,LEFT:5},u=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],h=[t.Vector3.create(-n,-r,o),t.Vector3.create(n,-r,o),t.Vector3.create(n,r,o),t.Vector3.create(-n,r,o),t.Vector3.create(n,-r,-o),t.Vector3.create(-n,-r,-o),t.Vector3.create(-n,r,-o),t.Vector3.create(n,r,-o)],p=[],f=[],d=[],_=[];return e(c.FRONT,i,a),e(c.BACK,i,a),e(c.TOP,i,s),e(c.BOTTOM,i,s),e(c.RIGHT,s,a),e(c.LEFT,s,a),{vertices:p,faces:t.GeometryUtils.convertToFaces(_,f),texCoords:d}},n}(t.Geometry);t.BoxGeometry=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.width=null,this.height=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.computeData=function(){var e=this.width,n=this.height,r=-e/2,o=e/2,i=n/2,a=-n/2,s=[],c=[],u=[],l=[];return s=[o,i,0,r,i,0,r,a,0,o,a,0],u=[0,1,2,0,2,3],c=[1,1,0,1,0,0,1,0],l=[0,0,1,0,0,1,0,0,1,0,0,1],{vertices:s,faces:t.GeometryUtils.convertToFaces(u,l),texCoords:c}},n}(t.Geometry);t.RectGeometry=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.width=null,this.height=null,this.widthSegments=1,this.heightSegments=1}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.computeData=function(){var e=this.width,n=this.height,r=this.widthSegments,o=this.heightSegments,i=null,a=null,s=null,c=null,u=null,l=null,h=null,p=[],f=[],d=[],_=[];for(l=0;r>=l;l++)for(h=0;o>=h;h++)i=-e+2*e*l/r,a=0,s=-(-n+2*n*h/o),c=l/r,u=h/o,p.push(i,a,s),d.push(0,1,0),f.push(c,u),r>l&&o>h&&(_.push(h+l*(r+1),h+(l+1)*(r+1),h+l*(r+1)+1),_.push(h+(l+1)*(r+1),h+(l+1)*(r+1)+1,h+l*(r+1)+1));return{vertices:p,faces:t.GeometryUtils.convertToFaces(_,d),texCoords:f}},n}(t.Geometry);t.PlaneGeometry=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.LATITUDELONGTITUDE=0]="LATITUDELONGTITUDE"}(t.ESphereDrawMode||(t.ESphereDrawMode={}));t.ESphereDrawMode}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.radius=1,this.sphereDrawMode=t.ESphereDrawMode.LATITUDELONGTITUDE,this.segments=20}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.computeData=function(){var e=this.radius,r=this.sphereDrawMode,o=this.segments,i=null;if(r===t.ESphereDrawMode.LATITUDELONGTITUDE){var a=n.create(e,o).getData(),s=a.vertices,c=a.indices,u=a.normals,l=a.texCoords;return{vertices:s,faces:t.GeometryUtils.convertToFaces(c,u),texCoords:l}}return i},r}(t.Geometry);t.SphereGeometry=e;var n=function(){function t(t,e){this._radius=null,this._latitudeBands=null,this._longitudeBands=null,this._radius=t,this._latitudeBands=e,this._longitudeBands=e}return t.create=function(t,e){var n=new this(t,e);return n},t.prototype.getData=function(){for(var t=[],e=[],n=[],r=[],o=0;o<=this._latitudeBands;o++)for(var i=o*Math.PI/this._latitudeBands,a=Math.sin(i),s=Math.cos(i),c=0;c<=this._longitudeBands;c++){var u=2*c*Math.PI/this._longitudeBands,l=Math.sin(u),h=Math.cos(u),p=this._radius*h*a,f=this._radius*s,d=this._radius*l*a,_=1-c/this._longitudeBands,y=1-o/this._latitudeBands;e.push(p),e.push(f),e.push(d),n.push(_),n.push(y),t.push(p),t.push(f),t.push(d)}for(var o=0;o<this._latitudeBands;o++)for(var c=0;c<this._longitudeBands;c++){var g=o*(this._longitudeBands+1)+c,m=g+this._longitudeBands+1;r.push(g+1),r.push(m),r.push(g),r.push(g+1),r.push(m+1),r.push(m)}return{vertices:t,indices:r,normals:e,texCoords:n}},t}()}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.width=null,this.height=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.computeData=function(){var e=this.width,n=this.height,r=-e/2,o=e/2,i=n/2,a=-n/2,s=[],c=[],u=[],l=[];return s=[0,i,0,r,a,0,o,a,0],u=[0,1,2],c=[.5,1,0,0,1,0],l=[0,0,1,0,0,1,0,0,1],{vertices:s,faces:t.GeometryUtils.convertToFaces(u,l),texCoords:c}},n}(t.Geometry);t.TriangleGeometry=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(t){this._vertices=null,this._faces=null,this._texCoords=null,this._colors=null,this._tangents=null,this.tangentDirty=!0,this.colorDirty=!0,this.geometry=null,this._normalCache=null,this._normalFromFaceCache=null,this._normalFromVertexCache=null,this._indiceCache=null,this._colorCache=null,this._normalDirty=!0,this._indiceDirty=!0,this._materialColorChangeSubscription=null,this.geometry=t}return Object.defineProperty(e.prototype,"vertices",{get:function(){return this._vertices},set:function(t){this._vertices=t,this.tangentDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normals",{get:function(){var t=this.geometry;return t.isSmoothShading()?(this.hasVertexNormals()||this.computeVertexNormals(),this.normalsFromVertexNormals):(this.hasFaceNormals()||this.computeFaceNormals(),this.normalsFromFaceNormal)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normalsFromFaceNormal",{get:function(){var e=null;return this.hasFaceNormals()?(e=[],this._faces.forEach(function(n){var r=n.faceNormal;t.GeometryUtils.setThreeComponent(e,r,n.aIndex),t.GeometryUtils.setThreeComponent(e,r,n.bIndex),t.GeometryUtils.setThreeComponent(e,r,n.cIndex)}),this._fillEmptyData(e),e):[]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normalsFromVertexNormals",{get:function(){var e=null;return this.hasVertexNormals()?(e=[],this._faces.forEach(function(n){t.GeometryUtils.setThreeComponent(e,n.vertexNormals.getChild(0),n.aIndex),t.GeometryUtils.setThreeComponent(e,n.vertexNormals.getChild(1),n.bIndex),t.GeometryUtils.setThreeComponent(e,n.vertexNormals.getChild(2),n.cIndex)}),this._fillEmptyData(e),e):[]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"indices",{get:function(){for(var t=[],e=0,n=this._faces;e<n.length;e++){var r=n[e];t.push(r.aIndex,r.bIndex,r.cIndex)}return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"faces",{get:function(){return this._faces},set:function(t){this._faces=t,this.onChangeFace()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"texCoords",{get:function(){return this._texCoords},set:function(t){this._texCoords=t,this.tangentDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"colors",{get:function(){return this._needGetColorsFromMaterial()?this._getColorsFromMaterial(this._vertices):this._colors},set:function(t){this._colors=t,this.colorDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tangents",{get:function(){return this.tangentDirty&&(this.tangentDirty=!1,t.GeometryUtils.hasData(this.normals)&&t.GeometryUtils.hasData(this.texCoords)&&t.GeometryUtils.hasData(this.indices)&&(this._tangents=this._calculateTangents(this._vertices,this.normals,this.texCoords,this.indices))),this._tangents},enumerable:!0,configurable:!0}),e.prototype.init=function(){var e=this;this._materialColorChangeSubscription=wdFrp.fromArray([t.EventManager.fromEvent(this.geometry.entityObject,t.EEngineEvent.MATERIAL_COLOR_CHANGE),t.EventManager.fromEvent(this.geometry.entityObject,t.EEngineEvent.MATERIAL_CHANGE)]).subscribe(function(){e._needGetColorsFromMaterial()&&(e.colorDirty=!0)})},e.prototype.dispose=function(){this._materialColorChangeSubscription&&this._materialColorChangeSubscription.dispose()},e.prototype.computeFaceNormals=function(){for(var t=this._vertices,e=0,n=this._faces;e<n.length;e++){var r=n[e];r.faceNormal=this.computeFaceNormalsHelper(t,r.aIndex,r.bIndex,r.cIndex)}},e.prototype.computeVertexNormals=function(){var t=null;this.hasFaceNormals()||this.computeFaceNormals(),t=this.computeVertexNormalsHelper(this._vertices);for(var e=0,n=this._faces;e<n.length;e++){var r=n[e];r.vertexNormals=wdCb.Collection.create([t[r.aIndex],t[r.bIndex],t[r.cIndex]])}},e.prototype.hasFaceNormals=function(){for(var t=0,e=this._faces;t<e.length;t++){var n=e[t];if(!n.hasFaceNormal())return!1}return!0},e.prototype.hasVertexNormals=function(){for(var t=0,e=this._faces;t<e.length;t++){var n=e[t];if(!n.hasVertexNormal())return!1}return!0},e.prototype.onChangeFace=function(){this.tangentDirty=!0,this._normalDirty=!0,this._indiceDirty=!0},e.prototype.computeFaceNormalsHelper=function(e,n,r,o){var i=t.GeometryUtils.getThreeComponent(e,n),a=t.GeometryUtils.getThreeComponent(e,r),s=t.GeometryUtils.getThreeComponent(e,o),c=t.Vector3.create().sub2(s,a),u=t.Vector3.create().sub2(i,a);return t.Vector3.create().cross(c,u).normalize()},e.prototype.computeVertexNormalsHelper=function(e){var n=e.length/3,r=null;r=new Array(n);for(var o=0;n>o;o++)r[o]=t.Vector3.create();for(var i=0,a=this._faces;i<a.length;i++){var s=a[i],c=null;c=s.faceNormal,r[s.aIndex].add(c),r[s.bIndex].add(c),r[s.cIndex].add(c)}for(var o=0;n>o;o++)r[o].normalize();return r},e.prototype._getColorsFromMaterial=function(t){var e=[],n=0,r=this.geometry.material.color,o=r.r,i=r.g,a=r.b,s=null;for(s=t.length/3,n=0;s>n;n++)e.push(o,i,a);return e},e.prototype._fillEmptyData=function(t){for(var e=0,n=t.length;n>e;e++)isNaN(t[e])&&(t[e]=0)},e.prototype._calculateTangents=function(e,n,r,o){var i,a,s,c,u,l,h,p,f,d,_,y,g,m,v,b=o.length/3,C=e.length/3,w=t.Vector3.create(),E=t.Vector3.create(),T=t.Vector3.create(),O=t.Vector3.create(),S=t.Vector3.create(),D=t.Vector2.create(),x=t.Vector2.create(),L=t.Vector2.create(),M=new Float32Array(3*C),A=new Float32Array(3*C),F=t.Vector3.create(),R=t.Vector3.create(),P=[];for(v=0;b>v;v++)i=o[3*v],a=o[3*v+1],s=o[3*v+2],T.set(e[3*i],e[3*i+1],e[3*i+2]),O.set(e[3*a],e[3*a+1],e[3*a+2]),S.set(e[3*s],e[3*s+1],e[3*s+2]),D.set(r[2*i],r[2*i+1]),x.set(r[2*a],r[2*a+1]),L.set(r[2*s],r[2*s+1]),c=O.x-T.x,u=S.x-T.x,l=O.y-T.y,h=S.y-T.y,p=O.z-T.z,f=S.z-T.z,d=x.x-D.x,_=L.x-D.x,y=x.y-D.y,g=L.y-D.y,m=1/(d*g-_*y),w.set((g*c-y*u)*m,(g*l-y*h)*m,(g*p-y*f)*m),E.set((d*u-_*c)*m,(d*h-_*l)*m,(d*f-_*p)*m),M[3*i+0]+=w.x,M[3*i+1]+=w.y,M[3*i+2]+=w.z,M[3*a+0]+=w.x,M[3*a+1]+=w.y,M[3*a+2]+=w.z,M[3*s+0]+=w.x,M[3*s+1]+=w.y,M[3*s+2]+=w.z,A[3*i+0]+=E.x,A[3*i+1]+=E.y,A[3*i+2]+=E.z,A[3*a+0]+=E.x,A[3*a+1]+=E.y,A[3*a+2]+=E.z,A[3*s+0]+=E.x,A[3*s+1]+=E.y,A[3*s+2]+=E.z;for(y=t.Vector3.create(),g=t.Vector3.create(),v=0;C>v;v++){var N=null;F.set(n[3*v],n[3*v+1],n[3*v+2]),y.set(M[3*v],M[3*v+1],M[3*v+2]),g.set(A[3*v],A[3*v+1],A[3*v+2]),N=F.dot(y),R=F.copy().scale(N),R.sub2(y,R).normalize(),P[4*v]=R.x,P[4*v+1]=R.y,P[4*v+2]=R.z,R.cross(F,y),P[4*v+3]=R.dot(g)<0?-1:1}return P},e.prototype._needGetColorsFromMaterial=function(){var t=this._colors;return!t||0===t.length},__decorate([t.requireGetter(function(){t.assert(this._faces.length>0,t.Log.info.FUNC_SHOULD("faces.count","> 0"));for(var e=0,n=this._faces;e<n.length;e++){var r=n[e];this.geometry.isSmoothShading()&&t.assert(r.vertexNormals&&3===r.vertexNormals.getCount(),t.Log.info.FUNC_SHOULD("faces->vertexNormals.count","=== 3"))}}),t.cacheGetter(function(){return!this._normalDirty&&this._normalCache},function(){return this._normalCache},function(t){this._normalCache=t,this._normalDirty=!1})],e.prototype,"normals",null),__decorate([t.requireGetter(function(){t.assert(this._faces.length>0,t.Log.info.FUNC_SHOULD("geometry","has faces"))}),t.ensureGetter(function(e){for(var n=0,r=e;n<r.length;n++){var o=r[n];t.assert(t.JudgeUtils.isNumber(o),t.Log.info.FUNC_SHOULD("normals data","be number"))}}),t.cacheGetter(function(){return!this._normalDirty&&this._normalFromFaceCache},function(){return this._normalFromFaceCache},function(t){this._normalFromFaceCache=t,this._normalDirty=!1})],e.prototype,"normalsFromFaceNormal",null),__decorate([t.requireGetter(function(){t.assert(this._faces.length>0,t.Log.info.FUNC_SHOULD("geometry","has faces"))}),t.ensureGetter(function(e){for(var n=0,r=e;n<r.length;n++){var o=r[n];t.assert(t.JudgeUtils.isNumber(o),t.Log.info.FUNC_SHOULD("normals data","be number"))}}),t.cacheGetter(function(){return!this._normalDirty&&this._normalFromVertexCache},function(){return this._normalFromVertexCache},function(t){this._normalFromVertexCache=t,this._normalDirty=!1})],e.prototype,"normalsFromVertexNormals",null),__decorate([t.cacheGetter(function(){return!this._indiceDirty&&this._indiceCache},function(){return this._indiceCache},function(t){this._indiceCache=t,this._indiceDirty=!1})],e.prototype,"indices",null),__decorate([t.ensureGetter(function(e){t.assert(e.length===this._vertices.length,t.Log.info.FUNC_SHOULD("colors.length:"+e.length,"=== vertices.length:"+this._vertices.length))}),t.cacheGetter(function(){return!this.colorDirty&&this._colorCache},function(){return this._colorCache},function(t){this._colorCache=t,this.colorDirty=!1})],e.prototype,"colors",null),__decorate([t.require(function(){t.assert(t.GeometryUtils.hasData(this.vertices),t.Log.info.FUNC_MUST("contain vertices"))}),t.ensure(function(){for(var e=0,n=this._faces;e<n.length;e++){var r=n[e];t.assert(r.faceNormal instanceof t.Vector3,t.Log.info.FUNC_SHOULD_NOT("faceNormal","be null"))}})],e.prototype,"computeFaceNormals",null),__decorate([t.virtual],e.prototype,"onChangeFace",null),e}();t.GeometryData=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e}(t.GeometryData);t.CommonGeometryData=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._morphTargets=null,this._morphNormalCache=null,this._morphNormalDirty=!0}return __extends(n,e),n.create=function(t){var e=new this(t);return e},Object.defineProperty(n.prototype,"morphNormals",{get:function(){var t=this.geometry;return this._morphNormalDirty=!1,t.isSmoothShading()?(this.hasMorphVertexNormals()||this.computeMorphNormals(),t.morphVertexNormals):(this.hasMorphFaceNormals()||this.computeMorphNormals(),t.morphFaceNormals)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"morphTargets",{get:function(){return this._morphTargets},set:function(t){this._morphTargets=t,this._morphNormalDirty=!0},enumerable:!0,configurable:!0}),n.prototype.computeMorphNormals=function(){var t=this.geometry,e=this;this._morphTargets.forEach(function(r,o){var i=wdCb.Collection.create(),a=wdCb.Collection.create();r.forEach(function(r){var o=n.create(t),s=null,c=null;o.vertices=r,o.faces=e._copyFaces(t.faces),o.computeFaceNormals(),o.computeVertexNormals(),u=e._getMorphNormals(o),s=u[0],c=u[1],i.addChild(s),a.addChild(c);var u}),t.morphFaceNormals.addChild(o,i),t.morphVertexNormals.addChild(o,a)})},n.prototype.hasMorphFaceNormals=function(){return this.geometry.morphFaceNormals.getCount()>0},n.prototype.hasMorphVertexNormals=function(){return this.geometry.morphVertexNormals.getCount()>0},n.prototype.onChangeFace=function(){this._morphNormalDirty=!0},n.prototype._copyFaces=function(t){for(var e=[],n=0,r=t;n<r.length;n++){var o=r[n];e.push(o.copy())}return e},n.prototype._getMorphNormals=function(t){return[t.normalsFromFaceNormal,t.normalsFromVertexNormals]},__decorate([t.cacheGetter(function(){return!this._morphNormalDirty&&this._morphNormalCache},function(){return this._morphNormalCache},function(t){this._morphNormalCache=t})],n.prototype,"morphNormals",null),n}(t.GeometryData);t.MorphGeometryData=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(t){this.geometryData=null,this.entityObject=null,this.container=wdCb.Hash.create(),this._colorBuffer=null,this._texCoordBuffer=null,this._tangentBuffer=null,this._indiceBuffer=null,this._materialChangeSubscription=null,this.entityObject=t}return e.prototype.init=function(){var e=this;this._materialChangeSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MATERIAL_CHANGE).subscribe(function(){e.removeCache(t.EBufferDataType.COLOR),e.geometryData.colorDirty=!0}),this.geometryData.init()},e.prototype.removeCache=function(t){this.container.removeChild(t)},e.prototype.getChild=function(e){var n=null;switch(e){case t.EBufferDataType.VERTICE:n=this.getVertice(e);break;case t.EBufferDataType.NORMAL:n=this.getNormal(e);break;case t.EBufferDataType.TANGENT:n=this._getTangent(e);break;case t.EBufferDataType.COLOR:n=this._getColor(e);break;case t.EBufferDataType.INDICE:n=this._getIndice(e);break;case t.EBufferDataType.TEXCOORD:n=this._getTexCoord(e);break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("EBufferDataType: "+e))}return n},e.prototype.dispose=function(){this.container.forEach(function(t){t.dispose()}),this.geometryData.dispose(),this._materialChangeSubscription&&this._materialChangeSubscription.dispose()},e.prototype.createBuffersFromGeometryData=function(){this.getChild(t.EBufferDataType.VERTICE),this.getChild(t.EBufferDataType.NORMAL),this.getChild(t.EBufferDataType.TANGENT),this.getChild(t.EBufferDataType.COLOR),this.getChild(t.EBufferDataType.INDICE),this.getChild(t.EBufferDataType.TEXCOORD)},e.prototype.createBufferOnlyOnce=function(t,e){this[t]||(this[t]=e.create())},e.prototype.hasData=function(t){return t&&t.length>0},e.prototype._getTangent=function(e){var n=null;return n=this.geometryData[t.BufferDataTable.getGeometryDataName(e)],this.hasData(n)?(this.createBufferOnlyOnce("_tangentBuffer",t.ArrayBuffer),this._tangentBuffer.resetData(new Float32Array(n),3,t.EBufferType.FLOAT),this._tangentBuffer):null},e.prototype._getColor=function(e){var n=null;return n=this.geometryData[t.BufferDataTable.getGeometryDataName(e)],this.hasData(n)?(this.createBufferOnlyOnce("_colorBuffer",t.ArrayBuffer),this._colorBuffer.resetData(new Float32Array(n),3,t.EBufferType.FLOAT),this._colorBuffer):null},e.prototype._getIndice=function(e){var n=null;return n=this.geometryData[t.BufferDataTable.getGeometryDataName(e)],this.hasData(n)?(this.createBufferOnlyOnce("_indiceBuffer",t.ElementBuffer),this._indiceBuffer.resetData(new Uint16Array(n),t.EBufferType.UNSIGNED_SHORT),this._indiceBuffer):null},e.prototype._getTexCoord=function(e){var n=null;return n=this.geometryData[t.BufferDataTable.getGeometryDataName(e)],this.hasData(n)?(this.createBufferOnlyOnce("_texCoordBuffer",t.ArrayBuffer),this._texCoordBuffer.resetData(new Float32Array(n),2,t.EBufferType.FLOAT),this._texCoordBuffer):null},e.prototype._needReCalcuteTangent=function(e){return this.geometryData.tangentDirty&&e===t.EBufferDataType.TANGENT},__decorate([t.cache(function(t){return this.container.hasChild(t)&&!this._needReCalcuteTangent(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],e.prototype,"_getTangent",null),__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],e.prototype,"_getColor",null),__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],e.prototype,"_getIndice",null),__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],e.prototype,"_getTexCoord",null),e}();t.BufferContainer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._verticeBuffer=null,this._normalBuffer=null}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.getVertice=function(e){var n=this.geometryData[t.BufferDataTable.getGeometryDataName(e)];return this.hasData(n)?(this.createBufferOnlyOnce("_verticeBuffer",t.ArrayBuffer),this._verticeBuffer.resetData(new Float32Array(n),3,t.EBufferType.FLOAT),this._verticeBuffer):null},n.prototype.getNormal=function(e){var n=this.geometryData[t.BufferDataTable.getGeometryDataName(e)];return this.hasData(n)?(this.createBufferOnlyOnce("_normalBuffer",t.ArrayBuffer),this._normalBuffer.resetData(new Float32Array(n),3,t.EBufferType.FLOAT),this._normalBuffer):null},__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],n.prototype,"getVertice",null),__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],n.prototype,"getNormal",null),n}(t.BufferContainer);t.CommonBufferContainer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(t,n){e.call(this,t),this._animation=null,this._isCacheChangeFlag={},this._isCacheChangeInLastLoop={},this._currentVerticeBuffer=null,this._nextVerticeBuffer=null,this._currentNormalBuffer=null,this._nextNormalBuffer=null,this._animation=n}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n},n.prototype.getVertice=function(t){return this._getMorphData(t,this.geometryData.morphTargets)},n.prototype.getNormal=function(t){return this._getMorphData(t,this.geometryData.morphNormals)},n.prototype._getMorphData=function(e,n){var r=null,o=null,i=null;if(this._isNotPlayAnimation())return this._getStaticData(e);if(0===n.getCount())return null;if(o=n.getChild(this._animation.currentAnimName),wdCb.Log.error(!o,wdCb.Log.info.FUNC_SHOULD('"'+this._animation.currentAnimName+'" animation',"contain frame data")),r=this.container.getChild(e))if(this._animation.isFrameChange&&(this._isCacheChangeInLastLoop[e]||this._isCacheNotChange(e))){var a=r[0],s=r[1],c=null,u=null;c=s,u=a.resetData(new Float32Array(o.getChild(this._animation.nextFrame))),i=[c,u],this.container.addChild(e,i),this._isCacheChangeFlag[e]=!0,this._isCacheChangeInLastLoop[e]=!0}else this._isCacheChangeFlag[e]=!1,this._isCacheChangeInLastLoop[e]=!1,i=r;else{var a=this._getCurrentBuffer(e),s=this._getNextBuffer(e);a.resetData(new Float32Array(o.getChild(this._animation.currentFrame)),3,t.EBufferType.FLOAT),s.resetData(new Float32Array(o.getChild(this._animation.nextFrame)),3,t.EBufferType.FLOAT),i=[a,s],this.container.addChild(e,i),this._isCacheChangeInLastLoop[e]=!1}return i},n.prototype._getCurrentBuffer=function(e){return e===t.EBufferDataType.VERTICE?(this.createBufferOnlyOnce("_currentVerticeBuffer",t.ArrayBuffer),
this._currentVerticeBuffer):(this.createBufferOnlyOnce("_currentNormalBuffer",t.ArrayBuffer),this._currentNormalBuffer)},n.prototype._getNextBuffer=function(e){return e===t.EBufferDataType.VERTICE?(this.createBufferOnlyOnce("_nextVerticeBuffer",t.ArrayBuffer),this._nextVerticeBuffer):(this.createBufferOnlyOnce("_nextNormalBuffer",t.ArrayBuffer),this._nextNormalBuffer)},n.prototype._isCacheNotChange=function(t){return!this._isCacheChangeFlag[t]},n.prototype._isNotPlayAnimation=function(){return null===this._animation.currentAnimName},n.prototype._getStaticData=function(e){var n=null,r=null;switch(e){case t.EBufferDataType.VERTICE:n=this.geometryData.vertices;break;case t.EBufferDataType.NORMAL:n=this.geometryData.normals;break;default:t.Log.error(!0,t.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))}return this.hasData(n)?(this._animation.interpolation=0,r=[this._getCurrentBuffer(e).resetData(new Float32Array(n),3,t.EBufferType.FLOAT),this._getNextBuffer(e).resetData(new Float32Array(n),3,t.EBufferType.FLOAT)]):null},n.prototype._getStaticDataCacheData=function(t){return"static_"+t},__decorate([t.require(function(e){t.assert(this.geometryData.morphTargets&&this.geometryData.morphTargets.getCount()>0,t.Log.info.FUNC_SHOULD("set morphTargets"))})],n.prototype,"getVertice",null),__decorate([t.require(function(e){t.assert(this.geometryData.morphTargets&&this.geometryData.morphTargets.getCount()>0,t.Log.info.FUNC_SHOULD("set morphTargets"))})],n.prototype,"getNormal",null),__decorate([t.require(function(e){t.assert(e===t.EBufferDataType.VERTICE||e===t.EBufferDataType.NORMAL,t.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))})],n.prototype,"_getCurrentBuffer",null),__decorate([t.require(function(e){t.assert(e===t.EBufferDataType.VERTICE||e===t.EBufferDataType.NORMAL,t.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))})],n.prototype,"_getNextBuffer",null),__decorate([t.cache(function(t){return this.container.hasChild(this._getStaticDataCacheData(t))},function(t){return this.container.getChild(this._getStaticDataCacheData(t))},function(t,e){this.container.addChild(this._getStaticDataCacheData(e),t)})],n.prototype,"_getStaticData",null),n}(t.BufferContainer);t.MorphBufferContainer=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this._worldToCameraMatrix=null,this._near=null,this._far=null,this.pMatrix=t.Matrix4.create(),this.entityObject=null,this.dirty=!1}return Object.defineProperty(e.prototype,"cameraToWorldMatrix",{get:function(){return this.entityObject.transform.localToWorldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"worldToCameraMatrix",{get:function(){return this._worldToCameraMatrix?this._worldToCameraMatrix:this.cameraToWorldMatrix.copy().invert()},set:function(t){this._worldToCameraMatrix=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"near",{get:function(){return this._near},set:function(t){this._near=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"far",{get:function(){return this._far},set:function(t){this._far=t,this.dirty=!0},enumerable:!0,configurable:!0}),e.prototype.init=function(){this.dirty&&(this.updateProjectionMatrix(),this.dirty=!1)},e.prototype.dispose=function(){},e.prototype.update=function(t){this.dirty&&(this.updateProjectionMatrix(),this.dirty=!1)},e.prototype.getInvViewProjMat=function(){return this.pMatrix.copy().multiply(this.worldToCameraMatrix).invert()},__decorate([t.requireGetter(function(){t.assert(this.entityObject,t.Log.info.FUNC_MUST_DEFINE("entityObject"))})],e.prototype,"cameraToWorldMatrix",null),__decorate([t.virtual],e.prototype,"init",null),__decorate([t.virtual],e.prototype,"dispose",null),e}();t.Camera=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._left=null,this._right=null,this._bottom=null,this._top=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"left",{get:function(){return this._left},set:function(t){this._left=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"right",{get:function(){return this._right},set:function(t){this._right=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bottom",{get:function(){return this._bottom},set:function(t){this._bottom=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"top",{get:function(){return this._top},set:function(t){this._top=t,this.dirty=!0},enumerable:!0,configurable:!0}),n.prototype.convertScreenToWorld=function(e,n,r){var o=t.DeviceManager.getInstance(),i=o.view.width,a=o.view.height,s=t.Vector3.create(2*e/i-1,(a-n)/a*2-1,(r-this.far)/(this.far-this.near)*2+1);return this.getInvViewProjMat().multiplyPoint(s)},n.prototype.updateProjectionMatrix=function(){this.pMatrix.setOrtho(this._left,this._right,this._bottom,this._top,this.near,this.far)},n}(t.Camera);t.OrthographicCamera=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._fovy=null,this._aspect=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"fovy",{get:function(){return this._fovy},set:function(t){this._fovy=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"aspect",{get:function(){return this._aspect},set:function(t){this._aspect=t,this.dirty=!0},enumerable:!0,configurable:!0}),n.prototype.zoomIn=function(t,e){void 0===e&&(e=1),this.fovy=Math.max(this.fovy-t,e)},n.prototype.zoomOut=function(t,e){void 0===e&&(e=179),this.fovy=Math.min(this.fovy+t,e)},n.prototype.convertScreenToWorld=function(e,n,r){var o=t.DeviceManager.getInstance(),i=o.view.width,a=o.view.height,s=t.Vector3.create(2*e/i-1,1-2*n/a,1),c=this.getInvViewProjMat(),u=null,l=null;return u=c.multiplyPoint(s),l=s.x*c.values[3]+s.y*c.values[7]+s.z*c.values[11]+c.values[15],u.scale(1/l),t.Vector3.create().lerp(this.entityObject.transform.position,u,r/this.far)},n.prototype.updateProjectionMatrix=function(){this.pMatrix.setPerspective(this._fovy,this._aspect,this.near,this.far)},n}(t.Camera);t.PerspectiveCamera=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(t){e.call(this),this.camera=null,this._worldToCameraMatrixCache=null,this._clearCacheSubscription=null,this.camera=t}return __extends(n,e),Object.defineProperty(n.prototype,"cameraToWorldMatrix",{get:function(){return this.camera.cameraToWorldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"worldToCameraMatrix",{get:function(){return this._getWorldToCameraMatrix()},set:function(t){this.camera.worldToCameraMatrix=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pMatrix",{get:function(){return this.camera.pMatrix},set:function(t){this.camera.pMatrix=t},enumerable:!0,configurable:!0}),n.prototype.init=function(){var e=this;this.camera.entityObject=this.entityObject,this.camera.init(),this._clearCacheSubscription=wdFrp.fromArray([t.EventManager.fromEvent(t.EEngineEvent.ENDLOOP),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_TRANSLATE),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_ROTATE),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_SCALE)]).mergeAll().subscribe(function(){e._clearCache()})},n.prototype.update=function(t){this.camera.update(t)},n.prototype.dispose=function(){this.camera.dispose(),this._clearCacheSubscription&&this._clearCacheSubscription.dispose()},n.prototype.isIntersectWithRay=function(e,n,r){var o=null;return e.hasComponent(t.Collider)?(o=e.getComponent(t.Collider).shape,o.isIntersectWithRay(this.createRay(n,r))):!1},n.prototype.createRay=function(e,n){var r=this.convertScreenToWorld(e,n,this.camera.near),o=this.convertScreenToWorld(e,n,this.camera.far);return t.Ray.create(r,o.sub(r))},n.prototype.convertScreenToWorld=function(t,e,n){return this.camera.convertScreenToWorld(t,e,n)},n.prototype.getPlanes=function(){for(var e=[],n=this.worldToCameraMatrix.applyMatrix(this.pMatrix,!0),r=0;6>r;r++)e.push(t.Plane.create(0,0,0,0));return this._setPlanes(n,e),e},n.prototype._setPlanes=function(t,e){e[0].normal.x=t.values[3]+t.values[2],e[0].normal.y=t.values[7]+t.values[6],e[0].normal.z=t.values[11]+t.values[10],e[0].d=t.values[15]+t.values[14],e[0].normalize(),e[1].normal.x=t.values[3]-t.values[2],e[1].normal.y=t.values[7]-t.values[6],e[1].normal.z=t.values[11]-t.values[10],e[1].d=t.values[15]-t.values[14],e[1].normalize(),e[2].normal.x=t.values[3]+t.values[0],e[2].normal.y=t.values[7]+t.values[4],e[2].normal.z=t.values[11]+t.values[8],e[2].d=t.values[15]+t.values[12],e[2].normalize(),e[3].normal.x=t.values[3]-t.values[0],e[3].normal.y=t.values[7]-t.values[4],e[3].normal.z=t.values[11]-t.values[8],e[3].d=t.values[15]-t.values[12],e[3].normalize(),e[4].normal.x=t.values[3]-t.values[1],e[4].normal.y=t.values[7]-t.values[5],e[4].normal.z=t.values[11]-t.values[9],e[4].d=t.values[15]-t.values[13],e[4].normalize(),e[5].normal.x=t.values[3]+t.values[1],e[5].normal.y=t.values[7]+t.values[5],e[5].normal.z=t.values[11]+t.values[9],e[5].d=t.values[15]+t.values[13],e[5].normalize()},n.prototype._clearCache=function(){this._worldToCameraMatrixCache=null},n.prototype._getWorldToCameraMatrix=function(){return this.camera.worldToCameraMatrix},__decorate([t.cacheGetter(function(){return null!==this._worldToCameraMatrixCache},function(){return this._worldToCameraMatrixCache},function(t){this._worldToCameraMatrixCache=t})],n.prototype,"worldToCameraMatrix",null),n}(t.Component);t.CameraController=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e}(t.CameraController);t.BasicCameraController=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(n){e.call(this,n),this._control=null,n instanceof t.PerspectiveCamera?this._control=t.FlyPerspectiveCameraControl.create(n):this._control=t.FlyOrthographicCameraControl.create(n)}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.init=function(){e.prototype.init.call(this),this._control.init(this.entityObject)},n.prototype.update=function(t){e.prototype.update.call(this,t),this._control.update(t)},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._control.dispose()},n}(t.CameraController);t.FlyCameraController=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this.moveSpeed=1.2,this.rotateSpeed=100,this.cameraComponent=null,this._rotateX=0,this._rotateY=0,this._isRotate=!1,this._mouseDragSubscription=null,this._keydownSubscription=null,this._gameObject=null,this.cameraComponent=t}return e.prototype.init=function(t){var e=t.transform.eulerAngles;this._rotateX=e.x,this._rotateY=e.y,this._gameObject=t,this._bindCanvasEvent()},e.prototype.update=function(e){this._isRotate&&(this._isRotate=!1,this._gameObject.transform.eulerAngles=t.Vector3.create(this._rotateX,this._rotateY,0))},e.prototype.dispose=function(){this._removeEvent()},e.prototype._move=function(e){var n=this.moveSpeed,r=this._gameObject,o=e.keyState;o.a||o.left?r.transform.translateLocal(t.Vector3.create(-n,0,0)):o.d||o.right?r.transform.translateLocal(t.Vector3.create(n,0,0)):o.w||o.up?r.transform.translateLocal(t.Vector3.create(0,0,-n)):(o.s||o.down)&&r.transform.translateLocal(t.Vector3.create(0,0,n))},e.prototype._bindCanvasEvent=function(){var e=this,n=this.rotateSpeed,r=t.EventManager.fromEvent(t.Director.getInstance().scene,t.EEngineEvent.MOUSE_DRAG),o=t.EventManager.fromEvent(t.EEventName.KEYDOWN),i=t.Director.getInstance().view;this._mouseDragSubscription=r.map(function(t){var r=t.userData.movementDelta,o=null,a=null,s=n/i.height;return o=s*r.x,a=s*r.y,e._isRotate=!0,{dx:o,dy:a}}).subscribe(function(t){e._rotateY-=t.dx,e._rotateX-=t.dy}),this._keydownSubscription=o.subscribe(function(t){e._move(t),e.zoom(t)})},e.prototype._removeEvent=function(){this._mouseDragSubscription.dispose(),this._keydownSubscription.dispose()},e}();t.FlyCameraControl=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.zoomSpeed=10}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.zoom=function(t){var e=this.zoomSpeed,n=t.keyState;n.g?this.cameraComponent.zoomIn(e):n.h&&this.cameraComponent.zoomOut(e)},e}(t.FlyCameraControl);t.FlyPerspectiveCameraControl=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.zoom=function(t){},e}(t.FlyCameraControl);t.FlyOrthographicCameraControl=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.moveSpeedX=1,this.moveSpeedY=1,this.rotateSpeed=1,this.wheelSpeed=1,this.distance=10,this.phi=Math.PI/2,this.theta=Math.PI/2,this.target=t.Vector3.create(0,0,0),this.thetaMargin=.05,this.minDistance=.05,this._isChange=!0,this._mouseDragSubscription=null,this._mouseWheelSubscription=null,this._keydownSubscription=null}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.init=function(){e.prototype.init.call(this),this._bindCanvasEvent()},n.prototype.update=function(n){var r=null,o=null,i=null;e.prototype.update.call(this,n),this._isChange&&(this._isChange=!1,r=this.distance*Math.cos(this.phi)*Math.sin(this.theta)+this.target.x,i=this.distance*Math.sin(this.phi)*Math.sin(this.theta)+this.target.z,o=this.distance*Math.cos(this.theta)+this.target.y,this.entityObject.transform.position=t.Vector3.create(r,o,i),this.entityObject.transform.lookAt(this.target))},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._removeEvent()},n.prototype._bindCanvasEvent=function(){var e=this,n=t.Director.getInstance().scene,r=t.EventManager.fromEvent(n,t.EEngineEvent.MOUSE_WHEEL),o=t.EventManager.fromEvent(n,t.EEngineEvent.MOUSE_DRAG),i=t.EventManager.fromEvent(t.EEventName.KEYDOWN);this._mouseDragSubscription=o.subscribe(function(t){e._changeOrbit(t.userData)}),this._mouseWheelSubscription=r.subscribe(function(t){var n=t.userData;n.preventDefault(),e._changeDistance(n)}),this._keydownSubscription=i.subscribe(function(t){e._changeTarget(t)})},n.prototype._changeOrbit=function(t){var e=t.movementDelta;this._isChange=!0,this.phi+=e.x/(100/this.rotateSpeed),this.theta-=e.y/(100/this.rotateSpeed),this._contrainTheta()},n.prototype._changeTarget=function(e){var n=this.moveSpeedX,r=this.moveSpeedY,o=null,i=null,a=e.keyState,s=this.entityObject.transform;this._isChange=!0,a.a||a.left?o=-n:a.d||a.right?o=n:a.w||a.up?i=r:(a.s||a.down)&&(i=-r),this.target.add(t.Vector3.create(s.right.x*o,0,s.right.z*o)),this.target.add(t.Vector3.create(s.up.x*i,s.up.y*i,0))},n.prototype._changeDistance=function(t){this._isChange=!0,this.distance-=this.wheelSpeed*t.wheel,this._contrainDistance()},n.prototype._contrainDistance=function(){this.distance=t.MathUtils.bigThan(this.distance,this.minDistance)},n.prototype._contrainTheta=function(){this.theta=t.MathUtils.clamp(this.theta,this.thetaMargin,Math.PI-this.thetaMargin)},n.prototype._removeEvent=function(){this._mouseDragSubscription.dispose(),this._mouseWheelSubscription.dispose(),this._keydownSubscription.dispose()},n}(t.CameraController);t.ArcballCameraController=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.p_target=null,this.isFinish=!1}return __extends(n,e),Object.defineProperty(n.prototype,"isStart",{get:function(){return!this.isStop},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isStop",{get:function(){return t.Log.error(!0,t.Log.info.ABSTRACT_ATTRIBUTE)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isPause",{get:function(){return t.Log.error(!0,t.Log.info.ABSTRACT_ATTRIBUTE)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"target",{get:function(){return this.p_target},set:function(t){this.p_target=t},enumerable:!0,configurable:!0}),n.prototype.reset=function(){this.isFinish=!1},n.prototype.addToObject=function(t){e.prototype.addToObject.call(this,t),this.target=t,t.actionManager.addChild(this)},n.prototype.removeFromObject=function(t){e.prototype.removeFromObject.call(this,t),t.actionManager.removeChild(this)},n.prototype.init=function(){this.start()},n.prototype.finish=function(){this.isFinish=!0,this.stop()},n}(t.Component);t.Action=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"isStop",{get:function(){return!1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isPause",{get:function(){return!1},enumerable:!0,configurable:!0}),e.prototype.start=function(){},e.prototype.stop=function(){},e.prototype.pause=function(){},e.prototype.resume=function(){},e}(t.Action);t.ActionInstant=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(n,r,o){e.call(this),this._context=null,this._callFunc=null,this._dataArr=null,this._context=r||t.root,this._callFunc=n,this._dataArr=wdCb.Collection.create(o)}return __extends(n,e),n.create=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var o=Array.prototype.slice.call(arguments,2),i=new this(t,e,o);return i},n.prototype.reverse=function(){return this},n.prototype.update=function(t){this._callFunc&&this._callFunc.call(this._context,this.p_target,this._dataArr),this.finish()},n.prototype.copy=function(){return new n(this._context,this._callFunc,this._dataArr.copy(!0).getChildren())},n}(t.ActionInstant);t.CallFunc=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.elapsed=null,this.duration=null,this._isStop=!0,this._isPause=!1,this._timeController=t.CommonTimeController.create()}return __extends(n,e),Object.defineProperty(n.prototype,"isStop",{get:function(){return this._isStop},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isPause",{get:function(){return this._isPause},enumerable:!0,configurable:!0}),n.prototype.update=function(t){t<this._timeController.startTime||(this.elapsed=this._convertToRatio(this._timeController.computeElapseTime(t)),this.updateBody(t),1===this.elapsed&&this.finish())},n.prototype.start=function(){this._isStop=!1,this._timeController.start()},n.prototype.stop=function(){this._isStop=!0,this._timeController.stop()},n.prototype.reset=function(){e.prototype.reset.call(this),this._isStop=!0},n.prototype.pause=function(){this._isPause=!0,this._timeController.pause()},n.prototype.resume=function(){this._isPause=!1,this._timeController.resume()},n.prototype.updateBody=function(t){},n.prototype._convertToRatio=function(t){var e=t/this.duration;return e>1?1:e},__decorate([t.virtual],n.prototype,"updateBody",null),n}(t.Action);t.ActionInterval=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"target",{set:function(t){this.p_target=t,this.getInnerActions().forEach(function(e){e.target=t})},enumerable:!0,configurable:!0}),e.prototype.init=function(){t.prototype.init.call(this),this.iterate("init")},e.prototype.reverse=function(){return this.iterate("reverse"),this},e.prototype.reset=function(){return t.prototype.reset.call(this),this.iterate("reset"),this},e.prototype.iterate=function(t,e){this.getInnerActions().forEach(function(n){n[t].apply(n,e)})},e}(t.ActionInterval);t.Control=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(t){e.call(this),this._actions=wdCb.Collection.create(),this._currentAction=null,this._actionIndex=0,this._actions.addChildren(t)}return __extends(n,e),n.create=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return t.Log.assert(e.length>=2,"Sequence should has two actions at least"),r=new this(e),r.initWhenCreate(),r},n.prototype.initWhenCreate=function(){this._currentAction=this._actions.getChild(0)},n.prototype.update=function(t){return this._actionIndex===this._actions.getCount()?void this.finish():(this._currentAction=this._actions.getChild(this._actionIndex),this._currentAction.isFinish?void this._startNextActionAndJudgeFinish():(this._currentAction.update(t),this._currentAction.isFinish&&this._startNextActionAndJudgeFinish(),null))},n.prototype.copy=function(){var t=[];return this._actions.forEach(function(e){t.push(e.copy())}),n.create.apply(n,t)},n.prototype.reset=function(){return e.prototype.reset.call(this),this._actionIndex=0,this._currentAction=this._actions.getChild(this._actionIndex),this},n.prototype.start=function(){return e.prototype.start.call(this),this._currentAction.start(),this},n.prototype.stop=function(){return e.prototype.stop.call(this),this._currentAction.stop(),this},n.prototype.pause=function(){return e.prototype.pause.call(this),this._currentAction.pause(),this},n.prototype.resume=function(){return e.prototype.resume.call(this),this._currentAction.resume(),this},n.prototype.reverse=function(){return this._actions=this._actions.reverse(),e.prototype.reverse.call(this),this},n.prototype.getInnerActions=function(){return this._actions},n.prototype._startNextActionAndJudgeFinish=function(){return this._actionIndex++,this._actionIndex===this._actions.getCount()?void this.finish():void this._actions.getChild(this._actionIndex).start()},n}(t.Control);t.Sequence=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(t){e.call(this),this._actions=wdCb.Collection.create(),this._actions.addChildren(t)}return __extends(n,e),n.create=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return t.Log.assert(e.length>=2,"Sequence should has two actions at least"),r=new this(e)},n.prototype.update=function(t){return this._isFinish()?void this.finish():(this.iterate("update",[t]),void(this._isFinish()&&this.finish()))},n.prototype.start=function(){return e.prototype.start.call(this),this.iterate("start"),this},n.prototype.stop=function(){return e.prototype.stop.call(this),this.iterate("stop"),this},n.prototype.pause=function(){return e.prototype.pause.call(this),this.iterate("pause"),this},n.prototype.resume=function(){return e.prototype.resume.call(this),this.iterate("resume"),this},n.prototype.copy=function(){var t=[];return this._actions.forEach(function(e){t.push(e.copy())}),n.create.apply(n,t)},n.prototype.reset=function(){return e.prototype.reset.call(this),this.iterate("reset"),this},n.prototype.reverse=function(){return this._actions=this._actions.reverse(),e.prototype.reverse.call(this),this},n.prototype.getInnerActions=function(){return this._actions},n.prototype.iterate=function(t,e){this._actions.forEach(function(n){n[t].apply(n,e)})},n.prototype._isFinish=function(){var t=!0;return this._actions.forEach(function(e){return e.isFinish?void 0:(t=!1,wdCb.$BREAK)}),t},n}(t.Control);t.Spawn=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(e){t.call(this),this.duration=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.reverse=function(){return this},e.prototype.copy=function(){return e.create(this.duration)},e}(t.ActionInterval);t.DelayTime=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(e,n){t.call(this),this._innerAction=null,this._originTimes=null,this._times=null,this._innerAction=e,this._times=n}return __extends(e,t),e.create=function(t,e){var n=new this(t,e);return n.initWhenCreate(),n},e.prototype.initWhenCreate=function(){this._originTimes=this._times},e.prototype.update=function(t){if(0===this._times)return void this.finish();if(this._innerAction.update(t),this._innerAction.isFinish){if(this._times-=1,0!==this._times)return this._innerAction.reset(),void this._innerAction.start();this.finish()}},e.prototype.copy=function(){return e.create(this._innerAction.copy(),this._times)},e.prototype.reset=function(){return t.prototype.reset.call(this),this._times=this._originTimes,this},e.prototype.start=function(){t.prototype.start.call(this),this._innerAction.start()},e.prototype.stop=function(){t.prototype.stop.call(this),this._innerAction.stop()},e.prototype.pause=function(){t.prototype.pause.call(this),this._innerAction.pause()},e.prototype.resume=function(){t.prototype.resume.call(this),this._innerAction.resume()},e.prototype.getInnerActions=function(){return wdCb.Collection.create([this._innerAction])},e}(t.Control);t.Repeat=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(e){t.call(this),this._innerAction=null,this._innerAction=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.update=function(t){this._innerAction.update(t),this._innerAction.isFinish&&(this._innerAction.reset(),this._innerAction.start())},e.prototype.copy=function(){return e.create(this._innerAction.copy())},e.prototype.start=function(){t.prototype.start.call(this),this._innerAction.start()},e.prototype.stop=function(){t.prototype.stop.call(this),this._innerAction.stop()},e.prototype.pause=function(){t.prototype.pause.call(this),this._innerAction.pause()},e.prototype.resume=function(){t.prototype.resume.call(this),this._innerAction.resume()},e.prototype.getInnerActions=function(){return wdCb.Collection.create([this._innerAction])},e}(t.Control);t.RepeatForever=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._object=null,this._valuesStart=wdCb.Hash.create(),this._valuesEnd=wdCb.Hash.create(),this._easingFunction=n.Easing.Linear.None,this._interpolationFunction=n.Interpolation.Linear,this._onStartCallback=null,this._onStartCallbackFired=!1,this._onUpdateCallback=null,this._onFinishCallback=null,this._onStopCallback=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.updateBody=function(e){var n=this,r=null;return this._onStartCallbackFired===!1&&(null!==this._onStartCallback&&this._onStartCallback.call(this._object.getChildren()),this._onStartCallbackFired=!0),r=this._easingFunction(this.elapsed),this._valuesEnd.forEach(function(e,o){var i=n._valuesStart.getChild(o),a=e;a instanceof Array?n._object.setValue(o,n._interpolationFunction(a,r)):(t.JudgeUtils.isString(a)&&(a=i+t.root.parseFloat(a,10)),t.JudgeUtils.isNumber(a)&&n._object.setValue(o,i+(a-i)*r))}),null!==this._onUpdateCallback&&this._onUpdateCallback.call(this._object.getChildren(),r),!0},n.prototype.from=function(e){var n=this;return this._object=wdCb.Hash.create(e),this._object.forEach(function(e,r){n._valuesStart.addChild(r,t.root.parseFloat(e,10))}),this},n.prototype.to=function(t,e){return void 0===e&&(e=1e3),this.duration=e,this._valuesEnd=wdCb.Hash.create(t),this},n.prototype.init=function(){var t=this;e.prototype.init.call(this),this._valuesEnd.forEach(function(e,n){if(e instanceof Array){if(0===e.length)return;t._valuesEnd.setValue(n,[t._object.getChild(n)].concat(t._valuesEnd.getChild(n)))}t._valuesStart.setValue(n,t._object.getChild(n)),t._valuesStart.getChild(n)instanceof Array==!1&&t._valuesStart.setValue(n,1*t._valuesStart.getChild(n));
})},n.prototype.start=function(){return e.prototype.start.call(this),this._onStartCallbackFired=!1,this},n.prototype.stop=function(){return e.prototype.stop.call(this),null!==this._onStopCallback&&this._onStopCallback.call(this._object.getChildren()),this},n.prototype.copy=function(){return n.create().from(this._valuesStart.getChildren()).to(this._valuesEnd.getChildren(),this.duration).easing(this._easingFunction).interpolation(this._interpolationFunction).onStart(this._onStartCallback).onStop(this._onStopCallback).onFinish(this._onFinishCallback).onUpdate(this._onUpdateCallback)},n.prototype.reverse=function(){var t=this._valuesStart;this._valuesStart=this._valuesEnd,this._valuesEnd=t},n.prototype.easing=function(t){return this._easingFunction=t,this},n.prototype.interpolation=function(t){return this._interpolationFunction=t,this},n.prototype.onUpdate=function(t){return this._onUpdateCallback=t,this},n.prototype.onFinish=function(t){return this._onFinishCallback=t,this},n.prototype.onStart=function(t){return this._onStartCallback=t,this},n.prototype.onStop=function(t){return this._onStopCallback=t,this},n.prototype.finish=function(){e.prototype.finish.call(this),null!==this._onFinishCallback&&this._onFinishCallback.call(this._object.getChildren())},n.Easing={Linear:{None:function(t){return t}},Quadratic:{In:function(t){return t*t},Out:function(t){return t*(2-t)},InOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}},Cubic:{In:function(t){return t*t*t},Out:function(t){return--t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}},Quartic:{In:function(t){return t*t*t*t},Out:function(t){return 1- --t*t*t*t},InOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}},Quintic:{In:function(t){return t*t*t*t*t},Out:function(t){return--t*t*t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}},Sinusoidal:{In:function(t){return 1-Math.cos(t*Math.PI/2)},Out:function(t){return Math.sin(t*Math.PI/2)},InOut:function(t){return.5*(1-Math.cos(Math.PI*t))}},Exponential:{In:function(t){return 0===t?0:Math.pow(1024,t-1)},Out:function(t){return 1===t?1:1-Math.pow(2,-10*t)},InOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(-Math.pow(2,-10*(t-1))+2)}},Circular:{In:function(t){return 1-Math.sqrt(1-t*t)},Out:function(t){return Math.sqrt(1- --t*t)},InOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}},Elastic:{In:function(t){var e,n=.1,r=.4;return 0===t?0:1===t?1:(!n||1>n?(n=1,e=r/4):e=r*Math.asin(1/n)/(2*Math.PI),-(n*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/r)))},Out:function(t){var e,n=.1,r=.4;return 0===t?0:1===t?1:(!n||1>n?(n=1,e=r/4):e=r*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*t)*Math.sin((t-e)*(2*Math.PI)/r)+1)},InOut:function(t){var e,n=.1,r=.4;return 0===t?0:1===t?1:(!n||1>n?(n=1,e=r/4):e=r*Math.asin(1/n)/(2*Math.PI),(t*=2)<1?-.5*(n*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/r)):n*Math.pow(2,-10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/r)*.5+1)}},Back:{In:function(t){var e=1.70158;return t*t*((e+1)*t-e)},Out:function(t){var e=1.70158;return--t*t*((e+1)*t+e)+1},InOut:function(t){var e=2.5949095;return(t*=2)<1?.5*(t*t*((e+1)*t-e)):.5*((t-=2)*t*((e+1)*t+e)+2)}},Bounce:{In:function(t){return 1-n.Easing.Bounce.Out(1-t)},Out:function(t){return 1/2.75>t?7.5625*t*t:2/2.75>t?7.5625*(t-=1.5/2.75)*t+.75:2.5/2.75>t?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},InOut:function(t){return.5>t?.5*n.Easing.Bounce.In(2*t):.5*n.Easing.Bounce.Out(2*t-1)+.5}}},n.Interpolation={Linear:function(t,e){var r=t.length-1,o=r*e,i=Math.floor(o),a=n.Interpolation.Utils.Linear;return 0>e?a(t[0],t[1],o):e>1?a(t[r],t[r-1],r-o):a(t[i],t[i+1>r?r:i+1],o-i)},Bezier:function(t,e){var r,o=0,i=t.length-1,a=Math.pow,s=n.Interpolation.Utils.Bernstein;for(r=0;i>=r;r++)o+=a(1-e,i-r)*a(e,r)*t[r]*s(i,r);return o},CatmullRom:function(t,e){var r=t.length-1,o=r*e,i=Math.floor(o),a=n.Interpolation.Utils.CatmullRom;return t[0]===t[r]?(0>e&&(i=Math.floor(o=r*(1+e))),a(t[(i-1+r)%r],t[i],t[(i+1)%r],t[(i+2)%r],o-i)):0>e?t[0]-(a(t[0],t[0],t[1],t[1],-o)-t[0]):e>1?t[r]-(a(t[r],t[r],t[r-1],t[r-1],o-r)-t[r]):a(t[i?i-1:0],t[i],t[i+1>r?r:i+1],t[i+2>r?r:i+2],o-i)},Utils:{Linear:function(t,e,n){return(e-t)*n+t},Bernstein:function(t,e){var r=n.Interpolation.Utils.Factorial;return r(t)/r(e)/r(t-e)},Factorial:function(){var t=[1];return function(e){var n,r=1;if(t[e])return t[e];for(n=e;n>1;n--)r*=n;return t[e]=r}}(),CatmullRom:function(t,e,n,r,o){var i=.5*(n-t),a=.5*(r-e),s=o*o,c=o*s;return(2*e-2*n+i+a)*c+(-3*e+3*n-2*i-a)*s+i*o+e}}},n}(t.ActionInterval);t.Tween=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.Component);t.RendererComponent=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.render=function(t,e,n){t.addCommand(this.createDrawCommand(t,e,n))},n.prototype.createDrawCommand=function(e,n,r){var o=e.createQuadCommand(),i=r.getComponent(t.CameraController),a=n.material,s=this.entityObject.transform.position;return o.buffers=n.buffers,o.animation=n.entityObject.getComponent(t.Animation),o.drawMode=n.drawMode,o.mMatrix=this.entityObject.transform.localToWorldMatrix,o.vMatrix=i.worldToCameraMatrix,o.pMatrix=i.pMatrix,o.material=a,o.z=s.z,o.blend=a.blend,o},__decorate([t.require(function(e,n,r){var o=r.getComponent(t.CameraController);t.assert(!!o&&!!o.camera,t.Log.info.FUNC_MUST("camera","add Camera Component")),t.assert(!!n,t.Log.info.FUNC_MUST("Mesh","add geometry component"))})],n.prototype,"createDrawCommand",null),n}(t.RendererComponent);t.MeshRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.render=function(t,e,n){t.skyboxCommand=this.createDrawCommand(t,e,n)},e}(t.MeshRenderer);t.SkyboxRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._zIndex=1,this.dirtyDuringCurrentLoop=!1,this._dirty=!0,this.context=null,this.isClearCanvas=!1,this.state=t.EUIRendererState.NORMAL,this.canvas=null,this._referenceList=wdCb.Collection.create()}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"zIndex",{get:function(){return this._zIndex},set:function(t){t!==this._zIndex&&(this._zIndex=t,this.canvas&&wdCb.DomQuery.create(this.canvas).css("zIndex",t))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"dirty",{get:function(){return this._dirty},set:function(t){t&&(this._dirty=!0,this.dirtyDuringCurrentLoop=!0)},enumerable:!0,configurable:!0}),n.prototype.resetDirty=function(){this._dirty=!1},n.prototype.addToObject=function(t){this._referenceList.addChild(t),this.entityObject=t},n.prototype.removeFromObject=function(t){this._referenceList.removeChild(t),this._referenceList.getCount()>0||e.prototype.removeFromObject.call(this,t)},n.prototype.init=function(){},n.prototype.initWhenCreate=function(){this._createOverlayCanvas()},n.prototype.dispose=function(){this._referenceList.getCount()>0||wdCb.DomQuery.create(this.canvas).remove()},n.prototype.render=function(t,e,n){},n.prototype.clearCanvas=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.isClearCanvas=!0},n.prototype._createOverlayCanvas=function(){var e=null,n=null;this.canvas||(e=wdCb.DomQuery.create("<canvas></canvas>").prependTo("body"),n=t.DeviceManager.getInstance().view,e.css("position","absolute"),e.css("left",n.x+"px"),e.css("top",n.y+"px"),e.css("zIndex",this.zIndex),e.attr("width",n.width),e.attr("height",n.height),this.canvas=e.get(0),this.context=this.canvas.getContext("2d"))},__decorate([t.execOnlyOnce("_isInit")],n.prototype,"init",null),n}(t.RendererComponent);t.UIRenderer=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.NORMAL=0]="NORMAL",t[t.DIRTY=1]="DIRTY",t[t.NOT_DIRTY=2]="NOT_DIRTY"}(t.EUIRendererState||(t.EUIRendererState={}));t.EUIRendererState}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.Component);t.SpacePartition=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.maxDepth=2,this.maxNodeCapacity=64,this._root=null,this._selectionList=wdCb.Collection.create()}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.addToObject=function(t){e.prototype.addToObject.call(this,t)},n.prototype.build=function(){var e=this.getChildren(),n=0,r=this.maxNodeCapacity,o=this.maxDepth,i=function(e,n,a,s,c){for(var u=new t.Vector3((n.x-e.x)/2,(n.y-e.y)/2,(n.z-e.z)/2),l=0;2>l;l++)for(var h=0;2>h;h++)for(var p=0;2>p;p++){var f=e.copy().add(u.copy().scale(l,h,p)),d=e.copy().add(u.copy().scale(l+1,h+1,p+1)),_=t.OctreeNode.create(f,d,r,a+1,o);_.addEntityObjects(s),_.entityObjectCount>r&&o>a&&i(f,d,a+1,s,_),c.addNode(_)}};this._updateColliderForFirstCheck(e);var a=this._getWorldExtends(e),s=a.worldMin,c=a.worldMax;this._root=t.OctreeNode.create(s,c,r,n+1,o),i(s,c,n,e,this._root)},n.prototype.getRenderListByFrustumCull=function(){var e=t.Director.getInstance().scene.currentCamera.getComponent(t.CameraController).getPlanes();return this._visitRoot("findAndAddToRenderList",[e,this._selectionList])},n.prototype.getIntersectListWithRay=function(e){var n=e.locationInView;return this._visitRoot("findAndAddToIntersectList",[t.Director.getInstance().scene.currentCamera.getComponent(t.CameraController).createRay(n.x,n.y),this._selectionList])},n.prototype.getCollideObjects=function(t){return this._visitRoot("findAndAddToCollideList",[t,this._selectionList])},n.prototype.getChildren=function(){return this.entityObject.getChildren()},n.prototype._visitRoot=function(t,e){return this._selectionList.removeAllChildren(),this._root.nodeList.forEach(function(n){n[t].apply(n,e)}),this._selectionList=this._selectionList.removeRepeatItems(),this._selectionList},n.prototype._updateColliderForFirstCheck=function(e){var n=null,r=this;e.forEach(function(e){e.hasComponent(t.ColliderForFirstCheck)?n=e.getComponent(t.BoxColliderForFirstCheck):(n=r._createCollider(),e.addComponent(n),n.init()),n.update(null)})},n.prototype._getWorldExtends=function(e){var n=t.Vector3.create(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=t.Vector3.create(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),o=this;return e.forEach(function(e){var i=null,a=null,s=null,c=null;s=e.getComponent(t.BoxColliderForFirstCheck),c=s.shape,i=c.getMin(),a=c.getMax(),o._checkExtends(i,n,r),o._checkExtends(a,n,r)}),{worldMin:n,worldMax:r}},n.prototype._createCollider=function(){return t.BoxColliderForFirstCheck.create()},n.prototype._checkExtends=function(t,e,n){t.x<e.x&&(e.x=t.x),t.y<e.y&&(e.y=t.y),t.z<e.z&&(e.z=t.z),t.x>n.x&&(n.x=t.x),t.y>n.y&&(n.y=t.y),t.z>n.z&&(n.z=t.z)},__decorate([t.require(function(e){t.assert(e instanceof t.GameObject,t.Log.info.FUNC_SHOULD("Octree component","add to GameObject"))})],n.prototype,"addToObject",null),__decorate([t.require(function(){t.assert(!!t.Director.getInstance().scene.currentCamera.getComponent(t.CameraController),t.Log.info.FUNC_SHOULD("contain CameraController component"))})],n.prototype,"getRenderListByFrustumCull",null),__decorate([t.require(function(){t.assert(!!t.Director.getInstance().scene.currentCamera.getComponent(t.CameraController),t.Log.info.FUNC_SHOULD("contain CameraController component"))})],n.prototype,"getIntersectListWithRay",null),n}(t.SpacePartition);t.Octree=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(t,e,n,r,o){this.entityObjectList=wdCb.Collection.create(),this.nodeList=wdCb.Collection.create(),this._depth=null,this._maxDepth=null,this._capacity=null,this._minPoint=null,this._maxPoint=null,this._boundingVectors=null,this._capacity=n,this._depth=r,this._maxDepth=o,this._minPoint=t,this._maxPoint=e}return e.create=function(t,e,n,r,o){var i=new this(t,e,n,r,o);return i.initWhenCreate(),i},Object.defineProperty(e.prototype,"entityObjectCount",{get:function(){return this.entityObjectList.getCount()},enumerable:!0,configurable:!0}),e.prototype.initWhenCreate=function(){this._boundingVectors=t.BoundingRegionUtils.buildBoundingVectors(this._minPoint,this._maxPoint)},e.prototype.addEntityObjects=function(e){var n=this,r=this._minPoint,o=this._maxPoint;e.forEach(function(e){e.getComponent(t.BoxColliderForFirstCheck).shape.isIntersectWithBox(r,o)&&n.entityObjectList.addChild(e)})},e.prototype.addNode=function(t){this.nodeList.addChild(t)},e.prototype.findAndAddToRenderList=function(e,n){if(t.BoundingRegionUtils.isAABBIntersectFrustum(this._boundingVectors,e)){if(this._hasNode())return void this.nodeList.forEach(function(t){t.findAndAddToRenderList(e,n)});n.addChildren(this.entityObjectList.filter(function(t){return t.isVisible}))}},e.prototype.findAndAddToIntersectList=function(t,e){if(t.isIntersectWithAABB(this._minPoint,this._maxPoint)){if(this._hasNode())return void this.nodeList.forEach(function(n){n.findAndAddToIntersectList(t,e)});e.addChildren(this.entityObjectList)}},e.prototype.findAndAddToCollideList=function(t,e){if(t.isIntersectWithBox(this._minPoint,this._maxPoint)){if(this._hasNode())return void this.nodeList.forEach(function(n){n.findAndAddToCollideList(t,e)});e.addChildren(this.entityObjectList)}},e.prototype._hasNode=function(){return this.nodeList.getCount()>0},__decorate([t.require(function(e){e.forEach(function(e){t.assert(e instanceof t.GameObject,t.Log.info.FUNC_SHOULD("add gameObjects"))})})],e.prototype,"addEntityObjects",null),e}();t.OctreeNode=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.Component);t.ColliderForFirstCheck=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._collider=t.BoxCollider.create()}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"shape",{get:function(){return this._collider.shape},enumerable:!0,configurable:!0}),n.prototype.init=function(){this._collider.entityObject=this.entityObject,this._collider.init()},n.prototype.update=function(t){this._collider.update(t)},n}(t.ColliderForFirstCheck);t.BoxColliderForFirstCheck=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type=t.ABSTRACT_ATTRIBUTE,this.boundingRegion=null}return __extends(n,e),Object.defineProperty(n.prototype,"shape",{get:function(){return this.boundingRegion.shape},enumerable:!0,configurable:!0}),n.prototype.init=function(){this.boundingRegion=this.createBoundingRegion(),this.boundingRegion.init(),this.buildBoundingRegion()},n.prototype.update=function(t){this.boundingRegion.update()},n.prototype.updateShape=function(){this.boundingRegion.updateShape()},n.prototype.isIntersectWith=function(e){return e instanceof t.BoxCollider?this.boundingRegion.isIntersectWithBox(e.boundingRegion):e instanceof t.SphereCollider?this.boundingRegion.isIntersectWithSphere(e.boundingRegion):void t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT(this.type+" collider","intersect with "+e.type+" collider"))},n.prototype.isCollide=function(e){var r=null;return this._isSelf(e)||!e.hasComponent(n)?!1:(r=e.getComponent(n),e.hasComponent(t.RigidBody)&&r.updateShape(),this.isIntersectWith(r))},n.prototype._isSelf=function(e){return t.JudgeUtils.isSelf(this.entityObject,e)},__decorate([t.require(function(e){t.assert(e instanceof n,t.Log.info.FUNC_SHOULD("target","be collider"))})],n.prototype,"isIntersectWith",null),n}(t.Component);t.Collider=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.center=t.Vector3.create(0,0,0),this.halfExtents=null,this.type=t.EColliderType.BOX}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.createBoundingRegion=function(){return t.BoxBoundingRegion.create(this.entityObject)},n.prototype.buildBoundingRegion=function(){this.boundingRegion.build(this.center,this.halfExtents)},n}(t.Collider);t.BoxCollider=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.center=t.Vector3.create(0,0,0),this.radius=null,this.type=t.EColliderType.SPHERE}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.createBoundingRegion=function(){return t.SphereBoundingRegion.create(this.entityObject)},n.prototype.buildBoundingRegion=function(){this.boundingRegion.build(this.center,this.radius)},n}(t.Collider);t.SphereCollider=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(t){this.shape=null,this.entityObject=null,this.isUserSpecifyTheRegion=!1,this.originShape=null,this.debugObject=null,this.entityObject=t}return e.prototype.init=function(){this.shape=this.createShape()},e.prototype.build=function(e){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var o=Array.prototype.slice.call(arguments,0);this.isBuildUserSpecifyBoundingRegion.apply(this,o)?(this.isUserSpecifyTheRegion=!0,this.shape.setFromShapeParam.apply(this.shape,o)):this.shape.setFromPoints(t.ColliderUtils.getVertices(this.entityObject)),this.originShape=this.shape.copy(),t.DebugConfig.debugCollision&&(this.debugObject=this.buildDebugObjectFromShape(this.shape),t.Director.getInstance().scene.addChild(this.debugObject))},e.prototype.update=function(){this.isNotTransformed()||(t.DebugConfig.debugCollision?(this.updateShape(),this.updateDebugObjectFromShape(this.shape)):this.entityObject.hasComponent(t.RigidBody)||this.updateShape())},e.prototype.isIntersectWithSphere=function(t){return this.shape.isIntersectWithSphere(t.shape)},e.prototype.isIntersectWithBox=function(t){return this.shape.isIntersectWithBox(t.shape)},e.prototype.buildDebugObjectFromShape=function(e){var n=null,r=null,o=null,i=null;return n=t.BasicMaterial.create(),n.color=t.Color.create("rgb(255,0,0)"),r=t.CustomGeometry.create(),r.material=n,r.drawMode=t.EDrawMode.LINES,this.setDebugObjectGeometry(r,e),o=t.MeshRenderer.create(),i=t.GameObject.create(),i.addComponent(r),i.addComponent(o),i.transform.translate(e.center),i.name="debugBoundingRegion"+this.entityObject.uid,i.init(),i},__decorate([t.ensure(function(e,n){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];this.isBuildUserSpecifyBoundingRegion.apply(this,Array.prototype.slice.call(arguments,1))&&t.assert(this.shape.center.isEqual(n),t.Log.info.FUNC_SHOULD_NOT("transform shape when build"))})],e.prototype,"build",null),e}();t.BoundingRegion=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.updateShape=function(){var t=this.entityObject.transform;this.isUserSpecifyTheRegion?this.shape.setFromTranslationAndScale(this.originShape,t.localToWorldMatrix):t.isRotate?this.shape.setFromObject(this.entityObject):this.shape.setFromTranslationAndScale(this.originShape,t.localToWorldMatrix)},n.prototype.createShape=function(){return t.AABBShape.create()},n.prototype.updateDebugObjectFromShape=function(e){var n=this.debugObject.getComponent(t.CustomGeometry);this.setDebugObjectGeometry(n,e),this.debugObject.transform.position=e.center},n.prototype.setDebugObjectGeometry=function(t,e){var n=e.halfExtents,r=n.x,o=n.y,i=n.z;t.vertices=[-r,-o,-i,-r,-o,i,r,-o,i,r,-o,-i,-r,o,-i,-r,o,i,r,o,i,r,o,-i],t.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]},n.prototype.isBuildUserSpecifyBoundingRegion=function(t,e){return!!t&&!!e},n.prototype.isNotTransformed=function(){var t=this.entityObject.transform;return!t.isRotate&&!t.isTranslate&&!t.isScale},__decorate([t.require(function(e){t.assert(this.debugObject,t.Log.info.FUNC_SHOULD("build debugObject"))})],n.prototype,"updateDebugObjectFromShape",null),__decorate([t.require(function(e,n){t.assert(n.halfExtents&&!n.halfExtents.isZero(),t.Log.info.FUNC_SHOULD_NOT("halfExtents","be zero"))})],n.prototype,"setDebugObjectGeometry",null),n}(t.BoundingRegion);t.BoxBoundingRegion=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.updateShape=function(){var t=this.entityObject.transform;this.shape.setFromTranslationAndScale(this.originShape,t.localToWorldMatrix)},n.prototype.createShape=function(){return t.SphereShape.create()},n.prototype.updateDebugObjectFromShape=function(e){this.debugObject.transform.position=e.center;var n=e.radius/this.originShape.radius;this.debugObject.transform.scale=t.Vector3.create(n,n,n)},n.prototype.isNotTransformed=function(){var t=this.entityObject.transform;return!t.isTranslate&&!t.isScale},n.prototype.isBuildUserSpecifyBoundingRegion=function(t,e){return!!t&&!!e},n.prototype.setDebugObjectGeometry=function(t,e){for(var n=40,r=3,o=e.radius,i=[],a=0,s=0;r>s;s++){var c=0,u=1,l=2,h=null;1===s?(c=1,u=0,l=2):2===s&&(c=0,u=2,l=1);for(var p=0;n>p;p++)h=2*Math.PI*(p/n),i[a+c]=o*Math.cos(h),i[a+u]=0,i[a+l]=o*Math.sin(h),a+=3,h=2*Math.PI*((p+1)/n),i[a+c]=o*Math.cos(h),i[a+u]=0,i[a+l]=o*Math.sin(h),a+=3}t.vertices=i},__decorate([t.require(function(e){t.assert(this.debugObject,t.Log.info.FUNC_SHOULD("build debugObject"))})],n.prototype,"updateDebugObjectFromShape",null),__decorate([t.require(function(e,n){t.assert(n.radius>0,t.Log.info.FUNC_SHOULD("radius","> 0"))})],n.prototype,"setDebugObjectGeometry",null),n}(t.BoundingRegion);t.SphereBoundingRegion=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.isAABBInFrustum=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null,r=null;if(2===t.length)n=t[0],r=t[1];else if(3===t.length){var o=t[0],i=t[1];n=this.buildBoundingVectors(o,i),r=t[2]}for(var a=0;6>a;a++)for(var s=0;8>s;s++)if(r[a].dotCoordinate(n[s])<0)return!1;return!0},t.isAABBIntersectFrustum=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=null,r=null;if(2===t.length)n=t[0],r=t[1];else if(3===t.length){var o=t[0],i=t[1];n=this.buildBoundingVectors(o,i),r=t[2]}for(var a=0;6>a;a++){for(var s=8,c=0;8>c&&r[a].dotCoordinate(n[c])<0;c++)s--;if(0===s)return!1}return!0},t.buildBoundingVectors=function(t,e){var n=[];return n.push(t.copy()),n.push(e.copy()),n.push(t.copy()),n[2].x=e.x,n.push(t.copy()),n[3].y=e.y,n.push(t.copy()),n[4].z=e.z,n.push(e.copy()),n[5].z=t.z,n.push(e.copy()),n[6].x=t.x,n.push(e.copy()),n[7].y=t.y,n},t}();t.BoundingRegionUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.center=t.Vector3.create(0,0,0)}return e.prototype.isBoxAndSphereIntersected=function(t,e){var n=e.center,r=e.radius;return n.distanceToSquared(t.closestPointTo(n))<Math.pow(r,2)},e}();t.Shape=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.halfExtents=t.Vector3.create(.5,.5,.5)}return __extends(n,e),n.create=function(){var t=new this;return t},n.getCenter=function(e,n){return t.Vector3.create().add2(n,e).scale(.5)},n.getHalfExtents=function(e,n){return t.Vector3.create().sub2(n,e).scale(.5)},n.prototype.setMinMax=function(t,e){this.center=n.getCenter(t,e),this.halfExtents=n.getHalfExtents(t,e)},n.prototype.getMin=function(){return this.center.copy().sub(this.halfExtents)},n.prototype.getMax=function(){return this.center.copy().add(this.halfExtents)},n.prototype.setFromShapeParam=function(t,e){this.center=t,this.halfExtents=e},n.prototype.setFromPoints=function(e){var n=this,r=this._getEmptyMin(),o=this._getEmptyMax();return t.GeometryUtils.iterateThreeComponent(e,function(t){n._expandByPoint(t,r,o)}),this.setMinMax(r,o),this},n.prototype.setFromTransformedAABB=function(t,e){var n=this.center,r=this.halfExtents,o=t.center.values,i=t.halfExtents.values,a=e.values,s=a[0],c=a[4],u=a[8],l=a[1],h=a[5],p=a[9],f=a[2],d=a[6],_=a[10],y=Math.abs(s),g=Math.abs(c),m=Math.abs(u),v=Math.abs(l),b=Math.abs(h),C=Math.abs(p),w=Math.abs(f),E=Math.abs(d),T=Math.abs(_);n.set(a[12]+s*o[0]+c*o[1]+u*o[2],a[13]+l*o[0]+h*o[1]+p*o[2],a[14]+f*o[0]+d*o[1]+_*o[2]),r.set(y*i[0]+g*i[1]+m*i[2],v*i[0]+b*i[1]+C*i[2],w*i[0]+E*i[1]+T*i[2])},n.prototype.setFromTranslationAndScale=function(t,e){var n=e.getTranslation(),r=e.getScale();this.center=t.center.copy().add(n),this.halfExtents=t.halfExtents.copy().mul(r)},n.prototype.setFromObject=function(e){var n=e.transform.localToWorldMatrix,r=t.ColliderUtils.getVertices(e),o=this,i=this._getEmptyMin(),a=this._getEmptyMax();t.GeometryUtils.iterateThreeComponent(r,function(t){t.applyMatrix4(n),o._expandByPoint(t,i,a)}),this.setMinMax(i,a)},n.prototype.isIntersectWithBox=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=this.getMax(),r=this.getMin(),o=null,i=null;if(1===t.length){var a=t[0];i=a.getMin(),o=a.getMax()}else 2===t.length&&(i=t[0],o=t[1]);return r.x<=o.x&&n.x>=i.x&&r.y<=o.y&&n.y>=i.y&&r.z<=o.z&&n.z>=i.z},n.prototype.isIntersectWithSphere=function(t){return this.isBoxAndSphereIntersected(this,t)},n.prototype.isIntersectWithRay=function(t){return t.isIntersectWithAABB(this)},n.prototype.closestPointTo=function(e){var n=this.getMin(),r=this.getMax(),o=t.Vector3.create();return e.x<n.x?o.x=n.x:e.x>r.x?o.x=r.x:o.x=e.x,e.y<n.y?o.y=n.y:e.y>r.y?o.y=r.y:o.y=e.y,e.z<n.z?o.z=n.z:e.z>r.z?o.z=r.z:o.z=e.z,o},n.prototype.containPoint=function(t){for(var e=this.getMin(),n=this.getMax(),r=0;3>r;++r)if(t.values[r]<e.values[r]||t.values[r]>n.values[r])return!1;return!0},n.prototype.copy=function(){var t=n.create();return t.center=this.center.copy(),t.halfExtents=this.halfExtents.copy(),t},n.prototype._getEmptyMin=function(){return t.Vector3.create(1/0,1/0,1/0)},n.prototype._getEmptyMax=function(){return t.Vector3.create(-(1/0),-(1/0),-(1/0))},n.prototype._expandByPoint=function(t,e,n){e.min(t),n.max(t)},__decorate([t.require(function(e){var n=t.ColliderUtils.getVertices(e);t.assert(n&&n.length>0,t.Log.info.FUNC_MUST_DEFINE("vertices"))})],n.prototype,"setFromObject",null),n}(t.Shape);
t.AABBShape=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.radius=1}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.setFromShapeParam=function(t,e){this.center=t,this.radius=e},n.prototype.setFromPoints=function(e){var n=t.AABBShape.create();this.center=n.setFromPoints(e).center,this.radius=this._findMaxDistanceOfPointsToCenter(e)},n.prototype.setFromTranslationAndScale=function(t,e){var n=e.getTranslation(),r=e.getScale();this.center=t.center.copy().add(n),this.radius=t.radius*Math.max(r.x,r.y,r.z)},n.prototype.isIntersectWithSphere=function(t){var e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=Math.pow(e,2)},n.prototype.isIntersectWithBox=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;if(1===e.length)r=e[0];else if(2===e.length){var o=e[0],i=e[1];r=t.AABBShape.create(),r.setMinMax(o,i)}return this.isBoxAndSphereIntersected(r,this)},n.prototype.isIntersectWithRay=function(t){return t.isIntersectWithSphere(this)},n.prototype.containPoint=function(t){return t.distanceToSquared(this.center)<=Math.pow(this.radius,2)},n.prototype.copy=function(){var t=n.create();return t.center=this.center.copy(),t.radius=this.radius,t},n.prototype._findMaxDistanceOfPointsToCenter=function(e){var n=0,r=this.center;return t.GeometryUtils.iterateThreeComponent(e,function(t){n=Math.max(n,r.distanceToSquared(t))}),Math.sqrt(n)},n}(t.Shape);t.SphereShape=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BOX="box"]="BOX",t[t.SPHERE="sphere"]="SPHERE"}(t.EColliderType||(t.EColliderType={}));t.EColliderType}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){}return e.getVertices=function(e){return e.hasComponent(t.Geometry)?e.getComponent(t.Geometry).geometryData.vertices:e.hasTag(t.EWDTag.CONTAINER)?e.getChild(0).getComponent(t.Geometry).vertices:null},__decorate([t.require(function(e){if(!e.hasComponent(t.Geometry)&&e.hasTag(t.EWDTag.CONTAINER)){var n=e.getChild(0).getComponent(t.Geometry).vertices,r=e.getChild(1).getComponent(t.Geometry).vertices;t.assert(!!n&&n.length===r.length,t.Log.info.FUNC_SHOULD("if entityObject is EWDTag.CONTAINER, then its children should has its vertices"))}})],e,"getVertices",null),e}();t.ColliderUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._friction=0,this._restitution=0,this._children=wdCb.Collection.create(),this.lockConstraint=t.LockConstraint.create(this),this.distanceConstraint=t.DistanceConstraint.create(this),this.hingeConstraint=t.HingeConstraint.create(this),this.pointToPointConstraintList=t.PointToPointConstraintList.create(this),this._afterInitSubscription=null,this._afterInitRigidbodyAddConstraintSubscription=null}return __extends(n,e),Object.defineProperty(n.prototype,"friction",{get:function(){return this._friction},set:function(t){this._friction=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"restitution",{get:function(){return this._restitution},set:function(t){this._restitution=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"children",{get:function(){return this._children},set:function(e){if(t.JudgeUtils.isArrayExactly(e)){var n=e;this._children=wdCb.Collection.create(n)}else{var r=e;this._children=r}this._children.forEach(function(t){t.addTag("isRigidbodyChild")})},enumerable:!0,configurable:!0}),n.prototype.init=function(){var e=this;this._afterInitSubscription=t.EventManager.fromEvent(t.EEngineEvent.AFTER_GAMEOBJECT_INIT).subscribe(function(){e._afterInitHandler()}),this._afterInitRigidbodyAddConstraintSubscription=t.EventManager.fromEvent(t.EEngineEvent.AFTER_GAMEOBJECT_INIT_RIGIDBODY_ADD_CONSTRAINT).subscribe(function(){e._afterInitRigidbodyAddConstraintHandler()})},n.prototype.addConstraint=function(){var t=this,e=this.getPhysicsEngineAdapter();this.lockConstraint&&this.lockConstraint.connectedBody&&e.addLockConstraint(this.entityObject,this.lockConstraint),this.distanceConstraint&&this.distanceConstraint.connectedBody&&e.addDistanceConstraint(this.entityObject,this.distanceConstraint),this.hingeConstraint&&this.hingeConstraint.connectedBody&&e.addHingeConstraint(this.entityObject,this.hingeConstraint),this.pointToPointConstraintList&&this.pointToPointConstraintList.getCount()>0&&this.pointToPointConstraintList.forEach(function(n){e.addPointToPointConstraint(t.entityObject,n)},this)},n.prototype.removeFromObject=function(t){var n=this.getPhysicsEngineAdapter();n&&(this.getPhysicsEngineAdapter().removeGameObject(t),this.getPhysicsEngineAdapter().removeConstraints(t)),e.prototype.removeFromObject.call(this,t)},n.prototype.dispose=function(){this._children.forEach(function(t){t.removeTag("isRigidbodyChild")},this),this._afterInitSubscription&&this._afterInitSubscription.dispose(),this._afterInitRigidbodyAddConstraintSubscription&&this._afterInitRigidbodyAddConstraintSubscription.dispose()},n.prototype.getPhysicsEngineAdapter=function(){return t.Director.getInstance().scene.physicsEngineAdapter},n.prototype.isPhysicsEngineAdapterExist=function(){return!!t.Director.getInstance().scene&&!!t.Director.getInstance().scene.physicsEngineAdapter},n.prototype.addBodyToPhysicsEngine=function(t,e){void 0===e&&(e={});var n=this.getPhysicsEngineAdapter(),r=this.entityObject.transform.position,o=this.entityObject.transform.rotation;n[t](this.entityObject,wdCb.ExtendUtils.extend({position:r,rotation:o,children:this._children,lockConstraint:this.lockConstraint,onContact:wdCb.FunctionUtils.bind(this,this._onContact),onCollisionStart:wdCb.FunctionUtils.bind(this,this._onCollisionStart),onCollisionEnd:wdCb.FunctionUtils.bind(this,this._onCollisionEnd),friction:this.friction,restitution:this.restitution},e))},n.prototype._onContact=function(t){this.entityObject.execScript("onContact",wdCb.Collection.create([t]))},n.prototype._onCollisionStart=function(t){this.entityObject.execScript("onCollisionStart",wdCb.Collection.create([t]))},n.prototype._onCollisionEnd=function(){this.entityObject.execScript("onCollisionEnd")},n.prototype._isContainer=function(t){var e=t.getComponent(n);return e.children.getCount()>0},n.prototype._afterInitHandler=function(){this.addBody()},n.prototype._afterInitRigidbodyAddConstraintHandler=function(){this.addConstraint()},__decorate([t.operateBodyDataGetterAndSetter("Friction")],n.prototype,"friction",null),__decorate([t.operateBodyDataGetterAndSetter("Restitution")],n.prototype,"restitution",null),__decorate([t.require(function(){this._isContainer(this.entityObject)?t.assert(!this.entityObject.getComponent(t.Collider),t.Log.info.FUNC_SHOULD_NOT("container","add collider component in the case of compound")):(t.assert(!!this.entityObject.getComponent(t.Collider),t.Log.info.FUNC_MUST_DEFINE("collider component when add rigid body component")),t.assert(!!this.entityObject.getComponent(t.Collider).shape,t.Log.info.FUNC_SHOULD("create collider.shape before adding rigid body component")))})],n.prototype,"addBodyToPhysicsEngine",null),__decorate([t.execOnlyOnce("_isAfterInit")],n.prototype,"_afterInitHandler",null),__decorate([t.execOnlyOnce("_isAfterInitRigidbodyAddConstraint")],n.prototype,"_afterInitRigidbodyAddConstraintHandler",null),n}(t.Component);t.RigidBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._linearDamping=0,this._angularDamping=0,this._velocity=t.Vector3.create(0,0,0),this._angularVelocity=t.Vector3.create(0,0,0),this._mass=1,this.impulse=null,this.force=null,this.hitPoint=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"linearDamping",{get:function(){return this._linearDamping},set:function(t){this._linearDamping=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"angularDamping",{get:function(){return this._angularDamping},set:function(t){this._angularDamping=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"angularVelocity",{get:function(){return this._angularVelocity},set:function(t){this._angularVelocity=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"mass",{get:function(){return this._mass},set:function(t){this._mass=t},enumerable:!0,configurable:!0}),n.prototype.addBody=function(){this.addBodyToPhysicsEngine("addDynamicBody",{mass:this.mass,linearDamping:this.linearDamping,angularDamping:this.angularDamping,velocity:this.velocity,angularVelocity:this.angularVelocity,impulse:this.impulse,force:this.force,hitPoint:this.hitPoint})},__decorate([t.operateBodyDataGetterAndSetter("LinearDamping")],n.prototype,"linearDamping",null),__decorate([t.operateBodyDataGetterAndSetter("AngularDamping")],n.prototype,"angularDamping",null),__decorate([t.operateBodyDataGetterAndSetter("Velocity")],n.prototype,"velocity",null),__decorate([t.operateBodyDataGetterAndSetter("AngularVelocity")],n.prototype,"angularVelocity",null),__decorate([t.operateBodyDataGetterAndSetter("Mass")],n.prototype,"mass",null),n}(t.RigidBody);t.DynamicRigidBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._velocity=t.Vector3.create(0,0,0),this._angularVelocity=t.Vector3.create(0,0,0),this._mass=1}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"angularVelocity",{get:function(){return this._angularVelocity},set:function(t){this._angularVelocity=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"mass",{get:function(){return this._mass},set:function(t){this._mass=t},enumerable:!0,configurable:!0}),n.prototype.addBody=function(){this.addBodyToPhysicsEngine("addKinematicBody",{mass:this.mass,velocity:this.velocity,angularVelocity:this.angularVelocity})},__decorate([t.operateBodyDataGetterAndSetter("Velocity")],n.prototype,"velocity",null),__decorate([t.operateBodyDataGetterAndSetter("AngularVelocity")],n.prototype,"angularVelocity",null),__decorate([t.operateBodyDataGetterAndSetter("Mass")],n.prototype,"mass",null),n}(t.RigidBody);t.KinematicRigidBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.addBody=function(){this.addBodyToPhysicsEngine("addStaticBody")},e}(t.RigidBody);t.StaticRigidBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(){function t(t){this.maxForce=null,this.rigidBody=null,this.rigidBody=t}return t}();t.PhysicsConstraint=e;var n=function(t){function e(){t.apply(this,arguments),this._connectedBody=null}return __extends(e,t),e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(t){var e=null;this._connectedBody=t,this.rigidBody.isPhysicsEngineAdapterExist()&&(e=this.rigidBody.getPhysicsEngineAdapter(),e.removeLockConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint())},enumerable:!0,configurable:!0}),e}(e);t.LockConstraint=n;var r=function(t){function e(){t.apply(this,arguments),this._connectedBody=null,this.distance=null}return __extends(e,t),e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(t){var e=null;this._connectedBody=t,this.rigidBody.isPhysicsEngineAdapterExist()&&(e=this.rigidBody.getPhysicsEngineAdapter(),e.removeDistanceConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint())},enumerable:!0,configurable:!0}),e}(e);t.DistanceConstraint=r;var o=function(t){function e(){t.apply(this,arguments),this._connectedBody=null,this.pivotA=null,this.pivotB=null,this.axisA=null,this.axisB=null}return __extends(e,t),e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(t){var e=null;this._connectedBody=t,this.rigidBody.isPhysicsEngineAdapterExist()&&(e=this.rigidBody.getPhysicsEngineAdapter(),e.removeHingeConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint())},enumerable:!0,configurable:!0}),e}(e);t.HingeConstraint=o;var i=function(t){function e(){t.apply(this,arguments),this.connectedBody=null,this.pivotA=null,this.pivotB=null}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e}(e);t.PointToPointConstraint=i;var a=function(){function e(t){this._rigidBody=null,this._list=wdCb.Collection.create(),this._rigidBody=t}return e.create=function(t){var e=new this(t);return e},e.prototype.forEach=function(e,n){void 0===n&&(n=t.root),this._list.forEach(e,n)},e.prototype.getCount=function(){return this._list.getCount()},e.prototype.addChild=function(t){var e=null;this._list.addChild(t),this._rigidBody.isPhysicsEngineAdapterExist()&&(e=this._rigidBody.getPhysicsEngineAdapter(),e.addPointToPointConstraint(this._rigidBody.entityObject,t))},e.prototype.addChildren=function(e){var n=this;if(t.JudgeUtils.isArrayExactly(e))for(var r=0,o=e;r<o.length;r++){var i=o[r];this.addChild(i)}else{var a=e;a.forEach(function(t){n.addChild(t)},this)}},e.prototype.removeChild=function(t){var e=null;this._list.removeChild(t),this._rigidBody.isPhysicsEngineAdapterExist()&&(e=this._rigidBody.getPhysicsEngineAdapter(),e.removePointToPointConstraint(t))},e}();t.PointToPointConstraintList=a}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.create=function(e){var n=null;switch(e){case t.EPhysicsEngineType.CANNON:n=t.CannonAdapter.create();break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNEXPECT("physics engine type"))}return n},e}();t.PhysicsEngineFactory=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.CANNON=0]="CANNON"}(t.EPhysicsEngineType||(t.EPhysicsEngineType={}));t.EPhysicsEngineType}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.dataList=wdCb.Collection.create()}return e.prototype.getCount=function(){return this.dataList.getCount()},e.prototype.removeByGameObject=function(e){this.dataList.removeChild(function(n){var r=n.entityObject;n.body;return t.JudgeUtils.isEqual(r,e)})},e}();t.CannonDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.remove=function(t){this.removeByGameObject(t)},n.prototype.updateBodyTransformData=function(){this.dataList.forEach(function(e){var n=e.entityObject,r=e.body,o=n.transform;(o.isTranslate||o.isRotate)&&(r.position=t.CannonUtils.convertToCannonVector3(n.transform.position),r.quaternion=t.CannonUtils.convertToCannonQuaternion(n.transform.rotation))})},n.prototype.updateGameObjectTransformData=function(){this.dataList.forEach(function(e){var n=e.entityObject,r=e.body;n.hasTag("isRigidbodyChild")||(n.transform.position=t.CannonUtils.convertToWonderVector3(r.position),n.transform.rotation=t.CannonUtils.convertToWonderQuaternion(r.quaternion))})},n.prototype.add=function(t,e){this.dataList.addChild({entityObject:t,body:e})},n.prototype.findGameObjectByBody=function(t){var e=this.dataList.findOne(function(e){var n=(e.entityObject,e.body);return n===t});return null!==e?e.entityObject:null},n.prototype.findBodyByGameObject=function(e){var n=this.dataList.findOne(function(n){var r=n.entityObject;n.body;return t.JudgeUtils.isEqual(r,e)});return null!==n?n.body:null},n}(t.CannonDataList);t.CannonGameObjectDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.remove=function(t){this.removeByGameObject(t)},n.prototype.findMaterialByGameObject=function(e){var n=this.dataList.findOne(function(n){var r=n.entityObject;n.material;return t.JudgeUtils.isEqual(r,e)});return null!==n?n.material:null},n.prototype.add=function(t,e){this.dataList.addChild({entityObject:t,material:e})},n.prototype.addContactMaterial=function(t,e,n,r){this.dataList.forEach(function(o){var i=(o.entityObject,o.material);t.addContactMaterial(new CANNON.ContactMaterial(i,e,{friction:n,restitution:r}))})},n.prototype.getContactMaterialData=function(t,e,n){var r=null;return this.dataList.forEach(function(o){var i=(o.entityObject,o.material),a=t.getContactMaterial(i,e);return a?(r=a[n],wdCb.$BREAK):void 0}),r},n.prototype.getContactMaterials=function(t,e){var n=[];return this.dataList.forEach(function(r){var o=(r.entityObject,r.material),i=t.getContactMaterial(o,e);i&&n.push(i)}),n},n.prototype.setContactMaterialData=function(t,e,n,r){this.dataList.forEach(function(o){var i=(o.entityObject,o.material),a=t.getContactMaterial(i,e);a&&(a[n]=r)})},n}(t.CannonDataList);t.CannonMaterialList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.CannonDataList);t.CannonConstraintDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.add=function(t,e){this.dataList.addChild({entityObject:t,constraint:e})},n.prototype.remove=function(t){this.removeByGameObject(t)},n.prototype.findConstraintByGameObject=function(e){var n=this.dataList.findOne(function(n){var r=n.entityObject;return t.JudgeUtils.isEqual(r,e)});return null!==n?n.constraint:null},n}(t.CannonConstraintDataList);t.CannonSingleConstraintDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.CannonSingleConstraintDataList);t.CannonLockConstraintDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.filter=function(t){return this.dataList.filter(t)},n.prototype.forEach=function(t){this.dataList.forEach(t)},n.prototype.add=function(t,e,n){this.dataList.addChild({entityObject:t,pointToPointConstraint:e,cannonConstraint:n})},n.prototype.remove=function(e){this.dataList.removeChild(function(n){var r=n.pointToPointConstraint;return t.JudgeUtils.isEqual(r,e)})},n.prototype.findCannonConstraintByPointToPointConstraint=function(e){var n=this.dataList.findOne(function(n){var r=n.pointToPointConstraint;return t.JudgeUtils.isEqual(r,e)});return null!==n?n.cannonConstraint:null},n}(t.CannonConstraintDataList);t.CannonPointToPointConstraintDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.CannonSingleConstraintDataList);t.CannonDistanceConstraintDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.CannonSingleConstraintDataList);t.CannonHingeConstraintDataList=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.convertToCannonVector3=function(t){return new CANNON.Vec3(t.x,t.y,t.z)},e.convertToCannonQuaternion=function(t){return new CANNON.Quaternion(t.x,t.y,t.z,t.w)},e.convertToWonderVector3=function(e){return t.Vector3.create(e.x,e.y,e.z)},e.convertToWonderQuaternion=function(e){return t.Quaternion.create(e.x,e.y,e.z,e.w)},e}();t.CannonUtils=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this.world=null,this._materialList=t.CannonMaterialList.create(),this._gameObjectDataList=t.CannonGameObjectDataList.create(),this._lockConstraintDataList=t.CannonLockConstraintDataList.create(),this._distanceConstraintDataList=t.CannonDistanceConstraintDataList.create(),this._hingeConstraintDataList=t.CannonHingeConstraintDataList.create(),this._pointToPointConstraintDataList=t.CannonPointToPointConstraintDataList.create(),this._dynamicBody=null,this._kinematicBody=null,this._staticBody=null,this._lockConstraint=null,this._distanceConstraint=null,this._hingeConstraint=null,this._pointToPointConstraint=null}return e.create=function(){var t=new this;return t},e.prototype.getGravity=function(e){return t.CannonUtils.convertToWonderVector3(this.world.gravity)},e.prototype.setGravity=function(e){this.world.gravity=t.CannonUtils.convertToCannonVector3(e)},e.prototype.getFriction=function(t,e){return this._getMaterialData(t,"friction")},e.prototype.setFriction=function(t,e){this._setMaterialData(t,"friction",e)},e.prototype.getRestitution=function(t,e){return this._getMaterialData(t,"restitution")},e.prototype.setRestitution=function(t,e){this._setMaterialData(t,"restitution",e)},e.prototype.getLinearDamping=function(t){return this._getNumberData(t,"linearDamping")},e.prototype.setLinearDamping=function(t,e){return this._setNumberData(t,"linearDamping",e)},e.prototype.getAngularDamping=function(t){return this._getNumberData(t,"angularDamping")},e.prototype.setAngularDamping=function(t,e){return this._setNumberData(t,"angularDamping",e)},e.prototype.getMass=function(t){return this._getNumberData(t,"mass")},e.prototype.setMass=function(t,e){return this._setNumberData(t,"mass",e)},e.prototype.getVelocity=function(t){return this._getVec3Data(t,"velocity")},e.prototype.setVelocity=function(t,e){this._setVec3Data(t,"velocity",e)},e.prototype.getAngularVelocity=function(t){return this._getVec3Data(t,"angularVelocity")},e.prototype.setAngularVelocity=function(t,e){this._setVec3Data(t,"angularVelocity",e)},e.prototype.init=function(){var e=t.Director.getInstance().scene.physics,n=e.gravity,r=e.iterations;this.world=new CANNON.World,this.world.broadphase=new CANNON.NaiveBroadphase,this.world.solver.iterations=r,this.world.gravity.set(n.x,n.y,n.z),this._dynamicBody=t.CannonDynamicBody.create(this.world,this._gameObjectDataList,this._materialList),this._kinematicBody=t.CannonKinematicBody.create(this.world,this._gameObjectDataList,this._materialList),this._staticBody=t.CannonStaticBody.create(this.world,this._gameObjectDataList,this._materialList),this._lockConstraint=t.CannonLockConstraint.create(this.world,this._gameObjectDataList,this._lockConstraintDataList),this._distanceConstraint=t.CannonDistanceConstraint.create(this.world,this._gameObjectDataList,this._distanceConstraintDataList),this._hingeConstraint=t.CannonHingeConstraint.create(this.world,this._gameObjectDataList,this._hingeConstraintDataList),this._pointToPointConstraint=t.CannonPointToPointConstraint.create(this.world,this._gameObjectDataList,this._pointToPointConstraintDataList)},e.prototype.addDynamicBody=function(t,e){this._dynamicBody.addBody(t,e)},e.prototype.addKinematicBody=function(t,e){this._kinematicBody.addBody(t,e)},e.prototype.addStaticBody=function(t,e){this._staticBody.addBody(t,e)},e.prototype.addLockConstraint=function(t,e){this._lockConstraint.addConstraint(t,e)},e.prototype.removeLockConstraint=function(t){this._lockConstraint.removeConstraint(t)},e.prototype.addDistanceConstraint=function(t,e){this._distanceConstraint.addConstraint(t,e)},e.prototype.removeDistanceConstraint=function(t){this._distanceConstraint.removeConstraint(t)},e.prototype.addHingeConstraint=function(t,e){this._hingeConstraint.addConstraint(t,e)},e.prototype.removeHingeConstraint=function(t){this._hingeConstraint.removeConstraint(t)},e.prototype.addPointToPointConstraint=function(t,e){this._pointToPointConstraint.addConstraint(t,e)},e.prototype.removePointToPointConstraint=function(t){this._pointToPointConstraint.removeConstraint(t)},e.prototype.removeGameObject=function(t){var e=(this._getMaterial(t),this._gameObjectDataList.findBodyByGameObject(t));e&&this.world.remove(e),this._gameObjectDataList.remove(t),this._materialList.remove(t)},e.prototype.removeConstraints=function(e){var n=this;this._lockConstraint.removeConstraint(e),this._distanceConstraint.removeConstraint(e),this._hingeConstraint.removeConstraint(e),this._pointToPointConstraintDataList.filter(function(n){var r=n.entityObject;return t.JudgeUtils.isEqual(r,e)}).forEach(function(t){var e=t.pointToPointConstraint;n._pointToPointConstraint.removeConstraint(e)})},e.prototype.update=function(e){this._gameObjectDataList.updateBodyTransformData(),this.world.step(t.Director.getInstance().getDeltaTime()/1e3),this._gameObjectDataList.updateGameObjectTransformData()},e.prototype._getMaterial=function(t){return this._materialList.findMaterialByGameObject(t)},e.prototype._getNumberData=function(t,e){var n=this._gameObjectDataList.findBodyByGameObject(t);return n?n[e]:null},e.prototype._setNumberData=function(t,e,n){var r=this._gameObjectDataList.findBodyByGameObject(t);return r?void(r[e]=n):null},e.prototype._getVec3Data=function(e,n){var r=this._gameObjectDataList.findBodyByGameObject(e);return r?t.CannonUtils.convertToWonderVector3(r[n]):null},e.prototype._setVec3Data=function(e,n,r){var o=this._gameObjectDataList.findBodyByGameObject(e);return o?void(o[n]=t.CannonUtils.convertToCannonVector3(r)):null},e.prototype._getMaterialData=function(t,e){var n=this._getMaterial(t);return n?this._materialList.getContactMaterialData(this.world,n,e):null},e.prototype._setMaterialData=function(e,n,r){var o=(this.world,this._getMaterial(e));return o?void this._materialList.setContactMaterialData(this.world,o,n,r):void t.Log.warn("no material find, please add material first")},__decorate([t.require(function(e,n){var r=[],o=null,i=this._getMaterial(e);if(!i)return null;r=this._materialList.getContactMaterials(this.world,i),o=r[0];for(var a=0,s=r;a<s.length;a++){var c=s[a];t.assert(c===o,t.Log.info.FUNC_SHOULD("the data of contact material which contains the same material","be the same"))}})],e.prototype,"_getMaterialData",null),e}();t.CannonAdapter=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(t,e,n){this.world=null,this.materialList=null,this.gameObjectList=null,this.world=t,this.gameObjectList=e,this.materialList=n}return e.prototype.addBody=function(e,n){var r=this.createBody(n);return n.children.getCount()>0?this._addCompounds(e,n.children,r):r.addShape(this._createShape(e.getComponent(t.Collider).shape)),this.afterAddShape(r,n),r.material=this._createMaterial(e,n.friction,n.restitution),r.position=t.CannonUtils.convertToCannonVector3(n.position),r.quaternion=t.CannonUtils.convertToCannonQuaternion(n.rotation),this.world.addBody(r),this.gameObjectList.add(e,r),this._bindCollideEvent(r,n.onCollisionStart,n.onContact,n.onCollisionEnd),r},e.prototype.afterAddShape=function(t,e){},e.prototype._createShape=function(e){var n=null;return e instanceof t.AABBShape?n=new CANNON.Box(t.CannonUtils.convertToCannonVector3(e.halfExtents)):e instanceof t.SphereShape&&(n=new CANNON.Sphere(e.radius)),n},e.prototype._bindCollideEvent=function(t,e,n,r){var o=this;t.addEventListener("collide",function(t){var i=o.gameObjectList.findGameObjectByBody(t.body),a=null;i&&(a=i,e(a),n(a),r(a))})},e.prototype._createMaterial=function(t,e,n){
var r=null,o=null;return(r=this._getMaterial(t))?r:(o=new CANNON.Material("material"),this._addMaterial(t,o,e,n),o)},e.prototype._getMaterial=function(t){return this.materialList.findMaterialByGameObject(t)},e.prototype._addMaterial=function(t,e,n,r){this.materialList.add(t,e),this.materialList.addContactMaterial(this.world,e,n,r)},e.prototype._addCompounds=function(e,n,r){var o=this,i=e.transform.position,a=e.transform.rotation;n.forEach(function(e){r.addShape(o._createShape(e.getComponent(t.Collider).shape),t.CannonUtils.convertToCannonVector3(e.transform.position.copy().sub(i)),t.CannonUtils.convertToCannonQuaternion(e.transform.rotation.copy().sub(a)))},this)},__decorate([t.virtual],e.prototype,"afterAddShape",null),__decorate([t.require(function(e,n,r){n.forEach(function(e){t.assert(!!e.getComponent(t.Collider),t.Log.info.FUNC_MUST_DEFINE("collider component")),t.assert(!!e.getComponent(t.Collider).shape,t.Log.info.FUNC_SHOULD("create collider.shape"))})})],e.prototype,"_addCompounds",null),e}();t.CannonBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.createBody=function(e){var n=e.mass,r=e.linearDamping,o=e.angularDamping,i=e.velocity,a=e.angularVelocity;return new CANNON.Body({mass:n,linearDamping:r,angularDamping:o,velocity:t.CannonUtils.convertToCannonVector3(i),angularVelocity:t.CannonUtils.convertToCannonVector3(a)})},n.prototype.afterAddShape=function(e,n){var r=n.impulse,o=n.force,i=n.hitPoint;r&&i&&e.applyImpulse(t.CannonUtils.convertToCannonVector3(r),t.CannonUtils.convertToCannonVector3(i)),o&&i&&e.applyForce(t.CannonUtils.convertToCannonVector3(o),t.CannonUtils.convertToCannonVector3(i))},n}(t.CannonBody);t.CannonDynamicBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.createBody=function(e){var n=e.mass,r=e.velocity,o=e.angularVelocity;return new CANNON.Body({type:CANNON.Body.KINEMATIC,mass:n,velocity:t.CannonUtils.convertToCannonVector3(r),angularVelocity:t.CannonUtils.convertToCannonVector3(o)})},n}(t.CannonBody);t.CannonKinematicBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e,n){var r=new this(t,e,n);return r},e.prototype.createBody=function(t){return new CANNON.Body({mass:0})},e}(t.CannonBody);t.CannonStaticBody=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(t,e,n){this.world=null,this.gameObjectList=null,this.constraintDataList=null,this.world=t,this.gameObjectList=e,this.constraintDataList=n}return e.prototype.addConstraint=function(t,e){var n=null,r=this.gameObjectList.findBodyByGameObject(t);n=this.createCannonConstraint(r,e),this.world.addConstraint(n),this.addToConstraintDataList(t,e,n)},e.prototype.findBody=function(t){return this.gameObjectList.findBodyByGameObject(t.entityObject)},__decorate([t.require(function(e,n){t.assert(null!==this.gameObjectList.findBodyByGameObject(e),t.Log.info.FUNC_SHOULD("add rigid body")),t.assert(this.findBody(n.connectedBody),t.Log.info.FUNC_SHOULD("add connectedBody"))})],e.prototype,"addConstraint",null),e}();t.CannonConstraint=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.removeConstraint=function(t){var e=this.constraintDataList.findConstraintByGameObject(t);e&&this.world.removeConstraint(e),this.constraintDataList.remove(t)},e.prototype.addToConstraintDataList=function(t,e,n){this.constraintDataList.add(t,n)},e}(t.CannonConstraint);t.CannonSingleConstraint=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e,n){var r=new this(t,e,n);return r},e.prototype.createCannonConstraint=function(t,e){var n=null,r=this.findBody(e.connectedBody);return n=e.maxForce?new CANNON.LockConstraint(t,r,e.maxForce):new CANNON.LockConstraint(t,r)},e}(t.CannonSingleConstraint);t.CannonLockConstraint=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.removeConstraint=function(t){var e=this.constraintDataList.findCannonConstraintByPointToPointConstraint(t);e&&this.world.removeConstraint(e),this.constraintDataList.remove(t)},n.prototype.createCannonConstraint=function(e,n){var r=null,o=this.findBody(n.connectedBody),i=t.CannonUtils.convertToCannonVector3(n.pivotA),a=t.CannonUtils.convertToCannonVector3(n.pivotB);return r=n.maxForce?new CANNON.PointToPointConstraint(e,i,o,a,n.maxForce):new CANNON.PointToPointConstraint(e,i,o,a)},n.prototype.addToConstraintDataList=function(t,e,n){this.constraintDataList.add(t,e,n)},n}(t.CannonConstraint);t.CannonPointToPointConstraint=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e,n){var r=new this(t,e,n);return r},e.prototype.createCannonConstraint=function(t,e){var n=null,r=this.findBody(e.connectedBody);return n=new CANNON.DistanceConstraint(t,r,null!==e.distance?e.distance:void 0,null!==e.maxForce?e.maxForce:void 0)},e}(t.CannonSingleConstraint);t.CannonDistanceConstraint=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e,n){var r=new this(t,e,n);return r},n.prototype.createCannonConstraint=function(e,n){var r=null,o=this.findBody(n.connectedBody),i=t.CannonUtils.convertToCannonVector3(n.pivotA),a=t.CannonUtils.convertToCannonVector3(n.axisA),s=t.CannonUtils.convertToCannonVector3(n.pivotB),c=t.CannonUtils.convertToCannonVector3(n.axisB),u={};return n.pivotA&&(u.pivotA=i),n.axisA&&(u.axisA=a),n.pivotB&&(u.pivotB=s),n.axisB&&(u.axisB=c),n.maxForce&&(u.maxForce=n.maxForce),r=new CANNON.HingeConstraint(e,o,u)},n}(t.CannonSingleConstraint);t.CannonHingeConstraint=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._shadowMapWidth=null,this._shadowMapHeight=null,this.color=t.Color.create("#ffffff"),this.castShadow=!1,this.shadowCameraNear=.1,this.shadowCameraFar=5e3,this.shadowBias=t.ShaderChunk.NULL,this.shadowDarkness=0,this.shadowMap=null,this.shadowMapRenderer=null}return __extends(n,e),Object.defineProperty(n.prototype,"position",{get:function(){return this.entityObject.transform.position},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"shadowMapWidth",{get:function(){var e=t.GPUDetector.getInstance().maxCubemapTextureSize;return!this._shadowMapWidth||this._shadowMapWidth>e?e:this._shadowMapWidth},set:function(t){this._shadowMapWidth=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"shadowMapHeight",{get:function(){var e=t.GPUDetector.getInstance().maxCubemapTextureSize;return!this._shadowMapHeight||this._shadowMapHeight>e?e:this._shadowMapHeight},set:function(t){this._shadowMapHeight=t},enumerable:!0,configurable:!0}),n}(t.Component);t.Light=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.type="ambientLight",e}(t.Light);t.AmbientLight=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.intensity=1,this._beforeInitSubscription=null}return __extends(n,e),n.prototype.initWhenCreate=function(){var e=this;this._beforeInitSubscription=t.EventManager.fromEvent(t.EEngineEvent.BEFORE_GAMEOBJECT_INIT).subscribe(function(){e.beforeInitHandler()})},n.prototype.dispose=function(){this.shadowMap&&this.shadowMap.dispose(),t.Director.getInstance().scene.removeRenderTargetRenderer(this.shadowMapRenderer),this._beforeInitSubscription&&this._beforeInitSubscription.dispose()},n.prototype.beforeInitHandler=function(){this.castShadow&&(this.shadowMap=this.createShadowMap(),this.shadowMapRenderer=this.createShadowMapRenderer(),t.Director.getInstance().scene.addRenderTargetRenderer(this.shadowMapRenderer))},__decorate([t.execOnlyOnce("_isBeforeInit")],n.prototype,"beforeInitHandler",null),n}(t.Light);t.SourceLight=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._shadowRenderList=null,this.shadowCameraLeft=-1e3,this.shadowCameraRight=1e3,this.shadowCameraTop=1e3,this.shadowCameraBottom=-1e3}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"shadowRenderList",{get:function(){return this._shadowRenderList},set:function(t){this._shadowRenderList=wdCb.Collection.create(t)},enumerable:!0,configurable:!0}),n.prototype.createShadowMap=function(){return t.TwoDShadowMapTexture.create()},n.prototype.createShadowMapRenderer=function(){return t.TwoDShadowMapRenderTargetRenderer.create(this)},n.type="directionLight",n.defaultPosition=t.Vector3.create(0,0,1),__decorate([t.requireSetter(function(e){t.assert(t.JudgeUtils.isArrayExactly(e),t.Log.info.FUNC_MUST_BE("shadowRenderList","array"))})],n.prototype,"shadowRenderList",null),n}(t.SourceLight);t.DirectionLight=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._rangeLevel=null,this._shadowRenderList=wdCb.Hash.create(),this._attenuation=t.Attenuation.create()}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"rangeLevel",{get:function(){return this._rangeLevel},set:function(t){this._rangeLevel=t,this._attenuation.rangeLevel=this._rangeLevel},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"range",{get:function(){return this._attenuation.range},set:function(t){this._attenuation.range=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"constant",{get:function(){return this._attenuation.constant},set:function(t){this._attenuation.constant=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"linear",{get:function(){return this._attenuation.linear},set:function(t){this._attenuation.linear=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"quadratic",{get:function(){return this._attenuation.quadratic},set:function(t){this._attenuation.quadratic=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"shadowRenderList",{get:function(){return this._shadowRenderList},set:function(t){t=t;for(var e in t)if(t.hasOwnProperty(e)){var n=t[e];this._shadowRenderList.addChild(e,wdCb.Collection.create(n))}},enumerable:!0,configurable:!0}),n.prototype.createShadowMap=function(){return t.CubemapShadowMapTexture.create()},n.prototype.createShadowMapRenderer=function(){return t.CubemapShadowMapRenderTargetRenderer.create(this)},n.type="pointLight",__decorate([t.requireSetter(function(e){t.assert(t.JudgeUtils.isDirectObject(e),t.Log.info.FUNC_MUST_BE("shadowRenderList","object"));for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];t.assert(t.JudgeUtils.isArrayExactly(r)||e instanceof wdCb.Hash,t.Log.info.FUNC_MUST_BE("renderList in each direction of shadowRenderList","array"))}})],n.prototype,"shadowRenderList",null),n}(t.SourceLight);t.PointLight=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._constant=1,this._range=null,this._linear=0,this._quadratic=0,this._rangeLevel=0}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"constant",{get:function(){return this._constant},set:function(t){this._constant=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"range",{get:function(){return this._range},set:function(t){this._range=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"linear",{get:function(){return this._linear},set:function(t){this._linear=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"quadratic",{get:function(){return this._quadratic},set:function(t){this._quadratic=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rangeLevel",{get:function(){return this._rangeLevel},set:function(t){this._rangeLevel=t,this.setByRangeLevel()},enumerable:!0,configurable:!0}),e.prototype.setByRangeLevel=function(){switch(this._rangeLevel){case 0:this._range=7,this._linear=.7,this._quadratic=1.8;break;case 1:this._range=13,this._linear=.35,this._quadratic=.44;break;case 2:this._range=20,this._linear=.22,this._quadratic=.2;break;case 3:this._range=32,this._linear=.14,this._quadratic=.07;break;case 4:this._range=50,this._linear=.09,this._quadratic=.032;break;case 5:this._range=65,this._linear=.07,this._quadratic=.017;break;case 6:this._range=100,this._linear=.045,this._quadratic=.0075;break;case 7:this._range=160,this._linear=.027,this._quadratic=.0028;break;case 8:this._range=200,this._linear=.022,this._quadratic=.0019;break;case 9:this._range=325,this._linear=.014,this._quadratic=7e-4;break;case 10:this._range=600,this._linear=.007,this._quadratic=2e-4;break;case 11:this._range=3250,this._linear=.0014,this._quadratic=7e-6;break;default:t.Log.error(!0,"over light range")}},e}();t.Attenuation=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.PHONG="PHONG"]="PHONG",t[t.BLINN="BLINN"]="BLINN",t[t.LAMBERT="LAMBERT"]="LAMBERT",t[t.CONSTANT="CONSTANT"]="CONSTANT"}(t.ELightModel||(t.ELightModel={}));t.ELightModel}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.context=null}return __extends(n,e),Object.defineProperty(n.prototype,"dirty",{get:function(){var t=this.getUIRenderer();return t?t.dirty:!0},set:function(t){if(t){var e=this.getUIRenderer();if(!e)return;e.dirty=t}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"width",{get:function(){return this.entityObject?this.entityObject.transform.width:null},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"height",{get:function(){return this.entityObject?this.entityObject.transform.height:null},enumerable:!0,configurable:!0}),n.prototype.init=function(){this.context=this.getContext()},n.prototype.addToObject=function(t){e.prototype.addToObject.call(this,t),t.uiManager.addChild(this)},n.prototype.removeFromObject=function(t){e.prototype.removeFromObject.call(this,t),t.uiManager.removeChild(this)},n.prototype.update=function(t){var e=this.context;this.shouldNotUpdate()||(e.save(),this._setCanvasTransformForRotation(),this.draw(t),e.restore())},n.prototype.draw=function(t){},n.prototype.shouldNotUpdate=function(){return!1},n.prototype.getContext=function(){return this.getUIRenderer().context},n.prototype.getCanvas=function(){return this.getUIRenderer().canvas},n.prototype.getUIRenderer=function(){return this.entityObject?this.entityObject.getComponent(t.UIRenderer):null},n.prototype.drawInCenterPoint=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=t[0],r=t[1];if(5===t.length){var o=t[2],i=t[3],a=t[4];n.drawImage(r,o.x-i/2,o.y-a/2,i,a)}else if(9===t.length){var s=t[2],c=t[3],u=t[4],l=t[5],o=t[6],i=t[7],a=t[8];n.drawImage(r,s,c,u,l,o.x-i/2,o.y-a/2,i,a)}},n.prototype._setCanvasTransformForRotation=function(){var t=this.entityObject.transform.rotationMatrix;this.context.setTransform(t.a,t.b,t.c,t.d,t.tx,t.ty)},__decorate([t.virtual],n.prototype,"dirty",null),__decorate([t.require(function(e){t.assert(null!==this.context,t.Log.info.FUNC_SHOULD("set context"))})],n.prototype,"update",null),__decorate([t.virtual],n.prototype,"draw",null),__decorate([t.virtual],n.prototype,"shouldNotUpdate",null),n}(t.Component);t.UI=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(t.EFontXAlignment||(t.EFontXAlignment={}));t.EFontXAlignment}(wd||(wd={}));var wd;!function(t){!function(t){t[t.TOP=0]="TOP",t[t.MIDDLE=1]="MIDDLE",t[t.BOTTOM=2]="BOTTOM"}(t.EFontYAlignment||(t.EFontYAlignment={}));t.EFontYAlignment}(wd||(wd={}));var wd;!function(t){!function(t){t[t.AUTO="auto"]="AUTO"}(t.EFontDimension||(t.EFontDimension={}));t.EFontDimension}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.needFormat=!1,this._isFirstUpdate=!0,this._sizeChangeEventSubscription=null}return __extends(n,e),n.prototype.init=function(){var n=this;e.prototype.init.call(this),this._sizeChangeEventSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.UI_WIDTH_CHANGE).merge(t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.UI_HEIGHT_CHANGE)).subscribe(function(){n.dirty=!0,n.needFormat=!0})},n.prototype.dispose=function(){this._sizeChangeEventSubscription&&this._sizeChangeEventSubscription.dispose()},n.prototype.update=function(t){this._isFirstUpdate?this._isFirstUpdate=!1:this.needFormat&&this.reFormat(),this.needFormat=!1,e.prototype.update.call(this,t)},n.prototype.reFormat=function(){},n.prototype.getLeftCornerPosition=function(){var e=this.entityObject.transform,n=e.position;return t.Vector2.create(n.x-e.width/2,n.y-e.height/2)},__decorate([t.virtual],n.prototype,"reFormat",null),n}(t.UI);t.Font=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=/([a-zA-Z0-9]+|\S)/,n=/^[a-zA-Z0-9]/,r=/[a-zA-Z0-9]+$/,o=/\s+$/,i=function(i){function a(){i.apply(this,arguments),this._text="",this._fontSize=10,this._fontFamily="sans-serif",this._xAlignment=t.EFontXAlignment.LEFT,this._yAlignment=t.EFontYAlignment.TOP,this._fillEnabled=!0,this._fillStyle="rgba(0, 0, 0, 1)",this._strokeEnabled=!1,this._strokeStyle=null,this._strokeSize=null,this._fontClientHeightCache=wdCb.Hash.create(),this._lineHeight=null,this._strArr=[]}return __extends(a,i),a.create=function(){var t=new this;return t},Object.defineProperty(a.prototype,"text",{get:function(){return this._text},set:function(t){t!==this._text&&(this._text=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"fontSize",{get:function(){return this._fontSize},set:function(t){t!==this._fontSize&&(this._fontSize=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"fontFamily",{get:function(){return this._fontFamily},set:function(t){t!==this._fontFamily&&(this._fontFamily=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"xAlignment",{get:function(){return this._xAlignment},set:function(t){t!==this._xAlignment&&(this._xAlignment=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"yAlignment",{get:function(){return this._yAlignment},set:function(t){t!==this._yAlignment&&(this._yAlignment=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),a.prototype.init=function(){i.prototype.init.call(this),this._formatText(),this._lineHeight=this._getDefaultLineHeight()},a.prototype.setFillStyle=function(t){this._fillStyle=t},a.prototype.enableStroke=function(t,e){this._strokeEnabled=!0,this._fillEnabled=!1,this._strokeStyle=t,this._strokeSize=e},a.prototype.enableFill=function(t){this._fillEnabled=!0,this._strokeEnabled=!1,this._fillStyle=t},a.prototype.setLineHeight=function(t){this._lineHeight=t},a.prototype.reFormat=function(){this._formatText(),this._lineHeight=this._getDefaultLineHeight()},a.prototype.draw=function(){var t=this.context;t.font=this.fontSize+"px '"+this.fontFamily+"'",t.textBaseline="top",t.textAlign="start",this._strArr.length>1?this._drawMultiLine():this._drawSingleLine()},a.prototype._formatText=function(){var t=this.width;if(this._trimStr(),0!==t){this._strArr=this._text.split("\n");for(var e=0;e<this._strArr.length;e++){var n=this._strArr[e],r=this._measure(n);r>t&&n.length>1&&this._formatMultiLine(e,n,r,t)}}},a.prototype._trimStr=function(){this._text=this._text.replace(o,"")},a.prototype._formatMultiLine=function(t,o,i,a){var s=this,c=100,u=this,l=null,h=o.length*(a/i)|0,p=o.substr(h),f=0,d=i-this._measure(p),_=0,y=function(){for(;d>a&&c>f;)h*=a/d,h=Math.floor(h),p=o.substr(h),d=i-s._measure(p),f+=1;f=0},g=function(){for(;a>d&&c>f;){if(p){var t=e.exec(p);_=t?t[0].length:1}h+=_,p=o.substr(h),d=i-s._measure(p),f+=1}},m=function(){if(n.test(p)){var t=o.substr(0,h),e=r.exec(t);e&&(h-=e[0].length)}else h-=_;0===h&&(h=1)},v=function(){p=o.substr(h),l=o.substr(0,h),u._strArr[t]=p,u._strArr.splice(t,0,l)};y(),g(),m(),v()},a.prototype._measure=function(t){var e=this.context;return e.font=this.fontSize+"px '"+this.fontFamily+"'",e.measureText(t).width},a.prototype._getDefaultLineHeight=function(){return this._computeLineHeight("normal")},a.prototype._computeLineHeight=function(t){var e=wdCb.DomQuery.create("<div></div>"),n=e.get(0),r=null;return n.style.cssText="\n             font-family: "+this.fontFamily+";\n             font-size: "+this.fontSize+"px;\n             position: absolute;\n             left: -100px;\n             top: -100px;\n             line-height: "+t+";\n             ",e.prependTo("body"),n.innerHTML="abc!",r=n.clientHeight,e.remove(),r},a.prototype._getFontClientHeight=function(){var t=this.fontSize,e=this.fontFamily,n=t+"."+e,r=this._fontClientHeightCache.getChild(n),o=null;return r?r:(o=this._computeLineHeight(1),this._fontClientHeightCache.addChild(n,o),o)},a.prototype._drawMultiLine=function(){var e=this.context,n=this.getLeftCornerPosition(),r=n.x,o=n.y,i=this._lineHeight,a=this._getFontClientHeight(),s=this,c=this._strArr.length,u=(c-1)*i+a;s.yAlignment===t.EFontYAlignment.BOTTOM?o=o+s.height-u:s.yAlignment===t.EFontYAlignment.MIDDLE&&(o+=(s.height-u)/2);for(var l=0,h=this._strArr;l<h.length;l++){var p=h[l];s.xAlignment===t.EFontXAlignment.RIGHT?r=r+s.width-s._measure(p):s.xAlignment==t.EFontXAlignment.CENTER&&(r+=(s.width-s._measure(p))/2),s._fillEnabled?(e.fillStyle=s._fillStyle,e.fillText(p,r,o)):s._strokeEnabled&&(e.strokeStyle=s._strokeStyle,e.lineWidth=s._strokeSize,e.strokeText(p,r,o)),r=n.x,o+=i}},a.prototype._drawSingleLine=function(){var e=this.context,n=this.getLeftCornerPosition(),r=n.x,o=n.y,i=this._getFontClientHeight(),a=this,s=i,c=this._strArr[0];a.yAlignment===t.EFontYAlignment.BOTTOM?o=o+a.height-s:a.yAlignment===t.EFontYAlignment.MIDDLE&&(o+=(a.height-s)/2),a.xAlignment===t.EFontXAlignment.RIGHT?r=r+a.width-a._measure(c):a.xAlignment==t.EFontXAlignment.CENTER&&(r+=(a.width-a._measure(c))/2),a._fillEnabled?(e.fillStyle=a._fillStyle,e.fillText(c,r,o)):a._strokeEnabled&&(e.strokeStyle=a._strokeStyle,e.lineWidth=a._strokeSize,e.strokeText(c,r,o))},a}(t.Font);t.PlainFont=i}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._text="",this._xAlignment=t.EFontXAlignment.LEFT,this.fntId=null,this.bitmapId=null,this._charFontList=wdCb.Collection.create()}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"text",{get:function(){return this._text},set:function(t){t!==this._text&&(this._text=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"xAlignment",{get:function(){return this._xAlignment},set:function(t){t!==this._xAlignment&&(this._xAlignment=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),n.prototype.init=function(){var n=this._getFntObj(),r=this._getImageAsset();return n?r?(e.prototype.init.call(this),this._createAndAddFontCharUIObjects(n,r.source),void this._formatText(n)):(t.Log.log("impossible to create font: not find bitmap file"),!1):(t.Log.log("impossible to create font: not find fnt file"),!1)},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._removeAllCharFont()},n.prototype.reFormat=function(){var e=this._getFntObj(),n=this._getImageAsset();return this._removeAllCharFont(),e?n?(this._createAndAddFontCharUIObjects(e,n.source),void this._formatText(e)):(t.Log.log("impossible to create font: not find bitmap file"),!1):(t.Log.log("impossible to create font: not find fnt file"),!1)},n.prototype._getFntObj=function(){return t.LoaderManager.getInstance().get(this.fntId)},n.prototype._getImageAsset=function(){return t.LoaderManager.getInstance().get(this.bitmapId)},n.prototype._createAndAddFontCharUIObjects=function(e,n){for(var r=this.text,o=e.fontDefDictionary,i=0,a=0,s=this.getLeftCornerPosition(),c=this.getUIRenderer(),u=null,l=null,h=0,p=r.length;p>h;h++){var f=String(r.charCodeAt(h)),d=r[h];if(this._isNewLine(d)){var _=this._createAndAddFontCharObjectOfNewLineChar(h,d,c);u=_.charFontUIObject,l=_.charFont,this._setCharFontUIObjectPosition(u,s.x+i,s.y+a),l.startPosX=i,l.xAdvance=0,i=0,a+=e.commonHeight}else{var y=this._getFontDef(o,f),g=null;y?(g=this._createAndAddFontCharObjectOfCommonChar(y,n,h,d,c),u=g.charFontUIObject,l=g.charFont,this._setCharFontUIObjectPosition(u,s.x+i+y.xOffset,s.y+a+y.yOffset),l.startPosX=i,l.xAdvance=y.xAdvance,i+=y.xAdvance):t.Log.log("character not found "+d)}}},n.prototype._createAndAddFontCharObjectOfNewLineChar=function(e,n,r){var o=this._findCharFontUIObject(e),i=null;if(o)i=o.getComponent(t.CharFont);else{var a=this._createCharFont(e,r);o=a.charFontUIObject,i=a.charFont,this._addCharFontUIObject(o)}return i["char"]=n,{charFontUIObject:o,charFont:i}},n.prototype._createAndAddFontCharObjectOfCommonChar=function(e,n,r,o,i){var a=t.RectRegion.create(e.rect.x,e.rect.y,e.rect.width,e.rect.height),s=this._findCharFontUIObject(r),c=null;if(s)c=s.getComponent(t.CharFont);else{var u=this._createCharFont(r,i),l=null;s=u.charFontUIObject,l=s.transform,c=u.charFont,c.image=n,c.rectRegion=a,l.width=a.width,l.height=a.height,this._addCharFontUIObject(s)}return c["char"]=o,{charFontUIObject:s,charFont:c}},n.prototype._formatText=function(t){this.width>0&&this._formatMultiLine(t),this._formatAlign()},n.prototype._formatMultiLine=function(e){for(var n=(this.entityObject,null),r=null,o=this.getLeftCornerPosition(),i=0,a=0,s=e.commonHeight,c=1,u=this.text.length;u>c;c++)if(n=this._findCharFontUIObject(c),r=n.getComponent(t.CharFont),this._isNewLine(r["char"])&&(r.isNewLine=!0,r.isFullLine=!1,this._translateCharFontUIObject(n,-i,a),i=0),this._isExceedWidth(o,r,i)){var l=this._findCharFontUIObject(c-1);if(l){var h=l.getComponent(t.CharFont);h.isNewLine=!0,this._isSpaceUnicode(h["char"])||(h.isFullLine=!0);
}i=this._getLetterPosXLeft(r),a+=s,this._translateCharFontUIObject(n,-i,a)}else this._translateCharFontUIObject(n,-i,a)},n.prototype._formatAlign=function(){var e=this.getLeftCornerPosition(),n=this;if(this._xAlignment!=t.EFontXAlignment.LEFT){var r=[];this._charFontList.forEach(function(o){var i=o.getComponent(t.CharFont);return i.isNewLine?i.isNewLine&&i.isFullLine?void(r=[]):(n._alignLine(e,r,r[r.length-1]),void(r=[])):void r.push(i)}),r.length>0&&n._alignLine(e,r,r[r.length-1])}},n.prototype._createCharFont=function(e,n){var r=t.UIObject.create(),o=t.CharFont.create();return r.addComponent(o),r.addComponent(n),r.addTag(String(e)),r.init(),{charFontUIObject:r,charFont:o}},n.prototype._addCharFontUIObject=function(t){this._charFontList.addChild(t),this.entityObject.addChild(t)},n.prototype._findCharFontUIObject=function(t){return this.entityObject.findChildByTag(String(t))},n.prototype._isSpaceUnicode=function(t){var e=t.charCodeAt(0);return 32==e||133==e||160==e||5760==e||e>=8192&&8202>=e||8232==e||8233==e||8239==e||8287==e||12288==e},n.prototype._isNewLine=function(t){return 10==t.charCodeAt(0)},n.prototype._getLetterPosXLeft=function(t){return t.startPosX},n.prototype._getLetterPosXRight=function(e,n){return t.CoordinateUtils.convertCenterPositionXToLeftCornerPositionX(n.x,n.width)-e.x+n.xAdvance},n.prototype._getFontDef=function(t,e){return t[e]},n.prototype._isExceedWidth=function(t,e,n){return this._getLetterPosXRight(t,e)-n>this.width},n.prototype._alignLine=function(e,n,r){var o=this;n=this._trimBottomSpaceChar(n),r=n[n.length-1],n.forEach(function(n){var i=null,a=o._getLetterPosXRight(e,r);switch(o._xAlignment){case t.EFontXAlignment.CENTER:i=(o.width-a)/2;break;case t.EFontXAlignment.RIGHT:i=o.width-a}n.x=n.x+i})},n.prototype._trimBottomSpaceChar=function(t){var e=t.length-1;for(this._isNewLine(t[e]["char"])&&(e-=1);e>=0&&this._isSpaceUnicode(t[e]["char"]);)e-=1;return t=t.splice(0,e+1)},n.prototype._setCharFontUIObjectPosition=function(e,n,r){var o=e.transform;e.transform.position=t.CoordinateUtils.convertLeftCornerPositionToCenterPosition(t.Vector2.create(n,r),o.width,o.height)},n.prototype._translateCharFontUIObject=function(t,e,n){t.transform.translate(e,n)},n.prototype._removeAllCharFont=function(){this._charFontList.forEach(function(t){t.dispose()}),this._charFontList.removeAllChildren()},__decorate([t.require(function(e){if(this.width>0)for(var n=1,r=this.text.length;r>n;n++){var o=this.entityObject.findChildByTag(String(n));t.assert(!!o,"char not has corresponding entityObject"),t.assert(o.hasComponent(t.CharFont),t.Log.info.FUNC_SHOULD("char entityObject","contain CharFont component"))}})],n.prototype,"_formatText",null),n}(t.Font);t.BitmapFont=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._char=null,this.startPosX=null,this.xAdvance=null,this.image=null,this.rectRegion=null,this.isNewLine=!1,this.isFullLine=!1,this._subscription=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"x",{get:function(){return this.entityObject.transform.position.x},set:function(e){var n=this.entityObject.transform.position;this.entityObject.transform.position=t.Vector2.create(e,n.y)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"y",{get:function(){return this.entityObject.transform.position.y},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"char",{get:function(){return this._char},set:function(e){return null!==this._char?void t.Log.log(t.Log.info.FUNC_NOT_SUPPORT("change char")):void(this._char=e)},enumerable:!0,configurable:!0}),n.prototype.init=function(){var n=this;e.prototype.init.call(this),this._subscription=wdFrp.fromArray([t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_TRANSLATE),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_ROTATE),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_SCALE)]).mergeAll().subscribe(function(){n.dirty=!0})},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._subscription.dispose()},n.prototype.shouldNotUpdate=function(){return null===this.rectRegion||0===this.width&&0===this.height},n.prototype.draw=function(t){var e=null,n=null,r=null,o=null;e=this.entityObject.transform,n=e.position,r=this.width,o=this.height,this.drawInCenterPoint(this.context,this.image,this.rectRegion.x,this.rectRegion.y,this.rectRegion.width,this.rectRegion.height,n,r,o)},__decorate([t.execOnlyOnce("_isInit")],n.prototype,"init",null),n}(t.Font);t.CharFont=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._percent=0,this.borderStyle="rgba(0, 0, 0, 1)",this.fillStyle="rgba(255, 0, 0, 1)",this.radius=5,this._offScreenCanvas=null,this._offScreenContext=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"percent",{get:function(){return this._percent},set:function(t){this._percent!==t&&(this._percent=t,this.dirty=!0)},enumerable:!0,configurable:!0}),n.prototype.init=function(){e.prototype.init.call(this),this._createOffScreenCanvas(),this._drawProgressBar()},n.prototype.shouldNotUpdate=function(){return this.percent<=0},n.prototype.draw=function(t){var e=this.entityObject.transform.position;this._drawFromLeft(e),this._drawBorder(e)},n.prototype._drawFromLeft=function(e){var n=this._offScreenCanvas,r=this.width*this.percent;this.drawInCenterPoint(this.context,n,0,0,r,this.height,t.Vector2.create(e.x-this.width/2+r/2,e.y),r,this.height)},n.prototype._drawBorder=function(e){t.RoundedRectUtils.drawRoundedRect(this.context,this.borderStyle,null,e.x-this.width/2,e.y-this.height/2,this.width,this.height,this.radius)},n.prototype._createOffScreenCanvas=function(){var t=wdCb.DomQuery.create("<canvas></canvas>");t.attr("width",this.context.canvas.width),t.attr("height",this.context.canvas.height),this._offScreenCanvas=t.get(0),this._offScreenContext=this._offScreenCanvas.getContext("2d")},n.prototype._drawProgressBar=function(){this._offScreenContext.clearRect(0,0,this._offScreenCanvas.width,this._offScreenCanvas.height),t.RoundedRectUtils.drawRoundedRect(this._offScreenContext,this.borderStyle,this.fillStyle,0,0,this.width,this.height,this.radius)},__decorate([t.require(function(e){t.assert(this.percent>=0&&this.percent<=1,t.Log.info.FUNC_SHOULD("percent"," >= 0 and <= 1"))})],n.prototype,"draw",null),n}(t.UI);t.ProgressBar=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){function e(){var t=null,e=null;return"undefined"==typeof document?!1:(t=document.createElement("canvas"),t.width=1,t.height=1,e=t.getContext("2d"),e.fillStyle="#000",e.fillRect(0,0,1,1),e.globalCompositeOperation="multiply",e.fillStyle="#fff",e.fillRect(0,0,1,1),0===e.getImageData(0,0,1,1).data[0])}var n=function(n){function r(){n.apply(this,arguments),this._source=null,this.color=null,this.targetSource=null,this.targetColor=null}return __extends(r,n),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"source",{get:function(){return this._source},set:function(t){t!==this._source&&(this._source=t,this.dirty=!0)},enumerable:!0,configurable:!0}),r.prototype.shouldNotUpdate=function(){return null===this._getDrawSource()&&null===this._getDrawColor()},r.prototype.draw=function(t){var e=this._getDrawColor(),n=this._getDrawSource();if(null!==e){var r=this.entityObject.transform.position;this._setFillStyle(e.toString()),e.a<1&&this._setGlobalAlpha(this.context,e.a),this.context.fillRect(r.x-this.width/2,r.y-this.height/2,this.width,this.height),n&&this._blendColorWithSource()}else this.drawInCenterPoint(this.context,n.source,this.entityObject.transform.position,this.width,this.height)},r.prototype._setFillStyle=function(t){this.context.fillStyle=t},r.prototype._getDrawSource=function(){return this.targetSource?this.targetSource:this.source},r.prototype._getDrawColor=function(){return this.targetColor?this.targetColor:this.color},r.prototype._blendByMultiply=function(){this._setGlobalCompositeOperation(this.context,"multiply"),this.drawInCenterPoint(this.context,this._getDrawSource().source,this.entityObject.transform.position,this.width,this.height)},r.prototype._blendByPerPixel=function(){var t=this.context,e=this.getCanvas(),n=this.color.r,r=this.color.g,o=this.color.b,i=null,a=null;t.globalCompositeOperation="copy",this.drawInCenterPoint(this.context,this._getDrawSource().source,this.entityObject.transform.position,this.width,this.height),i=t.getImageData(0,0,e.width,e.height),a=i.data;for(var s=0,c=a.length;c>s;s+=4)a[s]*=n,a[s+1]*=r,a[s+2]*=o;t.putImageData(i,0,0)},r.prototype._setGlobalCompositeOperation=function(t,e){t.globalCompositeOperation=e},r.prototype._setGlobalAlpha=function(t,e){t.globalAlpha=e},r.constructorForBlend=function(t){return t._blendColorWithSource=e()?t._blendByMultiply:t._blendByPerPixel,!0},r.constructorInitForBlend=r.constructorForBlend(r.prototype),__decorate([t.require(function(){t.assert(!!this._getDrawSource(),t.Log.info.FUNC_SHOULD("source","exist"))})],r.prototype,"_blendByMultiply",null),__decorate([t.require(function(){t.assert(!!this._getDrawSource(),t.Log.info.FUNC_SHOULD("source","exist"))})],r.prototype,"_blendByPerPixel",null),r}(t.UI);t.Image=n}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.p_transitionMode=null,this.transitionManager=t.TransitionManager.create(this)}return __extends(n,e),Object.defineProperty(n.prototype,"transitionMode",{get:function(){return this.p_transitionMode},set:function(t){this.p_transitionMode=t},enumerable:!0,configurable:!0}),n}(t.UI);t.InteractionUI=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._text=null,this._mousedownSubscription=null,this._mouseupSubscription=null,this._mouseoverSubscription=null,this._mouseoutSubscription=null,this._stateMachine=t.UIStateMachine.create(this)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"text",{get:function(){var e=null;return null===this.entityObject?this._text:(e=this.getObject(t.EButtonObjectName.TEXT),e?e.getComponent(t.PlainFont).text:null)},set:function(e){var n=null;this._text=e,null!==this.entityObject&&this.getUIRenderer()&&(n=this.getObject(t.EButtonObjectName.TEXT),n?n.getComponent(t.PlainFont).text=e:this.entityObject.addChild(this._createFontObject()))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isDisabled",{get:function(){return this._stateMachine.currentState===t.EUIState.DISABLED},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currentState",{get:function(){return this._stateMachine.currentState},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){this.transitionMode=t.ETransitionMode.SPRITE,this.text="button"},n.prototype.init=function(){e.prototype.init.call(this),this._hasFontObject()||this.entityObject.addChild(this._createFontObject()),this.entityObject.addChild(this._createBackgroundObject()),this._bindEvent()},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._mousedownSubscription.dispose(),this._mouseupSubscription.dispose(),this._mouseoverSubscription.dispose(),this._mouseoutSubscription.dispose()},n.prototype.getObject=function(t){return this.entityObject.findChildByName(t)},n.prototype.getObjectTransition=function(t){return this.transitionManager.getObjectTransition(t)},n.prototype.enable=function(){this._stateMachine.changeState(t.EUIState.NORMAL)},n.prototype.disable=function(){this._stateMachine.changeState(t.EUIState.DISABLED)},n.prototype.update=function(e){var n=this.transitionManager.getObjectTarget(t.EButtonObjectName.BACKGROUND);if(n)switch(this.p_transitionMode){case t.ETransitionMode.SPRITE:this.getObject(t.EButtonObjectName.BACKGROUND).getComponent(t.Image).targetSource=n;break;case t.ETransitionMode.COLOR:this.getObject(t.EButtonObjectName.BACKGROUND).getComponent(t.Image).targetColor=n;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("transitionMode"))}else{var r=this.getObject(t.EButtonObjectName.BACKGROUND).getComponent(t.Image);switch(this.p_transitionMode){case t.ETransitionMode.SPRITE:r.targetSource=null;break;case t.ETransitionMode.COLOR:r.targetColor=null;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("transitionMode"))}}},n.prototype._createBackgroundObject=function(){var e=t.UIObject.create(),n=t.Image.create(),r=this.entityObject.transform;return e.addComponent(n),e.addComponent(this.getUIRenderer()),e.transform.width=r.width,e.transform.height=r.height,e.transform.zIndex=1,e.name=t.EButtonObjectName.BACKGROUND,e},n.prototype._createFontObject=function(){var e=t.UIObject.create(),n=t.PlainFont.create(),r=this.entityObject.transform;return n.text=this._text,n.enableFill("#000000"),n.xAlignment=t.EFontXAlignment.CENTER,n.yAlignment=t.EFontYAlignment.MIDDLE,e.addComponent(n),e.addComponent(this.getUIRenderer()),e.transform.width=r.width,e.transform.height=r.height,e.transform.zIndex=2,e.name=t.EButtonObjectName.TEXT,e},n.prototype._hasFontObject=function(){return!!this.getObject(t.EButtonObjectName.TEXT)},n.prototype._bindEvent=function(){var e=this;this._mousedownSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MOUSE_DOWN).filter(function(t){return!e.isDisabled}).subscribe(function(n){e._stateMachine.changeState(t.EUIState.PRESSED)}),this._mouseupSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MOUSE_UP).filter(function(t){return!e.isDisabled}).subscribe(function(t){e._stateMachine.backState()}),this._mouseoverSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MOUSE_OVER).filter(function(t){return!e.isDisabled}).subscribe(function(n){e._stateMachine.changeState(t.EUIState.HIGHLIGHT)}),this._mouseoutSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MOUSE_OUT).filter(function(t){return!e.isDisabled}).subscribe(function(t){e._stateMachine.backState()})},__decorate([t.require(function(e){t.assert(this.getObject(t.EButtonObjectName.BACKGROUND).hasComponent(t.Image),t.Log.info.FUNC_SHOULD("Button UIObject","contain Image component"))})],n.prototype,"update",null),n}(t.InteractionUI);t.Button=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BACKGROUND="background"]="BACKGROUND",t[t.TEXT="text"]="TEXT"}(t.EButtonObjectName||(t.EButtonObjectName={}));t.EButtonObjectName}(wd||(wd={}));var wd;!function(t){!function(t){t[t.NORMAL=0]="NORMAL",t[t.HIGHLIGHT=1]="HIGHLIGHT",t[t.PRESSED=2]="PRESSED",t[t.DISABLED=3]="DISABLED"}(t.EUIState||(t.EUIState={}));t.EUIState}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this._ui=null,this._stateHistory=wdCb.Stack.create(),this._ui=t}return e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"transitionManager",{get:function(){return this._ui.transitionManager},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentState",{get:function(){return this._stateHistory.top||t.EUIState.NORMAL},enumerable:!0,configurable:!0}),e.prototype.changeState=function(t){this._stateHistory.push(t),this.transitionManager.changeState(t),this._ui.dirty=!0},e.prototype.backState=function(){var e=null;this._stateHistory.pop(),e=this._stateHistory.top,e||(e=t.EUIState.NORMAL),this.transitionManager.changeState(e),this._ui.dirty=!0},e}();t.UIStateMachine=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._target=null}return Object.defineProperty(e.prototype,"target",{get:function(){return null===this._target&&this.changeState(t.EUIState.NORMAL),this._target},set:function(t){this._target=t},enumerable:!0,configurable:!0}),e}();t.Transition=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.normalSprite=null,this.highlightSprite=null,this.pressedSprite=null,this.disabledSprite=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.changeState=function(e){switch(e){case t.EUIState.NORMAL:this.target=this.normalSprite;break;case t.EUIState.HIGHLIGHT:this.target=this.highlightSprite;break;case t.EUIState.PRESSED:this.target=this.pressedSprite;break;case t.EUIState.DISABLED:this.target=this.disabledSprite;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("state"))}},n}(t.Transition);t.SpriteTransition=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.normalColor=null,this.highlightColor=null,this.pressedColor=null,this.disabledColor=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.changeState=function(e){switch(e){case t.EUIState.NORMAL:this.target=this.normalColor;break;case t.EUIState.HIGHLIGHT:this.target=this.highlightColor;break;case t.EUIState.PRESSED:this.target=this.pressedColor;break;case t.EUIState.DISABLED:this.target=this.disabledColor;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("state"))}},n}(t.Transition);t.ColorTransition=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.SPRITE=0]="SPRITE",t[t.COLOR=1]="COLOR"}(t.ETransitionMode||(t.ETransitionMode={}));t.ETransitionMode}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this._ui=null,this._spriteTransitionMap=wdCb.Hash.create(),this._colorTransitionMap=wdCb.Hash.create(),this._ui=t}return e.create=function(t){var e=new this(t);return e},e.prototype.getObjectTransition=function(t){var e=this._getTransitionMap().getChild(t);return e||(e=this._createTransitionInstance(),this._getTransitionMap().addChild(t,e)),e},e.prototype.getObjectTarget=function(t){return this.getObjectTransition(t).target},e.prototype.changeState=function(t){wdFrp.fromArray([this._spriteTransitionMap,this._colorTransitionMap]).subscribe(function(e){e.forEach(function(e){e.changeState(t)})})},e.prototype._getTransitionMap=function(){var e=null;switch(this._ui.transitionMode){case t.ETransitionMode.SPRITE:e=this._spriteTransitionMap;break;case t.ETransitionMode.COLOR:e=this._colorTransitionMap;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("transitionMode"))}return e},e.prototype._createTransitionInstance=function(){var e=null;switch(this._ui.transitionMode){case t.ETransitionMode.SPRITE:e=t.SpriteTransition.create();break;case t.ETransitionMode.COLOR:e=t.ColorTransition.create();break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("transitionMode"))}return e},e}();t.TransitionManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.drawRoundedRect=function(t,e,n,r,o,i,a,s){t.save(),t.beginPath(),i>0?t.moveTo(r+s,o):t.moveTo(r-s,o),t.arcTo(r+i,o,r+i,o+a,s),t.arcTo(r+i,o+a,r,o+a,s),t.arcTo(r,o+a,r,o,s),i>0?t.arcTo(r,o,r+s,o,s):t.arcTo(r,o,r-s,o,s),t.closePath(),t.strokeStyle=e,t.fillStyle=n,e&&t.stroke(),n&&t.fill(),t.restore()},t}();t.RoundedRectUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.isView=function(t){return!!t&&t.offset&&t.width&&t.height&&this.isFunction(t.getContext)},n.isEqual=function(t,e){return!t&&e||t&&!e?!1:t.uid&&e.uid?t.uid===e.uid:t===e},n.isPowerOfTwo=function(t){return 0===(t&t-1)&&0!==t},n.isFloatArray=function(e){return"[object Float32Array]"===t.EntityObject.prototype.toString.call(e)||"[object Float16Array]"===t.EntityObject.prototype.toString.call(e)},n.isInterface=function(t,e){return!!t[e]},n.isSpacePartitionObject=function(e){return e.hasComponent(t.SpacePartition)},n.isSelf=function(t,e){return t.uid===e.uid},n.isComponenet=function(t){return void 0!==t.entityObject},n.isDom=function(t){return null!==Object.prototype.toString.call(t).match(/\[object HTML\w+/)},n}(wdCb.JudgeUtils);t.JudgeUtils=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){}return e.clamp=function(t,e,n){return e>t?e:t>n?n:t},e.bigThan=function(t,e){return e>t?e:t},e.generateZeroToOne=function(){return Math.random()},e.generateInteger=function(t,e){var e=e+1;return Math.floor(Math.random()*(e-t)+t)},__decorate([t.require(function(e,n){t.assert(n>e,t.Log.info.FUNC_SHOULD("min","< max"))})],e,"generateInteger",null),e}();t.MathUtils=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){}return e.convertWebGLPositionToCanvasPosition=function(e){var n=t.DeviceManager.getInstance().view;return t.Vector2.create(n.width/2+e.x,n.height/2-e.y)},e.convertCanvasPositionToWebGLPosition=function(e){var n=t.DeviceManager.getInstance().view;return t.Vector3.create(e.x-n.width/2,n.height/2-e.y,0)},e.convertLeftCornerPositionToCenterPosition=function(e,n,r){return t.Vector2.create(this.convertLeftCornerPositionXToCenterPositionX(e.x,n),this.convertLeftCornerPositionYToCenterPositionY(e.y,r))},e.convertLeftCornerPositionXToCenterPositionX=function(t,e){return t+e/2},e.convertLeftCornerPositionYToCenterPositionY=function(t,e){return t+e/2},e.convertCenterPositionToLeftCornerPosition=function(e,n,r){return t.Vector2.create(this.convertCenterPositionXToLeftCornerPositionX(e.x,n),this.convertCenterPositionYToLeftCornerPositionY(e.y,r))},e.convertCenterPositionXToLeftCornerPositionX=function(t,e){return t-e/2},e.convertCenterPositionYToLeftCornerPositionY=function(t,e){return t-e/2},__decorate([t.require(function(){t.assert(!!t.DeviceManager.getInstance().view,t.Log.info.FUNC_SHOULD("set view"))})],e,"convertWebGLPositionToCanvasPosition",null),__decorate([t.require(function(){t.assert(!!t.DeviceManager.getInstance().view,t.Log.info.FUNC_SHOULD("set view"))})],e,"convertCanvasPositionToWebGLPosition",null),e}();t.CoordinateUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(wdCb.Log);t.Log=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this.elapsed=null,this.pauseElapsed=0,this.pauseTime=null,this.startTime=null}return e.prototype.start=function(){this.startTime=this.getNow(),this.pauseElapsed=null},e.prototype.stop=function(){this.startTime=null},e.prototype.pause=function(){this.pauseTime=this.getNow()},e.prototype.resume=function(){this.pauseElapsed+=this.getNow()-this.pauseTime,this.pauseTime=null},e.prototype.computeElapseTime=function(t){return this.pauseElapsed?this.elapsed=t-this.pauseElapsed-this.startTime:this.elapsed=t-this.startTime,this.elapsed<0&&(this.elapsed=0),this.elapsed},__decorate([t.ensure(function(){t.assert(this.elapsed>=0,t.Log.info.FUNC_SHOULD("elapsed:"+this.elapsed,">= 0"))})],e.prototype,"computeElapseTime",null),e}();t.TimeController=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=60,n=1e3,r=function(r){function o(){r.apply(this,arguments),this.gameTime=null,this.fps=null,this.isTimeChange=!1,this.deltaTime=null,this._lastTime=null}return __extends(o,r),o.create=function(){var t=new this;return t},o.prototype.tick=function(t){this.deltaTime=null!==this._lastTime?t-this._lastTime:t,this._updateFps(this.deltaTime),this.gameTime=t/n,this._lastTime=t},o.prototype.start=function(){r.prototype.start.call(this),this.isTimeChange=!0,this.elapsed=0},o.prototype.resume=function(){r.prototype.resume.call(this),this.isTimeChange=!0},o.prototype.getNow=function(){return t.root.performance.now()},o.prototype._updateFps=function(t){null===this._lastTime?this.fps=e:this.fps=1e3/t},o}(t.TimeController);t.DirectorTimeController=r}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.getNow=function(){return t.Director.getInstance().isTimeChange?t.Director.getInstance().elapsed:t.root.performance.now()},n}(t.TimeController);t.CommonTimeController=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(t){this.texture=null,this.frameBufferOperator=null,this.texture=t}return e.prototype.initWhenCreate=function(){this.frameBufferOperator=t.FrameBuffer.create(this.texture.width,this.texture.height)},e.prototype.init=function(){this.texture.createEmptyTexture(),this.initFrameBuffer()},e.prototype.render=function(t,e){this.beforeRender(),this.renderFrameBufferTexture(t,e),this.afterRender()},e.prototype.dispose=function(){this.frameBufferOperator.dispose(),this.disposeFrameBuffer(),this.texture.dispose()},e.prototype.beforeRender=function(){},e.prototype.afterRender=function(){},__decorate([t.virtual],e.prototype,"beforeRender",null),__decorate([t.virtual],e.prototype,"afterRender",null),e}();t.RenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.frameBuffer=null,this.renderBuffer=null,this._lastCamera=null}return __extends(n,e),n.prototype.initFrameBuffer=function(){var e=this.frameBufferOperator,n=t.DeviceManager.getInstance().gl;this.frameBuffer=e.createFrameBuffer(),this.renderBuffer=e.createRenderBuffer(),e.bindFrameBuffer(this.frameBuffer),e.attachTexture(n.TEXTURE_2D,this.texture.glTexture),e.attachRenderBuffer("DEPTH_ATTACHMENT",this.renderBuffer),e.check(),e.unBind()},n.prototype.renderFrameBufferTexture=function(t,e){var n=this.createCamera(e);this._lastCamera&&this._lastCamera.dispose(),this._lastCamera=n,this.beforeRenderFrameBufferTexture(n),this.frameBufferOperator.bindFrameBuffer(this.frameBuffer),this.texture.bindToUnit(0),this.frameBufferOperator.setViewport(),this.getRenderList().forEach(function(e){e.render(t,n)}),t.clear(),this.renderRenderer(t),this.frameBufferOperator.unBind(),this.frameBufferOperator.restoreViewport()},n.prototype.disposeFrameBuffer=function(){var e=t.DeviceManager.getInstance().gl;e.deleteFramebuffer(this.frameBuffer),e.deleteRenderbuffer(this.renderBuffer)},n}(t.RenderTargetRenderer);t.TwoDRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.beforeRenderFrameBufferTexture=function(t){},n.prototype.getRenderList=function(){return this.texture.renderList},n.prototype.renderRenderer=function(e){this._setSceneSide(t.ESide.BACK),e.render(),this._setSceneSide(null)},n.prototype.createCamera=function(e){var n=null,r=null,o=e.getComponent(t.CameraController),i=null,a=null;return r=this.texture.getPlane(),i=r.getReflectionMatrix().applyMatrix(o.worldToCameraMatrix),a=this._setClipPlane(i,o.pMatrix,r),n=t.PerspectiveCamera.create(),n.worldToCameraMatrix=i.copy(),n.pMatrix=a,t.GameObject.create().addComponent(t.BasicCameraController.create(n)).init()},n.prototype._setSceneSide=function(e){var n=t.Director.getInstance().scene;n.side=e},n.prototype._setClipPlane=function(e,n,r){var o=n.copy(),i=t.Vector4.create(),a=this._getClipPlaneInCameraSpace(e,r),s=t.Vector4.create();
return i.x=(Math.sign(a.x)+o.values[8])/o.values[0],i.y=(Math.sign(a.y)+o.values[9])/o.values[5],i.z=-1,i.w=(1+o.values[10])/o.values[14],s=a.multiplyScalar(2/a.dot(i)),o.values[2]=s.x,o.values[6]=s.y,o.values[10]=s.z+1,o.values[14]=s.w,o},n.prototype._getClipPlaneInCameraSpace=function(e,n){var r=t.Vector4.create(),o=e.multiplyPoint(this.texture.getPosition()),i=e.copy().invert().transpose().multiplyPoint(n.normal).normalize();return r.set(i.x,i.y,i.z,-o.dot(i)),r},n}(t.TwoDRenderTargetRenderer);t.MirrorRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(t){e.call(this,t.shadowMap),this._light=null,this._shadowMapRendererUtils=null,this._light=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.initWhenCreate=function(){this._shadowMapRendererUtils=t.TwoDShadowMapRenderTargetRendererUtils.create(this._light,this.texture),e.prototype.initWhenCreate.call(this)},n.prototype.init=function(){var n=this;this._handleShadowRendererList(),this._shadowMapRendererUtils.bindEndLoop(function(){n._light.shadowRenderList.forEach(function(t){n._shadowMapRendererUtils.clearTwoDShadowMapData(t)})}),this._shadowMapRendererUtils.createShaderWithShaderLib(t.BuildTwoDShadowMapShaderLib.create()),e.prototype.init.call(this)},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._shadowMapRendererUtils.unBindEndLoop()},n.prototype.beforeRenderFrameBufferTexture=function(t){var e=this;this._light.shadowRenderList.removeRepeatItems().forEach(function(n){e._shadowMapRendererUtils.setShadowMapData(n,t)})},n.prototype.getRenderList=function(){return this._light.shadowRenderList},n.prototype.renderRenderer=function(t){t.render()},n.prototype.beforeRender=function(){this._shadowMapRendererUtils.beforeRender()},n.prototype.afterRender=function(){this._shadowMapRendererUtils.afterRender()},n.prototype.createCamera=function(){var e=t.OrthographicCamera.create(),n=this._light,r=t.GameObject.create();return e.left=n.shadowCameraLeft,e.right=n.shadowCameraRight,e.top=n.shadowCameraTop,e.bottom=n.shadowCameraBottom,e.near=n.shadowCameraNear,e.far=n.shadowCameraFar,r.addComponent(t.BasicCameraController.create(e)),r.transform.translate(n.position),r.transform.lookAt(0,0,0),r.init(),r},n.prototype._handleShadowRendererList=function(){var t=this,e=this,n=[];this._light.shadowRenderList.forEach(function(e){n=n.concat(t._shadowMapRendererUtils.addAllChildren(e))},this),this._light.shadowRenderList.addChildren(n),this._light.shadowRenderList.removeChild(function(t){return e._shadowMapRendererUtils.isContainer(t)})},n}(t.TwoDRenderTargetRenderer);t.TwoDShadowMapRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._frameBufferList=wdCb.Collection.create(),this._renderBufferList=wdCb.Collection.create(),this._lastCameraList=null,this._lastPosition=null}return __extends(n,e),n.prototype.initFrameBuffer=function(){for(var e=this.frameBufferOperator,n=t.DeviceManager.getInstance().gl,r=0;6>r;r++){var o=e.createFrameBuffer(),i=e.createRenderBuffer();this._frameBufferList.addChild(o),this._renderBufferList.addChild(i),e.bindFrameBuffer(o),e.attachTexture(n.TEXTURE_CUBE_MAP_POSITIVE_X+r,this.texture.glTexture),e.attachRenderBuffer("DEPTH_ATTACHMENT",i),e.check()}e.unBind()},n.prototype.renderFrameBufferTexture=function(t,e){var n=null,r=null,o=null,i=this.getPosition(),a=null;a=this.getRenderList(),this.texture.bindToUnit(0),this._needCreateCamera(i)&&(o=wdCb.Collection.create());for(var s=0;6>s;s++)r=a.getChild(this._convertIndexToFaceKey(s)),this._isEmpty(r)||(this._needCreateCamera(i)?(n=this.createCamera(s),o.addChild(n)):n=this._lastCameraList.getChild(s),this.frameBufferOperator.bindFrameBuffer(this._frameBufferList.getChild(s)),this.frameBufferOperator.setViewport(),r.forEach(function(e){e.render(t,n)}),t.clear(),t.render());this._needCreateCamera(i)&&(this._lastCameraList&&this._lastCameraList.forEach(function(t){t.dispose()}),this._lastCameraList=o,this._lastPosition=i),this.frameBufferOperator.unBind(),this.frameBufferOperator.restoreViewport()},n.prototype.disposeFrameBuffer=function(){var e=t.DeviceManager.getInstance().gl;this._frameBufferList.forEach(function(t){return e.deleteFramebuffer(t)}),this._renderBufferList.forEach(function(t){return e.deleteRenderbuffer(t)})},n.prototype.createCamera=function(e){var n=t.PerspectiveCamera.create(),r=t.GameObject.create(),o=this.getPosition();return n.fovy=90,this.setCamera(n),r.addComponent(t.BasicCameraController.create(n)),r.transform.translate(o),this._lookAtFace(r,o,e),r.init(),r},n.prototype._isEmpty=function(t){return!t||t.length&&0===t.length||t.getCount&&0===t.getCount()},n.prototype._convertIndexToFaceKey=function(t){var e=null;switch(t){case 0:e="px";break;case 1:e="nx";break;case 2:e="py";break;case 3:e="ny";break;case 4:e="pz";break;case 5:e="nz"}return e},n.prototype._lookAtFace=function(t,e,n){switch(n){case 0:t.transform.lookAt(e.x+1,e.y,e.z,0,-1,0);break;case 1:t.transform.lookAt(e.x-1,e.y,e.z,0,-1,0);break;case 2:t.transform.lookAt(e.x,e.y+1,e.z,0,0,1);break;case 3:t.transform.lookAt(e.x,e.y-1,e.z,0,0,-1);break;case 4:t.transform.lookAt(e.x,e.y,e.z+1,0,-1,0);break;case 5:t.transform.lookAt(e.x,e.y,e.z-1,0,-1,0)}},n.prototype._needCreateCamera=function(t){return null===this._lastPosition||null===this._lastCameraList?!0:!t.isEqual(this._lastPosition)},n}(t.RenderTargetRenderer);t.CubemapRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(t){e.call(this,t.shadowMap),this._light=null,this._shadowMapRendererUtils=null,this._light=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.initWhenCreate=function(){this._shadowMapRendererUtils=t.CubemapShadowMapRenderTargetRendererUtils.create(this._light,this.texture),e.prototype.initWhenCreate.call(this)},n.prototype.init=function(){var n=this;this._handleShadowRendererList(),this._shadowMapRendererUtils.bindEndLoop(function(){n._light.shadowRenderList.forEach(function(t){t.forEach(function(t){n._shadowMapRendererUtils.clearCubemapShadowMapData(t)})})}),this._shadowMapRendererUtils.createShaderWithShaderLib(t.BuildCubemapShadowMapShaderLib.create()),e.prototype.init.call(this)},n.prototype.dispose=function(){e.prototype.dispose.call(this),this._shadowMapRendererUtils.unBindEndLoop()},n.prototype.getRenderList=function(){return this._light.shadowRenderList},n.prototype.beforeRender=function(){var t=this._shadowMapRendererUtils;this._convertRenderListToCollection(this.getRenderList()).removeRepeatItems().forEach(function(e){t.setShadowMapData(e)}),this._shadowMapRendererUtils.beforeRender()},n.prototype.afterRender=function(){this._shadowMapRendererUtils.afterRender()},n.prototype.setCamera=function(t){var e=this._light;t.aspect=e.shadowMapWidth/e.shadowMapHeight,t.near=e.shadowCameraNear,t.far=e.shadowCameraFar},n.prototype.getPosition=function(){return this._light.position},n.prototype._convertRenderListToCollection=function(t){var e=wdCb.Collection.create();return t.forEach(function(t){e.addChildren(t)}),e},n.prototype._handleShadowRendererList=function(){var t=this,e=wdCb.Hash.create();this._light.shadowRenderList.forEach(function(n,r){var o=[];n.forEach(function(e){o=o.concat(t._shadowMapRendererUtils.addAllChildren(e))}),e.addChild(r,o)},this),this._light.shadowRenderList.forEach(function(t,n){t.addChildren(e.getChild(n))}),this._light.shadowRenderList.forEach(function(e){e.removeChild(function(e){return t._shadowMapRendererUtils.isContainer(e)})})},n}(t.CubemapRenderTargetRenderer);t.CubemapShadowMapRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t){var e=new this(t);return e.initWhenCreate(),e},e.prototype.getRenderList=function(){return this.texture.renderList},e.prototype.setCamera=function(t){t.aspect=1,t.near=this.texture.near,t.far=this.texture.far},e.prototype.getPosition=function(){return this.texture.getPosition()},e}(t.CubemapRenderTargetRenderer);t.DynamicCubemapRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e){this.texture=null,this.light=null,this._endLoopSubscription=null,this._shader=null,this.light=t,this.texture=e}return e.prototype.initWhenCreate=function(){this.texture.width=this.light.shadowMapWidth,this.texture.height=this.light.shadowMapHeight},e.prototype.init=function(){this.texture.init()},e.prototype.setShadowMapData=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0],o=r.getComponent(t.Geometry).material,i=null;2===e.length&&(i=e[1]),t.Log.error(!(o instanceof t.LightMaterial),t.Log.info.FUNC_MUST_BE("material","LightMaterial when set shadowMap")),this.setMaterialShadowMapData(o,r,i)},e.prototype.bindEndLoop=function(e){this._endLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.ENDLOOP).subscribe(function(){e()})},e.prototype.unBindEndLoop=function(){this._endLoopSubscription&&this._endLoopSubscription.dispose()},e.prototype.beforeRender=function(){var e=t.Director.getInstance().scene;e.useProgram(this._shader)},e.prototype.afterRender=function(){var e=t.Director.getInstance().scene;e.unUseProgram()},e.prototype.createShaderWithShaderLib=function(e){this._shader=t.Shader.create(),this._shader.addLib(t.CommonShaderLib.create()),this._shader.addLib(t.CommonVerticeShaderLib.create()),this._shader.addLib(e)},e.prototype.isContainer=function(e){return!e.hasComponent(t.Geometry)},e.prototype.addAllChildren=function(t){var e=[],n=function(t){t.forEach(function(t){e.push(t),n(t)})};return n(t),e},e.prototype.setShadowMap=function(e,n){var r=null;e.hasComponent(t.Geometry)&&(r=e.getComponent(t.Geometry).material,r.hasShadowMap(n)||(t.Log.error(!(r instanceof t.LightMaterial),t.Log.info.FUNC_MUST_BE("material","LightMaterial when set shadowMap")),this.addShadowMap(r,n)))},e}();t.ShadowMapRenderTargetRendererUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n.initWhenCreate(),n},n.prototype.initWhenCreate=function(){var t=this;e.prototype.initWhenCreate.call(this),this.light.shadowRenderList.forEach(function(e){e.forEach(function(e){t.setShadowMap(e,t.texture)})})},n.prototype.clearCubemapShadowMapData=function(e){var n=e.getComponent(t.Geometry).material;n.clearCubemapShadowMapData()},n.prototype.setMaterialShadowMapData=function(t,e,n){t.addCubemapShadowMapData({shadowBias:this.light.shadowBias,shadowDarkness:this.light.shadowDarkness,lightPos:this.light.position,farPlane:this.light.shadowCameraFar}),t.buildCubemapShadowMapData={lightPos:this.light.position,farPlane:this.light.shadowCameraFar}},n.prototype.addShadowMap=function(t,e){t.addCubemapShadowMap(e)},__decorate([t.require(function(e){var n=e.getComponent(t.Geometry).material;t.assert(n instanceof t.LightMaterial,t.Log.info.FUNC_MUST_BE("material","LightMaterial when set shadowMap"))})],n.prototype,"clearCubemapShadowMapData",null),n}(t.ShadowMapRenderTargetRendererUtils);t.CubemapShadowMapRenderTargetRendererUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t,e){var n=new this(t,e);return n.initWhenCreate(),n},n.prototype.initWhenCreate=function(){var t=this;e.prototype.initWhenCreate.call(this),this.light.shadowRenderList.forEach(function(e){t.setShadowMap(e,t.texture)})},n.prototype.clearTwoDShadowMapData=function(e){var n=e.getComponent(t.Geometry).material;n.clearTwoDShadowMapData()},n.prototype.setMaterialShadowMapData=function(e,n,r){var o=r.getComponent(t.CameraController);e.addTwoDShadowMapData({shadowBias:this.light.shadowBias,shadowDarkness:this.light.shadowDarkness,shadowSize:[this.light.shadowMapWidth,this.light.shadowMapHeight],lightPos:this.light.position,vpMatrixFromLight:o.worldToCameraMatrix.applyMatrix(o.pMatrix,!0)}),e.buildTwoDShadowMapData={vpMatrixFromLight:o.worldToCameraMatrix.applyMatrix(o.pMatrix,!0)}},n.prototype.addShadowMap=function(t,e){t.addTwoDShadowMap(e)},__decorate([t.require(function(e){var n=e.getComponent(t.Geometry).material;t.assert(n instanceof t.LightMaterial,t.Log.info.FUNC_MUST_BE("material","LightMaterial when set shadowMap"))})],n.prototype,"clearTwoDShadowMapData",null),n}(t.ShadowMapRenderTargetRendererUtils);t.TwoDShadowMapRenderTargetRendererUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this.skyboxCommand=null}return t.prototype.init=function(){},t}();t.Renderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._commandQueue=wdCb.Collection.create(),this._clearOptions={color:t.Color.create("#ffffff")}}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.createQuadCommand=function(){return t.QuadCommand.create()},n.prototype.addCommand=function(t){this._commandQueue.hasChild(t)||(this._commandQueue.addChild(t),t.init())},n.prototype.hasCommand=function(){return this._commandQueue.getCount()>0||!!this.skyboxCommand},n.prototype.clear=function(){t.DeviceManager.getInstance().clear(this._clearOptions)},n.prototype.render=function(){var e=t.DeviceManager.getInstance(),n=[];this._commandQueue.forEach(function(t){t.blend?n.push(t):t.execute()}),n.length>0&&(e.depthWrite=!1,this._renderSortedTransparentCommands(n),e.depthWrite=!0),this.skyboxCommand&&(e.depthFunc=t.EDepthFunction.LEQUAL,this.skyboxCommand.execute(),e.depthFunc=t.EDepthFunction.LESS),this._clearCommand()},n.prototype.init=function(){var e=t.DeviceManager.getInstance();e.depthTest=!0,e.blend=!1,e.setColorWrite(!0,!0,!0,!0),e.side=t.ESide.FRONT,e.depthWrite=!0},n.prototype.setClearColor=function(t){this._setClearOptions({color:t})},n.prototype._renderSortedTransparentCommands=function(e){var n=this,r=t.Director.getInstance().scene.currentCamera.transform.position.z;e.sort(function(t,e){return n._getObjectToCameraZDistance(r,e)-n._getObjectToCameraZDistance(r,t)}).forEach(function(t){t.execute()})},n.prototype._getObjectToCameraZDistance=function(t,e){return t-e.z},n.prototype._clearCommand=function(){this._commandQueue.removeAllChildren(),this.skyboxCommand=null},n.prototype._setClearOptions=function(t){wdCb.ExtendUtils.extend(this._clearOptions,t)},__decorate([t.require(function(e){t.assert(!!t.Director.getInstance().scene.currentCamera,t.Log.info.FUNC_NOT_EXIST("current camera"))})],n.prototype,"_renderSortedTransparentCommands",null),n}(t.Renderer);t.WebGLRenderer=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.POINTS="POINTS"]="POINTS",t[t.LINES="LINES"]="LINES",t[t.LINE_LOOP="LINE_LOOP"]="LINE_LOOP",t[t.LINE_STRIP="LINE_STRIP"]="LINE_STRIP",t[t.TRIANGLES="TRIANGLES"]="TRIANGLES",t[t.TRIANGLE_STRIP="TRIANGLE_STRIP"]="TRIANGLE_STRIP",t[t.TRANGLE_FAN="TRIANGLE_FAN"]="TRANGLE_FAN"}(t.EDrawMode||(t.EDrawMode={}));t.EDrawMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BYTE="BYTE"]="BYTE",t[t.UNSIGNED_BYTE="UNSIGNED_BYTE"]="UNSIGNED_BYTE",t[t.SHORT="SHORT"]="SHORT",t[t.UNSIGNED_SHORT="UNSIGNED_SHORT"]="UNSIGNED_SHORT",t[t.INT="INT"]="INT",t[t.UNSIGNED_INT="UNSIGNED_INT"]="UNSIGNED_INT",t[t.FLOAT="FLOAT"]="FLOAT"}(t.EBufferType||(t.EBufferType={}));t.EBufferType}(wd||(wd={}));var wd;!function(t){!function(t){t[t.VERTICE="VERTICE"]="VERTICE",t[t.INDICE="INDICE"]="INDICE",t[t.NORMAL="NORMAL"]="NORMAL",t[t.TEXCOORD="TEXCOORD"]="TEXCOORD",t[t.TANGENT="TANGENT"]="TANGENT",t[t.COLOR="COLOR"]="COLOR"}(t.EBufferDataType||(t.EBufferDataType={}));t.EBufferDataType}(wd||(wd={}));var wd;!function(t){!function(t){t[t.STREAM_DRAW="STREAM_DRAW"]="STREAM_DRAW",t[t.STATIC_DRAW="STATIC_DRAW"]="STATIC_DRAW",t[t.DYNAMIC_DRAW="DYNAMIC_DRAW"]="DYNAMIC_DRAW"}(t.EBufferUsage||(t.EBufferUsage={}));t.EBufferUsage}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.buffer=null,this.type=null,this.count=null}return e.prototype.dispose=function(){t.DeviceManager.getInstance().gl.deleteBuffer(this.buffer),delete this.buffer},e}();t.Buffer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._typeSize=null,this.data=null,this._type=null}return __extends(n,e),n.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=new this;return n.initWhenCreate.apply(n,t),n},Object.defineProperty(n.prototype,"typeSize",{get:function(){return this._typeSize},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.DeviceManager.getInstance().gl;if(this.buffer=r.createBuffer(),!this.buffer)return t.Log.log("Failed to create the this.buffer object"),null;if(0!==e.length){var o=e[0],i=e[1],a=e[2]||t.EBufferUsage.STATIC_DRAW;return o&&this._checkDataType(o,i)?(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.buffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,o,r[a]),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),this.type=r[i],this._type=i,this.count=o.length,this.data=o,this._typeSize=this._getInfo(i).size,this.buffer):null}},n.prototype.resetData=function(e,n){void 0===n&&(n=this._type);var r=t.DeviceManager.getInstance().gl;return r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.buffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,e,r.DYNAMIC_DRAW),this.type=r[n],this._type=n,this.data=e,this.count=e.length,this._typeSize=this._getInfo(n).size,this},n.prototype._checkDataType=function(t,e){var n=this._getInfo(e);return t instanceof n.typeClass},n.prototype._getInfo=function(e){var n=null;switch(e){case t.EBufferType.UNSIGNED_BYTE:n={typeClass:Uint8Array,size:1};break;case t.EBufferType.SHORT:n={typeClass:Int16Array,size:2};break;case t.EBufferType.UNSIGNED_SHORT:n={typeClass:Uint16Array,size:2};break;case t.EBufferType.INT:n={typeClass:Int32Array,size:4};break;case t.EBufferType.UNSIGNED_INT:n={typeClass:Uint32Array,size:4};break;case t.EBufferType.FLOAT:n={typeClass:Float32Array,size:4};break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EBufferType"))}return n},__decorate([t.require(function(e,n){void 0===n&&(n=this._type),t.assert(this.buffer,t.Log.info.FUNC_MUST("create gl buffer"))})],n.prototype,"resetData",null),n}(t.Buffer);t.ElementBuffer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.size=null,this.data=null,this._type=null}return __extends(n,e),n.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=new this;return n.initWhenCreate.apply(n,t),n},n.prototype.initWhenCreate=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.DeviceManager.getInstance().gl;if(this.buffer=r.createBuffer(),!this.buffer)return t.Log.log("Failed to create the this.buffer object"),null;if(0!==e.length){var o=e[0],i=e[1],a=e[2],s=e[3]||t.EBufferUsage.STATIC_DRAW;return o?(r.bindBuffer(r.ARRAY_BUFFER,this.buffer),r.bufferData(r.ARRAY_BUFFER,o,r[s]),r.bindBuffer(r.ARRAY_BUFFER,null),this.size=i,this.type=r[a],this._type=a,this.count=o.length/i,this.data=o,this.buffer):null}},n.prototype.resetData=function(e,n,r){void 0===n&&(n=this.size),void 0===r&&(r=this._type);var o=t.DeviceManager.getInstance().gl;return o.bindBuffer(o.ARRAY_BUFFER,this.buffer),o.bufferData(o.ARRAY_BUFFER,e,o.DYNAMIC_DRAW),this.size=n,this.type=o[r],this._type=r,this.count=e.length/n,this.data=e,this},__decorate([t.require(function(e,n,r){void 0===n&&(n=this.size),void 0===r&&(r=this._type),t.assert(this.buffer,t.Log.info.FUNC_MUST("create gl buffer"))})],n.prototype,"resetData",null),n}(t.Buffer);t.ArrayBuffer=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=wdCb.Hash.create();e.addChild(t.EBufferDataType.VERTICE,"vertices"),e.addChild(t.EBufferDataType.INDICE,"indices"),e.addChild(t.EBufferDataType.NORMAL,"normals"),e.addChild(t.EBufferDataType.TEXCOORD,"texCoords"),e.addChild(t.EBufferDataType.COLOR,"colors"),e.addChild(t.EBufferDataType.TANGENT,"tangents");var n=function(){function n(){}return n.getGeometryDataName=function(t){var n=e.getChild(t);return n},__decorate([t.ensure(function(e,n){t.Log.error(void 0===e,t.Log.info.FUNC_NOT_EXIST(n,"in BufferDataTable"))})],n,"getGeometryDataName",null),n}();t.BufferDataTable=n}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this._program=null,this._shader=null,this._getAttribLocationCache=wdCb.Hash.create(),this._getUniformLocationCache=wdCb.Hash.create(),this._attributesFromCustomShaderCache=null,this._uniformsFromCustomShaderCache=null}return e.create=function(){var t=new this;return t},e.prototype.use=function(){t.DeviceManager.getInstance().gl.useProgram(this._program)},e.prototype.getUniformLocation=function(e){var n=null;return this._shader.dirty||(n=this._getUniformLocationCache.getChild(e),void 0===n)?(n=t.DeviceManager.getInstance().gl.getUniformLocation(this._program,e),this._getUniformLocationCache.addChild(e,n),n):n},e.prototype.sendUniformData=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.DeviceManager.getInstance().gl,o=null,i=null,a=null;if(i=e[1],a=e[2],t.JudgeUtils.isString(e[0])){var s=e[0];o=this.getUniformLocation(s)}else o=e[0];if(!this.isUniformDataNotExistByLocation(o)&&null!==a)switch(t.JudgeUtils.isFunction(a)&&(a=a()),i){case t.EVariableType.FLOAT_1:r.uniform1f(o,a);break;case t.EVariableType.FLOAT_2:r.uniform2f(o,a[0],a[1]);break;case t.EVariableType.FLOAT_3:a=this._convertToArray3(a),r.uniform3f(o,a[0],a[1],a[2]);break;case t.EVariableType.FLOAT_4:a=this._convertToArray4(a),r.uniform4f(o,a[0],a[1],a[2],a[3]);break;case t.EVariableType.FLOAT_MAT3:r.uniformMatrix3fv(o,!1,a.values);break;case t.EVariableType.FLOAT_MAT4:r.uniformMatrix4fv(o,!1,a.values);break;case t.EVariableType.NUMBER_1:case t.EVariableType.SAMPLER_CUBE:case t.EVariableType.SAMPLER_2D:r.uniform1i(o,a);break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EVariableType:",i))}},e.prototype.sendUniformDataFromCustomShader=function(){var e=this;this._getUniformsFromCustomShader().forEach(function(n,r){if(n.type===t.EVariableType.STRUCTURE)for(var o in n.value)e.sendStructureData(r+"."+o,n.value[o].type,n.value[o].value);else e.sendUniformData(r,n.type,n.value)})},e.prototype.sendAttributeData=function(e,n,r){var o=t.DeviceManager.getInstance().gl,i=null,a=null;if(i=this._getAttribLocation(o,e),-1!==i&&null!==r)switch(a=t.JudgeUtils.isFunction(r)?r():r,n){case t.EVariableType.BUFFER:o.bindBuffer(o.ARRAY_BUFFER,a.buffer),o.vertexAttribPointer(i,a.size,a.type,!1,0,0),o.enableVertexAttribArray(i);break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EVariableType:",n))}},e.prototype.sendAttributeDataFromCustomShader=function(){var t=this;this._getAttributesFromCustomShader().forEach(function(e,n){t.sendAttributeData(n,t._convertAttributeDataType(e),e.value)})},e.prototype.sendStructureData=function(t,e,n){this.sendUniformData(t,e,n)},e.prototype.initWithShader=function(e){var n=t.DeviceManager.getInstance().gl,r=null,o=null;return this._program=t.DeviceManager.getInstance().gl.createProgram(),r=e.createVsShader(),o=e.createFsShader(),this._shader=e,n.attachShader(this._program,r),n.attachShader(this._program,o),n.bindAttribLocation(this._program,0,"a_position"),n.linkProgram(this._program),t.Log.error(n.getProgramParameter(this._program,n.LINK_STATUS)===!1,n.getProgramInfoLog(this._program)),n.deleteShader(r),n.deleteShader(o),this},e.prototype.dispose=function(){var e=t.DeviceManager.getInstance().gl;e.deleteProgram(this._program),this._program=void 0},e.prototype.isUniformDataNotExistByLocation=function(t){return null===t},e.prototype._convertAttributeDataType=function(e){return t.EVariableType.BUFFER},e.prototype._convertToArray3=function(e){return t.JudgeUtils.isArray(e)?e:[e.x,e.y,e.z]},e.prototype._convertToArray4=function(e){return t.JudgeUtils.isArray(e)?e:[e.x,e.y,e.z,e.w]},e.prototype._getAttribLocation=function(t,e){var n=null;return this._shader.dirty||(n=this._getAttribLocationCache.getChild(e),void 0===n)?(n=t.getAttribLocation(this._program,e),this._getAttribLocationCache.addChild(e,n),n):n},e.prototype._getAttributesFromCustomShader=function(){return this._shader.attributes.filter(function(e){return e.value!==t.EVariableCategory.ENGINE})},e.prototype._getUniformsFromCustomShader=function(){return this._shader.uniforms.filter(function(e){return e.value!==t.EVariableCategory.ENGINE})},__decorate([t.require(function(){this._shader.uniforms.filter(function(e){return e.value!==t.EVariableCategory.ENGINE}).forEach(function(e,n){e.type===t.EVariableType.STRUCTURE&&t.Log.error(!t.JudgeUtils.isDirectObject(e.value),t.Log.info.FUNC_MUST_BE("value's type","object{}"))})})],e.prototype,"sendUniformDataFromCustomShader",null),__decorate([t.require(function(e,n,r){r&&t.JudgeUtils.isFunction(r)&&t.Log.error(!(r instanceof t.ArrayBuffer),t.Log.info.FUNC_MUST_BE("ArrayBuffer"))})],e.prototype,"sendAttributeData",null),__decorate([t.require(function(e){t.assert(t.JudgeUtils.isArray(e)||e instanceof t.Vector3,t.Log.info.FUNC_MUST_BE("shader->attributes->value","Array<Array<any>> or Array<Vector3> stucture"))})],e.prototype,"_convertToArray3",null),__decorate([t.require(function(e){t.assert(t.JudgeUtils.isArray(e)||e instanceof t.Vector4,t.Log.info.FUNC_MUST_BE("shader->attributes->value","Array<Array<any>> or Array<Vector4> stucture"))})],e.prototype,"_convertToArray4",null),__decorate([t.cache(function(){return!this._shader.dirty&&null!==this._attributesFromCustomShaderCache},function(){return this._attributesFromCustomShaderCache},function(t){this._attributesFromCustomShaderCache=t})],e.prototype,"_getAttributesFromCustomShader",null),__decorate([t.cache(function(){return!this._shader.dirty&&null!==this._uniformsFromCustomShaderCache},function(){return this._uniformsFromCustomShaderCache},function(t){this._uniformsFromCustomShaderCache=t})],e.prototype,"_getUniformsFromCustomShader",null),e}();t.Program=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this._mMatrix=null,this.buffers=null,this.vMatrix=null,this.pMatrix=null,this.drawMode=t.EDrawMode.TRIANGLES,this.z=null,this.blend=!1,this.material=null,this.animation=null,this._normalMatrixCache=null}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"program",{get:function(){return this.material.program},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normalMatrix",{get:function(){return this.mMatrix.invertTo3x3().transpose()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mMatrix",{get:function(){return this._mMatrix},set:function(t){this._mMatrix=t,this._normalMatrixCache=null},enumerable:!0,configurable:!0}),e.prototype.execute=function(){var t=this.material;t.updateTexture(),t.updateShader(this),this._draw(t)},e.prototype.init=function(){},e.prototype._draw=function(e){var n=0,r=0,o=null,i=null,a=t.DeviceManager.getInstance().gl;this._setEffects(e),i=this.buffers.getChild(t.EBufferDataType.INDICE),i?(n=i.count,a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,i.buffer),t.GlUtils.drawElements(a[this.drawMode],n,i.type,i.typeSize*r)):(o=this.buffers.getChild(t.EBufferDataType.VERTICE),n=o.count,t.GlUtils.drawArrays(a[this.drawMode],r,n))},e.prototype._setEffects=function(e){var n=t.DeviceManager.getInstance();n.setColorWrite(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),n.polygonOffsetMode=e.polygonOffsetMode,
n.side=this._getSide(),n.blend=e.blend,e.blendFuncSeparate&&e.blendEquationSeparate?(n.setBlendFuncSeparate(e.blendFuncSeparate),n.setBlendEquationSeparate(e.blendEquationSeparate)):(n.setBlendFunc(e.blendSrc,e.blendDst),n.setBlendEquation(e.blendEquation))},e.prototype._getSide=function(){var e=t.Director.getInstance().scene;return e.side?e.side:this.material.side},__decorate([t.requireGetter(function(){t.assert(!!this.mMatrix,t.Log.info.FUNC_NOT_EXIST("mMatrix"))}),t.cacheGetter(function(){return null!==this._normalMatrixCache},function(){return this._normalMatrixCache},function(t){this._normalMatrixCache=t})],e.prototype,"normalMatrix",null),__decorate([t.require(function(t){t.blendFuncSeparate&&t.blendEquationSeparate||wdCb.Log.error(!t.blendSrc||!t.blendDst||!t.blendEquation,wdCb.Log.info.FUNC_MUST("material.blendSrc || material.blendDst || material.blendEquation","be set"))})],e.prototype,"_setEffects",null),e}();t.QuadCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.drawElements=function(e,n,r,o){t.DebugStatistics.count.drawCalls++,this._getGl().drawElements(e,n,r,o)},e.drawArrays=function(e,n,r){t.DebugStatistics.count.drawCalls++,this._getGl().drawArrays(e,n,r)},e._getGl=function(){return t.DeviceManager.getInstance().gl},e}();t.GlUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e){this.width=null,this.height=null,this._originScissorTest=null,this.width=t,this.height=e}return e.create=function(t,e){var n=new this(t,e);return n},Object.defineProperty(e.prototype,"gl",{get:function(){return t.DeviceManager.getInstance().gl},enumerable:!0,configurable:!0}),e.prototype.createFrameBuffer=function(){return this.gl.createFramebuffer()},e.prototype.bindFrameBuffer=function(t){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t)},e.prototype.setViewport=function(){var e=t.DeviceManager.getInstance();e.setViewport(0,0,this.width,this.height),this._originScissorTest=e.scissorTest,e.scissorTest=!1},e.prototype.restoreViewport=function(){var e=t.DeviceManager.getInstance(),n=e.view;e.setViewport(0,0,n.width,n.height),e.scissorTest=this._originScissorTest},e.prototype.dispose=function(){this.unBind()},e.prototype.unBind=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},e.prototype.createRenderBuffer=function(){var e=this.gl,n=e.createRenderbuffer();return t.Log.error(!n,"Failed to create renderbuffer object"),n},e.prototype.attachTexture=function(t,e){var n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,t,e,0)},e.prototype.attachRenderBuffer=function(t,e){var n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,e),n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_COMPONENT16,this.width,this.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n[t],n.RENDERBUFFER,e)},e.prototype.check=function(){var e=this.gl,n=e.checkFramebufferStatus(e.FRAMEBUFFER);n!==e.FRAMEBUFFER_COMPLETE&&t.Log.error(!0,"Frame buffer object is incomplete:"+n.toString())},e}();t.FrameBuffer=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this._attributes=wdCb.Hash.create(),this._uniforms=wdCb.Hash.create(),this._vsSource="",this._fsSource="",this.program=t.Program.create(),this.libDirty=!0,this._definitionDataDirty=!0,this._libs=wdCb.Collection.create(),this._sourceBuilder=t.ShaderSourceBuilder.create()}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"attributes",{get:function(){return this._attributes},set:function(t){this._isNotEqual(t,this._attributes)&&(this._definitionDataDirty=!0),this._attributes=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uniforms",{get:function(){return this._uniforms},set:function(t){this._isNotEqual(t,this._uniforms)&&(this._definitionDataDirty=!0),this._uniforms=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"vsSource",{get:function(){return this._vsSource},set:function(t){t!==this._vsSource&&(this._definitionDataDirty=!0),this._vsSource=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fsSource",{get:function(){return this._fsSource},set:function(t){t!==this._fsSource&&(this._definitionDataDirty=!0),this._fsSource=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dirty",{get:function(){return this.libDirty||this._definitionDataDirty},enumerable:!0,configurable:!0}),e.prototype.createVsShader=function(){var e=t.DeviceManager.getInstance().gl;return this._initShader(e.createShader(e.VERTEX_SHADER),this.vsSource)},e.prototype.createFsShader=function(){var e=t.DeviceManager.getInstance().gl;return this._initShader(e.createShader(e.FRAGMENT_SHADER),this.fsSource)},e.prototype.isEqual=function(t){return this.vsSource===t.vsSource&&this.fsSource===t.fsSource},e.prototype.init=function(){this._libs.forEach(function(t){t.init()}),this.judgeRefreshShader()},e.prototype.dispose=function(){this.program.dispose(),this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this._libs.forEach(function(t){t.dispose()})},e.prototype.update=function(t,e){var n=this.program;this.judgeRefreshShader(),this.program.use(),this._libs.forEach(function(r){r.sendShaderVariables(n,t,e)}),n.sendAttributeDataFromCustomShader(),n.sendUniformDataFromCustomShader(),e.mapManager.sendData(n)},e.prototype.judgeRefreshShader=function(){this.libDirty&&this.buildDefinitionData(null,t.LightMaterial.create()),this._definitionDataDirty&&this.program.initWithShader(this),this.libDirty=!1,this._definitionDataDirty=!1},e.prototype.hasLib=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(e[0]instanceof t.ShaderLib){var r=e[0];return this._libs.hasChild(r)}var o=e[0];return this._libs.hasChildWithFunc(function(t){return t instanceof o})},e.prototype.addLib=function(t){this._libs.addChild(t),t.shader=this,this.libDirty=!0},e.prototype.addShaderLibToTop=function(t){this._libs.unShiftChild(t),t.shader=this,this.libDirty=!0},e.prototype.getLib=function(t){return this._libs.findOne(function(e){return e instanceof t})},e.prototype.getLibs=function(){return this._libs},e.prototype.removeLib=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.libDirty=!0,this._libs.removeChild(t[0])},e.prototype.removeAllLibs=function(){this.libDirty=!0,this._libs.removeAllChildren()},e.prototype.sortLib=function(t){this.libDirty=!0,this._libs=this._libs.sort(t)},e.prototype.read=function(t){this._sourceBuilder.read(t),this.libDirty=!0},e.prototype.buildDefinitionData=function(t,e){this._libs.forEach(function(n){n.setShaderDefinition(t,e)}),this._sourceBuilder.clearShaderDefinition(),this._sourceBuilder.build(this._libs),this.attributes=this._sourceBuilder.attributes,this.uniforms=this._sourceBuilder.uniforms,this.vsSource=this._sourceBuilder.vsSource,this.fsSource=this._sourceBuilder.fsSource},e.prototype._initShader=function(e,n){var r=t.DeviceManager.getInstance().gl;return r.shaderSource(e,n),r.compileShader(e),r.getShaderParameter(e,r.COMPILE_STATUS)?e:(t.Log.log(r.getShaderInfoLog(e)),t.Log.log("attributes:\n",this.attributes),t.Log.log("uniforms:\n",this.uniforms),t.Log.log("source:\n",n),void 0)},e.prototype._isNotEqual=function(t,e){var n=!1;return t.forEach(function(t,r){var o=e.getChild(r);return o&&t.type===o.type&&t.value===o.value?void 0:(n=!0,wdCb.$BREAK)}),n},__decorate([t.ensure(function(){var e=this;this._libs.forEach(function(n){t.assert(t.JudgeUtils.isEqual(n.shader,e),t.Log.info.FUNC_SHOULD("set ShaderLib.shader to be this"))}),t.assert(this.libDirty===!0,t.Log.info.FUNC_SHOULD("libDirty","be true"))})],e.prototype,"addLib",null),__decorate([t.ensure(function(){var e=this;this._libs.forEach(function(n){t.assert(t.JudgeUtils.isEqual(n.shader,e),t.Log.info.FUNC_SHOULD("set ShaderLib.shader to be this"))}),t.assert(this.libDirty===!0,t.Log.info.FUNC_SHOULD("libDirty","be true"))})],e.prototype,"addShaderLibToTop",null),e}();t.Shader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.attributes=wdCb.Hash.create(),this.uniforms=wdCb.Hash.create(),this.vsSource="",this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.fsSource="",this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.vsSourceDefineList=wdCb.Collection.create(),this.fsSourceDefineList=wdCb.Collection.create(),this.attributesFromShaderLib=wdCb.Hash.create(),this.uniformsFromShaderLib=wdCb.Hash.create(),this.vsSourceTopFromShaderLib="",this.vsSourceDefineFromShaderLib="",this.vsSourceVarDeclareFromShaderLib="",this.vsSourceFuncDeclareFromShaderLib="",this.vsSourceFuncDefineFromShaderLib="",this.vsSourceBodyFromShaderLib="",this.fsSourceTopFromShaderLib="",this.fsSourceDefineFromShaderLib="",this.fsSourceVarDeclareFromShaderLib="",this.fsSourceFuncDeclareFromShaderLib="",this.fsSourceFuncDefineFromShaderLib="",this.fsSourceBodyFromShaderLib=""}return e.create=function(){var t=new this;return t},e.prototype.read=function(t){t.attributes&&(this.attributesFromShaderLib=t.attributes instanceof wdCb.Hash?t.attributes:wdCb.Hash.create(t.attributes)),t.uniforms&&(this.uniformsFromShaderLib=t.uniforms instanceof wdCb.Hash?t.uniforms:wdCb.Hash.create(t.uniforms)),this.vsSourceTopFromShaderLib=t.vsSourceTop||"",this.vsSourceDefineFromShaderLib=t.vsSourceDefine||"",this.vsSourceVarDeclareFromShaderLib=t.vsSourceVarDeclare||"",this.vsSourceFuncDeclareFromShaderLib=t.vsSourceFuncDeclare||"",this.vsSourceFuncDefineFromShaderLib=t.vsSourceFuncDefine||"",this.vsSourceBodyFromShaderLib=t.vsSourceBody||"",this.fsSourceTopFromShaderLib=t.fsSourceTop||"",this.fsSourceDefineFromShaderLib=t.fsSourceDefine||"",this.fsSourceVarDeclareFromShaderLib=t.fsSourceVarDeclare||"",this.fsSourceFuncDeclareFromShaderLib=t.fsSourceFuncDeclare||"",this.fsSourceFuncDefineFromShaderLib=t.fsSourceFuncDefine||"",this.fsSourceBodyFromShaderLib=t.fsSourceBody||""},e.prototype.build=function(e){var n=this;this._readLibSource(e),this._buildVsSource(),this._buildFsSource(),this.attributes.filter(function(e){return(t.JudgeUtils.isArrayExactly(e.value)||t.JudgeUtils.isFloatArray(e.value))&&e.value!==t.EVariableCategory.ENGINE}).forEach(function(t,e){t.value=n._convertArrayToArrayBuffer(t.type,t.value)})},e.prototype.clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSourceDefineList.removeAllChildren(),this.fsSourceDefineList.removeAllChildren(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody=""},e.prototype.dispose=function(){this.clearShaderDefinition(),this.attributesFromShaderLib.removeAllChildren(),this.uniformsFromShaderLib.removeAllChildren()},e.prototype._readLibSource=function(t){var e=this,n="",r="",o="",i="",a="",s="",c="",u="",l="",h="",p="",f="";t.forEach(function(t){e.attributes.addChildren(t.attributes),e.uniforms.addChildren(t.uniforms),n+=t.vsSourceTop,r+=t.vsSourceDefine,o+=t.vsSourceVarDeclare,i+=t.vsSourceFuncDeclare,a+=t.vsSourceFuncDefine,s+=t.vsSourceBody,c+=t.fsSourceTop,u+=t.fsSourceDefine,l+=t.fsSourceVarDeclare,h+=t.fsSourceFuncDeclare,p+=t.fsSourceFuncDefine,f+=t.fsSourceBody,e.vsSourceDefineList.addChildren(t.vsSourceDefineList),e.fsSourceDefineList.addChildren(t.fsSourceDefineList)}),this.attributes.addChildren(this.attributesFromShaderLib),this.uniforms.addChildren(this.uniformsFromShaderLib),this.vsSourceTop=n+this.vsSourceTopFromShaderLib,this.vsSourceDefine=r+this.vsSourceDefineFromShaderLib,this.vsSourceVarDeclare=o+this.vsSourceVarDeclareFromShaderLib,this.vsSourceFuncDeclare=i+this.vsSourceFuncDeclareFromShaderLib,this.vsSourceFuncDefine=a+this.vsSourceFuncDefineFromShaderLib,this.vsSourceBody=s+this.vsSourceBodyFromShaderLib,this.fsSourceTop=c+this.fsSourceTopFromShaderLib,this.fsSourceDefine=u+this.fsSourceDefineFromShaderLib,this.fsSourceVarDeclare=l+this.fsSourceVarDeclareFromShaderLib,this.fsSourceFuncDeclare=h+this.fsSourceFuncDeclareFromShaderLib,this.fsSourceFuncDefine=p+this.fsSourceFuncDefineFromShaderLib,this.fsSourceBody=f+this.fsSourceBodyFromShaderLib},e.prototype._buildVsSource=function(){this.vsSource=this._buildVsSourceTop()+this._buildVsSourceDefine()+this._buildVsSourceVarDeclare()+this._buildVsSourceFuncDeclare()+this._buildVsSourceFuncDefine()+this._buildVsSourceBody()},e.prototype._buildFsSource=function(){this.fsSource=this._buildFsSourceTop()+this._buildFsSourceDefine()+this._buildFsSourceVarDeclare()+this._buildFsSourceFuncDeclare()+this._buildFsSourceFuncDefine()+this._buildFsSourceBody()},e.prototype._buildVsSourceTop=function(){return this._getPrecisionSource()+this.vsSourceTop},e.prototype._buildVsSourceDefine=function(){return this._buildSourceDefine(this.vsSourceDefineList)+this.vsSourceDefine},e.prototype._buildVsSourceVarDeclare=function(){return this._generateAttributeSource()+this._generateUniformSource(this.vsSourceVarDeclare,this.vsSourceFuncDefine,this.vsSourceBody)+this.vsSourceVarDeclare},e.prototype._buildVsSourceFuncDeclare=function(){return this.vsSourceFuncDeclare},e.prototype._buildVsSourceFuncDefine=function(){return this.vsSourceFuncDefine},e.prototype._buildVsSourceBody=function(){return t.ShaderSnippet.main_begin+this.vsSourceBody+t.ShaderSnippet.main_end},e.prototype._buildFsSourceTop=function(){return this._getPrecisionSource()+this.fsSourceTop},e.prototype._buildFsSourceDefine=function(){return this._buildSourceDefine(this.fsSourceDefineList)+this.fsSourceDefine},e.prototype._buildFsSourceVarDeclare=function(){return this._generateUniformSource(this.fsSourceVarDeclare,this.fsSourceFuncDefine,this.fsSourceBody)+this.fsSourceVarDeclare},e.prototype._buildFsSourceFuncDeclare=function(){return this.fsSourceFuncDeclare},e.prototype._buildFsSourceFuncDefine=function(){return this.fsSourceFuncDefine},e.prototype._buildFsSourceBody=function(){return t.ShaderSnippet.main_begin+this.fsSourceBody+t.ShaderSnippet.main_end},e.prototype._buildSourceDefine=function(t){var e="";return t.forEach(function(t){e+=void 0===t.value?"#define "+t.name+"\n":"#define "+t.name+" "+t.value+"\n"}),e},e.prototype._getPrecisionSource=function(){var e=t.GPUDetector.getInstance().precision,n=null;switch(e){case t.EGPUPrecision.HIGHP:n=t.ShaderChunk.highp_fragment.top;break;case t.EGPUPrecision.MEDIUMP:n=t.ShaderChunk.mediump_fragment.top;break;case t.EGPUPrecision.LOWP:n=t.ShaderChunk.lowp_fragment.top;break;default:n=""}return n},e.prototype._generateAttributeSource=function(){var e="";return this.attributes.filter(function(t,e){return!!t}).forEach(function(n,r){e+="attribute "+t.VariableTypeTable.getVariableType(n.type)+" "+r+";\n"}),e},e.prototype._generateUniformSource=function(e,n,r){var o="",i=this;return this.uniforms.filter(function(o,a){return!!o&&o.type!==t.EVariableType.STRUCTURE&&o.type!==t.EVariableType.STRUCTURES&&!i._isExistInSource(a,e)&&(i._isExistInSource(a,n)||i._isExistInSource(a,r))}).forEach(function(e,n){o+="uniform "+t.VariableTypeTable.getVariableType(e.type)+" "+n+";\n"}),o},e.prototype._isExistInSource=function(t,e){return-1!==e.indexOf(t)},e.prototype._convertArrayToArrayBuffer=function(e,n){var r=this._getBufferSize(e);return t.JudgeUtils.isArrayExactly(n)?t.ArrayBuffer.create(new Float32Array(n),r,t.EBufferType.FLOAT):t.JudgeUtils.isFloatArray(n)?t.ArrayBuffer.create(n,r,t.EBufferType.FLOAT):void 0},e.prototype._getBufferSize=function(e){var n=null;switch(e){case t.EVariableType.FLOAT_1:case t.EVariableType.NUMBER_1:n=1;break;case t.EVariableType.FLOAT_3:n=3;break;case t.EVariableType.FLOAT_4:n=4;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("EVariableType",e))}return n},e}();t.ShaderSourceBuilder=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.FLOAT_1=0]="FLOAT_1",t[t.FLOAT_2=1]="FLOAT_2",t[t.FLOAT_3=2]="FLOAT_3",t[t.FLOAT_4=3]="FLOAT_4",t[t.FLOAT_MAT3=4]="FLOAT_MAT3",t[t.FLOAT_MAT4=5]="FLOAT_MAT4",t[t.BUFFER=6]="BUFFER",t[t.SAMPLER_CUBE=7]="SAMPLER_CUBE",t[t.SAMPLER_2D=8]="SAMPLER_2D",t[t.NUMBER_1=9]="NUMBER_1",t[t.STRUCTURE=10]="STRUCTURE",t[t.STRUCTURES=11]="STRUCTURES"}(t.EVariableType||(t.EVariableType={}));t.EVariableType}(wd||(wd={}));var wd;!function(t){!function(t){t[t.ENGINE="ENGINE"]="ENGINE",t[t.CUSTOM="CUSTOM"]="CUSTOM"}(t.EVariableCategory||(t.EVariableCategory={}));t.EVariableCategory}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.a_position={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_currentFramePosition={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_nextFramePosition={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_normal={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_currentFrameNormal={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_nextFrameNormal={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_color={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_texCoord={type:t.EVariableType.FLOAT_2,value:t.EVariableCategory.ENGINE},e.a_tangent={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_mMatrix={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_vMatrix={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_pMatrix={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_normalMatrix={type:t.EVariableType.FLOAT_MAT3,value:t.EVariableCategory.ENGINE},e.u_samplerCube0={type:t.EVariableType.SAMPLER_CUBE,value:t.EVariableCategory.ENGINE},e.u_sampler2D0={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_sampler2D1={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_diffuseMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_specularMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_emissionMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_normalMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_mirrorSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_cameraPos={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_refractionRatio={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_reflectivity={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_sourceRegion={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_repeatRegion={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_combineMode={type:t.EVariableType.NUMBER_1,value:t.EVariableCategory.ENGINE},e.u_mixRatio={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_diffuse={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_specular={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_emission={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_shininess={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_lightModel={type:t.EVariableType.NUMBER_1,value:t.EVariableCategory.ENGINE},e.u_isBothSide={type:t.EVariableType.NUMBER_1,value:t.EVariableCategory.ENGINE},e.u_opacity={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_ambient={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_directionLights={type:t.EVariableType.STRUCTURES,value:t.EVariableCategory.ENGINE},e.u_pointLights={type:t.EVariableType.STRUCTURES,value:t.EVariableCategory.ENGINE},e.u_vpMatrixFromLight={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_lightPos={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_farPlane={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_interpolation={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e}();t.VariableLib=e}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create();e.addChild(t.EVariableType.FLOAT_1,"float"),e.addChild(t.EVariableType.FLOAT_2,"vec2"),e.addChild(t.EVariableType.FLOAT_3,"vec3"),e.addChild(t.EVariableType.FLOAT_4,"vec4"),e.addChild(t.EVariableType.FLOAT_MAT3,"mat3"),e.addChild(t.EVariableType.FLOAT_MAT4,"mat4"),e.addChild(t.EVariableType.NUMBER_1,"int"),e.addChild(t.EVariableType.SAMPLER_CUBE,"samplerCube"),e.addChild(t.EVariableType.SAMPLER_2D,"sampler2D");var n=function(){function n(){}return n.getVariableType=function(n){var r=e.getChild(n);return t.Log.error(void 0===r,t.Log.info.FUNC_NOT_EXIST(n,"in VariableTypeTable")),r},n}();t.VariableTypeTable=n}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create();e.addChild("diffuseMap","u_diffuseMapSampler"),e.addChild("specularMap","u_specularMapSampler"),e.addChild("emissionMap","u_emissionMapSampler"),e.addChild("normalMap","u_normalMapSampler"),e.addChild("mirrorReflectionMap","u_mirrorSampler");var n=function(){function n(){}return n.getVariableName=function(n){var r=e.getChild(n);return t.Log.error(void 0===r,t.Log.info.FUNC_NOT_EXIST(n,"in VariableNameTable")),r},n}();t.VariableNameTable=n}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this.type=t.ABSTRACT_ATTRIBUTE,this.shader=null,this.attributes=wdCb.Hash.create(),this.uniforms=wdCb.Hash.create(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.vsSourceDefineList=wdCb.Collection.create(),this.fsSourceDefineList=wdCb.Collection.create()}return e.prototype.setShaderDefinition=function(t,e){var n=null,r=null;this._clearShaderDefinition(),n=this.getVsChunk(),r=this.getFsChunk(),n&&this.setVsSource(n),r&&this.setFsSource(r)},e.prototype.init=function(){},e.prototype.dispose=function(){},e.prototype.getVsChunk=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=0===t.length?this.type:t[0];return this._getChunk(r,n.vs)},e.prototype.getFsChunk=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=0===t.length?this.type:t[0];return this._getChunk(r,n.fs)},e.prototype.setVsSource=function(t,e){void 0===e&&(e="="),this._setSource(t,n.vs,e)},e.prototype.setFsSource=function(t,e){void 0===e&&(e="="),this._setSource(t,n.fs,e)},e.prototype.addAttributeVariable=function(t){this._addVariable(this.attributes,t)},e.prototype.addUniformVariable=function(t){this._addVariable(this.uniforms,t)},e.prototype.sendAttributeData=function(e,n,r){e.sendAttributeData(n,t.EVariableType.BUFFER,r)},e.prototype.sendUniformData=function(e,n,r){e.sendUniformData(n,t.VariableLib[n].type,r)},e.prototype._clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSourceDefineList.removeAllChildren(),this.fsSourceDefineList.removeAllChildren(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody=""},e.prototype._getChunk=function(e,r){var o=null;return o=e.indexOf(".glsl")>-1?""+wdCb.PathUtils.basename(e,".glsl"):r===n.vs?e+"_vertex":e+"_fragment",t.ShaderChunk[o]?t.ShaderChunk[o]:t.ShaderChunk.empty},e.prototype._setSource=function(e,n,r){if(e)switch(r){case"+":this[n+"SourceTop"]+=e.top,this[n+"SourceDefine"]+=e.define,this[n+"SourceVarDeclare"]+=e.varDeclare,this[n+"SourceFuncDeclare"]+=e.funcDeclare,this[n+"SourceFuncDefine"]+=e.funcDefine,this[n+"SourceBody"]+=e.body;break;case"=":this[n+"SourceTop"]=e.top,this[n+"SourceDefine"]=e.define,this[n+"SourceVarDeclare"]=e.varDeclare,this[n+"SourceFuncDeclare"]=e.funcDeclare,this[n+"SourceFuncDefine"]=e.funcDefine,this[n+"SourceBody"]=e.body;break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("opertor:",r))}},e.prototype._addVariable=function(e,n){n.forEach(function(n){t.Log.assert(t.VariableLib[n],t.Log.info.FUNC_SHOULD(n,"exist in VariableLib")),e.addChild(n,t.VariableLib[n])})},__decorate([t.virtual],e.prototype,"setShaderDefinition",null),__decorate([t.virtual],e.prototype,"init",null),__decorate([t.virtual],e.prototype,"dispose",null),__decorate([t.require(function(e,n,r){t.assert(!!t.VariableLib[n],n+" should exist in VariableLib")})],e.prototype,"sendUniformData",null),e}();t.ShaderLib=e;var n;!function(t){t[t.vs="vs"]="vs",t[t.fs="fs"]="fs"}(n||(n={}))}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="common"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_mMatrix",e.mMatrix),this.sendUniformData(t,"u_vMatrix",e.vMatrix),this.sendUniformData(t,"u_pMatrix",e.pMatrix)},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable(["u_mMatrix","u_vMatrix","u_pMatrix"]),this.vsSourceDefine=t.ShaderChunk.common_define.define+t.ShaderChunk.common_vertex.define,this.vsSourceFuncDefine=t.ShaderChunk.common_function.funcDefine+t.ShaderChunk.common_vertex.funcDefine,this.fsSourceDefine=t.ShaderChunk.common_define.define+t.ShaderChunk.common_fragment.define,this.fsSourceFuncDefine=t.ShaderChunk.common_function.funcDefine+t.ShaderChunk.common_fragment.funcDefine},n}(t.ShaderLib);t.CommonShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="commonVertice"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(t,e,n){this._sendAttributeVariables(t,e)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addAttributeVariable(["a_position"])},n.prototype._sendAttributeVariables=function(e,n){var r=n.buffers.getChild(t.EBufferDataType.VERTICE);r&&this.sendAttributeData(e,"a_position",r)},n}(t.ShaderLib);t.CommonVerticeShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="commonNormal"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(t,e,n){this._sendAttributeVariables(t,e)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addAttributeVariable(["a_normal"])},n.prototype._sendAttributeVariables=function(e,n){var r=n.buffers.getChild(t.EBufferDataType.NORMAL);r&&this.sendAttributeData(e,"a_normal",r)},n}(t.ShaderLib);t.CommonNormalShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="basic"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){var o=n.buffers.getChild(t.EBufferDataType.COLOR);o&&(this.sendAttributeData(e,"a_color",o),this.sendUniformData(e,"u_opacity",r.opacity))},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addAttributeVariable(["a_color"]),this.addUniformVariable(["u_opacity"]),this.vsSourceBody=t.ShaderSnippet.setPos_mvp+t.ShaderChunk.basic_vertex.body},n}(t.ShaderLib);t.BasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="basicEnd"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.ShaderLib);t.BasicEndShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="morphCommon"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(t,e,n){var r=e.animation;this.sendUniformData(t,"u_interpolation",r.interpolation)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addUniformVariable(["u_interpolation"])},__decorate([t.require(function(e,n,r){t.assert(!!n.animation,t.Log.info.FUNC_SHOULD("entityObject","add MorphAnimation component"))})],n.prototype,"sendShaderVariables",null),n}(t.ShaderLib);t.MorphCommonShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="morphVertice"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){var o=n.buffers.getChild(t.EBufferDataType.VERTICE);o&&(this.sendAttributeData(e,"a_currentFramePosition",o[0]),this.sendAttributeData(e,"a_nextFramePosition",o[1]))},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addAttributeVariable(["a_currentFramePosition","a_nextFramePosition"])},__decorate([t.require(function(e,n,r){t.assert(!!n.animation,t.Log.info.FUNC_SHOULD("entityObject","add MorphAnimation component"))})],n.prototype,"sendShaderVariables",null),
n}(t.ShaderLib);t.MorphVerticeShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="morphNormal"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){var o=n.buffers.getChild(t.EBufferDataType.NORMAL);o&&(this.sendAttributeData(e,"a_currentFrameNormal",o[0]),this.sendAttributeData(e,"a_nextFrameNormal",o[1]))},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addAttributeVariable(["a_currentFrameNormal","a_nextFrameNormal"])},n}(t.ShaderLib);t.MorphNormalShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="skybox"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_samplerCube0"])},e}(t.ShaderLib);t.SkyboxShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.sendShaderVariables=function(e,n,r){this.sendUniformData(e,"u_normalMatrix",n.normalMatrix),this.sendUniformData(e,"u_cameraPos",t.Director.getInstance().scene.currentCamera.transform.position)},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable(["u_samplerCube0","u_cameraPos","u_normalMatrix"]),this.vsSourceBody=t.ShaderSnippet.setPos_mvp+this.getVsChunk().body},n.prototype.setEnvMapSource=function(){var t=this.getVsChunk("envMap_forBasic"),e=this.getFsChunk("envMap_forBasic");this.vsSourceTop=t.top,this.vsSourceDefine=t.define,this.vsSourceVarDeclare=t.varDeclare,this.vsSourceFuncDeclare=t.funcDeclare,this.vsSourceFuncDefine=t.funcDefine,this.vsSourceBody+=t.body,this.setFsSource(e)},n}(t.ShaderLib);t.EnvMapForBasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="basic_envMap_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.EnvMapForBasicShaderLib);t.BasicEnvMapForBasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="reflection_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.EnvMapForBasicShaderLib);t.ReflectionForBasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="refraction_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(e,n,r){t.prototype.sendShaderVariables.call(this,e,n,r),this.sendUniformData(e,"u_refractionRatio",r.refractionRatio)},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_refractionRatio"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.EnvMapForBasicShaderLib);t.RefractionForBasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="fresnel_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(e,n,r){t.prototype.sendShaderVariables.call(this,e,n,r),this.sendUniformData(e,"u_refractionRatio",r.refractionRatio),this.sendUniformData(e,"u_reflectivity",r.reflectivity)},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_refractionRatio","u_reflectivity"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.EnvMapForBasicShaderLib);t.FresnelForBasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.sendShaderVariables=function(t,e,n){},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable(["u_samplerCube0"]),this.vsSourceBody=t.ShaderSnippet.setPos_mvp+this.getVsChunk().body},n.prototype.setEnvMapSource=function(){var t=this.getVsChunk("envMap_forLight"),e=this.getFsChunk("envMap_forLight");this.vsSourceTop=t.top,this.vsSourceDefine=t.define,this.vsSourceVarDeclare=t.varDeclare,this.vsSourceFuncDeclare=t.funcDeclare,this.vsSourceFuncDefine=t.funcDefine,this.vsSourceBody+=t.body,this.setFsSource(e)},n}(t.ShaderLib);t.EnvMapForLightShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="basic_forLight_envMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.EnvMapForLightShaderLib);t.BasicEnvMapForLightShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="reflection_forLight"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.EnvMapForLightShaderLib);t.ReflectionForLightShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="refraction_forLight"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(e,n,r){t.prototype.sendShaderVariables.call(this,e,n,r),this.sendUniformData(e,"u_refractionRatio",r.refractionRatio)},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_refractionRatio"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.EnvMapForLightShaderLib);t.RefractionForLightShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="fresnel_forLight"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(n,r,o){e.prototype.sendShaderVariables.call(this,n,r,o),null!==o.reflectivity?this.sendUniformData(n,"u_reflectivity",o.reflectivity):(this.sendUniformData(n,"u_reflectivity",t.ShaderChunk.NULL),this.sendUniformData(n,"u_refractionRatio",o.refractionRatio))},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addUniformVariable(["u_refractionRatio","u_reflectivity"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},n}(t.EnvMapForLightShaderLib);t.FresnelForLightShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.sendShaderVariables=function(e,n,r){var o=n.buffers.getChild(t.EBufferDataType.TEXCOORD);o&&this.sendAttributeData(e,"a_texCoord",o)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addAttributeVariable(["a_texCoord"]),this.addUniformVariable(["u_sampler2D0","u_sourceRegion","u_repeatRegion"]),this._setMapSource()},n.prototype._setMapSource=function(){var t=this.getVsChunk("map_forBasic"),e=this.getFsChunk("map_forBasic");this.vsSourceTop=t.top,this.vsSourceDefine=t.define,this.vsSourceVarDeclare=t.varDeclare,this.vsSourceFuncDeclare=t.funcDeclare,this.vsSourceFuncDefine=t.funcDefine,this.vsSourceBody=t.body,this.setFsSource(e)},n}(t.ShaderLib);t.MapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="map_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.MapShaderLib);t.BasicMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="multi_map_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(e,n,r){t.prototype.sendShaderVariables.call(this,e,n,r),this.sendUniformData(e,"u_combineMode",r.mapCombineMode),this.sendUniformData(e,"u_mixRatio",r.mapMixRatio)},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_sampler2D1","u_combineMode","u_mixRatio"]),this.fsSourceFuncDefine=this.getFsChunk().funcDefine,this.fsSourceBody=this.getFsChunk().body},e}(t.MapShaderLib);t.MultiMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="mirror_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_mirrorSampler"])},e}(t.ShaderLib);t.MirrorForBasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="lightCommon"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.setVsSource(this.getVsChunk("light_common.glsl")),this.setVsSource(this.getVsChunk(),"+"),this.setFsSource(this.getFsChunk("light_common.glsl")),this.setFsSource(this.getFsChunk(),"+")},e}(t.ShaderLib);t.LightCommonShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="light"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){this.sendUniformData(e,"u_normalMatrix",n.normalMatrix),this.sendUniformData(e,"u_cameraPos",t.Director.getInstance().scene.currentCamera.transform.position),this.sendUniformData(e,"u_shininess",r.shininess),this.sendUniformData(e,"u_opacity",r.opacity),this.sendUniformData(e,"u_lightModel",this._convertLightModelToGLSLVariable(r.lightModel)),this._sendLightVariables(e)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addUniformVariable(["u_normalMatrix","u_cameraPos","u_shininess","u_ambient","u_opacity","u_isBothSide","u_lightModel"]),this._setLightDefinition(n)},n.prototype._sendLightVariables=function(e){var n=t.Director.getInstance().scene,r=n.directionLights,o=n.ambientLight,i=n.pointLights;o&&this.sendUniformData(e,"u_ambient",o.getComponent(t.AmbientLight).color.toVector3()),i&&this._sendPointLightVariables(e,i),r&&this._sendDirectionLightVariables(e,r)},n.prototype._sendPointLightVariables=function(e,n){n.forEach(function(n,r){var o=n.getComponent(t.PointLight);e.sendStructureData("u_pointLights["+r+"].position",t.EVariableType.FLOAT_3,o.position),e.sendStructureData("u_pointLights["+r+"].color",t.EVariableType.FLOAT_3,o.color.toVector3()),e.sendStructureData("u_pointLights["+r+"].intensity",t.EVariableType.FLOAT_1,o.intensity),e.sendStructureData("u_pointLights["+r+"].constant",t.EVariableType.FLOAT_1,o.constant),e.sendStructureData("u_pointLights["+r+"].linear",t.EVariableType.FLOAT_1,o.linear),e.sendStructureData("u_pointLights["+r+"].quadratic",t.EVariableType.FLOAT_1,o.quadratic),null!==o.range?e.sendStructureData("u_pointLights["+r+"].range",t.EVariableType.FLOAT_1,o.range):e.sendStructureData("u_pointLights["+r+"].range",t.EVariableType.FLOAT_1,t.ShaderChunk.NULL)})},n.prototype._sendDirectionLightVariables=function(e,n){var r=this;n.forEach(function(n,o){var i=n.getComponent(t.DirectionLight);r._isZero(i.position)?e.sendStructureData("u_directionLights["+o+"].position",t.EVariableType.FLOAT_3,t.DirectionLight.defaultPosition):e.sendStructureData("u_directionLights["+o+"].position",t.EVariableType.FLOAT_3,i.position),e.sendStructureData("u_directionLights["+o+"].color",t.EVariableType.FLOAT_3,i.color.toVector3()),e.sendStructureData("u_directionLights["+o+"].intensity",t.EVariableType.FLOAT_1,i.intensity)})},n.prototype._isZero=function(t){var e=t.values;return 0===e[0]&&0===e[1]&&0===e[2]},n.prototype._setLightDefinition=function(e){var n=t.Director.getInstance().scene,r=n.directionLights,o=n.pointLights,i=0,a=0;r&&(this.addUniformVariable(["u_directionLights"]),i=r.getCount()),o&&(this.addUniformVariable(["u_pointLights"]),a=o.getCount()),this._addDefine(this.vsSourceDefineList,i,a),this._addDefine(this.fsSourceDefineList,i,a),e.side===t.ESide.BOTH&&this.fsSourceDefineList.addChildren([{name:"BOTH_SIDE"}])},n.prototype._addDefine=function(t,e,n){t.addChildren([{name:"DIRECTION_LIGHTS_COUNT",value:e},{name:"POINT_LIGHTS_COUNT",value:n}])},n.prototype._convertLightModelToGLSLVariable=function(e){switch(e){case t.ELightModel.BLINN:return 1;case t.ELightModel.PHONG:return 2;case t.ELightModel.CONSTANT:return 3;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("lightModel:"+e))}},__decorate([t.require(function(e){t.assert(e!==t.ELightModel.LAMBERT,t.Log.info.FUNC_SHOULD_NOT("lightModel","=== ELightModel.LAMBERT"))})],n.prototype,"_convertLightModelToGLSLVariable",null),n}(t.ShaderLib);t.LightShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="lightEnd"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.ShaderLib);t.LightEndShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.sendShaderVariables=function(e,n,r){var o=n.buffers.getChild(t.EBufferDataType.TEXCOORD);o&&this.sendAttributeData(e,"a_texCoord",o)},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this.addAttributeVariable(["a_texCoord"])},n}(t.ShaderLib);t.LightMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="diffuseMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable([t.VariableNameTable.getVariableName("diffuseMap"),"u_sourceRegion","u_repeatRegion"])},n}(t.LightMapShaderLib);t.DiffuseMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="specularMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable([t.VariableNameTable.getVariableName("specularMap")])},n}(t.LightMapShaderLib);t.SpecularMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="emissionMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addUniformVariable([t.VariableNameTable.getVariableName("emissionMap")])},n}(t.LightMapShaderLib);t.EmissionMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="normalMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(n,r,o){var i=null;e.prototype.sendShaderVariables.call(this,n,r,o),i=r.buffers.getChild(t.EBufferDataType.TANGENT),i&&this.sendAttributeData(n,"a_tangent",i)},n.prototype.setShaderDefinition=function(n,r){e.prototype.setShaderDefinition.call(this,n,r),this.addAttributeVariable(["a_tangent"]),this.addUniformVariable([t.VariableNameTable.getVariableName("normalMap")])},n}(t.LightMapShaderLib);t.NormalMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noDiffuseMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_diffuse",n.color.toVector3())},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_diffuse"])},e}(t.ShaderLib);t.NoDiffuseMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noSpecularMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_specular",n.specularColor.toVector3())},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_specular"])},e}(t.ShaderLib);t.NoSpecularMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noEmissionMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_emission",n.emissionColor.toVector3())},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_emission"])},e}(t.ShaderLib);t.NoEmissionMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noNormalMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.ShaderLib);t.NoNormalMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.setFsSource(this.getFsChunk("commonBuildShadowMap_fragment.glsl")),this.setFsSource(this.getFsChunk(),"+")},e}(t.ShaderLib);t.BuildShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="buildTwoDShadowMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_vpMatrixFromLight",n.buildTwoDShadowMapData.vpMatrixFromLight)},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_vpMatrixFromLight"])},e}(t.BuildShadowMapShaderLib);t.BuildTwoDShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="buildCubemapShadowMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){this.sendUniformData(t,"u_lightPos",n.buildCubemapShadowMapData.lightPos),this.sendUniformData(t,"u_farPlane",n.buildCubemapShadowMapData.farPlane)},e.prototype.setShaderDefinition=function(e,n){t.prototype.setShaderDefinition.call(this,e,n),this.addUniformVariable(["u_lightPos","u_farPlane"])},e}(t.BuildShadowMapShaderLib);t.BuildCubemapShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="totalShadowMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.ShaderLib);t.TotalShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._softTypeChangeSubscription=null}return __extends(n,e),n.prototype.init=function(){var e=this.shader;this._softTypeChangeSubscription=t.EventManager.fromEvent(t.Director.getInstance().scene.gameObjectScene,t.EEngineEvent.SHADOWMAP_SOFTTYPE_CHANGE).subscribe(function(){e.libDirty=!0})},n.prototype.dispose=function(){this._softTypeChangeSubscription&&this._softTypeChangeSubscription.dispose()},n.prototype.setShaderDefinition=function(t,n){e.prototype.setShaderDefinition.call(this,t,n),this._setShadowMapSource()},n.prototype._setShadowMapSource=function(){var e=t.Director.getInstance().scene,n=e.directionLights?e.directionLights.filter(function(e){return e.getComponent(t.DirectionLight).castShadow}).getCount():0,r=e.pointLights?e.pointLights.filter(function(e){return e.getComponent(t.PointLight).castShadow}).getCount():0;e.shadowMap.softType===t.EShadowMapSoftType.PCF&&this.fsSourceDefineList.addChildren([{name:"SHADOWMAP_TYPE_PCF"}]),this.vsSourceDefineList.addChild({name:"TWOD_SHADOWMAP_COUNT",value:n}),this.fsSourceDefineList.addChildren([{name:"TWOD_SHADOWMAP_COUNT",value:n},{name:"CUBEMAP_SHADOWMAP_COUNT",value:r}])},n}(t.ShaderLib);t.ShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="twoDShadowMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){r.twoDShadowMapDatas.forEach(function(n,r){e.sendStructureData("u_vpMatrixFromLight["+r+"]",t.EVariableType.FLOAT_MAT4,n.vpMatrixFromLight),e.sendStructureData("u_twoDShadowSize["+r+"]",t.EVariableType.FLOAT_2,n.shadowSize),e.sendStructureData("u_twoDShadowBias["+r+"]",t.EVariableType.FLOAT_1,n.shadowBias),e.sendStructureData("u_twoDShadowDarkness["+r+"]",t.EVariableType.FLOAT_1,n.shadowDarkness),e.sendStructureData("u_twoDLightPos["+r+"]",t.EVariableType.FLOAT_3,n.lightPos)})},n}(t.ShadowMapShaderLib);t.TwoDShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type="cubemapShadowMap"}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.sendShaderVariables=function(e,n,r){r.cubemapShadowMapDatas.forEach(function(n,r){e.sendStructureData("u_cubemapLightPos["+r+"]",t.EVariableType.FLOAT_3,n.lightPos),e.sendStructureData("u_farPlane["+r+"]",t.EVariableType.FLOAT_1,n.farPlane),e.sendStructureData("u_cubemapShadowBias["+r+"]",t.EVariableType.FLOAT_1,n.shadowBias),e.sendStructureData("u_cubemapShadowDarkness["+r+"]",t.EVariableType.FLOAT_1,n.shadowDarkness)})},n}(t.ShadowMapShaderLib);t.CubemapShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noShadowMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,n){},e}(t.ShaderLib);t.NoShadowMapShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.main_begin="void main(void){\n",t.main_end="}\n",t.setPos_mvp="gl_Position = u_pMatrix * u_vMatrix * u_mMatrix * vec4(a_position, 1.0);\n",t}();t.ShaderSnippet=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this._blendType=null,this._blendSrc=t.EBlendFunc.ONE,this._blendDst=t.EBlendFunc.ZERO,this._blendEquation=t.EBlendEquation.ADD,this._color=t.Color.create("#ffffff"),this.shader=t.Shader.create(),this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this.polygonOffsetMode=t.EPolygonOffsetMode.NONE,this.side=t.ESide.FRONT,this.blend=!1,this.blendFuncSeparate=null,this.blendEquationSeparate=[t.EBlendEquation.ADD,t.EBlendEquation.ADD],this.shading=t.EShading.FLAT,this.refractionRatio=0,this.reflectivity=null,this.mapCombineMode=t.ETextureCombineMode.MIX,this.mapMixRatio=.5,this.mapManager=t.MapManager.create(this),this.geometry=null,this._afterInitSubscription=null}return Object.defineProperty(e.prototype,"program",{get:function(){return this.shader.program},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendType",{get:function(){return this._blendType?this._blendType:this.blendSrc===t.EBlendFunc.ONE&&this.blendDst===t.EBlendFunc.ZERO&&this.blendEquation===t.EBlendEquation.ADD?t.EBlendType.NONE:this.blendSrc===t.EBlendFunc.SRC_ALPHA&&this.blendDst===t.EBlendFunc.ONE_MINUS_SRC_ALPHA&&this.blendEquation===t.EBlendEquation.ADD?t.EBlendType.NORMAL:this.blendSrc===t.EBlendFunc.ONE&&this.blendDst===t.EBlendFunc.ONE&&this.blendEquation===t.EBlendEquation.ADD?t.EBlendType.ADDITIVE:this.blendSrc===t.EBlendFunc.SRC_ALPHA&&this.blendDst===t.EBlendFunc.ONE&&this.blendEquation===t.EBlendEquation.ADD?t.EBlendType.ADDITIVEALPHA:this.blendSrc===t.EBlendFunc.DST_COLOR&&this.blendDst===t.EBlendFunc.ZERO&&this.blendEquation===t.EBlendEquation.ADD?t.EBlendType.MULTIPLICATIVE:this.blendSrc===t.EBlendFunc.ONE&&this.blendDst===t.EBlendFunc.ONE_MINUS_SRC_ALPHA&&this.blendEquation===t.EBlendEquation.ADD?t.EBlendType.PREMULTIPLIED:t.EBlendType.NORMAL},set:function(e){switch(e){case t.EBlendType.NONE:
this.blend=!1,this.blendSrc=t.EBlendFunc.ONE,this.blendDst=t.EBlendFunc.ZERO,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.NORMAL:this.blend=!0,this.blendSrc=t.EBlendFunc.SRC_ALPHA,this.blendDst=t.EBlendFunc.ONE_MINUS_SRC_ALPHA,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.PREMULTIPLIED:this.blend=!0,this.blendSrc=t.EBlendFunc.ONE,this.blendDst=t.EBlendFunc.ONE_MINUS_SRC_ALPHA,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.ADDITIVE:this.blend=!0,this.blendSrc=t.EBlendFunc.ONE,this.blendDst=t.EBlendFunc.ONE,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.ADDITIVEALPHA:this.blend=!0,this.blendSrc=t.EBlendFunc.SRC_ALPHA,this.blendDst=t.EBlendFunc.ONE,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.MULTIPLICATIVE:this.blend=!0,this.blendSrc=t.EBlendFunc.DST_COLOR,this.blendDst=t.EBlendFunc.ZERO,this.blendEquation=t.EBlendEquation.ADD;break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("blendType"))}this._blendType=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"envMap",{get:function(){return this.mapManager.getEnvMap()},set:function(t){this.mapManager.setEnvMap(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendSrc",{get:function(){return this._blendSrc},set:function(t){this._blendSrc=t,this.blendFuncSeparate=null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendDst",{get:function(){return this._blendDst},set:function(t){this._blendDst=t,this.blendFuncSeparate=null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendEquation",{get:function(){return this._blendEquation},set:function(t){this._blendEquation=t,this.blendEquationSeparate=null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(e){this._isColorEqual(e,this._color)||(this.geometry&&this.geometry.entityObject&&t.EventManager.trigger(this.geometry.entityObject,t.EEngineEvent.MATERIAL_COLOR_CHANGE),this._color=e)},enumerable:!0,configurable:!0}),e.prototype.init=function(){this._addTopShaderLib(),this.addShaderLib(),this.shader.init(),this.mapManager.init()},e.prototype.dispose=function(){this.shader.dispose(),this.mapManager.dispose(),this._afterInitSubscription&&this._afterInitSubscription.dispose()},e.prototype.updateTexture=function(){this.mapManager.update()},e.prototype.updateShader=function(e){var n=t.Director.getInstance().scene;n.isUseProgram?n.shader.update(e,this):this.shader.update(e,this)},e.prototype.addShaderLib=function(){},e.prototype.addMap=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.mapManager.addMap.apply(this.mapManager,t)},e.prototype.addNormalShaderLib=function(){this._hasAnimation()&&!this.shader.hasLib(t.MorphNormalShaderLib)?this._addShaderLibToTop(t.MorphNormalShaderLib.create()):this.shader.hasLib(t.CommonNormalShaderLib)||this._addShaderLibToTop(t.CommonNormalShaderLib.create())},e.prototype.setBlendByOpacity=function(t){1>t&&t>=0?this.blend=!0:this.blend=!1},e.prototype._addTopShaderLib=function(){this.shader.addLib(t.CommonShaderLib.create()),this._hasAnimation()?(this.shader.addLib(t.MorphCommonShaderLib.create()),this.shader.addLib(t.MorphVerticeShaderLib.create())):this.shader.addLib(t.CommonVerticeShaderLib.create())},e.prototype._addShaderLibToTop=function(t){this.shader.addShaderLibToTop(t)},e.prototype._hasAnimation=function(){if(this.geometry instanceof t.ModelGeometry){var e=this.geometry;return e.hasAnimation()}return!1},e.prototype._isColorEqual=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a},__decorate([t.require(function(){t.assert(!(this.mirrorMap&&this.envMap),t.Log.info.FUNC_SHOULD_NOT("mirrorMap and envMap","be set both"))})],e.prototype,"init",null),__decorate([t.virtual],e.prototype,"addShaderLib",null),e}();t.Material=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._opacity=1}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"map",{set:function(e){if(e instanceof t.Texture||e instanceof t.TextureAsset)this.addMap(e);else{var n=arguments[0];wdCb.Log.error(n.length>2,wdCb.Log.info.FUNC_SUPPORT("only","map.count <= 2"));for(var r=0,o=n;r<o.length;r++){var i=o[r];this.addMap(i)}}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"mirrorMap",{get:function(){return this.mapManager.getMirrorMap()},set:function(t){this.mapManager.setMirrorMap(t)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"opacity",{get:function(){return this._opacity},set:function(t){this.setBlendByOpacity(t),this._opacity=t},enumerable:!0,configurable:!0}),n.prototype.addShaderLib=function(){var e=null;this.shader.addLib(t.BasicShaderLib.create()),this._setMapShaderLib(),e=this.envMap,e&&this._setEnvMapShaderLib(e),this._setMirrorMapShaderLib(),this.shader.addLib(t.BasicEndShaderLib.create())},n.prototype._setMapShaderLib=function(){var e=this.mapManager,n=e.getMapCount(function(t){return!e.isMirrorMap(t)});n>0&&(n>1?this.shader.addLib(t.MultiMapShaderLib.create()):this.shader.addLib(t.BasicMapShaderLib.create()))},n.prototype._setEnvMapShaderLib=function(e){switch(this.addNormalShaderLib(),e.mode){case t.EEnvMapMode.BASIC:this.shader.addLib(t.BasicEnvMapForBasicShaderLib.create());break;case t.EEnvMapMode.REFLECTION:this.shader.addLib(t.ReflectionForBasicShaderLib.create());break;case t.EEnvMapMode.REFRACTION:this.shader.addLib(t.RefractionForBasicShaderLib.create());break;case t.EEnvMapMode.FRESNEL:this.shader.addLib(t.FresnelForBasicShaderLib.create());break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EEnvMapMode"))}},n.prototype._setMirrorMapShaderLib=function(){this.mirrorMap&&this.shader.addLib(t.MirrorForBasicShaderLib.create())},n}(t.Material);t.BasicMaterial=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.initWhenCreate=function(){this.side=t.ESide.BACK},n.prototype.addShaderLib=function(){this.shader.addLib(t.SkyboxShaderLib.create())},n}(t.Material);t.SkyboxMaterial=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._diffuseMap=null,this._specularMap=null,this._emissionMap=null,this._normalMap=null,this._shininess=32,this._opacity=1,this.lightModel=t.ELightModel.PHONG,this.twoDShadowMapDatas=wdCb.Collection.create(),this.cubemapShadowMapDatas=wdCb.Collection.create(),this.buildTwoDShadowMapData=null,this.buildCubemapShadowMapData=null,this.specularColor=t.Color.create("0x111111"),this.emissionColor=t.Color.create("0x111111"),this._twoDShadowMapSamplerIndex=0,this._cubemapShadowMapSamplerIndex=0}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"diffuseMap",{get:function(){return this._diffuseMap},set:function(e){this.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("diffuseMap")}),this._diffuseMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"specularMap",{get:function(){return this._specularMap},set:function(e){this.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("specularMap")}),this._specularMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"emissionMap",{get:function(){return this._emissionMap},set:function(e){this.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("emissionMap")}),this._emissionMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"normalMap",{get:function(){return this._normalMap},set:function(e){this.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("normalMap")}),this._normalMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"shininess",{get:function(){return Number(this._shininess)<=0?32:this._shininess},set:function(t){this._shininess=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"opacity",{get:function(){return this._opacity},set:function(t){this.setBlendByOpacity(t),this._opacity=t},enumerable:!0,configurable:!0}),n.prototype.addTwoDShadowMap=function(t){this.addMap(t,{samplerData:this._twoDShadowMapSamplerIndex}),this._twoDShadowMapSamplerIndex++},n.prototype.addCubemapShadowMap=function(t){this.addMap(t,{samplerData:this._cubemapShadowMapSamplerIndex}),this._cubemapShadowMapSamplerIndex++},n.prototype.hasShadowMap=function(t){return this.mapManager.hasMap(t)},n.prototype.addTwoDShadowMapData=function(t){this.twoDShadowMapDatas.addChild(t)},n.prototype.addCubemapShadowMapData=function(t){this.cubemapShadowMapDatas.addChild(t)},n.prototype.clearTwoDShadowMapData=function(){this.twoDShadowMapDatas.removeAllChildren()},n.prototype.clearCubemapShadowMapData=function(){this.cubemapShadowMapDatas.removeAllChildren()},n.prototype.addShaderLib=function(){var e=null;this.addNormalShaderLib(),this.shader.addLib(t.LightCommonShaderLib.create()),this._setLightMapShaderLib(),this.shader.addLib(t.LightShaderLib.create()),e=this.envMap,e&&this._setEnvMapShaderLib(e),this.shader.addLib(t.LightEndShaderLib.create())},n.prototype._setLightMapShaderLib=function(){var e=t.Director.getInstance().scene;this._diffuseMap?this.shader.addLib(t.DiffuseMapShaderLib.create()):this.shader.addLib(t.NoDiffuseMapShaderLib.create()),this._specularMap?this.shader.addLib(t.SpecularMapShaderLib.create()):this.shader.addLib(t.NoSpecularMapShaderLib.create()),this._emissionMap?this.shader.addLib(t.EmissionMapShaderLib.create()):this.shader.addLib(t.NoEmissionMapShaderLib.create()),this._normalMap?this.shader.addLib(t.NormalMapShaderLib.create()):this.shader.addLib(t.NoNormalMapShaderLib.create()),e.shadowMap.enable&&(this._hasTwoDShadowMap()||this._hasCubemapShadowMap())?(this._hasTwoDShadowMap()&&this.shader.addLib(t.TwoDShadowMapShaderLib.create()),this._hasCubemapShadowMap()&&this.shader.addLib(t.CubemapShadowMapShaderLib.create()),this.shader.addLib(t.TotalShadowMapShaderLib.create())):this.shader.addLib(t.NoShadowMapShaderLib.create())},n.prototype._setEnvMapShaderLib=function(e){switch(e.mode){case t.EEnvMapMode.BASIC:this.shader.addLib(t.BasicEnvMapForLightShaderLib.create());break;case t.EEnvMapMode.REFLECTION:this.shader.addLib(t.ReflectionForLightShaderLib.create());break;case t.EEnvMapMode.REFRACTION:this.shader.addLib(t.RefractionForLightShaderLib.create());break;case t.EEnvMapMode.FRESNEL:this.shader.addLib(t.FresnelForLightShaderLib.create());break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EEnvMapMode"))}},n.prototype._hasTwoDShadowMap=function(){return this.mapManager.hasMap(function(e){return e instanceof t.TwoDShadowMapTexture})},n.prototype._hasCubemapShadowMap=function(){return this.mapManager.hasMap(function(e){return e instanceof t.CubemapShadowMapTexture})},n}(t.Material);t.LightMaterial=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.Material);t.ShaderMaterial=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.FLAT=0]="FLAT",t[t.SMOOTH=1]="SMOOTH"}(t.EShading||(t.EShading={}));t.EShading}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(t){this._material=null,this._mapTable=wdCb.Hash.create(),this._mirrorMap=null,this._textureDirty=!1,this._mapArrCache=null,this._material=t}return e.create=function(t){var e=new this(t);return e},e.prototype.init=function(){for(var t=this._getMapArr(),e=0,n=t.length;n>e;e++){var r=t[e];r.init()}},e.prototype.addMap=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;if(e[0]instanceof t.TextureAsset){var o=e[0];r=o.toTexture()}else e[0]instanceof t.Texture&&(r=e[0]);if(2===e.length){var i=e[1];this._setMapOption(r,i)}r.material=this._material,this._mapTable.appendChild("map",r),this._textureDirty=!0},e.prototype.getMap=function(t){return this._mapTable.getChild("map").getChild(t)},e.prototype.hasMap=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return r=this._mapTable.getChild("map"),r?t.JudgeUtils.isFunction(e[0])?r.hasChildWithFunc(e[0]):r.hasChild(e[0]):!1},e.prototype.getMapCount=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(0===t.length){var n=this._mapTable.getChild("map");return n?n.getCount():0}var r=t[0],n=this._mapTable.getChild("map");return n?n.filter(r).getCount():0},e.prototype.getEnvMap=function(){return this._getMap("envMap")},e.prototype.setEnvMap=function(t){this._setMap("envMap",t)},e.prototype.getMirrorMap=function(){return this._mirrorMap},e.prototype.setMirrorMap=function(e){this.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("mirrorReflectionMap")}),this._mirrorMap=e},e.prototype.isMirrorMap=function(t){return t===this._mirrorMap},e.prototype.removeAllChildren=function(){this._mapTable.removeAllChildren(),this._textureDirty=!0},e.prototype.dispose=function(){for(var t=this._getMapArr(),e=0,n=t.length;n>e;e++){var r=t[e];r.dispose()}this.removeAllChildren()},e.prototype.update=function(){for(var e=this._getMapArr(),n=0,r=e.length;r>n;n++){var o=e[n];o.needUpdate&&o instanceof t.BasicTexture&&o.update(n)}},e.prototype.sendData=function(t){for(var e=this._getMapArr(),n=0,r=e.length;r>n;n++){var o=e[n],i=o.getSamplerName(n),a=t.getUniformLocation(i);if(t.isUniformDataNotExistByLocation(a))return;o.bindToUnit(n),o.sendData(t,a,n)}},e.prototype._getMapArr=function(){return this._mapTable.toArray()},e.prototype._getMap=function(t){return this._mapTable.getChild(t)},e.prototype._setMap=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=t[0],r=t[1];if(!r)return void this._removeMap(n,r);if(3===arguments.length){var o=t[1];this._setMapOption(r,o)}r.material=this._material,this._mapTable.addChild(n,r)},e.prototype._removeMap=function(t,e){this._mapTable.removeChild(t),this._textureDirty=!0},e.prototype._setMapOption=function(t,e){t.variableData=e},__decorate([t.cache(function(){return!this._textureDirty&&this._mapArrCache},function(){return this._mapArrCache},function(t){this._mapArrCache=t,this._textureDirty=!1})],e.prototype,"_getMapArr",null),e}();t.MapManager=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.UNKNOW=0]="UNKNOW",t[t.FONT=1]="FONT"}(t.EAssetType||(t.EAssetType={}));t.EAssetType}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._container=wdCb.Hash.create()}return e.prototype.load=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0],o=null,i=this,a=null,s=null;return o=1===e.length?t.JudgeUtils.isArrayExactly(r)?r.join("-"):r:e[1],a=this._container.getChild(o),s=a?wdFrp.just(a):this.loadAsset(r,o)["do"](function(t){i._container.addChild(o,t)},function(t){i._errorHandle(r,t)},null)},e.prototype.get=function(t){return this._container.getChild(t)},e.prototype.has=function(t){return this._container.hasChild(t)},e.prototype.dispose=function(){this._container.removeAllChildren()},e.prototype._errorHandle=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,o=null;r=t.JudgeUtils.isArrayExactly(e[0])?e[0].join(","):e[0],o=e[1],t.Log.log("load "+r+" asset fail:"+o)},e}();t.Loader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0];return t.AjaxLoader.load(r,"text")},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.GLSLLoader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this,o=e[0];return wdFrp.fromPromise(new RSVP.Promise(function(e,n){var i=r._createScript();i.async=!1,i.addEventListener("error",function(t){n("load js file error. url:"+o)}),i.readyState?i.onreadystatechange=function(){("loaded"===i.readyState||"complete"===i.readyState)&&(i.onreadystatechange=null,e(o))}:i.onload=function(){e(o)},i.src=o,t._appendScript(i)}))},n.prototype._createScript=function(){var t=document.createElement("script");return t.type="text/javascript",t},n.prototype._appendScript=function(t){document.getElementsByTagName("head")[0].appendChild(t)},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.JsLoader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null;return r=t.JudgeUtils.isString(e[0])?[e[0]]:e[0],wdFrp.fromPromise(new RSVP.Promise(function(e,n){t.Video.create({urlArr:r,onLoad:function(n){e(t.VideoTextureAsset.create(n))},onError:function(t){n(t)}})}))},n._instance=null,n}(t.Loader);t.VideoLoader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=null,o=null,i=e[0];switch(r=wdCb.PathUtils.extname(i).toLowerCase()){case".jpg":case".jpeg":case".gif":case".bmp":o=t.ImageLoader.load(i).map(function(e){var n=t.ImageTextureAsset.create(e);return n.format=t.ETextureFormat.RGB,n});break;case".png":o=t.ImageLoader.load(i).map(function(e){return t.ImageTextureAsset.create(e)});break;case".dds":o=t.CompressedTextureLoader.load(i);break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT(r))}return o},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.TextureLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.load=function(e){return wdFrp.fromPromise(new RSVP.Promise(function(n,r){var o=null;o=new t.root.Image,o.onload=function(){this.onload=null,n(o)},o.onerror=function(){r("error")},o.src=e}))},e}();t.ImageLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.load=function(t,e){return wdFrp.fromPromise(new RSVP.Promise(function(n,r){wdCb.AjaxUtils.ajax({type:"get",url:t,contentType:"text/plain; charset=utf-8",dataType:e,success:function(t){n(t)},error:function(e,n){r("url:"+t+"\nreadyState:"+e.readyState+"\nstatus:"+e.status+"\nmessage:"+n.message+"\nresponseText:"+e.responseText)}})}))},t}();t.AjaxLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.getPath=function(t,e){return wdCb.PathUtils.dirname(t)+"/"+e},t}();t.ModelLoaderUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.load=function(e){var n=this;return t.AjaxLoader.load(e,"arraybuffer").map(function(e){var r=t.DDSParser.parse(e,!0),o=t.CompressedTextureAsset.create();return o.width=r.width,o.height=r.height,o.mipmaps=r.mipmaps,1==r.mipmapCount&&(o.minFilter=t.ETextureFilterMode.LINEAR),o.format=n._getCompressedFormat(r.format),o})},e._getCompressedFormat=function(e){var n=t.GPUDetector.getInstance().extensionCompressedTextureS3TC;if(e===t.ETextureFormat.RGBA)return e;if(!n)return null;switch(e){case t.ETextureFormat.RGB_S3TC_DXT1:e=n.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case t.ETextureFormat.RGBA_S3TC_DXT1:e=n.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case t.ETextureFormat.RGBA_S3TC_DXT3:e=n.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case t.ETextureFormat.RGBA_S3TC_DXT5:e=n.COMPRESSED_RGBA_S3TC_DXT5_EXT}return e},e}();t.CompressedTextureLoader=e}(wd||(wd={}));var wd;!function(t){var e=542327876,n=131072,r=512,o=4,i=function(){function i(){}return i.parse=function(i,s){void 0===s&&(s=!0);var c=new a,u=this._fourCCToInt32("DXT1"),l=this._fourCCToInt32("DXT3"),h=this._fourCCToInt32("DXT5"),p=31,f=0,d=1,_=2,y=3,g=4,m=7,v=20,b=21,C=22,w=23,E=24,T=25,O=26,S=28,D=new Int32Array(i,0,p),x=null,L=null,M=null,A=null,F=null,R=null,P=null;if(D[f]!==e)return t.Log.error(!0,"Invalid magic number in DDS header."),c;if(!D[v]&o)return t.Log.error(!0,"Unsupported format, must contain a FourCC code."),c;switch(L=D[b],M=!1,L){case u:x=8,c.format=t.ETextureFormat.RGB_S3TC_DXT1;break;case l:x=16,c.format=t.ETextureFormat.RGBA_S3TC_DXT3;break;case h:x=16,c.format=t.ETextureFormat.RGBA_S3TC_DXT5;break;default:if(!(32==D[C]&&16711680&D[w]&&65280&D[E]&&255&D[T]&&4278190080&D[O]))return t.Log.error(!0,"Unsupported FourCC code "+this._int32ToFourCC(L)),c;M=!0,x=64,c.format=t.ETextureFormat.RGBA}c.mipmapCount=1,D[_]&n&&s!==!1&&(c.mipmapCount=Math.max(1,D[m])),c.isCubemap=D[S]&r?!0:!1,c.width=D[g],c.height=D[y],A=D[d]+4,F=c.width,R=c.height,P=c.isCubemap?6:1;for(var N=0;P>N;N++){for(var U=0;U<c.mipmapCount;U++){var j=null,I=null,B=null;M?(I=this._loadARGBMip(i,A,F,R),B=I.length):(B=Math.max(4,F)/4*Math.max(4,R)/4*x,I=new Uint8Array(i,A,B)),j={data:I,width:F,height:R},c.mipmaps.addChild(j),A+=B,F=Math.max(.5*F,1),R=Math.max(.5*R,1)}F=c.width,R=c.height}return c},i._fourCCToInt32=function(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)},i._int32ToFourCC=function(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)},i._loadARGBMip=function(t,e,n,r){for(var o=n*r*4,i=new Uint8Array(t,e,o),a=new Uint8Array(o),s=0,c=0,u=0;r>u;u++)for(var l=0;n>l;l++){var h=null,p=null,f=null,d=null;h=i[c],c++,p=i[c],c++,f=i[c],c++,d=i[c],c++,a[s]=f,s++,a[s]=p,s++,a[s]=h,s++,a[s]=d,s++}return a},i}();t.DDSParser=i;var a=function(){function t(){this.mipmaps=wdCb.Collection.create(),this.width=0,this.height=0,this.format=null,this.mipmapCount=1,this.isCubemap=!1}return t}();t.DDSData=a}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._width=null,this._height=null,this.generateMipmaps=!0,this.sourceRegionMethod=t.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL,this.format=t.ETextureFormat.RGBA,this.source=e.defaultTexture,this.repeatRegion=t.RectRegion.create(0,0,1,1),this.sourceRegion=null,this.sourceRegionMapping=t.ETextureSourceRegionMapping.CANVAS,this.flipY=!0,this.premultiplyAlpha=!1,this.unpackAlignment=4,this.wrapS=t.ETextureWrapMode.CLAMP_TO_EDGE,this.wrapT=t.ETextureWrapMode.CLAMP_TO_EDGE,this.magFilter=t.ETextureFilterMode.LINEAR,this.minFilter=t.ETextureFilterMode.LINEAR_MIPMAP_LINEAR,this.type=t.ETextureType.UNSIGNED_BYTE,this.mipmaps=wdCb.Collection.create(),this.anisotropy=0,this.needUpdate=!0}return Object.defineProperty(e.prototype,"width",{get:function(){return null===this._width?this.source?this.source.width:null:this._width},set:function(t){this._width=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return null===this._height?this.source?this.source.height:null:this._height},set:function(t){this._height=t},enumerable:!0,configurable:!0}),e.prototype.copyToCubemapTexture=function(e){e.generateMipmaps=this.generateMipmaps,e.minFilter=this.minFilter,e.magFilter=this.magFilter,e.width=this.width,e.height=this.height,e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.anisotropy=this.anisotropy,e.premultiplyAlpha=this.premultiplyAlpha,e.unpackAlignment=this.unpackAlignment,e.needUpdate=this.needUpdate,e.mode=t.EEnvMapMode.BASIC},e.prototype.copyTo=function(e){return t.Log.error(!e,t.Log.info.FUNC_MUST_DEFINE("texture")),e.source=this.source,e.width=this.width,e.height=this.height,e.mipmaps=this.mipmaps.copy(),e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.format=this.format,e.type=this.type,e.repeatRegion=this.repeatRegion.copy(),e.sourceRegion=this.sourceRegion&&this.sourceRegion.copy(),e.sourceRegionMapping=this.sourceRegionMapping,e.sourceRegionMethod=this.sourceRegionMethod,e.generateMipmaps=this.generateMipmaps,e.premultiplyAlpha=this.premultiplyAlpha,e.flipY=this.flipY,e.unpackAlignment=this.unpackAlignment,e.needUpdate=this.needUpdate,e},e.defaultTexture=null,e}();t.TextureAsset=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(t){e.call(this),this.source=t}return __extends(n,e),n.create=function(t){var e=new this(t);return e},n.prototype.toTexture=function(){return t.ImageTexture.create(this)},n.prototype.toCubemapFaceTexture=function(){return t.CubemapFaceImageTexture.create(this)},n.prototype.copyToCubemapFaceTexture=function(e){e.source=this.source,e.type=this.type,e.format=this.format,e.width=this.width,e.height=this.height,e.sourceRegion=this.sourceRegion,e.sourceRegionMethod=t.ETextureSourceRegionMethod.DRAW_IN_CANVAS},n}(t.TextureAsset);t.ImageTextureAsset=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(t){e.call(this),this.video=null,this.video=t,this.source=this.video.source}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(),e},n.prototype.initWhenCreate=function(){this.width=0,this.height=0,this.generateMipmaps=!1,this.minFilter=null,this.magFilter=null,this.sourceRegion=null,this.sourceRegionMethod=null},n.prototype.toTexture=function(){return t.VideoTexture.create(this)},n.prototype.toCubemapFaceTexture=function(){return t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("video texture","cubemap"))},n.prototype.copyToCubemapFaceTexture=function(e){t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("video texture","cubemap"))},n}(t.TextureAsset);t.VideoTextureAsset=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},n.prototype.initWhenCreate=function(){this.generateMipmaps=!1,this.flipY=!1},n.prototype.toTexture=function(){return t.CompressedTexture.create(this)},n.prototype.toCubemapFaceTexture=function(){return t.CubemapFaceCompressedTexture.create(this)},n.prototype.copyToCubemapFaceTexture=function(t){t.type=this.type,t.format=this.format,t.width=this.width,t.height=this.height,t.mipmaps=this.mipmaps,t.minFilter=this.minFilter},n}(t.TextureAsset);t.CompressedTextureAsset=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.NEAREST="NEAREST"]="NEAREST",t[t.NEAREST_MIPMAP_MEAREST="NEAREST_MIPMAP_MEAREST"]="NEAREST_MIPMAP_MEAREST",t[t.NEAREST_MIPMAP_LINEAR="NEAREST_MIPMAP_LINEAR"]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR="LINEAR"]="LINEAR",t[t.LINEAR_MIPMAP_NEAREST="LINEAR_MIPMAP_NEAREST"]="LINEAR_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_LINEAR="LINEAR_MIPMAP_LINEAR"]="LINEAR_MIPMAP_LINEAR"}(t.ETextureFilterMode||(t.ETextureFilterMode={}));t.ETextureFilterMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.REPEAT="REPEAT"]="REPEAT",t[t.MIRRORED_REPEAT="MIRRORED_REPEAT"]="MIRRORED_REPEAT",t[t.CLAMP_TO_EDGE="CLAMP_TO_EDGE"]="CLAMP_TO_EDGE"}(t.ETextureWrapMode||(t.ETextureWrapMode={}));t.ETextureWrapMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.RGB="RGB"]="RGB",t[t.RGBA="RGBA"]="RGBA",t[t.ALPHA="ALPHA"]="ALPHA",t[t.LUMINANCE="LUMINANCE"]="LUMINANCE",t[t.LUMINANCE_ALPHA="LUMINANCE_ALPHA"]="LUMINANCE_ALPHA",t[t.RGB_S3TC_DXT1="RGB_S3TC_DXT1"]="RGB_S3TC_DXT1",t[t.RGBA_S3TC_DXT1="RGBA_S3TC_DXT1"]="RGBA_S3TC_DXT1",t[t.RGBA_S3TC_DXT3="RGBA_S3TC_DXT3"]="RGBA_S3TC_DXT3",t[t.RGBA_S3TC_DXT5="RGBA_S3TC_DXT5"]="RGBA_S3TC_DXT5"}(t.ETextureFormat||(t.ETextureFormat={}));t.ETextureFormat}(wd||(wd={}));var wd;!function(t){!function(t){t[t.UNSIGNED_BYTE="UNSIGNED_BYTE"]="UNSIGNED_BYTE",t[t.UNSIGNED_SHORT_5_6_5="UNSIGNED_SHORT_5_6_5"]="UNSIGNED_SHORT_5_6_5",t[t.UNSIGNED_SHORT_4_4_4_4="UNSIGNED_SHORT_4_4_4_4"]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1="UNSIGNED_SHORT_5_5_5_1"]="UNSIGNED_SHORT_5_5_5_1"}(t.ETextureType||(t.ETextureType={}));t.ETextureType}(wd||(wd={}));
var wd;!function(t){!function(t){t[t.BASIC=0]="BASIC",t[t.REFLECTION=1]="REFLECTION",t[t.REFRACTION=2]="REFRACTION",t[t.FRESNEL=3]="FRESNEL"}(t.EEnvMapMode||(t.EEnvMapMode={}));t.EEnvMapMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.MIX=0]="MIX",t[t.MULTIPLY=1]="MULTIPLY",t[t.ADD=2]="ADD"}(t.ETextureCombineMode||(t.ETextureCombineMode={}));t.ETextureCombineMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.CANVAS=0]="CANVAS",t[t.UV=1]="UV"}(t.ETextureSourceRegionMapping||(t.ETextureSourceRegionMapping={}));t.ETextureSourceRegionMapping}(wd||(wd={}));var wd;!function(t){!function(t){t[t.CHANGE_TEXCOORDS_IN_GLSL=0]="CHANGE_TEXCOORDS_IN_GLSL",t[t.DRAW_IN_CANVAS=1]="DRAW_IN_CANVAS"}(t.ETextureSourceRegionMethod||(t.ETextureSourceRegionMethod={}));t.ETextureSourceRegionMethod}(wd||(wd={}));var wd;!function(t){!function(t){t[t.TEXTURE_2D="TEXTURE_2D"]="TEXTURE_2D",t[t.TEXTURE_CUBE_MAP="TEXTURE_CUBE_MAP"]="TEXTURE_CUBE_MAP"}(t.ETextureTarget||(t.ETextureTarget={}));t.ETextureTarget}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.assetCount=0,this.currentLoadedCount=0,this._assetTable=wdCb.Hash.create()}return e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},e.prototype.load=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=this;if(t.JudgeUtils.isString(e[0])){var o=e[0],i=o;return this._createLoadSingleAssetStream(o,i)}var a=e[0];return wdFrp.fromArray(a).flatMap(function(e){return r._createLoadMultiAssetStream(e.type||t.EAssetType.UNKNOW,e.url,e.id)})},e.prototype.reset=function(){this.assetCount=0,this.currentLoadedCount=0},e.prototype.dispose=function(){this.reset(),t.LoaderFactory.createAllLoader().forEach(function(t){t.dispose()})},e.prototype.get=function(t){var e=this._assetTable.getChild(t);return e?e.get(t):null},e.prototype._createLoadMultiAssetStream=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=t[0],r=t[1],o=t[2],i=this._getLoader(n,r),a=this;return i.has(o)||a.assetCount++,this._addToAssetTable(i.load(r,o).map(function(t){return a.currentLoadedCount++,{currentLoadedCount:a.currentLoadedCount,assetCount:a.assetCount}}),o,i)},e.prototype._createLoadSingleAssetStream=function(e,n){var r=this._getLoader(t.EAssetType.UNKNOW,e);return this._addToAssetTable(r.load(e,n),n,r)},e.prototype._getLoader=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0],o=null;return o=t.JudgeUtils.isArrayExactly(e[1])?wdCb.PathUtils.extname(e[1][0]):wdCb.PathUtils.extname(e[1]),t.LoaderFactory.create(r,o.toLowerCase())},e.prototype._addToAssetTable=function(t,e,n){var r=this;return t["do"](null,null,function(){r._assetTable.addChild(e,n)})},e._instance=null,e}();t.LoaderManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.create=function(e,n){var r=null;switch(e){case t.EAssetType.FONT:r=t.FontLoader.getInstance();break;case t.EAssetType.UNKNOW:r=this._getLoaderByExtname(n);break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("asset type:"+e))}return r},e.createAllLoader=function(){return wdCb.Collection.create([t.JsLoader.getInstance(),t.GLSLLoader.getInstance(),t.TextureLoader.getInstance(),t.VideoLoader.getInstance(),t.FontLoader.getInstance(),t.FntLoader.getInstance()])},e._getLoaderByExtname=function(e){var n=null;switch(e){case".js":n=t.JsLoader.getInstance();break;case".glsl":n=t.GLSLLoader.getInstance();break;case".jpg":case".jpeg":case".png":case".dds":case".gif":case".bmp":n=t.TextureLoader.getInstance();break;case".mp4":case".ogv":case".webm":n=t.VideoLoader.getInstance();break;case".gltf":n=t.GLTFLoader.getInstance();break;case".wd":n=t.WDLoader.getInstance();break;case".eot":case".ttf":case".woff":case".svg":n=t.FontLoader.getInstance();break;case".fnt":n=t.FntLoader.getInstance();break;default:t.Log.error(!0,t.Log.info.FUNC_UNKNOW("extname:"+e))}return n},e}();t.LoaderFactory=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._gltfAssembler=t.GLTFAssembler.create(),this._gltfParser=t.GLTFParser.create(),this._arrayBufferMap=wdCb.Hash.create(),this._imageMap=wdCb.Hash.create()}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0],o=this,i=null;return t.AjaxLoader.load(r,"json").flatMap(function(t){return i=t,o._createLoadAllAssetsStream(r,t)}).concat(wdFrp.callFunc(function(){return o._gltfAssembler.build(o._gltfParser.parse(i,o._arrayBufferMap,o._imageMap))}))},n.prototype._createLoadAllAssetsStream=function(t,e){return wdFrp.fromArray([this._createLoadBuffersStream(t,e),this._createLoadImageAssetStream(t,e)]).mergeAll()},n.prototype._createLoadBuffersStream=function(e,n){var r=this._arrayBufferMap;return this._createLoadAssetStream(e,n,n.buffers,r,function(e,n){return t.AjaxLoader.load(n,"arraybuffer")["do"](function(n){t.Log.error(!(n instanceof ArrayBuffer),t.Log.info.FUNC_SHOULD("Buffer:"+e,"be an array buffer")),t.Log.error(n.byteLength!==n.byteLength,t.Log.info.FUNC_SHOULD("Buffer:"+e+"'s length is "+n.byteLength+", but it","be "+n.byteLength)),r.addChild(e,n)})})},n.prototype._createLoadImageAssetStream=function(e,n){var r=this._imageMap;return this._createLoadAssetStream(e,n,n.images,r,function(e,n){return t.ImageLoader.load(n)["do"](function(t){r.addChild(e,t)})})},n.prototype._createLoadAssetStream=function(e,n,r,o,i){var a=[];if(r){var s=null;for(s in r)if(r.hasOwnProperty(s)){var c=r[s];if(t.GLTFUtils.isBase64(c.uri))o.addChild(s,t.GLTFUtils.decodeArrayBuffer(c.uri));else{var u=t.ModelLoaderUtils.getPath(e,c.uri);a.push(i(s,u))}}}return wdFrp.fromArray(a).mergeAll()},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.GLTFLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._result=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},e.prototype.build=function(t){return this._buildMetadata(t),this._buildModels(t),this._result},e.prototype._buildMetadata=function(t){var e=wdCb.Hash.create();for(var n in t.metadata)t.metadata.hasOwnProperty(n)&&e.addChild(n,t.metadata[n]);this._result.addChild("metadata",e)},e.prototype._buildModels=function(e){var n=wdCb.Collection.create(),r=this,o=function(e){var n=t.GameObject.create();return e.name&&(n.name=e.name),r._isModelContainer(e)&&n.addTag(t.EWDTag.CONTAINER),r._addComponentsFromGLTF(n,e.components),n.addComponent(t.MeshRenderer.create()),e.children&&e.children.forEach(function(t){n.addChild(o(t))}),n};e.objects&&(e.objects.forEach(function(t){n.addChild(o(t))}),this._result.addChild("models",n))},e.prototype._isModelContainer=function(t){return t.isContainer},e.prototype._addComponentsFromGLTF=function(t,e){var n=this;e.forEach(function(e){n._isTransform(e)?t.transform=n._createTransform(e):n._isCamera(e)?t.addComponent(n._createCamera(e)):n._isLight(e)?t.addComponent(n._createLight(e)):n._isGeometry(e)?t.addComponent(n._createGeometry(e)):n._isArticulatedAnimation(e)&&t.addComponent(n._createArticulatedAnimation(e))})},e.prototype._isTransform=function(t){return!!t.matrix||!!t.position},e.prototype._isCamera=function(t){return!!t.camera},e.prototype._isLight=function(t){return!!t.lightColor&&!!t.type},e.prototype._isGeometry=function(t){return!!t.material},e.prototype._isArticulatedAnimation=function(e){return t.GLTFUtils.isIGLTFArticulatedAnimation(e)},e.prototype._createTransform=function(e){var n=t.ThreeDTransform.create();return e.matrix?(n.localPosition=e.matrix.getTranslation(),n.localRotation=e.matrix.getRotation(),n.localScale=e.matrix.getScale()):(n.localPosition=e.position,n.localRotation=e.rotation,n.localScale=e.scale),n},e.prototype._createCamera=function(e){return t.BasicCameraController.create(e.camera)},e.prototype._createLight=function(e){var n=null;switch(e.type){case"ambient":n=t.AmbientLight.create(),n.color=e.lightColor;break;case"directional":n=t.DirectionLight.create(),n.color=e.lightColor;break;case"point":n=t.PointLight.create(),n.color=e.lightColor,t.GLTFUtils.addData(n,"range",e.distance),t.GLTFUtils.addData(n,"constant",e.constantAttenuation),t.GLTFUtils.addData(n,"linear",e.linearAttenuation),t.GLTFUtils.addData(n,"quadratic",e.quadraticAttenuation)}return n},e.prototype._createGeometry=function(e){var n=t.ModelGeometry.create();return n.vertices=e.vertices,n.faces=e.faces,t.GLTFUtils.addData(n,"colors",e.colors),t.GLTFUtils.addData(n,"texCoords",e.texCoords),n.drawMode=e.drawMode,n.material=this._createMaterial(e.material),n},e.prototype._createMaterial=function(e){var n=null;switch(e.type){case"BasicMaterial":n=this._createBasicMaterial(e);break;case"LightMaterial":n=this._createLightMaterial(e);break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("material type:"+e.type))}return n},e.prototype._createBasicMaterial=function(e){var n=t.BasicMaterial.create();return this._setBasicDataOfMaterial(n,e),n},e.prototype._createLightMaterial=function(e){var n=t.LightMaterial.create();return this._setBasicDataOfMaterial(n,e),e.transparent===!0&&void 0!==e.opacity&&(n.opacity=e.opacity,n.blendType=t.EBlendType.NORMAL),e.lightModel===t.ELightModel.LAMBERT?(t.Log.log(t.Log.info.FUNC_NOT_SUPPORT("LAMBERT light model, use PHONG light model instead")),n.lightModel=t.ELightModel.PHONG):n.lightModel=e.lightModel,t.GLTFUtils.addData(n,"color",e.diffuseColor),t.GLTFUtils.addData(n,"specularColor",e.specularColor),t.GLTFUtils.addData(n,"emissionColor",e.emissionColor),t.GLTFUtils.addData(n,"diffuseMap",e.diffuseMap),t.GLTFUtils.addData(n,"specularMap",e.specularMap),t.GLTFUtils.addData(n,"emissionMap",e.emissionMap),t.GLTFUtils.addData(n,"shininess",e.shininess),n},e.prototype._setBasicDataOfMaterial=function(e,n){n.doubleSided&&n.doubleSided===!0?e.side=t.ESide.BOTH:e.side=t.ESide.FRONT},e.prototype._createArticulatedAnimation=function(e){var n=t.ArticulatedAnimation.create();return n.data=wdCb.Hash.create(e),n},e}();t.GLTFAssembler=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this._data={},this._arrayBufferMap=null,this._imageMap=null,this._json=null,this._geometryParser=t.GLTFGeometryParser.create(),this._articulatedAnimationParser=t.GLTFArticulatedAnimationParser.create()}return e.create=function(){var t=new this;return t},e.prototype.parse=function(t,e,n){return this._json=t,this._arrayBufferMap=e,this._imageMap=n,t.asset&&this._parseMetadata(),this._parseObjects(),t.animations&&this._articulatedAnimationParser.parse(t,this._data.objects,this._arrayBufferMap),this._data},e.prototype._parseMetadata=function(){var t={},e=this._json;for(var n in e.asset)e.asset.hasOwnProperty(n)&&(t[n]=e.asset[n]);this._data.metadata=t},e.prototype._parseObjects=function(){var e=this,n=this._json,r=wdCb.Collection.create(),o=function(r,i){var a=t.GLTFUtils.createObjectData();if(a.id=r,i.name&&(a.name=i.name),i.meshes&&i.meshes.length>0){var s=null;i.meshes.length>1&&t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT("multi mesh(geometry), just use the first mesh(geometry)")),s=n.meshes[i.meshes[0]],!i.name&&s.name&&(a.name=s.name),e._geometryParser.parse(n,a,s,e._arrayBufferMap,e._imageMap)}if(i.extensions&&i.extensions.KHR_materials_common&&i.extensions.KHR_materials_common.light&&a.components.addChild(e._parseLight(i.extensions.KHR_materials_common.light)),i.camera&&a.components.addChild(e._parseCamera(i.camera)),i.matrix?a.components.addChild(e._parseTransform(i.matrix)):i.rotation&&i.scale&&i.translation&&a.components.addChild(e._parseTransform(i.translation,i.rotation,i.scale)),i.children)for(var c=0,u=i.children;c<u.length;c++){var l=u[c];a.children.addChild(o(l,n.nodes[l]))}return a};if(!n.scenes[n.scene])return void(this._data.objects=r);for(var i=0,a=n.scenes[n.scene].nodes;i<a.length;i++){var s=a[i];r.addChild(o(s,n.nodes[s]))}this._data.objects=r},e.prototype._parseLight=function(e){var n=this._json.extensions.KHR_materials_common.lights[e],r={};return t.GLTFUtils.addData(r,"type",n.type),this._parseLightDataByType(r,n,r.type),r},e.prototype._parseLightDataByType=function(e,n,r){var o=n[r];switch(r){case"ambient":case"directional":e.lightColor=t.GLTFUtils.getColor(o.color);break;case"point":e.lightColor=t.GLTFUtils.getColor(o.color),t.GLTFUtils.addData(e,"distance",o.distance),t.GLTFUtils.addData(e,"constantAttenuation",o.constantAttenuation),t.GLTFUtils.addData(e,"linearAttenuation",o.linearAttenuation),t.GLTFUtils.addData(e,"quadraticAttenuation",o.quadraticAttenuation)}},e.prototype._parseCamera=function(t){var e=this._json.cameras[t],n={};return this._parseCameraDataByType(n,e),n},e.prototype._parseCameraDataByType=function(e,n){var r=null,o=n.type,i=n[o];switch(o){case"perspective":if(i=n[o],r=t.PerspectiveCamera.create(),r.near=i.znear,r.far=i.zfar,i.aspectRatio)r.aspect=i.aspectRatio;else{var a=t.DeviceManager.getInstance().view;r.aspect=a.width/a.height}r.fovy=i.yfov,e.camera=r;break;case"orthographic":r=t.OrthographicCamera.create(),r.near=i.znear,r.far=i.zfar,r.left=-i.xmag,r.right=i.xmag,r.top=i.ymag,r.bottom=-i.ymag,e.camera=r;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("camera type:"+o))}},e.prototype._parseTransform=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r={};if(1===e.length){var o=e[0];r.matrix=t.Matrix4.create(new Float32Array(o))}else if(3===e.length){var i=e[0],a=e[1],s=e[2];r.position=t.Vector3.create(i[0],i[1],i[2]),r.rotation=t.Quaternion.create(a[0],a[1],a[2],a[3]),r.scale=t.Vector3.create(s[0],s[1],s[2])}return r},__decorate([t.require(function(e){var n=this._json.extensions.KHR_materials_common.lights;t.assert(n&&n[e],t.Log.info.FUNC_NOT_EXIST("lightId:"+e))})],e.prototype,"_parseLight",null),__decorate([t.require(function(e){var n=this._json.cameras;t.assert(n&&n[e],t.Log.info.FUNC_NOT_EXIST("cameraId:"+e))})],e.prototype,"_parseCamera",null),e}();t.GLTFParser=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this._arrayBufferMap=null,this._imageMap=null,this._json=null,this._materialParser=t.GLTFMaterialParser.create()}return e.create=function(){var t=new this;return t},e.prototype.parse=function(e,n,r,o,i){if(this._json=e,this._arrayBufferMap=o,this._imageMap=i,r.primitives.length>1){for(var a=0,s=r.primitives;a<s.length;a++){var c=s[a],u=t.GLTFUtils.createObjectData();this._setChildObjectNameWithMultiPrimitives(u,c),u.components.addChild(this._parseGeometry(c)),n.children.addChild(u)}n.isContainer=!0}else 1===r.primitives.length&&n.components.addChild(this._parseGeometry(r.primitives[0]))},e.prototype._setChildObjectNameWithMultiPrimitives=function(t,e){t.name=e.material},e.prototype._parseGeometry=function(e){var n=this._json,r=this._arrayBufferMap,o=null,i=null,a={},s=null,c=null,u=null,l=null,h=null;for(var p in e.attributes)if(e.attributes.hasOwnProperty(p)){var f=e.attributes[p];if(o=n.accessors[f],i=t.GLTFUtils.getBufferArrFromAccessor(n,o,r),"POSITION"===p)s=[],this._addGeometryData(s,i);else if(p.indexOf("TEXCOORD_")>-1)c=[],this._addGeometryData(c,i),this._normalizeTexCoords(c);else if("NORMAL"===p){l=[];for(var d=0,_=i;d<_.length;d++){var y=_[d];l.push(y)}}else"COLOR"===p&&(u=[],this._addGeometryData(u,i))}return h=this._getFaces(n,e.indices,l),t.GLTFUtils.addData(a,"vertices",s),t.GLTFUtils.addData(a,"colors",u),t.GLTFUtils.addData(a,"texCoords",c),t.GLTFUtils.addData(a,"faces",h),t.GLTFUtils.addData(a,"drawMode",this._parseDrawMode(e.mode)),a.material=this._materialParser.parse(n,e.material,this._imageMap),a},e.prototype._addGeometryData=function(t,e){for(var n=0,r=e.length;r>n;n++)t.push(e[n])},e.prototype._getFaces=function(e,n,r){var o=null,i=null,a=null,s=[];if(!n)return[];o=e.accessors[n],i=t.GLTFUtils.getBufferArrFromAccessor(e,o,this._arrayBufferMap);for(var c=0,u=i.length;u>c;c+=3){var l=i[c],h=i[c+1],p=i[c+2],f=[l,h,p];a=t.Face3.create(l,h,p),t.GeometryUtils.hasData(r)&&this._addNormalData(a.vertexNormals,r,f),s.push(a)}return s},e.prototype._addNormalData=function(t,e,n){var r=n[0],o=n[1],i=n[2];t.addChildren([this._getThreeComponentData(e,r),this._getThreeComponentData(e,o),this._getThreeComponentData(e,i)])},e.prototype._getThreeComponentData=function(e,n){var r=3*n;return t.Vector3.create(e[r],e[r+1],e[r+2])},e.prototype._parseDrawMode=function(e){var n=null;if(!e)return null;switch(e){case 0:n=t.EDrawMode.POINTS;break;case 1:n=t.EDrawMode.LINES;break;case 2:n=t.EDrawMode.LINE_LOOP;break;case 3:n=t.EDrawMode.LINE_STRIP;break;case 4:n=t.EDrawMode.TRIANGLES;break;case 5:n=t.EDrawMode.TRIANGLE_STRIP;break;case 6:n=t.EDrawMode.TRANGLE_FAN;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("mode:"+e))}return n},e.prototype._normalizeTexCoords=function(t){if(t)for(var e=0,n=t.length/2;n>e;e++)t[2*e+1]=1-t[2*e+1]},__decorate([t.require(function(e,n,r){var o=null,i=null;return n?(o=e.accessors[n],i=t.GLTFUtils.getBufferArrFromAccessor(e,o,this._arrayBufferMap),void t.assert(i.length%3===0,t.Log.info.FUNC_SHOULD("indices' count","3 times"))):[]})],e.prototype,"_getFaces",null),e}();t.GLTFGeometryParser=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this._imageMap=null,this._json=null}return e.create=function(){var t=new this;return t},e.prototype.parse=function(e,n,r){var o=null,i=null;if(this._json=e,this._imageMap=r,!this._isUseKHRMaterialExtension()){t.Log.log("no KHR_materials_common extension found, will use default material instead");var a={type:"BasicMaterial",doubleSided:!1};return a}var s={};return o=e.materials[n],t.Log.error(!o.extensions||!o.extensions.KHR_materials_common,t.Log.info.FUNC_SHOULD("materials","define KHR_materials_common extensions")),i=o.extensions.KHR_materials_common,t.GLTFUtils.addData(s,"doubleSided",i.doubleSided),t.GLTFUtils.addData(s,"transparent",Boolean(i.transparent)),s.type=this._getMaterialType(i.technique),s.lightModel=this._getLightModel(i.technique),this._addMaterialExtensionValues(s,i.values),s},e.prototype._isUseKHRMaterialExtension=function(){var t=this._json.extensionsUsed;return t?t.indexOf("KHR_materials_common")>-1:!1},e.prototype._getMaterialType=function(e){var n=null;switch(e){case"PHONG":case"BLINN":case"CONSTANT":case"LAMBERT":n="LightMaterial";break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("technique:"+e))}return n},e.prototype._getLightModel=function(e){var n=null;switch(e){case"PHONG":n=t.ELightModel.PHONG;break;case"BLINN":n=t.ELightModel.BLINN;break;case"CONSTANT":n=t.ELightModel.CONSTANT;break;case"LAMBERT":n=t.ELightModel.LAMBERT;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("technique:"+e))}return n},e.prototype._addMaterialExtensionValues=function(e,n){n&&(n.ambient&&t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT("ambient of material")),this._addMaterialLightColor(e,"diffuse",n.diffuse),this._addMaterialLightColor(e,"specular",n.specular),this._addMaterialLightColor(e,"emission",n.emission),n.shininess&&(e.shininess=n.shininess.value),n.transparency&&(e.opacity=n.transparency.value))},e.prototype._addMaterialLightColor=function(e,n,r){r&&(t.JudgeUtils.isArrayExactly(r)?e[n+"Color"]=t.GLTFUtils.getColor(r):this._isColor(r.type)?e[n+"Color"]=t.GLTFUtils.getColor(r.value):e[n+"Map"]=this._getTexture(r.value))},e.prototype._isColor=function(t){return 35666===Number(t)},e.prototype._getTexture=function(e){var n=null,r=null;return this._json.textures&&this._json.textures[e]?(n=this._json.textures[e],r=this._createTextureAsset(n.target,n.source),n.internalFormat!==n.format&&t.Log.warn("texture.internalFormat("+n.internalFormat+") !== texture.format("+n.format+"), here take texture.format value as their value"),n.format&&(r.format=this._getTextureFormat(n.format)),n.type&&(r.type=this._getTextureType(n.type)),this._addTextureSampler(r,n.sampler),r.toTexture()):null},e.prototype._createTextureAsset=function(e,n){var r=null,o=this._imageMap.getChild(n);switch(o||t.Log.warn("no image found in loader(id:"+n+")"),e){case 3553:r=t.ImageTextureAsset.create(o);break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("target except TEXTURE_2D"))}return r},e.prototype._getTextureType=function(e){var n=null;switch(e){case 5121:n=t.ETextureType.UNSIGNED_BYTE;break;case 33635:n=t.ETextureType.UNSIGNED_SHORT_5_6_5;break;case 32819:n=t.ETextureType.UNSIGNED_SHORT_4_4_4_4;break;case 32820:n=t.ETextureType.UNSIGNED_SHORT_5_5_5_1;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("texture->type:"+e))}return n},e.prototype._getTextureFormat=function(e){var n=null;switch(e){case 6406:n=t.ETextureFormat.ALPHA;break;case 6407:n=t.ETextureFormat.RGB;break;case 6408:n=t.ETextureFormat.RGBA;break;case 6409:n=t.ETextureFormat.LUMINANCE;break;case 6410:n=t.ETextureFormat.LUMINANCE_ALPHA;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("texture->format:"+e))}return n},e.prototype._addTextureSampler=function(t,e){var n=this._json.samplers[e];t.wrapT=this._getTextureWrap(n.wrapT),t.wrapS=this._getTextureWrap(n.wrapS),t.minFilter=this._getTextureFilter(n.minFilter),t.magFilter=this._getTextureFilter(n.magFilter)},e.prototype._getTextureFilter=function(e){var n=null;switch(e){case 9728:n=t.ETextureFilterMode.NEAREST;break;case 9729:n=t.ETextureFilterMode.LINEAR;break;case 9984:n=t.ETextureFilterMode.NEAREST_MIPMAP_MEAREST;break;case 9985:n=t.ETextureFilterMode.LINEAR_MIPMAP_NEAREST;break;case 9986:n=t.ETextureFilterMode.NEAREST_MIPMAP_LINEAR;break;case 9987:n=t.ETextureFilterMode.LINEAR_MIPMAP_LINEAR;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("texture filter:"+e))}return n},e.prototype._getTextureWrap=function(e){var n=null;switch(e){case 33071:n=t.ETextureWrapMode.CLAMP_TO_EDGE;break;case 33648:n=t.ETextureWrapMode.MIRRORED_REPEAT;break;case 10497:n=t.ETextureWrapMode.REPEAT;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("texture wrap:"+e))}return n},__decorate([t.require(function(e,n){t.assert(!!this._json.samplers[n],t.Log.info.FUNC_NOT_EXIST("samplerId:"+n))})],e.prototype,"_addTextureSampler",null),e}();t.GLTFMaterialParser=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this._arrayBufferMap=null,this._json=null,this._translationArrayOffset=null,this._rotationArrayOffset=null,this._scaleArrayOffset=null}return e.create=function(){var t=new this;return t},e.prototype.parse=function(e,n,r){var o=this,i=wdCb.Hash.create(),a=this;this._json=e,this._arrayBufferMap=r;var s=function(s){if(e.animations.hasOwnProperty(s)){for(var c=e.animations[s],u=wdCb.Hash.create(),l=0,h=c.channels.length;h>l;l++){var p=c.channels[l],f=p.target.id;u.appendChild(f,p)}u.forEach(function(u,l){var h=wdCb.Collection.create(),p=a._findNode(n,l),f=null,d=null;if(null===p)return void t.Log.warn("can't find node whose id is "+l+" to attach to animation named "+s);a._addAnimationToNode(i,l,p,a._getAnimName(c,s),h),f=a._getInputData(c,u),d=t.GLTFUtils.getBufferArrFromAccessor(e,e.accessors[f],r),o._translationArrayOffset=0,o._rotationArrayOffset=0,o._scaleArrayOffset=0;for(var _=0;_<d.length;_++){var y={};y.time=o._convertSecondToMillisecond(d[_]),y.targets=o._getKeyFrameDataTargets(c,u),h.addChild(y)}})}};for(var c in e.animations)s(c);this._addAnimationComponent(i)},e.prototype._getAnimName=function(t,e){return t.name?t.name:e},e.prototype._getInputData=function(t,e){var n=null;return e.forEach(function(e){var r=t.samplers[e.sampler];return r?(n=t.parameters[r.input],wdCb.$BREAK):void 0}),n},e.prototype._addAnimationToNode=function(t,e,n,r,o){t.hasChild(e)||t.addChild(e,{node:n,animationData:{}}),t.getChild(e).animationData[r]=o},e.prototype._getKeyFrameDataTargets=function(e,n){var r=this,o=wdCb.Collection.create();return n.forEach(function(n){var i=e.samplers[n.sampler],a=null,s=null,c=null,u={};if(i){switch(c=n.target.path,a=e.parameters[i.output],s=t.GLTFUtils.getBufferArrFromAccessor(r._json,r._json.accessors[a],r._arrayBufferMap),u.interpolationMethod=r._convertTointerpolationMethod(i.interpolation),c){case"translation":u.target=t.EArticulatedAnimationTarget.TRANSLATION,u.data=t.Vector3.create(s[r._translationArrayOffset],s[r._translationArrayOffset+1],s[r._translationArrayOffset+2]),r._translationArrayOffset+=3;break;case"rotation":u.target=t.EArticulatedAnimationTarget.ROTATION,u.data=t.Quaternion.create(s[r._rotationArrayOffset],s[r._rotationArrayOffset+1],s[r._rotationArrayOffset+2],s[r._rotationArrayOffset+3]),r._rotationArrayOffset+=4;break;case"scale":u.target=t.EArticulatedAnimationTarget.SCALE,u.data=t.Vector3.create(s[r._scaleArrayOffset],s[r._scaleArrayOffset+1],s[r._scaleArrayOffset+2]),r._scaleArrayOffset+=3;break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("path:"+c))}o.addChild(u)}}),o},e.prototype._findNode=function(t,e){var n=function(t){var r=t.findOne(function(t){return t.id===e});return r?r:(t.forEach(function(t){return r=n(t.children),r?wdCb.$BREAK:void 0}),r)};return n(t)},e.prototype._addAnimationComponent=function(t){t.forEach(function(t){var e=t.node,n=t.animationData;e.components.addChild(n)})},e.prototype._convertSecondToMillisecond=function(t){return 1e3*t},e.prototype._convertTointerpolationMethod=function(e){switch(e){case"LINEAR":return t.EKeyFrameInterpolation.LINEAR;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("interpolation:"+e))}},__decorate([t.require(function(e,n){var r=wdCb.Collection.create();for(var o in e.samplers)if(e.samplers.hasOwnProperty(o)){var i=e.samplers[o];r.addChild(i.input)}t.assert(1===r.removeRepeatItems().getCount(),t.Log.info.FUNC_SHOULD("all sampler->input","be the same"))})],e.prototype,"_getInputData",null),__decorate([t.ensure(function(e,n){n.forEach(function(e){var n=e.node;e.animationData;t.assert(n.components.filter(function(e){return t.GLTFUtils.isIGLTFArticulatedAnimation(e)}).getCount()<=1,t.Log.info.FUNC_SHOULD("node","only has 1 IGLTFArticulatedAnimation component"))})})],e.prototype,"_addAnimationComponent",null),e}();t.GLTFArticulatedAnimationParser=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.addData=function(t,e,n){void 0!==n&&null!==n&&(t[e]=n)},e.isBase64=function(t){return t.length<5?!1:"data:"===t.substr(0,5)},e.decodeArrayBuffer=function(t){for(var e=t.split(",")[1],n=atob(e),r=n.length,o=new Uint8Array(new ArrayBuffer(r)),i=0;r>i;i++)o[i]=n.charCodeAt(i);return o.buffer},e.createObjectData=function(){return{id:null,isContainer:!1,components:wdCb.Collection.create(),children:wdCb.Collection.create()}},e.getColor=function(e){var n=t.Color.create();return n.r=Number(e[0]),n.g=Number(e[1]),n.b=Number(e[2]),4===e.length&&(n.a=Number(e[3])),n},e.getBufferArrFromAccessor=function(e,n,r){var o=e.bufferViews[n.bufferView],i=r.getChild(o.buffer),a=n.byteOffset+o.byteOffset,s=n.count*this.getAccessorTypeSize(n);switch(n.componentType){case 5120:return new Int8Array(i,a,s);case 5121:return new Uint8Array(i,a,s);case 5122:return new Int16Array(i,a,s);case 5123:return new Uint16Array(i,a,s);case 5126:return new Float32Array(i,a,s);default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("componentType:"+n.componentType))}},e.getAccessorTypeSize=function(t){var e=t.type;switch(e){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}},e.isIGLTFArticulatedAnimation=function(e){if(!t.JudgeUtils.isDirectObject(e))return!1;for(var n in e)return e[n]instanceof wdCb.Collection&&e[n].getCount()>0&&void 0!==e[n].getChild(0).time},e}();t.GLTFUtils=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.CONTAINER="CONTAINER"]="CONTAINER"}(t.EWDTag||(t.EWDTag={}));t.EWDTag}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._wdParser=t.WDParser.create(),this._wdBuilder=t.WDBuilder.create(),this._parseData=null}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=this,n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];var o=n[0],i=this;return t.AjaxLoader.load(o,"json").flatMap(function(t){return i._parseData=i._wdParser.parse(t),e._createLoadMapStream(o)}).concat(wdFrp.callFunc(function(){return i._wdBuilder.build(i._parseData)}))},n.prototype._createLoadMapStream=function(e){var n=[],r=this._parseData;return r.materials.forEach(function(r){var o=[];r.diffuseMapUrl&&o.push(["diffuseMap",r.diffuseMapUrl]),r.specularMapUrl&&o.push(["specularMap",r.specularMapUrl]),r.normalMapUrl&&o.push(["normalMap",r.normalMapUrl]),n.push(wdFrp.fromArray(o).flatMap(function(n){var o=n[0],i=n[1];return t.TextureLoader.getInstance().load(t.ModelLoaderUtils.getPath(e,i))["do"](function(t){r[o]=t.toTexture()},null,null)}))}),wdFrp.fromArray(n).mergeAll()},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.WDLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._data={},this._objectParser=t.WDObjectParser.create()}return e.create=function(){var t=new this;return t},e.prototype.parse=function(t){return this._parseMetadata(t),this._parseScene(t),this._parseMaterial(t),this._parseObject(t),this._data},e.prototype._parseMetadata=function(t){this._data.metadata=t.metadata},e.prototype._parseObject=function(t){
this._objectParser.parse(this._data,t)},e.prototype._parseScene=function(t){this._data.scene=t.scene,t.scene.ambientColor&&(this._data.scene.ambientColor=this._createColor(t.scene.ambientColor))},e.prototype._parseMaterial=function(t){var e=this;this._data.materials=wdCb.Hash.create(t.materials),this._data.materials.forEach(function(t){t.diffuseColor&&(t.diffuseColor=e._createColor(t.diffuseColor)),t.specularColor&&(t.specularColor=e._createColor(t.specularColor))})},e.prototype._createColor=function(e){return t.Color.create("rgb("+e.join(",").replace(/^(\d+),/g,"$1.0,").replace(/,(\d+),/g,",$1.0,").replace(/,(\d+)$/g,",$1.0")+")")},e}();t.WDParser=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){}return e.create=function(){var t=new this;return t},e.prototype.parse=function(t,e){var n=null,r=this;t.objects=wdCb.Collection.create(e.objects),n=function(t){r._isObjectContainer(t)?t.isContainer=!0:(t.isContainer=!1,r._parseFromIndices(t)),t.children&&(t.children=wdCb.Collection.create(t.children),t.children.forEach(function(e){e.parent=t,n(e)}))},t.objects.forEach(function(t){t.parent=null,n(t),r._removeObjectContainerData(t)})},e.prototype._isObjectContainer=function(e){return!t.GeometryUtils.hasData(e.verticeIndices)},e.prototype._parseFromIndices=function(t){this._duplicateVertexWithDifferentUvs(t),this._parseObjectFromIndices(t),this._removeRebundantIndiceData(t)},e.prototype._duplicateVertexWithDifferentUvs=function(e){var n=[],r=wdCb.Hash.create(),o=e.verticeIndices,i=e.uvIndices;if(t.GeometryUtils.hasData(i))for(var a=0,s=o.length;s>a;a++){var c=o[a];this._isSameVertexWithDifferentUvsByCompareToFirstOne(n,i[a],c)&&(this._isUvIndiceEqualTheOneOfAddedVertex(r,c,i[a])?o[a]=this._getVerticeIndexOfAddedVertexByFindContainer(r,c,i[a]):this._addVertexData(e,r,c,a),c=o[a]),n[c]=i[a]}},e.prototype._isSameVertexWithDifferentUvsByCompareToFirstOne=function(t,e,n){return void 0!==t[n]&&t[n]!==e},e.prototype._addVertexData=function(e,n,r,o){var i=e.verticeIndices,a=e.uvIndices,s=e.normalIndices,c=this._findData(e,"vertices"),u=this._findData(e,"normals"),l=this._findData(e,"morphTargets"),h=null;if(this._addThreeComponent(c,r),h=this._getVerticeIndexOfAddedVertex(c),i[o]=h,t.GeometryUtils.hasData(l))for(var p=0,f=l;p<f.length;p++){var d=f[p];this._addThreeComponent(d.vertices,r),t.GeometryUtils.hasData(d.normals)&&this._addDuplicateNormalOfAddedVertex(d.normals,s,o,r)}t.GeometryUtils.hasData(u)&&(this._addDuplicateNormalOfAddedVertex(u,s,o,r),t.GeometryUtils.hasData(s)&&(s[o]=h)),n.appendChild(String(r),[a[o],h])},e.prototype._addDuplicateNormalOfAddedVertex=function(e,n,r,o){return t.GeometryUtils.hasData(n)?void this._addThreeComponent(e,e,n[r]):void this._addThreeComponent(e,e,o)},e.prototype._isUvIndiceEqualTheOneOfAddedVertex=function(t,e,n){var r=t.getChild(String(e));return r?r.hasChildWithFunc(function(t){var e=t[0];t[1];return e===n}):!1},e.prototype._getVerticeIndexOfAddedVertexByFindContainer=function(t,e,n){var r=t.getChild(String(e));return r.findOne(function(t){var e=t[0];t[1];return e===n})[1]},e.prototype._getVerticeIndexOfAddedVertex=function(t){return t.length/3-1},e.prototype._addThreeComponent=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(2===t.length){var n=t[0],r=t[1];n.push(n[3*r],n[3*r+1],n[3*r+2])}else{var o=t[0],i=t[1],r=t[2];o.push(i[3*r],i[3*r+1],i[3*r+2])}},e.prototype._parseObjectFromIndices=function(e){for(var n=[],r=[],o=null,i=this._findData(e,"vertices"),a=this._findData(e,"uvs"),s=this._findData(e,"normals"),c=this._findData(e,"colors"),u=0,l=e.verticeIndices.length;l>u;u+=3){var h=e.verticeIndices[u],p=e.verticeIndices[u+1],f=e.verticeIndices[u+2],d=[u,u+1,u+2],_=[h,p,f];o=t.Face3.create(h,p,f),t.GeometryUtils.hasData(e.uvIndices)&&t.GeometryUtils.hasData(a)&&this._setUV(n,a,e.uvIndices,d,_),t.GeometryUtils.hasData(s)&&this._setNormal(o.vertexNormals,s,e.normalIndices,d,_),r.push(o)}e.vertices=i,t.GeometryUtils.hasData(e.uvIndices)?e.uvs=n:e.uvs=a,e.colors=c,e.faces=r,this._setMorphTargets(e,e.verticeIndices,e.normalIndices)},e.prototype._getAnimName=function(t){var e=/([a-z]+)_?(\d+)/,n="default",r=t.match(e);return r&&r.length>1?r[1]:n},e.prototype._removeRebundantIndiceData=function(t){delete t.verticeIndices,delete t.uvIndices,delete t.normalIndices},e.prototype._removeObjectContainerData=function(t){var e=null;(e=function(t){t.isContainer&&(delete t.vertices,delete t.uvs,delete t.colors),t.children&&t.children.forEach(function(t){e(t)})})(t)},e.prototype._findData=function(t,e){var n=null;do n=t[e];while(!n&&null!==(t=t.parent));return n},e.prototype._setUV=function(t,e,n,r,o){var i=null,a=null,s=null,c=r[0],u=r[1],l=r[2],h=o[0],p=o[1],f=o[2];i=n[c],a=n[u],s=n[l],this._setTwoComponentData(t,e,h,i),this._setTwoComponentData(t,e,p,a),this._setTwoComponentData(t,e,f,s)},e.prototype._setTwoComponentData=function(t,e,n,r){t[2*n]=e[2*r],t[2*n+1]=e[2*r+1]},e.prototype._setThreeComponentData=function(t,e,n,r){t[3*n]=e[3*r],t[3*n+1]=e[3*r+1],t[3*n+2]=e[3*r+2]},e.prototype._getThreeComponentData=function(e,n){var r=3*n;return t.Vector3.create(e[r],e[r+1],e[r+2])},e.prototype._setNormal=function(e,n,r,o,i){var a=o[0],s=o[1],c=o[2];return t.GeometryUtils.hasData(r)?void this._addNormalData(e,n,[r[a],r[s],r[c]]):void this._addNormalData(e,n,i)},e.prototype._addNormalData=function(t,e,n){var r=n[0],o=n[1],i=n[2];if(t instanceof wdCb.Collection)t.addChildren([this._getThreeComponentData(e,r),this._getThreeComponentData(e,o),this._getThreeComponentData(e,i)]);else for(var a=t,s=0,c=[this._getThreeComponentData(e,r),this._getThreeComponentData(e,o),this._getThreeComponentData(e,i)];s<c.length;s++){var u=c[s];a.push(u.x,u.y,u.z)}},e.prototype._setMorphTargets=function(e,n,r){var o=this._findData(e,"morphTargets"),i=null,a=null;if(t.GeometryUtils.hasData(o)){i=wdCb.Hash.create(),a=wdCb.Hash.create();for(var s=0,c=o;s<c.length;s++){var u=c[s],l=this._getAnimName(u.name);if(i.appendChild(l,u.vertices),t.GeometryUtils.hasData(u.normals))if(t.GeometryUtils.hasData(r)){for(var h=[],p=0,f=n.length;f>p;p++)this._setThreeComponentData(h,u.normals,n[p],r[p]);a.appendChild(l,h)}else a.appendChild(l,u.normals)}}e.morphTargets=i,e.morphNormals=a},__decorate([t.require(function(e,n,r){t.assert(this._isUvIndiceEqualTheOneOfAddedVertex(e,n,r),t.Log.info.FUNC_SHOULD("uvIndex","equal the one of added vertex"))})],e.prototype,"_getVerticeIndexOfAddedVertexByFindContainer",null),__decorate([t.ensure(function(e,n){t.assert(!n.verticeIndices,t.Log.info.FUNC_SHOULD("object.verticeIndices","be removed")),t.assert(!n.uvIndices,t.Log.info.FUNC_SHOULD("object.uvIndices","be removed")),t.assert(!n.normalIndices,t.Log.info.FUNC_SHOULD("object.normalIndices","be removed"))})],e.prototype,"_removeRebundantIndiceData",null),e}();t.WDObjectParser=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._result=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},e.prototype.build=function(t){return this._buildMetadata(t),this._buildScene(t),this._buildModels(t),this._result},e.prototype._buildMetadata=function(t){var e=wdCb.Hash.create();for(var n in t.metadata)t.metadata.hasOwnProperty(n)&&e.addChild(n,t.metadata[n]);this._result.addChild("metadata",e)},e.prototype._buildScene=function(t){var e=wdCb.Hash.create();t.scene.ambientColor&&e.addChild("ambientColor",t.scene.ambientColor),this._result.addChild("scene",e)},e.prototype._buildModels=function(e){var n=wdCb.Collection.create(),r=this,o=null;o=function(n,i){n.forEach(function(n){var a=null,s=null;s=t.GameObject.create(),r._isModelContainer(n)?s.addTag(t.EWDTag.CONTAINER):(a=t.ModelGeometry.create(),a.vertices=n.vertices,a.faces=n.faces,a.texCoords=n.uvs,a.colors=n.colors,n.material&&(a.material=r._buildMaterial(n.material,e.materials)),a.morphTargets=n.morphTargets,a.morphFaceNormals=n.morphNormals,a.morphVertexNormals=n.morphNormals,t.GeometryUtils.hasData(a.morphTargets)&&s.addComponent(t.MorphAnimation.create()),s.addComponent(a)),s.name=n.name,s.addComponent(t.MeshRenderer.create()),i.addChild(s),n.children&&o(n.children,s)})},o(e.objects,n),this._result.addChild("models",n)},e.prototype._isModelContainer=function(t){return t.isContainer},e.prototype._buildMaterial=function(e,n){var r="LightMaterial",o=null,i=null,a=null;return s=n.findOne(function(t,n){return n===e}),o=s[1],i=o.type||r,wdCb.Log.error(!t[i],wdCb.Log.info.FUNC_NOT_EXIST("materialClass:"+i)),a=t[i].create(),a.name=e,o.diffuseColor&&(a.color=o.diffuseColor),o.specularColor&&(a.specularColor=o.specularColor),o.diffuseMap&&(a.diffuseMap=o.diffuseMap),o.specularMap&&(a.specularMap=o.specularMap),o.normalMap&&(a.normalMap=o.normalMap),null!==o.shininess&&(a.shininess=o.shininess),null!==o.opacity&&(a.opacity=o.opacity),a;var s},e}();t.WDBuilder=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e={".eot":"embedded-opentype",".ttf":"truetype",".woff":"woff",".svg":"svg"},n=function(n){function r(){n.apply(this,arguments),this._familyName=null}return __extends(r,n),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.dispose=function(){n.prototype.dispose.call(this),wdCb.DomQuery.create("#"+this._familyName).remove()},r.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[1],o=this;return this._familyName=r,wdFrp.fromPromise(new RSVP.Promise(function(n,i){o._addStyleElement(e,r),document.fonts?document.fonts.load("1em "+r).then(function(){n()},function(t){i(t)}):(t.Log.warn("your browser not support document.fonts api, so it can't ensure that the font is loaded"),n())}))},r.prototype._getType=function(t){return e[wdCb.PathUtils.extname(t).toLowerCase()]},r.prototype._addStyleElement=function(e,n){var r=wdCb.DomQuery.create('<style id="'+n+'"></style>'),o=null;if(r.prependTo("body"),o="@font-face { font-family:"+n+"; src:",t.JudgeUtils.isArrayExactly(e[0])){for(var i=e[0],a=0,s=i;a<s.length;a++){var c=s[a];o+="url('"+c+"') format('"+this._getType(c)+"'),"}o=o.replace(/,$/,";")}else{var c=e[0];o+="url('"+c+"') format('"+this._getType(c)+"');"}r.get(0).textContent+=o+"};"},r._instance=null,__decorate([t.require(function(n){var r=wdCb.PathUtils.extname(n).toLowerCase();t.assert(!!e[r],t.Log.info.FUNC_UNKNOW("type:"+r))})],r.prototype,"_getType",null),r}(t.Loader);t.FontLoader=n}(wd||(wd={}));var wd;!function(t){var e=/common [^\n]*(\n|$)/gi,n=/page [^\n]*(\n|$)/gi,r=/char [^\n]*(\n|$)/gi,o=/\w+=[^ \r\n]+/gi,i=/^[\-]?\d+$/,a=function(){function a(){}return a.create=function(){var t=new this;return t},a.prototype.parseFnt=function(r,o){var i={},a=null,s=null;return a=this._parseStrToObj(r.match(e)[0]),i.commonHeight=a.lineHeight,1!==a.pages&&t.Log.log("only supports 1 page"),s=this._parseStrToObj(r.match(n)[0]),0!==s.id&&t.Log.log("file could not be found"),i.atlasName=wdCb.PathUtils.changeBasename(o,s.file),this._parseChar(r,i),i},a.prototype._parseStrToObj=function(t){var e=t.match(o),n={};if(e)for(var r=0,a=e;r<a.length;r++){var s=a[r],c=s.indexOf("="),u=s.substring(0,c),l=s.substring(c+1);l.match(i)?l=parseInt(l):'"'==l[0]&&(l=l.substring(1,l.length-1)),n[u]=l}return n},a.prototype._parseChar=function(t,e){for(var n=t.match(r),o={},i=0,a=n;i<a.length;i++){var s=a[i],c=this._parseStrToObj(s),u=c.id;o[u]={rect:{x:c.x,y:c.y,width:c.width,height:c.height},xOffset:c.xoffset,yOffset:c.yoffset,xAdvance:c.xadvance}}e.fontDefDictionary=o},a}();t.FntParser=a}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._parser=t.FntParser.create()}return __extends(n,e),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.loadAsset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[0],o=this;return t.AjaxLoader.load(r,"text").map(function(t){return o._parser.parseFnt(t,r)})},n._instance=null,__decorate([t.require(function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],n.prototype,"loadAsset",null),n}(t.Loader);t.FntLoader=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this.view=null,this.gl=null,this._scissorTest=null,this._depthTest=null,this._depthFunc=null,this._side=null,this.polygonOffset=null,this._polygonOffsetMode=null,this._depthWrite=null,this._blend=null,this._writeRed=null,this._writeGreen=null,this._writeBlue=null,this._writeAlpha=null,this._blendSrc=null,this._blendDst=null,this._blendEquation=null,this._blendFuncSeparate=null,this._blendEquationSeparate=null}return e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},Object.defineProperty(e.prototype,"scissorTest",{get:function(){return this._scissorTest},set:function(t){var e=this.gl;t?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),this._scissorTest=t},enumerable:!0,configurable:!0}),e.prototype.setScissor=function(t,e,n,r){this.gl.scissor(t,e,n,r),this.scissorTest||(this.scissorTest=!0)},e.prototype.setViewport=function(t,e,n,r){this.gl.viewport(t,e,n,r)},Object.defineProperty(e.prototype,"depthTest",{get:function(){return this._depthTest},set:function(t){var e=this.gl;this._depthTest!==t&&(t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._depthTest=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(t){var e=this.gl;this._depthFunc!==t&&(e.depthFunc(e[t]),this._depthFunc=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"side",{get:function(){return this._side},set:function(e){var r=this.gl;if(this._side!==e){switch(e){case n.NONE:r.enable(r.CULL_FACE),r.cullFace(r.FRONT_AND_BACK);break;case n.BOTH:r.disable(r.CULL_FACE);break;case n.FRONT:r.enable(r.CULL_FACE),r.cullFace(r.BACK);break;case n.BACK:r.enable(r.CULL_FACE),r.cullFace(r.FRONT);break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("side",e))}this._side=e}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"polygonOffsetMode",{get:function(){return this._polygonOffsetMode},set:function(e){var n=this.gl;if(this._polygonOffsetMode!==e){switch(e){case r.NONE:n.polygonOffset(0,0),n.disable(n.POLYGON_OFFSET_FILL);break;case r.IN:n.enable(n.POLYGON_OFFSET_FILL),n.polygonOffset(1,1);break;case r.OUT:n.enable(n.POLYGON_OFFSET_FILL),n.polygonOffset(-1,-1);break;case r.CUSTOM:n.enable(n.POLYGON_OFFSET_FILL),t.Log.error(!this.polygonOffset,t.Log.info.FUNC_MUST_DEFINE("polygonOffset")),n.polygonOffset(this.polygonOffset.x,this.polygonOffset.y)}this._polygonOffsetMode=e}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthWrite",{get:function(){return this._depthWrite},set:function(t){this._depthWrite!==t&&(this.gl.depthMask(t),this._depthWrite=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blend",{get:function(){return this._blend},set:function(t){var e=this.gl;this._blend!==t&&(t?e.enable(e.BLEND):e.disable(e.BLEND),this._blend=t)},enumerable:!0,configurable:!0}),e.prototype.setBlendFunc=function(t,e){(this._blendSrc!==t||this._blendDst!==e)&&(this._blend&&this.gl.blendFunc(this.gl[t],this.gl[e]),this._blendSrc=t,this._blendDst=e)},e.prototype.setBlendEquation=function(t){this._blendEquation!==t&&(this._blend&&this.gl.blendEquation(this.gl[t]),this._blendEquation=t)},e.prototype.setBlendFuncSeparate=function(t){var e=this.gl;this._blendFuncSeparate&&this._blendFuncSeparate[0]===t[0]&&this._blendFuncSeparate[1]===t[1]||(this._blend&&e.blendFuncSeparate(e[t[0]],e[t[1]],e[t[2]],e[t[3]]),this._blendFuncSeparate=t)},e.prototype.setBlendEquationSeparate=function(t){var e=this.gl;this._blendEquationSeparate&&this._blendEquationSeparate[0]===t[0]&&this._blendEquationSeparate[1]===t[1]||(this._blend&&e.blendEquationSeparate(e[t[0]],e[t[1]]),this._blendEquationSeparate=t)},e.prototype.setColorWrite=function(t,e,n,r){(this._writeRed!==t||this._writeGreen!==e||this._writeBlue!==n||this._writeAlpha!==r)&&(this.gl.colorMask(t,e,n,r),this._writeRed=t,this._writeGreen=e,this._writeBlue=n,this._writeAlpha=r)},e.prototype.clear=function(t){var e=this.gl,n=t.color;e.clearColor(n.r,n.g,n.b,n.a),this.setColorWrite(!0,!0,!0,!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)},e.prototype.createGL=function(e){var n=null;n=e?wdCb.DomQuery.create(e).get(0):wdCb.DomQuery.create("<canvas></canvas>").prependTo("body").get(0),this.view=t.ViewWebGL.create(n),this.gl=this.view.getContext()},e.prototype.setScreen=function(){var e=t.Main.screenSize,n=null,r=null,o=null,i=null;e===t.EScreenSize.FULL?(n=0,r=0,o=t.root.innerWidth,i=t.root.innerHeight,wdCb.DomQuery.create("body").css("margin","0")):(n=e.x||0,r=e.y||0,o=e.width||t.root.innerWidth,i=e.height||t.root.innerHeight),this.view.x=n,this.view.y=r,this.view.width=o,this.view.height=i,this.setViewport(0,0,o,i)},e._instance=null,__decorate([t.require(function(){t.assert(null!==t.Main.screenSize,t.Log.info.FUNC_NOT_EXIST("Main.screenSize"))})],e.prototype,"setScreen",null),e}();t.DeviceManager=e,function(t){t[t.NEVER="NEVER"]="NEVER",t[t.ALWAYS="ALWAYS"]="ALWAYS",t[t.LESS="LESS"]="LESS",t[t.LEQUAL="LEQUAL"]="LEQUAL",t[t.EQUAL="EQUAL"]="EQUAL",t[t.GEQUAL="GEQUAL"]="GEQUAL",t[t.GREATER="GREATER"]="GREATER",t[t.NOTEQUAL="NOTEQUAL"]="NOTEQUAL"}(t.EDepthFunction||(t.EDepthFunction={}));t.EDepthFunction;!function(t){t[t.NONE=0]="NONE",t[t.BOTH=1]="BOTH",t[t.BACK=2]="BACK",t[t.FRONT=3]="FRONT"}(t.ESide||(t.ESide={}));var n=t.ESide;!function(t){t[t.NONE=0]="NONE",t[t.IN=1]="IN",t[t.OUT=2]="OUT",t[t.CUSTOM=3]="CUSTOM"}(t.EPolygonOffsetMode||(t.EPolygonOffsetMode={}));var r=t.EPolygonOffsetMode;!function(t){t[t.ZERO="ZEOR"]="ZERO",t[t.ONE="ONE"]="ONE",t[t.SRC_COLOR="SRC_COLOR"]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR="ONE_MINUS_SRC_COLOR"]="ONE_MINUS_SRC_COLOR",t[t.DST_COLOR="DST_COLOR"]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR="ONE_MINUS_DST_COLOR"]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA="SRC_ALPHA"]="SRC_ALPHA",t[t.SRC_ALPHA_SATURATE="SRC_ALPHA_SATURATE"]="SRC_ALPHA_SATURATE",t[t.ONE_MINUS_SRC_ALPHA="ONE_MINUS_SRC_ALPHA"]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA="DST_ALPHA"]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPH="ONE_MINUS_DST_ALPHA"]="ONE_MINUS_DST_ALPH"}(t.EBlendFunc||(t.EBlendFunc={}));t.EBlendFunc;!function(t){t[t.ADD="FUNC_ADD"]="ADD",t[t.SUBTRACT="FUNC_SUBTRACT"]="SUBTRACT",t[t.REVERSE_SUBTRAC="FUNC_REVERSE_SUBTRACT"]="REVERSE_SUBTRAC"}(t.EBlendEquation||(t.EBlendEquation={}));t.EBlendEquation;!function(t){t[t.NONE=0]="NONE",t[t.NORMAL=1]="NORMAL",t[t.ADDITIVE=2]="ADDITIVE",t[t.ADDITIVEALPHA=3]="ADDITIVEALPHA",t[t.MULTIPLICATIVE=4]="MULTIPLICATIVE",t[t.PREMULTIPLIED=5]="PREMULTIPLIED"}(t.EBlendType||(t.EBlendType={}));t.EBlendType;!function(t){t[t.UI="UI"]="UI"}(t.ECanvasType||(t.ECanvasType={}));t.ECanvasType}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.maxTextureUnit=null,this.maxTextureSize=null,this.maxCubemapTextureSize=null,this.maxAnisotropy=null,this.extensionCompressedTextureS3TC=null,this.extensionTextureFilterAnisotropic=null,this.precision=null,this._isDetected=!1}return e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},Object.defineProperty(e.prototype,"gl",{get:function(){return t.DeviceManager.getInstance().gl},enumerable:!0,configurable:!0}),e.prototype.detect=function(){this._isDetected=!0,this._detectExtension(),this._detectCapabilty()},e.prototype._detectExtension=function(){this.extensionCompressedTextureS3TC=this._getExtension("WEBGL_compressed_texture_s3tc"),this.extensionTextureFilterAnisotropic=this._getExtension("EXT_texture_filter_anisotropic")},e.prototype._detectCapabilty=function(){var t=this.gl;this.maxTextureUnit=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubemapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxAnisotropy=this._getMaxAnisotropy(),this._detectPrecision()},e.prototype._getExtension=function(t){var e,n=this.gl;switch(t){case"EXT_texture_filter_anisotropic":e=n.getExtension("EXT_texture_filter_anisotropic")||n.getExtension("MOZ_EXT_texture_filter_anisotropic")||n.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":e=n.getExtension("WEBGL_compressed_texture_s3tc")||n.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||n.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":e=n.getExtension("WEBGL_compressed_texture_pvrtc")||n.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:e=n.getExtension(t)}return e},e.prototype._getMaxAnisotropy=function(){var t=this.extensionTextureFilterAnisotropic,e=this.gl;return null!==t?e.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0},e.prototype._detectPrecision=function(){var e=this.gl,r=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),o=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),i=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),a=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT),s=r.precision>0&&i.precision>0,c=o.precision>0&&a.precision>0;s?this.precision=n.HIGHP:c?(this.precision=n.MEDIUMP,t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT("gpu","highp, using mediump"))):(this.precision=n.LOWP,t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT("gpu","highp and mediump, using lowp")))},e._instance=null,e}();t.GPUDetector=e,function(t){t[t.HIGHP=0]="HIGHP",t[t.MEDIUMP=1]="MEDIUMP",t[t.LOWP=2]="LOWP"}(t.EGPUPrecision||(t.EGPUPrecision={}));var n=t.EGPUPrecision}(wd||(wd={}));var wd;!function(t){!function(t){t[t.FULL=0]="FULL"}(t.EScreenSize||(t.EScreenSize={}));t.EScreenSize}(wd||(wd={}));var wd;!function(t){var e=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.x=null,this.y=null,this.x=t,this.y=e}return t.create=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null);var n=new this(t,e);return n},t}();t.Point=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e,n,r,o){this._faceNormal=null,this.aIndex=null,this.bIndex=null,this.cIndex=null,this.vertexNormals=null,this.aIndex=t,this.bIndex=e,this.cIndex=n,this._faceNormal=r,this.vertexNormals=o}return e.create=function(t,e,n,r,o){void 0===r&&(r=null),void 0===o&&(o=wdCb.Collection.create());var i=new this(t,e,n,r,o);return i},Object.defineProperty(e.prototype,"faceNormal",{get:function(){return null!==this._faceNormal?this._faceNormal:t.Vector3.create(0,0,0)},set:function(t){this._faceNormal=t},enumerable:!0,configurable:!0}),e.prototype.hasFaceNormal=function(){return null!==this._faceNormal},e.prototype.hasVertexNormal=function(){return this.vertexNormals.getCount()>0},e.prototype.copy=function(){var t=this._faceNormal?this._faceNormal.copy():null,n=null;return this.vertexNormals&&(n=wdCb.Collection.create(),this.vertexNormals.forEach(function(t){n.addChild(t.copy())})),e.create(this.aIndex,this.bIndex,this.cIndex,t,n)},e}();t.Face3=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"width",{get:function(){return this.z},set:function(t){this.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.w},set:function(t){this.w=t},enumerable:!0,configurable:!0}),e.prototype.copy=function(){return this.copyHelper(e.create())},e.prototype.isNotEmpty=function(){return 0!==this.x||0!==this.y||0!==this.width||0!==this.height},e}(t.Vector4);t.RectRegion=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(t){this._dom=null,this._dom=t}return t.create=function(t){var e=new this(t);return e},Object.defineProperty(t.prototype,"offset",{get:function(){for(var t=this._dom,e={x:t.offsetLeft,y:t.offsetTop};t=t.offsetParent;)e.x+=t.offsetLeft,e.y+=t.offsetTop;return e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dom",{get:function(){return this._dom},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._dom.width},set:function(t){this._dom.width=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._dom.height},set:function(t){this._dom.height=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return Number(this._dom.style.left.slice(0,-2))},set:function(t){this._dom.style.position="absolute",this._dom.style.left=t+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return Number(this._dom.style.top.slice(0,-2))},set:function(t){this._dom.style.position="absolute",this._dom.style.top=t+"px"},enumerable:!0,configurable:!0}),t.prototype.getContext=function(){return this._dom.getContext("webgl")||this._dom.getContext("experimental-webgl")},t}();t.ViewWebGL=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this._r=null,this._g=null,this._b=null,this._a=null,this._colorString=null,this._colorVec3Cache=null,this._colorVec4Cache=null}return e.create=function(t){var e=new this;return e.initWhenCreate(t),e},Object.defineProperty(e.prototype,"dirty",{set:function(t){t&&this._clearCache()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"r",{get:function(){return this._r},set:function(t){this._r!==t&&(this.dirty=!0,this._r=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"g",{get:function(){return this._g},set:function(t){this._g!==t&&(this.dirty=!0,this._g=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"b",{get:function(){return this._b},set:function(t){this._b!==t&&(this.dirty=!0,this._b=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"a",{get:function(){return this._a},set:function(t){this._a!==t&&(this.dirty=!0,this._a=t)},enumerable:!0,configurable:!0}),e.prototype.initWhenCreate=function(t){t&&(this._colorString=t,this._setColor(t))},e.prototype.toVector3=function(){return t.Vector3.create(this.r,this.g,this.b)},e.prototype.toVector4=function(){return t.Vector4.create(this.r,this.g,this.b,this.a)},e.prototype.toString=function(){return this._colorString},e.prototype._setColor=function(t){var e=/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*([^\)]+)\)$/i,n=/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/i,r=/^rgb\((\d+\.\d+),\s*(\d+\.\d+),\s*(\d+\.\d+)\)$/i,o=/^\#([0-9a-f]{6})$/i,i=null;return e.test(t)?(i=e.exec(t),this.r=this._getColorValue(i,1),this.g=this._getColorValue(i,2),this.b=this._getColorValue(i,3),this.a=Number(i[4]),this):n.test(t)?(i=n.exec(t),this.r=this._getColorValue(i,1),this.g=this._getColorValue(i,2),this.b=this._getColorValue(i,3),this.a=1,this):r.test(t)?(i=r.exec(t),this.r=parseFloat(i[1]),this.g=parseFloat(i[2]),this.b=parseFloat(i[3]),this.a=1,this):o.test(t)?(i=o.exec(t),this._setHex(parseInt(i[1],16)),this):void 0},e.prototype._getColorValue=function(t,e,n){return void 0===n&&(n=255),Math.min(n,parseInt(t[e],10))/n},e.prototype._setHex=function(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this.a=1,this},e.prototype._clearCache=function(){this._colorVec3Cache=null,this._colorVec4Cache=null},__decorate([t.cache(function(){return null!==this._colorVec3Cache},function(){return this._colorVec3Cache},function(t){this._colorVec3Cache=t})],e.prototype,"toVector3",null),__decorate([t.cache(function(){return null!==this._colorVec4Cache},function(){return this._colorVec4Cache},function(t){this._colorVec4Cache=t})],e.prototype,"toVector4",null),e}();t.Color=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(){function e(){this.material=null,this.width=null,this.height=null,this.variableData=null,this.wrapS=null,this.wrapT=null,this.magFilter=null,this.minFilter=null,this.glTexture=null,this.target=t.ETextureTarget.TEXTURE_2D}return Object.defineProperty(e.prototype,"geometry",{get:function(){return this.material.geometry},enumerable:!0,configurable:!0}),e.prototype.bindToUnit=function(e){var n=t.DeviceManager.getInstance().gl,r=t.GPUDetector.getInstance().maxTextureUnit;return e>=r&&t.Log.warn("trying to use "+e+" texture units, but GPU only supports "+r+" units"),n.activeTexture(n["TEXTURE"+String(e)]),n.bindTexture(n[this.target],this.glTexture),this},e.prototype.sendData=function(t,e,n){t.sendUniformData(e,this.getSamplerType(),n),this.sendOtherData(t,n)},e.prototype.dispose=function(){var e=t.DeviceManager.getInstance().gl;e.deleteTexture(this.glTexture),delete this.glTexture},e.prototype.filterFallback=function(e){return e===t.ETextureFilterMode.NEAREST||e===t.ETextureFilterMode.NEAREST_MIPMAP_MEAREST||e===t.ETextureFilterMode.NEAREST_MIPMAP_LINEAR?t.ETextureFilterMode.NEAREST:t.ETextureFilterMode.LINEAR},e.prototype.sendOtherData=function(t,e){},e.prototype.getSamplerNameByVariableData=function(e,n){var r=null;return this.variableData?this.variableData.samplerVariableName&&(r=this.variableData.samplerVariableName):r=n===t.EVariableType.SAMPLER_2D?"u_sampler2D"+e:"u_samplerCube"+e,r},e.prototype.getSamplerType=function(){var e=null;switch(this.target){case t.ETextureTarget.TEXTURE_2D:e=t.EVariableType.SAMPLER_2D;break;case t.ETextureTarget.TEXTURE_CUBE_MAP:e=t.EVariableType.SAMPLER_CUBE}return e},e.prototype.isSourcePowerOfTwo=function(){return t.TextureUtils.isPowerOfTwo(this.width,this.height);
},e.prototype.setTextureParameters=function(e,n){var r=t.DeviceManager.getInstance().gl;n?(r.texParameteri(e,r.TEXTURE_WRAP_S,r[this.wrapS]),r.texParameteri(e,r.TEXTURE_WRAP_T,r[this.wrapT]),r.texParameteri(e,r.TEXTURE_MAG_FILTER,r[this.magFilter]),r.texParameteri(e,r.TEXTURE_MIN_FILTER,r[this.minFilter])):(r.texParameteri(e,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(e,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(e,r.TEXTURE_MAG_FILTER,r[this.filterFallback(this.magFilter)]),r.texParameteri(e,r.TEXTURE_MIN_FILTER,r[this.filterFallback(this.minFilter)]))},__decorate([t.virtual],e.prototype,"sendOtherData",null),__decorate([t.virtual],e.prototype,"isSourcePowerOfTwo",null),e}();t.Texture=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.isPowerOfTwo=function(e,n){return t.JudgeUtils.isPowerOfTwo(e)&&t.JudgeUtils.isPowerOfTwo(n)},e}();t.TextureUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.isDrawPartOfTexture=function(e,n){return e&&e.isNotEmpty()&&n===t.ETextureSourceRegionMethod.DRAW_IN_CANVAS},n.drawPartOfTextureByCanvas=function(t,e,n,r,o,i,a,s,c,u,l){var h=wdCb.DomQuery.create("<canvas></canvas>").get(0),p=null;return h.width=e,h.height=n,p=h.getContext("2d"),p.drawImage(t,r,o,i,a,s,c,u,l),h},n.isSourcePowerOfTwo=function(t,e,n,r){return this.isDrawPartOfTexture(t,e)?this.isPowerOfTwo(t.width,t.height):this.isPowerOfTwo(n,r)},n.needClampMaxSize=function(t,e,n){return e>t||n>t},n.clampToMaxSize=function(e,n){var r=null,o=null,i=null,a=null;return r=Math.max(e.width,e.height),o=Math.floor(e.width*n/r),i=Math.floor(e.height*n/r),a=this.drawPartOfTextureByCanvas(e,o,i,0,0,e.width,e.height,0,0,o,i),t.Log.log("source is too big (width:"+e.width+", height:"+e.height+"), resize it to be width:"+a.width+", height:"+a.height+"."),a},n}(t.TextureUtils);t.BasicTextureUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.init=function(){return this.minFilter=t.ETextureFilterMode.LINEAR,this.magFilter=t.ETextureFilterMode.LINEAR,this.wrapS=t.ETextureWrapMode.CLAMP_TO_EDGE,this.wrapT=t.ETextureWrapMode.CLAMP_TO_EDGE,this},n.prototype.getPosition=function(){return this.geometry.entityObject.transform.position},n.prototype.setEmptyTexture=function(e){var n=t.DeviceManager.getInstance().gl;t.Log.error(!e,"Failed to create texture object"),n.bindTexture(n[this.target],e),this.setTextureParameters(n[this.target],this.isSourcePowerOfTwo())},n}(t.Texture);t.RenderTargetTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._renderList=null,this.width=256,this.height=256}return __extends(n,e),Object.defineProperty(n.prototype,"renderList",{get:function(){return this._renderList},set:function(e){t.JudgeUtils.isArrayExactly(e)?this._renderList=wdCb.Collection.create(e):e instanceof wdCb.Collection?this._renderList=e:t.Log.error(!0,t.Log.info.FUNC_MUST_BE("renderList","array or wdCb.Collection"))},enumerable:!0,configurable:!0}),n.prototype.createEmptyTexture=function(){var e=t.DeviceManager.getInstance().gl,n=e.createTexture();this.setEmptyTexture(n),e.texImage2D(e[this.target],0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),this.glTexture=n},n}(t.RenderTargetTexture);t.TwoDRenderTargetTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.setTextureParameters=function(e){var n=t.DeviceManager.getInstance().gl,r=t.Director.getInstance().scene;r.shadowMap.softType===t.EShadowMapSoftType.PCF&&(n.texParameteri(e,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(e,n.TEXTURE_MIN_FILTER,n.NEAREST))},e}();t.ShadowMapTextureUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._plane=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addRenderTargetRenderer(t.MirrorRenderTargetRenderer.create(this)),this},n.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_2D)},n.prototype.getPlane=function(){var e=null,n=null,r=null;return this._plane&&!this.geometry.entityObject.transform.dirtyLocal?this._plane:(t.Log.error(!(this.geometry instanceof t.PlaneGeometry),t.Log.info.FUNC_MUST_BE("geometry","PlaneGeometry")),e=this.geometry.geometryData.normals,n=this.geometry.entityObject.transform.localRotation.multiplyVector3(t.Vector3.create(e[0],e[1],e[2])).normalize(),r=this.getPosition(),this._plane=t.Plane.create(n.x,n.y,n.z,-r.dot(n)),this._plane)},n}(t.TwoDRenderTargetTexture);t.MirrorTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.getSamplerName=function(e){return t.Log.error(!t.JudgeUtils.isNumber(this.variableData.samplerData),t.Log.info.FUNC_MUST_BE("shadowMapTexture->variableData.samplerData","samplerIndex")),"u_twoDShadowMapSampler["+this.variableData.samplerData+"]"},n.prototype.setTextureParameters=function(n,r){e.prototype.setTextureParameters.call(this,n,r),t.ShadowMapTextureUtils.setTextureParameters(n)},n}(t.TwoDRenderTargetTexture);t.TwoDShadowMapTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.target=t.ETextureTarget.TEXTURE_CUBE_MAP}return __extends(n,e),n.prototype.createEmptyTexture=function(){var e=t.DeviceManager.getInstance().gl,n=e.createTexture(),r=null;for(this.setEmptyTexture(n),r=0;6>r;r++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+r,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null);this.glTexture=n},n}(t.RenderTargetTexture);t.CubemapRenderTargetTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.getSamplerName=function(e){return t.Log.error(!t.JudgeUtils.isNumber(this.variableData.samplerData),t.Log.info.FUNC_MUST_BE("shadowMapTexture->variableData.samplerData","samplerIndex")),"u_cubemapShadowMapSampler["+this.variableData.samplerData+"]"},n}(t.CubemapRenderTargetTexture);t.CubemapShadowMapTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._renderList=null,this.size=256,this.near=.1,this.far=100,this.mode=null}return __extends(n,e),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"renderList",{get:function(){return this._renderList},set:function(e){t.JudgeUtils.isDirectObject(e)?this._renderList=wdCb.Hash.create(e):e instanceof wdCb.Hash?this._renderList=e:t.Log.error(!0,t.Log.info.FUNC_MUST_BE("renderList","array or wdCb.Collection"))},enumerable:!0,configurable:!0}),n.prototype.init=function(){return e.prototype.init.call(this),this.width=this.size,this.height=this.size,t.Director.getInstance().scene.addRenderTargetRenderer(t.DynamicCubemapRenderTargetRenderer.create(this)),this},n.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_CUBE)},n}(t.CubemapRenderTargetTexture);t.DynamicCubemapTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.p_sourceRegionMethod=null,this.generateMipmaps=null,this.format=null,this.source=null,this.repeatRegion=null,this.sourceRegion=null,this.sourceRegionMapping=null,this.flipY=null,this.premultiplyAlpha=null,this.unpackAlignment=null,this.type=null,this.mipmaps=null,this.anisotropy=null,this.needUpdate=null}return __extends(n,e),Object.defineProperty(n.prototype,"sourceRegionMethod",{get:function(){return this.p_sourceRegionMethod},set:function(t){this.p_sourceRegionMethod=t},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=t.DeviceManager.getInstance().gl;this.glTexture=r.createTexture()},n.prototype.init=function(){},n.prototype.update=function(e){var n=t.DeviceManager.getInstance().gl,r=this.isSourcePowerOfTwo();return this.bindToUnit(e),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,this.flipY),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),n.pixelStorei(n.UNPACK_ALIGNMENT,this.unpackAlignment),this.needClampMaxSize()&&(this.clampToMaxSize(),r=this.isSourcePowerOfTwo(),r||t.Log.warn("texture size is not power of two after clampToMaxSize()")),this.setTextureParameters(n[this.target],r),this.allocateSourceToTexture(r),this.generateMipmaps&&r&&n.generateMipmap(n[this.target]),this.needUpdate=!1,this},n.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_2D)},n.prototype.sendOtherData=function(e,n){var r=null;return r=this.sourceRegion&&this.sourceRegionMethod===t.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL?this._convertSourceRegionToUV():t.RectRegion.create(0,0,1,1),e.sendUniformData("u_sourceRegion",t.EVariableType.FLOAT_4,r),e.sendUniformData("u_repeatRegion",t.EVariableType.FLOAT_4,this.repeatRegion),this},n.prototype.needClampMaxSize=function(){return this.source?t.BasicTextureUtils.needClampMaxSize(t.GPUDetector.getInstance().maxTextureSize,this.source.width,this.source.height):!1},n.prototype.clampToMaxSize=function(){this.source=t.BasicTextureUtils.clampToMaxSize(this.source,t.GPUDetector.getInstance().maxTextureSize)},n.prototype.setTextureParameters=function(t,n){e.prototype.setTextureParameters.call(this,t,n),this._setAnisotropy(t)},n.prototype.isSourcePowerOfTwo=function(){return t.BasicTextureUtils.isSourcePowerOfTwo(this.sourceRegion,this.sourceRegionMethod,this.width,this.height)},n.prototype._setAnisotropy=function(e){var n=t.GPUDetector.getInstance(),r=t.DeviceManager.getInstance().gl;n.extensionTextureFilterAnisotropic&&this.anisotropy>1&&r.texParameterf(e,n.extensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(this.anisotropy,n.maxAnisotropy))},n.prototype._convertSourceRegionCanvasMapToUV=function(e){var n=this.width,r=this.height,o=null;return o=t.RectRegion.create(e.x/n,e.y/r,e.width/n,e.height/r),o.y=1-o.y-o.height,o},n.prototype._convertSourceRegionToUV=function(){return this.sourceRegionMapping===t.ETextureSourceRegionMapping.CANVAS?this._convertSourceRegionCanvasMapToUV(this.sourceRegion):this.sourceRegionMapping===t.ETextureSourceRegionMapping.UV?this.sourceRegion:void 0},__decorate([t.virtual],n.prototype,"needClampMaxSize",null),n}(t.Texture);t.BasicTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.initWhenCreate=function(e){t.prototype.initWhenCreate.call(this),e.copyTo(this)},e}(t.BasicTexture);t.TwoDTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.allocateSourceToTexture=function(e){var n=null,r=null,o=t.DeviceManager.getInstance().gl;e&&this.mipmaps.getCount()>0?(n=t.DrawMipmapTwoDTextureCommand.create(),n.mipmaps=this.mipmaps,n.format=this.format,n.type=this.type,n.sourceRegion=this.sourceRegion,n.sourceRegionMethod=this.sourceRegionMethod,n.glTarget=o.TEXTURE_2D,n.execute(),this.generateMipmaps=!1):(r=t.DrawNoMipmapTwoDTextureCommand.create(),r.source=this.source,r.format=this.format,r.type=this.type,r.sourceRegion=this.sourceRegion,r.sourceRegionMethod=this.sourceRegionMethod,r.glTarget=o.TEXTURE_2D,r.execute())},n}(t.TwoDTexture);t.CommonTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this;return e.initWhenCreate(t),e},n.prototype.initWhenCreate=function(n){if(arguments[0]instanceof t.ImageTextureAsset){var r=arguments[0];e.prototype.initWhenCreate.call(this,r)}else{var o=arguments[0];e.prototype.initWhenCreate.call(this,t.ImageTextureAsset.create(o))}},n}(t.CommonTexture);t.ImageTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._video=null,this._startLoopSubscription=null}return __extends(n,e),n.create=function(t){var e=new this;return e.initWhenCreate(t),e},n.prototype.initWhenCreate=function(t){e.prototype.initWhenCreate.call(this,t),this._video=t.video},n.prototype.init=function(){var n=this;return e.prototype.init.call(this),this._startLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.STARTLOOP).subscribe(function(){n._video.isStop?n.needUpdate=!1:n.needUpdate=!0}),this},n.prototype.dispose=function(){this._startLoopSubscription&&this._startLoopSubscription.dispose()},n.prototype.needClampMaxSize=function(){return!1},n}(t.CommonTexture);t.VideoTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(n){e.call(this),this.assets=null,this.textures=wdCb.Collection.create(),this.mode=null,this.target=t.ETextureTarget.TEXTURE_CUBE_MAP,this._areAllCompressedAsset=!1,this.assets=n}return __extends(n,e),n.create=function(t){var e=new this(t);return e.initWhenCreate(t),e},n.prototype.initWhenCreate=function(t){e.prototype.initWhenCreate.call(this),this._areAssetsAllCompressedAsset(t)?this._areAllCompressedAsset=!0:this._areAllCompressedAsset=!1,this._createTextures(t),this._getRepresentAsset(t).copyToCubemapTexture(this),this._areAllCompressedAsset?(this.generateMipmaps=!1,this._hasNoMipmapCompressedAsset()&&(this.minFilter=this.filterFallback(this.minFilter))):this.generateMipmaps=!0,this.flipY=!1},n.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_CUBE)},n.prototype.sendOtherData=function(e,n){return e.sendUniformData("u_repeatRegion",t.EVariableType.FLOAT_4,this.repeatRegion),this},n.prototype.allocateSourceToTexture=function(t){this._areAllCompressedAsset?this.textures.forEach(function(t,e){t.draw(e)}):this.textures.forEach(function(t,e){t.draw(e)})},n.prototype.needClampMaxSize=function(){var t=!1;return this.textures.forEach(function(e){return e.needClampMaxSize()?(t=!0,wdCb.$BREAK):void 0}),t},n.prototype.isSourcePowerOfTwo=function(){var t=!0;return this.textures.forEach(function(e){return e.isSourcePowerOfTwo()?void 0:(t=!1,wdCb.$BREAK)}),t},n.prototype.clampToMaxSize=function(){this.textures.forEach(function(t){t.clampToMaxSize()})},n.prototype._hasNoMipmapCompressedAsset=function(){var t=this;return this._areAllCompressedAsset?this.textures.filter(function(e){return!t._isMipmapFilter(e.minFilter)}).getCount()>0:!1},n.prototype._isMipmapFilter=function(e){return e===t.ETextureFilterMode.LINEAR_MIPMAP_LINEAR||e===t.ETextureFilterMode.LINEAR_MIPMAP_NEAREST||e===t.ETextureFilterMode.NEAREST_MIPMAP_LINEAR||e===t.ETextureFilterMode.NEAREST_MIPMAP_MEAREST},n.prototype._getRepresentAsset=function(t){return t[0].asset},n.prototype._areAssetsAllImageAssets=function(e){for(var n=[],r=0,o=e;r<o.length;r++){var i=o[r];i.asset instanceof t.ImageTextureAsset&&n.push(i)}return 6===n.length},n.prototype._areAssetsAllCompressedAsset=function(e){for(var n=[],r=0,o=e;r<o.length;r++){var i=o[r];i.asset instanceof t.CompressedTextureAsset&&n.push(i)}return 6===n.length},n.prototype._createTextures=function(e){for(var n=this,r=0,o=e;r<o.length;r++){var i=o[r],a=i.asset.toCubemapFaceTexture();if(i.sourceRegion&&a instanceof t.CubemapFaceImageTexture){var s=a;s.sourceRegion=i.sourceRegion}i.type&&(a.type=i.type),n.textures.addChild(a)}},n.prototype._areTextureSizOfAllFaceseEqual=function(t){for(var e=[],n=[],r=0,o=t;r<o.length;r++){var i=o[r];i.sourceRegion?(e.push(i.sourceRegion.width),n.push(i.sourceRegion.height)):(e.push(i.asset.width),n.push(i.asset.height))}return this._areAllElementsEqual(e)&&this._areAllElementsEqual(n)},n.prototype._hasSourceRegion=function(t){for(var e=0,n=t;e<n.length;e++){var r=n[e];if(r.sourceRegion)return!0}return!1},n.prototype._areAllElementsEqual=function(t){for(var e=t[0],n=0,r=t;n<r.length;n++){var o=r[n];if(o!==e)return!1}return!0},__decorate([t.require(function(e){t.assert(6===e.length,t.Log.info.FUNC_MUST("cubemap","has 6 assets")),t.assert(this._areAssetsAllImageAssets(e)||this._areAssetsAllCompressedAsset(e),t.Log.info.FUNC_MUST_BE("cubemap six face's assets","all ImageTextureAsset or all CompressedTextureAsset")),this._areAssetsAllCompressedAsset(e)&&t.assert(!this._hasSourceRegion(e),t.Log.info.FUNC_SHOULD_NOT("compressed face","contain sourceRegion data")),t.assert(this._areTextureSizOfAllFaceseEqual(e),t.Log.info.FUNC_MUST_BE("all cubemap faces' texture size","equal"))})],n.prototype,"initWhenCreate",null),n}(t.BasicTexture);t.CubemapTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.type=t.ETextureType.UNSIGNED_BYTE,this.format=null,this.width=null,this.height=null}return e}();t.CubemapFaceTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},__decorate=this&&this.__decorate||function(t,e,n,r){var o,i=arguments.length,a=3>i?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,n,a):o(e,n))||a);return i>3&&a&&Object.defineProperty(e,n,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.sourceRegion=null,this.source=null}return __extends(n,e),n.create=function(t){var e=new this;return e.initWhenCreate(t),e},Object.defineProperty(n.prototype,"sourceRegionMethod",{get:function(){return t.ETextureSourceRegionMethod.DRAW_IN_CANVAS},set:function(t){},enumerable:!0,configurable:!0}),n.prototype.initWhenCreate=function(t){t.copyToCubemapFaceTexture(this)},n.prototype.isSourcePowerOfTwo=function(){return t.BasicTextureUtils.isSourcePowerOfTwo(this.sourceRegion,this.sourceRegionMethod,this.width,this.height)},n.prototype.needClampMaxSize=function(){return this.source?t.BasicTextureUtils.needClampMaxSize(t.GPUDetector.getInstance().maxCubemapTextureSize,this.source.width,this.source.height):!1},n.prototype.clampToMaxSize=function(){var e=t.GPUDetector.getInstance().maxCubemapTextureSize;this.source=t.BasicTextureUtils.clampToMaxSize(this.source,e)},n.prototype.draw=function(e){var n=t.DrawNoMipmapTwoDTextureCommand.create(),r=t.DeviceManager.getInstance().gl;n.source=this.source,n.sourceRegion=this.sourceRegion,n.sourceRegionMethod=this.sourceRegionMethod,n.glTarget=r.TEXTURE_CUBE_MAP_POSITIVE_X+e,n.format=this.format,n.type=this.type,n.execute()},__decorate([t.requireSetter(function(e){t.assert(e===t.ETextureSourceRegionMethod.DRAW_IN_CANVAS,t.Log.info.FUNC_SUPPORT("cubemap twoD face texture->sourceRegionMethod only","DRAW_IN_CANVAS"))})],n.prototype,"sourceRegionMethod",null),n}(t.CubemapFaceTexture);t.CubemapFaceImageTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.mipmaps=null,this.minFilter=null}return __extends(n,e),n.create=function(t){var e=new this;return e.initWhenCreate(t),e},n.prototype.initWhenCreate=function(t){t.copyToCubemapFaceTexture(this)},n.prototype.isSourcePowerOfTwo=function(){return t.BasicTextureUtils.isSourcePowerOfTwo(null,null,this.width,this.height)},n.prototype.needClampMaxSize=function(){return t.BasicTextureUtils.needClampMaxSize(t.GPUDetector.getInstance().maxCubemapTextureSize,this.width,this.height)},n.prototype.clampToMaxSize=function(){t.Log.warn("CubemapFaceCompressedTexture's texture size is over maxCubemapTextureSize")},n.prototype.draw=function(e){var n=t.DrawCompressedTextureCommand.create(),r=t.DeviceManager.getInstance().gl;n.glTarget=r.TEXTURE_CUBE_MAP_POSITIVE_X+e,n.type=this.type,n.format=this.format,n.mipmaps=this.mipmaps,n.execute()},n}(t.CubemapFaceTexture);t.CubemapFaceCompressedTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.create=function(t){var e=new this;return e.initWhenCreate(t),e},Object.defineProperty(n.prototype,"sourceRegionMethod",{get:function(){return t.Log.assert(this.p_sourceRegionMethod===t.ETextureSourceRegionMethod.DRAW_IN_CANVAS,"compressed texture not support ETextureSourceRegionMethod.DRAW_IN_CANVAS, will use ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL instead"),t.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL},enumerable:!0,configurable:!0}),n.prototype.allocateSourceToTexture=function(e){var n=t.DeviceManager.getInstance().gl,r=t.DrawCompressedTextureCommand.create();r.glTarget=n.TEXTURE_2D,r.type=this.type,r.format=this.format,r.mipmaps=this.mipmaps,r.sourceRegion=this.sourceRegion,r.sourceRegionMethod=this.sourceRegionMethod,r.execute(),this.mipmaps.getCount()>1&&(this.generateMipmaps=!1)},n.prototype.needClampMaxSize=function(){return!1},n}(t.TwoDTexture);t.CompressedTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.format=null,this.type=null,this.sourceRegion=null,this.sourceRegionMethod=t.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL,this.glTarget=null}return e.prototype.getDrawTarget=function(e,n){void 0===n&&(n=this.sourceRegion);var r=null;return r=t.BasicTextureUtils.isDrawPartOfTexture(n,this.sourceRegionMethod)?t.BasicTextureUtils.drawPartOfTextureByCanvas(e,n.width,n.height,n.x,n.y,n.width,n.height,0,0,n.width,n.height):e},e}();t.DrawTextureCommand=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.mipmaps=null}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.execute=function(){var e=t.DeviceManager.getInstance().gl,n=this;t.Log.error(null===this.format,t.Log.info.FUNC_NOT_SUPPORT(this.format)),this.format!==t.ETextureFormat.RGBA?this.mipmaps.forEach(function(t,r){e.compressedTexImage2D(n.glTarget,r,n.format,t.width,t.height,0,n.getDrawTarget(t.data))}):this.mipmaps.forEach(function(t,r){e.texImage2D(n.glTarget,r,e[n.format],t.width,t.height,0,e[n.format],e[n.type],n.getDrawTarget(t.data))})},n}(t.DrawTextureCommand);t.DrawCompressedTextureCommand=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.source=null}return __extends(n,e),n.prototype.drawTexture=function(e,n){var r=t.DeviceManager.getInstance().gl;r.texImage2D(this.glTarget,e,r[this.format],r[this.format],r[this.type],this.getDrawTarget(n))},n}(t.DrawTextureCommand);t.DrawTwoDTextureCommand=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.mipmaps=null}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.execute=function(){var t=this;this.mipmaps.forEach(function(e,n){t.drawTexture(n,e)})},e}(t.DrawTwoDTextureCommand);t.DrawMipmapTwoDTextureCommand=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.execute=function(){this.drawTexture(0,this.source)},e}(t.DrawTwoDTextureCommand);t.DrawNoMipmapTwoDTextureCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){var e=t.urlArr,n=t.onLoad,r=void 0===n?function(t){}:n,o=t.onError,i=void 0===o?function(t){}:o;this.url=null,this.source=null,this.isStop=!1,this._urlArr=null,this._onLoad=null,this._onError=null,this._urlArr=wdCb.Collection.create(e),this._onLoad=r,this._onError=i}return e.create=function(t){var e=new this(t);return e.initWhenCreate(),e},e.prototype.initWhenCreate=function(){this.url=this._getCanPlayUrl(),this.source=document.createElement("video"),this.source.src=this.url,this._bindEvent()},e.prototype.play=function(){this.isStop=!1,this.source.play()},e.prototype._getCanPlayUrl=function(){var e=this,n=null,r=[];return this._urlArr.forEach(function(t){var o=wdCb.PathUtils.extname(t);return r.push(o),e._canplay(o)?(n=t,wdCb.$BREAK):void 0}),t.Log.error(null===n,t.Log.info.FUNC_NOT_SUPPORT("browser",r.join(","))),n},e.prototype._canplay=function(e){var n=document.createElement("video"),r=null;switch(e){case".mp4":r='video/mp4; codecs="avc1.42e01e, mp4a.40.2"';break;case".ogv":r='video/ogg; codecs="theora, vorbis"';break;case".webm":r='video/webm; codecs="vp8, vorbis"';break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT(e))}return!!n.canPlayType&&""!==n.canPlayType(r)},e.prototype._bindEvent=function(){var t=this;this.source.addEventListener("canplaythrough",function(){t._onLoad(t)},!1),this.source.addEventListener("error",function(){t._onError("errorCode "+t.source.error.code)},!1),this.source.addEventListener("ended",function(){t.isStop=!0},!1)},e}();t.Video=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},e.prototype.play=function(e){var n=t.VideoLoader.getInstance().get(e),r=null;t.Log.error(!n,t.Log.info.FUNC_NOT_EXIST("video asset which id is "+e)),r=n.video,r.play()},e._instance=null,e}();t.VideoManager=e}(wd||(wd={}));var wd;!function(t){t.JudgeUtils.isNodeJs()?t.root=global:t.root=window}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.empty={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.NULL=-1,t.morphNormal_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 a_normal = a_currentFrameNormal + (a_nextFrameNormal - a_currentFrameNormal) * u_interpolation;\n"},t.morphVertice_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 a_position = a_currentFramePosition + (a_nextFramePosition - a_currentFramePosition) * u_interpolation;\n"},t.basicEnd_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragColor = vec4(totalColor.rgb, totalColor.a * u_opacity);\n"},t.basic_fragment={top:"",define:"",varDeclare:"varying vec3 v_color;\n",funcDeclare:"",funcDefine:"",body:"vec4 totalColor = vec4(v_color, 1.0);\n"},t.basic_vertex={top:"",define:"",varDeclare:"varying vec3 v_color;\n",funcDeclare:"",funcDefine:"",body:"v_color = a_color;\n"},t.common_define={top:"",define:"#define NULL -1.0\n",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.common_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.common_function={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"mat2 transpose(mat2 m) {\n  return mat2(  m[0][0], m[1][0],   // new col 0\n                m[0][1], m[1][1]    // new col 1\n             );\n  }\nmat3 transpose(mat3 m) {\n  return mat3(  m[0][0], m[1][0], m[2][0],  // new col 0\n                m[0][1], m[1][1], m[2][1],  // new col 1\n                m[0][2], m[1][2], m[2][2]   // new col 1\n             );\n  }\n",body:""},t.common_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.highp_fragment={top:"precision highp float;\nprecision highp int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.lowp_fragment={top:"precision lowp float;\nprecision lowp int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.mediump_fragment={top:"precision mediump float;\nprecision mediump int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.lightCommon_fragment={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n#if POINT_LIGHTS_COUNT > 0\nstruct PointLight {\n    vec3 position;\n    vec3 color;\n    float intensity;\n\n    float range;\n    float constant;\n    float linear;\n    float quadratic;\n};\nuniform PointLight u_pointLights[POINT_LIGHTS_COUNT];\n\n#endif\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\nstruct DirectionLight {\n    vec3 position;\n\n    float intensity;\n\n    vec3 color;\n};\nuniform DirectionLight u_directionLights[DIRECTION_LIGHTS_COUNT];\n#endif\n",
funcDeclare:"",funcDefine:"",body:""},t.lightCommon_vertex={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n#if POINT_LIGHTS_COUNT > 0\nstruct PointLight {\n    vec3 position;\n    vec3 color;\n    float intensity;\n\n    float range;\n    float constant;\n    float linear;\n    float quadratic;\n};\nuniform PointLight u_pointLights[POINT_LIGHTS_COUNT];\n\n#endif\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\nstruct DirectionLight {\n    vec3 position;\n\n    float intensity;\n\n    vec3 color;\n};\nuniform DirectionLight u_directionLights[DIRECTION_LIGHTS_COUNT];\n#endif\n",funcDeclare:"",funcDefine:"",body:"v_worldPosition = vec3(u_mMatrix * vec4(a_position, 1.0));\n"},t.lightEnd_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragColor = vec4(totalColor.rgb, totalColor.a * u_opacity);\n"},t.light_common={top:"",define:"",varDeclare:"",funcDeclare:"vec3 getDirectionLightDirByLightPos(vec3 lightPos);\nvec3 getPointLightDirByLightPos(vec3 lightPos);\nvec3 getPointLightDirByLightPos(vec3 lightPos, vec3 worldPosition);\n",funcDefine:"vec3 getDirectionLightDirByLightPos(vec3 lightPos){\n    return lightPos - vec3(0.0);\n    //return vec3(0.0) - lightPos;\n}\nvec3 getPointLightDirByLightPos(vec3 lightPos){\n    return lightPos - v_worldPosition;\n}\nvec3 getPointLightDirByLightPos(vec3 lightPos, vec3 worldPosition){\n    return lightPos - worldPosition;\n}\n",body:""},t.light_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float getBlinnShininess(float shininess, vec3 normal, vec3 lightDir, vec3 viewDir, float dotResultBetweenNormAndLight){\n        vec3 halfAngle = normalize(lightDir + viewDir);\n        float blinnTerm = dot(normal, halfAngle);\n\n        blinnTerm = clamp(blinnTerm, 0.0, 1.0);\n        blinnTerm = dotResultBetweenNormAndLight != 0.0 ? blinnTerm : 0.0;\n        blinnTerm = pow(blinnTerm, shininess);\n\n        return blinnTerm;\n}\n\nfloat getPhongShininess(float shininess, vec3 normal, vec3 lightDir, vec3 viewDir, float dotResultBetweenNormAndLight){\n        vec3 reflectDir = reflect(-lightDir, normal);\n        float phongTerm = dot(viewDir, reflectDir);\n\n        phongTerm = clamp(phongTerm, 0.0, 1.0);\n        phongTerm = dotResultBetweenNormAndLight != 0.0 ? phongTerm : 0.0;\n        phongTerm = pow(phongTerm, shininess);\n\n        return phongTerm;\n}\n\nvec3 calcLight(vec3 lightDir, vec3 color, float intensity, float attenuation, vec3 normal, vec3 viewDir)\n{\n        vec3 materialDiffuse = getMaterialDiffuse();\n        vec3 materialSpecular = getMaterialSpecular();\n        vec3 materialEmission = getMaterialEmission();\n\n        float dotResultBetweenNormAndLight = dot(normal, lightDir);\n        float diff = max(dotResultBetweenNormAndLight, 0.0);\n\n        vec3 emissionColor = u_emission * materialEmission;\n\n        vec3 ambientColor = u_ambient * materialDiffuse;\n\n\n        if(u_lightModel == 3){\n            return emissionColor + ambientColor;\n        }\n\n        vec3 diffuseColor = diff * color * materialDiffuse * intensity;\n\n\n        float spec = 0.0;\n\n        if(u_lightModel == 2){\n                spec = getPhongShininess(u_shininess, normal, lightDir, viewDir, diff);\n        }\n        else if(u_lightModel == 1){\n                spec = getBlinnShininess(u_shininess, normal, lightDir, viewDir, diff);\n        }\n\n        vec3 specularColor = spec * materialSpecular * intensity;\n\n        return emissionColor + ambientColor + attenuation * (diffuseColor + specularColor);\n}\n\n\n\n\n\n#if POINT_LIGHTS_COUNT > 0\n        vec3 calcPointLight(vec3 lightDir, PointLight light, vec3 normal, vec3 viewDir)\n{\n        //lightDir is not normalize computing distance\n        float distance = length(lightDir);\n\n        float attenuation = 0.0;\n\n        if(light.range == NULL || distance < light.range)\n        {\n                attenuation = 1.0 / (light.constant + light.linear * distance + light.quadratic * (distance * distance));\n        }\n\n        lightDir = normalize(lightDir);\n\n        return calcLight(lightDir, light.color, light.intensity, attenuation, normal, viewDir);\n}\n#endif\n\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\n        vec3 calcDirectionLight(vec3 lightDir, DirectionLight light, vec3 normal, vec3 viewDir)\n{\n        float attenuation = 1.0;\n\n        lightDir = normalize(lightDir);\n\n        return calcLight(lightDir, light.color, light.intensity, attenuation, normal, viewDir);\n}\n#endif\n\n\n\nvec3 calcTotalLight(vec3 norm, vec3 viewDir){\n        vec3 totalLight = vec3(0.0);\n\n    #if POINT_LIGHTS_COUNT > 0\n                for(int i = 0; i < POINT_LIGHTS_COUNT; i++){\n                totalLight += calcPointLight(getPointLightDir(i), u_pointLights[i], norm, viewDir);\n        }\n    #endif\n\n    #if DIRECTION_LIGHTS_COUNT > 0\n                for(int i = 0; i < DIRECTION_LIGHTS_COUNT; i++){\n                totalLight += calcDirectionLight(getDirectionLightDir(i), u_directionLights[i], norm, viewDir);\n        }\n    #endif\n\n        return totalLight;\n}\n",body:"vec3 normal = normalize(getNormal());\n\n#ifdef BOTH_SIDE\nnormal = normal * (-1.0 + 2.0 * float(gl_FrontFacing));\n#endif\n\nvec3 viewDir = normalize(getViewDir());\n\nvec4 totalColor = vec4(calcTotalLight(normal, viewDir), 1.0);\n\ntotalColor *= vec4(getShadowVisibility(), 1.0);\n"},t.light_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_Position = u_pMatrix * u_vMatrix * vec4(v_worldPosition, 1.0);\n"},t.map_forBasic_fragment={top:"",define:"",varDeclare:"varying vec2 v_mapCoord;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= texture2D(u_sampler2D0, v_mapCoord);\n"},t.map_forBasic_vertex={top:"",define:"",varDeclare:"varying vec2 v_mapCoord;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord = a_texCoord * u_sourceRegion.zw + u_sourceRegion.xy;\n    v_mapCoord = sourceTexCoord * u_repeatRegion.zw + u_repeatRegion.xy;\n"},t.multi_map_forBasic_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMapColor(){\n            vec4 color0 = texture2D(u_sampler2D0, v_mapCoord);\n            vec4 color1 = texture2D(u_sampler2D1, v_mapCoord);\n            if(u_combineMode == 0){\n                return mix(color0, color1, u_mixRatio);\n            }\n            else if(u_combineMode == 1){\n                return color0 * color1;\n            }\n            else if(u_combineMode == 2){\n                return color0 + color1;\n            }\n		}\n",body:"totalColor *= getMapColor();\n"},t.mirror_forBasic_fragment={top:"",define:"",varDeclare:"varying vec4 v_mirrorCoord;\n",funcDeclare:"",funcDefine:"//todo add more blend way to mix mirror color and textureColor\n		float blendOverlay(float base, float blend) {\n			return( base < 0.5 ? ( 2.0 * base * blend ) : (1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n		}\n		vec4 getMirrorColor(in vec4 materialColor){\n			vec4 color = texture2DProj(u_mirrorSampler, v_mirrorCoord);\n\n			color = vec4(blendOverlay(materialColor.r, color.r), blendOverlay(materialColor.g, color.g), blendOverlay(materialColor.b, color.b), 1.0);\n\n			return color;\n		}\n",body:"totalColor = getMirrorColor(totalColor);\n"},t.mirror_forBasic_vertex={top:"",define:"",varDeclare:"varying vec4 v_mirrorCoord;\n",funcDeclare:"",funcDefine:"",body:"mat4 textureMatrix = mat4(\n                        0.5, 0.0, 0.0, 0.0,\n                        0.0, 0.5, 0.0, 0.0,\n                        0.0, 0.0, 0.5, 0.0,\n                        0.5, 0.5, 0.5, 1.0\n);\n\nv_mirrorCoord = textureMatrix * gl_Position;\n"},t.skybox_fragment={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"gl_FragColor = textureCube(u_samplerCube0, v_dir);\n"},t.skybox_vertex={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"vec4 pos = u_pMatrix * mat4(mat3(u_vMatrix)) * u_mMatrix * vec4(a_position, 1.0);\n\n    gl_Position = pos.xyww;\n\n    v_dir = a_position;\n"},t.basic_envMap_forBasic_fragment={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, v_dir);\n"},t.basic_envMap_forBasic_vertex={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"v_dir = a_position;\n"},t.envMap_forBasic_fragment={top:"",define:"",varDeclare:"varying vec3 v_normal;\nvarying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"vec3 inDir = normalize(v_position - u_cameraPos);\n"},t.envMap_forBasic_vertex={top:"",define:"",varDeclare:"varying vec3 v_normal;\nvarying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"v_normal = normalize( u_normalMatrix * a_normal);\n    v_position = vec3(u_mMatrix * vec4(a_position, 1.0));\n"},t.fresnel_forBasic_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float computeFresnelRatio(vec3 inDir, vec3 normal, float refractionRatio){\n    float f = pow(1.0 - refractionRatio, 2.0) / pow(1.0 + refractionRatio, 2.0);\n    float fresnelPower = 5.0;\n    float ratio = f + (1.0 - f) * pow((1.0 - dot(inDir, normal)), fresnelPower);\n\n    return ratio / 100.0;\n}\nvec4 getEnvMapTotalColor(vec3 inDir, vec3 normal){\n    vec3 reflectDir = reflect(inDir, normal);\n    vec3 refractDir = refract(inDir, normal, u_refractionRatio);\n\n    vec4 reflectColor = textureCube(u_samplerCube0, reflectDir);\n    vec4 refractColor = textureCube(u_samplerCube0, refractDir);\n\n    vec4 totalColor = vec4(0.0);\n\n	if(u_reflectivity != NULL){\n        totalColor = mix(reflectColor, refractColor, u_reflectivity);\n	}\n	else{\n        totalColor = mix(reflectColor, refractColor, computeFresnelRatio(inDir, normal, u_refractionRatio));\n	}\n\n	return totalColor;\n}\n",body:"totalColor *= getEnvMapTotalColor(inDir, normalize(v_normal));\n"},t.reflection_forBasic_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, reflect(inDir, normalize(v_normal)));\n"},t.refraction_forBasic_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, refract(inDir, normalize(v_normal), u_refractionRatio));\n"},t.basic_envMap_forLight_fragment={top:"",define:"",varDeclare:"varying vec3 v_basicEnvMap_dir;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, v_basicEnvMap_dir);\n"},t.basic_envMap_forLight_vertex={top:"",define:"",varDeclare:"varying vec3 v_basicEnvMap_dir;\n",funcDeclare:"",funcDefine:"",body:"v_basicEnvMap_dir = a_position;\n"},t.envMap_forLight_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 inDir = normalize(v_worldPosition - u_cameraPos);\n"},t.envMap_forLight_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.fresnel_forLight_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float computeFresnelRatio(vec3 inDir, vec3 normal, float refractionRatio){\n    float f = pow(1.0 - refractionRatio, 2.0) / pow(1.0 + refractionRatio, 2.0);\n    float fresnelPower = 5.0;\n    float ratio = f + (1.0 - f) * pow((1.0 - dot(inDir, normal)), fresnelPower);\n\n    return ratio / 100.0;\n}\n\nvec4 getEnvMapTotalColor(vec3 inDir, vec3 normal){\n    vec3 reflectDir = reflect(inDir, normal);\n    vec3 refractDir = refract(inDir, normal, u_refractionRatio);\n\n    vec4 reflectColor = textureCube(u_samplerCube0, reflectDir);\n    vec4 refractColor = textureCube(u_samplerCube0, refractDir);\n\n    vec4 totalColor = vec4(0.0);\n\n	if(u_reflectivity != NULL){\n        totalColor = mix(reflectColor, refractColor, u_reflectivity);\n	}\n	else{\n        totalColor = mix(reflectColor, refractColor, computeFresnelRatio(inDir, normal, u_refractionRatio));\n	}\n\n	return totalColor;\n}\n",body:"totalColor *= getEnvMapTotalColor(inDir, normalize(getNormal()));\n"},t.reflection_forLight_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, reflect(inDir, normalize(getNormal())));\n"},t.refraction_forLight_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, refract(inDir, getNormal(), u_refractionRatio));\n"},t.diffuseMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_diffuseMapTexCoord;\n",funcDeclare:"",funcDefine:"vec3 getMaterialDiffuse() {\n        return vec3(texture2D(u_diffuseMapSampler, v_diffuseMapTexCoord));\n    }\n",body:""},t.diffuseMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_diffuseMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord = a_texCoord * u_sourceRegion.zw + u_sourceRegion.xy;\n    v_diffuseMapTexCoord = sourceTexCoord * u_repeatRegion.zw + u_repeatRegion.xy;\n    //v_diffuseMapTexCoord = a_texCoord;\n"},t.emissionMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_emissionMapTexCoord;\n",funcDeclare:"",funcDefine:"vec3 getMaterialEmission() {\n        return vec3(texture2D(u_emissionMapSampler, v_emissionMapTexCoord));\n    }\n",body:""},t.emissionMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_emissionMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_emissionMapTexCoord = a_texCoord;\n"},t.noDiffuseMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getMaterialDiffuse() {\n        return u_diffuse;\n    }\n",body:""},t.noEmissionMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getMaterialEmission() {\n        return u_emission;\n    }\n",body:""},t.noNormalMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_normal;\n",funcDeclare:"vec3 getNormal();\n\n",funcDefine:"#if POINT_LIGHTS_COUNT > 0\nvec3 getPointLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return getPointLightDirByLightPos(u_pointLights[x].position);\n        }\n    }\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvec3 getDirectionLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return getDirectionLightDirByLightPos(u_directionLights[x].position);\n        }\n    }\n\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n\nvec3 getViewDir(){\n    return normalize(u_cameraPos - v_worldPosition);\n}\nvec3 getNormal(){\n    return v_normal;\n}\n\n",body:""},t.noNormalMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_normal;\n",funcDeclare:"",funcDefine:"",body:"//v_normal = normalize( vec3(u_normalMatrix * vec4(a_normal, 1.0)));\n    v_normal = normalize( u_normalMatrix * a_normal);\n"},t.noSpecularMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getMaterialSpecular() {\n        return u_specular;\n    }\n",body:""},t.normalMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_normalMapTexCoord;\nvarying vec3 v_viewDir;\n#if POINT_LIGHTS_COUNT > 0\nvarying vec3 v_pointLightDir[POINT_LIGHTS_COUNT];\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvarying vec3 v_directionLightDir[DIRECTION_LIGHTS_COUNT];\n#endif\n\n",funcDeclare:"vec3 getNormal();\n\nvec3 getLightDir(vec3 lightPos);\n\n",funcDefine:"#if POINT_LIGHTS_COUNT > 0\nvec3 getPointLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return v_pointLightDir[x];\n        }\n    }\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\n\nvec3 getDirectionLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return v_directionLightDir[x];\n        }\n    }\n\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n\nvec3 getViewDir(){\n    return v_viewDir;\n}\nvec3 getNormal(){\n        // Obtain normal from normal map in range [0,1]\n        vec3 normal = texture2D(u_normalMapSampler, v_normalMapTexCoord).rgb;\n\n        // Transform normal vector to range [-1,1]\n        return normalize(normal * 2.0 - 1.0);  // this normal is in tangent space\n}\n",body:""},t.normalMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_normalMapTexCoord;\n	varying vec3 v_viewDir;\n\n\n#if POINT_LIGHTS_COUNT > 0\nvarying vec3 v_pointLightDir[POINT_LIGHTS_COUNT];\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvarying vec3 v_directionLightDir[DIRECTION_LIGHTS_COUNT];\n#endif\n\n",funcDeclare:"",funcDefine:"mat3 computeTBN(){\n            //vec3 T = normalize(normalMatrix * tangent);\n            //vec3 B = normalize(normalMatrix * bitangent);\n            //vec3 N = normalize(normalMatrix * normal);\n\n            vec3 T = normalize(u_normalMatrix * a_tangent);\n            vec3 N = normalize(u_normalMatrix * a_normal);\n            // re-orthogonalize T with respect to N\n            T = normalize(T - dot(T, N) * N);\n            // then retrieve perpendicular vector B with the cross product of T and N\n            vec3 B = cross(T, N);\n\n\n            return transpose(mat3(T, B, N));\n        }\n",body:"mat3 TBN = computeTBN();\n\n    //v_tangentLightPos = TBN * light.position;\n    //v_tangentCameraPos  = TBN * u_cameraPos;\n    //v_tangentPos  = TBN * v_position;\n\n\n    vec3 tangentPosition = TBN * vec3(u_mMatrix * vec4(a_position, 1.0));\n\n    v_normalMapTexCoord = a_texCoord;\n\n    v_viewDir = normalize(TBN * u_cameraPos - tangentPosition);\n\n\n#if POINT_LIGHTS_COUNT > 0\n       for(int i = 0; i < POINT_LIGHTS_COUNT; i++){\n            //not normalize for computing distance\n            v_pointLightDir[i] = TBN * getPointLightDirByLightPos(u_pointLights[i].position, tangentPosition);\n       }\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\n       for(int i = 0; i < DIRECTION_LIGHTS_COUNT; i++){\n            v_directionLightDir[i] = normalize(- TBN * getDirectionLightDirByLightPos(u_directionLights[i].position));\n       }\n#endif\n\n"},t.specularMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_specularMapTexCoord;\n",funcDeclare:"",funcDefine:"vec3 getMaterialSpecular() {\n        return vec3(texture2D(u_specularMapSampler, v_specularMapTexCoord));\n    }\n",body:""},t.specularMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_specularMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_specularMapTexCoord = a_texCoord;\n"},t.buildCubemapShadowMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n",funcDeclare:"",funcDefine:"",body:"\n// get distance between fragment and light source\n    float lightDistance = length(v_worldPosition - u_lightPos);\n\n    // map to [0,1] range by dividing by farPlane\n    lightDistance = lightDistance / u_farPlane;\n\n\ngl_FragData[0] = packDepth(lightDistance);\n\n\n//gl_FragColor = vec4(0.5, 0.0, 1.0, 1.0);\n//gl_FragData[0] = vec4(lightDistance, 1.0, 1.0, 1.0);\n"},t.buildCubemapShadowMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n",funcDeclare:"",funcDefine:"",body:"v_worldPosition = vec3(u_mMatrix * vec4(a_position, 1.0));\n    gl_Position = u_pMatrix * u_vMatrix * vec4(v_worldPosition, 1.0);\n"},t.buildTwoDShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragData[0] = packDepth(gl_FragCoord.z);\n"},t.buildTwoDShadowMap_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_Position = u_vpMatrixFromLight * u_mMatrix * vec4(a_position, 1.0);\n//gl_Position = u_pMatrix* u_vMatrix * u_mMatrix * vec4(a_position, 1.0);\n"},t.commonBuildShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"// Packing a float in GLSL with multiplication and mod\nvec4 packDepth(in float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n\n    return res;\n}\n",body:""},t.cubemapShadowMap_fragment={top:"",define:"",varDeclare:"uniform samplerCube u_cubemapShadowMapSampler[ CUBEMAP_SHADOWMAP_COUNT ];\n	uniform float u_cubemapShadowDarkness[ CUBEMAP_SHADOWMAP_COUNT ];\n	uniform float u_cubemapShadowBias[ CUBEMAP_SHADOWMAP_COUNT ];\n	uniform float u_farPlane[ CUBEMAP_SHADOWMAP_COUNT ];\n	uniform vec3 u_cubemapLightPos[ CUBEMAP_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"// PCF\nfloat getCubemapShadowVisibilityByPCF(float currentDepth, vec3 fragToLight, samplerCube cubemapShadowMapSampler, float shadowBias, float farPlane, float shadowDarkness){\n    //only support in opengl es 3.0+\n    //vec3 sampleOffsetDirections[20] = vec3[]\n    //(\n       //vec3( 1,  1,  1), vec3( 1, -1,  1), vec3(-1, -1,  1), vec3(-1,  1,  1),\n       //vec3( 1,  1, -1), vec3( 1, -1, -1), vec3(-1, -1, -1), vec3(-1,  1, -1),\n       //vec3( 1,  1,  0), vec3( 1, -1,  0), vec3(-1, -1,  0), vec3(-1,  1,  0),\n       //vec3( 1,  0,  1), vec3(-1,  0,  1), vec3( 1,  0, -1), vec3(-1,  0, -1),\n       //vec3( 0,  1,  1), vec3( 0, -1,  1), vec3( 0, -1, -1), vec3( 0,  1, -1)\n    //);\n\n    vec3 sampleOffsetDirections[20];\n\n    sampleOffsetDirections[0] = vec3( 1,  1,  1);\n    sampleOffsetDirections[1] = vec3( 1,  -1,  1);\n    sampleOffsetDirections[2] = vec3( -1,  -1,  1);\n    sampleOffsetDirections[3] = vec3( -1,  1,  1);\n\n    sampleOffsetDirections[4] = vec3( 1,  1,  -1);\n    sampleOffsetDirections[5] = vec3( 1,  -1,  -1);\n    sampleOffsetDirections[6] = vec3( -1,  -1,  -1);\n    sampleOffsetDirections[7] = vec3( -1,  1,  -1);\n\n    sampleOffsetDirections[8] = vec3( 1,  1,  0);\n    sampleOffsetDirections[9] = vec3( 1,  -1,  0);\n    sampleOffsetDirections[10] = vec3( -1,  -1,  0);\n    sampleOffsetDirections[11] = vec3( -1,  1,  0);\n\n    sampleOffsetDirections[12] = vec3( 1,  0,  1);\n    sampleOffsetDirections[13] = vec3( -1,  0,  1);\n    sampleOffsetDirections[14] = vec3( 1,  0,  -1);\n    sampleOffsetDirections[15] = vec3( -1,  0,  -1);\n\n    sampleOffsetDirections[16] = vec3( 0,  1,  1);\n    sampleOffsetDirections[17] = vec3( 0,  -1,  1);\n    sampleOffsetDirections[18] = vec3( 0,  -1,  -1);\n    sampleOffsetDirections[19] = vec3( 0,  1,  -1);\n\n    float shadow = 0.0;\n    int samples = 20;\n\n    //float diskRadius = 0.00000;\n    //Another interesting trick we can apply here is that we can change the diskRadius based on how far the viewer is away from a fragment; this way we can increase the offset radius by the distance to the viewer, making the shadows softer when far away and sharper when close by.\n    float viewDistance = length(u_cameraPos - v_worldPosition);\n    float diskRadius = (1.0 + (viewDistance / farPlane)) / 25.0;\n\n    //for(int i = 0; i < samples; ++i)\n    for(int i = 0; i < 20; ++i)\n    {\n        float pcfDepth = unpackDepth(textureCube(cubemapShadowMapSampler, fragToLight + sampleOffsetDirections[i] * diskRadius));\n        pcfDepth *= farPlane;   // Undo mapping [0;1]\n        shadow += currentDepth - shadowBias > pcfDepth  ? shadowDarkness : 1.0;\n    }\n    shadow /= float(samples);\n\n    return shadow;\n}\n\n\nfloat getCubemapShadowVisibility(vec3 lightDir, samplerCube cubemapShadowMapSampler, vec3 lightPos, float farPlane, float shadowBias, float  shadowDarkness) {\n// Get vector between fragment position and light position\n    vec3 fragToLight= v_worldPosition - lightPos;\n    // Use the light to fragment vector to sample from the depth map\n    // Now get current linear depth as the length between the fragment and light position\n    float currentDepth = length(fragToLight);\n\n    #if defined(SHADOWMAP_TYPE_PCF)\n    return getCubemapShadowVisibilityByPCF(currentDepth, fragToLight, cubemapShadowMapSampler, getShadowBias(lightDir, shadowBias), farPlane, shadowDarkness);\n    #endif\n\n    float closestDepth = unpackDepth(textureCube(cubemapShadowMapSampler, fragToLight));\n\n    // It is currently in linear range between [0,1]. Re-transform back to original value\n    closestDepth *= farPlane;\n\n\n    return float(currentDepth > closestDepth + getShadowBias(lightDir, shadowBias) ? shadowDarkness : 1.0);\n}\n",body:""},t.noShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getShadowVisibility() {\n        return vec3(1.0);\n    }\n",body:""},t.totalShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"float getShadowBias(vec3 lightDir, float shadowBias);\nfloat unpackDepth(vec4 rgbaDepth);\n",funcDefine:"float getShadowBias(vec3 lightDir, float shadowBias){\n    float bias = shadowBias;\n\n    if(shadowBias == NULL){\n        bias = 0.005;\n    }\n\n\n     /*!\n     A shadow bias of 0.005 solves the issues of our scene by a large extent, but some surfaces that have a steep angle to the light source might still produce shadow acne. A more solid approach would be to change the amount of bias based on the surface angle towards the light: something we can solve with the dot product:\n     */\n\n     return max(bias * (1.0 - dot(normalize(getNormal()), lightDir)), bias);\n\n    //return bias;\n}\n\nfloat unpackDepth(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n\nvec3 getShadowVisibility() {\n    vec3 shadowColor = vec3(1.0);\n    vec3 twoDLightDir = vec3(0.0);\n    vec3 cubemapLightDir = vec3(0.0);\n\n\n    //to normalMap, the lightDir use the origin one instead of normalMap's lightDir here(the lightDir is used for computing shadowBias, the origin one is enough for it)\n\n    #if TWOD_SHADOWMAP_COUNT > 0\n	for( int i = 0; i < TWOD_SHADOWMAP_COUNT; i ++ ) {\n        twoDLightDir = getDirectionLightDirByLightPos(u_twoDLightPos[i]);\n\n	////if is opposite to direction of light rays, no shadow\n\n        shadowColor *= getTwoDShadowVisibility(twoDLightDir, u_twoDShadowMapSampler[i], v_positionFromLight[i], u_twoDShadowBias[i], u_twoDShadowDarkness[i], u_twoDShadowSize[i]);\n	}\n	#endif\n\n\n	#if CUBEMAP_SHADOWMAP_COUNT > 0\n	for( int i = 0; i < CUBEMAP_SHADOWMAP_COUNT; i ++ ) {\n        cubemapLightDir = getPointLightDirByLightPos(u_cubemapLightPos[i]);\n\n	////if is opposite to direction of light rays, no shadow\n\n        shadowColor *= getCubemapShadowVisibility(cubemapLightDir, u_cubemapShadowMapSampler[i], u_cubemapLightPos[i], u_farPlane[i], u_cubemapShadowBias[i], u_cubemapShadowDarkness[i]);\n	}\n	#endif\n\n	return shadowColor;\n}\n\n",body:""},t.twoDShadowMap_fragment={top:"",define:"",varDeclare:"varying vec4 v_positionFromLight[ TWOD_SHADOWMAP_COUNT ];\n	uniform sampler2D u_twoDShadowMapSampler[ TWOD_SHADOWMAP_COUNT ];\n	uniform float u_twoDShadowDarkness[ TWOD_SHADOWMAP_COUNT ];\n	uniform float u_twoDShadowBias[ TWOD_SHADOWMAP_COUNT ];\n	uniform vec2 u_twoDShadowSize[ TWOD_SHADOWMAP_COUNT ];\n	uniform vec3 u_twoDLightPos[ TWOD_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"// PCF\nfloat getTwoDShadowVisibilityByPCF(float currentDepth, vec2 shadowCoord, sampler2D twoDShadowMapSampler, float shadowBias, float shadowDarkness, vec2 shadowMapSize){\n\n    float shadow = 0.0;\n    vec2 texelSize = vec2(1.0 / shadowMapSize[0], 1.0 / shadowMapSize[1]);\n\n    for(int x = -1; x <= 1; ++x)\n    {\n        for(int y = -1; y <= 1; ++y)\n        {\n            float pcfDepth = unpackDepth(texture2D(twoDShadowMapSampler, shadowCoord + vec2(x, y) * texelSize));\n            shadow += currentDepth - shadowBias > pcfDepth  ? shadowDarkness : 1.0;\n        }\n    }\n    shadow /= 9.0;\n\n    return shadow;\n}\n\n\n\nfloat getTwoDShadowVisibility(vec3 lightDir, sampler2D twoDShadowMapSampler, vec4 v_positionFromLight, float shadowBias, float shadowDarkness, vec2 shadowSize) {\n    //project texture\n    vec3 shadowCoord = (v_positionFromLight.xyz / v_positionFromLight.w) / 2.0 + 0.5;\n    //vec3 shadowCoord = vec3(0.5, 0.5, 0.5);\n\n    #ifdef SHADOWMAP_TYPE_PCF\n    // Percentage-close filtering\n    // (9 pixel kernel)\n    return getTwoDShadowVisibilityByPCF(shadowCoord.z, shadowCoord.xy, twoDShadowMapSampler, getShadowBias(lightDir, shadowBias), shadowDarkness, shadowSize);\n\n    #else\n    return shadowCoord.z > unpackDepth(texture2D(twoDShadowMapSampler, shadowCoord.xy)) + getShadowBias(lightDir, shadowBias) ? shadowDarkness : 1.0;\n    #endif\n}\n",body:""},t.twoDShadowMap_vertex={top:"",define:"",varDeclare:"varying vec4 v_positionFromLight[ TWOD_SHADOWMAP_COUNT ];\nuniform mat4 u_vpMatrixFromLight[ TWOD_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"",body:"for( int i = 0; i < TWOD_SHADOWMAP_COUNT; i ++ ) {\n    v_positionFromLight[i] = u_vpMatrixFromLight[i] * vec4(v_worldPosition, 1.0);\n	}\n"},t}();t.ShaderChunk=e}(wd||(wd={}));