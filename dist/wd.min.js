!function(e,t){"undefined"!=typeof module&&module.exports?module.exports.browser=t():"function"==typeof define&&define.amd?define(t):this[e]=t()}("bowser",function(){function detect(t){function getFirstMatch(e){var r=t.match(e);return r&&r.length>1&&r[1]||""}var r,n=getFirstMatch(/(ipod|iphone|ipad)/i).toLowerCase(),i=/like android/i.test(t),a=!i&&/android/i.test(t),o=getFirstMatch(/version\/(\d+(\.\d+)?)/i),s=/tablet/i.test(t),c=!s&&/[^-]mobi/i.test(t);/opera|opr/i.test(t)?r={name:"Opera",opera:e,version:o||getFirstMatch(/(?:opera|opr)[\s\/](\d+(\.\d+)?)/i)}:/windows phone/i.test(t)?r={name:"Windows Phone",windowsphone:e,msie:e,version:getFirstMatch(/iemobile\/(\d+(\.\d+)?)/i)}:/msie|trident/i.test(t)?r={name:"Internet Explorer",msie:e,version:getFirstMatch(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:/chrome|crios|crmo/i.test(t)?r={name:"Chrome",chrome:e,version:getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:n?(r={name:"iphone"==n?"iPhone":"ipad"==n?"iPad":"iPod"},o&&(r.version=o)):/sailfish/i.test(t)?r={name:"Sailfish",sailfish:e,version:getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(t)?r={name:"SeaMonkey",seamonkey:e,version:getFirstMatch(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel/i.test(t)?(r={name:"Firefox",firefox:e,version:getFirstMatch(/(?:firefox|iceweasel)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(t)&&(r.firefoxos=e)):/silk/i.test(t)?r={name:"Amazon Silk",silk:e,version:getFirstMatch(/silk\/(\d+(\.\d+)?)/i)}:a?r={name:"Android",version:o}:/phantom/i.test(t)?r={name:"PhantomJS",phantom:e,version:getFirstMatch(/phantomjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(t)||/rim\stablet/i.test(t)?r={name:"BlackBerry",blackberry:e,version:o||getFirstMatch(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:/(web|hpw)os/i.test(t)?(r={name:"WebOS",webos:e,version:o||getFirstMatch(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(t)&&(r.touchpad=e)):r=/bada/i.test(t)?{name:"Bada",bada:e,version:getFirstMatch(/dolfin\/(\d+(\.\d+)?)/i)}:/tizen/i.test(t)?{name:"Tizen",tizen:e,version:getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||o}:/safari/i.test(t)?{name:"Safari",safari:e,version:o}:{},/(apple)?webkit/i.test(t)?(r.name=r.name||"Webkit",r.webkit=e,!r.version&&o&&(r.version=o)):!r.opera&&/gecko\//i.test(t)&&(r.name=r.name||"Gecko",r.gecko=e,r.version=r.version||getFirstMatch(/gecko\/(\d+(\.\d+)?)/i)),a||r.silk?r.android=e:n&&(r[n]=e,r.ios=e);var u="";n?(u=getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i),u=u.replace(/[_\s]/g,".")):a?u=getFirstMatch(/android[ \/-](\d+(\.\d+)*)/i):r.windowsphone?u=getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):r.webos?u=getFirstMatch(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):r.blackberry?u=getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i):r.bada?u=getFirstMatch(/bada\/(\d+(\.\d+)*)/i):r.tizen&&(u=getFirstMatch(/tizen[\/\s](\d+(\.\d+)*)/i)),u&&(r.osversion=u);var l=u.split(".")[0];return s||"ipad"==n||a&&(3==l||4==l&&!c)||r.silk?r.tablet=e:(c||"iphone"==n||"ipod"==n||a||r.blackberry||r.webos||r.bada)&&(r.mobile=e),r.msie&&r.version>=10||r.chrome&&r.version>=20||r.firefox&&r.version>=20||r.safari&&r.version>=6||r.opera&&r.version>=10||r.ios&&r.osversion&&r.osversion.split(".")[0]>=6||r.blackberry&&r.version>=10.1?r.a=e:r.msie&&r.version<10||r.chrome&&r.version<20||r.firefox&&r.version<20||r.safari&&r.version<6||r.opera&&r.version<10||r.ios&&r.osversion&&r.osversion.split(".")[0]<6?r.c=e:r.x=e,r}var e=!0,t=detect("undefined"!=typeof navigator?navigator.userAgent:"");return t._detect=detect,t}),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.chai=e()}}(function(){return function e(t,r,n){function s(a,o){if(!r[a]){if(!t[a]){var c="function"==typeof require&&require;if(!o&&c)return c(a,!0);if(i)return i(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var l=r[a]={exports:{}};t[a][0].call(l.exports,function(e){var r=t[a][1][e];return s(r?r:e)},l,l.exports,e,t,r,n)}return r[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)s(n[a]);return s}({1:[function(e,t,r){t.exports=e("./lib/chai")},{"./lib/chai":2}],2:[function(e,t,r){var n=[],r=t.exports={};r.version="3.5.0",r.AssertionError=e("assertion-error");var i=e("./chai/utils");r.use=function(e){return~n.indexOf(e)||(e(this,i),n.push(e)),this},r.util=i;var a=e("./chai/config");r.config=a;var o=e("./chai/assertion");r.use(o);var s=e("./chai/core/assertions");r.use(s);var c=e("./chai/interface/expect");r.use(c);var u=e("./chai/interface/should");r.use(u);var l=e("./chai/interface/assert");r.use(l)},{"./chai/assertion":3,"./chai/config":4,"./chai/core/assertions":5,"./chai/interface/assert":6,"./chai/interface/expect":7,"./chai/interface/should":8,"./chai/utils":22,"assertion-error":30}],3:[function(e,t,r){var n=e("./config");t.exports=function(e,t){function Assertion(e,t,r){i(this,"ssfi",r||arguments.callee),i(this,"object",e),i(this,"message",t)}var r=e.AssertionError,i=t.flag;e.Assertion=Assertion,Object.defineProperty(Assertion,"includeStack",{get:function(){return console.warn("Assertion.includeStack is deprecated, use chai.config.includeStack instead."),n.includeStack},set:function(e){console.warn("Assertion.includeStack is deprecated, use chai.config.includeStack instead."),n.includeStack=e}}),Object.defineProperty(Assertion,"showDiff",{get:function(){return console.warn("Assertion.showDiff is deprecated, use chai.config.showDiff instead."),n.showDiff},set:function(e){console.warn("Assertion.showDiff is deprecated, use chai.config.showDiff instead."),n.showDiff=e}}),Assertion.addProperty=function(e,r){t.addProperty(this.prototype,e,r)},Assertion.addMethod=function(e,r){t.addMethod(this.prototype,e,r)},Assertion.addChainableMethod=function(e,r,n){t.addChainableMethod(this.prototype,e,r,n)},Assertion.overwriteProperty=function(e,r){t.overwriteProperty(this.prototype,e,r)},Assertion.overwriteMethod=function(e,r){t.overwriteMethod(this.prototype,e,r)},Assertion.overwriteChainableMethod=function(e,r,n){t.overwriteChainableMethod(this.prototype,e,r,n)},Assertion.prototype.assert=function(e,a,o,s,c,u){var l=t.test(this,arguments);if(!0!==u&&(u=!1),!0!==n.showDiff&&(u=!1),!l){var a=t.getMessage(this,arguments),d=t.getActual(this,arguments);throw new r(a,{actual:d,expected:s,showDiff:u},n.includeStack?this.assert:i(this,"ssfi"))}},Object.defineProperty(Assertion.prototype,"_obj",{get:function(){return i(this,"object")},set:function(e){i(this,"object",e)}})}},{"./config":4}],4:[function(e,t,r){t.exports={includeStack:!1,showDiff:!0,truncateThreshold:40}},{}],5:[function(e,t,r){t.exports=function(e,t){function an(e,r){r&&n(this,"message",r),e=e.toLowerCase();var i=n(this,"object"),a=~["a","e","i","o","u"].indexOf(e.charAt(0))?"an ":"a ";this.assert(e===t.type(i),"expected #{this} to be "+a+e,"expected #{this} not to be "+a+e)}function includeChainingBehavior(){n(this,"contains",!0)}function include(e,i){t.expectTypes(this,["array","object","string"]),i&&n(this,"message",i);var a=n(this,"object"),o=!1;if("array"===t.type(a)&&"object"===t.type(e)){for(var s in a)if(t.eql(a[s],e)){o=!0;break}}else if("object"===t.type(e)){if(!n(this,"negate")){for(var c in e)new r(a).property(c,e[c]);return}var u={};for(var c in e)u[c]=a[c];o=t.eql(u,e)}else o=void 0!=a&&~a.indexOf(e);this.assert(o,"expected #{this} to include "+t.inspect(e),"expected #{this} to not include "+t.inspect(e))}function checkArguments(){var e=n(this,"object"),t=Object.prototype.toString.call(e);this.assert("[object Arguments]"===t,"expected #{this} to be arguments but got "+t,"expected #{this} to not be arguments")}function assertEqual(e,t){t&&n(this,"message",t);var r=n(this,"object");return n(this,"deep")?this.eql(e):void this.assert(e===r,"expected #{this} to equal #{exp}","expected #{this} to not equal #{exp}",e,this._obj,!0)}function assertEql(e,r){r&&n(this,"message",r),this.assert(t.eql(e,n(this,"object")),"expected #{this} to deeply equal #{exp}","expected #{this} to not deeply equal #{exp}",e,this._obj,!0)}function assertAbove(e,t){t&&n(this,"message",t);var i=n(this,"object");if(n(this,"doLength")){new r(i,t).to.have.property("length");var a=i.length;this.assert(a>e,"expected #{this} to have a length above #{exp} but got #{act}","expected #{this} to not have a length above #{exp}",e,a)}else this.assert(i>e,"expected #{this} to be above "+e,"expected #{this} to be at most "+e)}function assertLeast(e,t){t&&n(this,"message",t);var i=n(this,"object");if(n(this,"doLength")){new r(i,t).to.have.property("length");var a=i.length;this.assert(a>=e,"expected #{this} to have a length at least #{exp} but got #{act}","expected #{this} to have a length below #{exp}",e,a)}else this.assert(i>=e,"expected #{this} to be at least "+e,"expected #{this} to be below "+e)}function assertBelow(e,t){t&&n(this,"message",t);var i=n(this,"object");if(n(this,"doLength")){new r(i,t).to.have.property("length");var a=i.length;this.assert(a<e,"expected #{this} to have a length below #{exp} but got #{act}","expected #{this} to not have a length below #{exp}",e,a)}else this.assert(i<e,"expected #{this} to be below "+e,"expected #{this} to be at least "+e)}function assertMost(e,t){t&&n(this,"message",t);var i=n(this,"object");if(n(this,"doLength")){new r(i,t).to.have.property("length");var a=i.length;this.assert(a<=e,"expected #{this} to have a length at most #{exp} but got #{act}","expected #{this} to have a length above #{exp}",e,a)}else this.assert(i<=e,"expected #{this} to be at most "+e,"expected #{this} to be above "+e)}function assertInstanceOf(e,r){r&&n(this,"message",r);var i=t.getName(e);this.assert(n(this,"object")instanceof e,"expected #{this} to be an instance of "+i,"expected #{this} to not be an instance of "+i)}function assertOwnProperty(e,r){r&&n(this,"message",r);var i=n(this,"object");this.assert(i.hasOwnProperty(e),"expected #{this} to have own property "+t.inspect(e),"expected #{this} to not have own property "+t.inspect(e))}function assertOwnPropertyDescriptor(e,r,i){"string"==typeof r&&(i=r,r=null),i&&n(this,"message",i);var a=n(this,"object"),o=Object.getOwnPropertyDescriptor(Object(a),e);o&&r?this.assert(t.eql(r,o),"expected the own property descriptor for "+t.inspect(e)+" on #{this} to match "+t.inspect(r)+", got "+t.inspect(o),"expected the own property descriptor for "+t.inspect(e)+" on #{this} to not match "+t.inspect(r),r,o,!0):this.assert(o,"expected #{this} to have an own property descriptor for "+t.inspect(e),"expected #{this} to not have an own property descriptor for "+t.inspect(e)),n(this,"object",o)}function assertLengthChain(){n(this,"doLength",!0)}function assertLength(e,t){t&&n(this,"message",t);var i=n(this,"object");new r(i,t).to.have.property("length");var a=i.length;this.assert(a==e,"expected #{this} to have a length of #{exp} but got #{act}","expected #{this} to not have a length of #{act}",e,a)}function assertMatch(e,t){t&&n(this,"message",t);var r=n(this,"object");this.assert(e.exec(r),"expected #{this} to match "+e,"expected #{this} not to match "+e)}function assertKeys(e){var r,i=n(this,"object"),a=!0,o="keys must be given single argument of Array|Object|String, or multiple String arguments";switch(t.type(e)){case"array":if(arguments.length>1)throw new Error(o);break;case"object":if(arguments.length>1)throw new Error(o);e=Object.keys(e);break;default:e=Array.prototype.slice.call(arguments)}if(!e.length)throw new Error("keys required");var s=Object.keys(i),c=e,u=e.length,l=n(this,"any"),d=n(this,"all");if(l||d||(d=!0),l){var h=c.filter(function(e){return~s.indexOf(e)});a=h.length>0}if(d&&(a=e.every(function(e){return~s.indexOf(e)}),n(this,"negate")||n(this,"contains")||(a=a&&e.length==s.length)),u>1){e=e.map(function(e){return t.inspect(e)});var p=e.pop();d&&(r=e.join(", ")+", and "+p),l&&(r=e.join(", ")+", or "+p)}else r=t.inspect(e[0]);r=(u>1?"keys ":"key ")+r,r=(n(this,"contains")?"contain ":"have ")+r,this.assert(a,"expected #{this} to "+r,"expected #{this} to not "+r,c.slice(0).sort(),s.sort(),!0)}function assertThrows(e,i,a){a&&n(this,"message",a);var o=n(this,"object");new r(o,a).is.a("function");var s=!1,c=null,u=null,l=null;0===arguments.length?(i=null,e=null):e&&(e instanceof RegExp||"string"==typeof e)?(i=e,e=null):e&&e instanceof Error?(c=e,e=null,i=null):"function"==typeof e?(u=e.prototype.name,(!u||"Error"===u&&e!==Error)&&(u=e.name||(new e).name)):e=null;try{o()}catch(r){if(c)return this.assert(r===c,"expected #{this} to throw #{exp} but #{act} was thrown","expected #{this} to not throw #{exp}",c instanceof Error?c.toString():c,r instanceof Error?r.toString():r),n(this,"object",r),this;if(e&&(this.assert(r instanceof e,"expected #{this} to throw #{exp} but #{act} was thrown","expected #{this} to not throw #{exp} but #{act} was thrown",u,r instanceof Error?r.toString():r),!i))return n(this,"object",r),this;var d="error"===t.type(r)&&"message"in r?r.message:""+r;if(null!=d&&i&&i instanceof RegExp)return this.assert(i.exec(d),"expected #{this} to throw error matching #{exp} but got #{act}","expected #{this} to throw error not matching #{exp}",i,d),n(this,"object",r),this;if(null!=d&&i&&"string"==typeof i)return this.assert(~d.indexOf(i),"expected #{this} to throw error including #{exp} but got #{act}","expected #{this} to throw error not including #{act}",i,d),n(this,"object",r),this;s=!0,l=r}var h="",p=null!==u?u:c?"#{exp}":"an error";s&&(h=" but #{act} was thrown"),this.assert(s===!0,"expected #{this} to throw "+p+h,"expected #{this} to not throw "+p+h,c instanceof Error?c.toString():c,l instanceof Error?l.toString():l),n(this,"object",l)}function respondTo(e,r){r&&n(this,"message",r);var i=n(this,"object"),a=n(this,"itself"),o="function"!==t.type(i)||a?i[e]:i.prototype[e];this.assert("function"==typeof o,"expected #{this} to respond to "+t.inspect(e),"expected #{this} to not respond to "+t.inspect(e))}function satisfy(e,r){r&&n(this,"message",r);var i=n(this,"object"),a=e(i);this.assert(a,"expected #{this} to satisfy "+t.objDisplay(e),"expected #{this} to not satisfy"+t.objDisplay(e),!this.negate,a)}function closeTo(e,i,a){a&&n(this,"message",a);var o=n(this,"object");if(new r(o,a).is.a("number"),"number"!==t.type(e)||"number"!==t.type(i))throw new Error("the arguments to closeTo or approximately must be numbers");this.assert(Math.abs(o-e)<=i,"expected #{this} to be close to "+e+" +/- "+i,"expected #{this} not to be close to "+e+" +/- "+i)}function isSubsetOf(e,t,r){return e.every(function(e){return r?t.some(function(t){return r(e,t)}):t.indexOf(e)!==-1})}function oneOf(e,t){t&&n(this,"message",t);var i=n(this,"object");new r(e).to.be.an("array"),this.assert(e.indexOf(i)>-1,"expected #{this} to be one of #{exp}","expected #{this} to not be one of #{exp}",e,i)}function assertChanges(e,t,i){i&&n(this,"message",i);var a=n(this,"object");new r(e,i).to.have.property(t),new r(a).is.a("function");var o=e[t];a(),this.assert(o!==e[t],"expected ."+t+" to change","expected ."+t+" to not change")}function assertIncreases(e,t,i){i&&n(this,"message",i);var a=n(this,"object");new r(e,i).to.have.property(t),new r(a).is.a("function");var o=e[t];a(),this.assert(e[t]-o>0,"expected ."+t+" to increase","expected ."+t+" to not increase")}function assertDecreases(e,t,i){i&&n(this,"message",i);var a=n(this,"object");new r(e,i).to.have.property(t),new r(a).is.a("function");var o=e[t];a(),this.assert(e[t]-o<0,"expected ."+t+" to decrease","expected ."+t+" to not decrease")}var r=e.Assertion,n=(Object.prototype.toString,t.flag);["to","be","been","is","and","has","have","with","that","which","at","of","same"].forEach(function(e){r.addProperty(e,function(){return this})}),r.addProperty("not",function(){n(this,"negate",!0)}),r.addProperty("deep",function(){n(this,"deep",!0)}),r.addProperty("any",function(){n(this,"any",!0),n(this,"all",!1)}),r.addProperty("all",function(){n(this,"all",!0),n(this,"any",!1)}),r.addChainableMethod("an",an),r.addChainableMethod("a",an),r.addChainableMethod("include",include,includeChainingBehavior),r.addChainableMethod("contain",include,includeChainingBehavior),r.addChainableMethod("contains",include,includeChainingBehavior),r.addChainableMethod("includes",include,includeChainingBehavior),r.addProperty("ok",function(){this.assert(n(this,"object"),"expected #{this} to be truthy","expected #{this} to be falsy")}),r.addProperty("true",function(){this.assert(!0===n(this,"object"),"expected #{this} to be true","expected #{this} to be false",!this.negate)}),r.addProperty("false",function(){this.assert(!1===n(this,"object"),"expected #{this} to be false","expected #{this} to be true",!!this.negate)}),r.addProperty("null",function(){this.assert(null===n(this,"object"),"expected #{this} to be null","expected #{this} not to be null")}),r.addProperty("undefined",function(){this.assert(void 0===n(this,"object"),"expected #{this} to be undefined","expected #{this} not to be undefined")}),r.addProperty("NaN",function(){this.assert(isNaN(n(this,"object")),"expected #{this} to be NaN","expected #{this} not to be NaN")}),r.addProperty("exist",function(){this.assert(null!=n(this,"object"),"expected #{this} to exist","expected #{this} to not exist")}),r.addProperty("empty",function(){var e=n(this,"object"),t=e;Array.isArray(e)||"string"==typeof object?t=e.length:"object"==typeof e&&(t=Object.keys(e).length),this.assert(!t,"expected #{this} to be empty","expected #{this} not to be empty")}),r.addProperty("arguments",checkArguments),r.addProperty("Arguments",checkArguments),r.addMethod("equal",assertEqual),r.addMethod("equals",assertEqual),r.addMethod("eq",assertEqual),r.addMethod("eql",assertEql),r.addMethod("eqls",assertEql),r.addMethod("above",assertAbove),r.addMethod("gt",assertAbove),r.addMethod("greaterThan",assertAbove),r.addMethod("least",assertLeast),r.addMethod("gte",assertLeast),r.addMethod("below",assertBelow),r.addMethod("lt",assertBelow),r.addMethod("lessThan",assertBelow),r.addMethod("most",assertMost),r.addMethod("lte",assertMost),r.addMethod("within",function(e,t,i){i&&n(this,"message",i);var a=n(this,"object"),o=e+".."+t;if(n(this,"doLength")){new r(a,i).to.have.property("length");var s=a.length;this.assert(s>=e&&s<=t,"expected #{this} to have a length within "+o,"expected #{this} to not have a length within "+o)}else this.assert(a>=e&&a<=t,"expected #{this} to be within "+o,"expected #{this} to not be within "+o)}),r.addMethod("instanceof",assertInstanceOf),r.addMethod("instanceOf",assertInstanceOf),r.addMethod("property",function(e,r,i){i&&n(this,"message",i);var a=!!n(this,"deep"),o=a?"deep property ":"property ",s=n(this,"negate"),c=n(this,"object"),u=a?t.getPathInfo(e,c):null,l=a?u.exists:t.hasProperty(e,c),d=a?u.value:c[e];if(s&&arguments.length>1){if(void 0===d)throw i=null!=i?i+": ":"",new Error(i+t.inspect(c)+" has no "+o+t.inspect(e))}else this.assert(l,"expected #{this} to have a "+o+t.inspect(e),"expected #{this} to not have "+o+t.inspect(e));arguments.length>1&&this.assert(r===d,"expected #{this} to have a "+o+t.inspect(e)+" of #{exp}, but got #{act}","expected #{this} to not have a "+o+t.inspect(e)+" of #{act}",r,d),n(this,"object",d)}),r.addMethod("ownProperty",assertOwnProperty),r.addMethod("haveOwnProperty",assertOwnProperty),r.addMethod("ownPropertyDescriptor",assertOwnPropertyDescriptor),r.addMethod("haveOwnPropertyDescriptor",assertOwnPropertyDescriptor),r.addChainableMethod("length",assertLength,assertLengthChain),r.addMethod("lengthOf",assertLength),r.addMethod("match",assertMatch),r.addMethod("matches",assertMatch),r.addMethod("string",function(e,i){i&&n(this,"message",i);var a=n(this,"object");new r(a,i).is.a("string"),this.assert(~a.indexOf(e),"expected #{this} to contain "+t.inspect(e),"expected #{this} to not contain "+t.inspect(e))}),r.addMethod("keys",assertKeys),r.addMethod("key",assertKeys),r.addMethod("throw",assertThrows),r.addMethod("throws",assertThrows),r.addMethod("Throw",assertThrows),r.addMethod("respondTo",respondTo),r.addMethod("respondsTo",respondTo),r.addProperty("itself",function(){n(this,"itself",!0)}),r.addMethod("satisfy",satisfy),r.addMethod("satisfies",satisfy),r.addMethod("closeTo",closeTo),r.addMethod("approximately",closeTo),r.addMethod("members",function(e,i){i&&n(this,"message",i);var a=n(this,"object");new r(a).to.be.an("array"),new r(e).to.be.an("array");var o=n(this,"deep")?t.eql:void 0;return n(this,"contains")?this.assert(isSubsetOf(e,a,o),"expected #{this} to be a superset of #{act}","expected #{this} to not be a superset of #{act}",a,e):void this.assert(isSubsetOf(a,e,o)&&isSubsetOf(e,a,o),"expected #{this} to have the same members as #{act}","expected #{this} to not have the same members as #{act}",a,e)}),r.addMethod("oneOf",oneOf),r.addChainableMethod("change",assertChanges),r.addChainableMethod("changes",assertChanges),r.addChainableMethod("increase",assertIncreases),r.addChainableMethod("increases",assertIncreases),r.addChainableMethod("decrease",assertDecreases),r.addChainableMethod("decreases",assertDecreases),r.addProperty("extensible",function(){var e,t=n(this,"object");try{e=Object.isExtensible(t)}catch(t){if(!(t instanceof TypeError))throw t;e=!1}this.assert(e,"expected #{this} to be extensible","expected #{this} to not be extensible")}),r.addProperty("sealed",function(){var e,t=n(this,"object");try{e=Object.isSealed(t)}catch(t){if(!(t instanceof TypeError))throw t;e=!0}this.assert(e,"expected #{this} to be sealed","expected #{this} to not be sealed")}),r.addProperty("frozen",function(){var e,t=n(this,"object");try{e=Object.isFrozen(t)}catch(t){if(!(t instanceof TypeError))throw t;e=!0}this.assert(e,"expected #{this} to be frozen","expected #{this} to not be frozen")})}},{}],6:[function(e,t,r){t.exports=function(e,t){var r=e.Assertion,n=t.flag,i=e.assert=function(t,n){var i=new r(null,null,e.assert);i.assert(t,n,"[ negation message unavailable ]")};i.fail=function(t,r,n,a){throw n=n||"assert.fail()",new e.AssertionError(n,{actual:t,expected:r,operator:a},i.fail)},i.isOk=function(e,t){new r(e,t).is.ok},i.isNotOk=function(e,t){new r(e,t).is.not.ok},i.equal=function(e,t,a){var o=new r(e,a,i.equal);o.assert(t==n(o,"object"),"expected #{this} to equal #{exp}","expected #{this} to not equal #{act}",t,e)},i.notEqual=function(e,t,a){var o=new r(e,a,i.notEqual);o.assert(t!=n(o,"object"),"expected #{this} to not equal #{exp}","expected #{this} to equal #{act}",t,e)},i.strictEqual=function(e,t,n){new r(e,n).to.equal(t)},i.notStrictEqual=function(e,t,n){new r(e,n).to.not.equal(t)},i.deepEqual=function(e,t,n){new r(e,n).to.eql(t)},i.notDeepEqual=function(e,t,n){new r(e,n).to.not.eql(t)},i.isAbove=function(e,t,n){new r(e,n).to.be.above(t)},i.isAtLeast=function(e,t,n){new r(e,n).to.be.least(t)},i.isBelow=function(e,t,n){new r(e,n).to.be.below(t)},i.isAtMost=function(e,t,n){new r(e,n).to.be.most(t)},i.isTrue=function(e,t){new r(e,t).is.true},i.isNotTrue=function(e,t){new r(e,t).to.not.equal(!0)},i.isFalse=function(e,t){new r(e,t).is.false},i.isNotFalse=function(e,t){new r(e,t).to.not.equal(!1)},i.isNull=function(e,t){new r(e,t).to.equal(null)},i.isNotNull=function(e,t){new r(e,t).to.not.equal(null)},i.isNaN=function(e,t){new r(e,t).to.be.NaN},i.isNotNaN=function(e,t){new r(e,t).not.to.be.NaN},i.isUndefined=function(e,t){new r(e,t).to.equal(void 0)},i.isDefined=function(e,t){new r(e,t).to.not.equal(void 0)},i.isFunction=function(e,t){new r(e,t).to.be.a("function")},i.isNotFunction=function(e,t){new r(e,t).to.not.be.a("function")},i.isObject=function(e,t){new r(e,t).to.be.a("object")},i.isNotObject=function(e,t){new r(e,t).to.not.be.a("object")},i.isArray=function(e,t){new r(e,t).to.be.an("array")},i.isNotArray=function(e,t){new r(e,t).to.not.be.an("array")},i.isString=function(e,t){new r(e,t).to.be.a("string")},i.isNotString=function(e,t){new r(e,t).to.not.be.a("string")},i.isNumber=function(e,t){new r(e,t).to.be.a("number")},i.isNotNumber=function(e,t){new r(e,t).to.not.be.a("number")},i.isBoolean=function(e,t){new r(e,t).to.be.a("boolean")},i.isNotBoolean=function(e,t){new r(e,t).to.not.be.a("boolean")},i.typeOf=function(e,t,n){new r(e,n).to.be.a(t)},i.notTypeOf=function(e,t,n){new r(e,n).to.not.be.a(t)},i.instanceOf=function(e,t,n){new r(e,n).to.be.instanceOf(t)},i.notInstanceOf=function(e,t,n){new r(e,n).to.not.be.instanceOf(t)},i.include=function(e,t,n){new r(e,n,i.include).include(t)},i.notInclude=function(e,t,n){new r(e,n,i.notInclude).not.include(t)},i.match=function(e,t,n){new r(e,n).to.match(t)},i.notMatch=function(e,t,n){new r(e,n).to.not.match(t)},i.property=function(e,t,n){new r(e,n).to.have.property(t)},i.notProperty=function(e,t,n){new r(e,n).to.not.have.property(t)},i.deepProperty=function(e,t,n){new r(e,n).to.have.deep.property(t)},i.notDeepProperty=function(e,t,n){new r(e,n).to.not.have.deep.property(t)},i.propertyVal=function(e,t,n,i){new r(e,i).to.have.property(t,n)},i.propertyNotVal=function(e,t,n,i){new r(e,i).to.not.have.property(t,n)},i.deepPropertyVal=function(e,t,n,i){new r(e,i).to.have.deep.property(t,n)},i.deepPropertyNotVal=function(e,t,n,i){new r(e,i).to.not.have.deep.property(t,n)},i.lengthOf=function(e,t,n){new r(e,n).to.have.length(t)},i.throws=function(e,t,i,a){("string"==typeof t||t instanceof RegExp)&&(i=t,t=null);var o=new r(e,a).to.throw(t,i);return n(o,"object")},i.doesNotThrow=function(e,t,n){"string"==typeof t&&(n=t,t=null),new r(e,n).to.not.Throw(t)},i.operator=function(e,i,a,o){var s;switch(i){case"==":s=e==a;break;case"===":s=e===a;break;case">":s=e>a;break;case">=":s=e>=a;break;case"<":s=e<a;break;case"<=":s=e<=a;break;case"!=":s=e!=a;break;case"!==":s=e!==a;break;default:throw new Error('Invalid operator "'+i+'"')}var c=new r(s,o);c.assert(!0===n(c,"object"),"expected "+t.inspect(e)+" to be "+i+" "+t.inspect(a),"expected "+t.inspect(e)+" to not be "+i+" "+t.inspect(a))},i.closeTo=function(e,t,n,i){new r(e,i).to.be.closeTo(t,n)},i.approximately=function(e,t,n,i){new r(e,i).to.be.approximately(t,n)},i.sameMembers=function(e,t,n){new r(e,n).to.have.same.members(t)},i.sameDeepMembers=function(e,t,n){new r(e,n).to.have.same.deep.members(t)},i.includeMembers=function(e,t,n){new r(e,n).to.include.members(t)},i.includeDeepMembers=function(e,t,n){new r(e,n).to.include.deep.members(t)},i.oneOf=function(e,t,n){new r(e,n).to.be.oneOf(t)},i.changes=function(e,t,n){new r(e).to.change(t,n)},i.doesNotChange=function(e,t,n){new r(e).to.not.change(t,n)},i.increases=function(e,t,n){new r(e).to.increase(t,n)},i.doesNotIncrease=function(e,t,n){new r(e).to.not.increase(t,n)},i.decreases=function(e,t,n){new r(e).to.decrease(t,n)},i.doesNotDecrease=function(e,t,n){new r(e).to.not.decrease(t,n)},i.ifError=function(e){if(e)throw e},i.isExtensible=function(e,t){new r(e,t).to.be.extensible},i.isNotExtensible=function(e,t){new r(e,t).to.not.be.extensible},i.isSealed=function(e,t){new r(e,t).to.be.sealed},i.isNotSealed=function(e,t){new r(e,t).to.not.be.sealed},i.isFrozen=function(e,t){new r(e,t).to.be.frozen},i.isNotFrozen=function(e,t){new r(e,t).to.not.be.frozen},function alias(e,t){return i[t]=i[e],alias}("isOk","ok")("isNotOk","notOk")("throws","throw")("throws","Throw")("isExtensible","extensible")("isNotExtensible","notExtensible")("isSealed","sealed")("isNotSealed","notSealed")("isFrozen","frozen")("isNotFrozen","notFrozen")}},{}],7:[function(e,t,r){t.exports=function(e,t){e.expect=function(t,r){return new e.Assertion(t,r)},e.expect.fail=function(t,r,n,i){throw n=n||"expect.fail()",new e.AssertionError(n,{actual:t,expected:r,operator:i},e.expect.fail)}}},{}],8:[function(e,t,r){t.exports=function(e,t){function loadShould(){function shouldGetter(){return this instanceof String||this instanceof Number||this instanceof Boolean?new r(this.valueOf(),null,shouldGetter):new r(this,null,shouldGetter)}function shouldSetter(e){Object.defineProperty(this,"should",{value:e,enumerable:!0,configurable:!0,writable:!0})}Object.defineProperty(Object.prototype,"should",{set:shouldSetter,get:shouldGetter,configurable:!0});var t={};return t.fail=function(r,n,i,a){throw i=i||"should.fail()",new e.AssertionError(i,{actual:r,expected:n,operator:a},t.fail)},t.equal=function(e,t,n){new r(e,n).to.equal(t)},t.Throw=function(e,t,n,i){new r(e,i).to.Throw(t,n)},t.exist=function(e,t){new r(e,t).to.exist},t.not={},t.not.equal=function(e,t,n){new r(e,n).to.not.equal(t)},t.not.Throw=function(e,t,n,i){new r(e,i).to.not.Throw(t,n)},t.not.exist=function(e,t){new r(e,t).to.not.exist},t.throw=t.Throw,t.not.throw=t.not.Throw,t}var r=e.Assertion;e.should=loadShould,e.Should=loadShould}},{}],9:[function(e,t,r){var n=e("./transferFlags"),i=e("./flag"),a=e("../config"),o="__proto__"in Object,s=/^(?:length|name|arguments|caller)$/,c=Function.prototype.call,u=Function.prototype.apply;t.exports=function(e,t,r,l){"function"!=typeof l&&(l=function(){});var d={method:r,chainingBehavior:l};e.__methods||(e.__methods={}),e.__methods[t]=d,Object.defineProperty(e,t,{get:function(){d.chainingBehavior.call(this);var t=function assert(){var e=i(this,"ssfi");e&&a.includeStack===!1&&i(this,"ssfi",assert);var t=d.method.apply(this,arguments);return void 0===t?this:t};if(o){var r=t.__proto__=Object.create(this);r.call=c,r.apply=u}else{var l=Object.getOwnPropertyNames(e);l.forEach(function(r){if(!s.test(r)){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n)}})}return n(this,t),t},configurable:!0})}},{"../config":4,"./flag":13,"./transferFlags":29}],10:[function(e,t,r){var n=e("../config"),i=e("./flag");t.exports=function(e,t,r){e[t]=function(){var a=i(this,"ssfi");a&&n.includeStack===!1&&i(this,"ssfi",e[t]);var o=r.apply(this,arguments);return void 0===o?this:o}}},{"../config":4,"./flag":13}],11:[function(e,t,r){var n=e("../config"),i=e("./flag");t.exports=function(e,t,r){Object.defineProperty(e,t,{get:function addProperty(){var e=i(this,"ssfi");e&&n.includeStack===!1&&i(this,"ssfi",addProperty);var t=r.call(this);return void 0===t?this:t},configurable:!0})}},{"../config":4,"./flag":13}],12:[function(e,t,r){var n=e("assertion-error"),i=e("./flag"),a=e("type-detect");t.exports=function(e,t){var e=i(e,"object");t=t.map(function(e){return e.toLowerCase()}),t.sort();var r=t.map(function(e,r){var n=~["a","e","i","o","u"].indexOf(e.charAt(0))?"an":"a",i=t.length>1&&r===t.length-1?"or ":"";return i+n+" "+e}).join(", ");if(!t.some(function(t){return a(e)===t}))throw new n("object tested must be "+r+", but "+a(e)+" given")}},{"./flag":13,"assertion-error":30,"type-detect":35}],13:[function(e,t,r){t.exports=function(e,t,r){var n=e.__flags||(e.__flags=Object.create(null));return 3!==arguments.length?n[t]:void(n[t]=r)}},{}],14:[function(e,t,r){t.exports=function(e,t){return t.length>4?t[4]:e._obj}},{}],15:[function(e,t,r){t.exports=function(e){var t=[];for(var r in e)t.push(r);return t}},{}],16:[function(e,t,r){var n=e("./flag"),i=e("./getActual"),a=(e("./inspect"),e("./objDisplay"));t.exports=function(e,t){var r=n(e,"negate"),o=n(e,"object"),s=t[3],c=i(e,t),u=r?t[2]:t[1],l=n(e,"message");return"function"==typeof u&&(u=u()),u=u||"",u=u.replace(/#\{this\}/g,function(){return a(o)}).replace(/#\{act\}/g,function(){return a(c)}).replace(/#\{exp\}/g,function(){return a(s)}),l?l+": "+u:u}},{"./flag":13,"./getActual":14,"./inspect":23,"./objDisplay":24}],17:[function(e,t,r){t.exports=function(e){if(e.name)return e.name;var t=/^\s?function ([^(]*)\(/.exec(e);return t&&t[1]?t[1]:""}},{}],18:[function(e,t,r){function parsePath(e){var t=e.replace(/([^\\])\[/g,"$1.["),r=t.match(/(\\\.|[^.]+?)+/g);return r.map(function(e){var t=/^\[(\d+)\]$/,r=t.exec(e);return r?{i:parseFloat(r[1])}:{p:e.replace(/\\([.\[\]])/g,"$1")}})}function _getPathValue(e,t,r){var n,i=t;r=void 0===r?e.length:r;for(var a=0,o=r;a<o;a++){var s=e[a];i?("undefined"!=typeof s.p?i=i[s.p]:"undefined"!=typeof s.i&&(i=i[s.i]),a==o-1&&(n=i)):n=void 0}return n}var n=e("./hasProperty");t.exports=function(e,t){var r=parsePath(e),i=r[r.length-1],a={
parent:r.length>1?_getPathValue(r,t,r.length-1):t,name:i.p||i.i,value:_getPathValue(r,t)};return a.exists=n(a.name,a.parent),a}},{"./hasProperty":21}],19:[function(e,t,r){var n=e("./getPathInfo");t.exports=function(e,t){var r=n(e,t);return r.value}},{"./getPathInfo":18}],20:[function(e,t,r){t.exports=function(e){function addProperty(e){t.indexOf(e)===-1&&t.push(e)}for(var t=Object.getOwnPropertyNames(e),r=Object.getPrototypeOf(e);null!==r;)Object.getOwnPropertyNames(r).forEach(addProperty),r=Object.getPrototypeOf(r);return t}},{}],21:[function(e,t,r){var n=e("type-detect"),i={number:Number,string:String};t.exports=function(e,t){var r=n(t);return"null"!==r&&"undefined"!==r&&(i[r]&&"object"!=typeof t&&(t=new i[r](t)),e in t)}},{"type-detect":35}],22:[function(e,t,r){var r=t.exports={};r.test=e("./test"),r.type=e("type-detect"),r.expectTypes=e("./expectTypes"),r.getMessage=e("./getMessage"),r.getActual=e("./getActual"),r.inspect=e("./inspect"),r.objDisplay=e("./objDisplay"),r.flag=e("./flag"),r.transferFlags=e("./transferFlags"),r.eql=e("deep-eql"),r.getPathValue=e("./getPathValue"),r.getPathInfo=e("./getPathInfo"),r.hasProperty=e("./hasProperty"),r.getName=e("./getName"),r.addProperty=e("./addProperty"),r.addMethod=e("./addMethod"),r.overwriteProperty=e("./overwriteProperty"),r.overwriteMethod=e("./overwriteMethod"),r.addChainableMethod=e("./addChainableMethod"),r.overwriteChainableMethod=e("./overwriteChainableMethod")},{"./addChainableMethod":9,"./addMethod":10,"./addProperty":11,"./expectTypes":12,"./flag":13,"./getActual":14,"./getMessage":16,"./getName":17,"./getPathInfo":18,"./getPathValue":19,"./hasProperty":21,"./inspect":23,"./objDisplay":24,"./overwriteChainableMethod":25,"./overwriteMethod":26,"./overwriteProperty":27,"./test":28,"./transferFlags":29,"deep-eql":31,"type-detect":35}],23:[function(e,t,r){function inspect(e,t,r,n){var i={showHidden:t,seen:[],stylize:function(e){return e}};return formatValue(i,e,"undefined"==typeof r?2:r)}function formatValue(e,t,s){if(t&&"function"==typeof t.inspect&&t.inspect!==r.inspect&&(!t.constructor||t.constructor.prototype!==t)){var c=t.inspect(s);return"string"!=typeof c&&(c=formatValue(e,c,s)),c}var u=formatPrimitive(e,t);if(u)return u;if(o(t)){if("outerHTML"in t)return t.outerHTML;try{if(document.xmlVersion){var l=new XMLSerializer;return l.serializeToString(t)}var d="http://www.w3.org/1999/xhtml",h=document.createElementNS(d,"_");return h.appendChild(t.cloneNode(!1)),html=h.innerHTML.replace("><",">"+t.innerHTML+"<"),h.innerHTML="",html}catch(e){}}var p=a(t),f=e.showHidden?i(t):p;if(0===f.length||isError(t)&&(1===f.length&&"stack"===f[0]||2===f.length&&"description"===f[0]&&"stack"===f[1])){if("function"==typeof t){var m=n(t),g=m?": "+m:"";return e.stylize("[Function"+g+"]","special")}if(isRegExp(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(isDate(t))return e.stylize(Date.prototype.toUTCString.call(t),"date");if(isError(t))return formatError(t)}var _="",y=!1,v=["{","}"];if(isArray(t)&&(y=!0,v=["[","]"]),"function"==typeof t){var m=n(t),g=m?": "+m:"";_=" [Function"+g+"]"}if(isRegExp(t)&&(_=" "+RegExp.prototype.toString.call(t)),isDate(t)&&(_=" "+Date.prototype.toUTCString.call(t)),isError(t))return formatError(t);if(0===f.length&&(!y||0==t.length))return v[0]+_+v[1];if(s<0)return isRegExp(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special");e.seen.push(t);var b;return b=y?formatArray(e,t,s,p,f):f.map(function(r){return formatProperty(e,t,s,p,r,y)}),e.seen.pop(),reduceToSingleString(b,_,v)}function formatPrimitive(e,t){switch(typeof t){case"undefined":return e.stylize("undefined","undefined");case"string":var r="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(r,"string");case"number":return 0===t&&1/t===-(1/0)?e.stylize("-0","number"):e.stylize(""+t,"number");case"boolean":return e.stylize(""+t,"boolean")}if(null===t)return e.stylize("null","null")}function formatError(e){return"["+Error.prototype.toString.call(e)+"]"}function formatArray(e,t,r,n,i){for(var a=[],o=0,s=t.length;o<s;++o)Object.prototype.hasOwnProperty.call(t,String(o))?a.push(formatProperty(e,t,r,n,String(o),!0)):a.push("");return i.forEach(function(i){i.match(/^\d+$/)||a.push(formatProperty(e,t,r,n,i,!0))}),a}function formatProperty(e,t,r,n,i,a){var o,s;if(t.__lookupGetter__&&(t.__lookupGetter__(i)?s=t.__lookupSetter__(i)?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):t.__lookupSetter__(i)&&(s=e.stylize("[Setter]","special"))),n.indexOf(i)<0&&(o="["+i+"]"),s||(e.seen.indexOf(t[i])<0?(s=null===r?formatValue(e,t[i],null):formatValue(e,t[i],r-1),s.indexOf("\n")>-1&&(s=a?s.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+s.split("\n").map(function(e){return"   "+e}).join("\n"))):s=e.stylize("[Circular]","special")),"undefined"==typeof o){if(a&&i.match(/^\d+$/))return s;o=JSON.stringify(""+i),o.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+s}function reduceToSingleString(e,t,r){var n=0,i=e.reduce(function(e,t){return n++,t.indexOf("\n")>=0&&n++,e+t.length+1},0);return i>60?r[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+r[1]:r[0]+t+" "+e.join(", ")+" "+r[1]}function isArray(e){return Array.isArray(e)||"object"==typeof e&&"[object Array]"===objectToString(e)}function isRegExp(e){return"object"==typeof e&&"[object RegExp]"===objectToString(e)}function isDate(e){return"object"==typeof e&&"[object Date]"===objectToString(e)}function isError(e){return"object"==typeof e&&"[object Error]"===objectToString(e)}function objectToString(e){return Object.prototype.toString.call(e)}var n=e("./getName"),i=e("./getProperties"),a=e("./getEnumerableProperties");t.exports=inspect;var o=function(e){return"object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName}},{"./getEnumerableProperties":15,"./getName":17,"./getProperties":20}],24:[function(e,t,r){var n=e("./inspect"),i=e("../config");t.exports=function(e){var t=n(e),r=Object.prototype.toString.call(e);if(i.truncateThreshold&&t.length>=i.truncateThreshold){if("[object Function]"===r)return e.name&&""!==e.name?"[Function: "+e.name+"]":"[Function]";if("[object Array]"===r)return"[ Array("+e.length+") ]";if("[object Object]"===r){var a=Object.keys(e),o=a.length>2?a.splice(0,2).join(", ")+", ...":a.join(", ");return"{ Object ("+o+") }"}return t}return t}},{"../config":4,"./inspect":23}],25:[function(e,t,r){t.exports=function(e,t,r,n){var i=e.__methods[t],a=i.chainingBehavior;i.chainingBehavior=function(){var e=n(a).call(this);return void 0===e?this:e};var o=i.method;i.method=function(){var e=r(o).apply(this,arguments);return void 0===e?this:e}}},{}],26:[function(e,t,r){t.exports=function(e,t,r){var n=e[t],i=function(){return this};n&&"function"==typeof n&&(i=n),e[t]=function(){var e=r(i).apply(this,arguments);return void 0===e?this:e}}},{}],27:[function(e,t,r){t.exports=function(e,t,r){var n=Object.getOwnPropertyDescriptor(e,t),i=function(){};n&&"function"==typeof n.get&&(i=n.get),Object.defineProperty(e,t,{get:function(){var e=r(i).call(this);return void 0===e?this:e},configurable:!0})}},{}],28:[function(e,t,r){var n=e("./flag");t.exports=function(e,t){var r=n(e,"negate"),i=t[0];return r?!i:i}},{"./flag":13}],29:[function(e,t,r){t.exports=function(e,t,r){var n=e.__flags||(e.__flags=Object.create(null));t.__flags||(t.__flags=Object.create(null)),r=3!==arguments.length||r;for(var i in n)(r||"object"!==i&&"ssfi"!==i&&"message"!=i)&&(t.__flags[i]=n[i])}},{}],30:[function(e,t,r){function exclude(){function excludeProps(t,r){Object.keys(r).forEach(function(n){~e.indexOf(n)||(t[n]=r[n])})}var e=[].slice.call(arguments);return function(){for(var e=[].slice.call(arguments),t=0,r={};t<e.length;t++)excludeProps(r,e[t]);return r}}function AssertionError(e,t,r){var n=exclude("name","message","stack","constructor","toJSON"),i=n(t||{});this.message=e||"Unspecified AssertionError",this.showDiff=!1;for(var a in i)this[a]=i[a];r=r||arguments.callee,r&&Error.captureStackTrace?Error.captureStackTrace(this,r):this.stack=(new Error).stack}t.exports=AssertionError,AssertionError.prototype=Object.create(Error.prototype),AssertionError.prototype.name="AssertionError",AssertionError.prototype.constructor=AssertionError,AssertionError.prototype.toJSON=function(e){var t=exclude("constructor","toJSON","stack"),r=t({name:this.name},this);return!1!==e&&this.stack&&(r.stack=this.stack),r}},{}],31:[function(e,t,r){t.exports=e("./lib/eql")},{"./lib/eql":32}],32:[function(e,t,r){function deepEqual(e,t,r){return!!sameValue(e,t)||("date"===i(e)?dateEqual(e,t):"regexp"===i(e)?regexpEqual(e,t):n.isBuffer(e)?bufferEqual(e,t):"arguments"===i(e)?argumentsEqual(e,t,r):!!typeEqual(e,t)&&("object"!==i(e)&&"object"!==i(t)&&"array"!==i(e)&&"array"!==i(t)?sameValue(e,t):objectEqual(e,t,r)))}function sameValue(e,t){return e===t?0!==e||1/e===1/t:e!==e&&t!==t}function typeEqual(e,t){return i(e)===i(t)}function dateEqual(e,t){return"date"===i(t)&&sameValue(e.getTime(),t.getTime())}function regexpEqual(e,t){return"regexp"===i(t)&&sameValue(e.toString(),t.toString())}function argumentsEqual(e,t,r){return"arguments"===i(t)&&(e=[].slice.call(e),t=[].slice.call(t),deepEqual(e,t,r))}function enumerable(e){var t=[];for(var r in e)t.push(r);return t}function iterableEqual(e,t){if(e.length!==t.length)return!1;for(var r=0,n=!0;r<e.length;r++)if(e[r]!==t[r]){n=!1;break}return n}function bufferEqual(e,t){return!!n.isBuffer(t)&&iterableEqual(e,t)}function isValue(e){return null!==e&&void 0!==e}function objectEqual(e,t,r){if(!isValue(e)||!isValue(t))return!1;if(e.prototype!==t.prototype)return!1;var n;if(r){for(n=0;n<r.length;n++)if(r[n][0]===e&&r[n][1]===t||r[n][0]===t&&r[n][1]===e)return!0}else r=[];try{var i=enumerable(e),a=enumerable(t)}catch(e){return!1}if(i.sort(),a.sort(),!iterableEqual(i,a))return!1;r.push([e,t]);var o;for(n=i.length-1;n>=0;n--)if(o=i[n],!deepEqual(e[o],t[o],r))return!1;return!0}var n,i=e("type-detect");try{n=e("buffer").Buffer}catch(e){n={},n.isBuffer=function(){return!1}}t.exports=deepEqual},{buffer:void 0,"type-detect":33}],33:[function(e,t,r){t.exports=e("./lib/type")},{"./lib/type":34}],34:[function(e,t,r){function getType(e){var t=Object.prototype.toString.call(e);return n[t]?n[t]:null===e?"null":void 0===e?"undefined":e===Object(e)?"object":typeof e}function Library(){this.tests={}}var r=t.exports=getType,n={"[object Array]":"array","[object RegExp]":"regexp","[object Function]":"function","[object Arguments]":"arguments","[object Date]":"date"};r.Library=Library,Library.prototype.of=getType,Library.prototype.define=function(e,t){return 1===arguments.length?this.tests[e]:(this.tests[e]=t,this)},Library.prototype.test=function(e,t){if(t===getType(e))return!0;var r=this.tests[t];if(r&&"regexp"===getType(r))return r.test(e);if(r&&"function"===getType(r))return r(e);throw new ReferenceError('Type test "'+t+'" not defined or invalid.')}},{}],35:[function(e,t,r){arguments[4][33][0].apply(r,arguments)},{"./lib/type":36,dup:33}],36:[function(e,t,r){function getType(e){var t=Object.prototype.toString.call(e).match(n)[1].toLowerCase();return"function"==typeof Promise&&e instanceof Promise?"promise":null===e?"null":void 0===e?"undefined":t}function Library(){return this instanceof Library?void(this.tests={}):new Library}var r=t.exports=getType,n=/^\[object (.*)\]$/;r.Library=Library,Library.prototype.of=getType,Library.prototype.define=function(e,t){return 1===arguments.length?this.tests[e]:(this.tests[e]=t,this)},Library.prototype.test=function(e,t){if(t===getType(e))return!0;var r=this.tests[t];if(r&&"regexp"===getType(r))return r.test(e);if(r&&"function"===getType(r))return r(e);throw new ReferenceError('Type test "'+t+'" not defined or invalid.')}},{}]},{},[1])(1)}),function(){"use strict";function lib$rsvp$utils$$objectOrFunction(e){return"function"==typeof e||"object"==typeof e&&null!==e}function lib$rsvp$utils$$isFunction(e){return"function"==typeof e}function lib$rsvp$utils$$isMaybeThenable(e){return"object"==typeof e&&null!==e}function lib$rsvp$utils$$F(){}function lib$rsvp$events$$indexOf(e,t){for(var r=0,n=e.length;r<n;r++)if(e[r]===t)return r;return-1}function lib$rsvp$events$$callbacksFor(e){var t=e._promiseCallbacks;return t||(t=e._promiseCallbacks={}),t}function lib$rsvp$config$$configure(e,t){return"onerror"===e?void a.on("error",t):2!==arguments.length?a[e]:void(a[e]=t)}function lib$rsvp$instrument$$scheduleFlush(){setTimeout(function(){for(var e,t=0;t<o.length;t++){e=o[t];var r=e.payload;r.guid=r.key+r.id,r.childGuid=r.key+r.childId,r.error&&(r.stack=r.error.stack),a.trigger(e.name,e.payload)}o.length=0},50)}function lib$rsvp$instrument$$instrument(e,t,n){1===o.push({name:e,payload:{key:t._guidKey,id:t._id,eventName:e,detail:t._result,childId:n&&n._id,label:t._label,timeStamp:r(),error:a["instrument-with-stack"]?new Error(t._label):null}})&&lib$rsvp$instrument$$scheduleFlush()}function lib$rsvp$$internal$$withOwnPromise(){return new TypeError("A promises callback cannot return that same promise.")}function lib$rsvp$$internal$$noop(){}function lib$rsvp$$internal$$getThen(e){try{return e.then}catch(e){return d.error=e,d}}function lib$rsvp$$internal$$tryThen(e,t,r,n){try{e.call(t,r,n)}catch(e){return e}}function lib$rsvp$$internal$$handleForeignThenable(e,t,r){a.async(function(e){var n=!1,i=lib$rsvp$$internal$$tryThen(r,t,function(r){n||(n=!0,t!==r?lib$rsvp$$internal$$resolve(e,r):lib$rsvp$$internal$$fulfill(e,r))},function(t){n||(n=!0,lib$rsvp$$internal$$reject(e,t))},"Settle: "+(e._label||" unknown promise"));!n&&i&&(n=!0,lib$rsvp$$internal$$reject(e,i))},e)}function lib$rsvp$$internal$$handleOwnThenable(e,t){t._state===u?lib$rsvp$$internal$$fulfill(e,t._result):t._state===l?(t._onError=null,lib$rsvp$$internal$$reject(e,t._result)):lib$rsvp$$internal$$subscribe(t,void 0,function(r){t!==r?lib$rsvp$$internal$$resolve(e,r):lib$rsvp$$internal$$fulfill(e,r)},function(t){lib$rsvp$$internal$$reject(e,t)})}function lib$rsvp$$internal$$handleMaybeThenable(e,t){if(t.constructor===e.constructor)lib$rsvp$$internal$$handleOwnThenable(e,t);else{var r=lib$rsvp$$internal$$getThen(t);r===d?lib$rsvp$$internal$$reject(e,d.error):void 0===r?lib$rsvp$$internal$$fulfill(e,t):lib$rsvp$utils$$isFunction(r)?lib$rsvp$$internal$$handleForeignThenable(e,t,r):lib$rsvp$$internal$$fulfill(e,t)}}function lib$rsvp$$internal$$resolve(e,t){e===t?lib$rsvp$$internal$$fulfill(e,t):lib$rsvp$utils$$objectOrFunction(t)?lib$rsvp$$internal$$handleMaybeThenable(e,t):lib$rsvp$$internal$$fulfill(e,t)}function lib$rsvp$$internal$$publishRejection(e){e._onError&&e._onError(e._result),lib$rsvp$$internal$$publish(e)}function lib$rsvp$$internal$$fulfill(e,t){e._state===c&&(e._result=t,e._state=u,0===e._subscribers.length?a.instrument&&s("fulfilled",e):a.async(lib$rsvp$$internal$$publish,e))}function lib$rsvp$$internal$$reject(e,t){e._state===c&&(e._state=l,e._result=t,a.async(lib$rsvp$$internal$$publishRejection,e))}function lib$rsvp$$internal$$subscribe(e,t,r,n){var i=e._subscribers,o=i.length;e._onError=null,i[o]=t,i[o+u]=r,i[o+l]=n,0===o&&e._state&&a.async(lib$rsvp$$internal$$publish,e)}function lib$rsvp$$internal$$publish(e){var t=e._subscribers,r=e._state;if(a.instrument&&s(r===u?"fulfilled":"rejected",e),0!==t.length){for(var n,i,o=e._result,c=0;c<t.length;c+=3)n=t[c],i=t[c+r],n?lib$rsvp$$internal$$invokeCallback(r,n,i,o):i(o);e._subscribers.length=0}}function lib$rsvp$$internal$$ErrorObject(){this.error=null}function lib$rsvp$$internal$$tryCatch(e,t){try{return e(t)}catch(e){return h.error=e,h}}function lib$rsvp$$internal$$invokeCallback(e,t,r,n){var i,a,o,s,d=lib$rsvp$utils$$isFunction(r);if(d){if(i=lib$rsvp$$internal$$tryCatch(r,n),i===h?(s=!0,a=i.error,i=null):o=!0,t===i)return void lib$rsvp$$internal$$reject(t,lib$rsvp$$internal$$withOwnPromise())}else i=n,o=!0;t._state!==c||(d&&o?lib$rsvp$$internal$$resolve(t,i):s?lib$rsvp$$internal$$reject(t,a):e===u?lib$rsvp$$internal$$fulfill(t,i):e===l&&lib$rsvp$$internal$$reject(t,i))}function lib$rsvp$$internal$$initializePromise(e,t){var r=!1;try{t(function(t){r||(r=!0,lib$rsvp$$internal$$resolve(e,t))},function(t){r||(r=!0,lib$rsvp$$internal$$reject(e,t))})}catch(t){lib$rsvp$$internal$$reject(e,t)}}function lib$rsvp$enumerator$$makeSettledResult(e,t,r){return e===u?{state:"fulfilled",value:r}:{state:"rejected",reason:r}}function lib$rsvp$enumerator$$Enumerator(e,t,r,n){this._instanceConstructor=e,this.promise=new e(lib$rsvp$$internal$$noop,n),this._abortOnReject=r,this._validateInput(t)?(this._input=t,this.length=t.length,this._remaining=t.length,this._init(),0===this.length?lib$rsvp$$internal$$fulfill(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&lib$rsvp$$internal$$fulfill(this.promise,this._result))):lib$rsvp$$internal$$reject(this.promise,this._validationError())}function lib$rsvp$promise$all$$all(e,t){return new p(this,e,(!0),t).promise}function lib$rsvp$promise$race$$race(e,r){function onFulfillment(e){lib$rsvp$$internal$$resolve(i,e)}function onRejection(e){lib$rsvp$$internal$$reject(i,e)}var n=this,i=new n(lib$rsvp$$internal$$noop,r);if(!t(e))return lib$rsvp$$internal$$reject(i,new TypeError("You must pass an array to race.")),i;for(var a=e.length,o=0;i._state===c&&o<a;o++)lib$rsvp$$internal$$subscribe(n.resolve(e[o]),void 0,onFulfillment,onRejection);return i}function lib$rsvp$promise$resolve$$resolve(e,t){var r=this;if(e&&"object"==typeof e&&e.constructor===r)return e;var n=new r(lib$rsvp$$internal$$noop,t);return lib$rsvp$$internal$$resolve(n,e),n}function lib$rsvp$promise$reject$$reject(e,t){var r=this,n=new r(lib$rsvp$$internal$$noop,t);return lib$rsvp$$internal$$reject(n,e),n}function lib$rsvp$promise$$needsResolver(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function lib$rsvp$promise$$needsNew(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function lib$rsvp$promise$$Promise(e,t){this._id=v++,this._label=t,this._state=void 0,this._result=void 0,this._subscribers=[],a.instrument&&s("created",this),lib$rsvp$$internal$$noop!==e&&(lib$rsvp$utils$$isFunction(e)||lib$rsvp$promise$$needsResolver(),this instanceof lib$rsvp$promise$$Promise||lib$rsvp$promise$$needsNew(),lib$rsvp$$internal$$initializePromise(this,e))}function lib$rsvp$all$settled$$AllSettled(e,t,r){this._superConstructor(e,t,!1,r)}function lib$rsvp$all$settled$$allSettled(e,t){return new lib$rsvp$all$settled$$AllSettled(b,e,t).promise}function lib$rsvp$all$$all(e,t){return b.all(e,t)}function lib$rsvp$asap$$asap(e,t){R[M]=e,R[M+1]=t,M+=2,2===M&&S()}function lib$rsvp$asap$$useNextTick(){var e=process.nextTick,t=process.versions.node.match(/^(?:(\d+)\.)?(?:(\d+)\.)?(\*|\d+)$/);return Array.isArray(t)&&"0"===t[1]&&"10"===t[2]&&(e=setImmediate),function(){e(lib$rsvp$asap$$flush)}}function lib$rsvp$asap$$useVertxTimer(){return function(){C(lib$rsvp$asap$$flush)}}function lib$rsvp$asap$$useMutationObserver(){var e=0,t=new x(lib$rsvp$asap$$flush),r=document.createTextNode("");return t.observe(r,{characterData:!0}),function(){r.data=e=++e%2}}function lib$rsvp$asap$$useMessageChannel(){var e=new MessageChannel;return e.port1.onmessage=lib$rsvp$asap$$flush,function(){e.port2.postMessage(0)}}function lib$rsvp$asap$$useSetTimeout(){return function(){setTimeout(lib$rsvp$asap$$flush,1)}}function lib$rsvp$asap$$flush(){for(var e=0;e<M;e+=2){var t=R[e],r=R[e+1];t(r),R[e]=void 0,R[e+1]=void 0}M=0}function lib$rsvp$asap$$attemptVertex(){try{var e=require,t=e("vertx");return C=t.runOnLoop||t.runOnContext,lib$rsvp$asap$$useVertxTimer()}catch(e){return lib$rsvp$asap$$useSetTimeout()}}function lib$rsvp$defer$$defer(e){var t={};return t.promise=new b(function(e,r){t.resolve=e,t.reject=r},e),t}function lib$rsvp$filter$$filter(e,t,r){return b.all(e,r).then(function(e){if(!lib$rsvp$utils$$isFunction(t))throw new TypeError("You must pass a function as filter's second argument.");for(var n=e.length,i=new Array(n),a=0;a<n;a++)i[a]=t(e[a]);return b.all(i,r).then(function(t){for(var r=new Array(n),i=0,a=0;a<n;a++)t[a]&&(r[i]=e[a],i++);return r.length=i,r})})}function lib$rsvp$promise$hash$$PromiseHash(e,t,r){this._superConstructor(e,t,!0,r)}function lib$rsvp$hash$settled$$HashSettled(e,t,r){this._superConstructor(e,t,!1,r)}function lib$rsvp$hash$settled$$hashSettled(e,t){return new lib$rsvp$hash$settled$$HashSettled(b,e,t).promise}function lib$rsvp$hash$$hash(e,t){return new F(b,e,t).promise}function lib$rsvp$map$$map(e,t,r){return b.all(e,r).then(function(e){if(!lib$rsvp$utils$$isFunction(t))throw new TypeError("You must pass a function as map's second argument.");for(var n=e.length,i=new Array(n),a=0;a<n;a++)i[a]=t(e[a]);return b.all(i,r)})}function lib$rsvp$node$$Result(){this.value=void 0}function lib$rsvp$node$$getThen(e){try{return e.then}catch(e){return G.value=e,G}}function lib$rsvp$node$$tryApply(e,t,r){try{e.apply(t,r)}catch(e){return G.value=e,G}}function lib$rsvp$node$$makeObject(e,t){for(var r,n,i={},a=e.length,o=new Array(a),s=0;s<a;s++)o[s]=e[s];for(n=0;n<t.length;n++)r=t[n],i[r]=o[n+1];return i}function lib$rsvp$node$$arrayResult(e){for(var t=e.length,r=new Array(t-1),n=1;n<t;n++)r[n-1]=e[n];return r}function lib$rsvp$node$$wrapThenable(e,t){return{then:function(r,n){return e.call(t,r,n)}}}function lib$rsvp$node$$denodeify(e,r){var n=function(){for(var n,i=this,a=arguments.length,o=new Array(a+1),s=!1,c=0;c<a;++c){if(n=arguments[c],!s){if(s=lib$rsvp$node$$needsPromiseInput(n),s===j){var u=new b(lib$rsvp$$internal$$noop);return lib$rsvp$$internal$$reject(u,j.value),u}s&&s!==!0&&(n=lib$rsvp$node$$wrapThenable(s,n))}o[c]=n}var l=new b(lib$rsvp$$internal$$noop);return o[a]=function(e,n){e?lib$rsvp$$internal$$reject(l,e):void 0===r?lib$rsvp$$internal$$resolve(l,n):r===!0?lib$rsvp$$internal$$resolve(l,lib$rsvp$node$$arrayResult(arguments)):t(r)?lib$rsvp$$internal$$resolve(l,lib$rsvp$node$$makeObject(arguments,r)):lib$rsvp$$internal$$resolve(l,n)},s?lib$rsvp$node$$handlePromiseInput(l,o,e,i):lib$rsvp$node$$handleValueInput(l,o,e,i)};return n.__proto__=e,n}function lib$rsvp$node$$handleValueInput(e,t,r,n){var i=lib$rsvp$node$$tryApply(r,n,t);return i===G&&lib$rsvp$$internal$$reject(e,i.value),e}function lib$rsvp$node$$handlePromiseInput(e,t,r,n){return b.all(t).then(function(t){var i=lib$rsvp$node$$tryApply(r,n,t);return i===G&&lib$rsvp$$internal$$reject(e,i.value),e})}function lib$rsvp$node$$needsPromiseInput(e){return!(!e||"object"!=typeof e)&&(e.constructor===b||lib$rsvp$node$$getThen(e))}function lib$rsvp$race$$race(e,t){return b.race(e,t)}function lib$rsvp$reject$$reject(e,t){return b.reject(e,t)}function lib$rsvp$resolve$$resolve(e,t){return b.resolve(e,t)}function lib$rsvp$rethrow$$rethrow(e){throw setTimeout(function(){throw e}),e}function lib$rsvp$$async(e,t){a.async(e,t)}function lib$rsvp$$on(){a.on.apply(a,arguments)}function lib$rsvp$$off(){a.off.apply(a,arguments)}var e;e=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)};var t=e,r=Date.now||function(){return(new Date).getTime()},n=Object.create||function(e){if(arguments.length>1)throw new Error("Second argument not supported");if("object"!=typeof e)throw new TypeError("Argument must be an object");return lib$rsvp$utils$$F.prototype=e,new lib$rsvp$utils$$F},i={mixin:function(e){return e.on=this.on,e.off=this.off,e.trigger=this.trigger,e._promiseCallbacks=void 0,e},on:function(e,t){var r,n=lib$rsvp$events$$callbacksFor(this);r=n[e],r||(r=n[e]=[]),lib$rsvp$events$$indexOf(r,t)===-1&&r.push(t)},off:function(e,t){var r,n,i=lib$rsvp$events$$callbacksFor(this);return t?(r=i[e],n=lib$rsvp$events$$indexOf(r,t),void(n!==-1&&r.splice(n,1))):void(i[e]=[])},trigger:function(e,t){var r,n,i=lib$rsvp$events$$callbacksFor(this);if(r=i[e])for(var a=0;a<r.length;a++)(n=r[a])(t)}},a={instrument:!1};i.mixin(a);var o=[],s=lib$rsvp$instrument$$instrument,c=void 0,u=1,l=2,d=new lib$rsvp$$internal$$ErrorObject,h=new lib$rsvp$$internal$$ErrorObject,p=lib$rsvp$enumerator$$Enumerator;lib$rsvp$enumerator$$Enumerator.prototype._validateInput=function(e){return t(e)},lib$rsvp$enumerator$$Enumerator.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")},lib$rsvp$enumerator$$Enumerator.prototype._init=function(){this._result=new Array(this.length)},lib$rsvp$enumerator$$Enumerator.prototype._enumerate=function(){for(var e=this.length,t=this.promise,r=this._input,n=0;t._state===c&&n<e;n++)this._eachEntry(r[n],n)},lib$rsvp$enumerator$$Enumerator.prototype._eachEntry=function(e,t){var r=this._instanceConstructor;lib$rsvp$utils$$isMaybeThenable(e)?e.constructor===r&&e._state!==c?(e._onError=null,this._settledAt(e._state,t,e._result)):this._willSettleAt(r.resolve(e),t):(this._remaining--,this._result[t]=this._makeResult(u,t,e))},lib$rsvp$enumerator$$Enumerator.prototype._settledAt=function(e,t,r){var n=this.promise;n._state===c&&(this._remaining--,this._abortOnReject&&e===l?lib$rsvp$$internal$$reject(n,r):this._result[t]=this._makeResult(e,t,r)),0===this._remaining&&lib$rsvp$$internal$$fulfill(n,this._result)},lib$rsvp$enumerator$$Enumerator.prototype._makeResult=function(e,t,r){return r},lib$rsvp$enumerator$$Enumerator.prototype._willSettleAt=function(e,t){var r=this;lib$rsvp$$internal$$subscribe(e,void 0,function(e){r._settledAt(u,t,e)},function(e){r._settledAt(l,t,e)})};var f=lib$rsvp$promise$all$$all,m=lib$rsvp$promise$race$$race,g=lib$rsvp$promise$resolve$$resolve,_=lib$rsvp$promise$reject$$reject,y="rsvp_"+r()+"-",v=0,b=lib$rsvp$promise$$Promise;lib$rsvp$promise$$Promise.cast=g,lib$rsvp$promise$$Promise.all=f,lib$rsvp$promise$$Promise.race=m,lib$rsvp$promise$$Promise.resolve=g,lib$rsvp$promise$$Promise.reject=_,lib$rsvp$promise$$Promise.prototype={constructor:lib$rsvp$promise$$Promise,_guidKey:y,_onError:function(e){a.async(function(t){setTimeout(function(){t._onError&&a.trigger("error",e)},0)},this)},then:function(e,t,r){var n=this,i=n._state;if(i===u&&!e||i===l&&!t)return a.instrument&&s("chained",this,this),this;n._onError=null;var o=new this.constructor(lib$rsvp$$internal$$noop,r),c=n._result;if(a.instrument&&s("chained",n,o),i){var d=arguments[i-1];a.async(function(){lib$rsvp$$internal$$invokeCallback(i,o,d,c)})}else lib$rsvp$$internal$$subscribe(n,o,e,t);return o},catch:function(e,t){return this.then(null,e,t)},finally:function(e,t){var r=this.constructor;return this.then(function(t){return r.resolve(e()).then(function(){return t})},function(t){return r.resolve(e()).then(function(){throw t})},t)}},lib$rsvp$all$settled$$AllSettled.prototype=n(p.prototype),lib$rsvp$all$settled$$AllSettled.prototype._superConstructor=p,lib$rsvp$all$settled$$AllSettled.prototype._makeResult=lib$rsvp$enumerator$$makeSettledResult,lib$rsvp$all$settled$$AllSettled.prototype._validationError=function(){return new Error("allSettled must be called with an array")};var C,S,T=lib$rsvp$all$settled$$allSettled,E=lib$rsvp$all$$all,M=0,w=({}.toString,lib$rsvp$asap$$asap),L="undefined"!=typeof window?window:void 0,D=L||{},x=D.MutationObserver||D.WebKitMutationObserver,A="undefined"!=typeof process&&"[object process]"==={}.toString.call(process),O="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,R=new Array(1e3);S=A?lib$rsvp$asap$$useNextTick():x?lib$rsvp$asap$$useMutationObserver():O?lib$rsvp$asap$$useMessageChannel():void 0===L&&"function"==typeof require?lib$rsvp$asap$$attemptVertex():lib$rsvp$asap$$useSetTimeout();var I=lib$rsvp$defer$$defer,B=lib$rsvp$filter$$filter,F=lib$rsvp$promise$hash$$PromiseHash;lib$rsvp$promise$hash$$PromiseHash.prototype=n(p.prototype),lib$rsvp$promise$hash$$PromiseHash.prototype._superConstructor=p,lib$rsvp$promise$hash$$PromiseHash.prototype._init=function(){this._result={}},lib$rsvp$promise$hash$$PromiseHash.prototype._validateInput=function(e){return e&&"object"==typeof e},lib$rsvp$promise$hash$$PromiseHash.prototype._validationError=function(){return new Error("Promise.hash must be called with an object")},lib$rsvp$promise$hash$$PromiseHash.prototype._enumerate=function(){var e=this.promise,t=this._input,r=[];for(var n in t)e._state===c&&Object.prototype.hasOwnProperty.call(t,n)&&r.push({position:n,entry:t[n]});var i=r.length;this._remaining=i;for(var a,o=0;e._state===c&&o<i;o++)a=r[o],this._eachEntry(a.entry,a.position)},lib$rsvp$hash$settled$$HashSettled.prototype=n(F.prototype),lib$rsvp$hash$settled$$HashSettled.prototype._superConstructor=p,lib$rsvp$hash$settled$$HashSettled.prototype._makeResult=lib$rsvp$enumerator$$makeSettledResult,lib$rsvp$hash$settled$$HashSettled.prototype._validationError=function(){return new Error("hashSettled must be called with an object")};var P=lib$rsvp$hash$settled$$hashSettled,N=lib$rsvp$hash$$hash,U=lib$rsvp$map$$map,G=new lib$rsvp$node$$Result,j=new lib$rsvp$node$$Result,V=lib$rsvp$node$$denodeify,H=lib$rsvp$race$$race,$=lib$rsvp$reject$$reject,W=lib$rsvp$resolve$$resolve,k=lib$rsvp$rethrow$$rethrow;a.async=w;if("undefined"!=typeof window&&"object"==typeof window.__PROMISE_INSTRUMENTATION__){var q=window.__PROMISE_INSTRUMENTATION__;lib$rsvp$config$$configure("instrument",!0);for(var z in q)q.hasOwnProperty(z)&&lib$rsvp$$on(z,q[z])}var X={race:H,Promise:b,allSettled:T,hash:N,hashSettled:P,denodeify:V,on:lib$rsvp$$on,off:lib$rsvp$$off,map:U,filter:B,resolve:W,reject:$,all:E,rethrow:k,defer:I,EventTarget:i,configure:lib$rsvp$config$$configure,async:lib$rsvp$$async};"function"==typeof define&&define.amd?define(function(){return X}):"undefined"!=typeof module&&module.exports?module.exports=X:"undefined"!=typeof this&&(this.RSVP=X)}.call(this);var wdCb;!function(e){var t=Math.pow(2,53)-1,r=function(){function JudgeUtils(){}return JudgeUtils.isArray=function(e){var r=e&&e.length;return"number"==typeof r&&r>=0&&r<=t},JudgeUtils.isArrayExactly=function(e){return"[object Array]"===Object.prototype.toString.call(e)},JudgeUtils.isNumber=function(e){return"number"==typeof e},JudgeUtils.isNumberExactly=function(e){return"[object Number]"===Object.prototype.toString.call(e)},JudgeUtils.isString=function(e){return"string"==typeof e},JudgeUtils.isStringExactly=function(e){return"[object String]"===Object.prototype.toString.call(e)},JudgeUtils.isBoolean=function(e){return e===!0||e===!1||"[boolect Boolean]"===toString.call(e)},JudgeUtils.isDom=function(e){return!(!e||1!==e.nodeType)},JudgeUtils.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},JudgeUtils.isDirectObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},JudgeUtils.isHostMethod=function(e,t){var r=typeof e[t];return"function"===r||"object"===r&&!!e[t]||"unknown"===r},JudgeUtils.isNodeJs=function(){return("undefined"!=typeof global&&global.module||"undefined"!=typeof module)&&"undefined"!=typeof module.exports},JudgeUtils.isFunction=function(e){return!0},JudgeUtils}();e.JudgeUtils=r,"function"!=typeof/./&&"object"!=typeof Int8Array?r.isFunction=function(e){return"function"==typeof e}:r.isFunction=function(e){return"[object Function]"===Object.prototype.toString.call(e)}}(wdCb||(wdCb={}));var wdCb;!function(e){e.JudgeUtils.isNodeJs()?e.root=global:e.root=window}(wdCb||(wdCb={}));var wdCb;!function(e){if("performance"in e.root==!1&&(e.root.performance={}),Date.now=Date.now||function(){return(new Date).getTime()},"now"in e.root.performance==!1){var t=e.root.performance.timing&&e.root.performance.timing.navigationStart?performance.timing.navigationStart:Date.now();e.root.performance.now=function(){return Date.now()-t}}}(wdCb||(wdCb={}));var wdCb;!function(e){e.$BREAK={break:!0},e.$REMOVE=void 0}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function Log(){}return Log.log=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];
this._exec("log",t)||e.root.alert(t.join(",")),this._exec("trace",t)},Log.assert=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];e&&(this._exec("assert",arguments,1)||this.log.apply(this,Array.prototype.slice.call(arguments,1)))},Log.error=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(e)throw new Error(Array.prototype.slice.call(arguments,1).join("\n"))},Log.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=this._exec("warn",arguments);r?this._exec("trace",["warn trace"]):this.log.apply(this,arguments)},Log._exec=function(t,r,n){return void 0===n&&(n=0),!(!e.root.console||!e.root.console[t])&&(e.root.console[t].apply(e.root.console,Array.prototype.slice.call(r,n)),!0)},Log.info={INVALID_PARAM:"invalid parameter",helperFunc:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r="";return e.forEach(function(e){r+=String(e)+" "}),r.slice(0,-1)},assertion:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(2===e.length)return this.helperFunc(e[0],e[1]);if(3===e.length)return this.helperFunc(e[1],e[0],e[2]);throw new Error("args.length must <= 3")},FUNC_INVALID:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("invalid"),this.assertion.apply(this,e)},FUNC_MUST:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("must"),this.assertion.apply(this,e)},FUNC_MUST_BE:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("must be"),this.assertion.apply(this,e)},FUNC_MUST_NOT_BE:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("must not be"),this.assertion.apply(this,e)},FUNC_SHOULD:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("should"),this.assertion.apply(this,e)},FUNC_SHOULD_NOT:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("should not"),this.assertion.apply(this,e)},FUNC_SUPPORT:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("support"),this.assertion.apply(this,e)},FUNC_NOT_SUPPORT:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("not support"),this.assertion.apply(this,e)},FUNC_MUST_DEFINE:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("must define"),this.assertion.apply(this,e)},FUNC_MUST_NOT_DEFINE:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("must not define"),this.assertion.apply(this,e)},FUNC_UNKNOW:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("unknow"),this.assertion.apply(this,e)},FUNC_EXPECT:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("expect"),this.assertion.apply(this,e)},FUNC_UNEXPECT:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("unexpect"),this.assertion.apply(this,e)},FUNC_EXIST:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("exist"),this.assertion.apply(this,e)},FUNC_NOT_EXIST:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("not exist"),this.assertion.apply(this,e)},FUNC_ONLY:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("only"),this.assertion.apply(this,e)},FUNC_CAN_NOT:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return e.unshift("can't"),this.assertion.apply(this,e)}},Log}();e.Log=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function List(){this.children=null}return List.prototype.getCount=function(){return this.children.length},List.prototype.hasChild=function(e){for(var t=null,r=this.children,n=0,i=r.length;n<i;n++){if(t=r[n],e.uid&&t.uid&&e.uid==t.uid)return!0;if(e===t)return!0}return!1},List.prototype.hasChildWithFunc=function(e){for(var t=0,r=this.children.length;t<r;t++)if(e(this.children[t],t))return!0;return!1},List.prototype.getChildren=function(){return this.children},List.prototype.getChild=function(e){return this.children[e]},List.prototype.addChild=function(e){return this.children.push(e),this},List.prototype.addChildren=function(t){if(e.JudgeUtils.isArray(t)){var r=t;this.children=this.children.concat(r)}else if(t instanceof List){var r=t;this.children=this.children.concat(r.getChildren())}else{var n=t;this.addChild(n)}return this},List.prototype.setChildren=function(e){return this.children=e,this},List.prototype.unShiftChild=function(e){this.children.unshift(e)},List.prototype.removeAllChildren=function(){return this.children=[],this},List.prototype.forEach=function(e,t){return this._forEach(this.children,e,t),this},List.prototype.toArray=function(){return this.children},List.prototype.copyChildren=function(){return this.children.slice(0)},List.prototype.removeChildHelper=function(t){var r=null;if(e.JudgeUtils.isFunction(t)){var n=t;r=this._removeChild(this.children,n)}else r=t.uid?this._removeChild(this.children,function(e){return!!e.uid&&e.uid===t.uid}):this._removeChild(this.children,function(e){return e===t});return r},List.prototype._forEach=function(t,r,n){var i=n,a=0,o=t.length;for(a=0;a<o&&r.call(i,t[a],a)!==e.$BREAK;a++);},List.prototype._removeChild=function(e,t){var r=this,n=[],i=[];return this._forEach(e,function(e,a){t.call(r,e)?n.push(e):i.push(e)}),this.children=i,n},List}();e.List=t}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdCb;!function(e){var t=function(t){function Collection(e){void 0===e&&(e=[]),t.call(this),this.children=e}return __extends(Collection,t),Collection.create=function(e){void 0===e&&(e=[]);var t=new this(e);return t},Collection.prototype.clone=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null;return 0===t.length?(i=!1,n=Collection.create()):1===t.length?e.JudgeUtils.isBoolean(t[0])?(n=Collection.create(),i=t[0]):(n=t[0],i=!1):(n=t[0],i=t[1]),i===!0?n.setChildren(e.ExtendUtils.extendDeep(this.children)):n.setChildren(e.ExtendUtils.extend([],this.children)),n},Collection.prototype.filter=function(e){for(var t=this.children,r=[],n=null,i=0,a=t.length;i<a;i++)n=t[i],e.call(t,n,i)&&r.push(n);return Collection.create(r)},Collection.prototype.findOne=function(t){var r=this.children,n=null;return this.forEach(function(i,a){if(t.call(r,i,a))return n=i,e.$BREAK}),n},Collection.prototype.reverse=function(){return Collection.create(this.copyChildren().reverse())},Collection.prototype.removeChild=function(e){return Collection.create(this.removeChildHelper(e))},Collection.prototype.sort=function(e,t){return void 0===t&&(t=!1),t?(this.children.sort(e),this):Collection.create(this.copyChildren().sort(e))},Collection.prototype.map=function(t){var r=[];return this.forEach(function(n,i){var a=t(n,i);a!==e.$REMOVE&&r.push(a)}),Collection.create(r)},Collection.prototype.removeRepeatItems=function(){var e=Collection.create();return this.forEach(function(t){e.hasChild(t)||e.addChild(t)}),e},Collection.prototype.hasRepeatItems=function(){var t=Collection.create(),r=!1;return this.forEach(function(n){return t.hasChild(n)?(r=!0,e.$BREAK):void t.addChild(n)}),r},Collection}(e.List);e.Collection=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function Hash(e){void 0===e&&(e={}),this._children=null,this._children=e}return Hash.create=function(e){void 0===e&&(e={});var t=new this(e);return t},Hash.prototype.getChildren=function(){return this._children},Hash.prototype.getCount=function(){var e=0,t=this._children,r=null;for(r in t)t.hasOwnProperty(r)&&e++;return e},Hash.prototype.getKeys=function(){var t=e.Collection.create(),r=this._children,n=null;for(n in r)r.hasOwnProperty(n)&&t.addChild(n);return t},Hash.prototype.getValues=function(){var t=e.Collection.create(),r=this._children,n=null;for(n in r)r.hasOwnProperty(n)&&t.addChild(r[n]);return t},Hash.prototype.getChild=function(e){return this._children[e]},Hash.prototype.setValue=function(e,t){return this._children[e]=t,this},Hash.prototype.addChild=function(e,t){return this._children[e]=t,this},Hash.prototype.addChildren=function(e){var t=null,r=null;r=e instanceof Hash?e.getChildren():e;for(t in r)r.hasOwnProperty(t)&&this.addChild(t,r[t]);return this},Hash.prototype.appendChild=function(t,r){if(this._children[t]instanceof e.Collection){var n=this._children[t];n.addChild(r)}else this._children[t]=e.Collection.create().addChild(r);return this},Hash.prototype.setChildren=function(e){this._children=e},Hash.prototype.removeChild=function(t){var r=[];if(e.JudgeUtils.isString(t)){var n=t;r.push(this._children[n]),this._children[n]=void 0,delete this._children[n]}else if(e.JudgeUtils.isFunction(t)){var i=t,a=this;this.forEach(function(e,t){i(e,t)&&(r.push(a._children[t]),a._children[t]=void 0,delete a._children[t])})}return e.Collection.create(r)},Hash.prototype.removeAllChildren=function(){this._children={}},Hash.prototype.hasChild=function(e){return void 0!==this._children[e]},Hash.prototype.hasChildWithFunc=function(t){var r=!1;return this.forEach(function(n,i){if(t(n,i))return r=!0,e.$BREAK}),r},Hash.prototype.forEach=function(t,r){var n=this._children;for(var i in n)if(n.hasOwnProperty(i)&&t.call(r,n[i],i)===e.$BREAK)break;return this},Hash.prototype.filter=function(e){var t={},r=this._children,n=null;for(var i in r)r.hasOwnProperty(i)&&(n=r[i],e.call(r,n,i)&&(t[i]=n));return Hash.create(t)},Hash.prototype.findOne=function(t){var r=[],n=this,i=this._children;return this.forEach(function(a,o){if(t.call(i,a,o))return r=[o,n.getChild(o)],e.$BREAK}),r},Hash.prototype.map=function(t){var r={};return this.forEach(function(n,i){var a=t(n,i);a!==e.$REMOVE&&(e.Log.error(!e.JudgeUtils.isArray(a)||2!==a.length,e.Log.info.FUNC_MUST_BE("iterator","[key, value]")),r[a[0]]=a[1])}),Hash.create(r)},Hash.prototype.toCollection=function(){var t=e.Collection.create();return this.forEach(function(r,n){r instanceof e.Collection?t.addChildren(r):t.addChild(r)}),t},Hash.prototype.toArray=function(){var t=[];return this.forEach(function(r,n){r instanceof e.Collection?t=t.concat(r.getChildren()):t.push(r)}),t},Hash.prototype.clone=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null;return 0===t.length?(i=!1,n=Hash.create()):1===t.length?e.JudgeUtils.isBoolean(t[0])?(n=Hash.create(),i=t[0]):(n=t[0],i=!1):(n=t[0],i=t[1]),i===!0?n.setChildren(e.ExtendUtils.extendDeep(this._children)):n.setChildren(e.ExtendUtils.extend({},this._children)),n},Hash}();e.Hash=t}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdCb;!function(e){var t=function(e){function Queue(t){void 0===t&&(t=[]),e.call(this),this.children=t}return __extends(Queue,e),Queue.create=function(e){void 0===e&&(e=[]);var t=new this(e);return t},Object.defineProperty(Queue.prototype,"front",{get:function(){return this.children[this.children.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"rear",{get:function(){return this.children[0]},enumerable:!0,configurable:!0}),Queue.prototype.push=function(e){this.children.unshift(e)},Queue.prototype.pop=function(){return this.children.pop()},Queue.prototype.clear=function(){this.removeAllChildren()},Queue}(e.List);e.Queue=t}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdCb;!function(e){var t=function(t){function Stack(e){void 0===e&&(e=[]),t.call(this),this.children=e}return __extends(Stack,t),Stack.create=function(e){void 0===e&&(e=[]);var t=new this(e);return t},Object.defineProperty(Stack.prototype,"top",{get:function(){return this.children[this.children.length-1]},enumerable:!0,configurable:!0}),Stack.prototype.push=function(e){this.children.push(e)},Stack.prototype.pop=function(){return this.children.pop()},Stack.prototype.clear=function(){this.removeAllChildren()},Stack.prototype.clone=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null;return 0===t.length?(i=!1,n=Stack.create()):1===t.length?e.JudgeUtils.isBoolean(t[0])?(n=Stack.create(),i=t[0]):(n=t[0],i=!1):(n=t[0],i=t[1]),i===!0?n.setChildren(e.ExtendUtils.extendDeep(this.children)):n.setChildren(e.ExtendUtils.extend([],this.children)),n},Stack.prototype.filter=function(t){for(var r=this.children,n=[],i=null,a=0,o=r.length;a<o;a++)i=r[a],t.call(r,i,a)&&n.push(i);return e.Collection.create(n)},Stack.prototype.findOne=function(t){var r=this.children,n=null;return this.forEach(function(i,a){if(t.call(r,i,a))return n=i,e.$BREAK}),n},Stack.prototype.reverse=function(){return e.Collection.create(this.copyChildren().reverse())},Stack.prototype.removeChild=function(t){return e.Collection.create(this.removeChildHelper(t))},Stack.prototype.sort=function(t,r){return void 0===r&&(r=!1),r?(this.children.sort(t),this):e.Collection.create(this.copyChildren().sort(t))},Stack.prototype.map=function(t){var r=[];return this.forEach(function(n,i){var a=t(n,i);a!==e.$REMOVE&&r.push(a)}),e.Collection.create(r)},Stack.prototype.removeRepeatItems=function(){var t=e.Collection.create();return this.forEach(function(e){t.hasChild(e)||t.addChild(e)}),t},Stack.prototype.hasRepeatItems=function(){var t=e.Collection.create(),r=!1;return this.forEach(function(n){return t.hasChild(n)?(r=!0,e.$BREAK):void t.addChild(n)}),r},Stack}(e.List);e.Stack=t}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var AjaxUtils=function(){function AjaxUtils(){}return AjaxUtils.ajax=function(conf){var type=conf.type,url=conf.url,data=conf.data,dataType=conf.dataType,success=conf.success,error=conf.error,xhr=null,self=this;if(null===type&&(type="get"),null===dataType&&(dataType="text"),xhr=this._createAjax(error))try{xhr.open(type,url,!0),this._isSoundFile(dataType)&&(xhr.responseType="arraybuffer"),"GET"===type||"get"===type?xhr.send(null):"POST"!==type&&"post"!==type||(xhr.setRequestHeader("content-type","application/x-www-form-urlencoded"),xhr.send(data)),xhr.onreadystatechange=function(){4!==xhr.readyState||200!==xhr.status&&!self._isLocalFile(xhr.status)||("text"===dataType||"TEXT"===dataType?null!==success&&success(xhr.responseText):"xml"===dataType||"XML"===dataType?null!==success&&success(xhr.responseXML):"json"===dataType||"JSON"===dataType?null!==success&&success(eval("("+xhr.responseText+")")):self._isSoundFile(dataType)&&null!==success&&success(xhr.response))}}catch(e){error(xhr,e)}},AjaxUtils._createAjax=function(e){var t=null;try{t=new ActiveXObject("microsoft.xmlhttp")}catch(r){try{t=new XMLHttpRequest}catch(r){return e(t,{message:"ajax"}),null}}return t},AjaxUtils._isLocalFile=function(e){return document.URL.contain("file://")&&0===e},AjaxUtils._isSoundFile=function(e){return"arraybuffer"===e},AjaxUtils}();wdCb.AjaxUtils=AjaxUtils}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function ArrayUtils(){}return ArrayUtils.removeRepeatItems=function(e,t){void 0===t&&(t=function(e,t){return e===t});var r=[],n=this;return e.forEach(function(e){n.contain(r,function(r){return t(r,e)})||r.push(e)}),r},ArrayUtils.contain=function(t,r){if(e.JudgeUtils.isFunction(r))for(var n=r,i=0,a=t.length;i<a;i++){var o=t[i];if(n.call(null,o,i))return!0}else for(var i=0,a=t.length;i<a;i++){var o=t[i];if(r===o||o.contain&&o.contain(r))return!0}return!1},ArrayUtils}();e.ArrayUtils=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function ConvertUtils(){}return ConvertUtils.toString=function(t){return e.JudgeUtils.isNumber(t)?String(t):e.JudgeUtils.isFunction(t)?this._convertCodeToString(t):e.JudgeUtils.isDirectObject(t)||e.JudgeUtils.isArray(t)?JSON.stringify(t):String(t)},ConvertUtils._convertCodeToString=function(e){return e.toString().split("\n").slice(1,-1).join("\n")+"\n"},ConvertUtils}();e.ConvertUtils=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function EventUtils(){}return EventUtils.bindEvent=function(e,t){return function(r){return t.call(e,r)}},EventUtils.addEvent=function(t,r,n){e.JudgeUtils.isHostMethod(t,"addEventListener")?t.addEventListener(r,n,!1):e.JudgeUtils.isHostMethod(t,"attachEvent")?t.attachEvent("on"+r,n):t["on"+r]=n},EventUtils.removeEvent=function(t,r,n){e.JudgeUtils.isHostMethod(t,"removeEventListener")?t.removeEventListener(r,n,!1):e.JudgeUtils.isHostMethod(t,"detachEvent")?t.detachEvent("on"+r,n):t["on"+r]=null},EventUtils}();e.EventUtils=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function ExtendUtils(){}return ExtendUtils.extendDeep=function(e,t,r){void 0===r&&(r=function(e,t){return!0});var n=null,i=0,a=Object.prototype.toString,o="[object Array]",s="[object Object]",c="",u=null;if(a.call(e)===o)for(u=t||[],n=0,i=e.length;n<i;n++){var l=e[n];r(l,n)&&(l.clone?u[n]=l.clone():(c=a.call(l),c===o||c===s?(u[n]=c===o?[]:{},arguments.callee(l,u[n])):u[n]=l))}else if(a.call(e)===s){u=t||{};for(n in e){var l=e[n];r(l,n)&&(l.clone?u[n]=l.clone():(c=a.call(l),c===o||c===s?(u[n]=c===o?[]:{},arguments.callee(l,u[n])):u[n]=l))}}else u=e;return u},ExtendUtils.extend=function(e,t){var r="";for(r in t)e[r]=t[r];return e},ExtendUtils.copyPublicAttri=function(t){var r={};return this.extendDeep(t,r,function(t,r){return"_"!==r.slice(0,1)&&!e.JudgeUtils.isFunction(t)}),r},ExtendUtils}();e.ExtendUtils=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,r=function(){function PathUtils(){}return PathUtils.basename=function(e,t){var r=this._splitPath(e)[2];return t&&r.substr(-1*t.length)===t&&(r=r.substr(0,r.length-t.length)),r},PathUtils.changeExtname=function(e,t){var t=t||"",r=e.indexOf("?"),n="";return r>0&&(n=e.substring(r),e=e.substring(0,r)),r=e.lastIndexOf("."),r<0?e+t+n:e.substring(0,r)+t+n},PathUtils.changeBasename=function(e,t,r){void 0===r&&(r=!1);var n=null,i=null,a=null;return 0==t.indexOf(".")?this.changeExtname(e,t):(n=e.indexOf("?"),i="",a=r?this.extname(e):"",n>0&&(i=e.substring(n),e=e.substring(0,n)),n=e.lastIndexOf("/"),n=n<=0?0:n+1,e.substring(0,n)+t+a+i)},PathUtils.extname=function(e){return this._splitPath(e)[3]},PathUtils.dirname=function(e){var t=this._splitPath(e),r=t[0],n=t[1];return r||n?(n&&(n=n.substr(0,n.length-1)),r+n):"."},PathUtils._splitPath=function(e){return t.exec(e).slice(1)},PathUtils}();e.PathUtils=r}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function FunctionUtils(){}return FunctionUtils.bind=function(e,t){return function(){return t.apply(e,arguments)}},FunctionUtils}();e.FunctionUtils=t}(wdCb||(wdCb={}));var wdCb;!function(e){var t=function(){function DomQuery(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];return this._doms=null,e.JudgeUtils.isDom(t[0])?this._doms=[t[0]]:this._isDomEleStr(t[0])?this._doms=[this._buildDom(t[0])]:this._doms=document.querySelectorAll(t[0]),this}return DomQuery.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=new this(e[0]);return r},DomQuery.prototype.get=function(e){return this._doms[e]},DomQuery.prototype.prepend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;r=this._buildDom(e[0]);for(var n=0,i=this._doms;n<i.length;n++){var a=i[n];1===a.nodeType&&a.insertBefore(r,a.firstChild)}return this},DomQuery.prototype.prependTo=function(e){var t=null;t=DomQuery.create(e);for(var r=0,n=this._doms;r<n.length;r++){var i=n[r];1===i.nodeType&&t.prepend(i)}return this},DomQuery.prototype.remove=function(){for(var e=0,t=this._doms;e<t.length;e++){var r=t[e];r&&r.parentNode&&"BODY"!=r.tagName&&r.parentNode.removeChild(r)}return this},DomQuery.prototype.css=function(e,t){for(var r=0,n=this._doms;r<n.length;r++){var i=n[r];i.style[e]=t}},DomQuery.prototype.attr=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(1===e.length){var r=e[0];return this.get(0).getAttribute(r)}for(var n=e[0],i=e[1],a=0,o=this._doms;a<o.length;a++){var s=o[a];s.setAttribute(n,i)}},DomQuery.prototype._isDomEleStr=function(e){return null!==e.match(/<(\w+)[^>]*><\/\1>/)},DomQuery.prototype._buildDom=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(e.JudgeUtils.isString(t[0])){var n=this._createElement("div"),i=t[0];return n.innerHTML=i,n.firstChild}return t[0]},DomQuery.prototype._createElement=function(e){return document.createElement(e)},DomQuery}();e.DomQuery=t}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function JudgeUtils(){e.apply(this,arguments)}return __extends(JudgeUtils,e),JudgeUtils.isPromise=function(t){return!!t&&!e.isFunction.call(this,t.subscribe)&&e.isFunction.call(this,t.then)},JudgeUtils.isEqual=function(e,t){return e.uid===t.uid},JudgeUtils.isIObserver=function(e){return e.next&&e.error&&e.completed},JudgeUtils}(wdCb.JudgeUtils);e.JudgeUtils=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){e.fromNodeCallback=function(t,r){return function(){for(var n=[],i=0;i<arguments.length;i++)n[i-0]=arguments[i];return e.createStream(function(e){var i=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];return t?void e.error(t):(r.length<=1?e.next.apply(e,r):e.next(r),void e.completed())};n.push(i),t.apply(r,n)})}},e.fromStream=function(t,r){return void 0===r&&(r="end"),t.pause&&t.pause(),e.createStream(function(e){var n=function(t){e.next(t)},i=function(t){e.error(t)},a=function(){e.completed()};return t.addListener("data",n),t.addListener("error",i),t.addListener(r,a),t.resume&&t.resume(),function(){t.removeListener("data",n),t.removeListener("error",i),t.removeListener(r,a)}})},e.fromReadableStream=function(t){return e.fromStream(t,"end")},e.fromWritableStream=function(t){return e.fromStream(t,"finish")},e.fromTransformStream=function(t){return e.fromStream(t,"finish")}}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function Entity(e){this._uid=null,this._uid=e+String(Entity.UID++)}return Object.defineProperty(Entity.prototype,"uid",{get:function(){return this._uid},set:function(e){this._uid=e},enumerable:!0,configurable:!0}),Entity.UID=1,Entity}();e.Entity=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function Main(){}return Main.isTest=!1,Main}();e.Main=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){function assert(e,r){void 0===r&&(r="contract error"),t.error(!e,r)}function require(t){return function(r,n,i){var a=i.value;return i.value=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];return e.Main.isTest&&t.apply(this,r),a.apply(this,r)},i}}function ensure(t){return function(r,n,i){var a=i.value;return i.value=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];var i=a.apply(this,r),o=[i].concat(r);return e.Main.isTest&&t.apply(this,o),i},i}}function requireGetter(t){return function(r,n,i){var a=i.get;return i.get=function(){return e.Main.isTest&&t.call(this),a.call(this)},i}}function requireSetter(t){return function(r,n,i){var a=i.set;return i.set=function(r){e.Main.isTest&&t.call(this,r),a.call(this,r)},i}}function ensureGetter(t){return function(r,n,i){var a=i.get;return i.get=function(){var r=a.call(this);return e.Main.isTest&&t.call(this,r),r},i}}function ensureSetter(t){return function(r,n,i){var a=i.set;return i.set=function(r){var n=a.call(this,r),i=[n,r];e.Main.isTest&&t.apply(this,i)},i}}function invariant(t){return function(r){e.Main.isTest&&t(r)}}var t=wdCb.Log;e.assert=assert,e.require=require,e.ensure=ensure,e.requireGetter=requireGetter,e.requireSetter=requireSetter,e.ensureGetter=ensureGetter,e.ensureSetter=ensureSetter,e.invariant=invariant}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function SingleDisposable(t){e.call(this,"SingleDisposable"),this._disposeHandler=null,this._disposeHandler=t}return __extends(SingleDisposable,e),SingleDisposable.create=function(e){void 0===e&&(e=function(){});var t=new this(e);return t},SingleDisposable.prototype.setDisposeHandler=function(e){this._disposeHandler=e},SingleDisposable.prototype.dispose=function(){this._disposeHandler()},SingleDisposable}(e.Entity);e.SingleDisposable=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function GroupDisposable(t){e.call(this,"GroupDisposable"),this._group=wdCb.Collection.create(),t&&this._group.addChild(t)}return __extends(GroupDisposable,e),GroupDisposable.create=function(e){var t=new this(e);return t},GroupDisposable.prototype.add=function(e){return this._group.addChild(e),this},GroupDisposable.prototype.remove=function(e){return this._group.removeChild(e),this},GroupDisposable.prototype.dispose=function(){this._group.forEach(function(e){e.dispose()})},GroupDisposable}(e.Entity);e.GroupDisposable=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function InnerSubscription(e,t){this._subject=null,this._observer=null,this._subject=e,this._observer=t}return InnerSubscription.create=function(e,t){var r=new this(e,t);return r},InnerSubscription.prototype.dispose=function(){this._subject.remove(this._observer),this._observer.dispose()},InnerSubscription}();e.InnerSubscription=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function InnerSubscriptionGroup(){this._container=wdCb.Collection.create()}return InnerSubscriptionGroup.create=function(){var e=new this;return e},InnerSubscriptionGroup.prototype.addChild=function(e){this._container.addChild(e)},InnerSubscriptionGroup.prototype.dispose=function(){this._container.forEach(function(e){e.dispose()})},InnerSubscriptionGroup}();e.InnerSubscriptionGroup=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){e.JudgeUtils.isNodeJs()?e.root=global:e.root=window}(wdFrp||(wdFrp={}));var wdFrp;!function(e){e.root.RSVP&&(e.root.RSVP.onerror=function(e){throw e},e.root.RSVP.on("error",e.root.RSVP.onerror))}(wdFrp||(wdFrp={}));var wdFrp;!function(e){e.root.requestNextAnimationFrame=function(){var t=void 0,r=void 0,n=null,i=e.root.navigator&&e.root.navigator.userAgent,a=0,o=this;return r=function(t){t=e.root.performance.now(),o.callback(t)},e.root.requestAnimationFrame?requestAnimationFrame:(e.root.webkitRequestAnimationFrame&&(t=e.root.webkitRequestAnimationFrame,e.root.webkitRequestAnimationFrame=function(e,n){return o.callback=e,t(r,n)}),e.root.msRequestAnimationFrame&&(t=e.root.msRequestAnimationFrame,e.root.msRequestAnimationFrame=function(e){return o.callback=e,t(r)}),e.root.mozRequestAnimationFrame&&(a=i.indexOf("rv:"),i.indexOf("Gecko")!=-1&&(n=i.substr(a+3,3),"2.0"===n&&(e.root.mozRequestAnimationFrame=void 0))),e.root.webkitRequestAnimationFrame||e.root.mozRequestAnimationFrame||e.root.oRequestAnimationFrame||e.root.msRequestAnimationFrame||function(t,r){var n,i;e.root.setTimeout(function(){n=e.root.performance.now(),t(n),i=e.root.performance.now(),o.timeout=1e3/60-(i-n)},o.timeout)})}(),e.root.cancelNextRequestAnimationFrame=e.root.cancelRequestAnimationFrame||e.root.webkitCancelAnimationFrame||e.root.webkitCancelRequestAnimationFrame||e.root.mozCancelRequestAnimationFrame||e.root.oCancelRequestAnimationFrame||e.root.msCancelRequestAnimationFrame||clearTimeout}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},__decorate=this&&this.__decorate||function(e,t,r,n){var i,a=arguments.length,o=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,r,o):i(t,r))||o);return a>3&&o&&Object.defineProperty(t,r,o),o},wdFrp;!function(e){var t=wdCb.Log,r=function(r){function Stream(e){r.call(this,"Stream"),this.scheduler=null,this.subscribeFunc=null,this.subscribeFunc=e||function(){}}return __extends(Stream,r),Stream.prototype.buildStream=function(t){return e.SingleDisposable.create(this.subscribeFunc(t)||function(){})},Stream.prototype.do=function(t,r,n){return e.DoStream.create(this,t,r,n)},Stream.prototype.map=function(t){return e.MapStream.create(this,t)},Stream.prototype.flatMap=function(e){return this.map(e).mergeAll()},Stream.prototype.concatMap=function(e){return this.map(e).concatAll()},Stream.prototype.mergeAll=function(){return e.MergeAllStream.create(this)},Stream.prototype.concatAll=function(){return this.merge(1)},Stream.prototype.takeUntil=function(t){return e.TakeUntilStream.create(this,t)},Stream.prototype.take=function(t){void 0===t&&(t=1);var r=this;return 0===t?e.empty():e.createStream(function(e){r.subscribe(function(r){t>0&&e.next(r),t--,t<=0&&e.completed()},function(t){e.error(t)},function(){e.completed()})})},Stream.prototype.takeLast=function(t){void 0===t&&(t=1);var r=this;return 0===t?e.empty():e.createStream(function(e){var n=[];r.subscribe(function(e){n.push(e),n.length>t&&n.shift()},function(t){e.error(t)},function(){for(;n.length>0;)e.next(n.shift());e.completed()})})},Stream.prototype.takeWhile=function(t,r){void 0===r&&(r=this);var n=this,i=null;return i=wdCb.FunctionUtils.bind(r,t),e.createStream(function(e){var t=0,r=!1;n.subscribe(function(a){if(i(a,t++,n))try{e.next(a),r=!0}catch(t){return void e.error(t)}else r&&e.completed()},function(t){e.error(t)},function(){e.completed()})})},Stream.prototype.lastOrDefault=function(t){void 0===t&&(t=null);var r=this;return e.createStream(function(e){var n=[];r.subscribe(function(e){n.push(e),n.length>1&&n.shift()},function(t){e.error(t)},function(){if(0===n.length)e.next(t);else for(;n.length>0;)e.next(n.shift());e.completed()})})},Stream.prototype.filter=function(t,r){if(void 0===r&&(r=this),this instanceof e.FilterStream){var n=this;return n.internalFilter(t,r)}return e.FilterStream.create(this,t,r)},Stream.prototype.filterWithState=function(t,r){if(void 0===r&&(r=this),this instanceof e.FilterStream){var n=this;return n.internalFilter(t,r)}return e.FilterWithStateStream.create(this,t,r)},Stream.prototype.concat=function(){var t=null;return t=e.JudgeUtils.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments,0),t.unshift(this),e.ConcatStream.create(t)},Stream.prototype.merge=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(e.JudgeUtils.isNumber(t[0])){var n=t[0];return e.MergeStream.create(this,n)}e.JudgeUtils.isArray(t[0])&&(t=arguments[0]);var i=null;return t.unshift(this),i=e.fromArray(t).mergeAll()},Stream.prototype.repeat=function(t){return void 0===t&&(t=-1),e.RepeatStream.create(this,t)},Stream.prototype.ignoreElements=function(){return e.IgnoreElementsStream.create(this)},Stream.prototype.handleSubject=function(e){return!!this._isSubject(e)&&(this._setSubject(e),!0)},Stream.prototype._isSubject=function(t){return t instanceof e.Subject},Stream.prototype._setSubject=function(e){e.source=this},__decorate([e.require(function(r){void 0===r&&(r=1),e.assert(r>=0,t.info.FUNC_SHOULD("count",">= 0"))})],Stream.prototype,"take",null),__decorate([e.require(function(r){void 0===r&&(r=1),e.assert(r>=0,t.info.FUNC_SHOULD("count",">= 0"))})],Stream.prototype,"takeLast",null),
Stream}(e.Entity);e.Stream=r}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function Scheduler(){this._requestLoopId=null}return Scheduler.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=new this;return r},Object.defineProperty(Scheduler.prototype,"requestLoopId",{get:function(){return this._requestLoopId},set:function(e){this._requestLoopId=e},enumerable:!0,configurable:!0}),Scheduler.prototype.publishRecursive=function(e,t,r){r(t)},Scheduler.prototype.publishInterval=function(t,r,n,i){return e.root.setInterval(function(){r=i(r)},n)},Scheduler.prototype.publishIntervalRequest=function(t,r){var n=this,i=function(t){var a=r(t);a||(n._requestLoopId=e.root.requestNextAnimationFrame(i))};this._requestLoopId=e.root.requestNextAnimationFrame(i)},Scheduler.prototype.publishTimeout=function(t,r,n){return e.root.setTimeout(function(){n(r),t.completed()},r)},Scheduler}();e.Scheduler=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function Observer(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(e.call(this,"Observer"),this._isDisposed=null,this.onUserNext=null,this.onUserError=null,this.onUserCompleted=null,this._isStop=!1,this._disposable=null,1===t.length){var n=t[0];this.onUserNext=function(e){n.next(e)},this.onUserError=function(e){n.error(e)},this.onUserCompleted=function(){n.completed()}}else{var i=t[0],a=t[1],o=t[2];this.onUserNext=i||function(e){},this.onUserError=a||function(e){throw e},this.onUserCompleted=o||function(){}}}return __extends(Observer,e),Object.defineProperty(Observer.prototype,"isDisposed",{get:function(){return this._isDisposed},set:function(e){this._isDisposed=e},enumerable:!0,configurable:!0}),Observer.prototype.next=function(e){if(!this._isStop)return this.onNext(e)},Observer.prototype.error=function(e){this._isStop||(this._isStop=!0,this.onError(e))},Observer.prototype.completed=function(){this._isStop||(this._isStop=!0,this.onCompleted())},Observer.prototype.dispose=function(){this._isStop=!0,this._isDisposed=!0,this._disposable&&this._disposable.dispose()},Observer.prototype.setDisposable=function(e){this._disposable=e},Observer}(e.Entity);e.Observer=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function Subject(){this._source=null,this._observer=new e.SubjectObserver}return Subject.create=function(){var e=new this;return e},Object.defineProperty(Subject.prototype,"source",{get:function(){return this._source},set:function(e){this._source=e},enumerable:!0,configurable:!0}),Subject.prototype.subscribe=function(t,r,n){var i=t instanceof e.Observer?t:e.AutoDetachObserver.create(t,r,n);return this._observer.addChild(i),e.InnerSubscription.create(this,i)},Subject.prototype.next=function(e){this._observer.next(e)},Subject.prototype.error=function(e){this._observer.error(e)},Subject.prototype.completed=function(){this._observer.completed()},Subject.prototype.start=function(){this._source&&this._observer.setDisposable(this._source.buildStream(this))},Subject.prototype.remove=function(e){this._observer.removeChild(e)},Subject.prototype.dispose=function(){this._observer.dispose()},Subject}();e.Subject=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function GeneratorSubject(){t.call(this,"GeneratorSubject"),this._isStart=!1,this.observer=new e.SubjectObserver}return __extends(GeneratorSubject,t),GeneratorSubject.create=function(){var e=new this;return e},Object.defineProperty(GeneratorSubject.prototype,"isStart",{get:function(){return this._isStart},set:function(e){this._isStart=e},enumerable:!0,configurable:!0}),GeneratorSubject.prototype.onBeforeNext=function(e){},GeneratorSubject.prototype.onAfterNext=function(e){},GeneratorSubject.prototype.onIsCompleted=function(e){return!1},GeneratorSubject.prototype.onBeforeError=function(e){},GeneratorSubject.prototype.onAfterError=function(e){},GeneratorSubject.prototype.onBeforeCompleted=function(){},GeneratorSubject.prototype.onAfterCompleted=function(){},GeneratorSubject.prototype.subscribe=function(t,r,n){var i=t instanceof e.Observer?t:e.AutoDetachObserver.create(t,r,n);return this.observer.addChild(i),e.InnerSubscription.create(this,i)},GeneratorSubject.prototype.next=function(e){if(this._isStart&&!this.observer.isEmpty())try{this.onBeforeNext(e),this.observer.next(e),this.onAfterNext(e),this.onIsCompleted(e)&&this.completed()}catch(e){this.error(e)}},GeneratorSubject.prototype.error=function(e){this._isStart&&!this.observer.isEmpty()&&(this.onBeforeError(e),this.observer.error(e),this.onAfterError(e))},GeneratorSubject.prototype.completed=function(){this._isStart&&!this.observer.isEmpty()&&(this.onBeforeCompleted(),this.observer.completed(),this.onAfterCompleted())},GeneratorSubject.prototype.toStream=function(){var t=this,r=null;return r=e.AnonymousStream.create(function(e){t.subscribe(e)})},GeneratorSubject.prototype.start=function(){var t=this;this._isStart=!0,this.observer.setDisposable(e.SingleDisposable.create(function(){t.dispose()}))},GeneratorSubject.prototype.stop=function(){this._isStart=!1},GeneratorSubject.prototype.remove=function(e){this.observer.removeChild(e)},GeneratorSubject.prototype.dispose=function(){this.observer.dispose()},GeneratorSubject}(e.Entity);e.GeneratorSubject=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function AnonymousObserver(){e.apply(this,arguments)}return __extends(AnonymousObserver,e),AnonymousObserver.create=function(e,t,r){return new this(e,t,r)},AnonymousObserver.prototype.onNext=function(e){this.onUserNext(e)},AnonymousObserver.prototype.onError=function(e){this.onUserError(e)},AnonymousObserver.prototype.onCompleted=function(){this.onUserCompleted()},AnonymousObserver}(e.Observer);e.AnonymousObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function AutoDetachObserver(){e.apply(this,arguments)}return __extends(AutoDetachObserver,e),AutoDetachObserver.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return 1===e.length?new this(e[0]):new this(e[0],e[1],e[2])},AutoDetachObserver.prototype.dispose=function(){return this.isDisposed?void wdCb.Log.log("only can dispose once"):void e.prototype.dispose.call(this)},AutoDetachObserver.prototype.onNext=function(e){try{this.onUserNext(e)}catch(e){this.onError(e)}},AutoDetachObserver.prototype.onError=function(e){try{this.onUserError(e)}catch(e){throw e}finally{this.dispose()}},AutoDetachObserver.prototype.onCompleted=function(){try{this.onUserCompleted(),this.dispose()}catch(e){throw e}},AutoDetachObserver}(e.Observer);e.AutoDetachObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function MapObserver(t,r){e.call(this,null,null,null),this._currentObserver=null,this._selector=null,this._currentObserver=t,this._selector=r}return __extends(MapObserver,e),MapObserver.create=function(e,t){return new this(e,t)},MapObserver.prototype.onNext=function(e){var t=null;try{t=this._selector(e)}catch(e){this._currentObserver.error(e)}finally{this._currentObserver.next(t)}},MapObserver.prototype.onError=function(e){this._currentObserver.error(e)},MapObserver.prototype.onCompleted=function(){this._currentObserver.completed()},MapObserver}(e.Observer);e.MapObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function DoObserver(t,r){e.call(this,null,null,null),this._currentObserver=null,this._prevObserver=null,this._currentObserver=t,this._prevObserver=r}return __extends(DoObserver,e),DoObserver.create=function(e,t){return new this(e,t)},DoObserver.prototype.onNext=function(e){try{this._prevObserver.next(e)}catch(e){this._prevObserver.error(e),this._currentObserver.error(e)}finally{this._currentObserver.next(e)}},DoObserver.prototype.onError=function(e){try{this._prevObserver.error(e)}catch(e){}finally{this._currentObserver.error(e)}},DoObserver.prototype.onCompleted=function(){try{this._prevObserver.completed()}catch(e){this._prevObserver.error(e),this._currentObserver.error(e)}finally{this._currentObserver.completed()}},DoObserver}(e.Observer);e.DoObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},__decorate=this&&this.__decorate||function(e,t,r,n){var i,a=arguments.length,o=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,r,o):i(t,r))||o);return a>3&&o&&Object.defineProperty(t,r,o),o},wdFrp;!function(e){var t=wdCb.Log,r=function(r){function MergeAllObserver(e,t,n){r.call(this,null,null,null),this.done=!1,this.currentObserver=null,this._streamGroup=null,this._groupDisposable=null,this.currentObserver=e,this._streamGroup=t,this._groupDisposable=n}return __extends(MergeAllObserver,r),MergeAllObserver.create=function(e,t,r){return new this(e,t,r)},MergeAllObserver.prototype.onNext=function(t){e.JudgeUtils.isPromise(t)&&(t=e.fromPromise(t)),this._streamGroup.addChild(t),this._groupDisposable.add(t.buildStream(n.create(this,this._streamGroup,t)))},MergeAllObserver.prototype.onError=function(e){this.currentObserver.error(e)},MergeAllObserver.prototype.onCompleted=function(){this.done=!0,0===this._streamGroup.getCount()&&this.currentObserver.completed()},__decorate([e.require(function(r){e.assert(r instanceof e.Stream||e.JudgeUtils.isPromise(r),t.info.FUNC_MUST_BE("innerSource","Stream or Promise"))})],MergeAllObserver.prototype,"onNext",null),MergeAllObserver}(e.Observer);e.MergeAllObserver=r;var n=function(t){function InnerObserver(e,r,n){t.call(this,null,null,null),this._parent=null,this._streamGroup=null,this._currentStream=null,this._parent=e,this._streamGroup=r,this._currentStream=n}return __extends(InnerObserver,t),InnerObserver.create=function(e,t,r){var n=new this(e,t,r);return n},InnerObserver.prototype.onNext=function(e){this._parent.currentObserver.next(e)},InnerObserver.prototype.onError=function(e){this._parent.currentObserver.error(e)},InnerObserver.prototype.onCompleted=function(){var t=this._currentStream,r=this._parent;this._streamGroup.removeChild(function(r){return e.JudgeUtils.isEqual(r,t)}),this._isAsync()&&0===this._streamGroup.getCount()&&r.currentObserver.completed()},InnerObserver.prototype._isAsync=function(){return this._parent.done},InnerObserver}(e.Observer)}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},__decorate=this&&this.__decorate||function(e,t,r,n){var i,a=arguments.length,o=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,r,o):i(t,r))||o);return a>3&&o&&Object.defineProperty(t,r,o),o},wdFrp;!function(e){var t=wdCb.Log,r=function(r){function MergeObserver(e,t,n,i){r.call(this,null,null,null),this.done=!1,this.currentObserver=null,this.activeCount=0,this.q=[],this._maxConcurrent=null,this._groupDisposable=null,this._streamGroup=null,this.currentObserver=e,this._maxConcurrent=t,this._streamGroup=n,this._groupDisposable=i}return __extends(MergeObserver,r),MergeObserver.create=function(e,t,r,n){return new this(e,t,r,n)},MergeObserver.prototype.handleSubscribe=function(t){e.JudgeUtils.isPromise(t)&&(t=e.fromPromise(t)),this._streamGroup.addChild(t),this._groupDisposable.add(t.buildStream(n.create(this,this._streamGroup,t)))},MergeObserver.prototype.onNext=function(e){return this._isReachMaxConcurrent()?(this.activeCount++,void this.handleSubscribe(e)):void this.q.push(e)},MergeObserver.prototype.onError=function(e){this.currentObserver.error(e)},MergeObserver.prototype.onCompleted=function(){this.done=!0,0===this._streamGroup.getCount()&&this.currentObserver.completed()},MergeObserver.prototype._isReachMaxConcurrent=function(){return this.activeCount<this._maxConcurrent},__decorate([e.require(function(r){e.assert(r instanceof e.Stream||e.JudgeUtils.isPromise(r),t.info.FUNC_MUST_BE("innerSource","Stream or Promise"))})],MergeObserver.prototype,"onNext",null),MergeObserver}(e.Observer);e.MergeObserver=r;var n=function(e){function InnerObserver(t,r,n){e.call(this,null,null,null),this._parent=null,this._streamGroup=null,this._currentStream=null,this._parent=t,this._streamGroup=r,this._currentStream=n}return __extends(InnerObserver,e),InnerObserver.create=function(e,t,r){var n=new this(e,t,r);return n},InnerObserver.prototype.onNext=function(e){this._parent.currentObserver.next(e)},InnerObserver.prototype.onError=function(e){this._parent.currentObserver.error(e)},InnerObserver.prototype.onCompleted=function(){var e=this._parent;this._streamGroup.removeChild(this._currentStream),e.q.length>0?(e.activeCount=0,e.handleSubscribe(e.q.shift())):this._isAsync()&&0===this._streamGroup.getCount()&&e.currentObserver.completed()},InnerObserver.prototype._isAsync=function(){return this._parent.done},InnerObserver}(e.Observer)}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function TakeUntilObserver(t){e.call(this,null,null,null),this._prevObserver=null,this._prevObserver=t}return __extends(TakeUntilObserver,e),TakeUntilObserver.create=function(e){return new this(e)},TakeUntilObserver.prototype.onNext=function(e){this._prevObserver.completed()},TakeUntilObserver.prototype.onError=function(e){this._prevObserver.error(e)},TakeUntilObserver.prototype.onCompleted=function(){},TakeUntilObserver}(e.Observer);e.TakeUntilObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function ConcatObserver(t,r){e.call(this,null,null,null),this.currentObserver=null,this._startNextStream=null,this.currentObserver=t,this._startNextStream=r}return __extends(ConcatObserver,e),ConcatObserver.create=function(e,t){return new this(e,t)},ConcatObserver.prototype.onNext=function(e){this.currentObserver.next(e)},ConcatObserver.prototype.onError=function(e){this.currentObserver.error(e)},ConcatObserver.prototype.onCompleted=function(){this._startNextStream()},ConcatObserver}(e.Observer);e.ConcatObserver=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function SubjectObserver(){this.observers=wdCb.Collection.create(),this._disposable=null}return SubjectObserver.prototype.isEmpty=function(){return 0===this.observers.getCount()},SubjectObserver.prototype.next=function(e){this.observers.forEach(function(t){t.next(e)})},SubjectObserver.prototype.error=function(e){this.observers.forEach(function(t){t.error(e)})},SubjectObserver.prototype.completed=function(){this.observers.forEach(function(e){e.completed()})},SubjectObserver.prototype.addChild=function(e){this.observers.addChild(e),e.setDisposable(this._disposable)},SubjectObserver.prototype.removeChild=function(t){this.observers.removeChild(function(r){return e.JudgeUtils.isEqual(r,t)})},SubjectObserver.prototype.dispose=function(){this.observers.forEach(function(e){e.dispose()}),this.observers.removeAllChildren()},SubjectObserver.prototype.setDisposable=function(e){this.observers.forEach(function(t){t.setDisposable(e)}),this._disposable=e},SubjectObserver}();e.SubjectObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function IgnoreElementsObserver(t){e.call(this,null,null,null),this._currentObserver=null,this._currentObserver=t}return __extends(IgnoreElementsObserver,e),IgnoreElementsObserver.create=function(e){return new this(e)},IgnoreElementsObserver.prototype.onNext=function(e){},IgnoreElementsObserver.prototype.onError=function(e){this._currentObserver.error(e)},IgnoreElementsObserver.prototype.onCompleted=function(){this._currentObserver.completed()},IgnoreElementsObserver}(e.Observer);e.IgnoreElementsObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(e){function FilterObserver(t,r,n){e.call(this,null,null,null),this.prevObserver=null,this.source=null,this.i=0,this.predicate=null,this.prevObserver=t,this.predicate=r,this.source=n}return __extends(FilterObserver,e),FilterObserver.create=function(e,t,r){return new this(e,t,r)},FilterObserver.prototype.onNext=function(e){try{this.predicate(e,this.i++,this.source)&&this.prevObserver.next(e)}catch(e){this.prevObserver.error(e)}},FilterObserver.prototype.onError=function(e){this.prevObserver.error(e)},FilterObserver.prototype.onCompleted=function(){this.prevObserver.completed()},FilterObserver}(e.Observer);e.FilterObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function FilterWithStateObserver(){t.apply(this,arguments),this._isTrigger=!1}return __extends(FilterWithStateObserver,t),FilterWithStateObserver.create=function(e,t,r){return new this(e,t,r)},FilterWithStateObserver.prototype.onNext=function(t){var r=null;try{this.predicate(t,this.i++,this.source)?(r=this._isTrigger?{value:t,state:e.FilterState.TRIGGER}:{value:t,state:e.FilterState.ENTER},this.prevObserver.next(r),this._isTrigger=!0):(this._isTrigger&&(r={value:t,state:e.FilterState.LEAVE},this.prevObserver.next(r)),this._isTrigger=!1)}catch(e){this.prevObserver.error(e)}},FilterWithStateObserver}(e.FilterObserver);e.FilterWithStateObserver=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function BaseStream(){t.apply(this,arguments)}return __extends(BaseStream,t),BaseStream.prototype.subscribe=function(t,r,n){var i=null;if(!this.handleSubject(t))return i=t instanceof e.Observer?e.AutoDetachObserver.create(t):e.AutoDetachObserver.create(t,r,n),i.setDisposable(this.buildStream(i)),i},BaseStream.prototype.buildStream=function(e){return t.prototype.buildStream.call(this,e),this.subscribeCore(e)},BaseStream}(e.Stream);e.BaseStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function DoStream(r,n,i,a){t.call(this,null),this._source=null,this._observer=null,this._source=r,this._observer=e.AnonymousObserver.create(n,i,a),this.scheduler=this._source.scheduler}return __extends(DoStream,t),DoStream.create=function(e,t,r,n){var i=new this(e,t,r,n);return i},DoStream.prototype.subscribeCore=function(t){return this._source.buildStream(e.DoObserver.create(t,this._observer))},DoStream}(e.BaseStream);e.DoStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function MapStream(e,r){t.call(this,null),this._source=null,this._selector=null,this._source=e,this.scheduler=this._source.scheduler,this._selector=r}return __extends(MapStream,t),MapStream.create=function(e,t){var r=new this(e,t);return r},MapStream.prototype.subscribeCore=function(t){return this._source.buildStream(e.MapObserver.create(t,this._selector))},MapStream}(e.BaseStream);e.MapStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function FromArrayStream(e,r){t.call(this,null),this._array=null,this._array=e,this.scheduler=r}return __extends(FromArrayStream,t),FromArrayStream.create=function(e,t){var r=new this(e,t);return r},FromArrayStream.prototype.subscribeCore=function(t){function loopRecursive(e){e<n?(t.next(r[e]),arguments.callee(e+1)):t.completed()}var r=this._array,n=r.length;return this.scheduler.publishRecursive(t,0,loopRecursive),e.SingleDisposable.create()},FromArrayStream}(e.BaseStream);e.FromArrayStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function FromPromiseStream(e,r){t.call(this,null),this._promise=null,this._promise=e,this.scheduler=r}return __extends(FromPromiseStream,t),FromPromiseStream.create=function(e,t){var r=new this(e,t);return r},FromPromiseStream.prototype.subscribeCore=function(t){return this._promise.then(function(e){t.next(e),t.completed()},function(e){t.error(e)},t),e.SingleDisposable.create()},FromPromiseStream}(e.BaseStream);e.FromPromiseStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function FromEventPatternStream(e,r){t.call(this,null),this._addHandler=null,this._removeHandler=null,this._addHandler=e,this._removeHandler=r}return __extends(FromEventPatternStream,t),FromEventPatternStream.create=function(e,t){var r=new this(e,t);return r},FromEventPatternStream.prototype.subscribeCore=function(t){function innerHandler(e){t.next(e)}var r=this;return this._addHandler(innerHandler),e.SingleDisposable.create(function(){r._removeHandler(innerHandler)})},FromEventPatternStream}(e.BaseStream);e.FromEventPatternStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function AnonymousStream(r){t.call(this,r),this.scheduler=e.Scheduler.create()}return __extends(AnonymousStream,t),AnonymousStream.create=function(e){var t=new this(e);return t},AnonymousStream.prototype.subscribe=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;if(t[0]instanceof e.Subject){var i=t[0];return void this.handleSubject(i)}if(e.JudgeUtils.isIObserver(t[0]))n=e.AutoDetachObserver.create(t[0]);else{var a=t[0],o=t[1]||null,s=t[2]||null;n=e.AutoDetachObserver.create(a,o,s)}return n.setDisposable(this.buildStream(n)),n},AnonymousStream}(e.Stream);e.AnonymousStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function IntervalStream(e,r){t.call(this,null),this._interval=null,this._interval=e,this.scheduler=r}return __extends(IntervalStream,t),IntervalStream.create=function(e,t){var r=new this(e,t);return r.initWhenCreate(),r},IntervalStream.prototype.initWhenCreate=function(){this._interval=this._interval<=0?1:this._interval},IntervalStream.prototype.subscribeCore=function(t){var r=null;return r=this.scheduler.publishInterval(t,0,this._interval,function(e){return t.next(e),e+1}),e.SingleDisposable.create(function(){e.root.clearInterval(r)})},IntervalStream}(e.BaseStream);e.IntervalStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function IntervalRequestStream(e){t.call(this,null),this._isEnd=!1,this.scheduler=e}return __extends(IntervalRequestStream,t),IntervalRequestStream.create=function(e){var t=new this(e);return t},IntervalRequestStream.prototype.subscribeCore=function(t){var r=this;return this.scheduler.publishIntervalRequest(t,function(e){return t.next(e),r._isEnd}),e.SingleDisposable.create(function(){e.root.cancelNextRequestAnimationFrame(r.scheduler.requestLoopId),r._isEnd=!0})},IntervalRequestStream}(e.BaseStream);e.IntervalRequestStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},__decorate=this&&this.__decorate||function(e,t,r,n){var i,a=arguments.length,o=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,r,o):i(t,r))||o);return a>3&&o&&Object.defineProperty(t,r,o),o},wdFrp;!function(e){var t=wdCb.Log,r=function(r){function TimeoutStream(e,t){r.call(this,null),this._time=null,this._time=e,this.scheduler=t}return __extends(TimeoutStream,r),TimeoutStream.create=function(e,t){var r=new this(e,t);return r},TimeoutStream.prototype.subscribeCore=function(t){var r=null;return r=this.scheduler.publishTimeout(t,this._time,function(e){t.next(e)}),e.SingleDisposable.create(function(){e.root.clearTimeout(r)})},__decorate([e.require(function(r,n){e.assert(r>0,t.info.FUNC_SHOULD("time","> 0"))})],TimeoutStream,"create",null),TimeoutStream}(e.BaseStream);e.TimeoutStream=r}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function MergeAllStream(e){t.call(this,null),this._source=null,this._observer=null,this._source=e,this.scheduler=this._source.scheduler}return __extends(MergeAllStream,t),MergeAllStream.create=function(e){var t=new this(e);return t},MergeAllStream.prototype.subscribeCore=function(t){var r=wdCb.Collection.create(),n=e.GroupDisposable.create();return this._source.buildStream(e.MergeAllObserver.create(t,r,n)),n},MergeAllStream}(e.BaseStream);e.MergeAllStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function MergeStream(e,r){t.call(this,null),this._source=null,this._maxConcurrent=null,this._source=e,this._maxConcurrent=r,this.scheduler=this._source.scheduler}return __extends(MergeStream,t),MergeStream.create=function(e,t){var r=new this(e,t);return r},MergeStream.prototype.subscribeCore=function(t){var r=wdCb.Collection.create(),n=e.GroupDisposable.create();return this._source.buildStream(e.MergeObserver.create(t,this._maxConcurrent,r,n)),n},MergeStream}(e.BaseStream);e.MergeStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function TakeUntilStream(r,n){t.call(this,null),this._source=null,this._otherStream=null,this._source=r,this._otherStream=e.JudgeUtils.isPromise(n)?e.fromPromise(n):n,this.scheduler=this._source.scheduler}return __extends(TakeUntilStream,t),TakeUntilStream.create=function(e,t){var r=new this(e,t);return r},TakeUntilStream.prototype.subscribeCore=function(t){var r=e.GroupDisposable.create(),n=e.AutoDetachObserver.create(t),i=null;return i=this._source.buildStream(t),r.add(i),n.setDisposable(i),r.add(this._otherStream.buildStream(e.TakeUntilObserver.create(n))),r},TakeUntilStream}(e.BaseStream);e.TakeUntilStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function ConcatStream(r){t.call(this,null),this._sources=wdCb.Collection.create();var n=this;this.scheduler=r[0].scheduler,r.forEach(function(t){e.JudgeUtils.isPromise(t)?n._sources.addChild(e.fromPromise(t)):n._sources.addChild(t)})}return __extends(ConcatStream,t),ConcatStream.create=function(e){var t=new this(e);return t},ConcatStream.prototype.subscribeCore=function(t){function loopRecursive(a){return a===n?void t.completed():void i.add(r._sources.getChild(a).buildStream(e.ConcatObserver.create(t,function(){loopRecursive(a+1)})))}var r=this,n=this._sources.getCount(),i=e.GroupDisposable.create();return this.scheduler.publishRecursive(t,0,loopRecursive),e.GroupDisposable.create(i)},ConcatStream}(e.BaseStream);e.ConcatStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function RepeatStream(e,r){t.call(this,null),this._source=null,this._count=null,this._source=e,this._count=r,this.scheduler=this._source.scheduler}return __extends(RepeatStream,t),RepeatStream.create=function(e,t){var r=new this(e,t);return r},RepeatStream.prototype.subscribeCore=function(t){function loopRecursive(i){return 0===i?void t.completed():void n.add(r._source.buildStream(e.ConcatObserver.create(t,function(){loopRecursive(i-1)})))}var r=this,n=e.GroupDisposable.create();return this.scheduler.publishRecursive(t,this._count,loopRecursive),e.GroupDisposable.create(n)},RepeatStream}(e.BaseStream);e.RepeatStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,
new __)},wdFrp;!function(e){var t=function(t){function IgnoreElementsStream(e){t.call(this,null),this._source=null,this._source=e,this.scheduler=this._source.scheduler}return __extends(IgnoreElementsStream,t),IgnoreElementsStream.create=function(e){var t=new this(e);return t},IgnoreElementsStream.prototype.subscribeCore=function(t){return this._source.buildStream(e.IgnoreElementsObserver.create(t))},IgnoreElementsStream}(e.BaseStream);e.IgnoreElementsStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function DeferStream(e){t.call(this,null),this._buildStreamFunc=null,this._buildStreamFunc=e}return __extends(DeferStream,t),DeferStream.create=function(e){var t=new this(e);return t},DeferStream.prototype.subscribeCore=function(t){var r=e.GroupDisposable.create();return r.add(this._buildStreamFunc().buildStream(t)),r},DeferStream}(e.BaseStream);e.DeferStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function FilterStream(e,r,n){t.call(this,null),this.predicate=null,this._source=null,this._source=e,this.predicate=wdCb.FunctionUtils.bind(n,r)}return __extends(FilterStream,t),FilterStream.create=function(e,t,r){var n=new this(e,t,r);return n},FilterStream.prototype.subscribeCore=function(e){return this._source.subscribe(this.createObserver(e))},FilterStream.prototype.internalFilter=function(e,t){return this.createStreamForInternalFilter(this._source,this._innerPredicate(e,this),t)},FilterStream.prototype.createObserver=function(t){return e.FilterObserver.create(t,this.predicate,this)},FilterStream.prototype.createStreamForInternalFilter=function(e,t,r){return FilterStream.create(e,t,r)},FilterStream.prototype._innerPredicate=function(e,t){var r=this;return function(n,i,a){return t.predicate(n,i,a)&&e.call(r,n,i,a)}},FilterStream}(e.BaseStream);e.FilterStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function FilterWithStateStream(){t.apply(this,arguments)}return __extends(FilterWithStateStream,t),FilterWithStateStream.create=function(e,t,r){var n=new this(e,t,r);return n},FilterWithStateStream.prototype.createObserver=function(t){return e.FilterWithStateObserver.create(t,this.predicate,this)},FilterWithStateStream.prototype.createStreamForInternalFilter=function(e,t,r){return FilterWithStateStream.create(e,t,r)},FilterWithStateStream}(e.FilterStream);e.FilterWithStateStream=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){e.createStream=function(t){return e.AnonymousStream.create(t)},e.fromArray=function(t,r){return void 0===r&&(r=e.Scheduler.create()),e.FromArrayStream.create(t,r)},e.fromPromise=function(t,r){return void 0===r&&(r=e.Scheduler.create()),e.FromPromiseStream.create(t,r)},e.fromEventPattern=function(t,r){return e.FromEventPatternStream.create(t,r)},e.interval=function(t,r){return void 0===r&&(r=e.Scheduler.create()),e.IntervalStream.create(t,r)},e.intervalRequest=function(t){return void 0===t&&(t=e.Scheduler.create()),e.IntervalRequestStream.create(t)},e.timeout=function(t,r){return void 0===r&&(r=e.Scheduler.create()),e.TimeoutStream.create(t,r)},e.empty=function(){return e.createStream(function(e){e.completed()})},e.callFunc=function(t,r){return void 0===r&&(r=e.root),e.createStream(function(e){try{e.next(t.call(r,null))}catch(t){e.error(t)}e.completed()})},e.judge=function(e,t,r){return e()?t():r()},e.defer=function(t){return e.DeferStream.create(t)},e.just=function(t){return e.createStream(function(e){e.next(t),e.completed()})}}(wdFrp||(wdFrp={}));var wdFrp;!function(e){!function(e){e[e.TRIGGER=0]="TRIGGER",e[e.ENTER=1]="ENTER",e[e.LEAVE=2]="LEAVE"}(e.FilterState||(e.FilterState={}));e.FilterState}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(e,t){return e===t},r=function(){function Record(e,r,n,i){this._time=null,this._value=null,this._actionType=null,this._comparer=null,this._time=e,this._value=r,this._actionType=n,this._comparer=i||t}return Record.create=function(e,t,r,n){var i=new this(e,t,r,n);return i},Object.defineProperty(Record.prototype,"time",{get:function(){return this._time},set:function(e){this._time=e},enumerable:!0,configurable:!0}),Object.defineProperty(Record.prototype,"value",{get:function(){return this._value},set:function(e){this._value=e},enumerable:!0,configurable:!0}),Object.defineProperty(Record.prototype,"actionType",{get:function(){return this._actionType},set:function(e){this._actionType=e},enumerable:!0,configurable:!0}),Record.prototype.equals=function(e){return this._time===e.time&&this._comparer(this._value,e.value)},Record}();e.Record=r}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function MockObserver(e){t.call(this,null,null,null),this._messages=[],this._scheduler=null,this._scheduler=e}return __extends(MockObserver,t),MockObserver.create=function(e){var t=new this(e);return t},Object.defineProperty(MockObserver.prototype,"messages",{get:function(){return this._messages},set:function(e){this._messages=e},enumerable:!0,configurable:!0}),MockObserver.prototype.onNext=function(t){var r=null;r=e.JudgeUtils.isDirectObject(t)?e.Record.create(this._scheduler.clock,t,e.ActionType.NEXT,function(e,t){var r=!0;for(var n in e)if(e.hasOwnProperty(n)&&e[n]!==t[n]){r=!1;break}return r}):e.Record.create(this._scheduler.clock,t,e.ActionType.NEXT),this._messages.push(r)},MockObserver.prototype.onError=function(t){this._messages.push(e.Record.create(this._scheduler.clock,t,e.ActionType.ERROR))},MockObserver.prototype.onCompleted=function(){this._messages.push(e.Record.create(this._scheduler.clock,null,e.ActionType.COMPLETED))},MockObserver.prototype.dispose=function(){t.prototype.dispose.call(this),this._scheduler.remove(this)},MockObserver.prototype.clone=function(){var e=MockObserver.create(this._scheduler);return e.messages=this._messages,e},MockObserver}(e.Observer);e.MockObserver=t}(wdFrp||(wdFrp={}));var wdFrp;!function(e){var t=function(){function MockPromise(e,t){this._messages=[],this._scheduler=null,this._scheduler=e,this._messages=t}return MockPromise.create=function(e,t){var r=new this(e,t);return r},MockPromise.prototype.then=function(e,t,r){this._scheduler.setStreamMap(r,this._messages)},MockPromise}();e.MockPromise=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=200,r=1e3,n=function(n){function TestScheduler(e){n.call(this),this._clock=null,this._isReset=!1,this._isDisposed=!1,this._timerMap=wdCb.Hash.create(),this._streamMap=wdCb.Hash.create(),this._subscribedTime=null,this._disposedTime=null,this._observer=null,this._isReset=e}return __extends(TestScheduler,n),TestScheduler.next=function(t,r){return e.JudgeUtils.isDirectObject(r)?e.Record.create(t,r,e.ActionType.NEXT,function(e,t){var r=!0;for(var n in e)if(e.hasOwnProperty(n)&&e[n]!==t[n]){r=!1;break}return r}):e.Record.create(t,r,e.ActionType.NEXT)},TestScheduler.error=function(t,r){return e.Record.create(t,r,e.ActionType.ERROR)},TestScheduler.completed=function(t){return e.Record.create(t,null,e.ActionType.COMPLETED)},TestScheduler.create=function(e){void 0===e&&(e=!1);var t=new this(e);return t},Object.defineProperty(TestScheduler.prototype,"clock",{get:function(){return this._clock},set:function(e){this._clock=e},enumerable:!0,configurable:!0}),TestScheduler.prototype.setStreamMap=function(t,r){var n=this;r.forEach(function(r){var i=null;switch(r.actionType){case e.ActionType.NEXT:i=function(){t.next(r.value)};break;case e.ActionType.ERROR:i=function(){t.error(r.value)};break;case e.ActionType.COMPLETED:i=function(){t.completed()};break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("actionType"))}n._streamMap.addChild(String(r.time),i)})},TestScheduler.prototype.remove=function(e){this._isDisposed=!0},TestScheduler.prototype.publishRecursive=function(e,t,r){var n=this,i=null,a=null;this._setClock(),i=e.next,a=e.completed,e.next=function(t){i.call(e,t),n._tick(1)},e.completed=function(){a.call(e),n._tick(1)},r(t)},TestScheduler.prototype.publishInterval=function(e,t,r,n){var i=10,a=[];for(this._setClock();i>0&&!this._isDisposed;)this._tick(r),a.push(TestScheduler.next(this._clock,t)),t++,i--;return this.setStreamMap(e,a),NaN},TestScheduler.prototype.publishIntervalRequest=function(e,t){var r=10,n=[],i=100,a=0;for(this._setClock();r>0&&!this._isDisposed;)this._tick(i),n.push(TestScheduler.next(this._clock,a)),a++,r--;return this.setStreamMap(e,n),NaN},TestScheduler.prototype.publishTimeout=function(e,t,r){var n=[];return this._setClock(),this._tick(t),n.push(TestScheduler.next(this._clock,t),TestScheduler.completed(this._clock+1)),this.setStreamMap(e,n),NaN},TestScheduler.prototype._setClock=function(){this._isReset&&(this._clock=this._subscribedTime)},TestScheduler.prototype.startWithTime=function(e,t,r){var n,i,a=this.createObserver(),o=this;return this._subscribedTime=t,this._disposedTime=r,this._clock=t,this._runAt(t,function(){n=e(),i=n.subscribe(a)}),this._runAt(r,function(){i.dispose(),o._isDisposed=!0}),this._observer=a,this.start(),a},TestScheduler.prototype.startWithSubscribe=function(e,n){return void 0===n&&(n=t),this.startWithTime(e,n,r)},TestScheduler.prototype.startWithDispose=function(e,n){return void 0===n&&(n=r),this.startWithTime(e,t,n)},TestScheduler.prototype.publicAbsolute=function(e,t){this._runAt(e,function(){t()})},TestScheduler.prototype.start=function(){for(var e=this._getMinAndMaxTime(),t=e[0],r=e[1],n=t;n<=r;)this._clock=n,this._exec(n,this._timerMap),this._clock=n,this._runStream(n),n++,r=this._getMinAndMaxTime()[1]},TestScheduler.prototype.createStream=function(t){return e.TestStream.create(Array.prototype.slice.call(arguments,0),this)},TestScheduler.prototype.createObserver=function(){return e.MockObserver.create(this)},TestScheduler.prototype.createResolvedPromise=function(t,r){return e.MockPromise.create(this,[TestScheduler.next(t,r),TestScheduler.completed(t+1)])},TestScheduler.prototype.createRejectPromise=function(t,r){return e.MockPromise.create(this,[TestScheduler.error(t,r)])},TestScheduler.prototype._getMinAndMaxTime=function(){var e=this._timerMap.getKeys().addChildren(this._streamMap.getKeys());return e=e.map(function(e){return Number(e)}).toArray(),[Math.min.apply(Math,e),Math.max.apply(Math,e)]},TestScheduler.prototype._exec=function(e,t){var r=t.getChild(String(e));r&&r()},TestScheduler.prototype._runStream=function(e){var t=this._streamMap.getChild(String(e));t&&t()},TestScheduler.prototype._runAt=function(e,t){this._timerMap.addChild(String(e),t)},TestScheduler.prototype._tick=function(e){this._clock+=e},TestScheduler}(e.Scheduler);e.TestScheduler=n}(wdFrp||(wdFrp={}));var wdFrp;!function(e){!function(e){e[e.NEXT=0]="NEXT",e[e.ERROR=1]="ERROR",e[e.COMPLETED=2]="COMPLETED"}(e.ActionType||(e.ActionType={}));e.ActionType}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},wdFrp;!function(e){var t=function(t){function TestStream(e,r){t.call(this,null),this.scheduler=null,this._messages=null,this._messages=e,this.scheduler=r}return __extends(TestStream,t),TestStream.create=function(e,t){var r=new this(e,t);return r},TestStream.prototype.subscribeCore=function(t){return this.scheduler.setStreamMap(t,this._messages),e.SingleDisposable.create()},TestStream}(e.BaseStream);e.TestStream=t}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(e,t){function __(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)},__decorate=this&&this.__decorate||function(e,t,r,n){var i,a=arguments.length,o=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,r,o):i(t,r))||o);return a>3&&o&&Object.defineProperty(t,r,o),o},wd;!function(e){e.DebugConfig={isTest:!1,debugCollision:!1,showDebugPanel:!1}}(wd||(wd={}));var wd;!function(e){var t=function(){function DebugStatistics(){}return DebugStatistics.clear=function(){this.count.renderGameObjects=0,this.count.drawCalls=0},DebugStatistics.init=function(){var t=this;this._startLoopSubscription=e.EventManager.fromEvent(e.EEngineEvent.STARTLOOP).subscribe(function(){e.DebugConfig.showDebugPanel&&(console.log("totalGameObjects:"+t.count.totalGameObjects+", renderGameObjects:"+t.count.renderGameObjects+", drawCalls:"+t.count.drawCalls),console.log("fps:"+t.during.fps),t.clear())})},DebugStatistics.dispose=function(){this._startLoopSubscription.dispose()},DebugStatistics.count={get totalGameObjects(){var t=0;return e.Director.getInstance().scene.getChildren().forEach(function(r){return r.hasComponent(e.SpacePartition)?void(t+=r.getComponent(e.SpacePartition).getChildren().getCount()):void t++}),t},renderGameObjects:0,drawCalls:0},DebugStatistics.during={get fps(){return e.Director.getInstance().fps}},DebugStatistics._startLoopSubscription=null,DebugStatistics}();e.DebugStatistics=t}(wd||(wd={}));var wdFrp;!function(e){e.fromCollection=function(t,r){void 0===r&&(r=e.Scheduler.create());var n=t.toArray();return 0===n.length?e.empty():e.fromArray(n,r)}}(wdFrp||(wdFrp={}));var wd;!function(e){e.CompileConfig={isTest:!0}}(wd||(wd={}));var wd;!function(e){function assert(t,r){void 0===r&&(r="contract error"),e.Log.error(!t,r)}function describe(e,r,n,i){if(void 0===n&&(n=function(){return!0}),void 0===i&&(i=this),n.call(i,null)){t=i;try{r.call(i,null)}catch(t){assert(!1,e+"->"+t.message)}finally{t=null}}}function it(e,r,n){try{3===arguments.length?r.call(n,null):t?r.call(t,null):r()}catch(t){assert(!1,e+"->"+t.message)}}function require(t){return function(r,n,i){if(e.CompileConfig.isTest){var a=i.value;i.value=function(r){return e.Main.isTest&&t.apply(this,arguments),a.apply(this,arguments)}}return i}}function ensure(t){return function(r,n,i){if(e.CompileConfig.isTest){var a=i.value;i.value=function(r){var n=a.apply(this,arguments);if(e.Main.isTest){for(var i=[n],o=0,s=arguments.length;o<s;o++)i[o+1]=arguments[o];t.apply(this,i)}return n}}return i}}function requireGetterAndSetter(t,r){return function(n,i,a){if(e.CompileConfig.isTest){var o=a.get,s=a.set;a.get=function(){return e.Main.isTest&&t.call(this),o.call(this)},a.set=function(t){e.Main.isTest&&r.call(this,t),s.call(this,t)}}return a}}function requireGetter(t){return function(r,n,i){if(e.CompileConfig.isTest){var a=i.get;i.get=function(){return e.Main.isTest&&t.call(this),a.call(this)}}return i}}function requireSetter(t){return function(r,n,i){if(e.CompileConfig.isTest){var a=i.set;i.set=function(r){e.Main.isTest&&t.call(this,r),a.call(this,r)}}return i}}function ensureGetterAndSetter(t,r){return function(n,i,a){if(e.CompileConfig.isTest){var o=a.get,s=a.set;a.get=function(){var r=o.call(this);return e.Main.isTest&&t.call(this,r),r},a.set=function(t){var n=s.call(this,t);if(e.Main.isTest){var i=[n,t];r.apply(this,i)}}}return a}}function ensureGetter(t){return function(r,n,i){if(e.CompileConfig.isTest){var a=i.get;i.get=function(){var r=a.call(this);return e.Main.isTest&&t.call(this,r),r}}return i}}function ensureSetter(t){return function(r,n,i){if(e.CompileConfig.isTest){var a=i.set;i.set=function(r){var n=a.call(this,r);if(e.Main.isTest){var i=[n,r];t.apply(this,i)}}}return i}}function invariant(t){return function(r){e.CompileConfig.isTest&&e.Main.isTest&&t(r)}}var t=null;e.assert=assert,e.describe=describe,e.it=it,e.require=require,e.ensure=ensure,e.requireGetterAndSetter=requireGetterAndSetter,e.requireGetter=requireGetter,e.requireSetter=requireSetter,e.ensureGetterAndSetter=ensureGetterAndSetter,e.ensureGetter=ensureGetter,e.ensureSetter=ensureSetter,e.invariant=invariant}(wd||(wd={}));var wd;!function(e){function singleton(e){return void 0===e&&(e=!1),function(t){t._instance=null,e?t.getInstance=function(){if(null===t._instance){var e=new t;t._instance=e,e.initWhenCreate()}return t._instance}:t.getInstance=function(){return null===t._instance&&(t._instance=new t),t._instance}}}e.singleton=singleton}(wd||(wd={}));var wd;!function(e){function cacheGetter(e,t,r){return function(n,i,a){var o=a.get;return a.get=function(){var n=null;return e.call(this)?t.call(this):(n=o.call(this),r.call(this,n),n)},a}}function cache(e,t,r){return function(n,i,a){var o=a.value;return a.value=function(n){var i=null,a=null;if(e.apply(this,arguments))return t.apply(this,arguments);i=o.apply(this,arguments),a=[i];for(var s=0,c=arguments.length;s<c;s++)a[s+1]=arguments[s];return r.apply(this,a),i},a}}function cacheBufferForBufferContainer(){return function(e,t,r){var n=r.value;return r.value=function(e){var t=null;return this.container.hasChild(e)?this.container.getChild(e):(t=n.call(this,e),this.container.addChild(e,t),t)},r}}function cacheBufferForBufferContainerWithFuncParam(e){return function(t,r,n){var i=n.value;return n.value=function(t){var r=null,n=this[e](t);return this.container.hasChild(n)?this.container.getChild(n):(r=i.call(this,t),this.container.addChild(n,r),r)},n}}e.cacheGetter=cacheGetter,e.cache=cache,e.cacheBufferForBufferContainer=cacheBufferForBufferContainer,e.cacheBufferForBufferContainerWithFuncParam=cacheBufferForBufferContainerWithFuncParam}(wd||(wd={}));var wd;!function(e){function virtual(e,t,r){return r}e.virtual=virtual}(wd||(wd={}));var wd;!function(e){function operateBodyDataGetterAndSetter(e){return function(t,r,n){var i=(n.get,n.set);return n.get=function(){var t=this.getPhysicsEngineAdapter()["get"+e](this.entityObject);return null!==t?t:this["_"+lowerFirstChar(e)]},n.set=function(t){i.call(this,t),this.getPhysicsEngineAdapter()["set"+e](this.entityObject,t)},n}}function operateWorldDataGetterAndSetter(t){return function(r,n,i){var a=i.get,o=i.set;return i.get=function(){var r=e.PhysicsEngine.getInstance().physicsEngineAdapter;if(isWorldDefined(r)){var n=r["get"+t]();return null!==n?n:this["_"+lowerFirstChar(t)]}return a.call(this)},i.set=function(r){var n=e.PhysicsEngine.getInstance().physicsEngineAdapter;o.call(this,r),isWorldDefined(n)&&n["set"+t](r)},i}}function isWorldDefined(e){return e&&e.world}function lowerFirstChar(e){var t=e.slice(0,1);return""+t.toLowerCase()+e.slice(1)}e.operateBodyDataGetterAndSetter=operateBodyDataGetterAndSetter,e.operateWorldDataGetterAndSetter=operateWorldDataGetterAndSetter}(wd||(wd={}));var wd;!function(e){function script(t){return function(r){e.Script.addScript(t,r)}}e.script=script}(wd||(wd={}));var wd;!function(e){function execOnlyOnce(e){return function(t,r,n){var i=n.value;return n.value=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(!this[e])return this[e]=!0,i.apply(this,t)},n}}e.execOnlyOnce=execOnlyOnce}(wd||(wd={}));var wd;!function(e){e.expect=chai.expect}(wd||(wd={}));var wd;!function(e){var t=function(e){function ArrayUtils(){e.apply(this,arguments)}return __extends(ArrayUtils,e),ArrayUtils.hasRepeatItems=function(e){for(var t=[],r=!1,n=0,i=e;n<i.length;n++){var a=i[n];if(a){if(this.contain(t,a)){r=!0;break}t.push(a)}}return r},ArrayUtils.contain=function(e,t){for(var r=null,n=0,i=e.length;n<i;n++){if(r=e[n],t.uid&&r.uid&&t.uid==r.uid)return!0;if(t===r)return!0}return!1},ArrayUtils}(wdCb.ArrayUtils);e.ArrayUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BufferUtils(){}return BufferUtils.convertArrayToArrayBuffer=function(t,r){var n=this._getBufferSize(t);return e.ArrayBuffer.create(r,n,e.EBufferType.FLOAT)},BufferUtils._getBufferSize=function(t){var r=null;switch(t){case e.EVariableType.FLOAT_1:case e.EVariableType.NUMBER_1:r=1;break;case e.EVariableType.FLOAT_2:r=2;break;case e.EVariableType.FLOAT_3:r=3;break;case e.EVariableType.FLOAT_4:r=4;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("EVariableType",t))}return r},__decorate([e.require(function(t,r){e.it("value:"+r+" should be array",function(){e.expect(e.JudgeUtils.isArrayExactly(r)).true})})],BufferUtils,"convertArrayToArrayBuffer",null),BufferUtils}();e.BufferUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ClassUtils(){}return ClassUtils.getClassName=function(e){return e.constructor.name},__decorate([e.require(function(t){e.assert(e.JudgeUtils.isFunction(t.constructor),e.Log.info.FUNC_MUST_BE("objInstance.constructor","Function"))}),e.ensure(function(t){e.assert(!!t,e.Log.info.FUNC_CAN_NOT("get class name from objInstance.constructor.name"))})],ClassUtils,"getClassName",null),ClassUtils}();e.ClassUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CoordinateUtils(){}return CoordinateUtils.convertWebGLPositionToCanvasPosition=function(t){var r=e.DeviceManager.getInstance().view;return e.Vector2.create(r.width/2+t.x,r.height/2-t.y)},CoordinateUtils.convertCanvasPositionToWebGLPosition=function(t){var r=e.DeviceManager.getInstance().view;return e.Vector3.create(t.x-r.width/2,r.height/2-t.y,0)},CoordinateUtils.convertLeftCornerPositionToCenterPositionInWebGL=function(t,r,n){return e.Vector2.create(this.convertLeftCornerPositionXToCenterPositionXInWebGL(t.x,r),this.convertLeftCornerPositionYToCenterPositionYInWebGL(t.y,n))},CoordinateUtils.convertLeftCornerPositionXToCenterPositionXInWebGL=function(e,t){return e-t/2},CoordinateUtils.convertLeftCornerPositionYToCenterPositionYInWebGL=function(e,t){return e-t/2},CoordinateUtils.convertLeftCornerPositionToCenterPositionInCanvas=function(t,r,n){return e.Vector2.create(this.convertLeftCornerPositionXToCenterPositionXInCanvas(t.x,r),this.convertLeftCornerPositionYToCenterPositionYInCanvas(t.y,n))},CoordinateUtils.convertLeftCornerPositionXToCenterPositionXInCanvas=function(e,t){return e+t/2},CoordinateUtils.convertLeftCornerPositionYToCenterPositionYInCanvas=function(e,t){return e+t/2},__decorate([e.require(function(){e.assert(!!e.DeviceManager.getInstance().view,e.Log.info.FUNC_SHOULD("set view"))})],CoordinateUtils,"convertWebGLPositionToCanvasPosition",null),__decorate([e.require(function(){e.assert(!!e.DeviceManager.getInstance().view,e.Log.info.FUNC_SHOULD("set view"))})],CoordinateUtils,"convertCanvasPositionToWebGLPosition",null),CoordinateUtils}();e.CoordinateUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GlobalGeometryUtils(){}return GlobalGeometryUtils.hasAnimation=function(t){return t instanceof e.ModelGeometry&&t.hasAnimation()},GlobalGeometryUtils}();e.GlobalGeometryUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GlobalScriptUtils(){}return GlobalScriptUtils.handlerAfterLoadedScript=function(t){e.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(t,"onEnter"),e.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(t,"init")},GlobalScriptUtils.addScriptToEntityObject=function(t,r){e.ScriptEngine.getInstance().addChild(t,r.name,new r.class(t))},GlobalScriptUtils}();e.GlobalScriptUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GlobalTextureUtils(){}return GlobalTextureUtils.convertSourceRegionCanvasMapToUV=function(t,r,n){var i=null;return i=e.RectRegion.create(t.x/r,t.y/n,t.width/r,t.height/n),i.y=1-i.y-i.height,i},GlobalTextureUtils}();e.GlobalTextureUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function InstanceUtils(){}return InstanceUtils.isHardwareSupport=function(){return null!==e.GPUDetector.getInstance().extensionInstancedArrays},InstanceUtils.isInstance=function(t){return t.hasComponent(e.Instance)},InstanceUtils.isSourceInstance=function(t){return t.hasComponent(e.SourceInstance)},InstanceUtils.isOneToOneSourceInstance=function(t){return t.hasComponent(e.OneToOneSourceInstance)},InstanceUtils.isOneToManySourceInstance=function(t){return t.hasComponent(e.OneToManySourceInstance)},InstanceUtils.isObjectInstance=function(t){return t.hasComponent(e.ObjectInstance)},InstanceUtils.addModelMatrixShaderLib=function(t,r){if(r)return InstanceUtils.isInstance(r)?InstanceUtils.isHardwareSupport()?void t.addLib(e.ModelMatrixHardwareInstanceShaderLib.create()):void t.addLib(e.ModelMatrixBatchInstanceShaderLib.create()):void t.addLib(e.ModelMatrixNoInstanceShaderLib.create())},InstanceUtils.addNormalModelMatrixShaderLib=function(t,r){if(r)return InstanceUtils.isInstance(r)?InstanceUtils.isHardwareSupport()?void t.addLib(e.NormalMatrixHardwareInstanceShaderLib.create()):void t.addLib(e.NormalMatrixBatchInstanceShaderLib.create()):void t.addLib(e.NormalMatrixNoInstanceShaderLib.create())},InstanceUtils}();e.InstanceUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function IterateUtils(){}return IterateUtils.forEachAll=function(e,t){var r=function(e){t(e),e.forEach(function(e){r(e)})};r(e)},IterateUtils}();e.IterateUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function JudgeUtils(){t.apply(this,arguments)}return __extends(JudgeUtils,t),JudgeUtils.isView=function(e){return!!e&&e.offset&&e.width&&e.height&&this.isFunction(e.getContext)},JudgeUtils.isEqual=function(e,t){return!(!e&&t||e&&!t)&&(e.uid&&t.uid?e.uid===t.uid:e===t)},JudgeUtils.isPowerOfTwo=function(e){return 0===(e&e-1)&&0!==e},JudgeUtils.isFloatArray=function(e){return"[object Float32Array]"===Object.prototype.toString.call(e)||"[object Float16Array]"===Object.prototype.toString.call(e)},JudgeUtils.isInterface=function(e,t){return!!e[t]},JudgeUtils.isSpacePartitionObject=function(t){return t.hasComponent(e.SpacePartition)},JudgeUtils.isSelf=function(e,t){return e.uid===t.uid},JudgeUtils.isComponenet=function(e){return void 0!==e.entityObject},JudgeUtils.isDom=function(e){return null!==Object.prototype.toString.call(e).match(/\[object HTML\w+/)},JudgeUtils.isCollection=function(e){return e instanceof wdCb.Collection},JudgeUtils}(wdCb.JudgeUtils);e.JudgeUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function LightUtils(){}return LightUtils.getPointLightPosition=function(e){return e.position},LightUtils.getDirectionLightPosition=function(t){return this._isZero(t.position)?e.DirectionLight.defaultPosition:t.position},LightUtils._isZero=function(e){var t=e.values;return 0===t[0]&&0===t[1]&&0===t[2]},LightUtils}();e.LightUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function Log(){e.apply(this,arguments)}return __extends(Log,e),Log}(wdCb.Log);e.Log=t}(wd||(wd={}));var wd;!function(e){var t=function(){function MathUtils(){}return MathUtils.clamp=function(e,t,r){return e<t?t:e>r?r:e},MathUtils.bigThan=function(e,t){return e<t?t:e},MathUtils.generateZeroToOne=function(){return Math.random()},MathUtils.generateMinToMax=function(e,t){var t=t+1;return Math.random()*(t-e)+e},MathUtils.generateInteger=function(e,t){return Math.floor(this.generateMinToMax(e,t))},MathUtils.mod=function(e,t){var r=Math.floor(e/t);return e-=r*t,e<0&&(e+=t),e},MathUtils.maxFloorIntegralMultiple=function(e,t){return 0==t?e:e<t?0:Math.floor(e/t)*t},__decorate([e.require(function(t,r){e.assert(t<r,e.Log.info.FUNC_SHOULD("min","< max"))})],MathUtils,"generateMinToMax",null),__decorate([e.require(function(t,r){e.assert(t<r,e.Log.info.FUNC_SHOULD("min","< max"))})],MathUtils,"generateInteger",null),__decorate([e.ensure(function(t){e.assert(t>=0)})],MathUtils,"mod",null),__decorate([e.require(function(t,r){e.assert(t>=0&&r>=0,e.Log.info.FUNC_SHOULD("param",">= 0"))}),e.ensure(function(t){e.assert(t>=0)})],MathUtils,"maxFloorIntegralMultiple",null),MathUtils}();e.MathUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function RenderUtils(){}return RenderUtils.getGameObjectRenderList=function(t){var r=this,n=[];return t.forEach(function(t){var i=(t.getComponent(e.GameObjectLOD),null);return i=r._getActiveGameObject(t),null===i?wdCb.Collection.create():void(i.isVisible&&!e.InstanceUtils.isObjectInstance(i)&&n.push(i))}),wdCb.Collection.create(n)},RenderUtils.getGameObjectRenderListForOctree=function(t){var r=this,n=[];return t.forEach(function(t){var i=(t.getComponent(e.GameObjectLOD),null);return i=r._getActiveGameObject(t),null===i?wdCb.Collection.create():void(i.isVisible&&n.push(i))}),wdCb.Collection.create(n)},RenderUtils._getActiveGameObject=function(t){var r=t.getComponent(e.GameObjectLOD);return r?r.activeGameObject:t},RenderUtils}();e.RenderUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function SortUtils(){}return SortUtils.insertSort=function(e,t,r){void 0===r&&(r=!1);for(var n=r?e:wdCb.ExtendUtils.extend([],e),i=1,a=n.length;i<a;i++)for(var o=i;o>0&&t(n[o],n[o-1]);o--)this._swap(n,o-1,o);return n},SortUtils.quickSort=function(e,t,r){void 0===r&&(r=!1);var n=r?e:wdCb.ExtendUtils.extend([],e),i=function(e,r){if(!(e>=r)){for(var a=e,o=r,s=n[e];a<o;){for(;a<o&&t(s,n[o]);)o--;for(a<o&&(n[a++]=n[o]);a<o&&t(n[a],s);)a++;a<o&&(n[o--]=n[a])}n[a]=s,i(e,a-1),i(a+1,r)}};return i(0,n.length-1),n},SortUtils._swap=function(e,t,r){var n=null;n=e[t],e[t]=e[r],e[r]=n},SortUtils}();e.SortUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function TimeController(){this.elapsed=null,this.pauseElapsed=0,this.pauseTime=null,this.startTime=null}return TimeController.prototype.start=function(){this.startTime=this.getNow(),this.pauseElapsed=null},TimeController.prototype.stop=function(){this.startTime=null},TimeController.prototype.pause=function(){this.pauseTime=this.getNow()},TimeController.prototype.resume=function(){this.pauseElapsed+=this.getNow()-this.pauseTime,this.pauseTime=null},TimeController.prototype.computeElapseTime=function(e){return this.pauseElapsed?this.elapsed=e-this.pauseElapsed-this.startTime:this.elapsed=e-this.startTime,this.elapsed<0&&(this.elapsed=0),this.elapsed},__decorate([e.ensure(function(){e.assert(this.elapsed>=0,e.Log.info.FUNC_SHOULD("elapsed:"+this.elapsed,">= 0"))})],TimeController.prototype,"computeElapseTime",null),TimeController}();e.TimeController=t}(wd||(wd={}));var wd;!function(e){var t=60,r=1e3,n=function(n){function DirectorTimeController(){n.apply(this,arguments),this.gameTime=null,this.fps=null,this.isTimeChange=!1,this.deltaTime=null,this._lastTime=null}return __extends(DirectorTimeController,n),DirectorTimeController.create=function(){var e=new this;return e},DirectorTimeController.prototype.tick=function(e){this.deltaTime=null!==this._lastTime?e-this._lastTime:e,this._updateFps(this.deltaTime),this.gameTime=e/r,this._lastTime=e},DirectorTimeController.prototype.start=function(){n.prototype.start.call(this),this.isTimeChange=!0,this.elapsed=0},DirectorTimeController.prototype.resume=function(){n.prototype.resume.call(this),this.isTimeChange=!0},DirectorTimeController.prototype.getNow=function(){return e.root.performance.now()},DirectorTimeController.prototype._updateFps=function(e){null===this._lastTime?this.fps=t:this.fps=1e3/e},DirectorTimeController}(e.TimeController);e.DirectorTimeController=n}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonTimeController(){t.apply(this,arguments)}return __extends(CommonTimeController,t),CommonTimeController.create=function(){var e=new this;return e},CommonTimeController.prototype.getNow=function(){return e.Director.getInstance().isTimeChange?e.Director.getInstance().elapsed:e.root.performance.now()},CommonTimeController}(e.TimeController);e.CommonTimeController=t}(wd||(wd={}));
var wd;!function(e){function cloneAttributeAsBasicType(e){return c(l.BASIC,wdCb.ExtendUtils.extend({order:0},e))}function cloneAttributeAsCloneable(e){return c(l.CLONEABLE,wdCb.ExtendUtils.extend({order:0},e))}function cloneAttributeAsCustomType(e,t){return c(l.CUSTOM,e,wdCb.ExtendUtils.extend({order:0},t))}var t="not_clone",r=function(e){return e[s(e)]},n=function(e,t){e[s(e)]=t},i=function(e){var t="__decorator_clone",r=null;for(var n in e)if(e.hasOwnProperty(n)&&n.indexOf(t)>-1){r=e[n];break}return r},a=function(t){var a="__decorator_clone_isGathered_"+e.ClassUtils.getClassName(t)+"_cloneAttributeMembers",o=wdCb.Collection.create(),c=function(t){if(t){if(t[a]){var n=r(t);return e.assert(n,e.Log.info.FUNC_NOT_EXIST(""+s(t))),void o.addChildren(n)}c(t.__proto__);var u=i(t);u&&o.addChildren(u)}},u=function(){n(t.__proto__,o),t.__proto__[a]=!0};return c(t.__proto__),u(),r(t)},o=function(e){n(e,wdCb.Collection.create())},s=function(t){return"__decorator_clone_"+e.ClassUtils.getClassName(t)+"_cloneAttributeMembers"},c=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return function(n,i){r(n)||o(n),1===t.length?r(n).addChild({memberName:i,cloneType:e,configData:t[0]}):2===t.length&&r(n).addChild({memberName:i,cloneType:e,cloneFunc:t[0],configData:t[1]})}};e.cloneAttributeAsBasicType=cloneAttributeAsBasicType,e.cloneAttributeAsCloneable=cloneAttributeAsCloneable,e.cloneAttributeAsCustomType=cloneAttributeAsCustomType;var u=function(){function CloneUtils(){}return CloneUtils.clone=function(t,r,n,i){void 0===r&&(r=null),void 0===n&&(n=null),void 0===i&&(i=null);var o=a(t).sort(function(e,t){return e.configData.order-t.configData.order}),s=e.ClassUtils.getClassName(t);return null===i&&(i=n?e[s].create.apply(e[s],n):e[s].create()),o?(o.forEach(function(e){var n=e.cloneType,a=e.memberName;switch(n){case l.CLONEABLE:null!==t[a]&&void 0!==t[a]&&(null!==i[a]?i[a]=t[a].clone(i[a]):i[a]=t[a].clone());break;case l.BASIC:i[a]=t[a];break;case l.CUSTOM:var o=e.cloneFunc;o.call(i,t,i,a,r)}}),i):i},CloneUtils.cloneArray=function(e,t){return void 0===t&&(t=!1),t?wdCb.ExtendUtils.extendDeep(e):[].concat(e)},CloneUtils.markNotClone=function(e){e.hasTag(t)||e.addTag(t)},CloneUtils.isNotClone=function(e){return e.hasTag(t)},__decorate([e.require(function(t,r,n){void 0===r&&(r=null),void 0===n&&(n=null),n&&e.assert(e.JudgeUtils.isArrayExactly(n),e.Log.info.FUNC_MUST_BE("param:createDataArr","be arr"))})],CloneUtils,"clone",null),CloneUtils}();e.CloneUtils=u,function(e){e[e.CLONEABLE=0]="CLONEABLE",e[e.BASIC=1]="BASIC",e[e.CUSTOM=2]="CUSTOM"}(e.CloneType||(e.CloneType={}));var l=e.CloneType}(wd||(wd={}));var wd;!function(e){e.DEG_TO_RAD=Math.PI/180,e.RAD_TO_DEG=180/Math.PI}(wd||(wd={}));var wd;!function(e){var t=function(){function Vector2(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.values=new Float32Array(2),e.length>0&&(this.values[0]=e[0],this.values[1]=e[1])}return Vector2.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;return r=0===e.length?new this:new this(e[0],e[1])},Object.defineProperty(Vector2.prototype,"x",{get:function(){return this.values[0]},set:function(e){this.values[0]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vector2.prototype,"y",{get:function(){return this.values[1]},set:function(e){this.values[1]=e},enumerable:!0,configurable:!0}),Vector2.prototype.set=function(e,t){this.x=e,this.y=t},Vector2.prototype.add=function(e){return this.values[0]=this.values[0]+e.values[0],this.values[1]=this.values[1]+e.values[1],this},Vector2.prototype.mul=function(e){return this.values[0]=this.values[0]*e.values[0],this.values[1]=this.values[1]*e.values[1],this},Vector2.prototype.isEqual=function(e){return this.x===e.x&&this.y===e.y},Vector2.prototype.clone=function(){return Vector2.create(this.x,this.y)},Vector2}();e.Vector2=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Vector3(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.values=null,this.values=new Float32Array(3),e.length>0&&(this.values[0]=e[0],this.values[1]=e[1],this.values[2]=e[2])}return Vector3.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;return r=0===e.length?new this:new this(e[0],e[1],e[2])},Object.defineProperty(Vector3.prototype,"x",{get:function(){return this.values[0]},set:function(e){this.values[0]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vector3.prototype,"y",{get:function(){return this.values[1]},set:function(e){this.values[1]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vector3.prototype,"z",{get:function(){return this.values[2]},set:function(e){this.values[2]=e},enumerable:!0,configurable:!0}),Vector3.prototype.normalize=function(){var e=this.values,t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return 0===t?(e[0]=0,e[1]=0,e[2]=0,this):(e[0]=e[0]/t,e[1]=e[1]/t,e[2]=e[2]/t,e[0]===-0&&(e[0]=0),e[1]===-0&&(e[1]=0),e[2]===-0&&(e[2]=0),this)},Vector3.prototype.isZero=function(){var e=this.values;return 0===e[0]&&0===e[1]&&0===e[2]},Vector3.prototype.scale=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=this.values;if(1===e.length){var n=e[0];r[0]*=n,r[1]*=n,r[2]*=n}else if(3===e.length){var i=e[0],a=e[1],o=e[2];r[0]*=i,r[1]*=a,r[2]*=o}return this},Vector3.prototype.set=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(3===e.length)this.x=e[0],this.y=e[1],this.z=e[2];else{var r=e[0];this.x=r.x,this.y=r.y,this.z=r.z}},Vector3.prototype.sub=function(e){return this.values[0]=this.values[0]-e.values[0],this.values[1]=this.values[1]-e.values[1],this.values[2]=this.values[2]-e.values[2],this},Vector3.prototype.sub2=function(e,t){return this.values[0]=e.values[0]-t.values[0],this.values[1]=e.values[1]-t.values[1],this.values[2]=e.values[2]-t.values[2],this},Vector3.prototype.add=function(e){return this.values[0]=this.values[0]+e.values[0],this.values[1]=this.values[1]+e.values[1],this.values[2]=this.values[2]+e.values[2],this},Vector3.prototype.add2=function(e,t){return this.values[0]=e.values[0]+t.values[0],this.values[1]=e.values[1]+t.values[1],this.values[2]=e.values[2]+t.values[2],this},Vector3.prototype.mul=function(e){return this.values[0]=this.values[0]*e.values[0],this.values[1]=this.values[1]*e.values[1],this.values[2]=this.values[2]*e.values[2],this},Vector3.prototype.mul2=function(e,t){return this.values[0]=e.values[0]*t.values[0],this.values[1]=e.values[1]*t.values[1],this.values[2]=e.values[2]*t.values[2],this},Vector3.prototype.reverse=function(){return this.values[0]=-this.values[0],this.values[1]=-this.values[1],this.values[2]=-this.values[2],this},Vector3.prototype.clone=function(){var e=Vector3.create(),t=0,r=this.values.length;for(t=0;t<r;t++)e.values[t]=this.values[t];return e},Vector3.prototype.toVector4=function(){return e.Vector4.create(this.values[0],this.values[1],this.values[2],1)},Vector3.prototype.length=function(){var e=this.values;return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},Vector3.prototype.cross=function(e,t){var r,n,i,a,o,s,c,u,l;return r=e.values,n=t.values,i=this.values,a=r[0],o=r[1],s=r[2],c=n[0],u=n[1],l=n[2],i[0]=o*l-u*s,i[1]=s*c-l*a,i[2]=a*u-c*o,this},Vector3.prototype.lerp=function(e,t,r){var n=e.values,i=t.values,a=this.values;return a[0]=n[0]+r*(i[0]-n[0]),a[1]=n[1]+r*(i[1]-n[1]),a[2]=n[2]+r*(i[2]-n[2]),this},Vector3.prototype.dot=function(e){var t=this.values,r=e.values;return t[0]*r[0]+t[1]*r[1]+t[2]*r[2]},Vector3.prototype.calAngleCos=function(e){var t=this.length()*e.length();return 0===t?NaN:this.dot(e)/t},Vector3.prototype.min=function(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this},Vector3.prototype.max=function(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this},Vector3.prototype.isEqual=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},Vector3.prototype.toArray=function(){return[this.x,this.y,this.z]},Vector3.prototype.applyMatrix3=function(e){var t=this.x,r=this.y,n=this.z,i=e.values;return this.x=i[0]*t+i[3]*r+i[6]*n,this.y=i[1]*t+i[4]*r+i[7]*n,this.z=i[2]*t+i[5]*r+i[8]*n,this},Vector3.prototype.applyMatrix4=function(e){var t=this.x,r=this.y,n=this.z,i=e.values;return this.x=i[0]*t+i[4]*r+i[8]*n+i[12],this.y=i[1]*t+i[5]*r+i[9]*n+i[13],this.z=i[2]*t+i[6]*r+i[10]*n+i[14],this},Vector3.prototype.distanceTo=function(e){return Math.sqrt(this.distanceToSquared(e))},Vector3.prototype.distanceToSquared=function(e){var t=this.x-e.x,r=this.y-e.y,n=this.z-e.z;return Math.pow(t,2)+Math.pow(r,2)+Math.pow(n,2)},Vector3.up=Vector3.create(0,1,0),Vector3.forward=Vector3.create(0,0,1),Vector3.right=Vector3.create(1,0,0),Vector3}();e.Vector3=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Vector4(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.values=new Float32Array(4),e.length>0&&(this.values[0]=e[0],this.values[1]=e[1],this.values[2]=e[2],this.values[3]=e[3])}return Vector4.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;return r=0===e.length?new this:new this(e[0],e[1],e[2],e[3])},Object.defineProperty(Vector4.prototype,"x",{get:function(){return this.values[0]},set:function(e){this.values[0]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vector4.prototype,"y",{get:function(){return this.values[1]},set:function(e){this.values[1]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vector4.prototype,"z",{get:function(){return this.values[2]},set:function(e){this.values[2]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Vector4.prototype,"w",{get:function(){return this.values[3]},set:function(e){this.values[3]=e},enumerable:!0,configurable:!0}),Vector4.prototype.normalize=function(){var e=this.values,t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3]);return 0===t?Vector4.create(0,0,0,0):(e[0]=e[0]/t,e[1]=e[1]/t,e[2]=e[2]/t,e[3]=e[3]/t,this)},Vector4.prototype.isEqual=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},Vector4.prototype.clone=function(){return this.copyHelper(Vector4.create())},Vector4.prototype.toVector3=function(){return e.Vector3.create(this.values[0],this.values[1],this.values[2])},Vector4.prototype.multiplyScalar=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},Vector4.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},Vector4.prototype.set=function(e,t,r,n){this.x=e,this.y=t,this.z=r,this.w=n},Vector4.prototype.copyHelper=function(e){var t=e,r=0,n=this.values.length;for(r=0;r<n;r++)t.values[r]=this.values[r];return t},Vector4}();e.Vector4=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Matrix4(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.values=null,this._matrixArr=null,1===e.length?this.values=e[0]:this.values=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._matrixArr=[]}return Matrix4.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;return r=0===e.length?new this:new this(e[0])},Matrix4.prototype.push=function(){this._matrixArr.push(this.values)},Matrix4.prototype.pop=function(){this.values=this._matrixArr.pop()},Matrix4.prototype.set=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=this.values,n=null;if(1===e.length){var i=e[0];n=i.values}else n=[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]];return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],this},Matrix4.prototype.setIdentity=function(){var e=this.values;return e[0]=1,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=1,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1,this},Matrix4.prototype.invert=function(){var e,t,r,n,i,a,o,s,c,u,l,d,h,p,f,m,g,_,y,v,b,C,S,T,E,M,w,L,D,x;return x=this.values,e=x[0],t=x[1],r=x[2],n=x[3],i=x[4],a=x[5],o=x[6],s=x[7],c=x[8],u=x[9],l=x[10],d=x[11],h=x[12],p=x[13],f=x[14],m=x[15],g=e*a-t*i,_=e*o-r*i,y=e*s-n*i,v=t*o-r*a,b=t*s-n*a,C=r*s-n*o,S=c*p-u*h,T=c*f-l*h,E=c*m-d*h,M=u*f-l*p,w=u*m-d*p,L=l*m-d*f,D=1/(g*L-_*w+y*M+v*E-b*T+C*S),x[0]=(a*L-o*w+s*M)*D,x[1]=(-t*L+r*w-n*M)*D,x[2]=(p*C-f*b+m*v)*D,x[3]=(-u*C+l*b-d*v)*D,x[4]=(-i*L+o*E-s*T)*D,x[5]=(e*L-r*E+n*T)*D,x[6]=(-h*C+f*y-m*_)*D,x[7]=(c*C-l*y+d*_)*D,x[8]=(i*w-a*E+s*S)*D,x[9]=(-e*w+t*E-n*S)*D,x[10]=(h*b-p*y+m*g)*D,x[11]=(-c*b+u*y-d*g)*D,x[12]=(-i*M+a*T-o*S)*D,x[13]=(e*M-t*T+r*S)*D,x[14]=(-h*v+p*_-f*g)*D,x[15]=(c*v-u*_+l*g)*D,this},Matrix4.prototype.invertTo3x3=function(){var t,r,n,i,a,o,s,c,u,l,d,h,p,f=e.Matrix3.create();return l=this.values,d=f.values,t=l[10]*l[5]-l[6]*l[9],r=-l[10]*l[1]+l[2]*l[9],n=l[6]*l[1]-l[2]*l[5],i=-l[10]*l[4]+l[6]*l[8],a=l[10]*l[0]-l[2]*l[8],o=-l[6]*l[0]+l[2]*l[4],s=l[9]*l[4]-l[5]*l[8],c=-l[9]*l[0]+l[1]*l[8],u=l[5]*l[0]-l[1]*l[4],h=l[0]*t+l[1]*i+l[2]*s,0===h?(e.Log.warn("can't invert matrix, determinant is 0"),f):(p=1/h,d[0]=p*t,d[1]=p*r,d[2]=p*n,d[3]=p*i,d[4]=p*a,d[5]=p*o,d[6]=p*s,d[7]=p*c,d[8]=p*u,f)},Matrix4.prototype.transpose=function(){var e,t=this.values;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},Matrix4.prototype.setTranslate=function(e,t,r){var n=this.values;return n[0]=1,n[4]=0,n[8]=0,n[12]=e,n[1]=0,n[5]=1,n[9]=0,n[13]=t,n[2]=0,n[6]=0,n[10]=1,n[14]=r,n[3]=0,n[7]=0,n[11]=0,n[15]=1,this},Matrix4.prototype.translate=function(e,t,r){return this.applyMatrix(Matrix4.create().setTranslate(e,t,r)),this},Matrix4.prototype.setRotate=function(e,t,r,n){var i,a,o,s,c,u,l,d,h,p,f,m,e=Math.PI*e/180;return i=this.values,a=Math.sin(e),o=Math.cos(e),0!==t&&0===r&&0===n?(t<0&&(a=-a),i[0]=1,i[4]=0,i[8]=0,i[12]=0,i[1]=0,i[5]=o,i[9]=-a,i[13]=0,i[2]=0,i[6]=a,i[10]=o,i[14]=0,i[3]=0,i[7]=0,i[11]=0,i[15]=1):0===t&&0!==r&&0===n?(r<0&&(a=-a),i[0]=o,i[4]=0,i[8]=a,i[12]=0,i[1]=0,i[5]=1,i[9]=0,i[13]=0,i[2]=-a,i[6]=0,i[10]=o,i[14]=0,i[3]=0,i[7]=0,i[11]=0,i[15]=1):0===t&&0===r&&0!==n?(n<0&&(a=-a),i[0]=o,i[4]=-a,i[8]=0,i[12]=0,i[1]=a,i[5]=o,i[9]=0,i[13]=0,i[2]=0,i[6]=0,i[10]=1,i[14]=0,i[3]=0,i[7]=0,i[11]=0,i[15]=1):(s=Math.sqrt(t*t+r*r+n*n),1!==s&&(c=1/s,t*=c,r*=c,n*=c),u=1-o,l=t*r,d=r*n,h=n*t,p=t*a,f=r*a,m=n*a,i[0]=t*t*u+o,i[1]=l*u+m,i[2]=h*u-f,i[3]=0,i[4]=l*u-m,i[5]=r*r*u+o,i[6]=d*u+p,i[7]=0,i[8]=h*u+f,i[9]=d*u-p,i[10]=n*n*u+o,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1),this},Matrix4.prototype.rotate=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=e[0];if(2===e.length){var n=e[1];this.applyMatrix(Matrix4.create().setRotate(r,n.values[0],n.values[1],n.values[2]))}else if(4===e.length){var i=e[1],a=e[2],o=e[3];this.applyMatrix(Matrix4.create().setRotate(r,i,a,o))}return this},Matrix4.prototype.setScale=function(e,t,r){var n=this.values;return n[0]=e,n[4]=0,n[8]=0,n[12]=0,n[1]=0,n[5]=t,n[9]=0,n[13]=0,n[2]=0,n[6]=0,n[10]=r,n[14]=0,n[3]=0,n[7]=0,n[11]=0,n[15]=1,this},Matrix4.prototype.scale=function(e,t,r){return this.applyMatrix(Matrix4.create().setScale(e,t,r)),this},Matrix4.prototype.setLookAt=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n,i,a,o,s,c;3===t.length?(o=t[0],s=t[1],c=t[2]):9===t.length&&(o=e.Vector3.create(t[0],t[1],t[2]),s=e.Vector3.create(t[3],t[4],t[5]),c=e.Vector3.create(t[6],t[7],t[8])),n=e.Vector3.create(),a=o.clone().sub(s).normalize(),i=c.clone().normalize(),n.cross(i,a).normalize(),i.cross(a,n);var u=this.values;return u[0]=n.x,u[1]=n.y,u[2]=n.z,u[3]=0,u[4]=i.x,u[5]=i.y,u[6]=i.z,u[7]=0,u[8]=a.x,u[9]=a.y,u[10]=a.z,u[11]=0,u[12]=o.x,u[13]=o.y,u[14]=o.z,u[15]=1,this},Matrix4.prototype.lookAt=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=Matrix4.create();return this.applyMatrix(r.setLookAt.apply(r,e)),this},Matrix4.prototype.setOrtho=function(e,t,r,n,i,a){var o,s,c,u=this.values;return o=1/(t-e),s=1/(n-r),c=1/(a-i),u[0]=2*o,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*s,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=-2*c,u[11]=0,u[12]=-(t+e)*o,u[13]=-(n+r)*s,u[14]=-(a+i)*c,u[15]=1,this},Matrix4.prototype.ortho=function(e,t,r,n,i,a){return this.applyMatrix(Matrix4.create().setOrtho(e,t,r,n,i,a)),this},Matrix4.prototype.setPerspective=function(t,r,n,i){var a=null,o=null,s=null,c=null,t=Math.PI*t/180/2;return s=Math.sin(t),e.Log.error(0===s,e.Log.info.FUNC_MUST_NOT_BE("frustum","null")),o=1/(i-n),c=Math.cos(t)/s,a=this.values,a[0]=c/r,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=c,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-(i+n)*o,a[11]=-1,a[12]=0,a[13]=0,a[14]=-2*n*i*o,a[15]=0,this},Matrix4.prototype.perspective=function(e,t,r,n){return this.applyMatrix(Matrix4.create().setPerspective(e,t,r,n)),this},Matrix4.prototype.applyMatrix=function(e,t){void 0===t&&(t=!1);var r=this,n=e.clone();return t?n.multiply(r):(this.values=n.multiply(r).values,this)},Matrix4.prototype.multiply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null,n=null,i=null;i=this.values,1===e.length?(r=this.values,n=e[0].values):2===e.length&&(r=e[0].values,n=e[1].values);var a=r[0],o=r[1],s=r[2],c=r[3],u=r[4],l=r[5],d=r[6],h=r[7],p=r[8],f=r[9],m=r[10],g=r[11],_=r[12],y=r[13],v=r[14],b=r[15],C=n[0],S=n[1],T=n[2],E=n[3],M=n[4],w=n[5],L=n[6],D=n[7],x=n[8],A=n[9],O=n[10],R=n[11],I=n[12],B=n[13],F=n[14],P=n[15];return i[0]=C*a+S*u+T*p+E*_,i[1]=C*o+S*l+T*f+E*y,i[2]=C*s+S*d+T*m+E*v,i[3]=C*c+S*h+T*g+E*b,i[4]=M*a+w*u+L*p+D*_,i[5]=M*o+w*l+L*f+D*y,i[6]=M*s+w*d+L*m+D*v,i[7]=M*c+w*h+L*g+D*b,i[8]=x*a+A*u+O*p+R*_,i[9]=x*o+A*l+O*f+R*y,i[10]=x*s+A*d+O*m+R*v,i[11]=x*c+A*h+O*g+R*b,i[12]=I*a+B*u+F*p+P*_,i[13]=I*o+B*l+F*f+P*y,i[14]=I*s+B*d+F*m+P*v,i[15]=I*c+B*h+F*g+P*b,this},Matrix4.prototype.multiplyVector4=function(t){var r=this.values,n=t.values,i=[];return i[0]=n[0]*r[0]+n[1]*r[4]+n[2]*r[8]+n[3]*r[12],i[1]=n[0]*r[1]+n[1]*r[5]+n[2]*r[9]+n[3]*r[13],i[2]=n[0]*r[2]+n[1]*r[6]+n[2]*r[10]+n[3]*r[14],i[3]=n[0]*r[3]+n[1]*r[7]+n[2]*r[11]+n[3]*r[15],e.Vector4.create(i[0],i[1],i[2],i[3])},Matrix4.prototype.multiplyVector3=function(t){var r=this.values,n=t.values,i=[];return i[0]=n[0]*r[0]+n[1]*r[4]+n[2]*r[8],i[1]=n[0]*r[1]+n[1]*r[5]+n[2]*r[9],i[2]=n[0]*r[2]+n[1]*r[6]+n[2]*r[10],e.Vector3.create(i[0],i[1],i[2])},Matrix4.prototype.multiplyPoint=function(t){var r=this.values,n=t.values,i=[];return i[0]=n[0]*r[0]+n[1]*r[4]+n[2]*r[8]+r[12],i[1]=n[0]*r[1]+n[1]*r[5]+n[2]*r[9]+r[13],i[2]=n[0]*r[2]+n[1]*r[6]+n[2]*r[10]+r[14],e.Vector3.create(i[0],i[1],i[2])},Matrix4.prototype.clone=function(){var e=Matrix4.create(),t=0,r=this.values.length;for(t=0;t<r;t++)e.values[t]=this.values[t];return e},Matrix4.prototype.cloneToArray=function(e,t){void 0===t&&(t=0);for(var r=this.values,n=0;n<16;n++)e[t+n]=r[n];return this},Matrix4.prototype.getX=function(){return e.Vector3.create(this.values[0],this.values[1],this.values[2])},Matrix4.prototype.getY=function(){return e.Vector3.create(this.values[4],this.values[5],this.values[6])},Matrix4.prototype.getZ=function(){return e.Vector3.create(this.values[8],this.values[9],this.values[10])},Matrix4.prototype.getTranslation=function(){return e.Vector3.create(this.values[12],this.values[13],this.values[14])},Matrix4.prototype.getScale=function(){return e.Vector3.create(this.getX().length(),this.getY().length(),this.getZ().length())},Matrix4.prototype.getRotation=function(){return e.Quaternion.create().setFromMatrix(this)},Matrix4.prototype.getEulerAngles=function(){var t,r,n,i,a,o,s,c,u=this.getScale();return i=u.x,a=u.y,o=u.z,s=this.values,r=Math.asin(-s[2]/i),c=.5*Math.PI,r<c?r>-c?(t=Math.atan2(s[6]/a,s[10]/o),n=Math.atan2(s[1]/i,s[0]/i)):(n=0,t=-Math.atan2(s[4]/a,s[5]/a)):(n=0,t=Math.atan2(s[4]/a,s[5]/a)),e.Vector3.create(t,r,n).scale(e.RAD_TO_DEG)},Matrix4.prototype.setTRS=function(e,t,r){var n,i,a,o,s,c,u,l,d,h,p,f,m,g,_,y,v,b,C,S,T,E,M;return n=e.x,i=e.y,a=e.z,o=t.x,s=t.y,c=t.z,u=t.w,l=r.x,d=r.y,h=r.z,p=o+o,f=s+s,m=c+c,g=o*p,_=o*f,y=o*m,v=s*f,b=s*m,C=c*m,S=u*p,T=u*f,E=u*m,M=this.values,M[0]=(1-(v+C))*l,M[1]=(_+E)*l,M[2]=(y-T)*l,M[3]=0,M[4]=(_-E)*d,M[5]=(1-(g+C))*d,M[6]=(b+S)*d,M[7]=0,M[8]=(y+T)*h,M[9]=(b-S)*h,M[10]=(1-(g+v))*h,M[11]=0,M[12]=n,M[13]=i,M[14]=a,M[15]=1,this},__decorate([e.require(function(t,r,n,i){e.it("axis's component shouldn't all be zero",function(){e.expect(0===r&&0===n&&0===i).false})})],Matrix4.prototype,"setRotate",null),__decorate([e.require(function(t,r,n,i,a,o){e.assert(t!==r&&n!==i&&a!==o,e.Log.info.FUNC_MUST_NOT_BE("frustum","null"))})],Matrix4.prototype,"setOrtho",null),__decorate([e.require(function(t,r,n,i){e.assert(n!==i&&0!==r,e.Log.info.FUNC_MUST_NOT_BE("frustum","null")),e.assert(n>0,e.Log.info.FUNC_MUST("near","> 0")),e.assert(i>0,e.Log.info.FUNC_MUST("far","> 0"))})],Matrix4.prototype,"setPerspective",null),Matrix4}();e.Matrix4=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Matrix3(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.values=null,1===e.length?this.values=e[0]:this.values=new Float32Array([1,0,0,0,1,0,0,0,1])}return Matrix3.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;return r=0===e.length?new this:new this(e[0])},Object.defineProperty(Matrix3.prototype,"a",{get:function(){return this.values[0]},set:function(e){this.values[0]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"c",{get:function(){return this.values[1]},set:function(e){this.values[1]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"b",{get:function(){return this.values[3]},set:function(e){this.values[3]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"d",{get:function(){return this.values[4]},set:function(e){this.values[4]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"tx",{get:function(){return this.values[6]},set:function(e){this.values[6]=e},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"ty",{get:function(){return this.values[7]},set:function(e){this.values[7]=e},enumerable:!0,configurable:!0}),Matrix3.prototype.setIdentity=function(){var e=this.values;return e[0]=1,e[3]=0,e[6]=0,e[1]=0,e[4]=1,e[7]=0,e[2]=0,e[5]=0,e[8]=1,this},Matrix3.prototype.invert=function(){var e=this.values[0],t=this.values[1],r=this.values[3],n=this.values[4],i=this.values[6],a=this.values[7],o=e*n-t*r;return this.values[0]=n/o,this.values[1]=-t/o,this.values[3]=-r/o,this.values[4]=e/o,this.values[6]=(r*a-n*i)/o,this.values[7]=-(e*a-t*i)/o,this},Matrix3.prototype.multiplyScalar=function(e){var t=this.values;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},Matrix3.prototype.multiplyVector2=function(t){var r=t.x,n=t.y,i=e.Vector2.create(),a=this.values;return i.x=a[0]*r+a[3]*n,i.y=a[1]*r+a[4]*n,i},Matrix3.prototype.multiplyPoint=function(t){var r=t.x,n=t.y,i=e.Vector2.create(),a=this.values;return i.x=a[0]*r+a[3]*n+this.tx,i.y=a[1]*r+a[4]*n+this.ty,i},Matrix3.prototype.multiply=function(e){var t=this.a*e.a+this.c*e.b,r=this.b*e.a+this.d*e.b,n=this.a*e.c+this.c*e.d,i=this.b*e.c+this.d*e.d,a=this.a*e.tx+this.c*e.ty+this.tx,o=this.b*e.tx+this.d*e.ty+this.ty;return this.a=t,this.b=r,this.c=n,this.d=i,this.tx=a,this.ty=o,this},Matrix3.prototype.transpose=function(){var e,t=this.values;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},Matrix3.prototype.clone=function(){return Matrix3.create().set(this)},Matrix3.prototype.cloneToArray=function(e,t){void 0===t&&(t=0);for(var r=this.values,n=0;n<9;n++)e[t+n]=r[n];return this},Matrix3.prototype.set=function(e){var t=this.values,r=e.values;return t[0]=r[0],t[3]=r[3],t[6]=r[6],t[1]=r[1],t[4]=r[4],t[7]=r[7],t[2]=r[2],t[5]=r[5],t[8]=r[8],this},Matrix3.prototype.setTS=function(e,t){this.setPosition(e.x,e.y),this.setScale(t.x,t.y)},Matrix3.prototype.rotate=function(t){var r=t*e.DEG_TO_RAD,n=Math.cos(r),i=Math.sin(r),a=this.a*n+this.c*i,o=this.b*n+this.d*i,s=this.a*-i+this.c*n,c=this.b*-i+this.d*n;return this.a=a,this.b=o,this.c=s,this.d=c,this},Matrix3.prototype.setRotation=function(t){var r=t*e.DEG_TO_RAD,n=Math.cos(r),i=Math.sin(r),a=this.values;return a[0]=n,a[1]=-i,a[3]=i,a[4]=n,this},Matrix3.prototype.translate=function(e,t){this.tx+=this.a*e+this.c*t,this.ty+=this.b*e+this.d*t},Matrix3.prototype.setPosition=function(e,t){this.tx=e,this.ty=t},Matrix3.prototype.scale=function(e,t){return this.a*=e,this.b*=e,this.c*=t,this.d*=t,this},Matrix3.prototype.setScale=function(e,t){var r=this.values;return r[0]=e,r[4]=t,this},Matrix3.prototype.getTranslation=function(){return e.Vector2.create(this.tx,this.ty)},Matrix3.prototype.getScale=function(){return e.Vector2.create(Math.sqrt(this.a*this.a+this.b*this.b),Math.sqrt(this.c*this.c+this.d*this.d))},Matrix3.prototype.getRotation=function(){return this._getSkewX()},Matrix3.prototype.getSkew=function(){return e.Vector2.create(this._getSkewX(),this._getSkewY())},Matrix3.prototype._getDeltaTransformPoint=function(e,t){return{x:t.x*e.a+t.y*e.c+0,y:t.x*e.b+t.y*e.d+0}},Matrix3.prototype._getSkewX=function(){var e=this._getDeltaTransformPoint(this,{x:0,y:1});return 180/Math.PI*Math.atan2(e.y,e.x)-90},Matrix3.prototype._getSkewY=function(){var e=this._getDeltaTransformPoint(this,{x:1,y:0});return 180/Math.PI*Math.atan2(e.y,e.x)},Matrix3}();e.Matrix3=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Quaternion(e,t,r,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=1),this.x=null,this.y=null,this.z=null,this.w=null,this.x=e,this.y=t,this.z=r,this.w=n}return Quaternion.create=function(e,t,r,n){var i=new this(e,t,r,n);return i},Quaternion.prototype.setFromEulerAngles=function(t){var r,n,i,a,o,s,c,u=t.x,l=t.y,d=t.z;return c=.5*e.DEG_TO_RAD,u*=c,l*=c,d*=c,r=Math.sin(u),n=Math.cos(u),i=Math.sin(l),a=Math.cos(l),o=Math.sin(d),s=Math.cos(d),this.x=r*a*s-n*i*o,this.y=n*i*s+r*a*o,this.z=n*a*o-r*i*s,this.w=n*a*s+r*i*o,this},Quaternion.prototype.multiply=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r,n,i,a,o,s,c,u,l,d,h=this;return 1===e.length?(l=this,d=e[0]):2===e.length&&(l=e[0],d=e[1]),r=l.x,n=l.y,i=l.z,a=l.w,o=d.x,s=d.y,c=d.z,u=d.w,h.x=a*o+r*u+n*c-i*s,h.y=a*s+n*u+i*o-r*c,h.z=a*c+i*u+r*s-n*o,h.w=a*u-r*o-n*s-i*c,h},Quaternion.prototype.setFromMatrix=function(e){var t,r,n,i,a,o,s,c,u,l,d,h,p,f,m,g;return g=e.values,t=g[0],r=g[1],n=g[2],i=g[4],a=g[5],o=g[6],s=g[8],c=g[9],u=g[10],p=1/Math.sqrt(t*t+r*r+n*n),f=1/Math.sqrt(i*i+a*a+o*o),m=1/Math.sqrt(s*s+c*c+u*u),t*=p,r*=p,n*=p,i*=f,a*=f,o*=f,s*=m,c*=m,u*=m,l=t+a+u,l>=0?(d=Math.sqrt(l+1),this.w=.5*d,d=.5/d,this.x=(o-c)*d,this.y=(s-n)*d,this.z=(r-i)*d):t>a?t>u?(h=t-(a+u)+1,h=Math.sqrt(h),this.x=.5*h,h=.5/h,this.w=(o-c)*h,this.y=(r+i)*h,this.z=(n+s)*h):(h=u-(t+a)+1,h=Math.sqrt(h),this.z=.5*h,h=.5/h,this.w=(r-i)*h,this.x=(s+n)*h,this.y=(c+o)*h):a>u?(h=a-(u+t)+1,h=Math.sqrt(h),this.y=.5*h,h=.5/h,this.w=(s-n)*h,this.z=(o+c)*h,this.x=(i+r)*h):(h=u-(t+a)+1,h=Math.sqrt(h),this.z=.5*h,h=.5/h,this.w=(r-i)*h,this.x=(s+n)*h,this.y=(c+o)*h),this},Quaternion.prototype.setFromAxisAngle=function(t,r){var n,i;return r=r.normalize(),t*=.5*e.DEG_TO_RAD,n=Math.sin(t),i=Math.cos(t),this.x=n*r.x,this.y=n*r.y,this.z=n*r.z,this.w=i,this},Quaternion.prototype.invert=function(){return this.conjugate().normalize()},Quaternion.prototype.conjugate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},Quaternion.prototype.clone=function(){return Quaternion.create(this.x,this.y,this.z,this.w)},Quaternion.prototype.normalize=function(){var e=this.length();return 0===e?(this.x=this.y=this.z=0,this.w=1):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},Quaternion.prototype.length=function(){var e,t,r,n;return e=this.x,t=this.y,r=this.z,n=this.w,Math.sqrt(e*e+t*t+r*r+n*n)},Quaternion.prototype.multiplyVector3=function(t){var r=this,n=t.x,i=t.y,a=t.z,o=r.x,s=r.y,c=r.z,u=r.w,l=u*n+s*a-c*i,d=u*i+c*n-o*a,h=u*a+o*i-s*n,p=-o*n-s*i-c*a;return e.Vector3.create(l*u+p*-o+d*-c-h*-s,d*u+p*-s+h*-o-l*-c,h*u+p*-c+l*-s-d*-o)},Quaternion.prototype.set=function(e,t,r,n){this.x=e,this.y=t,this.z=r,this.w=n},Quaternion.prototype.sub=function(e){var t=e.clone().invert().multiply(this);return this.set(t.x,t.y,t.z,t.w),this},Quaternion.prototype.getEulerAngles=function(){var t,r,n,i,a,o,s,c;return i=this.x,a=this.y,o=this.z,s=this.w,c=2*(s*a-i*o),c<=-.99999?(t=2*Math.atan2(i,s),r=-Math.PI/2,n=0):c>=.99999?(t=2*Math.atan2(i,s),r=Math.PI/2,n=0):(t=Math.atan2(2*(s*i+a*o),1-2*(i*i+a*a)),r=Math.asin(c),n=Math.atan2(2*(s*o+i*a),1-2*(a*a+o*o))),e.Vector3.create(t,r,n).scale(e.RAD_TO_DEG)},Quaternion.prototype.slerp=function(e,t,r){var n,i,a=r,o=e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w,s=!1;if(o<0&&(s=!0,o=-o),o>.999999)i=1-a,n=s?-a:a;else{var c=Math.acos(o),u=1/Math.sin(c);i=Math.sin((1-a)*c)*u,n=s?-Math.sin(a*c)*u:Math.sin(a*c)*u}return Quaternion.create(i*e.x+n*t.x,i*e.y+n*t.y,i*e.z+n*t.z,i*e.w+n*t.w)},Quaternion}();e.Quaternion=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Plane(t,r,n,i){this.normal=e.Vector3.create(0,1,0),this.d=0,this.normal=e.Vector3.create(t,r,n),this.d=i}return Plane.create=function(e,t,r,n){var i=new this(e,t,r,n);return i},Plane.prototype.getReflectionMatrix=function(){this.normalize();var t=this.normal.x,r=this.normal.y,n=this.normal.z,i=-2*t,a=-2*r,o=-2*n,s=e.Matrix4.create();return s.values[0]=i*t+1,s.values[1]=a*t,s.values[2]=o*t,s.values[3]=0,s.values[4]=i*r,s.values[5]=a*r+1,s.values[6]=o*r,s.values[7]=0,s.values[8]=i*n,s.values[9]=a*n,s.values[10]=o*n+1,s.values[11]=0,s.values[12]=i*this.d,s.values[13]=a*this.d,s.values[14]=o*this.d,s.values[15]=1,s},Plane.prototype.normalize=function(){var e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),t=0;return 0!==e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this},Plane.prototype.clone=function(){return Plane.create(this.normal.x,this.normal.y,this.normal.z,this.d)},Plane.prototype.dotCoordinate=function(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d},Plane}();e.Plane=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Ray(e,t){this._origin=null,this._direction=null,this._origin=e,this._direction=t}return Ray.create=function(e,t){var r=new this(e,t);return r},Ray.prototype.isIntersectWithAABB=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null,a=e.Vector3.create(),o=null,s=null,c=e.Vector3.create(),u=e.Vector3.create(),l=this._origin,d=this._direction;if(1===t.length){var h=t[0];n=h.center,i=h.halfExtents}else if(2===t.length){var p=t[0],f=t[1];n=e.AABBShape.getCenter(p,f),i=e.AABBShape.getHalfExtents(p,f)}return a.sub2(l,n),o=e.Vector3.create(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z)),u.mul2(a,d),!(o.x>i.x&&u.x>=0)&&(!(o.y>i.y&&u.y>=0)&&(!(o.z>i.z&&u.z>=0)&&(s=e.Vector3.create(Math.abs(d.x),Math.abs(d.y),Math.abs(d.z)),c.cross(d,a),c.set(Math.abs(c.x),Math.abs(c.y),Math.abs(c.z)),!(c.x>i.y*s.z+i.z*s.y)&&(!(c.y>i.x*s.z+i.z*s.x)&&!(c.z>i.x*s.y+i.y*s.x)))))},Ray.prototype.isIntersectWithSphere=function(t){var r=t.center,n=t.radius,i=e.Vector3.create(),a=0,o=0,s=0,c=0,u=this._origin,l=this._direction;return i.sub2(u,r),i.dot(i)<n*n||(a=l.dot(l),o=2*l.dot(i),s=r.dot(r),s+=u.dot(u),s-=2*r.dot(u),s-=n*n,c=o*o-4*a*s,!(c<0))},Ray}();e.Ray=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Entity(){this.uid=null,this._tagList=wdCb.Collection.create(),this.uid=Entity._count,Entity._count+=1}return Entity.prototype.addTag=function(e){this._tagList.addChild(e)},Entity.prototype.removeTag=function(e){this._tagList.removeChild(e)},Entity.prototype.getTagList=function(){return this._tagList},Entity.prototype.hasTag=function(e){return this._tagList.hasChild(e)},Entity.prototype.containTag=function(e){return this._tagList.hasChildWithFunc(function(t){return t.indexOf(e)>-1})},Entity._count=1,Entity}();e.Entity=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Component(){t.apply(this,arguments),this.entityObject=null}return __extends(Component,t),Component.prototype.init=function(){},Component.prototype.dispose=function(){},
Component.prototype.clone=function(){return e.CloneUtils.clone(this)},Object.defineProperty(Component.prototype,"transform",{get:function(){return this.entityObject?this.entityObject.transform:null},enumerable:!0,configurable:!0}),Component.prototype.addToObject=function(e,t){void 0===t&&(t=!1),t||(this.entityObject&&this.entityObject.removeComponent(this),this.entityObject=e)},Component.prototype.removeFromObject=function(e){},__decorate([e.virtual],Component.prototype,"init",null),__decorate([e.virtual],Component.prototype,"dispose",null),__decorate([e.virtual],Component.prototype,"clone",null),__decorate([e.virtual],Component.prototype,"addToObject",null),__decorate([e.virtual],Component.prototype,"removeFromObject",null),Component}(e.Entity);e.Component=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Scheduler(){this._scheduleCount=0,this._schedules=wdCb.Hash.create()}return Scheduler.create=function(){var e=new this;return e},Scheduler.prototype.update=function(e){var t=this;this._schedules.forEach(function(r,n){r.isStop||r.isPause||(r.update(e),r.isFinish&&t.remove(n))})},Scheduler.prototype.scheduleLoop=function(e,t){return void 0===t&&(t=[]),this._schedule(a,Array.prototype.slice.call(arguments,0))},Scheduler.prototype.scheduleFrame=function(e,t,r){return void 0===t&&(t=1),this._schedule(o,Array.prototype.slice.call(arguments,0))},Scheduler.prototype.scheduleInterval=function(e,t,r){return void 0===t&&(t=0),this._schedule(i,Array.prototype.slice.call(arguments,0))},Scheduler.prototype.scheduleTime=function(e,t,r){return void 0===t&&(t=0),this._schedule(n,Array.prototype.slice.call(arguments,0))},Scheduler.prototype.pause=function(e){if(0===arguments.length){var t=this;this._schedules.forEach(function(e,r){t.pause(r)})}else if(1===arguments.length){var r=this._schedules.getChild(arguments[0]);r.pause()}},Scheduler.prototype.resume=function(e){if(0===arguments.length){var t=this;this._schedules.forEach(function(e,r){t.resume(r)})}else if(1===arguments.length){var r=this._schedules.getChild(arguments[0]);r.resume()}},Scheduler.prototype.start=function(e){if(0===arguments.length){var t=this;this._schedules.forEach(function(e,r){t.start(r)})}else if(1===arguments.length){var r=this._schedules.getChild(arguments[0]);r.start()}},Scheduler.prototype.stop=function(e){if(0===arguments.length){var t=this;this._schedules.forEach(function(e,r){t.stop(r)})}else if(1===arguments.length){var r=this._schedules.getChild(arguments[0]);r.stop()}},Scheduler.prototype.has=function(e){return!!this._schedules.hasChild(e)},Scheduler.prototype.remove=function(e){this._schedules.removeChild(e)},Scheduler.prototype.removeAll=function(){this._schedules.removeAllChildren()},Scheduler.prototype._schedule=function(e,t){var r=this._buildId();return this._schedules.setValue(r,e.create.apply(e,t)),r},Scheduler.prototype._buildId=function(){return"Schedule_"+this._scheduleCount++},Scheduler}();e.Scheduler=t;var r=function(){function ScheduleItem(t,r){this.isPause=!1,this.isStop=!1,this.pauseTime=null,this.pauseElapsed=null,this.startTime=null,this.isFinish=!1,this.task=null,this.args=null,this.timeController=e.CommonTimeController.create(),this.task=t,this.args=r}return ScheduleItem.prototype.pause=function(){this.isPause=!0,this.timeController.pause()},ScheduleItem.prototype.resume=function(){this.isPause=!1,this.timeController.resume()},ScheduleItem.prototype.start=function(){this.isStop=!1,this.timeController.start()},ScheduleItem.prototype.stop=function(){this.isStop=!0,this.timeController.stop()},ScheduleItem.prototype.finish=function(){this.isFinish=!0},ScheduleItem}(),n=function(e){function TimeScheduleItem(t,r,n){void 0===r&&(r=0),void 0===n&&(n=[]),e.call(this,t,n),this._time=null,this._time=r}return __extends(TimeScheduleItem,e),TimeScheduleItem.create=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=[]);var n=new this(e,t,r);return n},TimeScheduleItem.prototype.update=function(e){var e=this.timeController.computeElapseTime(e);e>=this._time&&(this.task.apply(this,this.args),this.finish())},TimeScheduleItem}(r),i=function(e){function IntervalScheduleItem(t,r,n){void 0===r&&(r=0),void 0===n&&(n=[]),e.call(this,t,n),this._intervalTime=null,this._elapsed=0,this._intervalTime=r}return __extends(IntervalScheduleItem,e),IntervalScheduleItem.create=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=[]);var n=new this(e,t,r);return n},IntervalScheduleItem.prototype.update=function(e){var e=this.timeController.computeElapseTime(e);e-this._elapsed>=this._intervalTime&&(this.task.apply(this,this.args),this._elapsed=e)},IntervalScheduleItem.prototype.start=function(){e.prototype.start.call(this),this._elapsed=0},IntervalScheduleItem}(r),a=function(e){function LoopScheduleItem(){e.apply(this,arguments)}return __extends(LoopScheduleItem,e),LoopScheduleItem.create=function(e,t){void 0===t&&(t=[]);var r=new this(e,t);return r},LoopScheduleItem.prototype.update=function(e){this.task.apply(this,this.args)},LoopScheduleItem}(r),o=function(e){function FrameScheduleItem(t,r,n){void 0===r&&(r=1),void 0===n&&(n=[]),e.call(this,t,n),this._frame=null,this._frame=r}return __extends(FrameScheduleItem,e),FrameScheduleItem.create=function(e,t,r){void 0===t&&(t=1),void 0===r&&(r=[]);var n=new this(e,t,r);return n},FrameScheduleItem.prototype.update=function(e){this._frame--,this._frame<=0&&(this.task.apply(this,this.args),this.finish())},FrameScheduleItem}(r)}(wd||(wd={}));var wd;!function(e){var t;!function(e){e[e.NORMAL=0]="NORMAL",e[e.STOP=1]="STOP",e[e.PAUSE=2]="PAUSE"}(t||(t={}));var r=function(){function Director(){this.scene=null,this.scheduler=null,this.renderer=null,this.domEventManager=e.DomEventManager.create(),this._gameLoop=null,this._eventSubscription=null,this._gameState=t.NORMAL,this._timeController=e.DirectorTimeController.create()}return Director.getInstance=function(){},Object.defineProperty(Director.prototype,"gameTime",{get:function(){return this._timeController.gameTime},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"fps",{get:function(){return this._timeController.fps},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"isNormal",{get:function(){return this._gameState===t.NORMAL},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"isStop",{get:function(){return this._gameState===t.STOP},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"isPause",{get:function(){return this._gameState===t.PAUSE},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"isTimeChange",{get:function(){return this._timeController.isTimeChange},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"elapsed",{get:function(){return this._timeController.elapsed},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"view",{get:function(){return e.DeviceManager.getInstance().view},enumerable:!0,configurable:!0}),Director.prototype.initWhenCreate=function(){this.scene=e.SceneDispatcher.create(),this.scheduler=e.Scheduler.create(),this.renderer=e.WebGLRenderer.create()},Director.prototype.start=function(){this._gameState=t.NORMAL,this._startLoop()},Director.prototype.stop=function(){this._gameLoop&&this._gameLoop.dispose(),this._gameState=t.STOP,this._timeController.stop(),this.scheduler.stop(),this._eventSubscription&&this._eventSubscription.dispose()},Director.prototype.pause=function(){this._gameState!==t.PAUSE&&(this._gameState=t.PAUSE,this._timeController.pause(),this.scheduler.pause())},Director.prototype.resume=function(){this._gameState=t.NORMAL,this._timeController.resume(),this.scheduler.resume()},Director.prototype.getDeltaTime=function(){return this._timeController.deltaTime},Director.prototype.initUIObjectScene=function(){var e=this.scene.uiObjectScene;this._initDomEvent(),e.onEnter(),e.init()},Director.prototype.runUIObjectScene=function(t){var r=this.scene.uiObjectScene;e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.STARTLOOP)),e.ScriptEngine.getInstance().execScript("onStartLoop"),r.update(t),r.render(),e.ScriptEngine.getInstance().execScript("onEndLoop"),e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.ENDLOOP))},Director.prototype._startLoop=function(){var e=this;this._gameLoop=this._buildInitStream().ignoreElements().concat(this._buildLoopStream()).subscribe(function(t){e._loopBody(t)})},Director.prototype._buildInitStream=function(){var e=this;return wdFrp.callFunc(function(){e._init()},this)},Director.prototype._init=function(){this._initGameObjectScene(),this.initUIObjectScene(),e.DebugStatistics.init()},Director.prototype._initGameObjectScene=function(){var e=this.scene.gameObjectScene;this._initDomEvent(),e.onEnter(),e.init(),this.renderer.init(),this._timeController.start(),this.scheduler.start()},Director.prototype._buildLoopStream=function(){return wdFrp.intervalRequest()},Director.prototype._loopBody=function(e){var r=null;return this._gameState!==t.PAUSE&&this._gameState!==t.STOP&&(r=this._timeController.computeElapseTime(e),this._run(r),!0)},Director.prototype._run=function(t){this._timeController.tick(t),e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.STARTLOOP)),e.ScriptEngine.getInstance().execScript("onStartLoop"),this._update(t),this._render(),e.ScriptEngine.getInstance().execScript("onEndLoop"),e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.ENDLOOP))},Director.prototype._update=function(t){this.scheduler.update(t),e.ScriptEngine.getInstance().execScriptWithData("update",t),e.ActionEngine.getInstance().update(t),this.scene.gameObjectScene.update(t),this.scene.uiObjectScene.update(t)},Director.prototype._render=function(){this.scene.gameObjectScene.render(this.renderer),this.renderer.clear(),this.renderer.hasCommand()&&(this.renderer.webglState=e.BasicState.create(),this.renderer.render()),this.scene.uiObjectScene.render()},Director.prototype._initDomEvent=function(){this._eventSubscription=this.domEventManager.initDomEvent()},__decorate([e.execOnlyOnce("_isInitUIScene")],Director.prototype,"initUIObjectScene",null),__decorate([e.execOnlyOnce("_isInitDomEvent")],Director.prototype,"_initDomEvent",null),Director=__decorate([e.singleton(!0)],Director)}();e.Director=r}(wd||(wd={}));var wd;!function(e){var t=function(){function Main(){}return Object.defineProperty(Main,"isTest",{get:function(){return this._isTest},set:function(e){this._isTest=e,wdFrp.Main.isTest=e},enumerable:!0,configurable:!0}),Main.setConfig=function(t){var r=t.canvasId,n=void 0===r?null:r,i=t.isTest,a=void 0===i?e.DebugConfig.isTest:i,o=t.screenSize,s=void 0===o?e.EScreenSize.FULL:o,c=t.useDevicePixelRatio,u=void 0!==c&&c,l=t.contextConfig,d=void 0===l?{options:{alpha:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1}}:l;return this.isTest=a,this.screenSize=s,this._canvasId=n,this._useDevicePixelRatio=u,this._contextConfig={options:wdCb.ExtendUtils.extend({alpha:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1},d.options)},this},Main.init=function(){return e.DeviceManager.getInstance().createGL(this._canvasId,this._contextConfig,this._useDevicePixelRatio),e.DeviceManager.getInstance().setScreen(),e.GPUDetector.getInstance().detect(),this},Main._isTest=!1,Main.screenSize=null,Main._canvasId=null,Main._contextConfig=null,Main._useDevicePixelRatio=null,Main}();e.Main=t}(wd||(wd={}));var wd;!function(e){var t=function(){function DomEventManager(){this.designatedTriggerList=null,this._lastTriggerList=null,this._isDragEventTriggering=!1,this._triggerListOfDragEvent=null}return DomEventManager.create=function(){var e=new this;return e},Object.defineProperty(DomEventManager.prototype,"scene",{get:function(){return e.Director.getInstance().scene},enumerable:!0,configurable:!0}),DomEventManager.prototype.initDomEvent=function(){var t=this;return wdFrp.fromArray([e.EventManager.fromEvent(e.EEventName.CLICK),e.EventManager.fromEvent(e.EEventName.MOUSEDOWN),e.EventManager.fromEvent(e.EEventName.MOUSEUP),e.EventManager.fromEvent(e.EEventName.MOUSEWHEEL),this._buildMouseDragStream()]).mergeAll().filter(function(t){return!e.Director.getInstance().isPause}).map(function(e){var r=t._getMouseEventTriggerList(e);return t._isDragEventTriggering&&(t._triggerListOfDragEvent=r),t._getMouseEventTriggerListData(e,r)}).merge(this._buildMouseMoveStream()).subscribe(function(e){var r=e[0],n=e[1];r.forEach(function(e){t._trigger(n.clone(),e)})})},DomEventManager.prototype._buildMouseDragStream=function(){var t=this;return e.EventManager.fromEvent(document,e.EEventName.MOUSEDOWN).flatMap(function(r){return e.EventManager.fromEvent(document,e.EEventName.MOUSEMOVE).takeUntil(e.EventManager.fromEvent(document,e.EEventName.MOUSEUP).do(function(e){t._isDragEventTriggering=!1}))}).map(function(r){return r.name=e.EEventName.MOUSEDRAG,t._isDragEventTriggering=!0,r})},DomEventManager.prototype._buildMouseMoveStream=function(){var t=this;return e.EventManager.fromEvent(e.EEventName.MOUSEMOVE).filter(function(t){return!e.Director.getInstance().isPause}).map(function(e){var r=null;r=t.designatedTriggerList?t.designatedTriggerList:t._isDragEventTriggering?t._triggerListOfDragEvent:t._getMouseEventTriggerList(e);var n=t._getMouseOverAndMouseOutObject(r,t._lastTriggerList),i=n.mouseoverObjects,a=n.mouseoutObjects;return t._setMouseOverTag(i),t._setMouseOutTag(a),t._lastTriggerList=r.clone(),r=a.addChildren(r),t._getMouseEventTriggerListData(e,r)})},DomEventManager.prototype._getMouseOverAndMouseOutObject=function(t,r){var n=wdCb.Collection.create(),i=wdCb.Collection.create();return r?(r.forEach(function(r){t.hasChildWithFunc(function(t){return e.JudgeUtils.isEqual(t,r)})||i.addChild(r)}),t.forEach(function(t){r.hasChildWithFunc(function(r){return e.JudgeUtils.isEqual(t,r)})||n.addChild(t)})):n=t,{mouseoverObjects:n,mouseoutObjects:i}},DomEventManager.prototype._setMouseOverTag=function(e){e.forEach(function(e){e.addTag(r.MOUSE_OVER)})},DomEventManager.prototype._setMouseOutTag=function(e){e.forEach(function(e){e.addTag(r.MOUSE_OUT)})},DomEventManager.prototype._setEventNameByEventTag=function(t,n){return t.hasTag(r.MOUSE_OVER)?n.name=e.EEventName.MOUSEOVER:t.hasTag(r.MOUSE_OUT)&&(n.name=e.EEventName.MOUSEOUT),n},DomEventManager.prototype._removeEventTag=function(e){e.removeTag(r.MOUSE_OVER),e.removeTag(r.MOUSE_OUT)},DomEventManager.prototype._trigger=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=t[1],a=!1,o=null,s=null,c=null;3===t.length&&t[2]?(a=!0,o=n):(o=this._setEventNameByEventTag(i,n),this._removeEventTag(i)),c=e.EventTriggerTable.getScriptHandlerName(o.name),s=e.CustomEvent.create(e.EEngineEvent[e.EventTriggerTable.getScriptEngineEvent(o.name)]),s.getDataFromDomEvent(o),e.EventManager.trigger(i,s,o,a),o.getDataFromCustomEvent(s),e.ScriptEngine.getInstance().execEntityObjectEventScriptWithData(i,c,o),!o.isStopPropagation&&i.bubbleParent&&this._trigger(o.clone(),i.bubbleParent,!0)},DomEventManager.prototype._getMouseEventTriggerList=function(e){var t=null,r=null,n=null;return this.designatedTriggerList?this.designatedTriggerList:(n=wdCb.Collection.create(),t=this._findTopGameObject(e,this.scene.gameObjectScene),r=this._findTopUIObject(e,this.scene.uiObjectScene),t&&n.addChild(t),r&&n.addChild(r),this._isSceneAsTopOne(e,n)&&n.addChild(this.scene),n)},DomEventManager.prototype._isSceneAsTopOne=function(e,t){return this._isTriggerScene(e)&&0===t.getCount()},DomEventManager.prototype._findTopGameObject=function(e,t){var r=this;return this._findTriggerGameObjectList(e,t).sort(function(e,t){return r._getDistanceToCamera(e)-r._getDistanceToCamera(t)}).getChild(0)},DomEventManager.prototype._getDistanceToCamera=function(t){return t.transform.position.clone().sub(e.Director.getInstance().scene.currentCamera.transform.position).length()},DomEventManager.prototype._findTopUIObject=function(e,t){return this._findTriggerUIObjectList(e,t).sort(function(e,t){return t.transform.zIndex-e.transform.zIndex}).getChild(0)},DomEventManager.prototype._findTriggerGameObjectList=function(t,r){var n=wdCb.Collection.create(),i=this,a=function(r){r.hasComponent(e.SpacePartition)?r.getSpacePartition().getIntersectListWithRay(t).forEach(function(e){i._addTriggerObjectByQueryDetector(e,t,n)}):(i._addTriggerObjectByQueryDetector(r,t,n),r.forEach(function(e){a(e)}))};return r.forEach(function(e){a(e)}),n},DomEventManager.prototype._findTriggerUIObjectList=function(e,t){var r=wdCb.Collection.create(),n=this,i=function(t){n._addTriggerObjectByQueryDetector(t,e,r),t.forEach(function(e){i(e)})};return t.forEach(function(e){i(e)}),r},DomEventManager.prototype._addTriggerObjectByQueryDetector=function(t,r,n){if(t.hasComponent(e.EventTriggerDetector)){var i=t.getComponent(e.EventTriggerDetector);i.isTrigger(r)&&n.addChild(t)}},DomEventManager.prototype._isTriggerScene=function(t){var r=this.scene.getComponent(e.EventTriggerDetector);return r.isTrigger(t)},DomEventManager.prototype._getMouseEventTriggerListData=function(e,t){return[t,e]},DomEventManager}();e.DomEventManager=t;var r;!function(e){e[e.MOUSE_OVER="MOUSE_OVER"]="MOUSE_OVER",e[e.MOUSE_OUT="MOUSE_OUT"]="MOUSE_OUT"}(r||(r={}))}(wd||(wd={}));var wd;!function(e){var t=function(t){function EntityObject(){t.apply(this,arguments),this._bubbleParent=null,this.name=null,this.parent=null,this.isVisible=!0,this.scriptManager=e.ScriptManager.create(this),this.componentManager=e.ComponentManager.create(this),this._hasComponentCache=wdCb.Hash.create(),this._getComponentCache=wdCb.Hash.create(),this._componentChangeSubscription=null,this._entityObjectManager=e.EntityObjectManager.create(this)}return __extends(EntityObject,t),Object.defineProperty(EntityObject.prototype,"bubbleParent",{get:function(){return this._bubbleParent?this._bubbleParent:this.parent},set:function(e){this._bubbleParent=e},enumerable:!0,configurable:!0}),Object.defineProperty(EntityObject.prototype,"componentDirty",{set:function(e){e===!0&&this.clearCache()},enumerable:!0,configurable:!0}),Object.defineProperty(EntityObject.prototype,"transform",{get:function(){return this.componentManager.transform},enumerable:!0,configurable:!0}),EntityObject.prototype.initWhenCreate=function(){this.addComponent(this.createTransform())},EntityObject.prototype.clone=function(t){void 0===t&&(t={});var r=null;return e.CloneUtils.isNotClone(this)?null:(t=wdCb.ExtendUtils.extend({cloneChildren:!0,shareGeometry:!1,cloneGeometry:!0},t),r=e.CloneUtils.clone(this),this.forEachComponent(function(n){if(t.cloneGeometry||!(n instanceof e.Geometry))return t.shareGeometry&&n instanceof e.Geometry?void r.addComponent(n,!0):void r.addComponent(n.clone())}),t.cloneChildren&&this._cloneChildren(r),r)},EntityObject.prototype.init=function(){var t=this;return this._componentChangeSubscription=e.EventManager.fromEvent(this,e.EEngineEvent.COMPONENT_CHANGE).subscribe(function(){t._onComponentChange()}),this.componentManager.init(),this._entityObjectManager.init(),this.afterInitChildren(),this},EntityObject.prototype.onEnter=function(){e.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"onEnter"),e.EventManager.trigger(this,e.CustomEvent.create(e.EEngineEvent.ENTER))},EntityObject.prototype.onExit=function(){e.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"onExit"),e.EventManager.trigger(this,e.CustomEvent.create(e.EEngineEvent.EXIT))},EntityObject.prototype.onDispose=function(){e.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"onDispose")},EntityObject.prototype.dispose=function(){this.onDispose(),this.parent&&(this.parent.removeChild(this),this.parent=null),e.EventManager.off(this),this._componentChangeSubscription&&this._componentChangeSubscription.dispose(),this.componentManager.dispose(),this._entityObjectManager.dispose()},EntityObject.prototype.hasChild=function(e){return this._entityObjectManager.hasChild(e)},EntityObject.prototype.addChild=function(e){return this._entityObjectManager.addChild(e),e.transform.parent=this.transform,this},EntityObject.prototype.addChildren=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return this._entityObjectManager.addChildren(e[0]),this},EntityObject.prototype.forEach=function(e){return this._entityObjectManager.forEach(e),this},EntityObject.prototype.filter=function(e){return this._entityObjectManager.filter(e)},EntityObject.prototype.sort=function(e,t){return void 0===t&&(t=!1),this._entityObjectManager.sort(e,t)},EntityObject.prototype.getChildren=function(){return this._entityObjectManager.getChildren()},EntityObject.prototype.getChild=function(e){return this._entityObjectManager.getChild(e)},EntityObject.prototype.findChildByUid=function(e){return this._entityObjectManager.findChildByUid(e)},EntityObject.prototype.findChildByTag=function(e){return this._entityObjectManager.findChildByTag(e)},EntityObject.prototype.findChildByName=function(e){return this._entityObjectManager.findChildByName(e)},EntityObject.prototype.findChildrenByName=function(e){return this._entityObjectManager.findChildrenByName(e)},EntityObject.prototype.removeChild=function(e){return this._entityObjectManager.removeChild(e),this},EntityObject.prototype.removeAllChildren=function(){this._entityObjectManager.removeAllChildren()},EntityObject.prototype.getComponent=function(e){return this.componentManager.getComponent(e)},EntityObject.prototype.getComponents=function(){return this.componentManager.getComponents()},EntityObject.prototype.findComponentByUid=function(e){return this.componentManager.findComponentByUid(e)},EntityObject.prototype.forEachComponent=function(e){return this.componentManager.forEachComponent(e),this},EntityObject.prototype.hasComponent=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=this._getHasComponentCacheKey(e[0]),n=this._hasComponentCache.getChild(r);return void 0!==n?n:(n=this.componentManager.hasComponent(e[0]),this._hasComponentCache.addChild(r,n),n)},EntityObject.prototype.addComponent=function(e,t){return void 0===t&&(t=!1),this.componentManager.addComponent(e,t),this.componentDirty=!0,this},EntityObject.prototype.removeComponent=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return this.componentManager.removeComponent(e[0]),this.componentDirty=!0,this},EntityObject.prototype.removeAllComponent=function(){return this.componentDirty=!0,this.componentManager.removeAllComponent()},EntityObject.prototype.render=function(e,t){var r=null;r=this.componentManager.getRendererComponent(),r&&r.render(e,this,t),this.getRenderList().forEach(function(r){r.render(e,t)})},EntityObject.prototype.update=function(e){this.forEach(function(t){t.update(e)})},EntityObject.prototype.getComponentCount=function(e){return this.componentManager.getComponentCount(e)},EntityObject.prototype.getGeometry=function(){return this.componentManager.getGeometry()},EntityObject.prototype.afterInitChildren=function(){},EntityObject.prototype.getRenderList=function(){return this.getChildren()},EntityObject.prototype.getAllChildren=function(){return this._entityObjectManager.getAllChildren()},EntityObject.prototype.clearCache=function(){this._hasComponentCache.removeAllChildren(),this._getComponentCache.removeAllChildren()},EntityObject.prototype._getHasComponentCacheKey=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(e.JudgeUtils.isComponenet(t[0])){var n=t[0];return String(n.uid)}var i=t[0];return i.name},EntityObject.prototype._onComponentChange=function(){this.clearCache()},EntityObject.prototype._cloneChildren=function(e){this.forEach(function(t){var r=t.clone();null!==r&&e.addChild(r)})},__decorate([e.cloneAttributeAsBasicType()],EntityObject.prototype,"bubbleParent",null),__decorate([e.cloneAttributeAsBasicType()],EntityObject.prototype,"name",void 0),__decorate([e.cloneAttributeAsBasicType()],EntityObject.prototype,"parent",void 0),__decorate([e.cloneAttributeAsBasicType()],EntityObject.prototype,"isVisible",void 0),__decorate([e.virtual],EntityObject.prototype,"initWhenCreate",null),__decorate([e.require(function(t){var r=this;void 0===t&&(t={}),e.it("if has OneToManySourceInstance component, not support share geometry",function(){t.shareGeometry&&e.expect(r.hasComponent(e.OneToManySourceInstance)).false})})],EntityObject.prototype,"clone",null),__decorate([e.cache(function(e){return this._getComponentCache.hasChild(e.name)},function(e){return this._getComponentCache.getChild(e.name)},function(e,t){this._getComponentCache.addChild(t.name,e)})],EntityObject.prototype,"getComponent",null),__decorate([e.virtual],EntityObject.prototype,"render",null),__decorate([e.virtual],EntityObject.prototype,"getGeometry",null),__decorate([e.virtual],EntityObject.prototype,"afterInitChildren",null),__decorate([e.virtual],EntityObject.prototype,"getRenderList",null),__decorate([e.ensure(function(t){e.it("key:"+t+" be string",function(){e.expect(e.JudgeUtils.isString(t)).true})})],EntityObject.prototype,"_getHasComponentCacheKey",null),EntityObject}(e.Entity);e.EntityObject=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ComponentManager(e){this.transform=null,this._entityObject=null,this._components=wdCb.Collection.create(),this._rendererComponent=null,this._collider=null,this._geometry=null,this._entityObject=e}return ComponentManager.create=function(e){var t=new this(e);return t},ComponentManager.prototype.init=function(){for(var t=0,r=e.SortUtils.insertSort(this._components.getChildren(),function(t,r){return e.ComponentInitOrderTable.getOrder(t)<e.ComponentInitOrderTable.getOrder(r)});t<r.length;t++){var n=r[t];n.init()}},ComponentManager.prototype.dispose=function(){var e=this.removeAllComponent();e.forEach(function(e){e.dispose()}),this._components.removeAllChildren()},ComponentManager.prototype.removeAllComponent=function(){var e=this,t=wdCb.Collection.create();return this._components.forEach(function(r){e._removeComponentHandler(r),t.addChild(r)},this),t},ComponentManager.prototype.getComponent=function(e){return this._components.findOne(function(t){return t instanceof e})},ComponentManager.prototype.getComponents=function(){return this._components},ComponentManager.prototype.findComponentByUid=function(e){return this._components.findOne(function(t){return t.uid===e})},ComponentManager.prototype.forEachComponent=function(e){return this._components.forEach(e),this},ComponentManager.prototype.hasComponent=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;if(e.JudgeUtils.isComponenet(t[0])){var i=t[0];n=this._components.hasChild(i)}else{var a=t[0];n=this._components.hasChildWithFunc(function(e){return e instanceof a})}return n},ComponentManager.prototype.addComponent=function(t,r){if(void 0===r&&(r=!1),t)return t instanceof e.RendererComponent?this._rendererComponent=t:t instanceof e.Collider?this._collider=t:t instanceof e.Geometry?this._geometry=t:t instanceof e.Transform&&(this.transform&&this.removeComponent(this.transform),this.transform=t),t.addToObject(this._entityObject,r),this._components.addChild(t),this},ComponentManager.prototype.removeComponent=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;return n=t[0]instanceof e.Component?t[0]:this.getComponent(t[0]),n&&(this._components.removeChild(n),this._removeComponentHandler(n)),this},ComponentManager.prototype.getComponentCount=function(e){return this._components.filter(function(t){return t instanceof e}).getCount()},ComponentManager.prototype.getGeometry=function(){return this._geometry},ComponentManager.prototype.getRendererComponent=function(){return this._rendererComponent},ComponentManager.prototype.getCollider=function(){return this._collider},ComponentManager.prototype._removeComponentHandler=function(e){e.removeFromObject(this._entityObject)},__decorate([e.require(function(t,r){var n=this;void 0===r&&(r=!1),t&&e.it("should not add the component which is already added",function(){e.expect(n.hasComponent(t)).false})})],ComponentManager.prototype,"addComponent",null),__decorate([e.require(function(){var t=this;e.it("entityObject shouldn't contain more than 1 geometry component",function(){e.expect(t.getComponentCount(e.Geometry)).lessThan(2)})})],ComponentManager.prototype,"getGeometry",null),__decorate([e.require(function(){var t=this;e.it("entityObject shouldn't contain more than 1 rendererComponent",function(){e.expect(t.getComponentCount(e.RendererComponent)).lessThan(2)})})],ComponentManager.prototype,"getRendererComponent",null),__decorate([e.require(function(){var t=this;e.it("entityObject shouldn't contain more than 1 collider",function(){e.expect(t.getComponentCount(e.Collider)).lessThan(2)})})],ComponentManager.prototype,"getCollider",null),ComponentManager}();e.ComponentManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EntityObjectManager(e){this._entityObject=null,this._children=wdCb.Collection.create(),this._entityObject=e}return EntityObjectManager.create=function(e){var t=new this(e);return t},EntityObjectManager.prototype.init=function(){this.forEach(function(e){e.init()})},EntityObjectManager.prototype.dispose=function(){this.forEach(function(e){e.dispose()})},EntityObjectManager.prototype.hasChild=function(e){return this._children.hasChild(e)},EntityObjectManager.prototype.addChild=function(e){return e.parent&&e.parent.removeChild(e),e.parent=this._entityObject,this._children.addChild(e),e.onEnter(),this},EntityObjectManager.prototype.addChildren=function(){for(var t=this,r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];if(e.JudgeUtils.isArray(r[0]))for(var i=r[0],a=0,o=i;a<o.length;a++){var s=o[a];this.addChild(s)}else if(e.JudgeUtils.isCollection(r[0])){var i=r[0];i.forEach(function(e){t.addChild(e)})}else this.addChild(r[0]);return this},EntityObjectManager.prototype.forEach=function(e){return this._children.forEach(e),this},EntityObjectManager.prototype.filter=function(e){return this._children.filter(e)},EntityObjectManager.prototype.sort=function(e,t){return void 0===t&&(t=!1),this._children.sort(e,t)},EntityObjectManager.prototype.getChildren=function(){return this._children},EntityObjectManager.prototype.getAllChildren=function(){var e=wdCb.Collection.create(),t=function(r){e.addChildren(r.getChildren()),r.forEach(function(e){t(e)})};return t(this._entityObject),e},EntityObjectManager.prototype.getChild=function(e){return this._children.getChild(e)},EntityObjectManager.prototype.findChildByUid=function(e){return this._children.findOne(function(t){return t.uid===e})},EntityObjectManager.prototype.findChildByTag=function(e){return this._children.findOne(function(t){return t.hasTag(e)})},EntityObjectManager.prototype.findChildByName=function(e){return this._children.findOne(function(t){return t.name.search(e)>-1})},EntityObjectManager.prototype.findChildrenByName=function(e){return this._children.filter(function(t){return t.name.search(e)>-1})},EntityObjectManager.prototype.removeChild=function(e){return e.onExit(),this._children.removeChild(e),e.parent=null,this},EntityObjectManager.prototype.removeAllChildren=function(){var e=this;this._children.forEach(function(t){e.removeChild(t)},this)},EntityObjectManager}();e.EntityObjectManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ScriptManager(e){this._scriptList=wdCb.Hash.create(),this._entityObject=null,this._scriptExecuteHistory=wdCb.Hash.create(),this._entityObject=e}return ScriptManager.create=function(e){var t=new this(e);return t},ScriptManager.prototype.addChild=function(e,t){this._scriptList.addChild(e,t)},ScriptManager.prototype.getChild=function(e){return this._scriptList.getChild(e)},ScriptManager.prototype.removeChild=function(e){return this._scriptList.removeChild(function(t){return t===e})},ScriptManager.prototype.hasChild=function(e){return this._scriptList.hasChildWithFunc(function(t){return t===e})},ScriptManager.prototype.execScriptOnlyOnce=function(e){var t=this;this._scriptList.forEach(function(r,n){t._isScriptExecuted(n,e)||(r&&r[e]&&r[e](),
t._addToScriptExecuteHistory(n,e))},this)},ScriptManager.prototype.execScriptWithData=function(e,t){this._scriptList.forEach(function(r){r[e]&&r[e](t)})},ScriptManager.prototype.execScript=function(e){this._scriptList.forEach(function(t){t[e]&&t[e]()})},ScriptManager.prototype.execEventScriptWithData=function(e,t){this._scriptList.forEach(function(r){r&&r[e]&&r[e](t)})},ScriptManager.prototype._addToScriptExecuteHistory=function(e,t){this._scriptExecuteHistory.addChild(this._buildScriptHistoryKey(e,t),!0)},ScriptManager.prototype._isScriptExecuted=function(e,t){return this._scriptExecuteHistory.getChild(this._buildScriptHistoryKey(e,t))},ScriptManager.prototype._buildScriptHistoryKey=function(e,t){return e+"_"+t},ScriptManager}();e.ScriptManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ComponentContainer(){this.list=wdCb.Collection.create()}return ComponentContainer.prototype.addChild=function(e){this.list.addChild(e)},ComponentContainer.prototype.removeChild=function(e){this.list.removeChild(e)},ComponentContainer.prototype.removeAllChildren=function(){this.list.removeAllChildren()},ComponentContainer.prototype.hasChild=function(e){return this.list.hasChild(e)},ComponentContainer}();e.ComponentContainer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function UIObject(){t.apply(this,arguments)}return __extends(UIObject,t),UIObject.create=function(){var e=new this;return e.initWhenCreate(),e},UIObject.prototype.createTransform=function(){return e.RectTransform.create()},UIObject.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.name="uiObject"+String(this.uid)},UIObject.prototype.addComponent=function(e){return t.prototype.addComponent.call(this,e),this},UIObject.prototype.addChild=function(e){return t.prototype.addChild.call(this,e),this},__decorate([e.require(function(t){t instanceof e.TwoDUI&&e.assert(!this.getComponent(e.TwoDUI),e.Log.info.FUNC_SHOULD("only has one TwoDUI component"))})],UIObject.prototype,"addComponent",null),__decorate([e.require(function(t){e.assert(this.getComponent(e.UIRenderer)===t.getComponent(e.UIRenderer),e.Log.info.FUNC_MUST_BE("the UIRenderer of UIObject and its children","the same one"))})],UIObject.prototype,"addChild",null),UIObject}(e.EntityObject);e.UIObject=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GameObject(){t.apply(this,arguments),this.renderGroup=0,this.renderPriority=0}return __extends(GameObject,t),GameObject.create=function(){var e=new this;return e.initWhenCreate(),e},GameObject.merge=function(t){var r=t[0],n=r.clone({cloneChildren:!1,cloneGeometry:!1}),i=e.ModelGeometry.create();n.removeAllChildren();for(var a=0,o=t;a<o.length;a++){var s=o[a];i.merge(s.getComponent(e.Geometry),s.transform)}return i.material=r.getComponent(e.Geometry).material.clone(),n.addComponent(i),n},GameObject.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.name="gameObject"+String(this.uid)},GameObject.prototype.getSpacePartition=function(){return this.getComponent(e.SpacePartition)},GameObject.prototype.getGeometry=function(){var r=this.getComponent(e.GeometryLOD);return r&&r.activeGeometry?r.activeGeometry:t.prototype.getGeometry.call(this)},GameObject.prototype.createTransform=function(){return e.ThreeDTransform.create()},GameObject.prototype.getRenderList=function(){return this.hasComponent(e.Octree)?this.getSpacePartition().getRenderList():e.RenderUtils.getGameObjectRenderList(this.getChildren())},GameObject.prototype.afterInitChildren=function(){if(this.hasComponent(e.Octree))return this.getSpacePartition().build()},__decorate([e.require(function(t){var r=function(t){e.assert(t.hasComponent(e.Geometry),e.Log.info.FUNC_SHOULD("contain geometry component"))},n=function(){var n=t[0],i=null;r(n),i=e.ClassUtils.getClassName(n.getComponent(e.Geometry).material);for(var a=1,o=t.length;a<o;a++){var s=t[a];r(s),e.assert(e.ClassUtils.getClassName(s.getComponent(e.Geometry).material)===i,e.Log.info.FUNC_SHOULD("gameObjectArr","has the same material class"))}};e.assert(t.length>1,e.Log.info.FUNC_SHOULD("object count","> 1")),n()}),e.ensure(function(t){e.assert(0===t.getChildren().getCount(),e.Log.info.FUNC_SHOULD("merged object","has no children"))})],GameObject,"merge",null),GameObject}(e.EntityObject);e.GameObject=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SceneDispatcher(){t.apply(this,arguments),this.name="scene"+String(this.uid),this.uiObjectScene=e.UIObjectScene.create(),this.gameObjectScene=e.GameObjectScene.create()}return __extends(SceneDispatcher,t),SceneDispatcher.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(SceneDispatcher.prototype,"scriptManager",{get:function(){return this.gameObjectScene.scriptManager},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"ambientLight",{get:function(){return this.gameObjectScene.ambientLight},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"directionLights",{get:function(){return this.gameObjectScene.directionLights},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"pointLights",{get:function(){return this.gameObjectScene.pointLights},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"side",{get:function(){return this.gameObjectScene.side},set:function(e){this.gameObjectScene.side=e},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"shadowMap",{get:function(){return this.gameObjectScene.shadowMap},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"currentCamera",{get:function(){return this.gameObjectScene.currentCamera},set:function(e){this.gameObjectScene.currentCamera=e},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"physics",{get:function(){return this.gameObjectScene.physics},set:function(e){this.gameObjectScene.physics=e},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"glslData",{get:function(){return this.gameObjectScene.glslData},set:function(e){this.gameObjectScene.glslData=e},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"isUseShader",{get:function(){return this.gameObjectScene.isUseShader},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"currentShaderType",{get:function(){return this.gameObjectScene.currentShaderType},enumerable:!0,configurable:!0}),SceneDispatcher.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.addComponent(e.SceneEventTriggerDetector.create())},SceneDispatcher.prototype.useShaderType=function(e){this.gameObjectScene.useShaderType(e)},SceneDispatcher.prototype.unUseShader=function(){this.gameObjectScene.unUseShader()},SceneDispatcher.prototype.addChild=function(t){return t instanceof e.GameObject?this.gameObjectScene.addChild(t):t instanceof e.UIObject&&this.uiObjectScene.addChild(t),t.parent=this,this},SceneDispatcher.prototype.addCommonRenderTargetRenderer=function(e){return this.gameObjectScene.renderTargetRendererManager.addCommonRenderTargetRenderer(e)},SceneDispatcher.prototype.addProceduralRenderTargetRenderer=function(e){return this.gameObjectScene.renderTargetRendererManager.addProceduralRenderTargetRenderer(e)},SceneDispatcher.prototype.dispose=function(){this.gameObjectScene.dispose(),this.uiObjectScene.dispose()},SceneDispatcher.prototype.hasChild=function(t){return t instanceof e.GameObject?this.gameObjectScene.hasChild(t):t instanceof e.UIObject?this.uiObjectScene.hasChild(t):void 0},SceneDispatcher.prototype.addChildren=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(t[0]instanceof e.EntityObject){var n=t[0];this.addChild(n)}if(t[0]instanceof wdCb.Collection){var i=t[0],a=this;i.forEach(function(e){a.addChild(e)})}else if(e.JudgeUtils.isArrayExactly(t[0]))for(var i=t[0],o=0,s=i;o<s.length;o++){var n=s[o];this.addChild(n)}return this},SceneDispatcher.prototype.getChildren=function(){return this.gameObjectScene.getChildren().addChildren(this.uiObjectScene.getChildren())},SceneDispatcher.prototype.findChildByUid=function(e){var t=this.gameObjectScene.findChildByUid(e);return t||(t=this.uiObjectScene.findChildByUid(e)),t},SceneDispatcher.prototype.findChildByTag=function(e){var t=this.gameObjectScene.findChildByTag(e);return t||(t=this.uiObjectScene.findChildByTag(e)),t},SceneDispatcher.prototype.findChildByName=function(e){var t=this.gameObjectScene.findChildByName(e);return t||(t=this.uiObjectScene.findChildByName(e)),t},SceneDispatcher.prototype.findChildrenByName=function(e){return this.gameObjectScene.findChildrenByName(e).addChildren(this.uiObjectScene.findChildrenByName(e))},SceneDispatcher.prototype.removeChild=function(t){return t instanceof e.GameObject?this.gameObjectScene.removeChild(t):t instanceof e.UIObject?this.uiObjectScene.removeChild(t):void 0},SceneDispatcher.prototype.onEnter=function(){this.gameObjectScene.onEnter(),this.uiObjectScene.onEnter()},SceneDispatcher.prototype.onExit=function(){this.gameObjectScene.onExit(),this.uiObjectScene.onExit()},SceneDispatcher.prototype.onDispose=function(){this.gameObjectScene.onDispose(),this.uiObjectScene.onDispose()},SceneDispatcher.prototype.createTransform=function(){return null},__decorate([e.ensureGetter(function(t){t&&e.assert(t.getCount()<=4,e.Log.info.FUNC_SHOULD("direction lights' count","<= 4"))})],SceneDispatcher.prototype,"directionLights",null),__decorate([e.ensureGetter(function(t){t&&e.assert(t.getCount()<=4,e.Log.info.FUNC_SHOULD("point lights' count","<= 4"))})],SceneDispatcher.prototype,"pointLights",null),SceneDispatcher}(e.EntityObject);e.SceneDispatcher=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function Scene(){e.apply(this,arguments)}return __extends(Scene,e),Scene}(e.EntityObject);e.Scene=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function UIObjectScene(){t.apply(this,arguments),this._startLoopSubscription=null,this._endLoopSubscription=null}return __extends(UIObjectScene,t),UIObjectScene.create=function(){var e=new this;return e.initWhenCreate(),e},UIObjectScene.prototype.init=function(){var r=this;return t.prototype.init.call(this),this._startLoopSubscription=e.EventManager.fromEvent(e.EEngineEvent.STARTLOOP).subscribe(function(){r._sortSiblingChildren()}),this._endLoopSubscription=e.EventManager.fromEvent(e.EEngineEvent.ENDLOOP).subscribe(function(){r._resetAllRendererClearCanvasFlag()}),this},UIObjectScene.prototype.update=function(r){t.prototype.update.call(this,r),e.TwoDUIEngine.getInstance().update(r)},UIObjectScene.prototype.onDispose=function(){t.prototype.onDispose.call(this),this._startLoopSubscription.dispose(),this._endLoopSubscription.dispose()},UIObjectScene.prototype.render=function(){var t=this;this._resetAllRendererState(),this.forEach(function(r){var n=t._getUIRenderer(r);n.dirty?(n.isClearCanvas||n.clearCanvas(),n.state=e.EUIRendererState.DIRTY,n.resetDirty()):n.state!==e.EUIRendererState.DIRTY&&(n.state=e.EUIRendererState.NOT_DIRTY)}),e.TwoDUIEngine.getInstance().render()},UIObjectScene.prototype.createTransform=function(){return null},UIObjectScene.prototype._getUIRenderer=function(t){return t.getComponent(e.UIRenderer)},UIObjectScene.prototype._resetAllRendererClearCanvasFlag=function(){var e=this;this.forEach(function(t){var r=e._getUIRenderer(t);r.isClearCanvas=!1})},UIObjectScene.prototype._resetAllRendererState=function(){var t=this;this.forEach(function(r){var n=t._getUIRenderer(r);n.state=e.EUIRendererState.NORMAL})},UIObjectScene.prototype._sortSiblingChildren=function(){var e=function(t){t.sort(function(e,t){return e.transform.zIndex-t.transform.zIndex},!0),t.forEach(function(t){e(t)})};e(this)},__decorate([e.require(function(){this.forEach(function(t){e.assert(t instanceof e.UIObject,e.Log.info.FUNC_MUST_BE("child","UIObject")),e.assert(t.hasComponent(e.TwoDUI),e.Log.info.FUNC_SHOULD("UIObject","contain ui component"))})})],UIObjectScene.prototype,"render",null),__decorate([e.require(function(t){e.assert(t.getComponentCount(e.UIRenderer)<=1,e.Log.info.FUNC_SHOULD_NOT("uiObject","contain more than 1 uiRenderer component"))})],UIObjectScene.prototype,"_getUIRenderer",null),__decorate([e.ensure(function(){var t=this;this.getAllChildren().forEach(function(r){var n=t._getUIRenderer(r);e.assert(!n.isClearCanvas,e.Log.info.FUNC_SHOULD("reset all UIRenderers->isClearCanvas"))})})],UIObjectScene.prototype,"_resetAllRendererClearCanvasFlag",null),__decorate([e.ensure(function(){var t=this;this.getAllChildren().forEach(function(r){var n=t._getUIRenderer(r);e.assert(n.state===e.EUIRendererState.NORMAL,e.Log.info.FUNC_SHOULD("reset all UIRenderers->state"))})})],UIObjectScene.prototype,"_resetAllRendererState",null),UIObjectScene}(e.Scene);e.UIObjectScene=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BufferTable(){}return BufferTable.bindIndexBuffer=function(t){var r=null;this.lastBindedElementBuffer!==t&&(this.lastBindedElementBuffer=t,r=e.DeviceManager.getInstance().gl,r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.buffer))},BufferTable.hasBuffer=function(e){return this._table.hasChild(e)},BufferTable.addBuffer=function(e,t){this._table.addChild(e,t)},BufferTable.getBuffer=function(e){return this._table.getChild(e)},BufferTable.dispose=function(){this._table.forEach(function(e){e.dispose()}),this.lastBindedArrayBufferListUidStr=null,this.lastBindedElementBuffer=null},BufferTable.clearAll=function(){this._table.removeAllChildren(),this.lastBindedArrayBufferListUidStr=null,this.lastBindedElementBuffer=null},BufferTable.resetBindedArrayBuffer=function(){var t=e.DeviceManager.getInstance().gl;t.bindBuffer(t.ARRAY_BUFFER,null),this.lastBindedArrayBufferListUidStr=null},BufferTable.resetBindedElementBuffer=function(){var t=e.DeviceManager.getInstance().gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.lastBindedElementBuffer=null},BufferTable.lastBindedArrayBufferListUidStr=null,BufferTable.lastBindedElementBuffer=null,BufferTable._table=wdCb.Hash.create(),BufferTable}();e.BufferTable=t,function(e){e[e.PROCEDURAL_VERTEX="PROCEDURAL_VERTEX"]="PROCEDURAL_VERTEX",e[e.PROCEDURAL_INDEX="PROCEDURAL_INDEX"]="PROCEDURAL_INDEX"}(e.BufferTableKey||(e.BufferTableKey={}));e.BufferTableKey}(wd||(wd={}));var wd;!function(e){var t=function(){function ProgramTable(){}return ProgramTable.hasProgram=function(e){return this._table.hasChild(e)},ProgramTable.addProgram=function(e,t){this._table.addChild(e,t)},ProgramTable.getProgram=function(e){return this._table.getChild(e)},ProgramTable.dispose=function(){this._table.forEach(function(e){e.dispose()}),this.lastUsedProgram=null},ProgramTable.clearAll=function(){this._table.removeAllChildren(),this.lastUsedProgram=null},ProgramTable.lastUsedProgram=null,ProgramTable._table=wdCb.Hash.create(),ProgramTable}();e.ProgramTable=t}(wd||(wd={}));var wd;!function(e){var t=function(){function TextureCache(){}return TextureCache.isCached=function(t,r){return e.JudgeUtils.isEqual(this.getActiveTexture(t),r)},TextureCache.addActiveTexture=function(e,t){this._bindTextureUnitCache[e]=t},TextureCache.getActiveTexture=function(e){return this._bindTextureUnitCache[e]},TextureCache.clearAll=function(){this._bindTextureUnitCache=[]},TextureCache.clearAllBindTextureUnitCache=function(){this._bindTextureUnitCache=[]},TextureCache.clearBindTextureUnitCache=function(e){this._bindTextureUnitCache[e]=null},TextureCache._checkUnit=function(t){var r=e.GPUDetector.getInstance().maxTextureUnit;e.assert(t>=0,e.Log.info.FUNC_SHOULD("texture unit",">= 0, but actual is "+t)),e.assert(t<r,"trying to cache "+t+" texture units, but GPU only supports "+r+" units")},TextureCache._bindTextureUnitCache=[],__decorate([e.require(function(e,t){this._checkUnit(e)})],TextureCache,"addActiveTexture",null),__decorate([e.require(function(e,t){this._checkUnit(e)})],TextureCache,"getActiveTexture",null),TextureCache}();e.TextureCache=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GameObjectScene(){t.apply(this,arguments),this._currentCamera=null,this.side=null,this.shadowMap=n.create(this),this.physics=r.create(),this.glslData=wdCb.Hash.create(),this.currentShaderType=null,this.renderTargetRendererManager=e.RenderTargetRendererManager.create(),this.shadowManager=e.ShadowManager.create(this),this._lightManager=e.LightManager.create(),this._cameraList=wdCb.Collection.create()}return __extends(GameObjectScene,t),GameObjectScene.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(GameObjectScene.prototype,"ambientLight",{get:function(){return this._lightManager.ambientLight},enumerable:!0,configurable:!0}),Object.defineProperty(GameObjectScene.prototype,"directionLights",{get:function(){return this._lightManager.directionLights},enumerable:!0,configurable:!0}),Object.defineProperty(GameObjectScene.prototype,"pointLights",{get:function(){return this._lightManager.pointLights},enumerable:!0,configurable:!0}),Object.defineProperty(GameObjectScene.prototype,"currentCamera",{get:function(){return this._currentCamera||this._cameraList.getChild(0)},set:function(t){if(e.JudgeUtils.isNumber(t)){var r=t;this._currentCamera=this._cameraList.getChild(r)}else if(t instanceof e.GameObject){var n=t;this._currentCamera=n}},enumerable:!0,configurable:!0}),Object.defineProperty(GameObjectScene.prototype,"isUseShader",{get:function(){return null!==this.currentShaderType},enumerable:!0,configurable:!0}),GameObjectScene.prototype.init=function(){return e.PhysicsEngine.getInstance().initPhysicsEngineAdapter(),this.shadowManager.init(),t.prototype.init.call(this),this.renderTargetRendererManager.init(),e.PhysicsEngine.getInstance().initBody(),e.PhysicsEngine.getInstance().initConstraint(),this},GameObjectScene.prototype.dispose=function(){t.prototype.dispose.call(this),this.shadowManager.dispose(),this.renderTargetRendererManager.dispose()},GameObjectScene.prototype.addChild=function(e){var r=this._getCameras(e),n=this._getLights(e);return r.getCount()>0&&this._cameraList.addChildren(r),n.getCount()>0&&this._lightManager.addChildren(n),t.prototype.addChild.call(this,e)},GameObjectScene.prototype.update=function(r){var n=this._getCurrentCameraComponent(),i=this.shadowManager;e.PhysicsEngine.getInstance().update(r),n&&n.update(r),i.update(r),e.LODEngine.getInstance().update(r),e.SpacePartitionEngine.getInstance().update(r),e.AnimationEngine.getInstance().update(r),e.CollisionEngine.getInstance().update(r),e.ThreeDUIEngine.getInstance().update(r),t.prototype.update.call(this,r),e.CollisionEngine.getInstance().detect(r),e.BillboardEngine.getInstance().update(r)},GameObjectScene.prototype.render=function(e){this.shadowManager.setShadowRenderListForCurrentLoop(),this.renderTargetRendererManager.render(e,this.currentCamera),t.prototype.render.call(this,e,this.currentCamera)},GameObjectScene.prototype.useShaderType=function(e){this.currentShaderType=e},GameObjectScene.prototype.unUseShader=function(){this.currentShaderType=null},GameObjectScene.prototype.getRenderList=function(){return e.RenderUtils.getGameObjectRenderList(this.getChildren())},GameObjectScene.prototype.createTransform=function(){return null},GameObjectScene.prototype._getCameras=function(e){return this._find(e,this._isCamera)},GameObjectScene.prototype._getLights=function(e){return this._find(e,this._isLight)},GameObjectScene.prototype._find=function(e,t){var r=this,n=wdCb.Collection.create(),i=function(e){t.call(r,e)&&n.addChild(e),e.forEach(function(e){i(e)})};return i(e),n},GameObjectScene.prototype._isCamera=function(t){return t.hasComponent(e.CameraController)},GameObjectScene.prototype._isLight=function(t){return t.hasComponent(e.Light)},GameObjectScene.prototype._getCurrentCameraComponent=function(){return this.currentCamera?this.currentCamera.getComponent(e.CameraController):null},__decorate([e.requireSetter(function(t){if(e.JudgeUtils.isNumber(t)){var r=t;e.assert(!!this._cameraList.getChild(r),e.Log.info.FUNC_NOT_EXIST("current camera in cameraList"))}})],GameObjectScene.prototype,"currentCamera",null),GameObjectScene}(e.Scene);e.GameObjectScene=t;var r=function(){function PhysicsConfig(){this._gravity=e.Vector3.create(0,-9.8,0),this.enable=!1,this.engine=e.EPhysicsEngineType.CANNON,this.iterations=10}return PhysicsConfig.create=function(){var e=new this;return e},Object.defineProperty(PhysicsConfig.prototype,"gravity",{get:function(){return this._gravity},set:function(e){this._gravity=e},enumerable:!0,configurable:!0}),__decorate([e.operateWorldDataGetterAndSetter("Gravity")],PhysicsConfig.prototype,"gravity",null),PhysicsConfig}();e.PhysicsConfig=r;var n=function(){function ShadowMapModel(t){this._scene=null,this._enable=!0,this._softType=e.EShadowMapSoftType.NONE,this.shadowLayerList=e.ShadowLayerList.create(),this._scene=t}return ShadowMapModel.create=function(e){var t=new this(e);return t},Object.defineProperty(ShadowMapModel.prototype,"enable",{get:function(){return this._enable},set:function(e){this._enable=e},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowMapModel.prototype,"softType",{get:function(){return this._softType},set:function(t){t!==this._softType&&(e.EventManager.broadcast(this._scene,e.CustomEvent.create(e.EEngineEvent.SHADOWMAP_SOFTTYPE_CHANGE)),this._softType=t)},enumerable:!0,configurable:!0}),ShadowMapModel.prototype.getTwoDShadowMapDataMap=function(e){return this._scene.shadowManager.getTwoDShadowMapDataMap(e)},ShadowMapModel.prototype.getCubemapShadowMapDataMap=function(e){return this._scene.shadowManager.getCubemapShadowMapDataMap(e)},ShadowMapModel}();e.ShadowMapModel=n}(wd||(wd={}));var wd;!function(e){var t=function(){function CollisionDetector(){this._collisionTable=wdCb.Hash.create(),this._lastCollisionTable=wdCb.Hash.create()}return CollisionDetector.create=function(){var e=new this;return e},CollisionDetector.prototype.update=function(t){var r=e.Director.getInstance().scene.gameObjectScene,n=r.filter(function(t){return t.hasComponent(e.Collider)||e.JudgeUtils.isSpacePartitionObject(t)&&t.getSpacePartition().isCollideEnable}),i=this;0!==n.getCount()&&(this._clearCollisionTable(),n.forEach(function(t){t.hasComponent(e.RigidBody)||i._recordCollideObjects(t,n)}),this._triggerCollisionEvent())},CollisionDetector.prototype._recordCollideObjects=function(t,r){var n=this;if(e.JudgeUtils.isSpacePartitionObject(t)){var i=t.getSpacePartition();return void r.forEach(function(r){e.JudgeUtils.isSelf(t,r)||(e.JudgeUtils.isSpacePartitionObject(r)?n._handleCollisionBetweenSpacePartitionAndSpacePartition(r.getSpacePartition(),i):n._handleCollisionBetweenGameObjectAndSpacePartition(r.getComponent(e.Collider),i))})}var a=t.getComponent(e.Collider);a.enable&&r.forEach(function(r){e.JudgeUtils.isSelf(t,r)||(e.JudgeUtils.isSpacePartitionObject(r)?n._handleCollisionBetweenGameObjectAndSpacePartition(a,r.getSpacePartition()):n._handleCollisionBetweenGameObjectAndGameObject(a,r))})},CollisionDetector.prototype._isGameObjectCollideWithGameObject=function(e,t,n){return!(this._isNotTransform(e)&&this._isNotTransform(n)&&!e.hasTag(r.COLLIDED))&&t.isCollide(n)},CollisionDetector.prototype._clearCollisionTable=function(){this._collisionTable.removeAllChildren()},CollisionDetector.prototype._isCollidedInTable=function(e,t){var r=this._collisionTable,n=String(e.uid),i=String(t.uid);return r.hasChild(n)&&r.getChild(n).targetObjectMap.hasChild(i)},CollisionDetector.prototype._recordToTable=function(e,t){var r=this._collisionTable,n=String(e.uid),i=String(t.uid);if(!r.hasChild(n)){var a=wdCb.Hash.create();return a.addChild(i,t),void r.addChild(n,{sourceObject:e,targetObjectMap:a})}r.getChild(n).targetObjectMap.addChild(i,t)},CollisionDetector.prototype._handleCollisionBetweenGameObjectAndSpacePartition=function(t,r){var n=t.entityObject,i=this;t.enable&&r.getCollideObjects(t.shape).forEach(function(t){var r=t.getComponent(e.Collider);r.enable&&!i._isCollidedInTable(t,n)&&i._isGameObjectCollideWithGameObject(t,r,n)&&(i._recordToTable(t,n),i._recordToTable(n,t))})},CollisionDetector.prototype._handleCollisionBetweenSpacePartitionAndSpacePartition=function(t,r){var n=this;t.getChildren().forEach(function(t){var i=t.getComponent(e.Collider);i.enable&&n._handleCollisionBetweenGameObjectAndSpacePartition(i,r)},this)},CollisionDetector.prototype._handleCollisionBetweenGameObjectAndGameObject=function(t,r){var n=t.entityObject;r.getComponent(e.Collider).enable&&!this._isCollidedInTable(n,r)&&this._isGameObjectCollideWithGameObject(n,t,r)&&(this._recordToTable(n,r),this._recordToTable(r,n))},CollisionDetector.prototype._isCollisionStart=function(e){return!e.hasTag(r.COLLIDED)},CollisionDetector.prototype._triggerCollisionEventOfCollideObjectWhichHasRigidBody=function(t,r,n){r.hasComponent(e.RigidBody)&&t.filter(function(t){return t.hasComponent(e.RigidBody)}).forEach(function(t){for(var i=0,a=n;i<a.length;i++){var o=a[i];e.ScriptEngine.getInstance().execEntityObjectScriptWithData(t,o,wdCb.Collection.create([r]))}})},CollisionDetector.prototype._triggerCollisionEvent=function(){var t=this;this._collisionTable.forEach(function(n){var i=n.sourceObject,a=n.targetObjectMap,o=a.toCollection();t._isCollisionStart(i)?(e.ScriptEngine.getInstance().execEntityObjectScriptWithData(i,"onCollisionStart",o),e.ScriptEngine.getInstance().execEntityObjectScriptWithData(i,"onContact",o),t._triggerCollisionEventOfCollideObjectWhichHasRigidBody(o,i,["onCollisionStart","onContact"])):(e.ScriptEngine.getInstance().execEntityObjectScriptWithData(i,"onContact",o),t._triggerCollisionEventOfCollideObjectWhichHasRigidBody(o,i,["onContact"])),i.hasTag(r.COLLIDED)||i.addTag(r.COLLIDED)},this),this._triggerCollisionEndEvent(),this._lastCollisionTable=this._collisionTable.clone()},CollisionDetector.prototype._triggerCollisionEndEvent=function(){var t=this,n=this._collisionTable;this._lastCollisionTable.forEach(function(i){var a=i.sourceObject,o=i.targetObjectMap;n.hasChild(String(a.uid))||(e.ScriptEngine.getInstance().execEntityObjectScript(a,"onCollisionEnd"),t._triggerCollisionEventOfCollideObjectWhichHasRigidBody(o.toCollection(),a,["onCollisionEnd"]),a.removeTag(r.COLLIDED))})},CollisionDetector.prototype._isNotTransform=function(e){return!e.transform.isTransform},__decorate([e.require(function(t,r){r.forEach(function(t){e.assert(t instanceof e.GameObject,e.Log.info.FUNC_SHOULD("targetObject","be GameObject"))})})],CollisionDetector.prototype,"_recordCollideObjects",null),__decorate([e.require(function(t,r,n){e.assert(t instanceof e.GameObject&&n instanceof e.GameObject,e.Log.info.FUNC_SHOULD("sourceObject and targetObject","be GameObject"))})],CollisionDetector.prototype,"_isGameObjectCollideWithGameObject",null),CollisionDetector}();e.CollisionDetector=t;var r;!function(e){e[e.COLLIDED="COLLIDED"]="COLLIDED"}(r||(r={}))}(wd||(wd={}));var wd;!function(e){var t=function(){function ShadowManager(t){this.gameObjectScene=null,this._shadowRenderList=null,this._endLoopSubscription=null,this._shadowMapManager=e.ShadowMapManager.create(this),this._shadowMapLayerChangeSubscription=null,this.gameObjectScene=t}return ShadowManager.create=function(e){var t=new this(e);return t},Object.defineProperty(ShadowManager.prototype,"twoDShadowMapDataMap",{get:function(){return this._shadowMapManager.twoDShadowMapDataMap},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowManager.prototype,"twoDShadowMapCountForGLSL",{get:function(){return this._shadowMapManager.twoDShadowMapCountForGLSL},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowManager.prototype,"cubemapShadowMapDataMap",{get:function(){return this._shadowMapManager.cubemapShadowMapDataMap},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowManager.prototype,"cubemapShadowMapCountForGLSL",{get:function(){return this._shadowMapManager.cubemapShadowMapCountForGLSL},enumerable:!0,configurable:!0}),ShadowManager.prototype.update=function(e){this._isShadowMapEnable()&&this.gameObjectScene.shadowMap.shadowLayerList.update()},ShadowManager.prototype.dispose=function(){this._endLoopSubscription&&this._endLoopSubscription.dispose(),this._shadowMapLayerChangeSubscription&&this._shadowMapLayerChangeSubscription.dispose(),this._shadowMapManager.dispose()},ShadowManager.prototype.getTwoDShadowMapDataMap=function(e){return this._shadowMapManager.twoDShadowMapDataMap.getChild(e)},ShadowManager.prototype.getCubemapShadowMapDataMap=function(e){return this._shadowMapManager.cubemapShadowMapDataMap.getChild(e)},ShadowManager.prototype.setShadowRenderListForCurrentLoop=function(){this._isShadowMapEnable()&&(this._shadowRenderList=this._getShadowRenderList())},ShadowManager.prototype.getShadowRenderListByLayer=function(t){return this._shadowRenderList.filter(function(r){return r.getComponent(e.Shadow).layer===t})},ShadowManager.prototype.getShadowLayerList=function(){var t=null,r=this.gameObjectScene.shadowMap.shadowLayerList,n=this;return r.dirty?r.removeRepeatItems():(t=e.ShadowLayerList.create(),e.RenderUtils.getGameObjectRenderList(this.gameObjectScene.getChildren()).forEach(function(r){return e.JudgeUtils.isSpacePartitionObject(r)?void r.forEach(function(r){n._isCastShadow(r)&&t.addChild(r.getComponent(e.Shadow).layer)}):void(n._isCastShadow(r)&&t.addChild(r.getComponent(e.Shadow).layer))}),t.dirty=!1,t.removeRepeatItems())},ShadowManager.prototype.init=function(){var t=this,r=this.gameObjectScene,n=null;this._isShadowMapEnable()&&this._hasShadow()&&(this.gameObjectScene.shadowMap.shadowLayerList=this.getShadowLayerList(),n=this.gameObjectScene.shadowMap.shadowLayerList,n.init(),this._shadowMapManager.initShadowMapData(n),this._shadowMapManager.twoDShadowMapDataMap.forEach(function(t,n){t.forEach(function(t){var i=t.shadowMap,a=t.light,o=e.TwoDShadowMapRenderTargetRenderer.create(i,a,n);r.renderTargetRendererManager.addCommonRenderTargetRenderer(o)})}),this._shadowMapManager.cubemapShadowMapDataMap.forEach(function(t,n){t.forEach(function(t){var i=t.shadowMap,a=t.light,o=e.CubemapShadowMapRenderTargetRenderer.create(i,a,n);r.renderTargetRendererManager.addCommonRenderTargetRenderer(o)})}),this._initShadowList(),this._shadowMapLayerChangeSubscription=e.EventManager.fromEvent(e.EEngineEvent.SHADOWMAP_LAYER_CHANGE).subscribe(function(){t._updateWhenShadowLayerChange()}))},ShadowManager.prototype._getShadowRenderList=function(){var t=wdCb.Collection.create(),r=this;return e.RenderUtils.getGameObjectRenderList(this.gameObjectScene.getChildren()).forEach(function(n){return e.JudgeUtils.isSpacePartitionObject(n)?void t.addChildren(n.getSpacePartition().getRenderList().filter(function(e){return r._isCastShadow(e)})):void(r._isCastShadow(n)&&t.addChild(n))}),t},ShadowManager.prototype._updateWhenShadowLayerChange=function(){var e=this.gameObjectScene;if(this._hasShadow()){this._shadowMapManager.updateWhenShadowLayerChange(e.shadowMap.shadowLayerList.getDiffData());var t=this._shadowMapManager.getAllDiffShadowMapDataWhenShadowLayerChange(),r=t.addTwoDShadowMapData,n=t.removeTwoDShadowMapData,i=t.addCubemapShadowMapData,a=t.removeCubemapShadowMapData;this._refreshRenderTargerRendererList(r,n,i,a)}},ShadowManager.prototype._refreshRenderTargerRendererList=function(t,r,n,i){var a=this.gameObjectScene;a.renderTargetRendererManager.removeCommonRenderTargetRenderer(function(t){var n=t.texture;return r.hasChildWithFunc(function(t){return e.JudgeUtils.isEqual(t.shadowMap,n)})||i.hasChildWithFunc(function(t){return e.JudgeUtils.isEqual(t.shadowMap,n)})}).forEach(function(e){e.dispose()}),t.forEach(function(t,r){t.forEach(function(t){var n=t.shadowMap,i=t.light,o=e.TwoDShadowMapRenderTargetRenderer.create(n,i,r);o.init(),a.renderTargetRendererManager.addCommonRenderTargetRenderer(o)})}),n.forEach(function(t,r){t.forEach(function(t){var n=t.shadowMap,i=t.light,o=e.CubemapShadowMapRenderTargetRenderer.create(n,i,r);o.init(),a.renderTargetRendererManager.addCommonRenderTargetRenderer(o)})})},ShadowManager.prototype._initShadowList=function(){var t=this;this._endLoopSubscription=e.EventManager.fromEvent(e.EEngineEvent.ENDLOOP).subscribe(function(){
t._removeShadowMapGLSLData()})},ShadowManager.prototype._isCastShadow=function(t){var r=t.getComponent(e.Shadow);return!!r&&r.cast},ShadowManager.prototype._removeShadowMapGLSLData=function(){e.Director.getInstance().scene.glslData.removeChild(e.EShaderGLSLData.TWOD_SHADOWMAP),e.Director.getInstance().scene.glslData.removeChild(e.EShaderGLSLData.CUBEMAP_SHADOWMAP),e.Director.getInstance().scene.glslData.removeChild(e.EShaderGLSLData.BUILD_CUBEMAP_SHADOWMAP)},ShadowManager.prototype._hasShadow=function(){var e=this.gameObjectScene;return!!e.directionLights||!!e.pointLights},ShadowManager.prototype._isShadowMapEnable=function(){return this.gameObjectScene.shadowMap.enable},__decorate([e.require(function(){var t=this,r=function(){t.gameObjectScene.getChildren().filter(function(t){return!e.JudgeUtils.isSpacePartitionObject(t)}).forEach(function(t){var r=function(t){e.assert(!t.hasComponent(e.Shadow),e.Log.info.FUNC_CAN_NOT("if the first level object of gameObjectScene don't contain Shadow component, its children","contain Shadow component")),t.forEach(function(e){r(e)})};t.hasComponent(e.Shadow)||t.forEach(function(e){r(e)})})},n=function(){t.gameObjectScene.getChildren().filter(function(t){return e.JudgeUtils.isSpacePartitionObject(t)}).forEach(function(t){t.forEach(function(t){var r=function(t){e.assert(!t.hasComponent(e.Shadow),e.Log.info.FUNC_CAN_NOT("if the first level object of space partition objject don't contain Shadow component, its children","contain Shadow component")),t.forEach(function(e){r(e)})};t.hasComponent(e.Shadow)||t.forEach(function(e){r(e)})})})};r(),n()})],ShadowManager.prototype,"_getShadowRenderList",null),__decorate([e.require(function(){var t=this.gameObjectScene.shadowMap.shadowLayerList;e.assert(t.dirty,e.Log.info.FUNC_SHOULD("shadowLayerList","dirty")),this._getShadowRenderList().forEach(function(r){e.assert(t.hasChild(r.getComponent(e.Shadow).layer),e.Log.info.FUNC_SHOULD("the shadow layer of shadow gameObject","exist in scene->shadowLayerList"))})})],ShadowManager.prototype,"_updateWhenShadowLayerChange",null),__decorate([e.ensure(function(){e.assert(!this.gameObjectScene.renderTargetRendererManager.getCommonRenderTargetRendererList().hasRepeatItems(),e.Log.info.FUNC_SHOULD_NOT("scene->commonRenderTargetRendererList","has repeat items"))})],ShadowManager.prototype,"_refreshRenderTargerRendererList",null),ShadowManager}();e.ShadowManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ShadowMapManager(e){this.twoDShadowMapDataMap=wdCb.Hash.create(),this.cubemapShadowMapDataMap=wdCb.Hash.create(),this._shadowManager=null,this._lastTwoDShadowMapDataMap=wdCb.Hash.create(),this._lastCubemapShadowMapDataMap=wdCb.Hash.create(),this._shadowManager=e}return ShadowMapManager.create=function(e){var t=new this(e);return t},Object.defineProperty(ShadowMapManager.prototype,"twoDShadowMapCountForGLSL",{get:function(){var e=0;return this.twoDShadowMapDataMap.forEach(function(t){e+=t.getCount()}),e},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowMapManager.prototype,"cubemapShadowMapCountForGLSL",{get:function(){var e=0;return this.cubemapShadowMapDataMap.forEach(function(t){e+=t.getCount()}),e},enumerable:!0,configurable:!0}),ShadowMapManager.prototype.initShadowMapData=function(t){var r=this,n=this._shadowManager.gameObjectScene;n.directionLights&&n.directionLights.getCount()>0&&n.directionLights.forEach(function(n){var i=n.getComponent(e.DirectionLight);i.castShadow&&r._addTwoDShadowMapDataWithLayer(t,i)},this),n.pointLights&&n.pointLights.getCount()>0&&n.pointLights.forEach(function(n){var i=n.getComponent(e.PointLight);i.castShadow&&r._addCubemapShadowMapDataWithLayer(t,i)},this)},ShadowMapManager.prototype.updateWhenShadowLayerChange=function(t){var r=this,n=t.addLayerList,i=t.removeLayerList,a=null;if(a=this._shadowManager.gameObjectScene,a.directionLights&&a.directionLights.getCount()>0){var o=this.twoDShadowMapDataMap;this._lastTwoDShadowMapDataMap=o.clone(),i.forEach(function(e){o.removeChild(e)}),a.directionLights.forEach(function(t){var i=t.getComponent(e.DirectionLight);i.castShadow&&r._addTwoDShadowMapDataWithLayer(n,i)},this)}if(a.pointLights&&a.pointLights.getCount()>0){var s=this.cubemapShadowMapDataMap;this._lastCubemapShadowMapDataMap=s.clone(),i.forEach(function(e){s.removeChild(e)}),a.pointLights.forEach(function(t){var i=t.getComponent(e.PointLight);i.castShadow&&r._addCubemapShadowMapDataWithLayer(n,i)},this)}},ShadowMapManager.prototype.getAllDiffShadowMapDataWhenShadowLayerChange=function(){var e=this._getDiffShadowMapDataWhenShadowLayerChange(this._lastTwoDShadowMapDataMap,this.twoDShadowMapDataMap),t=this._getDiffShadowMapDataWhenShadowLayerChange(this._lastCubemapShadowMapDataMap,this.cubemapShadowMapDataMap);return{addTwoDShadowMapData:e.addShadowMapData,removeTwoDShadowMapData:e.removeShadowMapData,addCubemapShadowMapData:t.addShadowMapData,removeCubemapShadowMapData:t.removeShadowMapData}},ShadowMapManager.prototype._getDiffShadowMapDataWhenShadowLayerChange=function(e,t){var r=wdCb.Hash.create(),n=wdCb.Collection.create();return n=e.filter(function(e,r){return!t.hasChild(r)}).toCollection(),r=t.filter(function(t,r){return!e.hasChild(r)}),{addShadowMapData:r,removeShadowMapData:n}},ShadowMapManager.prototype._addTwoDShadowMapDataWithLayer=function(t,r){var n=this.twoDShadowMapDataMap;t.forEach(function(t){n.appendChild(t,{shadowMap:e.TwoDShadowMapTexture.create(),light:r})})},ShadowMapManager.prototype._addCubemapShadowMapDataWithLayer=function(t,r){var n=this.cubemapShadowMapDataMap;t.forEach(function(t){n.appendChild(t,{shadowMap:e.CubemapShadowMapTexture.create(),light:r})})},ShadowMapManager.prototype.dispose=function(){},__decorate([e.require(function(t,r){e.assert(!t.hasRepeatItems(),e.Log.info.FUNC_SHOULD_NOT("has repeat shadow layer"))})],ShadowMapManager.prototype,"_addTwoDShadowMapDataWithLayer",null),__decorate([e.require(function(t,r){e.assert(!t.hasRepeatItems(),e.Log.info.FUNC_SHOULD_NOT("has repeat shadow layer"))})],ShadowMapManager.prototype,"_addCubemapShadowMapDataWithLayer",null),ShadowMapManager}();e.ShadowMapManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function LightManager(){this._lights=wdCb.Hash.create()}return LightManager.create=function(){var e=new this;return e},Object.defineProperty(LightManager.prototype,"ambientLight",{get:function(){return this._lights.getChild(e.AmbientLight.type)},enumerable:!0,configurable:!0}),Object.defineProperty(LightManager.prototype,"directionLights",{get:function(){return this._getLights(e.DirectionLight.type)},enumerable:!0,configurable:!0}),Object.defineProperty(LightManager.prototype,"pointLights",{get:function(){return this._getLights(e.PointLight.type)},enumerable:!0,configurable:!0}),LightManager.prototype.addChild=function(t){t.hasComponent(e.AmbientLight)?this._lights.addChild(e.AmbientLight.type,t):t.hasComponent(e.DirectionLight)?this._lights.appendChild(e.DirectionLight.type,t):t.hasComponent(e.PointLight)?this._lights.appendChild(e.PointLight.type,t):e.Log.error(!0,e.Log.info.FUNC_INVALID("light"))},LightManager.prototype.addChildren=function(e){var t=this;e.forEach(function(e){t.addChild(e)})},LightManager.prototype._getLights=function(e){return this._lights.getChild(e)},LightManager}();e.LightManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function RenderTargetRendererManager(){this._commonRenderTargetRendererList=wdCb.Collection.create(),this._proceduralRendererList=wdCb.Collection.create()}return RenderTargetRendererManager.create=function(){var e=new this;return e},RenderTargetRendererManager.prototype.init=function(){this._commonRenderTargetRendererList.forEach(function(e){return e.init()}),this._proceduralRendererList.forEach(function(e){return e.init()})},RenderTargetRendererManager.prototype.dispose=function(){this._commonRenderTargetRendererList.forEach(function(e){return e.dispose()}),this._proceduralRendererList.forEach(function(e){return e.dispose()})},RenderTargetRendererManager.prototype.addCommonRenderTargetRenderer=function(e){this._commonRenderTargetRendererList.addChild(e)},RenderTargetRendererManager.prototype.getCommonRenderTargetRendererList=function(){return this._commonRenderTargetRendererList},RenderTargetRendererManager.prototype.removeCommonRenderTargetRenderer=function(e){return this._commonRenderTargetRendererList.removeChild(e)},RenderTargetRendererManager.prototype.addProceduralRenderTargetRenderer=function(e){this._proceduralRendererList.addChild(e)},RenderTargetRendererManager.prototype.render=function(e,t){this._proceduralRendererList.filter(function(e){return e.needRender()}).forEach(function(t){t.render(e)}),this._commonRenderTargetRendererList.filter(function(e){return e.needRender()}).forEach(function(r){r.render(e,t)})},RenderTargetRendererManager}();e.RenderTargetRendererManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ShadowLayerList(){this.dirty=!1,this._list=wdCb.Collection.create(),this._lastList=null}return ShadowLayerList.create=function(){var e=new this;return e},ShadowLayerList.prototype.init=function(){this._lastList=this._list.clone()},ShadowLayerList.prototype.update=function(){this.dirty&&(e.EventManager.trigger(e.CustomEvent.create(e.EEngineEvent.SHADOWMAP_LAYER_CHANGE)),this.dirty=!1),this._lastList=this._list.clone()},ShadowLayerList.prototype.getDiffData=function(){var e=this._lastList,t=this._list,r=null,n=null;return null===e?{addLayerList:this._list.clone(),removeLayerList:wdCb.Collection.create()}:(r=wdCb.Collection.create(),n=wdCb.Collection.create(),n=e.filter(function(e){return!t.hasChild(e)}),r=t.filter(function(t){return!e.hasChild(t)}),{addLayerList:r,removeLayerList:n})},ShadowLayerList.prototype.getCount=function(){return this._list.getCount()},ShadowLayerList.prototype.addChild=function(e){this._list.addChild(e),this.dirty=!0},ShadowLayerList.prototype.addChildren=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this._list.addChildren.apply(this._list,e),this.dirty=!0},ShadowLayerList.prototype.removeChild=function(e){return this.dirty=!0,this._convertCollectionToThis(this._list.removeChild(e))},ShadowLayerList.prototype.removeAllChildren=function(){this.dirty=!0,this._list.removeAllChildren()},ShadowLayerList.prototype.removeRepeatItems=function(){var e=this._convertCollectionToThis(this._list.removeRepeatItems());return e.dirty=this.dirty,e},ShadowLayerList.prototype.hasRepeatItems=function(){return this._list.hasRepeatItems()},ShadowLayerList.prototype.forEach=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this._list.forEach.apply(this._list,e)},ShadowLayerList.prototype.getChildren=function(){return this._list.getChildren()},ShadowLayerList.prototype.hasChild=function(e){return this._list.hasChild(e)},ShadowLayerList.prototype._convertCollectionToThis=function(e){var t=ShadowLayerList.create();return t.addChildren(e.getChildren()),t},ShadowLayerList}();e.ShadowLayerList=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventListenerMap(){this.listenerMap=wdCb.Hash.create()}return EventListenerMap.prototype.hasChild=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=e[0],n=e[1],i=this.listenerMap.getChild(this.buildKey(r,n));return i&&i.getCount()>0},EventListenerMap.prototype.hasChildWithFunc=function(e){return this.listenerMap.hasChildWithFunc(e)},EventListenerMap.prototype.appendChild=function(e,t,r){this.listenerMap.appendChild(this.buildKey(e,t),r)},EventListenerMap.prototype.filter=function(e){return this.listenerMap.filter(e)},EventListenerMap.prototype.forEach=function(e){return this.listenerMap.forEach(e)},EventListenerMap.prototype.getEventNameFromKey=function(e){var t=this.getEventSeparator();return e.indexOf(t)>-1?e.split(t)[1]:e},EventListenerMap.prototype.isEventName=function(e,t){return e.indexOf(""+this.getEventSeparator()+t)>-1||e===t},EventListenerMap}();e.EventListenerMap=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomEventListenerMap(){t.apply(this,arguments)}return __extends(CustomEventListenerMap,t),CustomEventListenerMap.create=function(){var e=new this;return e},CustomEventListenerMap.prototype.getChild=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=this;if(1===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0];return this.listenerMap.getChild(i)}if(1===t.length&&t[0]instanceof e.EntityObject){var a=t[0];return this.listenerMap.filter(function(e,t){return n.isTarget(t,a,e)})}if(2===t.length){var o=t[0],i=t[1];return this.listenerMap.getChild(this.buildKey(o,i))}},CustomEventListenerMap.prototype.removeChild=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=this;if(1===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0];this.listenerMap.removeChild(function(e,t){return n.isEventName(t,i)})}else if(1===t.length&&t[0]instanceof e.EntityObject){var a=t[0];this.listenerMap.removeChild(function(e,t){return n.isTarget(t,a,e)})}else if(2===t.length&&e.JudgeUtils.isString(t[0])){var o=t[0],s=t[1],c=null;this.listenerMap.hasChild(o)&&(c=this.listenerMap.getChild(o),wdCb.Collection.create().addChild(c.removeChild(function(e){return e.originHandler===s})),0===c.getCount()&&this.listenerMap.removeChild(o))}else if(2===t.length&&e.JudgeUtils.isNumber(t[0])){var u=t[0],o=t[1];this.listenerMap.removeChild(this.buildKey(u,o))}else if(2===t.length&&t[0]instanceof e.EntityObject){var l=t[0],o=t[1];this.listenerMap.removeChild(this.buildKey(l,o))}else if(3===t.length&&t[0]instanceof e.EntityObject){var o=t[1],d=t[2];this.listenerMap.forEach(function(e,t){if(e.removeChild(function(e){return e.originHandler===d}),0===e.getCount())return wdCb.$REMOVE})}},CustomEventListenerMap.prototype.getUidFromKey=function(e){var t=""+CustomEventListenerMap.eventSeparator;return e.indexOf(t)>-1?Number(e.split(t)[0]):null},CustomEventListenerMap.prototype.isTarget=function(e,t,r){return e.indexOf(this._buildKeyPrefix(t.uid))>-1&&void 0!==r},CustomEventListenerMap.prototype.getEventSeparator=function(){return""+CustomEventListenerMap.eventSeparator},CustomEventListenerMap.prototype.buildKey=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(e.JudgeUtils.isNumber(t[0])){var n=t[0],i=t[1];return this._buildKeyWithUid(n,i)}if(t[0]instanceof e.EntityObject){var a=t[0],i=t[1];return this._buildKeyWithUid(a.uid,i)}if(null===t[0]){var i=t[1];return i}},CustomEventListenerMap.prototype._buildKeyWithUid=function(e,t){return""+this._buildKeyPrefix(e)+CustomEventListenerMap.eventSeparator+t},CustomEventListenerMap.prototype._buildKeyPrefix=function(e){return""+String(e)},CustomEventListenerMap.eventSeparator="@",CustomEventListenerMap}(e.EventListenerMap);e.CustomEventListenerMap=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DomEventListenerMap(){t.apply(this,arguments)}return __extends(DomEventListenerMap,t),DomEventListenerMap.create=function(){var e=new this;return e},DomEventListenerMap.prototype.getChild=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(1===e.length){var r=e[0];return this.listenerMap.getChild(r)}if(2===e.length){var n=e[0],r=e[1];return this.listenerMap.getChild(this.buildKey(n,r))}},DomEventListenerMap.prototype.removeChild=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=this,i=null;if(1===t.length&&e.JudgeUtils.isString(t[0])){var a=t[0];i=this._getEventDataOffDataList(a,this.listenerMap.removeChild(function(e,t){return n.isEventName(t,a)}))}else if(2===t.length&&e.JudgeUtils.isString(t[0])){var o=t[0],s=t[1],c=wdCb.Collection.create();this.listenerMap.forEach(function(e,t){if(n.isEventName(t,o)){var r=e.removeChild(function(e){return e.originHandler===s});if(r.getCount()>0&&c.addChild(r),0===e.getCount())return wdCb.$REMOVE}}),i=this._getEventDataOffDataList(o,c)}else if(2===t.length&&e.JudgeUtils.isDom(t[0])){var u=t[0],l=t[1];i=this._getEventDataOffDataList(l,this.listenerMap.removeChild(this.buildKey(u,l)))}else if(3===t.length&&e.JudgeUtils.isDom(t[0])){var l=t[1],d=wdCb.Collection.create(),h=t[2];this.listenerMap.forEach(function(e,t){var r=e.removeChild(function(e){return e.originHandler===h});if(r.getCount()>0&&d.addChild(r),0===e.getCount())return wdCb.$REMOVE}),i=this._getEventDataOffDataList(l,d)}return i},DomEventListenerMap.prototype.isDom=function(e,t,r){return e.indexOf(this._buildKeyPrefix(t))>-1&&void 0!==r},DomEventListenerMap.prototype.getEventSeparator=function(){return""+DomEventListenerMap.eventSeparator},DomEventListenerMap.prototype.buildKey=function(e,t){return""+this._buildKeyPrefix(e)+DomEventListenerMap.eventSeparator+t},DomEventListenerMap.prototype._buildKeyPrefix=function(e){return e.id?""+e.tagName+e.id:""+e.tagName},DomEventListenerMap.prototype._getEventDataOffDataList=function(e,t){return t.map(function(t){return t.map(function(t){return{dom:t.dom,eventName:e,domHandler:t.domHandler}})})},DomEventListenerMap.eventSeparator="@",DomEventListenerMap}(e.EventListenerMap);e.DomEventListenerMap=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.MOUSE=0]="MOUSE",e[e.KEYBOARD=1]="KEYBOARD",e[e.CUSTOM=2]="CUSTOM"}(e.EEventType||(e.EEventType={}));e.EEventType}(wd||(wd={}));var wd;!function(e){var t;!function(e){e[e.FALLBACK="fallback"]="FALLBACK",e[e.FIREFOX="firefox"]="FIREFOX",e[e.CHROME="chrome"]="CHROME"}(t||(t={})),function(e){e[e.CLICK="click"]="CLICK",e[e.MOUSEOVER="mouseover"]="MOUSEOVER",e[e.MOUSEUP="mouseup"]="MOUSEUP",e[e.MOUSEOUT="mouseout"]="MOUSEOUT",e[e.MOUSEMOVE="mousemove"]="MOUSEMOVE",e[e.MOUSEDOWN="mousedown"]="MOUSEDOWN",e[e.MOUSEWHEEL="mousewheel|DOMMouseScroll*"+t.FIREFOX]="MOUSEWHEEL",e[e.MOUSEDRAG="mousedrag"]="MOUSEDRAG",e[e.KEYDOWN="keydown"]="KEYDOWN",e[e.KEYUP="keyup"]="KEYUP",e[e.KEYPRESS="keypress"]="KEYPRESS"}(e.EEventName||(e.EEventName={}));var r=(e.EEventName,"|"),n="*",i=function(){function EventNameHandler(){}return EventNameHandler.handleEventName=function(e){for(var t=e,n=null,i=[],a=null,o=0,s=t.split(r);o<s.length;o++){var c=s[o];this._isFallbackEventName(c)?n=c:i.push(c)}return a=this._getSpecifyBrowserEventName(i),null!==a?a:n},EventNameHandler._isFallbackEventName=function(e){return 1===e.split(n).length},EventNameHandler._getSpecifyBrowserEventName=function(e){for(var r=null,i=0,a=e;i<a.length;i++){var o=a[i],s=o.split(n),c=s[0],u=s[1];switch(u){case t.CHROME:bowser.chrome&&(r=c);break;case t.FIREFOX:bowser.firefox&&(r=c)}if(r)break}return r},EventNameHandler}();e.EventNameHandler=i}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BROADCAST=0]="BROADCAST",e[e.EMIT=1]="EMIT"}(e.EEventPhase||(e.EEventPhase={}));e.EEventPhase}(wd||(wd={}));var wd;!function(e){var t=wdCb.Hash.create();t.addChild(e.EEventName.CLICK,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEOVER,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEOUT,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEMOVE,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEDOWN,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEUP,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEWHEEL,e.EEventType.MOUSE),t.addChild(e.EEventName.MOUSEDRAG,e.EEventType.MOUSE),t.addChild(e.EEventName.KEYDOWN,e.EEventType.KEYBOARD),t.addChild(e.EEventName.KEYPRESS,e.EEventType.KEYBOARD),t.addChild(e.EEventName.KEYUP,e.EEventType.KEYBOARD);var r=function(){function EventTable(){}return EventTable.getEventType=function(r){var n=t.getChild(r);return void 0===n&&(n=e.EEventType.CUSTOM),n},EventTable}();e.EventTable=r}(wd||(wd={}));var wd;!function(e){var t=function(){function Event(e){this.name=null,this.currentTarget=null,this.isStopPropagation=!1,this.phase=null,this.name=e}return Object.defineProperty(Event.prototype,"type",{get:function(){return this.p_type},enumerable:!0,configurable:!0}),Event.prototype.stopPropagation=function(){this.isStopPropagation=!0},Event.prototype.copyMember=function(e,t,r){return r.forEach(function(r){e[r]=t[r]}),e},Event}();e.Event=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DomEvent(e,r){t.call(this,r),this._event=null,this.event=e}return __extends(DomEvent,t),Object.defineProperty(DomEvent.prototype,"event",{get:function(){return this._event},set:function(t){this._event=t||e.root.event},enumerable:!0,configurable:!0}),DomEvent.prototype.preventDefault=function(){var e=this._event;bowser.msie&&Number(bowser.version)<=8?e.returnValue=!1:e.preventDefault()},DomEvent.prototype.getDataFromCustomEvent=function(e){this.target=e.target,this.currentTarget=e.currentTarget,this.isStopPropagation=e.isStopPropagation},DomEvent}(e.Event);e.DomEvent=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MouseEvent(){t.apply(this,arguments),this._location=null,this._locationInView=null,this._button=null,this.lastX=null,this.lastY=null,this.p_type=e.EEventType.MOUSE}return __extends(MouseEvent,t),MouseEvent.create=function(e,t){var r=new this(e,t);return r},Object.defineProperty(MouseEvent.prototype,"location",{get:function(){var t=null,r=this.event;return this._location?this._location:(t=e.Point.create(),bowser.msie?(t.x=r.clientX+document.body.scrollLeft||document.documentElement.scrollLeft,t.y=r.clientY+document.body.scrollTop||document.documentElement.scrollTop):(t.x=r.pageX,t.y=r.pageY),t)},set:function(e){this._location=e},enumerable:!0,configurable:!0}),Object.defineProperty(MouseEvent.prototype,"locationInView",{get:function(){var t=null,r=null;return this._locationInView?this._locationInView:(t=this.location,r=e.DeviceManager.getInstance().view.offset,e.Point.create(t.x-r.x,t.y-r.y))},set:function(e){this._locationInView=e},enumerable:!0,configurable:!0}),Object.defineProperty(MouseEvent.prototype,"button",{get:function(){var t=this.event,r=null;if(this._button)return this._button;if(bowser.msie)switch(t.button){case 1:r=e.EMouseButton.LEFT;break;case 4:r=e.EMouseButton.RIGHT;break;case 2:r=e.EMouseButton.CENTER;break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("multi mouse button"))}else switch(t.button){case 0:r=e.EMouseButton.LEFT;break;case 1:r=e.EMouseButton.RIGHT;break;case 2:r=e.EMouseButton.CENTER;break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("multi mouse button"))}return r},set:function(e){this._button=e},enumerable:!0,configurable:!0}),Object.defineProperty(MouseEvent.prototype,"wheel",{get:function(){var e=this.event;return e.detail?-1*e.detail:e.wheelDelta?e.wheelDelta/120:0},enumerable:!0,configurable:!0}),Object.defineProperty(MouseEvent.prototype,"movementDelta",{get:function(){var e=this.event,t=null,r=null;if(this._isPointerLocked())t=e.movementX||e.webkitMovementX||e.mozMovementX||0,r=e.movementY||e.webkitMovementY||e.mozMovementY||0;else{var n=this.location,i=this.lastX,a=this.lastY;null===i&&null===a?(t=0,r=0):(t=n.x-i,r=n.y-a)}return{x:t,y:r}},enumerable:!0,configurable:!0}),MouseEvent.prototype.clone=function(){var e=MouseEvent.create(this.event,this.name);return this.copyMember(e,this,["target","currentTarget","isStopPropagation","phase","lastX","lastY"])},MouseEvent.prototype._isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)},MouseEvent}(e.DomEvent);e.MouseEvent=t}(wd||(wd={}));var wd;!function(e){var t={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},r={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},n=function(n){function KeyboardEvent(){n.apply(this,arguments),this.p_type=e.EEventType.KEYBOARD,this.keyState=null}return __extends(KeyboardEvent,n),KeyboardEvent.create=function(e,t){var r=new this(e,t);return r},Object.defineProperty(KeyboardEvent.prototype,"ctrlKey",{get:function(){return this.event.ctrlKey},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"altKey",{get:function(){return this.event.altKey},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"shiftKey",{get:function(){return this.event.shiftKey},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"metaKey",{get:function(){return this.event.metaKey},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"keyCode",{get:function(){return this.event.keyCode},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"key",{get:function(){var e=t[this.keyCode],n=null;return e?e:(n=String.fromCharCode(this.keyCode).toLowerCase(),this.shiftKey?r[n]:n)},enumerable:!0,configurable:!0}),KeyboardEvent.prototype.clone=function(){var e=KeyboardEvent.create(this.event,this.name);return this.copyMember(e,this,["target","currentTarget","isStopPropagation","phase","altKey","shiftKey","ctrlKey","metaKey","keyCode","key"])},KeyboardEvent}(e.DomEvent);e.KeyboardEvent=n}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomEvent(){t.apply(this,arguments),this.userData=null,this.p_type=e.EEventType.CUSTOM}return __extends(CustomEvent,t),CustomEvent.create=function(e){var t=new this(e);return t},CustomEvent.prototype.copyPublicAttri=function(t,r){return wdCb.ExtendUtils.extend(t,function(t,r){return"_"!==r.slice(0,1)&&!e.JudgeUtils.isFunction(t)}),t},CustomEvent.prototype.clone=function(){var e=CustomEvent.create(this.name);return this.copyMember(e,this,["target","currentTarget","isStopPropagation","phase"])},CustomEvent.prototype.getDataFromDomEvent=function(e){this.target=e.target,this.currentTarget=e.currentTarget,this.isStopPropagation=e.isStopPropagation},CustomEvent}(e.Event);e.CustomEvent=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.CENTER=2]="CENTER"}(e.EMouseButton||(e.EMouseButton={}));e.EMouseButton}(wd||(wd={}));var wd;!function(e){var t=function(){function EventListener(e){this.eventType=null,this.priority=null,this.handlerDataList=wdCb.Collection.create(),this.eventType=e.eventType,this.priority=e.priority||1}return EventListener.create=function(e){var t=new this(e);return t.initWhenCreate(e),t},EventListener.prototype.initWhenCreate=function(e){this._setHandlerDataList(e)},EventListener.prototype._setHandlerDataList=function(e){var t=null,r=/on\w+/;for(t in e)e.hasOwnProperty(t)&&r.test(t)&&this.handlerDataList.addChild({eventName:this._parseEventName(t),handler:e[t]})},EventListener.prototype._parseEventName=function(e){return e.slice(2).toLowerCase()},EventListener}();e.EventListener=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventHandler(){}return EventHandler}();e.EventHandler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DomEventHandler(){t.apply(this,arguments)}return __extends(DomEventHandler,t),DomEventHandler.prototype.off=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=this,i=e.DomEventRegister.getInstance(),a=null;a=i.remove.apply(i,t),a&&a.forEach(function(e){e.forEach(function(e){n._unBind(e.dom,e.eventName,e.domHandler)})})},DomEventHandler.prototype.trigger=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null,a=null,o=null;1===t.length?(i=t[0],n=this.getDefaultDom()):(n=t[0],i=t[1]),a=i.name,o=e.DomEventRegister.getInstance().getEventRegisterDataList(n,a),null!==o&&0!==o.getCount()&&o.forEach(function(e){var t=i.clone();e.handler(t,e.eventData)})},DomEventHandler.prototype.clearHandler=function(){},DomEventHandler.prototype.buildDomHandler=function(t,r){var n=this,i=e.root;return wdCb.EventUtils.bindEvent(i,function(e){n.triggerDomEvent(t,e,r)})},DomEventHandler.prototype.handler=function(t,r,n,i){var a=null,o=n;n=this.addEngineHandler(r,n),a=e.DomEventRegister.getInstance().isBinded(t,r)?e.DomEventRegister.getInstance().getDomHandler(t,r):this._bind(t,r),e.DomEventRegister.getInstance().register(t,r,this.createEventData(),n,o,a,i)},DomEventHandler.prototype._bind=function(t,r){var n=null;return n=this.buildDomHandler(t,r),wdCb.EventUtils.addEvent(t,e.EventNameHandler.handleEventName(r),n),n},DomEventHandler.prototype._unBind=function(t,r,n){wdCb.EventUtils.removeEvent(t,e.EventNameHandler.handleEventName(r),n)},__decorate([e.virtual],DomEventHandler.prototype,"clearHandler",null),DomEventHandler}(e.EventHandler);e.DomEventHandler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MouseEventHandler(){t.call(this)}return __extends(MouseEventHandler,t),MouseEventHandler.getInstance=function(){},MouseEventHandler.prototype.on=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null,n=null,i=null,a=null;3===e.length?(r=this.getDefaultDom(),n=e[0],i=e[1],a=e[2]):(r=e[0],n=e[1],i=e[2],a=e[3]),this.handler(r,n,i,a)},MouseEventHandler.prototype.getDefaultDom=function(){return document.body},MouseEventHandler.prototype.triggerDomEvent=function(t,r,n){var i=this._createEventObject(t,r,n);e.EventManager.trigger(t,i)},MouseEventHandler.prototype.addEngineHandler=function(t,r){var n=null;switch(t){case e.EEventName.MOUSEMOVE:n=this._handleMove(r);break;default:n=r}return n},MouseEventHandler.prototype.createEventData=function(){var e=wdCb.Hash.create();return e.addChild("lastX",null),e.addChild("lastY",null),e},MouseEventHandler.prototype._handleMove=function(e){var t=this;return function(r,n){t._copyEventDataToEventObject(r,n),e(r),t._saveLocation(r,n)}},MouseEventHandler.prototype._createEventObject=function(t,r,n){var i=e.MouseEvent.create(r?r:e.root.event,n);return i.target=t,i},MouseEventHandler.prototype._copyEventDataToEventObject=function(e,t){e.lastX=t.getChild("lastX"),e.lastY=t.getChild("lastY")},MouseEventHandler.prototype._saveLocation=function(e,t){var r=e.location;t.addChild("lastX",r.x),t.addChild("lastY",r.y)},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(4===t.length){var n=t[0];e.assert(e.JudgeUtils.isDom(n),e.Log.info.FUNC_MUST_BE("first param","HTMLElement"))}})],MouseEventHandler.prototype,"on",null),MouseEventHandler=__decorate([e.singleton()],MouseEventHandler)}(e.DomEventHandler);e.MouseEventHandler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function KeyboardEventHandler(){t.call(this)}return __extends(KeyboardEventHandler,t),KeyboardEventHandler.getInstance=function(){},KeyboardEventHandler.prototype.on=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null,a=null;3===t.length?(n=t[0],i=t[1],a=t[2]):(e.Log.warn("keyboard event can only bind on document.body"),n=t[1],i=t[2],a=t[3]),this.handler(this.getDefaultDom(),n,i,a)},KeyboardEventHandler.prototype.triggerDomEvent=function(t,r,n){var i=this._createEventObject(t,r,n);e.EventManager.trigger(t,i)},KeyboardEventHandler.prototype.getDefaultDom=function(){return document.body},KeyboardEventHandler.prototype.addEngineHandler=function(t,r){var n=null;switch(t){case e.EEventName.KEYDOWN:n=this._handleKeyDown(r);break;case e.EEventName.KEYUP:n=this._handleKeyUp(r);break;default:n=r}return n},KeyboardEventHandler.prototype.createEventData=function(){var e=wdCb.Hash.create();return e.addChild("keyState",{}),e},KeyboardEventHandler.prototype._handleKeyDown=function(e){var t=this;return function(r,n){var i=n.getChild("keyState");t._setKeyStateAllFalse(i),i[r.key]=!0,t._copyEventDataToEventObject(r,n),e(r)}},KeyboardEventHandler.prototype._handleKeyUp=function(e){var t=this;return function(r,n){
t._setKeyStateAllFalse(n.getChild("keyState")),t._copyEventDataToEventObject(r,n),e(r)}},KeyboardEventHandler.prototype._copyEventDataToEventObject=function(e,t){e.keyState=t.getChild("keyState")},KeyboardEventHandler.prototype._setKeyStateAllFalse=function(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=!1)},KeyboardEventHandler.prototype._createEventObject=function(t,r,n){var i=e.KeyboardEvent.create(r?r:e.root.event,n);return i.target=t,i},KeyboardEventHandler=__decorate([e.singleton()],KeyboardEventHandler)}(e.DomEventHandler);e.KeyboardEventHandler=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomEventHandler(){t.call(this)}return __extends(CustomEventHandler,t),CustomEventHandler.getInstance=function(){},CustomEventHandler.prototype.on=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(3===t.length){var n=t[0],i=t[1],a=i,o=t[2];e.CustomEventRegister.getInstance().register(null,n,i,a,null,o)}else if(4===t.length){var s=t[0],n=t[1],i=t[2],a=i,o=t[3];e.CustomEventRegister.getInstance().register(s,n,i,a,null,o)}},CustomEventHandler.prototype.off=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=e.CustomEventRegister.getInstance();n.remove.apply(n,t)},CustomEventHandler.prototype.trigger=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;if(1===e.length||2===e.length){var n=null;return 1===e.length?r=e[0]:(r=e[0],n=e[1]),this._triggerEventHandler(r,n)}if(3===e.length||4===e.length){var i=null,n=null,a=null;return 3===e.length?(i=e[0],r=e[1],a=e[2]):(i=e[0],r=e[1],n=e[2],a=e[3]),this._triggerTargetAndEventHandler(i,r,n,a)}},CustomEventHandler.prototype._triggerEventHandler=function(t,r){var n=null,i=this;return n=e.CustomEventRegister.getInstance().getEventRegisterDataList(t.name),null!==n&&0!==n.getCount()&&(n.forEach(function(e){t.currentTarget=e.target,t.target=e.target,i._setUserData(t,r),e.handler(t)}),!0)},CustomEventHandler.prototype._triggerTargetAndEventHandler=function(t,r,n,i){var a=null,o=!1,s=this;return i||(r.target=t),a=e.CustomEventRegister.getInstance().getEventRegisterDataList(t,r.name),null!==a&&0!==a.getCount()&&(a.forEach(function(e){r.currentTarget=e.target,s._setUserData(r,n),e.handler(r),r.isStopPropagation&&(o=!0)}),o)},CustomEventHandler.prototype._setUserData=function(e,t){t&&(e.userData=t)},CustomEventHandler=__decorate([e.singleton()],CustomEventHandler)}(e.EventHandler);e.CustomEventHandler=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventDispatcher(){}return EventDispatcher}();e.EventDispatcher=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomEventDispatcher(){t.call(this)}return __extends(CustomEventDispatcher,t),CustomEventDispatcher.getInstance=function(){},CustomEventDispatcher.prototype.trigger=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t.length;if(1===n){var i=t[0],a=i.type;return e.EventHandlerFactory.createEventHandler(a).trigger(i)}if(2===n&&e.EventUtils.isEvent(t[0])){var o=t[0],s=t[1],a=o.type;return e.EventHandlerFactory.createEventHandler(a).trigger(o,s)}if(2===n&&e.EventUtils.isEntityObject(t[0])||3===n&&e.JudgeUtils.isBoolean(t[2])){var c=t[0],u=t[1],l=void 0!==t[2]&&t[2],a=u.type;return e.EventHandlerFactory.createEventHandler(a).trigger(c,u,l)}if(3===n||4===n){var c=t[0],d=t[1],s=t[2],l=void 0!==t[3]&&t[3],a=d.type;return e.EventHandlerFactory.createEventHandler(a).trigger(c,d,s,l)}},CustomEventDispatcher.prototype.emit=function(t,r,n){var i=!1;if(t){r.phase=e.EEventPhase.EMIT,r.target=t;do{if(i=this._triggerWithUserData(t,r,n,!0))break;t=t.bubbleParent}while(t)}},CustomEventDispatcher.prototype.broadcast=function(t,r,n){var i=this,a=function(e){var t=e.getChildren();0!==t.getCount()&&t.forEach(function(e){i._triggerWithUserData(e,r,n,!0),a(e)})};t&&(r.phase=e.EEventPhase.BROADCAST,r.target=t,this._triggerWithUserData(t,r,n,!0),a(t))},CustomEventDispatcher.prototype._triggerWithUserData=function(e,t,r,n){return r?this.trigger(e,t,r,n):this.trigger(e,t,n)},CustomEventDispatcher=__decorate([e.singleton()],CustomEventDispatcher)}(e.EventDispatcher);e.CustomEventDispatcher=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DomEventDispatcher(){t.call(this)}return __extends(DomEventDispatcher,t),DomEventDispatcher.getInstance=function(){},DomEventDispatcher.prototype.trigger=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(1===t.length){var n=t[0],i=n.type;e.EventHandlerFactory.createEventHandler(i).trigger(n)}else if(2===t.length){var a=t[0],o=t[1],i=o.type;e.EventHandlerFactory.createEventHandler(i).trigger(a,o)}},DomEventDispatcher=__decorate([e.singleton()],DomEventDispatcher)}(e.EventDispatcher);e.DomEventDispatcher=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventRegister(){}return EventRegister.prototype.getEventRegisterDataList=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=this.listenerMap.getChild.apply(this.listenerMap,e);return r?r.sort(function(e,t){return t.priority-e.priority}):null},EventRegister.prototype.filter=function(e){return this.listenerMap.filter(e)},EventRegister.prototype.forEach=function(e){return this.listenerMap.forEach(e)},EventRegister.prototype.getChild=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return this.listenerMap.getChild.apply(this.listenerMap,Array.prototype.slice.call(arguments,0))},EventRegister.prototype.getEventNameFromKey=function(e){return this.listenerMap.getEventNameFromKey(e)},EventRegister}();e.EventRegister=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomEventRegister(){t.call(this),this.listenerMap=e.CustomEventListenerMap.create()}return __extends(CustomEventRegister,t),CustomEventRegister.getInstance=function(){},CustomEventRegister.prototype.register=function(e,t,r,n,i,a){this.listenerMap.appendChild(e,t,{target:e,eventName:t,handler:r,originHandler:n,domHandler:i,priority:a})},CustomEventRegister.prototype.remove=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0];if(1===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0];this.listenerMap.removeChild(i)}else if(1===t.length&&t[0]instanceof e.EntityObject)this.listenerMap.removeChild(n),this._handleAfterAllEventHandlerRemoved(n);else if(2===t.length&&e.JudgeUtils.isFunction(t[1])){var i=t[0],a=t[1];this.listenerMap.removeChild(i,a)}else if(2===t.length&&e.JudgeUtils.isNumber(t[0])){var o=t[0],i=t[1];this.listenerMap.removeChild(o,i)}else(2===t.length&&t[0]instanceof e.EntityObject||3===t.length)&&(this.listenerMap.removeChild.apply(this.listenerMap,t),this._isAllEventHandlerRemoved(n)&&this._handleAfterAllEventHandlerRemoved(n))},CustomEventRegister.prototype.setBubbleParent=function(e,t){e.bubbleParent=t},CustomEventRegister.prototype.getUidFromKey=function(e){return this.listenerMap.getUidFromKey(e)},CustomEventRegister.prototype.isTarget=function(e,t,r){return this.listenerMap.isTarget(e,t,r)},CustomEventRegister.prototype._isAllEventHandlerRemoved=function(e){return!this.listenerMap.hasChildWithFunc(function(t,r){return r.indexOf(String(e.uid))>-1&&t&&t.getCount()>0})},CustomEventRegister.prototype._handleAfterAllEventHandlerRemoved=function(e){this.setBubbleParent(e,null)},CustomEventRegister=__decorate([e.singleton()],CustomEventRegister)}(e.EventRegister);e.CustomEventRegister=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DomEventRegister(){t.call(this),this.listenerMap=e.DomEventListenerMap.create()}return __extends(DomEventRegister,t),DomEventRegister.getInstance=function(){},DomEventRegister.prototype.register=function(e,t,r,n,i,a,o){this.listenerMap.appendChild(e,t,{dom:e,eventName:t,eventData:r,handler:n,originHandler:i,domHandler:a,priority:o})},DomEventRegister.prototype.remove=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;if(1===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0];n=this.listenerMap.removeChild(i)}else if(2===t.length&&e.JudgeUtils.isFunction(t[1])){var i=t[0],a=t[1];n=this.listenerMap.removeChild(i,a)}else(2===t.length&&e.JudgeUtils.isDom(t[0])||3===t.length)&&(n=this.listenerMap.removeChild.apply(this.listenerMap,t));return n},DomEventRegister.prototype.isBinded=function(e,t){return this.listenerMap.hasChild(e,t)},DomEventRegister.prototype.isDom=function(e,t,r){return this.listenerMap.isDom(e,t,r)},DomEventRegister.prototype.getDomHandler=function(e,t){var r=this.getChild(e,t);if(r&&r.getCount()>0)return r.getChild(0).domHandler},DomEventRegister=__decorate([e.singleton()],DomEventRegister)}(e.EventRegister);e.DomEventRegister=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventBinder(){}return EventBinder}();e.EventBinder=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomEventBinder(){t.call(this)}return __extends(CustomEventBinder,t),CustomEventBinder.getInstance=function(){},CustomEventBinder.prototype.on=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(2===t.length){var n=t[0],i=t[1];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(n)).on(n,i)}else if(3===t.length&&e.JudgeUtils.isString(t[0])){var n=t[0],i=t[1],a=t[2];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(n)).on(n,i,a)}else if(3===t.length&&t[0]instanceof e.EntityObject){var o=t[0],n=t[1],i=t[2];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(n)).on(o,n,i)}else if(4===t.length){var o=t[0],n=t[1],i=t[2],a=t[3];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(n)).on(o,n,i,a)}},CustomEventBinder.prototype.off=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=e.CustomEventRegister.getInstance();if(0===t.length)n.forEach(function(t,r){var i=n.getEventNameFromKey(r),a=n.getUidFromKey(r);a?e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).off(a,i):e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).off(i)});else if(1===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0];n.forEach(function(t,r){var a=n.getEventNameFromKey(r);a===i&&e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).off(i)})}else if(1===t.length&&t[0]instanceof e.EntityObject){var a=t[0];n.forEach(function(t,r){var i=n.getEventNameFromKey(r);n.isTarget(r,a,t)&&e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).off(a,i)})}else if(2===t.length&&e.JudgeUtils.isString(t[0])){var o=t[0],s=t[1];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(o)).off(o,s)}else if(2===t.length&&t[0]instanceof e.EntityObject){var c=t[0],o=t[1];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(o)).off(c,o)}else if(3===t.length&&t[0]instanceof e.EntityObject){var c=t[0],o=t[1],s=t[2];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(o)).off(c,o,s)}},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=function(t){e.assert(t.indexOf(e.CustomEventListenerMap.eventSeparator)===-1,e.Log.info.FUNC_SHOULD_NOT("eventName","contain "+e.CustomEventListenerMap.eventSeparator))};if(1===t.length);else if(2===t.length){var i=t[0];n(i)}else if(3===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0];n(i)}else if(3===t.length&&t[0]instanceof e.EntityObject){var i=t[1];n(i)}else if(4===t.length){var i=t[1];n(i)}})],CustomEventBinder.prototype,"on",null),CustomEventBinder=__decorate([e.singleton()],CustomEventBinder)}(e.EventBinder);e.CustomEventBinder=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DomEventBinder(){t.call(this)}return __extends(DomEventBinder,t),DomEventBinder.getInstance=function(){},DomEventBinder.prototype.on=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(1===t.length){var n=t[0]instanceof e.EventListener?t[0]:e.EventListener.create(t[0]);n.handlerDataList.forEach(function(t){e.EventHandlerFactory.createEventHandler(n.eventType).on(t.eventName,t.handler,n.priority)})}else if(2===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0],a=t[1];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).on(i,a)}else if(2===t.length&&e.JudgeUtils.isDom(t[0])){var o=t[0],s=t[0]instanceof e.EventListener?t[0]:e.EventListener.create(t[0]);s.handlerDataList.forEach(function(t){e.EventHandlerFactory.createEventHandler(s.eventType).on(o,t.eventName,t.handler,s.priority)})}else if(3===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0],a=t[1],c=t[2];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).on(i,a,c)}else if(3===t.length&&e.JudgeUtils.isDom(t[0])){var u=t[0],i=t[1],a=t[2];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).on(u,i,a)}else if(4===t.length){var u=t[0],i=t[1],a=t[2],c=t[3];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).on(u,i,a,c)}},DomEventBinder.prototype.off=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=e.DomEventRegister.getInstance();if(0===t.length)n.forEach(function(t,r){var i=n.getEventNameFromKey(r);e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).off(i)});else if(1===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0];n.forEach(function(t,r){var a=n.getEventNameFromKey(r);a===i&&e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).off(i)})}else if(1===t.length&&e.JudgeUtils.isDom(t[0])){var a=t[0];n.forEach(function(t,r){var i=n.getEventNameFromKey(r);n.isDom(r,a,t)&&e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(i)).off(a,i)})}else if(2===t.length&&e.JudgeUtils.isString(t[0])){var o=t[0],s=t[1];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(o)).off(o,s)}else if(2===t.length&&e.JudgeUtils.isDom(t[0])){var c=t[0],o=t[1];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(o)).off(c,o)}else if(3===t.length){var c=t[0],o=t[1],s=t[2];e.EventHandlerFactory.createEventHandler(e.EventTable.getEventType(o)).off(c,o,s)}},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=function(t){e.assert(t.indexOf(e.DomEventListenerMap.eventSeparator)===-1,e.Log.info.FUNC_SHOULD_NOT("eventName","contain "+e.DomEventListenerMap.eventSeparator))};if(1===t.length);else if(2===t.length);else if(3===t.length&&e.JudgeUtils.isString(t[0])){var i=t[0];n(i)}else if(3===t.length&&e.JudgeUtils.isDom(t[0])){var i=t[1];n(i)}else if(4===t.length){var i=t[1];n(i)}})],DomEventBinder.prototype,"on",null),DomEventBinder=__decorate([e.singleton()],DomEventBinder)}(e.EventBinder);e.DomEventBinder=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventHandlerFactory(){}return EventHandlerFactory.createEventHandler=function(t){var r=null;switch(t){case e.EEventType.MOUSE:r=e.MouseEventHandler.getInstance();break;case e.EEventType.KEYBOARD:r=e.KeyboardEventHandler.getInstance();break;case e.EEventType.CUSTOM:r=e.CustomEventHandler.getInstance();break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("eventType"))}return r},EventHandlerFactory}();e.EventHandlerFactory=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventBinderFactory(){}return EventBinderFactory.createEventBinder=function(t){var r=null,n=e.EventTable.getEventType(t);switch(n){case e.EEventType.MOUSE:case e.EEventType.KEYBOARD:r=e.DomEventBinder.getInstance();break;case e.EEventType.CUSTOM:r=e.CustomEventBinder.getInstance();break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("eventName:"+t))}return r},EventBinderFactory}();e.EventBinderFactory=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventDispatcherFactory(){}return EventDispatcherFactory.createEventDispatcher=function(t){var r=null,n=t.type;switch(n){case e.EEventType.MOUSE:case e.EEventType.KEYBOARD:r=e.DomEventDispatcher.getInstance();break;case e.EEventType.CUSTOM:r=e.CustomEventDispatcher.getInstance();break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("event:"+t))}return r},EventDispatcherFactory}();e.EventDispatcherFactory=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventUtils(){}return EventUtils.isEvent=function(e){return e&&void 0!==e.currentTarget},EventUtils.isEntityObject=function(e){return e&&void 0!==e.bubbleParent},__decorate([e.ensure(function(t,r){t&&e.assert(r instanceof e.EntityObject,e.Log.info.FUNC_MUST_BE("EntityObject, but actual is "+r))})],EventUtils,"isEntityObject",null),EventUtils}();e.EventUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventManager(){}return EventManager.on=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(1===t.length){var n=t[0],i=e.DomEventBinder.getInstance();i.on(n)}else if(2===t.length&&e.JudgeUtils.isString(t[0])){var a=t[0],o=t[1],s=1,i=e.EventBinderFactory.createEventBinder(a);i.on(a,o,s)}else if(2===t.length&&e.JudgeUtils.isDom(t[0])){var c=t[0],n=t[1],i=e.DomEventBinder.getInstance();i.on(c,n)}else if(3===t.length&&e.JudgeUtils.isString(t[0])){var a=t[0],o=t[1],s=t[2],i=e.EventBinderFactory.createEventBinder(a);i.on(a,o,s)}else if(3===t.length&&t[0]instanceof e.EntityObject){var u=t[0],a=t[1],o=t[2],s=1,i=e.CustomEventBinder.getInstance();i.on(u,a,o,s)}else if(3===t.length&&e.JudgeUtils.isDom(t[0])){var c=t[0],a=t[1],o=t[2],s=1,i=e.DomEventBinder.getInstance();i.on(c,a,o,s)}else if(4===t.length&&t[0]instanceof e.EntityObject){var u=t[0],a=t[1],o=t[2],s=t[3],i=e.CustomEventBinder.getInstance();i.on(u,a,o,s)}else if(4===t.length&&e.JudgeUtils.isDom(t[0])){var c=t[0],a=t[1],o=t[2],s=t[3],i=e.DomEventBinder.getInstance();i.on(c,a,o,s)}},EventManager.off=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(0===t.length){var n=e.CustomEventBinder.getInstance(),i=e.DomEventBinder.getInstance();n.off(),i.off()}else if(1===t.length&&e.JudgeUtils.isString(t[0])){var a=t[0],o=e.EventBinderFactory.createEventBinder(a);o.off(a)}else if(1===t.length&&t[0]instanceof e.EntityObject){var a=t[0],o=e.CustomEventBinder.getInstance();o.off(a)}else if(1===t.length&&e.JudgeUtils.isDom(t[0])){var a=t[0],o=e.DomEventBinder.getInstance();o.off(a)}else if(2===t.length&&e.JudgeUtils.isString(t[0])){var a=t[0],s=t[1],o=e.EventBinderFactory.createEventBinder(a);o.off(a,s)}else if(2===t.length&&t[0]instanceof e.EntityObject){var c=t[0],a=t[1],o=e.CustomEventBinder.getInstance();o.off(c,a)}else if(2===t.length&&e.JudgeUtils.isDom(t[0])){var u=t[0],a=t[1],o=e.DomEventBinder.getInstance();o.off(u,a)}else if(3===t.length&&t[0]instanceof e.EntityObject){var c=t[0],a=t[1],s=t[2],o=e.CustomEventBinder.getInstance();o.off(c,a,s)}else if(3===t.length&&e.JudgeUtils.isDom(t[0])){var u=t[0],a=t[1],s=t[2],o=e.DomEventBinder.getInstance();o.off(u,a,s)}},EventManager.trigger=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t.length;if(1===n){var i=t[0],a=e.EventDispatcherFactory.createEventDispatcher(i);a.trigger(i)}else if(2===n&&e.EventUtils.isEvent(t[0])){var o=t[0],s=t[1],a=e.CustomEventDispatcher.getInstance();a.trigger(o,s)}else if(2===n&&e.EventUtils.isEntityObject(t[0])){var c=t[0],u=t[1],a=e.CustomEventDispatcher.getInstance();if(!c)return;a.trigger(c,u)}else if(2===n){var l=t[0],d=t[1],a=e.DomEventDispatcher.getInstance();if(!l)return;a.trigger(l,d)}else if(3===n){var c=t[0],h=t[1],s=t[2],a=e.CustomEventDispatcher.getInstance();if(!c)return;a.trigger(c,h,s)}else if(4===n){var c=t[0],p=t[1],s=t[2],f=t[3],a=e.CustomEventDispatcher.getInstance();if(!c)return;a.trigger(c,p,s,f)}},EventManager.broadcast=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=e.CustomEventDispatcher.getInstance();n.broadcast.apply(n,t)},EventManager.emit=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=e.CustomEventDispatcher.getInstance();n.emit.apply(n,t)},EventManager.fromEvent=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null;if(1===t.length){var a=t[0];n=function(e){EventManager.on(a,e)},i=function(e){EventManager.off(a,e)}}else if(2===t.length&&e.JudgeUtils.isNumber(t[1])){var o=t[0],s=t[1];n=function(e){EventManager.on(o,e,s)},i=function(e){EventManager.off(o,e)}}else if(2===t.length){var c=t[1];n=function(e){EventManager.on(t[0],c,e)},i=function(e){EventManager.off(t[0],c,e)}}else if(3===t.length){var u=t[1],l=t[2];n=function(e){EventManager.on(t[0],u,e,l)},i=function(e){EventManager.off(t[0],u,e)}}return wdFrp.fromEventPattern(n,i)},EventManager.setBubbleParent=function(t,r){e.CustomEventRegister.getInstance().setBubbleParent(t,r)},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(t[0]instanceof e.EntityObject){var n=t[1];e.assert(e.EventTable.getEventType(n)===e.EEventType.CUSTOM,e.Log.info.FUNC_MUST_BE("event","custom event"))}else if(e.JudgeUtils.isDom(t[0])){var n=t[1],i=e.EventTable.getEventType(n);e.assert(i===e.EEventType.MOUSE||i===e.EEventType.KEYBOARD,e.Log.info.FUNC_MUST_BE("event","dom event"))}})],EventManager,"on",null),__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(t.length>2&&t[0]instanceof e.EntityObject){var n=t[1];e.assert(e.EventTable.getEventType(n)===e.EEventType.CUSTOM,e.Log.info.FUNC_MUST_BE("event","custom event"))}else if(t.length>2&&e.JudgeUtils.isDom(t[0])){var n=t[1],i=e.EventTable.getEventType(n);e.assert(i===e.EEventType.MOUSE||i===e.EEventType.KEYBOARD,e.Log.info.FUNC_MUST_BE("event","dom event"))}})],EventManager,"off",null),__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(2===t.length&&t[0]instanceof e.Event){var n=t[0];e.assert(n instanceof e.CustomEvent,e.Log.info.FUNC_MUST_BE("event type","CUSTOM"))}else if(2===t.length&&t[0]instanceof e.EntityObject);else if(2===t.length)t[0]&&e.assert(e.JudgeUtils.isDom(t[0]),e.Log.info.FUNC_MUST_BE("the first param","dom"));else if(t[0]instanceof e.EntityObject){var i=t[1];e.assert(i instanceof e.CustomEvent,e.Log.info.FUNC_MUST_BE("event type","CUSTOM"))}})],EventManager,"trigger",null),__decorate([e.require(function(t,r,n){e.assert(r instanceof e.CustomEvent,e.Log.info.FUNC_MUST_BE("eventObject","CustomEvent"))})],EventManager,"broadcast",null),__decorate([e.require(function(t,r,n){e.assert(r instanceof e.CustomEvent,e.Log.info.FUNC_MUST_BE("eventObject","CustomEvent"))})],EventManager,"emit",null),__decorate([e.require(function(t,r){e.assert(t instanceof e.EntityObject,"only EntityObject can setBubleParent")})],EventManager,"setBubbleParent",null),EventManager}();e.EventManager=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.STARTLOOP="wd_startLoop"]="STARTLOOP",e[e.ENDLOOP="wd_endLoop"]="ENDLOOP",e[e.MOUSE_CLICK="wd_mouseclick"]="MOUSE_CLICK",e[e.MOUSE_DOWN="wd_mousedown"]="MOUSE_DOWN",e[e.MOUSE_UP="wd_mouseup"]="MOUSE_UP",e[e.MOUSE_MOVE="wd_mousemove"]="MOUSE_MOVE",e[e.MOUSE_OVER="wd_mouseover"]="MOUSE_OVER",e[e.MOUSE_OUT="wd_mouseout"]="MOUSE_OUT",e[e.MOUSE_WHEEL="wd_mousewheel"]="MOUSE_WHEEL",e[e.MOUSE_DRAG="wd_mousedrag"]="MOUSE_DRAG",e[e.MATERIAL_CHANGE="wd_material_change"]="MATERIAL_CHANGE",e[e.MATERIAL_COLOR_CHANGE="wd_material_color_change"]="MATERIAL_COLOR_CHANGE",e[e.UI_WIDTH_CHANGE="wd_ui_width_change"]="UI_WIDTH_CHANGE",e[e.UI_HEIGHT_CHANGE="wd_ui_height_change"]="UI_HEIGHT_CHANGE",e[e.TRANSFORM_TRANSLATE="wd_transform_translate"]="TRANSFORM_TRANSLATE",e[e.TRANSFORM_ROTATE="wd_transform_rotate"]="TRANSFORM_ROTATE",e[e.TRANSFORM_SCALE="wd_transform_scale"]="TRANSFORM_SCALE",e[e.SHADOWMAP_SOFTTYPE_CHANGE="wd_shadowMap_softType_change"]="SHADOWMAP_SOFTTYPE_CHANGE",e[e.SHADOWMAP_LAYER_CHANGE="wd_shadowMap_layer_change"]="SHADOWMAP_LAYER_CHANGE",e[e.COMPONENT_CHANGE="wd_component_change"]="COMPONENT_CHANGE",e[e.EXIT="wd_exit"]="EXIT",e[e.ENTER="wd_enter"]="ENTER"}(e.EEngineEvent||(e.EEngineEvent={}));e.EEngineEvent}(wd||(wd={}));var wd;!function(e){var t=function(){function ComponentInitOrderTable(){}return ComponentInitOrderTable.getOrder=function(t){return t instanceof e.SourceInstance?1:t instanceof e.Shadow?2:t instanceof e.ThreeDBitmapFont?3:t instanceof e.Geometry?4:5},ComponentInitOrderTable}();e.ComponentInitOrderTable=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Billboard(){t.apply(this,arguments),this.mode=e.EBillboardMode.ALL}return __extends(Billboard,t),Billboard.create=function(){var e=new this;return e},Billboard.prototype.addToObject=function(r,n){void 0===n&&(n=!1);var i=e.BillboardEngine.getInstance();t.prototype.addToObject.call(this,r,n),i.hasChild(this)||i.addChild(this)},Billboard.prototype.removeFromObject=function(r){t.prototype.removeFromObject.call(this,r),e.BillboardEngine.getInstance().removeChild(this)},Billboard.prototype.update=function(t){var r=e.Director.getInstance().scene.currentCamera;if(this.mode!==e.EBillboardMode.NONE&&r){var n=e.Vector3.create(),i=this.entityObject.transform,a=i.position,o=r.transform.position,s=null;s=this._rotateByYAxis(r,n,o,a,i),this.mode===e.EBillboardMode.ALL&&s&&this._rotateLocalByXAxis(r,n,o,a,i)}},Billboard.prototype._rotateByYAxis=function(t,r,n,i,a){var o=e.Vector3.create(),s=e.Vector3.create(),c=null,u=!1;return r.x=n.x-i.x,r.y=0,r.z=n.z-i.z,o.x=0,o.y=0,o.z=1,r.normalize(),s.cross(o,r),c=o.dot(r),c<.9999&&c>-.9999&&(u=!0,a.rotation=e.Quaternion.create().setFromAxisAngle(180*Math.acos(c)/Math.PI,s)),u},Billboard.prototype._rotateLocalByXAxis=function(t,r,n,i,a){var o=e.Vector3.create(),s=null;o.x=n.x-i.x,o.y=n.y-i.y,o.z=n.z-i.z,o.normalize(),s=r.dot(o),s<.9999&&s>-.9999&&(o.y<0?a.rotateLocal(180*Math.acos(s)/Math.PI,0,0):a.rotateLocal(180*-Math.acos(s)/Math.PI,0,0))},__decorate([e.cloneAttributeAsBasicType()],Billboard.prototype,"mode",void 0),Billboard}(e.Component);e.Billboard=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.NONE=0]="NONE",e[e.Y=1]="Y",e[e.ALL=2]="ALL"}(e.EBillboardMode||(e.EBillboardMode={}));e.EBillboardMode}(wd||(wd={}));var wd;!function(e){var t=function(t){function LOD(){t.apply(this,arguments)}return __extends(LOD,t),LOD.prototype.addToObject=function(r,n){void 0===n&&(n=!1);var i=e.LODEngine.getInstance();t.prototype.addToObject.call(this,r,n),i.hasChild(this)||i.addChild(this)},LOD.prototype.removeFromObject=function(r){t.prototype.removeFromObject.call(this,r),e.LODEngine.getInstance().removeChild(this)},LOD}(e.Component);e.LOD=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GeometryLOD(){t.apply(this,arguments),this.activeGeometry=null,this._levelList=wdCb.Collection.create(),this._originGeometry=null}return __extends(GeometryLOD,t),GeometryLOD.create=function(){var e=new this;return e},GeometryLOD.prototype.init=function(){var r=this.entityObject;this.activeGeometry=r.getComponent(e.Geometry),this._originGeometry=this.activeGeometry,this._levelList.filter(function(t){var r=t.geometry;t.distanceBetweenCameraAndObject;return r!==e.ELODState.INVISIBLE}).forEach(function(e){var t=e.geometry;e.distanceBetweenCameraAndObject;t.entityObject=r,t.init(),t.createBuffersFromGeometryData()}),t.prototype.init.call(this)},GeometryLOD.prototype.addLevel=function(e,t){this._levelList.addChild({distanceBetweenCameraAndObject:e,geometry:t}),this._levelList.sort(function(e,t){return t.distanceBetweenCameraAndObject-e.distanceBetweenCameraAndObject},!0)},GeometryLOD.prototype.update=function(t){var r=e.Vector3.create().sub2(e.Director.getInstance().scene.currentCamera.transform.position,this.entityObject.transform.position).length(),n=!0,i=null;return this._levelList.forEach(function(e){var t=e.geometry,a=e.distanceBetweenCameraAndObject;if(r>=a)return i=t,n=!1,wdCb.$BREAK}),i===e.ELODState.INVISIBLE?(this.activeGeometry=null,void(this.entityObject.isVisible=!1)):(this.entityObject.isVisible=!0,void(i&&!e.JudgeUtils.isEqual(i,this.activeGeometry)?(this.activeGeometry=i,e.EventManager.trigger(this.entityObject,e.CustomEvent.create(e.EEngineEvent.COMPONENT_CHANGE))):n&&(this.activeGeometry=this._originGeometry)))},__decorate([e.cloneAttributeAsCustomType(function(t,r,n,i){t._levelList.forEach(function(t){var n=null;n=t.geometry===e.ELODState.INVISIBLE?e.ELODState.INVISIBLE:i?t.geometry:t.geometry.clone(),r.addLevel(t.distanceBetweenCameraAndObject,n)})})],GeometryLOD.prototype,"_levelList",void 0),__decorate([e.require(function(){e.InstanceUtils.isHardwareSupport()&&e.assert(!e.InstanceUtils.isObjectInstance(this.entityObject),e.Log.info.FUNC_SHOULD_NOT("if hardware support instance, object instance","add lod component"))})],GeometryLOD.prototype,"update",null),GeometryLOD}(e.LOD);e.GeometryLOD=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GameObjectLOD(){t.apply(this,arguments),this.activeGameObject=null,this.defaultGameObjectSwitchHandler=function(e){},this._levelList=wdCb.Collection.create(),this._lastActiveGameObject=null,this._lastNotNullActiveGameObject=null}return __extends(GameObjectLOD,t),GameObjectLOD.create=function(){var e=new this;return e},GameObjectLOD.prototype.init=function(){var r=this.entityObject;this.activeGameObject=r,this._lastNotNullActiveGameObject=this.activeGameObject,this._levelList.filter(function(t){var r=t.gameObject;t.distanceBetweenCameraAndObject;return r!==e.ELODState.INVISIBLE}).forEach(function(e){var t=e.gameObject;e.distanceBetweenCameraAndObject;t.isVisible=!1,r.addChild(t)}),t.prototype.init.call(this)},GameObjectLOD.prototype.addLevel=function(e,t,r){void 0===r&&(r=function(e){}),this._levelList.addChild({distanceBetweenCameraAndObject:e,gameObject:t,switchHandler:r}),this._levelList.sort(function(e,t){return t.distanceBetweenCameraAndObject-e.distanceBetweenCameraAndObject},!0)},GameObjectLOD.prototype.update=function(t){var r=this,n=e.Director.getInstance().scene.currentCamera.transform.position,i=null,a=null;return null!==this.activeGameObject&&(this.activeGameObject.isVisible=!1),this._levelList.forEach(function(e){if(r._computeCurrentDistanceBetweenCameraAndObject(n,e.gameObject)>=e.distanceBetweenCameraAndObject)return i=e.gameObject,a=e.switchHandler,wdCb.$BREAK},this),i===e.ELODState.INVISIBLE?(null!==this.activeGameObject&&(this._lastNotNullActiveGameObject=this.activeGameObject),void(this.activeGameObject=null)):(null===i?(this.activeGameObject=this.entityObject,this.activeGameObject.isVisible=!0,this._isSwitch()&&this.defaultGameObjectSwitchHandler(this.entityObject)):(this.activeGameObject=i,this.activeGameObject.isVisible=!0,this._isSwitch()&&a(this.activeGameObject)),void(this._lastActiveGameObject=this.activeGameObject))},GameObjectLOD.prototype._computeCurrentDistanceBetweenCameraAndObject=function(t,r){var n=null;return n=r===e.ELODState.INVISIBLE?this._lastNotNullActiveGameObject:r,e.Vector3.create().sub2(t,n.transform.position).length()},GameObjectLOD.prototype._isSwitch=function(){return!e.JudgeUtils.isEqual(this.activeGameObject,this._lastActiveGameObject)},__decorate([e.cloneAttributeAsBasicType()],GameObjectLOD.prototype,"activeGameObject",void 0),__decorate([e.cloneAttributeAsBasicType()],GameObjectLOD.prototype,"defaultGameObjectSwitchHandler",void 0),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){t._levelList.forEach(function(t){var n=null;n=t.gameObject===e.ELODState.INVISIBLE?e.ELODState.INVISIBLE:t.gameObject.clone(),r.addLevel(t.distanceBetweenCameraAndObject,n,t.switchHandler)})})],GameObjectLOD.prototype,"_levelList",void 0),__decorate([e.ensure(function(){var t=this;e.it("should only activeGameObject is visible while others is not",function(){var r=t.activeGameObject;null!==r&&e.expect(r.isVisible).true,t._levelList.map(function(e){return e.gameObject}).addChild(t.entityObject).filter(function(t){return t!==e.ELODState.INVISIBLE&&!e.JudgeUtils.isEqual(t,r)}).forEach(function(t){e.expect(t.isVisible).false})})})],GameObjectLOD.prototype,"update",null),__decorate([e.require(function(){var t=this;e.it("_lastNotNullActiveGameObject shouldn't be null",function(){e.expect(t._lastNotNullActiveGameObject).not.null},this)})],GameObjectLOD.prototype,"_computeCurrentDistanceBetweenCameraAndObject",null),GameObjectLOD}(e.LOD);e.GameObjectLOD=t}(wd||(wd={}));
var wd;!function(e){!function(e){e[e.INVISIBLE=0]="INVISIBLE"}(e.ELODState||(e.ELODState={}));e.ELODState}(wd||(wd={}));var wd;!function(e){var t=function(t){function Instance(){t.apply(this,arguments)}return __extends(Instance,t),Instance.prototype.addToObject=function(e,r){void 0===r&&(r=!1),t.prototype.addToObject.call(this,e,r)},Instance.prototype.clone=function(){return e.CloneUtils.clone(this)},__decorate([e.require(function(t){e.assert(t instanceof e.GameObject,e.Log.info.FUNC_SHOULD("Instance component","add to GameObject"))})],Instance.prototype,"addToObject",null),Instance}(e.Component);e.Instance=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SourceInstance(){t.apply(this,arguments),this._instanceBuffer=null}return __extends(SourceInstance,t),Object.defineProperty(SourceInstance.prototype,"instanceBuffer",{get:function(){return null===this._instanceBuffer&&(this._instanceBuffer=e.InstanceBuffer.create()),this._instanceBuffer},enumerable:!0,configurable:!0}),SourceInstance}(e.Instance);e.SourceInstance=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToOneSourceInstance(){t.apply(this,arguments),this.instanceList=wdCb.Collection.create(),this._toRenderInstanceList=wdCb.Collection.create(),this._endLoopSubscription=null,this._isAddSourceInstanceToChildren=!1,this._enterSubscription=null,this._exitSubscription=null}return __extends(OneToOneSourceInstance,t),OneToOneSourceInstance.create=function(){var e=new this;return e},Object.defineProperty(OneToOneSourceInstance.prototype,"toRenderInstanceListForDraw",{get:function(){return this.hasToRenderInstance()||(this._toRenderInstanceList=this.defaultToRenderInstanceList),this._toRenderInstanceList},enumerable:!0,configurable:!0}),Object.defineProperty(OneToOneSourceInstance.prototype,"defaultToRenderInstanceList",{get:function(){return wdCb.Collection.create().addChild(this.entityObject).addChildren(this.instanceList)},enumerable:!0,configurable:!0}),OneToOneSourceInstance.prototype.init=function(){var t=this;this._isAddSourceInstanceToChildren||this._addSourceInstanceToChildren(),this._endLoopSubscription=e.EventManager.fromEvent(e.EEngineEvent.ENDLOOP).subscribe(function(){t._toRenderInstanceList.removeAllChildren()}),this._enterSubscription=e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.ENTER).subscribe(function(){t._addAllInstances()}),this._exitSubscription=e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.EXIT).subscribe(function(){t._removeAllInstances()})},OneToOneSourceInstance.prototype.dispose=function(){this._endLoopSubscription.dispose(),this._enterSubscription.dispose(),this._exitSubscription.dispose(),this.instanceList.forEach(function(e){e.dispose()})},OneToOneSourceInstance.prototype.cloneInstance=function(t){var r=this,n=this,i=function(t,a){var o=e.GameObject.create(),s=e.ObjectInstance.create(),c=null;return c=a.getComponent(OneToOneSourceInstance).instanceList,o.name=t,r._addComponentsFromSourceToObject(a,o),s.sourceObject=a,o.addComponent(s),o.bubbleParent=a.bubbleParent,o.parent=a.parent,o.isVisible=a.isVisible,a.getTagList().forEach(function(e){o.addTag(e)}),c.addChild(o),a.forEach(function(e){o.addChild(i(n._buildInstanceChildName(t,e.name),e))}),o};return this._addSourceInstanceToChildren(),this._isAddSourceInstanceToChildren=!0,i(t,this.entityObject)},OneToOneSourceInstance.prototype.hasToRenderInstance=function(){return this._toRenderInstanceList&&this._toRenderInstanceList.getCount()>0},OneToOneSourceInstance.prototype.addToRenderIntance=function(e){this._toRenderInstanceList.addChild(e)},OneToOneSourceInstance.prototype.forEachToRenderInstanceList=function(e){this._toRenderInstanceList.forEach(e)},OneToOneSourceInstance.prototype._addComponentsFromSourceToObject=function(t,r){r.removeComponent(e.Transform),t.forEachComponent(function(t){t instanceof OneToOneSourceInstance||t instanceof e.GeometryLOD||(t instanceof e.Geometry||t instanceof e.Script?r.addComponent(t,!0):r.addComponent(t.clone()))})},OneToOneSourceInstance.prototype._addSourceInstanceToChildren=function(){var t=function(r){if(!e.InstanceUtils.isOneToOneSourceInstance(r)){var n=OneToOneSourceInstance.create();r.addComponent(n),r.forEach(function(e){t(e)})}};this.entityObject.forEach(function(e){t(e)})},OneToOneSourceInstance.prototype._addAllInstances=function(){var t=this.entityObject.parent,r=e.EInstanceTag.isAddSourceInstance;this.instanceList.forEach(function(e){e.addTag(r),t.addChild(e),e.removeTag(r)})},OneToOneSourceInstance.prototype._removeAllInstances=function(){var t=e.EInstanceTag.isRemoveSourceInstance;this.instanceList.forEach(function(e){e.addTag(t),e.parent.removeChild(e),e.removeTag(t)})},OneToOneSourceInstance.prototype._buildInstanceChildName=function(e,t){return e+"_"+t},__decorate([e.ensureGetter(function(t){var r=this;e.it("should not be empty",function(){e.expect(t.getCount()).greaterThan(0)}),e.it("should render self entityObject or the entityObject in instanceList",function(){t.forEach(function(t){e.expect(e.JudgeUtils.isEqual(t,r.entityObject)||r.instanceList.hasChild(t)).true})},this),e.it("shouldn't has repeat instance which is to render",function(){e.expect(t.hasRepeatItems()).false})})],OneToOneSourceInstance.prototype,"toRenderInstanceListForDraw",null),__decorate([e.cloneAttributeAsCloneable()],OneToOneSourceInstance.prototype,"instanceList",void 0),__decorate([e.ensure(function(){var t=this;e.it("children should contain OneToOneSourceInstance component",function(){t.entityObject.forEach(function(t){e.IterateUtils.forEachAll(t,function(t){e.expect(e.InstanceUtils.isOneToOneSourceInstance(t)).true})})},this)})],OneToOneSourceInstance.prototype,"init",null),__decorate([e.require(function(){var t=this;e.it("instance is not only in instanceList but also in loop",function(){var r=null,n=null,i=!0;0!==t.instanceList.getCount()&&(r=e.Director.getInstance().scene,n=wdCb.Collection.create(),e.IterateUtils.forEachAll(r.gameObjectScene,function(e){n.addChild(e)}),t.instanceList.forEach(function(e){if(!n.hasChild(e))return i=!1,wdCb.$BREAK}),e.expect(i).true)},this)})],OneToOneSourceInstance.prototype,"dispose",null),__decorate([e.require(function(){var t=this.entityObject;e.it("space partition not support instance",function(){e.expect(t.hasComponent(e.SpacePartition)).false})}),e.ensure(function(t){e.it("should be object instance",function(){e.expect(e.InstanceUtils.isObjectInstance(t)).true})})],OneToOneSourceInstance.prototype,"cloneInstance",null),__decorate([e.ensure(function(t,r,n){e.it("instance should contain ThreeDTransform component",function(){e.expect(n.hasComponent(e.ThreeDTransform)).true})})],OneToOneSourceInstance.prototype,"_addComponentsFromSourceToObject",null),__decorate([e.ensure(function(){var t=this;e.it("children should contain only one OneToOneSourceInstance component",function(){e.IterateUtils.forEachAll(t.entityObject,function(t){e.expect(t.getComponents().filter(function(e){return e instanceof OneToOneSourceInstance}).getCount()).equal(1)})})})],OneToOneSourceInstance.prototype,"_addSourceInstanceToChildren",null),__decorate([e.ensure(function(){var t=this;e.it("instance shouldn't add EInstanceTag.isAddSourceInstance tag here",function(){t.instanceList.forEach(function(t){e.expect(t.hasTag(e.EInstanceTag.isAddSourceInstance)).false})},this)})],OneToOneSourceInstance.prototype,"_addAllInstances",null),__decorate([e.ensure(function(){var t=this;e.it("instance shouldn't add EInstanceTag.isRemoveSourceInstance tag here",function(){t.instanceList.forEach(function(t){e.expect(t.hasTag(e.EInstanceTag.isRemoveSourceInstance)).false})},this)})],OneToOneSourceInstance.prototype,"_removeAllInstances",null),OneToOneSourceInstance}(e.SourceInstance);e.OneToOneSourceInstance=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function OneToManySourceInstance(){e.apply(this,arguments)}return __extends(OneToManySourceInstance,e),OneToManySourceInstance.create=function(){var e=new this;return e},OneToManySourceInstance}(e.SourceInstance);e.OneToManySourceInstance=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ObjectInstance(){t.apply(this,arguments),this.sourceObject=null,this._enterSubscription=null,this._exitSubscription=null}return __extends(ObjectInstance,t),ObjectInstance.create=function(){var e=new this;return e},ObjectInstance.prototype.init=function(){var t=this,r=this.entityObject;this._enterSubscription=e.EventManager.fromEvent(r,e.EEngineEvent.ENTER).subscribe(function(){r.hasTag(e.EInstanceTag.isAddSourceInstance)||t._addToSourceAndItsChildren()}),this._exitSubscription=e.EventManager.fromEvent(r,e.EEngineEvent.EXIT).subscribe(function(){r.hasTag(e.EInstanceTag.isRemoveSourceInstance)||t._removeFromSourceAndItsChildren()})},ObjectInstance.prototype.dispose=function(){this._enterSubscription.dispose(),this._exitSubscription.dispose(),this._removeFromSourceAndItsChildren()},ObjectInstance.prototype._addToSourceAndItsChildren=function(){var t=function(r,n){r.getComponent(e.OneToOneSourceInstance).instanceList.addChild(n),n.forEach(function(e,n){t(r.getChild(n),e)})};t(this.sourceObject,this.entityObject)},ObjectInstance.prototype._removeFromSourceAndItsChildren=function(){var t=function(r,n){r.getComponent(e.OneToOneSourceInstance).instanceList.removeChild(n),n.forEach(function(e,n){t(r.getChild(n),e)})};t(this.sourceObject,this.entityObject)},__decorate([e.cloneAttributeAsBasicType()],ObjectInstance.prototype,"sourceObject",void 0),ObjectInstance}(e.Instance);e.ObjectInstance=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.isRemoveSourceInstance="isRemoveSourceInstance"]="isRemoveSourceInstance",e[e.isAddSourceInstance="isAddSourceInstance"]="isAddSourceInstance"}(e.EInstanceTag||(e.EInstanceTag={}));e.EInstanceTag}(wd||(wd={}));var wd;!function(e){var t=function(t){function EventTriggerDetector(){t.apply(this,arguments)}return __extends(EventTriggerDetector,t),EventTriggerDetector.prototype.clone=function(){return e.CloneUtils.clone(this)},EventTriggerDetector}(e.Component);e.EventTriggerDetector=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function UIEventTriggerDetector(){t.apply(this,arguments)}return __extends(UIEventTriggerDetector,t),UIEventTriggerDetector.create=function(){var e=new this;return e},UIEventTriggerDetector.prototype.isTrigger=function(t){var r=this.entityObject.transform,n=r.width,i=r.height,a=r.position,o=t.locationInView,s=null;return s=e.Vector2.create(a.x-n/2,a.y-i/2),e.EventTriggerDetectorUtils.isInRect(o,s,n,i)},UIEventTriggerDetector}(e.EventTriggerDetector);e.UIEventTriggerDetector=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RayCasterEventTriggerDetector(){t.apply(this,arguments)}return __extends(RayCasterEventTriggerDetector,t),RayCasterEventTriggerDetector.create=function(){var e=new this;return e},RayCasterEventTriggerDetector.prototype.isTrigger=function(t){var r=e.Director.getInstance().scene,n=r.currentCamera.getComponent(e.CameraController),i=t.locationInView;return n.isIntersectWithRay(this.entityObject,i.x,i.y)},RayCasterEventTriggerDetector}(e.EventTriggerDetector);e.RayCasterEventTriggerDetector=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SceneEventTriggerDetector(){t.apply(this,arguments)}return __extends(SceneEventTriggerDetector,t),SceneEventTriggerDetector.create=function(){var e=new this;return e},SceneEventTriggerDetector.prototype.isTrigger=function(t){var r=e.DeviceManager.getInstance().view,n=r.width,i=r.height,a=t.locationInView,o=e.Vector2.create(0,0);return e.EventTriggerDetectorUtils.isInRect(a,o,n,i)},SceneEventTriggerDetector}(e.EventTriggerDetector);e.SceneEventTriggerDetector=t}(wd||(wd={}));var wd;!function(e){var t=function(){function EventTriggerDetectorUtils(){}return EventTriggerDetectorUtils.isInRect=function(e,t,r,n){return e.x>=t.x&&e.x<=t.x+r&&e.y>=t.y&&e.y<=t.y+n},EventTriggerDetectorUtils}();e.EventTriggerDetectorUtils=t}(wd||(wd={}));var wd;!function(e){var t=wdCb.Hash.create(),r=wdCb.Hash.create();t.addChild(e.EEventName.CLICK,"onMouseClick"),t.addChild(e.EEventName.MOUSEOVER,"onMouseOver"),t.addChild(e.EEventName.MOUSEOUT,"onMouseOut"),t.addChild(e.EEventName.MOUSEMOVE,"onMouseMove"),t.addChild(e.EEventName.MOUSEDOWN,"onMouseDown"),t.addChild(e.EEventName.MOUSEUP,"onMouseUp"),t.addChild(e.EEventName.MOUSEWHEEL,"onMouseWheel"),t.addChild(e.EEventName.MOUSEDRAG,"onMouseDrag"),r.addChild(e.EEventName.CLICK,"MOUSE_CLICK"),r.addChild(e.EEventName.MOUSEDOWN,"MOUSE_DOWN"),r.addChild(e.EEventName.MOUSEUP,"MOUSE_UP"),r.addChild(e.EEventName.MOUSEMOVE,"MOUSE_MOVE"),r.addChild(e.EEventName.MOUSEOVER,"MOUSE_OVER"),r.addChild(e.EEventName.MOUSEOUT,"MOUSE_OUT"),r.addChild(e.EEventName.MOUSEWHEEL,"MOUSE_WHEEL"),r.addChild(e.EEventName.MOUSEDRAG,"MOUSE_DRAG");var n=function(){function EventTriggerTable(){}return EventTriggerTable.getScriptHandlerName=function(e){var r=t.getChild(e);return r},EventTriggerTable.getScriptEngineEvent=function(e){var t=r.getChild(e);return t},EventTriggerTable}();e.EventTriggerTable=n}(wd||(wd={}));var wd;!function(e){var t=function(t){function Script(e){void 0===e&&(e=null),t.call(this),this.url=null,this._subscription=null,this.url=e}return __extends(Script,t),Script.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(0===e.length)return new this;if(1===e.length){var r=e[0];return new this(r)}},Script.addScript=function(e,t){this.scriptList.push({name:e,class:t})},Script.prototype.dispose=function(){this._subscription.dispose()},Script.prototype.createLoadJsStream=function(){return e.Log.error(!this.url,e.Log.info.FUNC_MUST_DEFINE("url")),e.LoaderManager.getInstance().load(this.url).map(function(){return Script.scriptList.pop()})},Script.prototype.addToObject=function(r,n){void 0===n&&(n=!1),t.prototype.addToObject.call(this,r,n),this._subscription=this.createLoadJsStream().subscribe(function(t){e.GlobalScriptUtils.addScriptToEntityObject(r,t),e.GlobalScriptUtils.handlerAfterLoadedScript(r)})},Script.scriptList=wdCb.Stack.create(),__decorate([e.cloneAttributeAsBasicType()],Script.prototype,"url",void 0),Script}(e.Component);e.Script=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Transform(){t.apply(this,arguments),this.p_parent=null,this._isTranslate=!1,this._isRotate=!1,this._isScale=!1,this.dirtyLocal=!0,this.children=wdCb.Collection.create(),this._endLoopSubscription=null}return __extends(Transform,t),Object.defineProperty(Transform.prototype,"parent",{get:function(){return this.p_parent},set:function(e){this.setParent(e)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isTransform",{get:function(){return this.isTranslate||this.isRotate||this.isScale},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isTranslate",{get:function(){return this._isTranslate},set:function(t){this._setGlobalTransformState(e.ETransformState.ISTRANSLATE,t)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isRotate",{get:function(){return this._isRotate},set:function(t){this._setGlobalTransformState(e.ETransformState.ISROTATE,t)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isScale",{get:function(){return this._isScale},set:function(t){this._setGlobalTransformState(e.ETransformState.ISSCALE,t)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isLocalTranslate",{set:function(t){this._setLocalTransformState(e.ETransformState.ISLOCALTRANSLATE,t)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isLocalRotate",{set:function(t){this._setLocalTransformState(e.ETransformState.ISLOCALROTATE,t)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isLocalScale",{set:function(t){this._setLocalTransformState(e.ETransformState.ISLOCALSCALE,t)},enumerable:!0,configurable:!0}),Transform.prototype.init=function(){var t=this;this._endLoopSubscription=e.EventManager.fromEvent(e.EEngineEvent.ENDLOOP).subscribe(function(){t._resetTransformFlag()})},Transform.prototype.dispose=function(){t.prototype.dispose.call(this),this._endLoopSubscription&&this._endLoopSubscription.dispose()},Transform.prototype.addChild=function(e){this.children.addChild(e)},Transform.prototype.removeChild=function(e){this.children.removeChild(e)},Transform.prototype.setChildrenTransformState=function(e,t){t&&this.children.forEach(function(t){t[e]=!0})},Transform.prototype.handleWhenSetTransformState=function(e){},Transform.prototype.setParent=function(e){return this.p_parent&&this.p_parent.removeChild(this),e?(this.p_parent=e,void this.p_parent.addChild(this)):void(this.p_parent=null)},Transform.prototype.getMatrix=function(e,t){var r=wdCb.Collection.create(),n=this.p_parent;for(r.addChild(this);null!==n;)r.addChild(n),n=n.parent;return r.reverse().forEach(function(t){t[e]()}),this[t]},Transform.prototype._setGlobalTransformState=function(e,t){this["_"+e]=t,t&&(this.dirtyLocal=!0,this.clearCache(),this.handleWhenSetTransformState(e)),t&&this.setChildrenTransformState(e,t)},Transform.prototype._setLocalTransformState=function(e,t){t&&(this.dirtyLocal=!0,this.clearCache()),t&&this.setChildrenTransformState(e,t)},Transform.prototype._resetTransformFlag=function(){this.isTranslate=!1,this.isScale=!1,this.isRotate=!1},__decorate([e.cloneAttributeAsBasicType()],Transform.prototype,"parent",null),__decorate([e.virtual],Transform.prototype,"handleWhenSetTransformState",null),Transform}(e.Component);e.Transform=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ThreeDTransform(){t.apply(this,arguments),this._localToWorldMatrix=null,this._position=e.Vector3.create(),this._rotation=e.Quaternion.create(0,0,0,1),this._scale=e.Vector3.create(1,1,1),this._eulerAngles=null,this._localPosition=e.Vector3.create(0,0,0),this._localRotation=e.Quaternion.create(0,0,0,1),this._localEulerAngles=null,this._localScale=e.Vector3.create(1,1,1),this.dirtyWorld=null,this._localToParentMatrix=e.Matrix4.create(),this._localToWorldMatrixCache=null,this._positionCache=null,this._rotationCache=null,this._scaleCache=null,this._eulerAnglesCache=null,this._localEulerAnglesCache=null,this._normalMatrixCache=null}return __extends(ThreeDTransform,t),ThreeDTransform.create=function(){var e=new this;return e},Object.defineProperty(ThreeDTransform.prototype,"localToWorldMatrix",{get:function(){return this.getMatrix("sync","_localToWorldMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"normalMatrix",{get:function(){return this.localToWorldMatrix.invertTo3x3().transpose()},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"position",{get:function(){return this._position=this.localToWorldMatrix.getTranslation(),this._position},set:function(e){null===this.p_parent?this._localPosition=e:this._localPosition=this.p_parent.localToWorldMatrix.clone().invert().multiplyPoint(e),this.isTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"rotation",{get:function(){return this._rotation.setFromMatrix(this.localToWorldMatrix),this._rotation},set:function(e){null===this.p_parent?this._localRotation=e:this._localRotation=this.p_parent.rotation.clone().invert().multiply(e),this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"scale",{get:function(){return this._scale=this.localToWorldMatrix.getScale(),this._scale},set:function(e){null===this.p_parent?this._localScale=e:this._localScale=this.p_parent.localToWorldMatrix.clone().invert().multiplyVector3(e),this.isScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"eulerAngles",{get:function(){return this._eulerAngles=this.localToWorldMatrix.getEulerAngles(),this._eulerAngles},set:function(e){this._localRotation.setFromEulerAngles(e),null!==this.p_parent&&(this._localRotation=this.p_parent.rotation.clone().invert().multiply(this._localRotation)),this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"localPosition",{get:function(){return this._localPosition},set:function(e){this._localPosition=e,this.isLocalTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"localRotation",{get:function(){return this._localRotation},set:function(e){this._localRotation=e,this.isLocalRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"localEulerAngles",{get:function(){return this._localEulerAngles=this._localRotation.getEulerAngles(),this._localEulerAngles},set:function(e){this._localRotation.setFromEulerAngles(e),this.isLocalRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"localScale",{get:function(){return this._localScale},set:function(e){this._localScale=e,this.isLocalScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"up",{get:function(){return this.localToWorldMatrix.getY().normalize()},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"right",{get:function(){return this.localToWorldMatrix.getX().normalize()},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"forward",{get:function(){return this.localToWorldMatrix.getZ().normalize().scale(-1)},enumerable:!0,configurable:!0}),ThreeDTransform.prototype.sync=function(){this.dirtyLocal&&(this._localToParentMatrix.setTRS(this._localPosition,this._localRotation,this._localScale),this.dirtyLocal=!1,this.dirtyWorld=!0),this.dirtyWorld&&(null===this.p_parent?this._localToWorldMatrix=this._localToParentMatrix.clone():this._localToWorldMatrix=this.p_parent.localToWorldMatrix.clone().multiply(this._localToParentMatrix),this.dirtyWorld=!1,this.children.forEach(function(e){e.dirtyWorld=!0}))},ThreeDTransform.prototype.translateLocal=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;return n=3===t.length?e.Vector3.create(t[0],t[1],t[2]):t[0],this._localPosition=this._localPosition.add(this._localRotation.multiplyVector3(n)),this.isTranslate=!0,this},ThreeDTransform.prototype.translate=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;return n=3===t.length?e.Vector3.create(t[0],t[1],t[2]):t[0],this.position=n.add(this.position),this},ThreeDTransform.prototype.rotate=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=e.Quaternion.create();return n=3===t.length?e.Vector3.create(t[0],t[1],t[2]):t[0],i.setFromEulerAngles(n),null===this.p_parent?this._localRotation=i.multiply(this._localRotation):(i=this.p_parent.rotation.clone().invert().multiply(i),this._localRotation=i.multiply(this.rotation)),this.isRotate=!0,this},ThreeDTransform.prototype.rotateLocal=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=e.Quaternion.create();return n=3===t.length?e.Vector3.create(t[0],t[1],t[2]):t[0],i.setFromEulerAngles(n),this._localRotation.multiply(i),this.isRotate=!0,this},ThreeDTransform.prototype.rotateAround=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null,a=null,o=null,s=null;return 3===t.length?(n=t[0],i=t[1],a=t[2]):(n=t[0],i=e.Vector3.create(t[1],t[2],t[3]),a=e.Vector3.create(t[4],t[5],t[6])),o=e.Quaternion.create().setFromAxisAngle(n,a),s=this.position.clone().sub(i),s=o.multiplyVector3(s),this.position=i.add(s),this.rotation=o.multiply(this.rotation),this},ThreeDTransform.prototype.lookAt=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null;return 1===t.length?(n=t[0],i=e.Vector3.up):2===t.length?(n=t[0],i=t[1]):3===t.length?(n=e.Vector3.create(t[0],t[1],t[2]),i=e.Vector3.up):(n=e.Vector3.create(t[0],t[1],t[2]),i=e.Vector3.create(t[3],t[4],t[5])),this.rotation=e.Quaternion.create().setFromMatrix(e.Matrix4.create().setLookAt(this.position,n,i)),this},ThreeDTransform.prototype.clearCache=function(){this._localToWorldMatrixCache=null,this._normalMatrixCache=null,this._positionCache=null,this._rotationCache=null,this._scaleCache=null,this._eulerAnglesCache=null,this._localEulerAnglesCache=null},ThreeDTransform.prototype.handleWhenSetTransformState=function(t){var r=null;switch(t){case e.ETransformState.ISTRANSLATE:r=e.EEngineEvent.TRANSFORM_TRANSLATE;break;case e.ETransformState.ISROTATE:r=e.EEngineEvent.TRANSFORM_ROTATE;break;case e.ETransformState.ISSCALE:r=e.EEngineEvent.TRANSFORM_SCALE;break;default:e.Log.error(!0,e.Log.info.FUNC_UNKNOW("transformState:"+t))}e.EventManager.trigger(this.entityObject,e.CustomEvent.create(r))},__decorate([e.cacheGetter(function(){return null!==this._localToWorldMatrixCache},function(){return this._localToWorldMatrixCache},function(e){this._localToWorldMatrixCache=e})],ThreeDTransform.prototype,"localToWorldMatrix",null),__decorate([e.cacheGetter(function(){return null!==this._normalMatrixCache},function(){return this._normalMatrixCache},function(e){this._normalMatrixCache=e})],ThreeDTransform.prototype,"normalMatrix",null),__decorate([e.cloneAttributeAsCloneable(),e.cacheGetter(function(){return null!==this._positionCache},function(){return this._positionCache},function(e){this._positionCache=e})],ThreeDTransform.prototype,"position",null),__decorate([e.cloneAttributeAsCloneable(),e.cacheGetter(function(){return null!==this._rotationCache},function(){return this._rotationCache},function(e){this._rotationCache=e})],ThreeDTransform.prototype,"rotation",null),__decorate([e.cloneAttributeAsCloneable(),e.cacheGetter(function(){return null!==this._scaleCache},function(){return this._scaleCache},function(e){this._scaleCache=e})],ThreeDTransform.prototype,"scale",null),__decorate([e.cacheGetter(function(){return null!==this._eulerAnglesCache},function(){return this._eulerAnglesCache},function(e){this._eulerAnglesCache=e})],ThreeDTransform.prototype,"eulerAngles",null),__decorate([e.cloneAttributeAsCloneable()],ThreeDTransform.prototype,"localPosition",null),__decorate([e.cloneAttributeAsCloneable()],ThreeDTransform.prototype,"localRotation",null),__decorate([e.cacheGetter(function(){return null!==this._localEulerAnglesCache},function(){return this._localEulerAnglesCache},function(e){this._localEulerAnglesCache=e})],ThreeDTransform.prototype,"localEulerAngles",null),__decorate([e.cloneAttributeAsCloneable()],ThreeDTransform.prototype,"localScale",null),ThreeDTransform}(e.Transform);e.ThreeDTransform=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RectTransform(){t.apply(this,arguments),this._rotationMatrix=null,this._localPositionAndScaleMatrix=e.Matrix3.create(),this._position=e.Vector2.create(),this._rotation=0,this._scale=e.Vector2.create(1,1),this._localPosition=e.Vector2.create(0,0),this._localScale=e.Vector2.create(1,1),this._anchorX=e.Vector2.create(.5,.5),this._anchorY=e.Vector2.create(.5,.5),this._width=null,this._height=null,this.dirtyRotation=!0,this.dirtyPositionAndScale=!0,this.pivot=e.Vector2.create(0,0),this.zIndex=1,this._localRotationMatrix=e.Matrix3.create(),this._localToParentMatrix=e.Matrix3.create(),this._rotationMatrixCache=null,this._localPositionAndScaleMatrixCache=null}return __extends(RectTransform,t),RectTransform.create=function(){var e=new this;return e},Object.defineProperty(RectTransform.prototype,"rotationMatrix",{get:function(){return this.getMatrix("syncRotation","_rotationMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"localPositionAndScaleMatrix",{get:function(){return this.getMatrix("syncPositionAndScale","_localPositionAndScaleMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"position",{get:function(){return this._position=this.localPositionAndScaleMatrix.getTranslation(),this._position},set:function(e){null===this.p_parent?this._localPosition=e:this._localPosition=this.p_parent.localPositionAndScaleMatrix.clone().invert().multiplyPoint(e),this.isTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"rotation",{get:function(){return this._rotation=this.rotationMatrix.getRotation(),this._rotation},set:function(e){this.resetRotation(),this.rotate(e),this.dirtyRotation=!0,this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"scale",{get:function(){return this._scale=this.localPositionAndScaleMatrix.getScale(),this._scale},set:function(e){null===this.p_parent?this._localScale=e:this._localScale=this.p_parent.localPositionAndScaleMatrix.clone().invert().multiplyVector2(e),this.isScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"localPosition",{get:function(){return this._localPosition},set:function(e){this._localPosition=e,this.isLocalTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"localScale",{get:function(){return this._localScale},set:function(e){this._localScale=e,this.isLocalScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"anchorX",{get:function(){return this._anchorX},set:function(t){var r=null;if(!this._anchorX.isEqual(t)){if(this._anchorX=t,t.x===t.y){var n=(t.x-.5)*this._getParentWidth();return void(this.position=e.Vector2.create(this._getParentPosition().x+n,this.position.y))}r=this._getParentWidth(),this.position=e.Vector2.create(this._getParentPosition().x+(t.x+t.y-1)/2*r,this.position.y),this.width=r/this._getParentScale().x*(t.y-t.x)*this.scale.x}},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"anchorY",{get:function(){return this._anchorY},set:function(t){var r=null;if(!this._anchorY.isEqual(t)){if(this._anchorY=t,t.x===t.y){var n=(t.x-.5)*this._getParentHeight();return void(this.position=e.Vector2.create(this.position.x,this._getParentPosition().y+n))}r=this._getParentHeight(),this.position=e.Vector2.create(this.position.x,this._getParentPosition().y+(t.x+t.y-1)/2*r),this.height=r/this._getParentScale().y*(t.y-t.x)*this.scale.y}},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"width",{get:function(){return this._width*this.scale.x},set:function(t){this._width!==t&&(this._width=t,this.entityObject&&e.EventManager.trigger(this.entityObject,e.CustomEvent.create(e.EEngineEvent.UI_WIDTH_CHANGE)))},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"height",{get:function(){return this._height*this.scale.y},set:function(t){this._height!==t&&(this._height=t,this.entityObject&&e.EventManager.trigger(this.entityObject,e.CustomEvent.create(e.EEngineEvent.UI_HEIGHT_CHANGE)))},enumerable:!0,configurable:!0}),RectTransform.prototype.syncRotation=function(){this.dirtyRotation&&(null===this.p_parent?this._rotationMatrix=this._localRotationMatrix.clone():this._rotationMatrix=this.p_parent.rotationMatrix.clone().multiply(this._localRotationMatrix),this.children.forEach(function(e){e.dirtyRotation=!0}))},RectTransform.prototype.syncPositionAndScale=function(){this.dirtyLocal&&(this._localToParentMatrix.setTS(this._localPosition,this._localScale),this.dirtyLocal=!1,this.dirtyPositionAndScale=!0),this.dirtyPositionAndScale&&(null===this.p_parent?this._localPositionAndScaleMatrix=this._localToParentMatrix.clone():this._localPositionAndScaleMatrix=this.p_parent.localPositionAndScaleMatrix.clone().multiply(this._localToParentMatrix),this.dirtyLocal=!1,this.children.forEach(function(e){e.dirtyPositionAndScale=!0}))},RectTransform.prototype.translate=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;return n=2===t.length?e.Vector2.create(t[0],t[1]):t[0],this.position=n.add(this.position),this},RectTransform.prototype.rotate=function(e){var t=this.position;return this.rotateAround(e,t.x+this.pivot.x,t.y-this.pivot.y),this.dirtyRotation=!0,this.isRotate=!0,this},RectTransform.prototype.rotateAround=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null,a=null,o=null;return 2===t.length?(n=t[0],
i=t[1]):(n=t[0],i=e.Vector2.create(t[1],t[2])),a=i.x,o=i.y,this._translateInRotationMatrix(a,o),this._rotateAroundCanvasOriginPoint(n),this._translateInRotationMatrix(-a,-o),this},RectTransform.prototype._translateInRotationMatrix=function(e,t){return this._localRotationMatrix.translate(e,t),this},RectTransform.prototype.resetPosition=function(){this.position=e.Vector2.create(0,0)},RectTransform.prototype.resetScale=function(){this.scale=e.Vector2.create(1,1)},RectTransform.prototype.resetRotation=function(){this._localRotationMatrix.setIdentity()},RectTransform.prototype.handleWhenSetTransformState=function(t){var r=null;switch(t){case e.ETransformState.ISTRANSLATE:r=e.EEngineEvent.TRANSFORM_TRANSLATE;break;case e.ETransformState.ISROTATE:r=e.EEngineEvent.TRANSFORM_ROTATE;break;case e.ETransformState.ISSCALE:r=e.EEngineEvent.TRANSFORM_SCALE;break;default:e.Log.error(!0,e.Log.info.FUNC_UNKNOW("transformState:"+t))}e.EventManager.trigger(this.entityObject,e.CustomEvent.create(r))},RectTransform.prototype.clearCache=function(){this._rotationMatrixCache=null,this._localPositionAndScaleMatrixCache=null},RectTransform.prototype._rotateAroundCanvasOriginPoint=function(e){return this._localRotationMatrix.rotate(e),this.dirtyRotation=!0,this},RectTransform.prototype._getParentWidth=function(){return null===this.p_parent?e.DeviceManager.getInstance().view.width:this.p_parent.width},RectTransform.prototype._getParentHeight=function(){return null===this.p_parent?e.DeviceManager.getInstance().view.height:this.p_parent.height},RectTransform.prototype._getParentPosition=function(){if(null===this.p_parent){var t=e.DeviceManager.getInstance().view;return e.Vector2.create(t.width/2,t.height/2)}return this.p_parent.position},RectTransform.prototype._getParentScale=function(){return null===this.p_parent?e.Vector2.create(1,1):this.p_parent.scale},__decorate([e.cacheGetter(function(){return null!==this._rotationMatrixCache},function(){return this._rotationMatrixCache},function(e){this._rotationMatrixCache=e})],RectTransform.prototype,"rotationMatrix",null),__decorate([e.cacheGetter(function(){return null!==this._localPositionAndScaleMatrixCache},function(){return this._localPositionAndScaleMatrixCache},function(e){this._localPositionAndScaleMatrixCache=e})],RectTransform.prototype,"localPositionAndScaleMatrix",null),__decorate([e.cloneAttributeAsCloneable()],RectTransform.prototype,"position",null),__decorate([e.cloneAttributeAsBasicType()],RectTransform.prototype,"rotation",null),__decorate([e.cloneAttributeAsCloneable()],RectTransform.prototype,"scale",null),__decorate([e.cloneAttributeAsCloneable()],RectTransform.prototype,"localPosition",null),__decorate([e.cloneAttributeAsCloneable()],RectTransform.prototype,"localScale",null),__decorate([e.requireSetter(function(t){e.assert(t.x<=t.y,e.Log.info.FUNC_SHOULD("minX","<= maxY")),e.assert(t.x>=0&&t.x<=1,e.Log.info.FUNC_SHOULD("minX",">= 0 && <= 1")),e.assert(t.y>=0&&t.y<=1,e.Log.info.FUNC_SHOULD("maxX",">= 0 && <= 1"))}),e.cloneAttributeAsCloneable()],RectTransform.prototype,"anchorX",null),__decorate([e.requireSetter(function(t){e.assert(t.x<=t.y,e.Log.info.FUNC_SHOULD("minY","<= maxY")),e.assert(t.x>=0&&t.x<=1,e.Log.info.FUNC_SHOULD("minY",">= 0 && <= 1")),e.assert(t.y>=0&&t.y<=1,e.Log.info.FUNC_SHOULD("maxY",">= 0 && <= 1"))}),e.cloneAttributeAsCloneable()],RectTransform.prototype,"anchorY",null),__decorate([e.cloneAttributeAsBasicType()],RectTransform.prototype,"width",null),__decorate([e.cloneAttributeAsBasicType()],RectTransform.prototype,"height",null),__decorate([e.cloneAttributeAsCloneable()],RectTransform.prototype,"pivot",void 0),__decorate([e.cloneAttributeAsBasicType()],RectTransform.prototype,"zIndex",void 0),RectTransform}(e.Transform);e.RectTransform=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.ISTRANSLATE="isTranslate"]="ISTRANSLATE",e[e.ISROTATE="isRotate"]="ISROTATE",e[e.ISSCALE="isScale"]="ISSCALE",e[e.ISLOCALTRANSLATE="isLocalTranslate"]="ISLOCALTRANSLATE",e[e.ISLOCALROTATE="isLocalRotate"]="ISLOCALROTATE",e[e.ISLOCALSCALE="isLocalScale"]="ISLOCALSCALE"}(e.ETransformState||(e.ETransformState={}));e.ETransformState}(wd||(wd={}));var wd;!function(e){var t=function(t){function Shadow(){t.apply(this,arguments),this._receive=!0,this._cast=!0,this._layer=e.EShadowLayer.DEFAULT,this._shadowMapLayerChangeSubscription=null,this._isInit=!1}return __extends(Shadow,t),Shadow.create=function(){var e=new this;return e},Object.defineProperty(Shadow.prototype,"receive",{get:function(){return this._receive},set:function(t){if(this._isInit&&this._receive!==t){if(e.InstanceUtils.isObjectInstance(this.entityObject))return void(this._receive=t);t?(this._addShadowMapsToObjectAndChildren(),this._switchToShadowMapShaderLib(this.entityObject)):(this._removeShadowMapsOfObjectAndChildren(),this._switchToNoShadowMapShaderLib(this.entityObject))}this._receive=t},enumerable:!0,configurable:!0}),Object.defineProperty(Shadow.prototype,"cast",{get:function(){return this._cast},set:function(e){this._cast=e},enumerable:!0,configurable:!0}),Object.defineProperty(Shadow.prototype,"layer",{get:function(){return e.InstanceUtils.isObjectInstance(this.entityObject)&&!e.InstanceUtils.isHardwareSupport()&&(this._layer=this.entityObject.getComponent(e.ObjectInstance).sourceObject.getComponent(Shadow).layer),this._layer},set:function(e){e&&this._layer!==e&&(this._layer=e)},enumerable:!0,configurable:!0}),Shadow.prototype.addToObject=function(e,r){void 0===r&&(r=!1),t.prototype.addToObject.call(this,e,r)},Shadow.prototype.init=function(){var t=this;if(this._isInit=!0,!e.InstanceUtils.isObjectInstance(this.entityObject)&&this._isFirstLevelObjectOfSceneOrSpacePartition())if(this._shadowMapLayerChangeSubscription=e.EventManager.fromEvent(e.EEngineEvent.SHADOWMAP_LAYER_CHANGE).subscribe(function(){t.receive&&t._addShadowMapsToObjectAndChildren()}),this.cast&&this.receive)this._addBuildShadowMapShaderAndShadowMapsToObjectAndChildren();else{if(this.cast)return void this._addBuildShadowMapShaderToObjectAndChildren();this.receive&&this._addShadowMapsToObjectAndChildren()}},Shadow.prototype.dispose=function(){this._shadowMapLayerChangeSubscription&&this._shadowMapLayerChangeSubscription.dispose()},Shadow.prototype._addAllShadowMaps=function(e,t,r){e.forEach(function(e){e.forEach(function(e){var t=e.shadowMap;r.addTwoDShadowMap(t)})}),t.forEach(function(e){e.forEach(function(e){var t=e.shadowMap;r.addCubemapShadowMap(t)})})},Shadow.prototype._isFirstLevelObjectOfSceneOrSpacePartition=function(){var t=this.entityObject.parent;return!!t&&(e.JudgeUtils.isEqual(t,e.Director.getInstance().scene)||e.JudgeUtils.isSpacePartitionObject(t))},Shadow.prototype._addBuildShadowMapShaderAndShadowMapsToObjectAndChildren=function(){var t=this,r=this,n=e.Director.getInstance().scene.gameObjectScene.shadowManager.twoDShadowMapDataMap,i=e.Director.getInstance().scene.gameObjectScene.shadowManager.cubemapShadowMapDataMap,a=function(o){if(o.hasComponent(e.Geometry)){var s=o.getComponent(e.Geometry),c=s.material,u=c.mapManager;r._addBuildTwoDShadowMapShader(c,t._createBuildTwoDShadowMapShader(o,s)),r._addBuildCubemapShadowMapShader(c,t._createBuildCubemapShadowMapShader(o,s)),c.shader.libDirty=!0,u.removeAllShdaowMaps(),r._addAllShadowMaps(n,i,u)}o.forEach(function(e){a(e)})};a(this.entityObject)},Shadow.prototype._addBuildShadowMapShaderToObjectAndChildren=function(){var t=this,r=this,n=function(i){if(i.hasComponent(e.Geometry)){var a=i.getComponent(e.Geometry),o=a.material;r._addBuildTwoDShadowMapShader(o,t._createBuildTwoDShadowMapShader(i,a)),r._addBuildCubemapShadowMapShader(o,t._createBuildCubemapShadowMapShader(i,a))}i.forEach(function(e){n(e)})};n(this.entityObject)},Shadow.prototype._addBuildTwoDShadowMapShader=function(t,r){t.addShader(e.EShaderTypeOfScene.BUILD_TWOD_SHADOWMAP,r)},Shadow.prototype._addBuildCubemapShadowMapShader=function(t,r){t.addShader(e.EShaderTypeOfScene.BUILD_CUBEMAP_SHADOWMAP,r)},Shadow.prototype._createBuildTwoDShadowMapShader=function(t,r){var n=this._createBuildShadowMapShader(t,r);return n.addLib(e.BuildTwoDShadowMapShaderLib.create()),n},Shadow.prototype._createBuildCubemapShadowMapShader=function(t,r){var n=this._createBuildShadowMapShader(t,r);return n.addLib(e.BuildCubemapShadowMapShaderLib.create()),n},Shadow.prototype._createBuildShadowMapShader=function(t,r){var n=e.CommonShader.create();return n.addLib(e.CommonShaderLib.create()),e.GlobalGeometryUtils.hasAnimation(r)?(n.addLib(e.CommonMorphShaderLib.create()),n.addLib(e.VerticeMorphShaderLib.create())):n.addLib(e.VerticeCommonShaderLib.create()),e.InstanceUtils.addModelMatrixShaderLib(n,t),n.addLib(e.EndShaderLib.create()),n},Shadow.prototype._addShadowMapsToObjectAndChildren=function(){var t=this,r=e.Director.getInstance().scene.gameObjectScene.shadowManager.twoDShadowMapDataMap,n=e.Director.getInstance().scene.gameObjectScene.shadowManager.cubemapShadowMapDataMap,i=function(a){if(a.hasComponent(e.Geometry)){var o=a.getComponent(e.Geometry).material,s=o.mapManager;o.shader.libDirty=!0,s.removeAllShdaowMaps(),t._addAllShadowMaps(r,n,s)}a.forEach(function(e){i(e)})};i(this.entityObject)},Shadow.prototype._removeShadowMapsOfObjectAndChildren=function(){var t=function(r){if(r.hasComponent(e.Geometry)){var n=r.getComponent(e.Geometry).material,i=n.mapManager;n.shader.libDirty=!0,i.removeAllShdaowMaps()}r.forEach(function(e){t(e)})};t(this.entityObject)},Shadow.prototype._switchToShadowMapShaderLib=function(t){var r=t.getComponent(e.Geometry).material,n=r.shader,i=r.mapManager;n.removeLib(function(t){return t instanceof e.NoShadowMapShaderLib}),this._isTwoDShadowMap(i)&&n.addLib(e.TwoDShadowMapShaderLib.create()),this._isCubemapShadowMap(i)&&n.addLib(e.CubemapShadowMapShaderLib.create()),n.addLib(e.TotalShadowMapShaderLib.create())},Shadow.prototype._switchToNoShadowMapShaderLib=function(t){var r=t.getComponent(e.Geometry).material,n=r.shader;n.removeLib(function(t){return t instanceof e.TwoDShadowMapShaderLib||t instanceof e.CubemapShadowMapShaderLib||t instanceof e.TotalShadowMapShaderLib}),n.hasLib(e.NoShadowMapShaderLib)||n.addLib(e.NoShadowMapShaderLib.create())},Shadow.prototype._isTwoDShadowMap=function(e){return e.getTwoDShadowMapList().getCount()>0},Shadow.prototype._isCubemapShadowMap=function(e){return e.getCubemapShadowMapList().getCount()>0},__decorate([e.cloneAttributeAsBasicType()],Shadow.prototype,"receive",null),__decorate([e.cloneAttributeAsBasicType()],Shadow.prototype,"cast",null),__decorate([e.cloneAttributeAsBasicType()],Shadow.prototype,"layer",null),__decorate([e.require(function(t,r){void 0===r&&(r=!1),e.assert(t instanceof e.GameObject,e.Log.info.FUNC_SHOULD("add to GameObject"))})],Shadow.prototype,"addToObject",null),__decorate([e.require(function(t,r){e.assert(!t.hasShader(e.EShaderTypeOfScene.BUILD_TWOD_SHADOWMAP),e.Log.info.FUNC_SHOULD_NOT("material","exist build twoD shadow map shader"))})],Shadow.prototype,"_addBuildTwoDShadowMapShader",null),__decorate([e.require(function(t,r){e.assert(!t.hasShader(e.EShaderTypeOfScene.BUILD_CUBEMAP_SHADOWMAP),e.Log.info.FUNC_SHOULD_NOT("material","exist build cubemap shadow map shader"))})],Shadow.prototype,"_addBuildCubemapShadowMapShader",null),__decorate([e.ensure(function(t,r){var n=r.getComponent(e.Geometry).material,i=n.shader;e.assert(!i.hasLib(e.NoShadowMapShaderLib),e.Log.info.FUNC_SHOULD_NOT("contain NoShadowMapShaderLib")),e.assert(i.getLibs().filter(function(t){return t instanceof e.TwoDShadowMapShaderLib}).getCount()<=1,e.Log.info.FUNC_SHOULD_NOT("has duplicate TwoDShadowMapShaderLib")),e.assert(i.getLibs().filter(function(t){return t instanceof e.CubemapShadowMapShaderLib}).getCount()<=1,e.Log.info.FUNC_SHOULD_NOT("has duplicate CubemapShadowMapShaderLib"))})],Shadow.prototype,"_switchToShadowMapShaderLib",null),__decorate([e.ensure(function(t,r){var n=r.getComponent(e.Geometry).material,i=n.shader;e.assert(!i.hasLib(e.TwoDShadowMapShaderLib),e.Log.info.FUNC_SHOULD_NOT("contain TwoDShadowMapShaderLib")),e.assert(!i.hasLib(e.CubemapShadowMapShaderLib),e.Log.info.FUNC_SHOULD_NOT("contain CubemapShadowMapShaderLib")),e.assert(i.getLibs().filter(function(t){return t instanceof e.NoShadowMapShaderLib}).getCount()<=1,e.Log.info.FUNC_SHOULD_NOT("has duplicate NoShadowMapShaderLib"))})],Shadow.prototype,"_switchToNoShadowMapShaderLib",null),Shadow}(e.Component);e.Shadow=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ShadowUtils(){}return ShadowUtils.isReceive=function(t){var r=null,n=t,i=!1;do{if(r=n.getComponent(e.Shadow),r&&r.receive){i=!0;break}n=n.parent}while(n);return i},ShadowUtils}();e.ShadowUtils=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.DEFAULT="default"]="DEFAULT"}(e.EShadowLayer||(e.EShadowLayer={}));e.EShadowLayer}(wd||(wd={}));var wd;!function(e){!function(e){e[e.NONE=0]="NONE",e[e.PCF=1]="PCF"}(e.EShadowMapSoftType||(e.EShadowMapSoftType={}));e.EShadowMapSoftType}(wd||(wd={}));var wd;!function(e){var t=function(t){function Animation(){t.apply(this,arguments),this.isFrameChange=!1,this.state=r.DEFAULT,this.pauseTime=null,this.resumeTime=null,this.pauseDuration=null,this.frameCount=null,this._isResume=!1}return __extends(Animation,t),Object.defineProperty(Animation.prototype,"isStart",{get:function(){return this.state===r.RUN},enumerable:!0,configurable:!0}),Object.defineProperty(Animation.prototype,"isStop",{get:function(){return this.state===r.STOP},enumerable:!0,configurable:!0}),Object.defineProperty(Animation.prototype,"isPause",{get:function(){return this.state===r.PAUSE},enumerable:!0,configurable:!0}),Animation.prototype.addToObject=function(r,n){void 0===n&&(n=!1);var i=e.AnimationEngine.getInstance();t.prototype.addToObject.call(this,r,n),i.hasChild(this)||i.addChild(this)},Animation.prototype.removeFromObject=function(r){t.prototype.removeFromObject.call(this,r),e.AnimationEngine.getInstance().removeChild(this)},Animation.prototype.clone=function(){return e.CloneUtils.clone(this)},Animation.prototype.pause=function(){this.state=r.PAUSE,this.pauseTime=this.getPauseTime()},Animation.prototype.resume=function(){this.state=r.RUN,this._isResume=!0,this.resumeTime=this.getResumeTime()},Animation.prototype.stop=function(){this.state=r.STOP},Animation.prototype.update=function(e){if(this.state!==r.DEFAULT&&!this.isStop){if(this.isPause)return void this.handleWhenPause(e);this._isResume&&(this._isResume=!1,this.continueFromPausePoint(e)),this.handleBeforeJudgeWhetherCurrentFrameFinish(e),this.isCurrentFrameFinish(e)?this.handleWhenCurrentFrameFinish(e):this.isFrameChange=!1,this.handleAfterJudgeWhetherCurrentFrameFinish(e)}},Animation.prototype.getPauseTime=function(){return this.getCurrentTime()},Animation.prototype.getResumeTime=function(){return this.getCurrentTime()},Animation.prototype.getCurrentTime=function(){return e.Director.getInstance().elapsed},Animation.prototype.continueFromPausePoint=function(e){this.pauseDuration+=this.resumeTime-this.pauseTime},Animation}(e.Component);e.Animation=t,function(e){e[e.DEFAULT=0]="DEFAULT",e[e.RUN=1]="RUN",e[e.STOP=2]="STOP",e[e.PAUSE=3]="PAUSE"}(e.EAnimationState||(e.EAnimationState={}));var r=e.EAnimationState}(wd||(wd={}));var wd;!function(e){var t=function(t){function MorphAnimation(){t.apply(this,arguments),this.interpolation=0,this.currentFrame=0,this.duration=null,this.fps=null,this.currentAnimName=null,this._prevFrameEndTime=null}return __extends(MorphAnimation,t),MorphAnimation.create=function(){var e=new this;return e},Object.defineProperty(MorphAnimation.prototype,"nextFrame",{get:function(){var e=this.currentFrame+1;return e>=this.frameCount&&(e=0),e},enumerable:!0,configurable:!0}),MorphAnimation.prototype.init=function(){},MorphAnimation.prototype.dispose=function(){},MorphAnimation.prototype.play=function(t,r){var n=this.entityObject.getComponent(e.ModelGeometry);this.currentAnimName=t,this.fps=r,this.duration=1/r*1e3,this.frameCount=n.morphTargets.getChild(t).getCount(),this.resetAnim(),this.state=e.EAnimationState.RUN},MorphAnimation.prototype.handleWhenPause=function(e){},MorphAnimation.prototype.handleWhenCurrentFrameFinish=function(t){this.isFrameChange=!0,this._prevFrameEndTime=e.MathUtils.maxFloorIntegralMultiple(t-this.pauseDuration,this.duration),this.currentFrame++,this._isFinishAllFrames()&&(this.currentFrame=0)},MorphAnimation.prototype.handleBeforeJudgeWhetherCurrentFrameFinish=function(e){null===this._prevFrameEndTime&&(this._prevFrameEndTime=this.getCurrentTime())},MorphAnimation.prototype.isCurrentFrameFinish=function(e){return e-this._prevFrameEndTime-this.pauseDuration>this.duration},MorphAnimation.prototype.handleAfterJudgeWhetherCurrentFrameFinish=function(e){this._computeInterpolation(e)},MorphAnimation.prototype.resetAnim=function(){this._prevFrameEndTime=null,this.currentFrame=0,this.pauseDuration=0},MorphAnimation.prototype._computeInterpolation=function(e){this.interpolation=this.fps*(e-this._prevFrameEndTime-this.pauseDuration)/1e3},MorphAnimation.prototype._isFinishAllFrames=function(){return this.currentFrame>=this.frameCount},__decorate([e.cloneAttributeAsBasicType()],MorphAnimation.prototype,"interpolation",void 0),__decorate([e.cloneAttributeAsBasicType()],MorphAnimation.prototype,"currentFrame",void 0),__decorate([e.cloneAttributeAsBasicType()],MorphAnimation.prototype,"duration",void 0),__decorate([e.cloneAttributeAsBasicType()],MorphAnimation.prototype,"fps",void 0),__decorate([e.cloneAttributeAsBasicType()],MorphAnimation.prototype,"currentAnimName",void 0),__decorate([e.require(function(t,r){var n=this.entityObject.getComponent(e.ModelGeometry);e.assert(n,e.Log.info.FUNC_SHOULD("this entityObject","add ModelGeometry component")),e.assert(n.morphTargets.getChild(t)&&n.morphTargets.getChild(t).getCount()>0,e.Log.info.FUNC_NOT_EXIST('"'+t+'" animation'))}),e.ensure(function(){e.assert(this.frameCount>1,e.Log.info.FUNC_SHOULD("frames.count","> 1"))})],MorphAnimation.prototype,"play",null),__decorate([e.require(function(t){e.assert(t-this._prevFrameEndTime-this.pauseDuration>=0,e.Log.info.FUNC_SHOULD("elapsed of current frame:"+(t-this._prevFrameEndTime-this.pauseDuration),">= 0"))})],MorphAnimation.prototype,"isCurrentFrameFinish",null),__decorate([e.ensure(function(){var t=this.interpolation;e.assert(t>=0&&t<=1,e.Log.info.FUNC_SHOULD("interpolation("+t,">= 0 && <= 1"))})],MorphAnimation.prototype,"_computeInterpolation",null),MorphAnimation}(e.Animation);e.MorphAnimation=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ArticulatedAnimation(){t.apply(this,arguments),this.data=null,this._currentFrame=null,this._currentAnimName=null,this._beginElapsedTimeOfFirstFrame=null,this._prevFrameTime=null,this._currentAnimData=null,this._currentFrameData=null,this._prevFrameData=null,this._startFrameDataMap=wdCb.Hash.create()}return __extends(ArticulatedAnimation,t),ArticulatedAnimation.create=function(){var e=new this;return e},ArticulatedAnimation.prototype.init=function(){},ArticulatedAnimation.prototype.dispose=function(){},ArticulatedAnimation.prototype.play=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(e.JudgeUtils.isNumber(t[0])){var n=t[0],i=0,a=this;this.data.forEach(function(e,t){return n===i?(a._currentAnimName=t,a._currentAnimData=e,wdCb.$BREAK):void i++})}else if(e.JudgeUtils.isString(t[0])){var o=t[0];this._currentAnimName=o,this._currentAnimData=this.data.getChild(o)}this.resetAnim(),this._saveStartFrameData(this.entityObject.transform),this.frameCount=this._currentAnimData.getCount(),this.state=e.EAnimationState.RUN},ArticulatedAnimation.prototype.handleWhenPause=function(e){},ArticulatedAnimation.prototype.handleWhenCurrentFrameFinish=function(e){this.isFrameChange=!0,this._updateFrame(e),this._saveStartFrameData(this._prevFrameData)},ArticulatedAnimation.prototype.handleBeforeJudgeWhetherCurrentFrameFinish=function(e){null===this._beginElapsedTimeOfFirstFrame&&(this._beginElapsedTimeOfFirstFrame=this.getCurrentTime())},ArticulatedAnimation.prototype.isCurrentFrameFinish=function(e){return e-this._beginElapsedTimeOfFirstFrame-this.pauseDuration>this._currentFrameData.time},ArticulatedAnimation.prototype.handleAfterJudgeWhetherCurrentFrameFinish=function(e){this._updateTargets(e)},ArticulatedAnimation.prototype.resetAnim=function(){this._beginElapsedTimeOfFirstFrame=null,this._prevFrameTime=0,this.pauseDuration=0,this._currentFrame=0,this._prevFrameData=null,this._updateCurrentFrameData(),this._startFrameDataMap.removeAllChildren()},ArticulatedAnimation.prototype._updateTargets=function(t){var r=this,n=this.entityObject.transform,i=this._startFrameDataMap;this._currentFrameData.targets.forEach(function(a){var o=a.data,s=i.getChild(a.target),c=r._computeInterpolation(t,a.interpolationMethod);switch(a.target){case e.EArticulatedAnimationTarget.TRANSLATION:n.localPosition=e.Vector3.create().lerp(s,o,c);break;case e.EArticulatedAnimationTarget.ROTATION:n.localRotation=e.Quaternion.create().slerp(s,o,c);break;case e.EArticulatedAnimationTarget.SCALE:n.localScale=e.Vector3.create().lerp(s,o,c);break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("EArticulatedAnimationTarget:"+a.target))}})},ArticulatedAnimation.prototype._computeInterpolation=function(t,r){var n=null;switch(r){case e.EKeyFrameInterpolation.LINEAR:n=this._currentFrameData.time-this._prevFrameTime===0?1:(t-this._beginElapsedTimeOfFirstFrame-this.pauseDuration-this._prevFrameTime)/(this._currentFrameData.time-this._prevFrameTime);break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("interpolationMethod:"+r))}return n},ArticulatedAnimation.prototype._saveStartFrameData=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=this._startFrameDataMap;if(this._isFrameData(t[0])){var i=t[0];i.targets.forEach(function(e){n.addChild(e.target,e.data)})}else{var a=t[0];n.addChild(e.EArticulatedAnimationTarget.TRANSLATION,a.localPosition),n.addChild(e.EArticulatedAnimationTarget.ROTATION,a.localRotation),n.addChild(e.EArticulatedAnimationTarget.SCALE,a.localScale)}},ArticulatedAnimation.prototype._updateCurrentFrameData=function(){this._currentFrameData=this._currentAnimData.getChild(this._currentFrame)},ArticulatedAnimation.prototype._updateFrame=function(e){this._updateCurrentFrameIndex(e),this._isFinishAllFrames()?(this._currentFrame=0,this._beginElapsedTimeOfFirstFrame=this._getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames(e),this._prevFrameTime=0,this._prevFrameData=this._currentAnimData.getChild(this.frameCount-1),this._updateCurrentFrameData()):this._prevFrameTime=this._currentAnimData.getChild(this._currentFrame-1).time},ArticulatedAnimation.prototype._getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames=function(t){return e.MathUtils.maxFloorIntegralMultiple(t,this._currentAnimData.getChild(this.frameCount-1).time)},ArticulatedAnimation.prototype._isFinishAllFrames=function(){return this._currentFrame>=this.frameCount},ArticulatedAnimation.prototype._updateCurrentFrameIndex=function(e){do this._currentFrame++,this._prevFrameData=this._currentFrameData,this._updateCurrentFrameData();while(!this._isFinishAllFrames()&&this.isCurrentFrameFinish(e))},ArticulatedAnimation.prototype._isFrameData=function(e){return void 0!==e.time&&void 0!==e.targets},__decorate([e.cloneAttributeAsCloneable()],ArticulatedAnimation.prototype,"data",void 0),__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(e.JudgeUtils.isNumber(t[0])){var n=t[0];e.assert(this.data.getCount()>=n+1,e.Log.info.FUNC_NOT_EXIST("animation index:"+n))}else if(e.JudgeUtils.isString(t[0])){var i=t[0];e.assert(this.data.hasChild(i),e.Log.info.FUNC_NOT_EXIST("animation name:"+i))}}),e.ensure(function(){e.assert(!!this._currentAnimData,e.Log.info.FUNC_NOT_EXIST("animation name:"+this._currentAnimName)),this._currentAnimData.forEach(function(t){e.assert(t.time>=0,e.Log.info.FUNC_SHOULD("time",">= 0")),e.assert(t.targets.getCount()>0,e.Log.info.FUNC_SHOULD("ArticulatedAnimationFrameData->targets.getCount()","> 0")),t.targets.forEach(function(t){var r=t.data;switch(t.target){case e.EArticulatedAnimationTarget.TRANSLATION:e.assert(r instanceof e.Vector3,e.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget === TRANSLATION, its data","Vector3"));break;case e.EArticulatedAnimationTarget.ROTATION:e.assert(r instanceof e.Quaternion,e.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget ===ROTATION, its data","Quaternion"));break;case e.EArticulatedAnimationTarget.SCALE:e.assert(r instanceof e.Vector3,e.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget === SCALE, its data","Vector3"));break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("EArticulatedAnimationTarget:"+t.target))}})})})],ArticulatedAnimation.prototype,"play",null),__decorate([e.require(function(t){e.assert(t-this._beginElapsedTimeOfFirstFrame-this.pauseDuration>=0,e.Log.info.FUNC_SHOULD("elapsed of current frame:"+(t-this._beginElapsedTimeOfFirstFrame-this.pauseDuration),">= 0"))})],ArticulatedAnimation.prototype,"isCurrentFrameFinish",null),__decorate([e.ensure(function(t,r,n){e.assert(t>=0&&t<=1,e.Log.info.FUNC_SHOULD("interpolation:"+t,">= 0 && <= 1"))})],ArticulatedAnimation.prototype,"_computeInterpolation",null),__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(this._isFrameData(t[0])){var n=t[0];e.assert(null!==this._currentFrameData,e.Log.info.FUNC_SHOULD("set currentFrameData")),this._currentFrameData.targets.forEach(function(t,r){e.assert(n.targets.getChild(r).target===t.target,e.Log.info.FUNC_SHOULD("the current frame and the start frame","modify the same targets"))})}})],ArticulatedAnimation.prototype,"_saveStartFrameData",null),__decorate([e.require(function(t){var r=this._currentAnimData.getChild(this.frameCount-1).time;e.assert(t>=r,e.Log.info.FUNC_SHOULD("elapsed:"+t,">= lastEndFrameTime:"+r))})],ArticulatedAnimation.prototype,"_getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames",null),ArticulatedAnimation}(e.Animation);e.ArticulatedAnimation=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.LINEAR=0]="LINEAR"}(e.EKeyFrameInterpolation||(e.EKeyFrameInterpolation={}));e.EKeyFrameInterpolation}(wd||(wd={}));var wd;!function(e){!function(e){e[e.TRANSLATION="position"]="TRANSLATION",e[e.ROTATION="rotation"]="ROTATION",e[e.SCALE="scale"]="SCALE"}(e.EArticulatedAnimationTarget||(e.EArticulatedAnimationTarget={}));e.EArticulatedAnimationTarget}(wd||(wd={}));var wd;!function(e){var t=function(t){function Geometry(){t.apply(this,arguments),this._material=null,this.buffers=null,this.vaoManager=e.GPUDetector.getInstance().extensionVAO?e.VAOManager.create():null,this.drawMode=e.EDrawMode.TRIANGLES}return __extends(Geometry,t),Object.defineProperty(Geometry.prototype,"material",{get:function(){return this._material},set:function(t){e.JudgeUtils.isEqual(t,this._material)||(this._material=t,this._material.geometry=this,this.entityObject&&e.EventManager.trigger(this.entityObject,e.CustomEvent.create(e.EEngineEvent.MATERIAL_CHANGE)))},enumerable:!0,configurable:!0}),Object.defineProperty(Geometry.prototype,"geometryData",{get:function(){return null===this.buffers?null:this.buffers.geometryData},enumerable:!0,configurable:!0}),Geometry.prototype.init=function(){var e=null,t=this.computeData(),r=t.vertices,n=t.faces,i=void 0===n?[]:n,a=t.texCoords,o=t.colors,s=t.morphTargets;this.buffers=this.createBufferContainer(),e=this.createGeometryData(r,i,a,o,s),this.buffers.geometryData=e,this.buffers.init(),this._material.init(),this.computeNormals(),this.vaoManager&&this.vaoManager.init()},Geometry.prototype.hasFaceNormals=function(){return this.buffers.geometryData.hasFaceNormals()},Geometry.prototype.hasVertexNormals=function(){return this.buffers.geometryData.hasVertexNormals()},Geometry.prototype.isSmoothShading=function(){return this._material.shading===e.EShading.SMOOTH},Geometry.prototype.dispose=function(){this.buffers.dispose(),this._material.dispose(),this.vaoManager&&this.vaoManager.dispose()},Geometry.prototype.computeFaceNormals=function(){this.buffers.geometryData.computeFaceNormals()},Geometry.prototype.computeVertexNormals=function(){this.buffers.geometryData.computeVertexNormals()},Geometry.prototype.createBuffersFromGeometryData=function(){this.buffers.createBuffersFromGeometryData()},Geometry.prototype.computeNormals=function(){this.isSmoothShading()?this.hasVertexNormals()||this.computeVertexNormals():this.hasFaceNormals()||this.computeFaceNormals()},Geometry.prototype.createBufferContainer=function(){return e.BasicBufferContainer.create(this.entityObject)},Geometry.prototype.createGeometryData=function(e,t,r,n,i){return this.createBasicGeometryData(e,t,r,n)},Geometry.prototype.createBasicGeometryData=function(t,r,n,i){var a=e.BasicGeometryData.create(this);return a.vertices=t,a.faces=r,a.texCoords=n,a.colors=i,a},__decorate([e.cloneAttributeAsCloneable()],Geometry.prototype,"material",null),__decorate([e.cloneAttributeAsBasicType()],Geometry.prototype,"drawMode",void 0),__decorate([e.ensure(function(){var t=this.buffers.geometryData;e.it("faces.count should be be "+t.indices.length/3+", but actual is "+t.faces.length,function(){e.expect(3*t.faces.length).equals(t.indices.length)})}),e.execOnlyOnce("_isInit")],Geometry.prototype,"init",null),__decorate([e.require(function(){var t=this;e.it("must define buffers->geometryData",function(){e.expect(t.buffers).exist,e.expect(t.buffers.geometryData).exist})})],Geometry.prototype,"hasFaceNormals",null),__decorate([e.require(function(){var t=this;e.it("must define buffers->geometryData",function(){e.expect(t.buffers).exist,e.expect(t.buffers.geometryData).exist})})],Geometry.prototype,"hasVertexNormals",null),__decorate([e.require(function(){var t=this;e.it("must define buffers->geometryData",function(){e.expect(t.buffers).exist,e.expect(t.buffers.geometryData).exist})})],Geometry.prototype,"computeFaceNormals",null),__decorate([e.require(function(){var t=this;e.it("not exist buffers",function(){e.expect(t.buffers).exist})})],Geometry.prototype,"createBuffersFromGeometryData",null),__decorate([e.virtual],Geometry.prototype,"computeNormals",null),__decorate([e.virtual],Geometry.prototype,"createBufferContainer",null),__decorate([e.virtual],Geometry.prototype,"createGeometryData",null),Geometry}(e.Component);e.Geometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function InstanceGeometry(){t.apply(this,arguments),this._customGeometry=e.CustomGeometry.create(),this._attributeData=wdCb.Collection.create(),this.dirty=!1}return __extends(InstanceGeometry,t),Object.defineProperty(InstanceGeometry.prototype,"vertices",{get:function(){return this._customGeometry.vertices},set:function(e){this._customGeometry.vertices=e},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"texCoords",{get:function(){return this._customGeometry.texCoords},set:function(e){this._customGeometry.texCoords=e},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"colors",{get:function(){return this._customGeometry.colors},set:function(e){this._customGeometry.colors=e},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"indices",{get:function(){return this._customGeometry.indices},set:function(e){this._customGeometry.indices=e},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"normals",{get:function(){return this._customGeometry.normals},set:function(e){this._customGeometry.normals=e},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"instanceAttributeData",{get:function(){return this.attributeData.getChild(0)},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"instanceCount",{get:function(){return this.attributeData.getCount()},enumerable:!0,configurable:!0}),Object.defineProperty(InstanceGeometry.prototype,"attributeData",{get:function(){return this._attributeData},enumerable:!0,configurable:!0}),InstanceGeometry.prototype.addInstanceAttributes=function(e){
var t=wdCb.Collection.create();this.dirty=!0;for(var r=0,n=e;r<n.length;r++){var i=n[r];t.addChild(wdCb.ExtendUtils.extend({meshPerAttribute:1},i))}this._attributeData.addChild(t)},InstanceGeometry.prototype.clearInstanceAttributeData=function(){this.dirty=!0,this._attributeData.removeAllChildren()},InstanceGeometry.prototype.computeData=function(){return{vertices:this.vertices,faces:e.GeometryUtils.convertToFaces(this.indices,this.normals),texCoords:this.texCoords,colors:this.colors}},__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],InstanceGeometry.prototype,"vertices",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],InstanceGeometry.prototype,"texCoords",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],InstanceGeometry.prototype,"colors",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],InstanceGeometry.prototype,"indices",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],InstanceGeometry.prototype,"normals",null),__decorate([e.requireGetter(function(){var t=this;e.it("attributeData.length should > 0",function(){e.expect(t.attributeData.getCount()).greaterThan(0)},this)}),e.ensureGetter(function(t){var r=this;e.it("each data of all instance datas should be the same except the data",function(){r.attributeData.forEach(function(r){r.forEach(function(r,n){e.expect(r.attributeName).equals(t.getChild(n).attributeName),e.expect(r.meshPerAttribute).equals(t.getChild(n).meshPerAttribute)})})},this)})],InstanceGeometry.prototype,"instanceAttributeData",null),__decorate([e.cloneAttributeAsCustomType(function(e,t,r){var n=e[r],i=t[r];n.forEach(function(e){i.addChild(e.clone(!0))})})],InstanceGeometry.prototype,"attributeData",null),__decorate([e.cloneAttributeAsBasicType()],InstanceGeometry.prototype,"dirty",void 0),__decorate([e.require(function(t){e.it("attributeName shouldn't equal vertices|normals|indices|texCoords|colors",function(){for(var r=0,n=t;r<n.length;r++){var i=n[r],a=i.attributeName;e.expect(a).not.equals("vertices"),e.expect(a).not.equals("normals"),e.expect(a).not.equals("indices"),e.expect(a).not.equals("texCoords"),e.expect(a).not.equals("colors")}}),e.it("data should be Array<number> or Float32Array",function(){for(var r=0,n=t;r<n.length;r++){var i=n[r],a=i.data;e.expect(e.JudgeUtils.isArrayExactly(a)||"[object Float32Array]"===Object.prototype.toString.call(a)).true}})})],InstanceGeometry.prototype,"addInstanceAttributes",null),InstanceGeometry}(e.Geometry);e.InstanceGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicInstanceGeometry(){e.apply(this,arguments)}return __extends(BasicInstanceGeometry,e),BasicInstanceGeometry.create=function(){var e=new this;return e},BasicInstanceGeometry}(e.InstanceGeometry);e.BasicInstanceGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(){function VAOManager(){this._vaoMap=wdCb.Hash.create(),this._extension=null}return VAOManager.create=function(){var e=new this;return e},VAOManager.prototype.init=function(){this._extension=e.GPUDetector.getInstance().extensionVAO},VAOManager.prototype.dispose=function(){this._vaoMap.removeAllChildren()},VAOManager.prototype.getVAOData=function(e){var t=!1,r=this._vaoMap.getChild(e);return r?t=!0:(r=this._extension.createVertexArrayOES(),this._vaoMap.addChild(e,r),t=!1),{vao:r,isSetted:t}},VAOManager.prototype.sendAllBufferData=function(t,r){var n=this.getVAOData(t),i=n.vao,a=n.isSetted;if(e.BufferTable.lastBindedElementBuffer=null,this._extension.bindVertexArrayOES(i),!a)for(var o=0,s=r.length;o<s;o++){var c=r[o];if(c){var u=e.DeviceManager.getInstance().gl;u.bindBuffer(u.ARRAY_BUFFER,c.buffer),u.vertexAttribPointer(o,c.size,u[c.type],!1,0,0),u.enableVertexAttribArray(o)}}},__decorate([e.require(function(){e.assert(!!e.GPUDetector.getInstance().extensionVAO,e.Log.info.FUNC_SHOULD("hardware","support vao extension"))})],VAOManager.prototype,"init",null),VAOManager}();e.VAOManager=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function LineGeometry(){t.apply(this,arguments),this._customGeometry=e.CustomGeometry.create()}return __extends(LineGeometry,t),Object.defineProperty(LineGeometry.prototype,"vertices",{get:function(){return this._customGeometry.vertices},set:function(e){this._customGeometry.vertices=e},enumerable:!0,configurable:!0}),LineGeometry.prototype.computeData=function(){return{vertices:this.computeVertices()}},__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],LineGeometry.prototype,"vertices",null),LineGeometry}(e.Geometry);e.LineGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SolidLineGeometry(){t.apply(this,arguments)}return __extends(SolidLineGeometry,t),SolidLineGeometry.create=function(){var e=new this;return e.initWhenCreate(),e},SolidLineGeometry.prototype.initWhenCreate=function(){this.drawMode=e.EDrawMode.LINE_STRIP},SolidLineGeometry.prototype.computeVertices=function(){return this.vertices},SolidLineGeometry}(e.LineGeometry);e.SolidLineGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DashLineGeometry(){t.apply(this,arguments),this.dashSize=3,this.gapSize=1,this.dashCount=200}return __extends(DashLineGeometry,t),DashLineGeometry.create=function(){var e=new this;return e.initWhenCreate(),e},DashLineGeometry.prototype.initWhenCreate=function(){this.drawMode=e.EDrawMode.LINES},DashLineGeometry.prototype.computeVertices=function(){for(var t=this.dashSize,r=this.gapSize,n=this.dashCount,i=this.vertices.slice(0),a=e.Vector3.create(),o=0,s=0,c=0,u=0,l=0,d=[],h=0,p=i.length-3;h<p;h+=3)a.x=i[h+3]-i[h],a.y=i[h+4]-i[h+1],a.z=i[h+5]-i[h+2],o+=a.length();c=o/n,u=t*c/(t+r);for(var h=0,p=i.length-3;h<p;h+=3){a.x=i[h+3]-i[h],a.y=i[h+4]-i[h+1],a.z=i[h+5]-i[h+2],s=Math.floor(a.length()/c),a.normalize();for(var f=0;f<s;f++)l=c*f,d.push(i[h]+l*a.x,i[h+1]+l*a.y,i[h+2]+l*a.z),d.push(i[h]+(l+u)*a.x,i[h+1]+(l+u)*a.y,i[h+2]+(l+u)*a.z)}return d},__decorate([e.cloneAttributeAsBasicType()],DashLineGeometry.prototype,"dashSize",void 0),__decorate([e.cloneAttributeAsBasicType()],DashLineGeometry.prototype,"gapSize",void 0),__decorate([e.cloneAttributeAsBasicType()],DashLineGeometry.prototype,"dashCount",void 0),DashLineGeometry}(e.LineGeometry);e.DashLineGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ConvexPolygonGeometry(){t.apply(this,arguments),this._customGeometry=e.CustomGeometry.create()}return __extends(ConvexPolygonGeometry,t),ConvexPolygonGeometry.create=function(){var e=new this;return e},Object.defineProperty(ConvexPolygonGeometry.prototype,"vertices",{get:function(){return this._customGeometry.vertices},set:function(e){this._customGeometry.vertices=e},enumerable:!0,configurable:!0}),Object.defineProperty(ConvexPolygonGeometry.prototype,"texCoords",{get:function(){return this._customGeometry.texCoords},set:function(e){this._customGeometry.texCoords=e},enumerable:!0,configurable:!0}),Object.defineProperty(ConvexPolygonGeometry.prototype,"colors",{get:function(){return this._customGeometry.colors},set:function(e){this._customGeometry.colors=e},enumerable:!0,configurable:!0}),Object.defineProperty(ConvexPolygonGeometry.prototype,"indices",{get:function(){return this._customGeometry.indices},set:function(e){this._customGeometry.indices=e},enumerable:!0,configurable:!0}),Object.defineProperty(ConvexPolygonGeometry.prototype,"normals",{get:function(){return this._customGeometry.normals},set:function(e){this._customGeometry.normals=e},enumerable:!0,configurable:!0}),ConvexPolygonGeometry.prototype.computeData=function(){for(var t=[],r=1,n=this.vertices.length/3-1;r<n;r++)t.push(0,r+1,r);return this.indices=t,{vertices:this.vertices,faces:e.GeometryUtils.convertToFaces(this.indices,this.normals),texCoords:this.texCoords,colors:this.colors}},__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ConvexPolygonGeometry.prototype,"vertices",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ConvexPolygonGeometry.prototype,"texCoords",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ConvexPolygonGeometry.prototype,"colors",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ConvexPolygonGeometry.prototype,"indices",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ConvexPolygonGeometry.prototype,"normals",null),ConvexPolygonGeometry}(e.Geometry);e.ConvexPolygonGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GeometryUtils(){}return GeometryUtils.convertToFaces=function(t,r){for(var n=this.hasData(r),i=[],a=0,o=t.length;a<o;a+=3){var s=t[a],c=t[a+1],u=t[a+2],l=e.Face3.create(s,c,u);n&&(l.vertexNormals.addChildren([this.getThreeComponent(r,s),this.getThreeComponent(r,c),this.getThreeComponent(r,u)]),l.faceNormal=l.vertexNormals.getChild(0).clone()),i.push(l)}return i},GeometryUtils.hasData=function(e){return e&&(e.length&&e.length>0||e.getCount&&e.getCount()>0)},GeometryUtils.getThreeComponent=function(t,r){var n=3*r;return e.Vector3.create(t[n],t[n+1],t[n+2])},GeometryUtils.iterateThreeComponent=function(t,r){for(var n=0,i=t.length;n<i;n+=3)r(e.Vector3.create(t[n],t[n+1],t[n+2]))},GeometryUtils.setThreeComponent=function(t,r,n){r instanceof e.Vector3?(t[3*n]=r.x,t[3*n+1]=r.y,t[3*n+2]=r.z):(t[3*n]=r[0],t[3*n+1]=r[1],t[3*n+2]=r[2])},__decorate([e.require(function(t){t&&e.assert(t instanceof wdCb.Collection||t instanceof wdCb.Hash||e.JudgeUtils.isArrayExactly(t),e.Log.info.FUNC_SHOULD("data","be Array or Collection or Hash"))})],GeometryUtils,"hasData",null),__decorate([e.require(function(t,r){e.assert(t.length%3===0,e.Log.info.FUNC_SHOULD("dataArr.length","times of three"))})],GeometryUtils,"iterateThreeComponent",null),GeometryUtils}();e.GeometryUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomGeometry(){t.apply(this,arguments),this._vertices=[],this._texCoords=[],this._colors=[],this._indices=[],this._normals=[]}return __extends(CustomGeometry,t),CustomGeometry.create=function(){var e=new this;return e},Object.defineProperty(CustomGeometry.prototype,"vertices",{get:function(){return this._vertices},set:function(e){this._vertices=e,this.buffers&&(this.buffers.geometryData.vertices=e)},enumerable:!0,configurable:!0}),Object.defineProperty(CustomGeometry.prototype,"texCoords",{get:function(){return this._texCoords},set:function(e){this._texCoords=e,this.buffers&&(this.buffers.geometryData.texCoords=e)},enumerable:!0,configurable:!0}),Object.defineProperty(CustomGeometry.prototype,"colors",{get:function(){return this._colors},set:function(e){this._colors=e,this.buffers&&(this.buffers.geometryData.colors=e)},enumerable:!0,configurable:!0}),Object.defineProperty(CustomGeometry.prototype,"indices",{get:function(){return this._indices},set:function(t){this._indices=t,this.buffers&&(this.buffers.geometryData.faces=e.GeometryUtils.convertToFaces(t,this.normals))},enumerable:!0,configurable:!0}),Object.defineProperty(CustomGeometry.prototype,"normals",{get:function(){return this._normals},set:function(t){this._normals=t,this.buffers&&(this.buffers.geometryData.faces=e.GeometryUtils.convertToFaces(this.indices,t))},enumerable:!0,configurable:!0}),CustomGeometry.prototype.computeData=function(){return{vertices:this.vertices,faces:e.GeometryUtils.convertToFaces(this.indices,this.normals),texCoords:this.texCoords,colors:this.colors}},__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],CustomGeometry.prototype,"vertices",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],CustomGeometry.prototype,"texCoords",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],CustomGeometry.prototype,"colors",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],CustomGeometry.prototype,"indices",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],CustomGeometry.prototype,"normals",null),CustomGeometry}(e.Geometry);e.CustomGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ModelGeometry(){t.apply(this,arguments),this.vertices=null,this.colors=null,this.texCoords=null,this.faces=null,this.morphTargets=null,this.morphFaceNormals=wdCb.Hash.create(),this.morphVertexNormals=wdCb.Hash.create()}return __extends(ModelGeometry,t),ModelGeometry.create=function(){var e=new this;return e},ModelGeometry.prototype.hasAnimation=function(){return this._hasMorphTargets()&&this.entityObject&&this.entityObject.hasComponent(e.MorphAnimation)},ModelGeometry.prototype.hasMorphFaceNormals=function(){return this.buffers.geometryData.hasMorphFaceNormals()},ModelGeometry.prototype.hasMorphVertexNormals=function(){return this.buffers.geometryData.hasMorphVertexNormals()},ModelGeometry.prototype.computeMorphNormals=function(){this.buffers.geometryData.computeMorphNormals()},ModelGeometry.prototype.merge=function(e,t){var r=this._getSourceGeometryData(),n=this._getTargetGeometryData(e);r=this._initGeometryData(r),this.faces=this._mergeTransformedFace(r.faces,n.faces,t,r.vertices.length/3),this.vertices=this._mergeData(r.vertices,this._transformVertices(n.vertices,t)),this.texCoords=this._mergeData(r.texCoords,n.texCoords),this.colors=this._mergeData(r.colors,n.colors)},ModelGeometry.prototype._getSourceGeometryData=function(){return null!==this.geometryData?this.geometryData:{vertices:this.vertices,texCoords:this.texCoords,colors:this.colors,faces:this.faces}},ModelGeometry.prototype._initGeometryData=function(e){return{vertices:e.vertices||[],texCoords:e.texCoords||[],colors:e.colors||[],faces:e.faces||[]}},ModelGeometry.prototype._getTargetGeometryData=function(e){return null!==e.geometryData?e.geometryData:e instanceof ModelGeometry?{vertices:e.vertices,texCoords:e.texCoords,colors:e.colors,faces:e.faces}:e.computeData()},ModelGeometry.prototype._transformVertices=function(t,r){for(var n=r.localToWorldMatrix,i=[],a=0,o=t.length;a<o;a+=3){var s=e.Vector3.create(t[a],t[a+1],t[a+2]).applyMatrix4(n);i.push(s.x,s.y,s.z)}return i},ModelGeometry.prototype._mergeTransformedFace=function(t,r,n,i){var a=null;if(!r)return t;a=n.normalMatrix;for(var o=function(r){var n=e.Face3.create(r.aIndex+i,r.bIndex+i,r.cIndex+i);if(r.hasFaceNormal()&&(n.faceNormal=r.faceNormal.clone().applyMatrix3(a)),r.vertexNormals){var o=wdCb.Collection.create();r.vertexNormals.forEach(function(e){o.addChild(e.clone().applyMatrix3(a))}),n.vertexNormals=o}t.push(n)},s=0,c=r;s<c.length;s++){var u=c[s];o(u)}return t},ModelGeometry.prototype._mergeData=function(e,t){return t?e.concat(t):e},ModelGeometry.prototype._mergeFace=function(e,t){if(!t)return e;for(var r=0,n=t;r<n.length;r++){var i=n[r];e.push(i.clone())}return e},ModelGeometry.prototype.computeNormals=function(){t.prototype.computeNormals.call(this),this._hasMorphTargets()&&(this.isSmoothShading()?this.hasMorphVertexNormals()||this.computeMorphNormals():this.hasMorphFaceNormals()||this.computeMorphNormals())},ModelGeometry.prototype.computeData=function(){return{vertices:this.vertices,faces:this.faces,texCoords:this.texCoords,colors:this.colors,morphTargets:this.morphTargets}},ModelGeometry.prototype.createBufferContainer=function(){return this.hasAnimation()?e.MorphBufferContainer.create(this.entityObject,this.entityObject.getComponent(e.MorphAnimation)):e.BasicBufferContainer.create(this.entityObject)},ModelGeometry.prototype.createGeometryData=function(t,r,n,i,a){if(this.hasAnimation()){var o=e.MorphGeometryData.create(this);return o.vertices=t,o.faces=r,o.texCoords=n,o.colors=i,o.morphTargets=a,o}return this.createBasicGeometryData(t,r,n,i)},ModelGeometry.prototype._hasMorphTargets=function(){return this.morphTargets&&this.morphTargets.getCount()>0},ModelGeometry.prototype._getDeepCloneMorphData=function(e){var t=wdCb.Hash.create();return e&&e.forEach(function(e,r){t.addChild(r,e.clone(!0))}),t},__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ModelGeometry.prototype,"vertices",void 0),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ModelGeometry.prototype,"colors",void 0),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n])})],ModelGeometry.prototype,"texCoords",void 0),__decorate([e.cloneAttributeAsCustomType(function(e,t,r){t[r]=this._mergeFace([],e[r])})],ModelGeometry.prototype,"faces",void 0),__decorate([e.cloneAttributeAsCustomType(function(e,t,r){t[r]=this._getDeepCloneMorphData(e[r])})],ModelGeometry.prototype,"morphTargets",void 0),__decorate([e.cloneAttributeAsCustomType(function(e,t,r){t[r]=this._getDeepCloneMorphData(e[r])})],ModelGeometry.prototype,"morphFaceNormals",void 0),__decorate([e.cloneAttributeAsCustomType(function(e,t,r){t[r]=this._getDeepCloneMorphData(e[r])})],ModelGeometry.prototype,"morphVertexNormals",void 0),__decorate([e.require(function(){e.assert(this.buffers&&this.buffers.geometryData,e.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],ModelGeometry.prototype,"hasMorphFaceNormals",null),__decorate([e.require(function(){e.assert(this.buffers&&this.buffers.geometryData,e.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],ModelGeometry.prototype,"hasMorphVertexNormals",null),__decorate([e.require(function(){e.assert(this.buffers&&this.buffers.geometryData,e.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],ModelGeometry.prototype,"computeMorphNormals",null),__decorate([e.require(function(t,r){e.assert(t&&t.length>0,e.Log.info.FUNC_MUST("vertices.count","> 0"))})],ModelGeometry.prototype,"_transformVertices",null),__decorate([e.require(function(){this.hasAnimation()&&e.assert(this.entityObject.getComponent(e.MorphAnimation),e.Log.info.FUNC_SHOULD("entityObject with ModelGeometry","add MorphAnimation component"))})],ModelGeometry.prototype,"createBufferContainer",null),ModelGeometry}(e.Geometry);e.ModelGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BoxGeometry(){t.apply(this,arguments),this.width=null,this.height=null,this.depth=null,this.widthSegments=1,this.heightSegments=1,this.depthSegments=1}return __extends(BoxGeometry,t),BoxGeometry.create=function(){var e=new this;return e},BoxGeometry.prototype.computeData=function(){function generateFace(t,r,n){var i,a,o,s,m=d.length/3;for(o=0;o<=r;o++)for(s=0;s<=n;s++){var g=e.Vector3.create(),_=e.Vector3.create(),y=e.Vector3.create(),v=e.Vector3.create();g.lerp(l[c[t][0]],l[c[t][1]],o/r),_.lerp(l[c[t][0]],l[c[t][2]],s/n),y.sub2(_,l[c[t][0]]),v.add2(g,y),i=o/r,a=s/n,d.push(v.x,v.y,v.z),h.push(u[t][0],u[t][1],u[t][2]),p.push(i,a),o<r&&s<n&&(f.push(m+s+o*(r+1),m+s+(o+1)*(r+1),m+s+o*(r+1)+1),f.push(m+s+(o+1)*(r+1),m+s+(o+1)*(r+1)+1,m+s+o*(r+1)+1))}}var t=this.width,r=this.height,n=this.depth,i=this.widthSegments,a=this.heightSegments,o=this.depthSegments,s={FRONT:0,BACK:1,TOP:2,BOTTOM:3,RIGHT:4,LEFT:5},c=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],u=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],l=[e.Vector3.create(-t,-r,n),e.Vector3.create(t,-r,n),e.Vector3.create(t,r,n),e.Vector3.create(-t,r,n),e.Vector3.create(t,-r,-n),e.Vector3.create(-t,-r,-n),e.Vector3.create(-t,r,-n),e.Vector3.create(t,r,-n)],d=[],h=[],p=[],f=[];return generateFace(s.FRONT,i,a),generateFace(s.BACK,i,a),generateFace(s.TOP,i,o),generateFace(s.BOTTOM,i,o),generateFace(s.RIGHT,o,a),generateFace(s.LEFT,o,a),{vertices:d,faces:e.GeometryUtils.convertToFaces(f,h),texCoords:p}},__decorate([e.cloneAttributeAsBasicType()],BoxGeometry.prototype,"width",void 0),__decorate([e.cloneAttributeAsBasicType()],BoxGeometry.prototype,"height",void 0),__decorate([e.cloneAttributeAsBasicType()],BoxGeometry.prototype,"depth",void 0),__decorate([e.cloneAttributeAsBasicType()],BoxGeometry.prototype,"widthSegments",void 0),__decorate([e.cloneAttributeAsBasicType()],BoxGeometry.prototype,"heightSegments",void 0),__decorate([e.cloneAttributeAsBasicType()],BoxGeometry.prototype,"depthSegments",void 0),BoxGeometry}(e.Geometry);e.BoxGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RectGeometry(){t.apply(this,arguments),this.width=null,this.height=null}return __extends(RectGeometry,t),RectGeometry.create=function(){var e=new this;return e},RectGeometry.prototype.computeData=function(){var t=this.width,r=this.height,n=-t/2,i=t/2,a=r/2,o=-r/2,s=[],c=[],u=[],l=[];return s=[i,a,0,n,a,0,n,o,0,i,o,0],u=[0,1,2,0,2,3],c=[1,1,0,1,0,0,1,0],l=[0,0,1,0,0,1,0,0,1,0,0,1],{vertices:s,faces:e.GeometryUtils.convertToFaces(u,l),texCoords:c}},__decorate([e.cloneAttributeAsBasicType()],RectGeometry.prototype,"width",void 0),__decorate([e.cloneAttributeAsBasicType()],RectGeometry.prototype,"height",void 0),RectGeometry}(e.Geometry);e.RectGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function PlaneGeometry(){t.apply(this,arguments),this.width=null,this.height=null,this.widthSegments=1,this.heightSegments=1}return __extends(PlaneGeometry,t),PlaneGeometry.create=function(){var e=new this;return e},PlaneGeometry.prototype.computeData=function(){var t=this.width,r=this.height,n=this.widthSegments,i=this.heightSegments,a=null,o=null,s=null,c=null,u=null,l=null,d=null,h=[],p=[],f=[],m=[];for(l=0;l<=n;l++)for(d=0;d<=i;d++)a=-t+2*t*l/n,o=0,s=-(-r+2*r*d/i),c=l/n,u=d/i,h.push(a,o,s),f.push(0,1,0),p.push(c,u),l<n&&d<i&&(m.push(d+l*(n+1),d+(l+1)*(n+1),d+l*(n+1)+1),m.push(d+(l+1)*(n+1),d+(l+1)*(n+1)+1,d+l*(n+1)+1));return{vertices:h,faces:e.GeometryUtils.convertToFaces(m,f),texCoords:p}},__decorate([e.cloneAttributeAsBasicType()],PlaneGeometry.prototype,"width",void 0),__decorate([e.cloneAttributeAsBasicType()],PlaneGeometry.prototype,"height",void 0),__decorate([e.cloneAttributeAsBasicType()],PlaneGeometry.prototype,"widthSegments",void 0),__decorate([e.cloneAttributeAsBasicType()],PlaneGeometry.prototype,"heightSegments",void 0),PlaneGeometry}(e.Geometry);e.PlaneGeometry=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.LATITUDELONGTITUDE=0]="LATITUDELONGTITUDE"}(e.ESphereDrawMode||(e.ESphereDrawMode={}));e.ESphereDrawMode}(wd||(wd={}));var wd;!function(e){var t=function(t){function SphereGeometry(){t.apply(this,arguments),this.radius=1,this.sphereDrawMode=e.ESphereDrawMode.LATITUDELONGTITUDE,this.segments=20}return __extends(SphereGeometry,t),SphereGeometry.create=function(){var e=new this;return e},SphereGeometry.prototype.computeData=function(){var t=this.radius,n=(this.sphereDrawMode,this.segments),i=r.create(t,n).getData(),a=i.vertices,o=i.indices,s=i.normals,c=i.texCoords;return{vertices:a,faces:e.GeometryUtils.convertToFaces(o,s),texCoords:c}},__decorate([e.cloneAttributeAsBasicType()],SphereGeometry.prototype,"radius",void 0),__decorate([e.cloneAttributeAsBasicType()],SphereGeometry.prototype,"sphereDrawMode",void 0),__decorate([e.cloneAttributeAsBasicType()],SphereGeometry.prototype,"segments",void 0),__decorate([e.require(function(){e.assert(this.sphereDrawMode===e.ESphereDrawMode.LATITUDELONGTITUDE,e.Log.info.FUNC_MUST_BE("sphereDrawMode","ESphereDrawMode.LATITUDELONGTITUDE"))})],SphereGeometry.prototype,"computeData",null),SphereGeometry}(e.Geometry);e.SphereGeometry=t;var r=function(){function GetDataByLatitudeLongtitude(e,t){this._radius=null,this._latitudeBands=null,this._longitudeBands=null,this._radius=e,this._latitudeBands=t,this._longitudeBands=t}return GetDataByLatitudeLongtitude.create=function(e,t){var r=new this(e,t);return r},GetDataByLatitudeLongtitude.prototype.getData=function(){for(var e=[],t=[],r=[],n=[],i=0;i<=this._latitudeBands;i++)for(var a=i*Math.PI/this._latitudeBands,o=Math.sin(a),s=Math.cos(a),c=0;c<=this._longitudeBands;c++){var u=2*c*Math.PI/this._longitudeBands,l=Math.sin(u),d=Math.cos(u),h=this._radius*d*o,p=this._radius*s,f=this._radius*l*o,m=1-c/this._longitudeBands,g=1-i/this._latitudeBands;t.push(h),t.push(p),t.push(f),r.push(m),r.push(g),e.push(h),e.push(p),e.push(f)}for(var i=0;i<this._latitudeBands;i++)for(var c=0;c<this._longitudeBands;c++){var _=i*(this._longitudeBands+1)+c,y=_+this._longitudeBands+1;n.push(_+1),n.push(y),n.push(_),n.push(_+1),n.push(y+1),n.push(y)}return{vertices:e,indices:n,normals:t,texCoords:r}},GetDataByLatitudeLongtitude}()}(wd||(wd={}));var wd;!function(e){var t=function(t){function TriangleGeometry(){t.apply(this,arguments),this.width=null,this.height=null}return __extends(TriangleGeometry,t),TriangleGeometry.create=function(){var e=new this;return e},TriangleGeometry.prototype.computeData=function(){var t=this.width,r=this.height,n=-t/2,i=t/2,a=r/2,o=-r/2,s=null,c=null,u=null,l=null;return s=[0,a,0,n,o,0,i,o,0],u=[0,1,2],c=[.5,1,0,0,1,0],l=[0,0,1,0,0,1,0,0,1],{vertices:s,faces:e.GeometryUtils.convertToFaces(u,l),texCoords:c}},__decorate([e.cloneAttributeAsBasicType()],TriangleGeometry.prototype,"width",void 0),__decorate([e.cloneAttributeAsBasicType()],TriangleGeometry.prototype,"height",void 0),TriangleGeometry}(e.Geometry);e.TriangleGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TerrainGeometry(){t.apply(this,arguments),this._rangeWidth=null,this._rangeHeight=null,this.heightMapAsset=null,this.subdivisions=2,this.minHeight=0,this.maxHeight=10,this.isHeightMapStoreHeightInEachPixel=!0,this._heightMapImageDataCache=null,this._heightMapImageDataCacheWidth=null,this._heightMapImageDataCacheHeight=null,this._heightCache=[]}return __extends(TerrainGeometry,t),TerrainGeometry.create=function(){var e=new this;return e},Object.defineProperty(TerrainGeometry.prototype,"rangeWidth",{get:function(){return null!==this._rangeWidth?this._rangeWidth:null!==this._heightMapImageDataCacheWidth?this.isHeightMapStoreHeightInEachPixel?4*this._heightMapImageDataCacheWidth:this._heightMapImageDataCacheWidth:256},set:function(e){this._rangeWidth=e},enumerable:!0,configurable:!0}),Object.defineProperty(TerrainGeometry.prototype,"rangeHeight",{get:function(){return null!==this._rangeHeight?this._rangeHeight:null!==this._heightMapImageDataCacheHeight?this._heightMapImageDataCacheHeight:256},set:function(e){this._rangeHeight=e},enumerable:!0,configurable:!0}),Object.defineProperty(TerrainGeometry.prototype,"heightMapImageDataWidth",{get:function(){return this._heightMapImageDataCacheWidth},enumerable:!0,configurable:!0}),Object.defineProperty(TerrainGeometry.prototype,"heightMapImageDataHeight",{get:function(){return this._heightMapImageDataCacheHeight},enumerable:!0,configurable:!0}),TerrainGeometry.prototype.getHeightAtCoordinates=function(e,t){var r=this.entityObject.transform,n=null;if(e+=this.rangeWidth/2,t+=this.rangeHeight/2,e>this.rangeWidth||t>this.rangeHeight||e<0||t<0)return 0;this._isReadHeightMapData()||this._readHeightMapData();var i=this._getQuadHeightMapCoordinateArr(this._getQuadSubdivisionsCoordinateArr(e,t)),a=this._getCacheHeight(i[0]),o=this._getCacheHeight(i[1]),s=this._getCacheHeight(i[2]),c=this._getCacheHeight(i[3]);return n=this._getBilinearInterpolatedHeight(i[4],a,o,s,c),n*r.scale.y+r.position.y},TerrainGeometry.prototype._getQuadSubdivisionsCoordinateArr=function(t,r){var n=[],i=this.subdivisions,a=t/this.rangeWidth*i,o=r/this.rangeHeight*i,s=Math.floor(a),c=Math.floor(o),u=null,l=null,d=null,h=null;return s<i?(u=s,l=s+1):(u=s-1,l=s),c<i?(d=c,h=c+1):(d=c-1,h=c),n.push(e.Vector2.create(u,d)),n.push(e.Vector2.create(l,d)),n.push(e.Vector2.create(l,h)),n.push(e.Vector2.create(u,h)),n.push(e.Vector2.create(a-u,o-d)),n},TerrainGeometry.prototype._getQuadHeightMapCoordinateArr=function(e){for(var t=0;t<=3;t++){var r=e[t];r.x=this._computeHeightMapColInCanvasCoordinate(r.x),r.y=this._computeHeightMapRowInCanvasCoordinate(r.y)}return e},TerrainGeometry.prototype._getBilinearInterpolatedHeight=function(e,t,r,n,i){return(t*(1-e.x)+r*e.x)*(1-e.y)+(n*e.x+i*(1-e.x))*e.y},TerrainGeometry.prototype._getCacheHeight=function(e){var t=e.x,r=e.y,n=this._computeHeightMapIndex(r,t),i=this._heightCache[n];if(void 0!==i)return i;var a=this._getHeightByReadHeightMapData(n);return this._heightCache[n]=a,a},TerrainGeometry.prototype.computeData=function(){return this._isReadHeightMapData()||this._readHeightMapData(),this._createGroundFromHeightMap()},TerrainGeometry.prototype._isReadHeightMapData=function(){return null!==this._heightMapImageDataCache},TerrainGeometry.prototype._readHeightMapData=function(){var e=this.heightMapAsset.source,t=e.width,r=e.height,n=document.createElement("canvas"),i=n.getContext("2d");n.width=t,n.height=r,i.drawImage(e,0,0),this._heightMapImageDataCache=i.getImageData(0,0,t,r).data,this._heightMapImageDataCacheWidth=t,this._heightMapImageDataCacheHeight=r},TerrainGeometry.prototype._createGroundFromHeightMap=function(){for(var t=[],r=[],n=[],i=this.subdivisions,a=this.rangeWidth,o=this.rangeHeight,s=this._heightCache,c=0;c<i;c++)for(var u=0;u<i;u++){var l=u*a/i-a/2,d=(i-c)*o/i-o/2,h=this._computeHeightMapRowInTexCoordCoordinate(c),p=this._computeHeightMapColInTexCoordCoordinate(u),f=this._computeHeightMapIndex(h,p),m=null;m=this._getHeightByReadHeightMapData(f),s[f]=m,t.push(l,m,d),n.push(u/i,1-c/i)}return{vertices:t,faces:e.GeometryUtils.convertToFaces(this._getIndices(),r),texCoords:n}},TerrainGeometry.prototype._computeHeightMapColInCanvasCoordinate=function(e){var t=Math.floor(e/this.subdivisions*this._heightMapImageDataCacheWidth);return t>0&&(t-=1),t},TerrainGeometry.prototype._computeHeightMapRowInCanvasCoordinate=function(e){var t=Math.floor(e/this.subdivisions*this._heightMapImageDataCacheHeight);return t>0&&(t-=1),t},TerrainGeometry.prototype._computeHeightMapColInTexCoordCoordinate=function(e){return this._computeHeightMapColInCanvasCoordinate(e)},TerrainGeometry.prototype._computeHeightMapRowInTexCoordCoordinate=function(e){var t=Math.floor((1-e/this.subdivisions)*this._heightMapImageDataCacheHeight);return t>0&&(t-=1),t},TerrainGeometry.prototype._computeHeightMapIndex=function(e,t){var r=4*(t+e*this._heightMapImageDataCacheWidth);return r},TerrainGeometry.prototype._getHeightByReadHeightMapData=function(e){var t=this._heightMapImageDataCache,r=t[e]/256,n=t[e+1]/256,i=t[e+2]/256,a=.3*r+.59*n+.11*i,o=this.minHeight,s=this.maxHeight;return o+(s-o)*a},TerrainGeometry.prototype._getIndices=function(){for(var e=[],t=this.subdivisions,r=0;r<t-1;r++)for(var n=0;n<t-1;n++)e.push(n+r*t),e.push(n+1+r*t),e.push(n+1+(r+1)*t),e.push(n+r*t),e.push(n+1+(r+1)*t),e.push(n+(r+1)*t);return e},__decorate([e.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"rangeWidth",null),__decorate([e.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"rangeHeight",null),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){t[n]&&(r[n]=e.ImageTextureAsset.create(t[n].source))})],TerrainGeometry.prototype,"heightMapAsset",void 0),__decorate([e.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"subdivisions",void 0),__decorate([e.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"minHeight",void 0),__decorate([e.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"maxHeight",void 0),__decorate([e.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"isHeightMapStoreHeightInEachPixel",void 0),TerrainGeometry}(e.Geometry);e.TerrainGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GeometryData(e){this._vertices=null,this._faces=null,this._texCoords=null,this._colors=null,this._tangents=null,this.tangentDirty=!0,this.colorDirty=!0,this.geometry=null,this._normalCache=null,this._normalFromFaceCache=null,this._normalFromVertexCache=null,this._indiceCache=null,this._colorCache=null,this._normalDirty=!0,this._indiceDirty=!0,this._materialColorChangeSubscription=null,this.geometry=e}return Object.defineProperty(GeometryData.prototype,"vertices",{get:function(){return this._vertices},
set:function(t){this._vertices=t,this.tangentDirty=!0,this.geometry.buffers.removeCache(e.EBufferDataType.VERTICE)},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"normals",{get:function(){var e=this.geometry;return e.isSmoothShading()?(this.hasVertexNormals()||this.computeVertexNormals(),this.normalsFromVertexNormals):(this.hasFaceNormals()||this.computeFaceNormals(),this.normalsFromFaceNormal)},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"normalsFromFaceNormal",{get:function(){var t=null;return this.hasFaceNormals()?(t=[],this._faces.forEach(function(r){var n=r.faceNormal;e.GeometryUtils.setThreeComponent(t,n,r.aIndex),e.GeometryUtils.setThreeComponent(t,n,r.bIndex),e.GeometryUtils.setThreeComponent(t,n,r.cIndex)}),this._fillEmptyData(t),t):[]},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"normalsFromVertexNormals",{get:function(){var t=null;return this.hasVertexNormals()?(t=[],this._faces.forEach(function(r){e.GeometryUtils.setThreeComponent(t,r.vertexNormals.getChild(0),r.aIndex),e.GeometryUtils.setThreeComponent(t,r.vertexNormals.getChild(1),r.bIndex),e.GeometryUtils.setThreeComponent(t,r.vertexNormals.getChild(2),r.cIndex)}),this._fillEmptyData(t),t):[]},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"indices",{get:function(){for(var e=[],t=0,r=this._faces;t<r.length;t++){var n=r[t];e.push(n.aIndex,n.bIndex,n.cIndex)}return e},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"faces",{get:function(){return this._faces},set:function(t){this._faces=t,this.geometry.buffers.removeCache(e.EBufferDataType.NORMAL),this.geometry.buffers.removeCache(e.EBufferDataType.INDICE),this.onChangeFace()},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"texCoords",{get:function(){return this._texCoords},set:function(t){this._texCoords=t,this.tangentDirty=!0,this.geometry.buffers.removeCache(e.EBufferDataType.TEXCOORD)},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"colors",{get:function(){return this._needGetColorsFromMaterial()?this._getColorsFromMaterial(this._vertices):this._colors},set:function(t){this._colors=t,this.colorDirty=!0,this.geometry.buffers.removeCache(e.EBufferDataType.COLOR)},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"tangents",{get:function(){return this.tangentDirty&&(this.tangentDirty=!1,e.GeometryUtils.hasData(this.normals)&&e.GeometryUtils.hasData(this.texCoords)&&e.GeometryUtils.hasData(this.indices)&&(this._tangents=this._calculateTangents(this._vertices,this.normals,this.texCoords,this.indices))),this._tangents},enumerable:!0,configurable:!0}),GeometryData.prototype.init=function(){var t=this;this._materialColorChangeSubscription=wdFrp.fromArray([e.EventManager.fromEvent(this.geometry.entityObject,e.EEngineEvent.MATERIAL_COLOR_CHANGE),e.EventManager.fromEvent(this.geometry.entityObject,e.EEngineEvent.MATERIAL_CHANGE)]).subscribe(function(){t._needGetColorsFromMaterial()&&(t.colorDirty=!0)})},GeometryData.prototype.dispose=function(){this._materialColorChangeSubscription&&this._materialColorChangeSubscription.dispose()},GeometryData.prototype.computeFaceNormals=function(){var t=this._vertices;if(!e.GeometryUtils.hasData(this.vertices))return void e.Log.warn("has no vertices data, can't compute face normals");for(var r=0,n=this._faces;r<n.length;r++){var i=n[r];i.faceNormal=this.computeFaceNormalsHelper(t,i.aIndex,i.bIndex,i.cIndex)}},GeometryData.prototype.computeVertexNormals=function(){var e=null;this.hasFaceNormals()||this.computeFaceNormals(),e=this.computeVertexNormalsHelper(this._vertices);for(var t=0,r=this._faces;t<r.length;t++){var n=r[t];n.vertexNormals=wdCb.Collection.create([e[n.aIndex],e[n.bIndex],e[n.cIndex]])}},GeometryData.prototype.hasFaceNormals=function(){for(var e=0,t=this._faces;e<t.length;e++){var r=t[e];if(!r.hasFaceNormal())return!1}return!0},GeometryData.prototype.hasVertexNormals=function(){for(var e=0,t=this._faces;e<t.length;e++){var r=t[e];if(!r.hasVertexNormal())return!1}return!0},GeometryData.prototype.onChangeFace=function(){this.tangentDirty=!0,this._normalDirty=!0,this._indiceDirty=!0},GeometryData.prototype.computeFaceNormalsHelper=function(t,r,n,i){var a=e.GeometryUtils.getThreeComponent(t,r),o=e.GeometryUtils.getThreeComponent(t,n),s=e.GeometryUtils.getThreeComponent(t,i),c=e.Vector3.create().sub2(s,o),u=e.Vector3.create().sub2(a,o);return e.Vector3.create().cross(c,u).normalize()},GeometryData.prototype.computeVertexNormalsHelper=function(t){var r=t.length/3,n=null;n=new Array(r);for(var i=0;i<r;i++)n[i]=e.Vector3.create();for(var a=0,o=this._faces;a<o.length;a++){var s=o[a],c=null;c=s.faceNormal,n[s.aIndex].add(c),n[s.bIndex].add(c),n[s.cIndex].add(c)}for(var i=0;i<r;i++)n[i].normalize();return n},GeometryData.prototype._getColorsFromMaterial=function(e){var t=[],r=0,n=this.geometry.material.color,i=n.r,a=n.g,o=n.b,s=null;for(s=e.length/3,r=0;r<s;r++)t.push(i,a,o);return t},GeometryData.prototype._fillEmptyData=function(e){for(var t=0,r=e.length;t<r;t++)isNaN(e[t])&&(e[t]=0)},GeometryData.prototype._calculateTangents=function(t,r,n,i){var a,o,s,c,u,l,d,h,p,f,m,g,_,y,v,b=i.length/3,C=t.length/3,S=e.Vector3.create(),T=e.Vector3.create(),E=e.Vector3.create(),M=e.Vector3.create(),w=e.Vector3.create(),L=e.Vector2.create(),D=e.Vector2.create(),x=e.Vector2.create(),A=new Float32Array(3*C),O=new Float32Array(3*C),R=e.Vector3.create(),I=e.Vector3.create(),B=[];for(v=0;v<b;v++)a=i[3*v],o=i[3*v+1],s=i[3*v+2],E.set(t[3*a],t[3*a+1],t[3*a+2]),M.set(t[3*o],t[3*o+1],t[3*o+2]),w.set(t[3*s],t[3*s+1],t[3*s+2]),L.set(n[2*a],n[2*a+1]),D.set(n[2*o],n[2*o+1]),x.set(n[2*s],n[2*s+1]),c=M.x-E.x,u=w.x-E.x,l=M.y-E.y,d=w.y-E.y,h=M.z-E.z,p=w.z-E.z,f=D.x-L.x,m=x.x-L.x,g=D.y-L.y,_=x.y-L.y,y=1/(f*_-m*g),S.set((_*c-g*u)*y,(_*l-g*d)*y,(_*h-g*p)*y),T.set((f*u-m*c)*y,(f*d-m*l)*y,(f*p-m*h)*y),A[3*a+0]+=S.x,A[3*a+1]+=S.y,A[3*a+2]+=S.z,A[3*o+0]+=S.x,A[3*o+1]+=S.y,A[3*o+2]+=S.z,A[3*s+0]+=S.x,A[3*s+1]+=S.y,A[3*s+2]+=S.z,O[3*a+0]+=T.x,O[3*a+1]+=T.y,O[3*a+2]+=T.z,O[3*o+0]+=T.x,O[3*o+1]+=T.y,O[3*o+2]+=T.z,O[3*s+0]+=T.x,O[3*s+1]+=T.y,O[3*s+2]+=T.z;for(g=e.Vector3.create(),_=e.Vector3.create(),v=0;v<C;v++){var F=null;R.set(r[3*v],r[3*v+1],r[3*v+2]),g.set(A[3*v],A[3*v+1],A[3*v+2]),_.set(O[3*v],O[3*v+1],O[3*v+2]),F=R.dot(g),I=R.clone().scale(F),I.sub2(g,I).normalize(),B[4*v]=I.x,B[4*v+1]=I.y,B[4*v+2]=I.z,I.cross(R,g),B[4*v+3]=I.dot(_)<0?-1:1}return B},GeometryData.prototype._needGetColorsFromMaterial=function(){var e=this._colors;return!e||0===e.length},__decorate([e.requireGetter(function(){e.assert(this._faces.length>0,e.Log.info.FUNC_SHOULD("faces.count","> 0"));for(var t=0,r=this._faces;t<r.length;t++){var n=r[t];this.geometry.isSmoothShading()&&e.assert(n.vertexNormals&&3===n.vertexNormals.getCount(),e.Log.info.FUNC_SHOULD("faces->vertexNormals.count","=== 3"))}}),e.cacheGetter(function(){return!this._normalDirty&&this._normalCache},function(){return this._normalCache},function(e){this._normalCache=e,this._normalDirty=!1})],GeometryData.prototype,"normals",null),__decorate([e.requireGetter(function(){e.assert(this._faces.length>0,e.Log.info.FUNC_SHOULD("geometry","has faces"))}),e.ensureGetter(function(t){for(var r=0,n=t;r<n.length;r++){var i=n[r];e.assert(e.JudgeUtils.isNumber(i),e.Log.info.FUNC_SHOULD("normals data","be number"))}}),e.cacheGetter(function(){return!this._normalDirty&&this._normalFromFaceCache},function(){return this._normalFromFaceCache},function(e){this._normalFromFaceCache=e,this._normalDirty=!1})],GeometryData.prototype,"normalsFromFaceNormal",null),__decorate([e.requireGetter(function(){e.assert(this._faces.length>0,e.Log.info.FUNC_SHOULD("geometry","has faces"))}),e.ensureGetter(function(t){for(var r=0,n=t;r<n.length;r++){var i=n[r];e.assert(e.JudgeUtils.isNumber(i),e.Log.info.FUNC_SHOULD("normals data","be number"))}}),e.cacheGetter(function(){return!this._normalDirty&&this._normalFromVertexCache},function(){return this._normalFromVertexCache},function(e){this._normalFromVertexCache=e,this._normalDirty=!1})],GeometryData.prototype,"normalsFromVertexNormals",null),__decorate([e.cacheGetter(function(){return!this._indiceDirty&&this._indiceCache},function(){return this._indiceCache},function(e){this._indiceCache=e,this._indiceDirty=!1})],GeometryData.prototype,"indices",null),__decorate([e.ensureGetter(function(t){e.assert(t.length===this._vertices.length,e.Log.info.FUNC_SHOULD("colors.length:"+t.length,"=== vertices.length:"+this._vertices.length))}),e.cacheGetter(function(){return!this.colorDirty&&this._colorCache},function(){return this._colorCache},function(e){this._colorCache=e,this.colorDirty=!1})],GeometryData.prototype,"colors",null),__decorate([e.ensure(function(){for(var t=0,r=this._faces;t<r.length;t++){var n=r[t];e.assert(n.faceNormal instanceof e.Vector3,e.Log.info.FUNC_SHOULD_NOT("faceNormal","be null"))}})],GeometryData.prototype,"computeFaceNormals",null),__decorate([e.virtual],GeometryData.prototype,"onChangeFace",null),GeometryData}();e.GeometryData=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicGeometryData(){e.apply(this,arguments)}return __extends(BasicGeometryData,e),BasicGeometryData.create=function(e){var t=new this(e);return t},BasicGeometryData}(e.GeometryData);e.BasicGeometryData=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MorphGeometryData(){t.apply(this,arguments),this._morphTargets=null,this._morphNormalCache=null,this._morphNormalDirty=!0}return __extends(MorphGeometryData,t),MorphGeometryData.create=function(e){var t=new this(e);return t},Object.defineProperty(MorphGeometryData.prototype,"morphNormals",{get:function(){var e=this.geometry;return this._morphNormalDirty=!1,e.isSmoothShading()?(this.hasMorphVertexNormals()||this.computeMorphNormals(),e.morphVertexNormals):(this.hasMorphFaceNormals()||this.computeMorphNormals(),e.morphFaceNormals)},enumerable:!0,configurable:!0}),Object.defineProperty(MorphGeometryData.prototype,"morphTargets",{get:function(){return this._morphTargets},set:function(e){this._morphTargets=e,this._morphNormalDirty=!0},enumerable:!0,configurable:!0}),MorphGeometryData.prototype.computeMorphNormals=function(){var e=this.geometry,t=this;this._morphTargets.forEach(function(r,n){var i=wdCb.Collection.create(),a=wdCb.Collection.create();r.forEach(function(r){var n=MorphGeometryData.create(e),o=null,s=null;n.vertices=r,n.faces=t._copyFaces(e.faces),n.computeFaceNormals(),n.computeVertexNormals(),c=t._getMorphNormals(n),o=c[0],s=c[1],i.addChild(o),a.addChild(s);var c}),e.morphFaceNormals.addChild(n,i),e.morphVertexNormals.addChild(n,a)})},MorphGeometryData.prototype.hasMorphFaceNormals=function(){return this.geometry.morphFaceNormals.getCount()>0},MorphGeometryData.prototype.hasMorphVertexNormals=function(){return this.geometry.morphVertexNormals.getCount()>0},MorphGeometryData.prototype.onChangeFace=function(){this._morphNormalDirty=!0},MorphGeometryData.prototype._copyFaces=function(e){for(var t=[],r=0,n=e;r<n.length;r++){var i=n[r];t.push(i.clone())}return t},MorphGeometryData.prototype._getMorphNormals=function(e){return[e.normalsFromFaceNormal,e.normalsFromVertexNormals]},__decorate([e.cacheGetter(function(){return!this._morphNormalDirty&&this._morphNormalCache},function(){return this._morphNormalCache},function(e){this._morphNormalCache=e})],MorphGeometryData.prototype,"morphNormals",null),MorphGeometryData}(e.GeometryData);e.MorphGeometryData=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BufferContainer(e){this.geometryData=null,this.entityObject=null,this.container=wdCb.Hash.create(),this._colorBuffer=null,this._texCoordBuffer=null,this._tangentBuffer=null,this._indiceBuffer=null,this._materialChangeSubscription=null,this.entityObject=e}return BufferContainer.prototype.createBuffersFromGeometryData=function(){this.getChild(e.EBufferDataType.VERTICE),this.getChild(e.EBufferDataType.NORMAL),this.getChild(e.EBufferDataType.TANGENT),this.getChild(e.EBufferDataType.COLOR),this.getChild(e.EBufferDataType.INDICE),this.getChild(e.EBufferDataType.TEXCOORD)},BufferContainer.prototype.init=function(){var t=this;this._materialChangeSubscription=e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.MATERIAL_CHANGE).subscribe(function(){t.removeCache(e.EBufferDataType.COLOR),t.geometryData.colorDirty=!0}),this.geometryData.init()},BufferContainer.prototype.removeCache=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];this.container.removeChild(e[0])},BufferContainer.prototype.getChild=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=null;switch(n){case e.EBufferDataType.VERTICE:i=this.getVertice(n);break;case e.EBufferDataType.NORMAL:i=this.getNormal(n);break;case e.EBufferDataType.TANGENT:i=this._getTangent(n);break;case e.EBufferDataType.COLOR:i=this._getColor(n);break;case e.EBufferDataType.INDICE:i=this._getIndice(n);break;case e.EBufferDataType.TEXCOORD:i=this._getTexCoord(n);break;case e.EBufferDataType.CUSTOM:i=this.getCustomData(t[1]);break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("EBufferDataType: "+n))}return i},BufferContainer.prototype.dispose=function(){this.container.forEach(function(e){e.dispose()}),this.geometryData.dispose(),this._materialChangeSubscription&&this._materialChangeSubscription.dispose()},BufferContainer.prototype.getCustomData=function(e){return null},BufferContainer.prototype.createOnlyOnceAndUpdateArrayBuffer=function(t,r,n,i,a,o){void 0===i&&(i=e.EBufferType.FLOAT),void 0===a&&(a=0),void 0===o&&(o=e.EBufferUsage.STATIC_DRAW);var s=this[t];return s?void s.resetData(r,n,i,a):void(this[t]=e.ArrayBuffer.create(r,n,i,o))},BufferContainer.prototype.createOnlyOnceAndUpdateElememntBuffer=function(t,r,n,i,a){void 0===n&&(n=null),void 0===i&&(i=0),void 0===a&&(a=e.EBufferUsage.STATIC_DRAW);var o=this[t];return o?void o.resetData(r,n,i):void(this[t]=e.ElementBuffer.create(r,n,a))},BufferContainer.prototype.hasData=function(e){return e&&e.length>0},BufferContainer.prototype._getTangent=function(t){var r=null;return r=this.geometryData[e.BufferDataTable.getGeometryDataName(t)],this.hasData(r)?(this.createOnlyOnceAndUpdateArrayBuffer("_tangentBuffer",r,3),this._tangentBuffer):null},BufferContainer.prototype._getColor=function(t){var r=null;return r=this.geometryData[e.BufferDataTable.getGeometryDataName(t)],this.hasData(r)?(this.createOnlyOnceAndUpdateArrayBuffer("_colorBuffer",r,3),this._colorBuffer):null},BufferContainer.prototype._getIndice=function(t){var r=null;return r=this.geometryData[e.BufferDataTable.getGeometryDataName(t)],this.hasData(r)?(this.createOnlyOnceAndUpdateElememntBuffer("_indiceBuffer",r),this._indiceBuffer):null},BufferContainer.prototype._getTexCoord=function(t){var r=null;return r=this.geometryData[e.BufferDataTable.getGeometryDataName(t)],this.hasData(r)?(this.createOnlyOnceAndUpdateArrayBuffer("_texCoordBuffer",r,2),this._texCoordBuffer):null},BufferContainer.prototype._needReCalcuteTangent=function(t){return this.geometryData.tangentDirty&&t===e.EBufferDataType.TANGENT},__decorate([e.virtual],BufferContainer.prototype,"createBuffersFromGeometryData",null),__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.it("test arguments",function(){if(2===t.length){var r=t[1];e.expect(r).exist,e.expect(r).be.a("string")}})})],BufferContainer.prototype,"getChild",null),__decorate([e.virtual],BufferContainer.prototype,"getCustomData",null),__decorate([e.cache(function(e){return this.container.hasChild(e)&&!this._needReCalcuteTangent(e)},function(e){return this.container.getChild(e)},function(e,t){this.container.addChild(t,e)})],BufferContainer.prototype,"_getTangent",null),__decorate([e.cache(function(e){return this.container.hasChild(e)},function(e){return this.container.getChild(e)},function(e,t){this.container.addChild(t,e)})],BufferContainer.prototype,"_getColor",null),__decorate([e.cache(function(e){return this.container.hasChild(e)},function(e){return this.container.getChild(e)},function(e,t){this.container.addChild(t,e)})],BufferContainer.prototype,"_getIndice",null),__decorate([e.cache(function(e){return this.container.hasChild(e)},function(e){return this.container.getChild(e)},function(e,t){this.container.addChild(t,e)})],BufferContainer.prototype,"_getTexCoord",null),BufferContainer}();e.BufferContainer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonBufferContainer(){t.apply(this,arguments),this._verticeBuffer=null,this._normalBuffer=null}return __extends(CommonBufferContainer,t),CommonBufferContainer.prototype.getBufferForRenderSort=function(){var t=this.getChild(e.EBufferDataType.VERTICE);return t?t:null},CommonBufferContainer.prototype.getVertice=function(t){var r=this.geometryData[e.BufferDataTable.getGeometryDataName(t)];return this.hasData(r)?(this.createOnlyOnceAndUpdateArrayBuffer("_verticeBuffer",r,3),this._verticeBuffer):null},CommonBufferContainer.prototype.getNormal=function(t){var r=this.geometryData[e.BufferDataTable.getGeometryDataName(t)];return this.hasData(r)?(this.createOnlyOnceAndUpdateArrayBuffer("_normalBuffer",r,3),this._normalBuffer):null},__decorate([e.cacheBufferForBufferContainer()],CommonBufferContainer.prototype,"getVertice",null),__decorate([e.cacheBufferForBufferContainer()],CommonBufferContainer.prototype,"getNormal",null),CommonBufferContainer}(e.BufferContainer);e.CommonBufferContainer=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicBufferContainer(){e.apply(this,arguments)}return __extends(BasicBufferContainer,e),BasicBufferContainer.create=function(e){var t=new this(e);return t},BasicBufferContainer}(e.CommonBufferContainer);e.BasicBufferContainer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MorphBufferContainer(e,r){t.call(this,e),this._animation=null,this._isCacheChangeFlag={},this._isCacheChangeInLastLoop={},this._currentVerticeBuffer=null,this._nextVerticeBuffer=null,this._currentNormalBuffer=null,this._nextNormalBuffer=null,this._animation=r}return __extends(MorphBufferContainer,t),MorphBufferContainer.create=function(e,t){var r=new this(e,t);return r},MorphBufferContainer.prototype.getBufferForRenderSort=function(){return null},MorphBufferContainer.prototype.getVertice=function(e){return this._getMorphData(e,this.geometryData.morphTargets)},MorphBufferContainer.prototype.getNormal=function(e){return this._getMorphData(e,this.geometryData.morphNormals)},MorphBufferContainer.prototype._getMorphData=function(e,t){var r=null,n=null,i=null;if(this._isNotPlayAnimation())return this._getStaticData(e);if(0===t.getCount())return null;if(n=this._getFrames(t),r=this.container.getChild(e))if(this._animation.isFrameChange&&(this._isCacheChangeInLastLoop[e]||this._isCacheNotChange(e))){var a=r[0],o=r[1],s=null,c=null;s=o,c=a.resetData(n.getChild(this._animation.nextFrame)),i=[s,c],this.container.addChild(e,i),this._isCacheChangeFlag[e]=!0,this._isCacheChangeInLastLoop[e]=!0}else this._isCacheChangeFlag[e]=!1,this._isCacheChangeInLastLoop[e]=!1,i=r;else{var a=this._getCurrentBufferWhichIsCreatedOnlyOnce(e,n.getChild(this._animation.currentFrame),3),o=this._getNextBufferWhichIsCreatedOnlyOnce(e,n.getChild(this._animation.nextFrame),3);i=[a,o],this.container.addChild(e,i),this._isCacheChangeInLastLoop[e]=!1}return i},MorphBufferContainer.prototype._getFrames=function(e){return e.getChild(this._animation.currentAnimName)},MorphBufferContainer.prototype._getCurrentBufferWhichIsCreatedOnlyOnce=function(t,r,n){return t===e.EBufferDataType.VERTICE?(this.createOnlyOnceAndUpdateArrayBuffer("_currentVerticeBuffer",r,n,e.EBufferType.FLOAT,0,e.EBufferUsage.DYNAMIC_DRAW),this._currentVerticeBuffer):(this.createOnlyOnceAndUpdateArrayBuffer("_currentNormalBuffer",r,n,e.EBufferType.FLOAT,0,e.EBufferUsage.DYNAMIC_DRAW),this._currentNormalBuffer)},MorphBufferContainer.prototype._getNextBufferWhichIsCreatedOnlyOnce=function(t,r,n){return t===e.EBufferDataType.VERTICE?(this.createOnlyOnceAndUpdateArrayBuffer("_nextVerticeBuffer",r,n,e.EBufferType.FLOAT,0,e.EBufferUsage.DYNAMIC_DRAW),this._nextVerticeBuffer):(this.createOnlyOnceAndUpdateArrayBuffer("_nextNormalBuffer",r,n,e.EBufferType.FLOAT,0,e.EBufferUsage.DYNAMIC_DRAW),this._nextNormalBuffer)},MorphBufferContainer.prototype._isCacheNotChange=function(e){return!this._isCacheChangeFlag[e]},MorphBufferContainer.prototype._isNotPlayAnimation=function(){return null===this._animation.currentAnimName},MorphBufferContainer.prototype._getStaticData=function(t){var r=null,n=null;switch(t){case e.EBufferDataType.VERTICE:r=this.geometryData.vertices;break;case e.EBufferDataType.NORMAL:r=this.geometryData.normals;break;default:e.Log.error(!0,e.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))}return this.hasData(r)?(this._animation.interpolation=0,n=[this._getCurrentBufferWhichIsCreatedOnlyOnce(t,r,3),this._getNextBufferWhichIsCreatedOnlyOnce(t,r,3)]):null},MorphBufferContainer.prototype._getStaticDataCacheData=function(e){return"static_"+e},__decorate([e.require(function(t){e.assert(this.geometryData.morphTargets&&this.geometryData.morphTargets.getCount()>0,e.Log.info.FUNC_SHOULD("set morphTargets"))})],MorphBufferContainer.prototype,"getVertice",null),__decorate([e.require(function(t){e.assert(this.geometryData.morphTargets&&this.geometryData.morphTargets.getCount()>0,e.Log.info.FUNC_SHOULD("set morphTargets"))})],MorphBufferContainer.prototype,"getNormal",null),__decorate([e.ensure(function(e){wdCb.Log.error(!e,wdCb.Log.info.FUNC_SHOULD('"'+this._animation.currentAnimName+'" animation',"contain frame data"))})],MorphBufferContainer.prototype,"_getFrames",null),__decorate([e.require(function(t,r,n){e.assert(t===e.EBufferDataType.VERTICE||t===e.EBufferDataType.NORMAL,e.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))})],MorphBufferContainer.prototype,"_getCurrentBufferWhichIsCreatedOnlyOnce",null),__decorate([e.require(function(t,r,n){e.assert(t===e.EBufferDataType.VERTICE||t===e.EBufferDataType.NORMAL,e.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))})],MorphBufferContainer.prototype,"_getNextBufferWhichIsCreatedOnlyOnce",null),__decorate([e.cacheBufferForBufferContainerWithFuncParam("_getStaticDataCacheData")],MorphBufferContainer.prototype,"_getStaticData",null),MorphBufferContainer}(e.BufferContainer);e.MorphBufferContainer=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Camera(){this._worldToCameraMatrix=null,this._near=null,this._far=null,this.pMatrix=e.Matrix4.create(),this.entityObject=null,this.dirty=!1}return Object.defineProperty(Camera.prototype,"cameraToWorldMatrix",{get:function(){return this.entityObject.transform.localToWorldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(Camera.prototype,"worldToCameraMatrix",{get:function(){return this._worldToCameraMatrix?this._worldToCameraMatrix:this.cameraToWorldMatrix.clone().invert()},set:function(e){this._worldToCameraMatrix=e},enumerable:!0,configurable:!0}),Object.defineProperty(Camera.prototype,"near",{get:function(){return this._near},set:function(e){this._near=e,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(Camera.prototype,"far",{get:function(){return this._far},set:function(e){this._far=e,this.dirty=!0},enumerable:!0,configurable:!0}),Camera.prototype.init=function(){this.dirty&&(this.updateProjectionMatrix(),this.dirty=!1)},Camera.prototype.dispose=function(){},Camera.prototype.clone=function(){return e.CloneUtils.clone(this)},Camera.prototype.update=function(e){this.dirty&&(this.updateProjectionMatrix(),this.dirty=!1)},Camera.prototype.getInvViewProjMat=function(){return this.pMatrix.clone().multiply(this.worldToCameraMatrix).invert()},__decorate([e.requireGetter(function(){e.assert(this.entityObject,e.Log.info.FUNC_MUST_DEFINE("entityObject"))})],Camera.prototype,"cameraToWorldMatrix",null),__decorate([e.cloneAttributeAsBasicType()],Camera.prototype,"near",null),__decorate([e.cloneAttributeAsBasicType()],Camera.prototype,"far",null),__decorate([e.cloneAttributeAsCloneable()],Camera.prototype,"pMatrix",void 0),__decorate([e.virtual],Camera.prototype,"init",null),__decorate([e.virtual],Camera.prototype,"dispose",null),Camera}();e.Camera=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OrthographicCamera(){t.apply(this,arguments),this._left=null,this._right=null,this._bottom=null,this._top=null}return __extends(OrthographicCamera,t),OrthographicCamera.create=function(){var e=new this;return e},Object.defineProperty(OrthographicCamera.prototype,"left",{get:function(){return this._left},set:function(e){this._left=e,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(OrthographicCamera.prototype,"right",{get:function(){return this._right},set:function(e){this._right=e,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(OrthographicCamera.prototype,"bottom",{get:function(){return this._bottom},set:function(e){this._bottom=e,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(OrthographicCamera.prototype,"top",{get:function(){return this._top},set:function(e){this._top=e,this.dirty=!0},enumerable:!0,configurable:!0}),OrthographicCamera.prototype.convertScreenToWorld=function(t,r,n){var i=e.DeviceManager.getInstance(),a=i.view.width,o=i.view.height,s=e.Vector3.create(2*t/a-1,(o-r)/o*2-1,(n-this.far)/(this.far-this.near)*2+1);return this.getInvViewProjMat().multiplyPoint(s)},OrthographicCamera.prototype.updateProjectionMatrix=function(){this.pMatrix.setOrtho(this._left,this._right,this._bottom,this._top,this.near,this.far)},__decorate([e.cloneAttributeAsBasicType()],OrthographicCamera.prototype,"left",null),__decorate([e.cloneAttributeAsBasicType()],OrthographicCamera.prototype,"right",null),__decorate([e.cloneAttributeAsBasicType()],OrthographicCamera.prototype,"bottom",null),__decorate([e.cloneAttributeAsBasicType()],OrthographicCamera.prototype,"top",null),OrthographicCamera}(e.Camera);e.OrthographicCamera=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function PerspectiveCamera(){t.apply(this,arguments),this._fovy=null,this._aspect=null}return __extends(PerspectiveCamera,t),PerspectiveCamera.create=function(){var e=new this;return e},Object.defineProperty(PerspectiveCamera.prototype,"fovy",{get:function(){return this._fovy},set:function(e){this._fovy=e,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(PerspectiveCamera.prototype,"aspect",{get:function(){return this._aspect},set:function(e){this._aspect=e,this.dirty=!0},enumerable:!0,configurable:!0}),PerspectiveCamera.prototype.zoomIn=function(e,t){void 0===t&&(t=1),this.fovy=Math.max(this.fovy-e,t)},PerspectiveCamera.prototype.zoomOut=function(e,t){void 0===t&&(t=179),this.fovy=Math.min(this.fovy+e,t)},PerspectiveCamera.prototype.convertScreenToWorld=function(t,r,n){var i=e.DeviceManager.getInstance(),a=i.view.width,o=i.view.height,s=e.Vector3.create(2*t/a-1,1-2*r/o,1),c=this.getInvViewProjMat(),u=null,l=null;return u=c.multiplyPoint(s),l=s.x*c.values[3]+s.y*c.values[7]+s.z*c.values[11]+c.values[15],u.scale(1/l),e.Vector3.create().lerp(this.entityObject.transform.position,u,n/this.far)},PerspectiveCamera.prototype.updateProjectionMatrix=function(){this.pMatrix.setPerspective(this._fovy,this._aspect,this.near,this.far)},__decorate([e.cloneAttributeAsBasicType()],PerspectiveCamera.prototype,"fovy",null),__decorate([e.cloneAttributeAsBasicType()],PerspectiveCamera.prototype,"aspect",null),PerspectiveCamera}(e.Camera);e.PerspectiveCamera=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CameraController(e){t.call(this),this.camera=null,this._worldToCameraMatrixCache=null,this._clearCacheSubscription=null,this.camera=e}return __extends(CameraController,t),Object.defineProperty(CameraController.prototype,"cameraToWorldMatrix",{get:function(){return this.camera.cameraToWorldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(CameraController.prototype,"worldToCameraMatrix",{get:function(){return this._getWorldToCameraMatrix()},set:function(e){this.camera.worldToCameraMatrix=e},enumerable:!0,configurable:!0}),Object.defineProperty(CameraController.prototype,"pMatrix",{get:function(){return this.camera.pMatrix},set:function(e){this.camera.pMatrix=e},enumerable:!0,configurable:!0}),CameraController.prototype.init=function(){this.camera.entityObject=this.entityObject,this.camera.init(),this.bindClearCacheEvent()},CameraController.prototype.update=function(e){this.camera.update(e)},CameraController.prototype.dispose=function(){this.camera.dispose(),this.disposeClearCacheEvent()},CameraController.prototype.clone=function(){return e.CloneUtils.clone(this)},CameraController.prototype.isIntersectWithRay=function(t,r,n){var i=null;return!!t.hasComponent(e.Collider)&&(i=t.getComponent(e.Collider).shape,i.isIntersectWithRay(this.createRay(r,n)))},CameraController.prototype.createRay=function(t,r){var n=this.convertScreenToWorld(t,r,this.camera.near),i=this.convertScreenToWorld(t,r,this.camera.far);return e.Ray.create(n,i.sub(n))},CameraController.prototype.convertScreenToWorld=function(e,t,r){return this.camera.convertScreenToWorld(e,t,r)},CameraController.prototype.getPlanes=function(){for(var t=[],r=this.worldToCameraMatrix.applyMatrix(this.pMatrix,!0),n=0;n<6;n++)t.push(e.Plane.create(0,0,0,0));return this._setPlanes(r,t),t},CameraController.prototype.bindClearCacheEvent=function(){var t=this;this._clearCacheSubscription=wdFrp.fromArray([e.EventManager.fromEvent(e.EEngineEvent.ENDLOOP),e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.TRANSFORM_TRANSLATE),e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.TRANSFORM_ROTATE),e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.TRANSFORM_SCALE)]).mergeAll().subscribe(function(){t._clearCache()})},CameraController.prototype.disposeClearCacheEvent=function(){this._clearCacheSubscription&&this._clearCacheSubscription.dispose()},CameraController.prototype._setPlanes=function(e,t){t[0].normal.x=e.values[3]+e.values[2],t[0].normal.y=e.values[7]+e.values[6],t[0].normal.z=e.values[11]+e.values[10],t[0].d=e.values[15]+e.values[14],t[0].normalize(),t[1].normal.x=e.values[3]-e.values[2],t[1].normal.y=e.values[7]-e.values[6],t[1].normal.z=e.values[11]-e.values[10],t[1].d=e.values[15]-e.values[14],t[1].normalize(),t[2].normal.x=e.values[3]+e.values[0],t[2].normal.y=e.values[7]+e.values[4],t[2].normal.z=e.values[11]+e.values[8],t[2].d=e.values[15]+e.values[12],t[2].normalize(),t[3].normal.x=e.values[3]-e.values[0],t[3].normal.y=e.values[7]-e.values[4],t[3].normal.z=e.values[11]-e.values[8],t[3].d=e.values[15]-e.values[12],t[3].normalize(),t[4].normal.x=e.values[3]-e.values[1],t[4].normal.y=e.values[7]-e.values[5],t[4].normal.z=e.values[11]-e.values[9],t[4].d=e.values[15]-e.values[13],t[4].normalize(),t[5].normal.x=e.values[3]+e.values[1],t[5].normal.y=e.values[7]+e.values[5],t[5].normal.z=e.values[11]+e.values[9],t[5].d=e.values[15]+e.values[13],t[5].normalize()},CameraController.prototype._clearCache=function(){this._worldToCameraMatrixCache=null},CameraController.prototype._getWorldToCameraMatrix=function(){return this.camera.worldToCameraMatrix},__decorate([e.cacheGetter(function(){return null!==this._worldToCameraMatrixCache},function(){return this._worldToCameraMatrixCache},function(e){this._worldToCameraMatrixCache=e})],CameraController.prototype,"worldToCameraMatrix",null),__decorate([e.cloneAttributeAsCloneable()],CameraController.prototype,"camera",void 0),__decorate([e.virtual],CameraController.prototype,"bindClearCacheEvent",null),__decorate([e.virtual],CameraController.prototype,"disposeClearCacheEvent",null),CameraController}(e.Component);e.CameraController=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function RenderTargetRendererCameraController(){e.apply(this,arguments)}return __extends(RenderTargetRendererCameraController,e),
RenderTargetRendererCameraController.create=function(e){var t=new this(e);return t},RenderTargetRendererCameraController.prototype.bindClearCacheEvent=function(){},RenderTargetRendererCameraController.prototype.disposeClearCacheEvent=function(){},RenderTargetRendererCameraController}(e.CameraController);e.RenderTargetRendererCameraController=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicCameraController(){e.apply(this,arguments)}return __extends(BasicCameraController,e),BasicCameraController.create=function(e){var t=new this(e);return t},BasicCameraController}(e.CameraController);e.BasicCameraController=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function FlyCameraController(r){t.call(this,r),this._control=null,r instanceof e.PerspectiveCamera?this._control=e.FlyPerspectiveCameraControl.create(r):this._control=e.FlyOrthographicCameraControl.create(r)}return __extends(FlyCameraController,t),FlyCameraController.create=function(e){var t=new this(e);return t},Object.defineProperty(FlyCameraController.prototype,"moveSpeed",{get:function(){return this._control.moveSpeed},set:function(e){this._control.moveSpeed=e},enumerable:!0,configurable:!0}),Object.defineProperty(FlyCameraController.prototype,"rotateSpeed",{get:function(){return this._control.rotateSpeed},set:function(e){this._control.rotateSpeed=e},enumerable:!0,configurable:!0}),Object.defineProperty(FlyCameraController.prototype,"zoomSpeed",{get:function(){return this._control.zoomSpeed},set:function(e){this._control.zoomSpeed=e},enumerable:!0,configurable:!0}),FlyCameraController.prototype.init=function(){t.prototype.init.call(this),this._control.init(this.entityObject)},FlyCameraController.prototype.update=function(e){t.prototype.update.call(this,e),this._control.update(e)},FlyCameraController.prototype.dispose=function(){t.prototype.dispose.call(this),this._control.dispose()},__decorate([e.cloneAttributeAsBasicType()],FlyCameraController.prototype,"moveSpeed",null),__decorate([e.cloneAttributeAsBasicType()],FlyCameraController.prototype,"rotateSpeed",null),__decorate([e.requireGetterAndSetter(function(){e.assert(this._control instanceof e.FlyPerspectiveCameraControl,e.Log.info.FUNC_MUST_BE("FlyPerspectiveCameraControl"))},function(){e.assert(this._control instanceof e.FlyPerspectiveCameraControl,e.Log.info.FUNC_MUST_BE("FlyPerspectiveCameraControl"))}),e.cloneAttributeAsBasicType()],FlyCameraController.prototype,"zoomSpeed",null),FlyCameraController}(e.CameraController);e.FlyCameraController=t}(wd||(wd={}));var wd;!function(e){var t=function(){function FlyCameraControl(e){this.moveSpeed=1.2,this.rotateSpeed=100,this.cameraComponent=null,this._rotateX=0,this._rotateY=0,this._isRotate=!1,this._mouseDragSubscription=null,this._keydownSubscription=null,this._gameObject=null,this.cameraComponent=e}return FlyCameraControl.prototype.init=function(e){var t=e.transform.eulerAngles;this._rotateX=t.x,this._rotateY=t.y,this._gameObject=e,this._bindCanvasEvent()},FlyCameraControl.prototype.update=function(t){this._isRotate&&(this._isRotate=!1,this._gameObject.transform.eulerAngles=e.Vector3.create(this._rotateX,this._rotateY,0))},FlyCameraControl.prototype.dispose=function(){this._removeEvent()},FlyCameraControl.prototype._move=function(t){var r=this.moveSpeed,n=this._gameObject,i=t.keyState;i.a||i.left?n.transform.translateLocal(e.Vector3.create(-r,0,0)):i.d||i.right?n.transform.translateLocal(e.Vector3.create(r,0,0)):i.w||i.up?n.transform.translateLocal(e.Vector3.create(0,0,-r)):(i.s||i.down)&&n.transform.translateLocal(e.Vector3.create(0,0,r))},FlyCameraControl.prototype._bindCanvasEvent=function(){var t=this,r=this.rotateSpeed,n=e.EventManager.fromEvent(e.Director.getInstance().scene,e.EEngineEvent.MOUSE_DRAG),i=e.EventManager.fromEvent(e.EEventName.KEYDOWN),a=e.Director.getInstance().view;this._mouseDragSubscription=n.map(function(e){var n=e.userData.movementDelta,i=null,o=null,s=r/a.height;return i=s*n.x,o=s*n.y,t._isRotate=!0,{dx:i,dy:o}}).subscribe(function(e){t._rotateY-=e.dx,t._rotateX-=e.dy}),this._keydownSubscription=i.subscribe(function(e){t._move(e),t.zoom(e)})},FlyCameraControl.prototype._removeEvent=function(){this._mouseDragSubscription.dispose(),this._keydownSubscription.dispose()},FlyCameraControl}();e.FlyCameraControl=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function FlyPerspectiveCameraControl(){e.apply(this,arguments),this.zoomSpeed=10}return __extends(FlyPerspectiveCameraControl,e),FlyPerspectiveCameraControl.create=function(e){var t=new this(e);return t},FlyPerspectiveCameraControl.prototype.zoom=function(e){var t=this.zoomSpeed,r=e.keyState;r.g?this.cameraComponent.zoomIn(t):r.h&&this.cameraComponent.zoomOut(t)},FlyPerspectiveCameraControl}(e.FlyCameraControl);e.FlyPerspectiveCameraControl=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function FlyOrthographicCameraControl(){e.apply(this,arguments)}return __extends(FlyOrthographicCameraControl,e),FlyOrthographicCameraControl.create=function(e){var t=new this(e);return t},FlyOrthographicCameraControl.prototype.zoom=function(e){},FlyOrthographicCameraControl}(e.FlyCameraControl);e.FlyOrthographicCameraControl=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ArcballCameraController(){t.apply(this,arguments),this._distance=10,this._minDistance=.05,this._phi=Math.PI/2,this._theta=Math.PI/2,this._thetaMargin=.05,this._target=e.Vector3.create(0,0,0),this.moveSpeedX=1,this.moveSpeedY=1,this.rotateSpeed=1,this.wheelSpeed=1,this._isChange=!0,this._mouseDragSubscription=null,this._mouseWheelSubscription=null,this._keydownSubscription=null}return __extends(ArcballCameraController,t),ArcballCameraController.create=function(e){var t=new this(e);return t},Object.defineProperty(ArcballCameraController.prototype,"distance",{get:function(){return this._distance},set:function(e){this._distance!==e&&this._changeDistance(e)},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"minDistance",{get:function(){return this._minDistance},set:function(e){this._minDistance=e,e>this._distance&&this._changeDistance(e)},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"phi",{get:function(){return this._phi},set:function(e){this._phi!==e&&this._changePhi(e)},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"theta",{get:function(){return this._theta},set:function(e){this._theta!==e&&this._changeTheta(e)},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"thetaMargin",{get:function(){return this._thetaMargin},set:function(e){this._thetaMargin!==e&&(this._thetaMargin=e,this._constrainTheta())},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"target",{get:function(){return this._target},set:function(e){this._target.isEqual(e)||this._changeTarget(e)},enumerable:!0,configurable:!0}),ArcballCameraController.prototype.init=function(){t.prototype.init.call(this),this._bindCanvasEvent()},ArcballCameraController.prototype.update=function(r){var n=null,i=null,a=null;t.prototype.update.call(this,r),this._isChange&&(this._isChange=!1,n=this.distance*Math.cos(this.phi)*Math.sin(this.theta)+this.target.x,a=this.distance*Math.sin(this.phi)*Math.sin(this.theta)+this.target.z,i=this.distance*Math.cos(this.theta)+this.target.y,this.entityObject.transform.position=e.Vector3.create(n,i,a),this.entityObject.transform.lookAt(this.target))},ArcballCameraController.prototype.dispose=function(){t.prototype.dispose.call(this),this._removeEvent()},ArcballCameraController.prototype._bindCanvasEvent=function(){var t=this,r=e.Director.getInstance().scene,n=e.EventManager.fromEvent(r,e.EEngineEvent.MOUSE_WHEEL),i=e.EventManager.fromEvent(r,e.EEngineEvent.MOUSE_DRAG),a=e.EventManager.fromEvent(e.EEventName.KEYDOWN);this._mouseDragSubscription=i.subscribe(function(e){t._changeOrbit(e.userData)}),this._mouseWheelSubscription=n.subscribe(function(e){var r=e.userData;r.preventDefault(),t._changeDistance(r)}),this._keydownSubscription=a.subscribe(function(e){t._changeTarget(e)})},ArcballCameraController.prototype._changeOrbit=function(e){var t=e.movementDelta;this._isChange=!0,this._changePhi(this._phi+t.x/(100/this.rotateSpeed)),this._changeTheta(this._theta-t.y/(100/this.rotateSpeed))},ArcballCameraController.prototype._changePhi=function(e){this._isChange=!0,this._phi=e},ArcballCameraController.prototype._changeTheta=function(e){this._isChange=!0,this._theta=e,this._constrainTheta()},ArcballCameraController.prototype._changeTarget=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(this._isChange=!0,t[0]instanceof e.Vector3)this._target=t[0];else{var n=t[0],i=this.moveSpeedX,a=this.moveSpeedY,o=null,s=null,c=n.keyState,u=this.entityObject.transform;c.a||c.left?o=-i:c.d||c.right?o=i:c.w||c.up?s=a:(c.s||c.down)&&(s=-a),this._target.add(e.Vector3.create(u.right.x*o,0,u.right.z*o)),this._target.add(e.Vector3.create(u.up.x*s,u.up.y*s,0))}},ArcballCameraController.prototype._changeDistance=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(this._isChange=!0,e.JudgeUtils.isNumber(t[0]))this._distance=t[0];else{var n=t[0];this._distance-=this.wheelSpeed*n.wheel}this._constrainDistance()},ArcballCameraController.prototype._constrainDistance=function(){this.distance=e.MathUtils.bigThan(this.distance,this.minDistance)},ArcballCameraController.prototype._constrainTheta=function(){this._theta=e.MathUtils.clamp(this._theta,this._thetaMargin,Math.PI-this._thetaMargin)},ArcballCameraController.prototype._removeEvent=function(){this._mouseDragSubscription.dispose(),this._mouseWheelSubscription.dispose(),this._keydownSubscription.dispose()},__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"distance",null),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"minDistance",null),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"phi",null),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"theta",null),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"thetaMargin",null),__decorate([e.cloneAttributeAsCloneable()],ArcballCameraController.prototype,"target",null),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"moveSpeedX",void 0),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"moveSpeedY",void 0),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"rotateSpeed",void 0),__decorate([e.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"wheelSpeed",void 0),__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.expect(t[0]instanceof e.KeyboardEvent||t[0]instanceof e.Vector3).true})],ArcballCameraController.prototype,"_changeTarget",null),__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.expect(e.JudgeUtils.isNumber(t[0])||t[0]instanceof e.MouseEvent).true})],ArcballCameraController.prototype,"_changeDistance",null),ArcballCameraController}(e.CameraController);e.ArcballCameraController=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Action(){t.apply(this,arguments),this.p_target=null,this.isFinish=!1}return __extends(Action,t),Object.defineProperty(Action.prototype,"isStop",{get:function(){},enumerable:!0,configurable:!0}),Object.defineProperty(Action.prototype,"isPause",{get:function(){},enumerable:!0,configurable:!0}),Object.defineProperty(Action.prototype,"isStart",{get:function(){return!this.isStop},enumerable:!0,configurable:!0}),Object.defineProperty(Action.prototype,"target",{get:function(){return this.p_target},set:function(e){this.p_target=e},enumerable:!0,configurable:!0}),Action.prototype.clone=function(){return e.CloneUtils.clone(this)},Action.prototype.reset=function(){this.isFinish=!1},Action.prototype.addToObject=function(r,n){void 0===n&&(n=!1);var i=e.ActionEngine.getInstance();t.prototype.addToObject.call(this,r,n),this.target=r,i.hasChild(this)||i.addChild(this)},Action.prototype.removeFromObject=function(r){t.prototype.removeFromObject.call(this,r),e.ActionEngine.getInstance().removeChild(this)},Action.prototype.init=function(){this.start()},Action.prototype.finish=function(){this.isFinish=!0,this.stop()},Action}(e.Component);e.Action=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ActionInstant(){e.apply(this,arguments)}return __extends(ActionInstant,e),Object.defineProperty(ActionInstant.prototype,"isStop",{get:function(){return!1},enumerable:!0,configurable:!0}),Object.defineProperty(ActionInstant.prototype,"isPause",{get:function(){return!1},enumerable:!0,configurable:!0}),ActionInstant.prototype.start=function(){},ActionInstant.prototype.stop=function(){},ActionInstant.prototype.pause=function(){},ActionInstant.prototype.resume=function(){},ActionInstant}(e.Action);e.ActionInstant=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CallFunc(r,n,i){t.call(this),this._context=null,this._callFunc=null,this._dataArr=null,this._context=n||e.root,this._callFunc=r,this._dataArr=wdCb.Collection.create(i)}return __extends(CallFunc,t),CallFunc.create=function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var i=Array.prototype.slice.call(arguments,2),a=new this(e,t,i);return a},CallFunc.prototype.clone=function(){return e.CloneUtils.clone(this,null,[this._callFunc,this._context,this._dataArr.clone(!0).toArray()])},CallFunc.prototype.reverse=function(){return this},CallFunc.prototype.update=function(e){this._callFunc&&this._callFunc.call(this._context,this.p_target,this._dataArr),this.finish()},CallFunc}(e.ActionInstant);e.CallFunc=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ActionInterval(){t.apply(this,arguments),this.elapsed=null,this.duration=null,this._isStop=!0,this._isPause=!1,this._timeController=e.CommonTimeController.create()}return __extends(ActionInterval,t),Object.defineProperty(ActionInterval.prototype,"isStop",{get:function(){return this._isStop},enumerable:!0,configurable:!0}),Object.defineProperty(ActionInterval.prototype,"isPause",{get:function(){return this._isPause},enumerable:!0,configurable:!0}),ActionInterval.prototype.update=function(e){e<this._timeController.startTime||(this.elapsed=this._convertToRatio(this._timeController.computeElapseTime(e)),this.updateBody(e),1===this.elapsed&&this.finish())},ActionInterval.prototype.start=function(){this._isStop=!1,this._timeController.start()},ActionInterval.prototype.stop=function(){this._isStop=!0,this._timeController.stop()},ActionInterval.prototype.reset=function(){t.prototype.reset.call(this),this._isStop=!0},ActionInterval.prototype.pause=function(){this._isPause=!0,this._timeController.pause()},ActionInterval.prototype.resume=function(){this._isPause=!1,this._timeController.resume()},ActionInterval.prototype.updateBody=function(e){},ActionInterval.prototype._convertToRatio=function(e){var t=e/this.duration;return t>1?1:t},__decorate([e.virtual],ActionInterval.prototype,"updateBody",null),ActionInterval}(e.Action);e.ActionInterval=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function Control(){e.apply(this,arguments)}return __extends(Control,e),Object.defineProperty(Control.prototype,"target",{set:function(e){this.p_target=e,this.getInnerActions().forEach(function(t){t.target=e})},enumerable:!0,configurable:!0}),Control.prototype.init=function(){e.prototype.init.call(this),this.iterate("init")},Control.prototype.reverse=function(){return this.iterate("reverse"),this},Control.prototype.reset=function(){return e.prototype.reset.call(this),this.iterate("reset"),this},Control.prototype.iterate=function(e,t){this.getInnerActions().forEach(function(r){r[e].apply(r,t)})},Control}(e.ActionInterval);e.Control=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Sequence(e){t.call(this),this._actions=wdCb.Collection.create(),this._currentAction=null,this._actionIndex=0,this._actions.addChildren(e)}return __extends(Sequence,t),Sequence.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=new this(e);return r.initWhenCreate(),r},Sequence.prototype.initWhenCreate=function(){this._currentAction=this._actions.getChild(0)},Sequence.prototype.clone=function(){return e.CloneUtils.clone(this,null,this._actions.clone(!0).toArray())},Sequence.prototype.update=function(e){return this._actionIndex===this._actions.getCount()?void this.finish():(this._currentAction=this._actions.getChild(this._actionIndex),this._currentAction.isFinish?void this._startNextActionAndJudgeFinish():(this._currentAction.update(e),this._currentAction.isFinish&&this._startNextActionAndJudgeFinish(),null))},Sequence.prototype.reset=function(){return t.prototype.reset.call(this),this._actionIndex=0,this._currentAction=this._actions.getChild(this._actionIndex),this},Sequence.prototype.start=function(){return t.prototype.start.call(this),this._currentAction.start(),this},Sequence.prototype.stop=function(){return t.prototype.stop.call(this),this._currentAction.stop(),this},Sequence.prototype.pause=function(){return t.prototype.pause.call(this),this._currentAction.pause(),this},Sequence.prototype.resume=function(){return t.prototype.resume.call(this),this._currentAction.resume(),this},Sequence.prototype.reverse=function(){return this._actions=this._actions.reverse(),t.prototype.reverse.call(this),this},Sequence.prototype.getInnerActions=function(){return this._actions},Sequence.prototype._startNextActionAndJudgeFinish=function(){return this._actionIndex++,this._actionIndex===this._actions.getCount()?void this.finish():void this._actions.getChild(this._actionIndex).start()},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.it("action's count should > 1",function(){e.expect(t.length).to.greaterThan(1)})})],Sequence,"create",null),Sequence}(e.Control);e.Sequence=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Spawn(e){t.call(this),this._actions=wdCb.Collection.create(),this._actions.addChildren(e)}return __extends(Spawn,t),Spawn.create=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null;return r=new this(e)},Spawn.prototype.clone=function(){return e.CloneUtils.clone(this,null,this._actions.clone(!0).toArray())},Spawn.prototype.update=function(e){return this._isFinish()?void this.finish():(this.iterate("update",[e]),void(this._isFinish()&&this.finish()))},Spawn.prototype.start=function(){return t.prototype.start.call(this),this.iterate("start"),this},Spawn.prototype.stop=function(){return t.prototype.stop.call(this),this.iterate("stop"),this},Spawn.prototype.pause=function(){return t.prototype.pause.call(this),this.iterate("pause"),this},Spawn.prototype.resume=function(){return t.prototype.resume.call(this),this.iterate("resume"),this},Spawn.prototype.reset=function(){return t.prototype.reset.call(this),this.iterate("reset"),this},Spawn.prototype.reverse=function(){return this._actions=this._actions.reverse(),t.prototype.reverse.call(this),this},Spawn.prototype.getInnerActions=function(){return this._actions},Spawn.prototype.iterate=function(e,t){this._actions.forEach(function(r){r[e].apply(r,t)})},Spawn.prototype._isFinish=function(){var e=!0;return this._actions.forEach(function(t){if(!t.isFinish)return e=!1,wdCb.$BREAK}),e},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.it("action's count should > 1",function(){e.expect(t.length).to.greaterThan(1)})})],Spawn,"create",null),Spawn}(e.Control);e.Spawn=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DelayTime(e){t.call(this),this.duration=e}return __extends(DelayTime,t),DelayTime.create=function(e){var t=new this(e);return t},DelayTime.prototype.clone=function(){return e.CloneUtils.clone(this,null,[this.duration])},DelayTime.prototype.reverse=function(){return this},DelayTime}(e.ActionInterval);e.DelayTime=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Repeat(e,r){t.call(this),this._innerAction=null,this._originTimes=null,this._times=null,this._innerAction=e,this._times=r}return __extends(Repeat,t),Repeat.create=function(e,t){var r=new this(e,t);return r.initWhenCreate(),r},Repeat.prototype.clone=function(){return e.CloneUtils.clone(this,null,[this._innerAction.clone(),this._times])},Repeat.prototype.initWhenCreate=function(){this._originTimes=this._times},Repeat.prototype.update=function(e){if(0===this._times)return void this.finish();if(this._innerAction.update(e),this._innerAction.isFinish){if(this._times-=1,0!==this._times)return this._innerAction.reset(),void this._innerAction.start();this.finish()}},Repeat.prototype.reset=function(){return t.prototype.reset.call(this),this._times=this._originTimes,this},Repeat.prototype.start=function(){t.prototype.start.call(this),this._innerAction.start()},Repeat.prototype.stop=function(){t.prototype.stop.call(this),this._innerAction.stop()},Repeat.prototype.pause=function(){t.prototype.pause.call(this),this._innerAction.pause()},Repeat.prototype.resume=function(){t.prototype.resume.call(this),this._innerAction.resume()},Repeat.prototype.getInnerActions=function(){return wdCb.Collection.create([this._innerAction])},Repeat}(e.Control);e.Repeat=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RepeatForever(e){t.call(this),this._innerAction=null,this._innerAction=e}return __extends(RepeatForever,t),RepeatForever.create=function(e){var t=new this(e);return t},RepeatForever.prototype.clone=function(){return e.CloneUtils.clone(this,null,[this._innerAction.clone()])},RepeatForever.prototype.update=function(e){this._innerAction.update(e),this._innerAction.isFinish&&(this._innerAction.reset(),this._innerAction.start())},RepeatForever.prototype.start=function(){t.prototype.start.call(this),this._innerAction.start()},RepeatForever.prototype.stop=function(){t.prototype.stop.call(this),this._innerAction.stop()},RepeatForever.prototype.pause=function(){t.prototype.pause.call(this),this._innerAction.pause()},RepeatForever.prototype.resume=function(){t.prototype.resume.call(this),this._innerAction.resume()},RepeatForever.prototype.getInnerActions=function(){return wdCb.Collection.create([this._innerAction])},RepeatForever}(e.Control);e.RepeatForever=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Tween(){t.apply(this,arguments),this._object=null,this._valuesStart=wdCb.Hash.create(),this._valuesEnd=wdCb.Hash.create(),this._easingFunction=Tween.Easing.Linear.None,this._interpolationFunction=Tween.Interpolation.Linear,this._onStartCallback=null,this._onStartCallbackFired=!1,this._onUpdateCallback=null,this._onFinishCallback=null,this._onStopCallback=null}return __extends(Tween,t),Tween.create=function(){var e=new this;return e},Tween.prototype.updateBody=function(t){var r=this,n=null;return this._onStartCallbackFired===!1&&(null!==this._onStartCallback&&this._onStartCallback.call(this._object.getChildren()),this._onStartCallbackFired=!0),n=this._easingFunction(this.elapsed),this._valuesEnd.forEach(function(t,i){var a=r._valuesStart.getChild(i),o=t;o instanceof Array?r._object.setValue(i,r._interpolationFunction(o,n)):(e.JudgeUtils.isString(o)&&(o=a+e.root.parseFloat(o,10)),e.JudgeUtils.isNumber(o)&&r._object.setValue(i,a+(o-a)*n))}),null!==this._onUpdateCallback&&this._onUpdateCallback.call(this._object.getChildren(),n),!0},Tween.prototype.from=function(t){var r=this;return this._object=wdCb.Hash.create(t),this._object.forEach(function(t,n){r._valuesStart.addChild(n,e.root.parseFloat(t,10))}),this},Tween.prototype.to=function(e,t){return void 0===t&&(t=1e3),this.duration=t,this._valuesEnd=wdCb.Hash.create(e),this},Tween.prototype.init=function(){var e=this;t.prototype.init.call(this),this._valuesEnd.forEach(function(t,r){if(t instanceof Array){if(0===t.length)return;e._valuesEnd.setValue(r,[e._object.getChild(r)].concat(e._valuesEnd.getChild(r)))}e._valuesStart.setValue(r,e._object.getChild(r)),e._valuesStart.getChild(r)instanceof Array==!1&&e._valuesStart.setValue(r,1*e._valuesStart.getChild(r))})},Tween.prototype.start=function(){return t.prototype.start.call(this),this._onStartCallbackFired=!1,this},Tween.prototype.stop=function(){return t.prototype.stop.call(this),null!==this._onStopCallback&&this._onStopCallback.call(this._object.getChildren()),this},Tween.prototype.reverse=function(){var e=this._valuesStart;this._valuesStart=this._valuesEnd,this._valuesEnd=e},Tween.prototype.easing=function(e){return this._easingFunction=e,this},Tween.prototype.interpolation=function(e){return this._interpolationFunction=e,this},Tween.prototype.onUpdate=function(e){return this._onUpdateCallback=e,this},Tween.prototype.onFinish=function(e){return this._onFinishCallback=e,this},Tween.prototype.onStart=function(e){return this._onStartCallback=e,this},Tween.prototype.onStop=function(e){return this._onStopCallback=e,this},Tween.prototype.finish=function(){t.prototype.finish.call(this),null!==this._onFinishCallback&&this._onFinishCallback.call(this._object.getChildren())},Tween.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(-Math.pow(2,-10*(e-1))+2)}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){var t,r=.1,n=.4;return 0===e?0:1===e?1:(!r||r<1?(r=1,t=n/4):t=n*Math.asin(1/r)/(2*Math.PI),-(r*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)))},Out:function(e){var t,r=.1,n=.4;return 0===e?0:1===e?1:(!r||r<1?(r=1,t=n/4):t=n*Math.asin(1/r)/(2*Math.PI),r*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/n)+1)},InOut:function(e){var t,r=.1,n=.4;return 0===e?0:1===e?1:(!r||r<1?(r=1,t=n/4):t=n*Math.asin(1/r)/(2*Math.PI),(e*=2)<1?-.5*(r*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)):r*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)*.5+1)}},Back:{In:function(e){var t=1.70158;return e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?.5*(e*e*((t+1)*e-t)):.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-Tween.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*Tween.Easing.Bounce.In(2*e):.5*Tween.Easing.Bounce.Out(2*e-1)+.5}}},Tween.Interpolation={Linear:function(e,t){var r=e.length-1,n=r*t,i=Math.floor(n),a=Tween.Interpolation.Utils.Linear;return t<0?a(e[0],e[1],n):t>1?a(e[r],e[r-1],r-n):a(e[i],e[i+1>r?r:i+1],n-i)},Bezier:function(e,t){var r,n=0,i=e.length-1,a=Tween.Interpolation.Utils.Bernstein;for(r=0;r<=i;r++)n+=Math.pow(1-t,i-r)*Math.pow(t,r)*e[r]*a(i,r);return n},CatmullRom:function(e,t){var r=e.length-1,n=r*t,i=Math.floor(n),a=Tween.Interpolation.Utils.CatmullRom;return e[0]===e[r]?(t<0&&(i=Math.floor(n=r*(1+t))),a(e[(i-1+r)%r],e[i],e[(i+1)%r],e[(i+2)%r],n-i)):t<0?e[0]-(a(e[0],e[0],e[1],e[1],-n)-e[0]):t>1?e[r]-(a(e[r],e[r],e[r-1],e[r-1],n-r)-e[r]):a(e[i?i-1:0],e[i],e[r<i+1?r:i+1],e[r<i+2?r:i+2],n-i)},Utils:{Linear:function(e,t,r){return(t-e)*r+e},Bernstein:function(e,t){var r=Tween.Interpolation.Utils.Factorial;return r(e)/r(t)/r(e-t)},Factorial:function(){var e=[1];return function(t){var r,n=1;if(e[t])return e[t];for(r=t;r>1;r--)n*=r;return e[t]=n}}(),CatmullRom:function(e,t,r,n,i){var a=.5*(r-e),o=.5*(n-t),s=i*i,c=i*s;return(2*t-2*r+a+o)*c+(-3*t+3*r-2*a-o)*s+a*i+t}}},__decorate([e.cloneAttributeAsBasicType()],Tween.prototype,"duration",void 0),__decorate([e.cloneAttributeAsCloneable()],Tween.prototype,"_valuesStart",void 0),__decorate([e.cloneAttributeAsCloneable()],Tween.prototype,"_valuesEnd",void 0),__decorate([e.cloneAttributeAsBasicType()],Tween.prototype,"_easingFunction",void 0),__decorate([e.cloneAttributeAsBasicType()],Tween.prototype,"_interpolationFunction",void 0),__decorate([e.cloneAttributeAsBasicType()],Tween.prototype,"_onStartCallback",void 0),__decorate([e.cloneAttributeAsBasicType()],Tween.prototype,"_onStartCallbackFired",void 0),__decorate([e.cloneAttributeAsBasicType()],Tween.prototype,"_onUpdateCallback",void 0),__decorate([e.cloneAttributeAsBasicType()],Tween.prototype,"_onFinishCallback",void 0),__decorate([e.cloneAttributeAsBasicType()],Tween.prototype,"_onStopCallback",void 0),Tween}(e.ActionInterval);e.Tween=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function RendererComponent(){e.apply(this,arguments)}return __extends(RendererComponent,e),RendererComponent}(e.Component);e.RendererComponent=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MeshRenderer(){t.apply(this,arguments)}return __extends(MeshRenderer,t),MeshRenderer.create=function(){var e=new this;return e},MeshRenderer.prototype.render=function(e,t,r){var n=t.getGeometry();n&&e.addCommand(this.createDrawCommand(t,n,r))},MeshRenderer.prototype.createDrawCommand=function(t,r,n){var i=null,a=n.getComponent(e.CameraController),o=r.material;return i=this._createCommand(t,o),i.target=t,i.buffers=r.buffers,i.vaoManager=r.vaoManager,i.drawMode=r.drawMode,i.mMatrix=t.transform.localToWorldMatrix,i.vMatrix=a.worldToCameraMatrix,i.pMatrix=a.pMatrix,i.material=o,i.blend=o.blend,i},MeshRenderer.prototype._createCommand=function(t,r){var n=null,i=null,a=this._getInstanceState(r),o=a.isModelMatrixInstance,s=a.isNormalMatrixInstance,c=a.isOneToManyInstance,u=a.isHardwareInstance,l=a.isBatchInstance;return i=this._getInstanceGLSLData(c,o,s),u?n=c?this._createOneToManyHardwareInstanceCommand(t,r,i):this._createOneToOneHardwareInstanceCommand(t,r,i):l?n=c?this._createOneToManyBatchInstanceCommand(t,r,i):this._createOneToOneBatchInstanceCommand(t,r,i):(n=e.SingleDrawCommand.create(),n.normalMatrix=this.entityObject.transform.normalMatrix),n},MeshRenderer.prototype._getInstanceState=function(t){if(t.geometry instanceof e.InstanceGeometry){var r=e.InstanceUtils.isHardwareSupport(),n=!r;return{isModelMatrixInstance:!1,isNormalMatrixInstance:!1,isOneToManyInstance:!0,isHardwareInstance:r,isBatchInstance:n}}var i=t.shader.getInstanceState(),a=i.isModelMatrixInstance,o=i.isNormalMatrixInstance,s=i.isHardwareInstance,c=i.isBatchInstance;return{isModelMatrixInstance:a,isNormalMatrixInstance:o,isOneToManyInstance:!1,isHardwareInstance:s,isBatchInstance:c}},MeshRenderer.prototype._getInstanceGLSLData=function(t,r,n){return t?e.EInstanceGLSLData.ONE_MANY:n?e.EInstanceGLSLData.NORMALMATRIX_MODELMATRIX:e.EInstanceGLSLData.MODELMATRIX},MeshRenderer.prototype._createOneToOneHardwareInstanceCommand=function(t,r,n){var i=t.getComponent(e.OneToOneSourceInstance),a=e.OneToOneHardwareInstanceCommand.create();return a.instanceList=i.toRenderInstanceListForDraw,a.instanceBuffer=i.instanceBuffer,a.glslData=n,a},MeshRenderer.prototype._createOneToManyHardwareInstanceCommand=function(t,r,n){var i=t.getComponent(e.OneToManySourceInstance),a=e.OneToManyHardwareInstanceCommand.create();return a.instanceBuffer=i.instanceBuffer,
a.geometry=r.geometry,a.glslData=n,a},MeshRenderer.prototype._createOneToOneBatchInstanceCommand=function(t,r,n){var i=t.getComponent(e.OneToOneSourceInstance),a=e.OneToOneBatchInstanceCommand.create();return a.instanceList=i.toRenderInstanceListForDraw,a.glslData=n,a},MeshRenderer.prototype._createOneToManyBatchInstanceCommand=function(t,r,n){var i=(t.getComponent(e.OneToManySourceInstance),e.OneToManyBatchInstanceCommand.create());return i.geometry=r.geometry,i.glslData=n,i},__decorate([e.require(function(t,r,n){var i=n.getComponent(e.CameraController);e.it("camera must add Camera Component",function(){e.expect(!!i&&!!i.camera).true}),e.it("Mesh must add geometry component",function(){e.expect(!!r).true})})],MeshRenderer.prototype,"createDrawCommand",null),__decorate([e.require(function(t){e.InstanceUtils.isInstance(t)&&e.it("if use instance to batch draw, target should be SourceInstance",function(){e.expect(e.InstanceUtils.isSourceInstance(t)).true})}),e.ensure(function(t,r){t instanceof e.HardwareInstanceCommand?e.it("hardware should support instance",function(){e.expect(e.InstanceUtils.isHardwareSupport()).true}):t instanceof e.BatchInstanceCommand&&e.it("hardware shouldn't support instance",function(){e.expect(e.InstanceUtils.isHardwareSupport()).false})})],MeshRenderer.prototype,"_createCommand",null),MeshRenderer}(e.RendererComponent);e.MeshRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SkyboxRenderer(){t.apply(this,arguments)}return __extends(SkyboxRenderer,t),SkyboxRenderer.create=function(){var e=new this;return e},SkyboxRenderer.prototype.render=function(t,r,n){t.skyboxCommand=this.createDrawCommand(r,r.getComponent(e.Geometry),n)},__decorate([e.require(function(t,r,n){e.it("target should has geometry",function(){e.expect(r.hasComponent(e.Geometry)).true})})],SkyboxRenderer.prototype,"render",null),SkyboxRenderer}(e.MeshRenderer);e.SkyboxRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function UIRenderer(){t.apply(this,arguments),this._zIndex=1,this._dirty=!0,this.isClearCanvas=!1,this.state=e.EUIRendererState.NORMAL,this.context=null,this.canvas=null,this._referenceList=wdCb.Collection.create()}return __extends(UIRenderer,t),UIRenderer.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(UIRenderer.prototype,"zIndex",{get:function(){return this._zIndex},set:function(e){e!==this._zIndex&&(this._zIndex=e,this.canvas&&wdCb.DomQuery.create(this.canvas).css("zIndex",e))},enumerable:!0,configurable:!0}),Object.defineProperty(UIRenderer.prototype,"dirty",{get:function(){return this._dirty},set:function(e){e?this._dirty=!0:this.resetDirty()},enumerable:!0,configurable:!0}),UIRenderer.prototype.resetDirty=function(){this._dirty=!1},UIRenderer.prototype.addToObject=function(e){this._referenceList.addChild(e),this.entityObject=e},UIRenderer.prototype.removeFromObject=function(e){this._referenceList.removeChild(e),this._referenceList.getCount()>0||t.prototype.removeFromObject.call(this,e)},UIRenderer.prototype.init=function(){},UIRenderer.prototype.initWhenCreate=function(){this._createOverlayCanvas()},UIRenderer.prototype.dispose=function(){this._referenceList.getCount()>0||wdCb.DomQuery.create(this.canvas).remove()},UIRenderer.prototype.render=function(e,t,r){},UIRenderer.prototype.clearCanvas=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.isClearCanvas=!0},UIRenderer.prototype._createOverlayCanvas=function(){var t=null,r=null;this.canvas||(t=wdCb.DomQuery.create("<canvas></canvas>").prependTo("body"),r=e.DeviceManager.getInstance().view,t.css("position","absolute"),t.css("left",r.x+"px"),t.css("top",r.y+"px"),t.css("zIndex",this.zIndex),t.attr("width",r.width),t.attr("height",r.height),this.canvas=t.get(0),this.context=this.canvas.getContext("2d"))},__decorate([e.cloneAttributeAsBasicType()],UIRenderer.prototype,"zIndex",null),__decorate([e.execOnlyOnce("_isInit")],UIRenderer.prototype,"init",null),UIRenderer}(e.RendererComponent);e.UIRenderer=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.NORMAL=0]="NORMAL",e[e.DIRTY=1]="DIRTY",e[e.NOT_DIRTY=2]="NOT_DIRTY"}(e.EUIRendererState||(e.EUIRendererState={}));e.EUIRendererState}(wd||(wd={}));var wd;!function(e){var t=function(t){function SpacePartition(){t.apply(this,arguments),this.isCollideEnable=!0}return __extends(SpacePartition,t),__decorate([e.cloneAttributeAsBasicType()],SpacePartition.prototype,"isCollideEnable",void 0),SpacePartition}(e.Component);e.SpacePartition=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Octree(){t.apply(this,arguments),this.maxDepth=2,this.maxNodeCapacity=64,this._root=null,this._selectionList=wdCb.Collection.create(),this._renderListCache=null}return __extends(Octree,t),Octree.create=function(){var e=new this;return e},Octree.prototype.addToObject=function(r,n){void 0===n&&(n=!1);var i=e.SpacePartitionEngine.getInstance();t.prototype.addToObject.call(this,r,n),i.hasChild(this)||i.addChild(this)},Octree.prototype.removeFromObject=function(r){t.prototype.removeFromObject.call(this,r),e.SpacePartitionEngine.getInstance().removeChild(this)},Octree.prototype.init=function(){t.prototype.init.call(this)},Octree.prototype.update=function(e){this._renderListCache=this._getRenderListForCurrentLoop()},Octree.prototype.getRenderList=function(){return this._renderListCache},Octree.prototype.build=function(){var t=this.getChildren(),r=0,n=this.maxNodeCapacity,i=this.maxDepth,a=function(t,r,o,s,c){for(var u=new e.Vector3((r.x-t.x)/2,(r.y-t.y)/2,(r.z-t.z)/2),l=0;l<2;l++)for(var d=0;d<2;d++)for(var h=0;h<2;h++){var p=t.clone().add(u.clone().scale(l,d,h)),f=t.clone().add(u.clone().scale(l+1,d+1,h+1)),m=e.OctreeNode.create(p,f,n,o+1,i);m.addGameObjects(s),m.gameObjectCount>n&&o<i&&a(p,f,o+1,s,m),c.addNode(m)}};this._updateColliderForFirstCheck(t);var o=this._getWorldExtends(t),s=o.worldMin,c=o.worldMax;this._root=e.OctreeNode.create(s,c,n,r+1,i),a(s,c,r,t,this._root)},Octree.prototype.getRenderListByFrustumCull=function(){var t=e.Director.getInstance().scene.currentCamera;return t?this._visitRoot("findAndAddToRenderList",[t.getComponent(e.CameraController).getPlanes(),this._selectionList]):wdCb.Collection.create()},Octree.prototype.getIntersectListWithRay=function(t){var r=t.locationInView;return this._visitRoot("findAndAddToIntersectList",[e.Director.getInstance().scene.currentCamera.getComponent(e.CameraController).createRay(r.x,r.y),this._selectionList])},Octree.prototype.getCollideObjects=function(e){return this._visitRoot("findAndAddToCollideList",[e,this._selectionList])},Octree.prototype.getChildren=function(){return this.entityObject.getChildren()},Octree.prototype._visitRoot=function(e,t){return this._selectionList.removeAllChildren(),this._root.nodeList.forEach(function(r){r[e].apply(r,t)}),this._selectionList=this._selectionList.removeRepeatItems(),this._selectionList},Octree.prototype._updateColliderForFirstCheck=function(t){var r=null,n=this;t.forEach(function(t){t.hasComponent(e.ColliderForFirstCheck)?r=t.getComponent(e.BoxColliderForFirstCheck):(r=n._createCollider(),t.addComponent(r),r.init()),r.update(null)})},Octree.prototype._getWorldExtends=function(t){var r=e.Vector3.create(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=e.Vector3.create(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i=this;return t.forEach(function(t){var a=null,o=null,s=null,c=null;s=t.getComponent(e.BoxColliderForFirstCheck),c=s.shape,a=c.getMin(),o=c.getMax(),i._checkExtends(a,r,n),i._checkExtends(o,r,n)}),{worldMin:r,worldMax:n}},Octree.prototype._createCollider=function(){return e.BoxColliderForFirstCheck.create()},Octree.prototype._checkExtends=function(e,t,r){e.x<t.x&&(t.x=e.x),e.y<t.y&&(t.y=e.y),e.z<t.z&&(t.z=e.z),e.x>r.x&&(r.x=e.x),e.y>r.y&&(r.y=e.y),e.z>r.z&&(r.z=e.z)},Octree.prototype._setToRenderInstanceListOfChildren=function(t,r){var n=function(t,r){t.forEach(function(t,i){var a=t.getComponent(e.OneToOneSourceInstance);r.forEachToRenderInstanceList(function(e){a.addToRenderIntance(e.getChild(i))}),n(t,a)})};n(t,r)},Octree.prototype._addSelfToToRenderInstanceList=function(e,t){t.addToRenderIntance(e)},Octree.prototype._getRenderListForCurrentLoop=function(){var t=this,r=this.getRenderListByFrustumCull(),n=wdCb.Collection.create(),i=wdCb.Hash.create();return r.forEach(function(r){if(!e.InstanceUtils.isInstance(r)||e.InstanceUtils.isOneToManySourceInstance(r))return void n.addChild(r);if(e.InstanceUtils.isOneToOneSourceInstance(r)){var a=r.getComponent(e.OneToOneSourceInstance);return t._addSelfToToRenderInstanceList(r,a),void i.addChild(String(r.uid),r)}var o=r.getComponent(e.ObjectInstance).sourceObject,s=o.getComponent(e.OneToOneSourceInstance);t._addSelfToToRenderInstanceList(r,s),i.addChild(String(o.uid),o)},this),i.forEach(function(r,i){var a=r.getComponent(e.OneToOneSourceInstance);t._setToRenderInstanceListOfChildren(r,a),n.addChild(r)},this),n},__decorate([e.cloneAttributeAsBasicType()],Octree.prototype,"maxDepth",void 0),__decorate([e.cloneAttributeAsBasicType()],Octree.prototype,"maxNodeCapacity",void 0),__decorate([e.require(function(t){e.assert(t instanceof e.GameObject,e.Log.info.FUNC_SHOULD("Octree component","add to GameObject"))})],Octree.prototype,"addToObject",null),__decorate([e.require(function(){e.assert(e.JudgeUtils.isEqual(this.entityObject.parent,e.Director.getInstance().scene)&&e.Director.getInstance().scene.gameObjectScene.hasChild(this.entityObject),e.Log.info.FUNC_SHOULD("be added to the one which is the firstLevel child of gameObjectScene"))})],Octree.prototype,"init",null),__decorate([e.ensure(function(t){e.assert(!!t&&t instanceof wdCb.Collection,e.Log.info.FUNC_NOT_EXIST("renderList"))})],Octree.prototype,"getRenderList",null),__decorate([e.require(function(){e.assert(!!e.Director.getInstance().scene.currentCamera.getComponent(e.CameraController),e.Log.info.FUNC_SHOULD("contain CameraController component"))})],Octree.prototype,"getRenderListByFrustumCull",null),__decorate([e.require(function(){e.assert(!!e.Director.getInstance().scene.currentCamera.getComponent(e.CameraController),e.Log.info.FUNC_SHOULD("contain CameraController component"))})],Octree.prototype,"getIntersectListWithRay",null),__decorate([e.require(function(t,r){e.assert(r.hasToRenderInstance(),e.Log.info.FUNC_SHOULD("top OneToOneSourceInstance","has to render instance"))})],Octree.prototype,"_setToRenderInstanceListOfChildren",null),__decorate([e.require(function(t,r){e.assert(r instanceof e.OneToOneSourceInstance,e.Log.info.FUNC_ONLY("OneToOneSourceInstance has toRenderList")),r.forEachToRenderInstanceList(function(r){e.assert(!e.JudgeUtils.isEqual(r,t),e.Log.info.FUNC_SHOULD_NOT("toRenderInstanceList","contain self"))})})],Octree.prototype,"_addSelfToToRenderInstanceList",null),Octree}(e.SpacePartition);e.Octree=t}(wd||(wd={}));var wd;!function(e){var t=function(){function OctreeNode(e,t,r,n,i){this.gameObjectList=wdCb.Collection.create(),this.nodeList=wdCb.Collection.create(),this._depth=null,this._maxDepth=null,this._capacity=null,this._minPoint=null,this._maxPoint=null,this._boundingVectors=null,this._capacity=r,this._depth=n,this._maxDepth=i,this._minPoint=e,this._maxPoint=t}return OctreeNode.create=function(e,t,r,n,i){var a=new this(e,t,r,n,i);return a.initWhenCreate(),a},Object.defineProperty(OctreeNode.prototype,"gameObjectCount",{get:function(){return this.gameObjectList.getCount()},enumerable:!0,configurable:!0}),OctreeNode.prototype.initWhenCreate=function(){this._boundingVectors=e.BoundingRegionUtils.buildBoundingVectors(this._minPoint,this._maxPoint)},OctreeNode.prototype.addGameObjects=function(t){var r=this,n=this._minPoint,i=this._maxPoint;t.forEach(function(t){t.getComponent(e.BoxColliderForFirstCheck).shape.isIntersectWithBox(n,i)&&r.gameObjectList.addChild(t)})},OctreeNode.prototype.addNode=function(e){this.nodeList.addChild(e)},OctreeNode.prototype.findAndAddToRenderList=function(t,r){if(e.BoundingRegionUtils.isAABBIntersectFrustum(this._boundingVectors,t)){if(this._hasNode())return void this.nodeList.forEach(function(e){e.findAndAddToRenderList(t,r)});r.addChildren(e.RenderUtils.getGameObjectRenderListForOctree(this.gameObjectList))}},OctreeNode.prototype.findAndAddToIntersectList=function(e,t){if(e.isIntersectWithAABB(this._minPoint,this._maxPoint)){if(this._hasNode())return void this.nodeList.forEach(function(r){r.findAndAddToIntersectList(e,t)});t.addChildren(this.gameObjectList)}},OctreeNode.prototype.findAndAddToCollideList=function(e,t){if(e.isIntersectWithBox(this._minPoint,this._maxPoint)){if(this._hasNode())return void this.nodeList.forEach(function(r){r.findAndAddToCollideList(e,t)});t.addChildren(this.gameObjectList)}},OctreeNode.prototype._hasNode=function(){return this.nodeList.getCount()>0},__decorate([e.require(function(t){t.forEach(function(t){e.assert(t instanceof e.GameObject,e.Log.info.FUNC_SHOULD("add gameObjects"))})})],OctreeNode.prototype,"addGameObjects",null),OctreeNode}();e.OctreeNode=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ColliderForFirstCheck(){t.apply(this,arguments)}return __extends(ColliderForFirstCheck,t),ColliderForFirstCheck.prototype.clone=function(){return e.CloneUtils.clone(this)},ColliderForFirstCheck}(e.Component);e.ColliderForFirstCheck=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BoxColliderForFirstCheck(){t.apply(this,arguments),this._collider=e.BoxCollider.create()}return __extends(BoxColliderForFirstCheck,t),BoxColliderForFirstCheck.create=function(){var e=new this;return e},Object.defineProperty(BoxColliderForFirstCheck.prototype,"shape",{get:function(){return this._collider.shape},enumerable:!0,configurable:!0}),BoxColliderForFirstCheck.prototype.init=function(){this._collider.entityObject=this.entityObject,this._collider.init()},BoxColliderForFirstCheck.prototype.update=function(e){this._collider.update(e)},__decorate([e.cloneAttributeAsCloneable()],BoxColliderForFirstCheck.prototype,"_collider",void 0),BoxColliderForFirstCheck}(e.ColliderForFirstCheck);e.BoxColliderForFirstCheck=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Collider(){t.apply(this,arguments),this.enable=!0,this.boundingRegion=null}return __extends(Collider,t),Object.defineProperty(Collider.prototype,"shape",{get:function(){return this.boundingRegion.shape},enumerable:!0,configurable:!0}),Collider.prototype.init=function(){this.boundingRegion=this.createBoundingRegion(),this.boundingRegion.init(),this.buildBoundingRegion()},Collider.prototype.addToObject=function(r,n){void 0===n&&(n=!1);var i=e.CollisionEngine.getInstance();t.prototype.addToObject.call(this,r,n),i.hasChild(this)||i.addChild(this)},Collider.prototype.removeFromObject=function(r){t.prototype.removeFromObject.call(this,r),e.CollisionEngine.getInstance().removeChild(this)},Collider.prototype.clone=function(){return e.CloneUtils.clone(this)},Collider.prototype.update=function(e){this.boundingRegion.update()},Collider.prototype.updateShape=function(){this.boundingRegion.updateShape()},Collider.prototype.isIntersectWith=function(t){return t instanceof e.BoxCollider?this.boundingRegion.isIntersectWithBox(t.boundingRegion):t instanceof e.SphereCollider?this.boundingRegion.isIntersectWithSphere(t.boundingRegion):void e.Log.warn(e.Log.info.FUNC_NOT_SUPPORT(this.type+" collider","intersect with "+t.type+" collider"))},Collider.prototype.isCollide=function(t){var r=null;return r=t.getComponent(Collider),t.hasComponent(e.RigidBody)&&r.updateShape(),this.isIntersectWith(r)},Collider.prototype._isSelf=function(t){return e.JudgeUtils.isSelf(this.entityObject,t)},__decorate([e.cloneAttributeAsBasicType()],Collider.prototype,"enable",void 0),__decorate([e.cloneAttributeAsCloneable()],Collider.prototype,"boundingRegion",void 0),__decorate([e.require(function(t){e.assert(t instanceof Collider,e.Log.info.FUNC_SHOULD("target","be collider"))})],Collider.prototype,"isIntersectWith",null),__decorate([e.require(function(t){e.assert(!this._isSelf(t),e.Log.info.FUNC_SHOULD_NOT("targetObject","be self")),e.assert(t.hasComponent(Collider),e.Log.info.FUNC_SHOULD("targetObject","contain Collider component"))})],Collider.prototype,"isCollide",null),Collider}(e.Component);e.Collider=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BoxCollider(){t.apply(this,arguments),this.center=e.Vector3.create(0,0,0),this.halfExtents=null,this.type=e.EColliderType.BOX}return __extends(BoxCollider,t),BoxCollider.create=function(){var e=new this;return e},BoxCollider.prototype.createBoundingRegion=function(){return e.BoxBoundingRegion.create(this.entityObject)},BoxCollider.prototype.buildBoundingRegion=function(){this.boundingRegion.build(this.center,this.halfExtents)},__decorate([e.cloneAttributeAsCloneable()],BoxCollider.prototype,"center",void 0),__decorate([e.cloneAttributeAsCloneable()],BoxCollider.prototype,"halfExtents",void 0),BoxCollider}(e.Collider);e.BoxCollider=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SphereCollider(){t.apply(this,arguments),this.center=e.Vector3.create(0,0,0),this.radius=null,this.type=e.EColliderType.SPHERE}return __extends(SphereCollider,t),SphereCollider.create=function(){var e=new this;return e},SphereCollider.prototype.createBoundingRegion=function(){return e.SphereBoundingRegion.create(this.entityObject)},SphereCollider.prototype.buildBoundingRegion=function(){this.boundingRegion.build(this.center,this.radius)},__decorate([e.cloneAttributeAsCloneable()],SphereCollider.prototype,"center",void 0),__decorate([e.cloneAttributeAsBasicType()],SphereCollider.prototype,"radius",void 0),SphereCollider}(e.Collider);e.SphereCollider=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BoundingRegion(e){this.shape=null,this.entityObject=null,this.isUserSpecifyTheRegion=!1,this.originShape=null,this.debugObject=null,this.entityObject=e}return BoundingRegion.prototype.init=function(){this.shape=this.createShape()},BoundingRegion.prototype.clone=function(){return e.CloneUtils.clone(this)},BoundingRegion.prototype.build=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];var i=Array.prototype.slice.call(arguments,0);this.isBuildUserSpecifyBoundingRegion.apply(this,i)?(this.isUserSpecifyTheRegion=!0,this.shape.setFromShapeParam.apply(this.shape,i)):this.shape.setFromPoints(e.ColliderUtils.getVertices(this.entityObject)),this.originShape=this.shape.clone(),e.DebugConfig.debugCollision&&(this.debugObject=this.buildDebugObjectFromShape(this.shape),e.Director.getInstance().scene.addChild(this.debugObject))},BoundingRegion.prototype.update=function(){this.isNotTransformed()||(e.DebugConfig.debugCollision?(this.updateShape(),this.updateDebugObjectFromShape(this.shape)):this.entityObject.hasComponent(e.RigidBody)||this.updateShape())},BoundingRegion.prototype.isIntersectWithSphere=function(e){return this.shape.isIntersectWithSphere(e.shape)},BoundingRegion.prototype.isIntersectWithBox=function(e){return this.shape.isIntersectWithBox(e.shape)},BoundingRegion.prototype.buildDebugObjectFromShape=function(t){var r=null,n=null,i=null,a=null;return r=e.BasicMaterial.create(),r.color=e.Color.create("rgb(255,0,0)"),n=e.CustomGeometry.create(),n.material=r,n.drawMode=e.EDrawMode.LINES,this.setDebugObjectGeometry(n,t),i=e.MeshRenderer.create(),a=e.GameObject.create(),a.addComponent(n),a.addComponent(i),a.transform.translate(t.center),a.name="debugBoundingRegion"+this.entityObject.uid,a.init(),a},__decorate([e.cloneAttributeAsCloneable()],BoundingRegion.prototype,"shape",void 0),__decorate([e.ensure(function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];this.isBuildUserSpecifyBoundingRegion.apply(this,Array.prototype.slice.call(arguments,1))&&e.assert(this.shape.center.isEqual(r),e.Log.info.FUNC_SHOULD_NOT("transform shape when build"))})],BoundingRegion.prototype,"build",null),BoundingRegion}();e.BoundingRegion=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BoxBoundingRegion(){t.apply(this,arguments)}return __extends(BoxBoundingRegion,t),BoxBoundingRegion.create=function(e){var t=new this(e);return t},BoxBoundingRegion.prototype.updateShape=function(){var e=this.entityObject.transform;this.isUserSpecifyTheRegion?this.shape.setFromTranslationAndScale(this.originShape,e.localToWorldMatrix):e.isRotate?this.shape.setFromObject(this.entityObject):this.shape.setFromTranslationAndScale(this.originShape,e.localToWorldMatrix)},BoxBoundingRegion.prototype.createShape=function(){return e.AABBShape.create()},BoxBoundingRegion.prototype.updateDebugObjectFromShape=function(t){var r=this.debugObject.getComponent(e.CustomGeometry);this.setDebugObjectGeometry(r,t),this.debugObject.transform.position=t.center},BoxBoundingRegion.prototype.setDebugObjectGeometry=function(e,t){var r=t.halfExtents,n=r.x,i=r.y,a=r.z;e.vertices=[-n,-i,-a,-n,-i,a,n,-i,a,n,-i,-a,-n,i,-a,-n,i,a,n,i,a,n,i,-a],e.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]},BoxBoundingRegion.prototype.isBuildUserSpecifyBoundingRegion=function(e,t){return!!e&&!!t},BoxBoundingRegion.prototype.isNotTransformed=function(){var e=this.entityObject.transform;return!e.isRotate&&!e.isTranslate&&!e.isScale},__decorate([e.require(function(t){e.assert(this.debugObject,e.Log.info.FUNC_SHOULD("build debugObject"))})],BoxBoundingRegion.prototype,"updateDebugObjectFromShape",null),__decorate([e.require(function(t,r){e.assert(r.halfExtents&&!r.halfExtents.isZero(),e.Log.info.FUNC_SHOULD_NOT("halfExtents","be zero"))})],BoxBoundingRegion.prototype,"setDebugObjectGeometry",null),BoxBoundingRegion}(e.BoundingRegion);e.BoxBoundingRegion=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SphereBoundingRegion(){t.apply(this,arguments)}return __extends(SphereBoundingRegion,t),SphereBoundingRegion.create=function(e){var t=new this(e);return t},SphereBoundingRegion.prototype.updateShape=function(){var e=this.entityObject.transform;this.shape.setFromTranslationAndScale(this.originShape,e.localToWorldMatrix)},SphereBoundingRegion.prototype.createShape=function(){return e.SphereShape.create()},SphereBoundingRegion.prototype.updateDebugObjectFromShape=function(t){this.debugObject.transform.position=t.center;var r=t.radius/this.originShape.radius;this.debugObject.transform.scale=e.Vector3.create(r,r,r)},SphereBoundingRegion.prototype.isNotTransformed=function(){var e=this.entityObject.transform;return!e.isTranslate&&!e.isScale},SphereBoundingRegion.prototype.isBuildUserSpecifyBoundingRegion=function(e,t){return!!e&&!!t},SphereBoundingRegion.prototype.setDebugObjectGeometry=function(e,t){for(var r=40,n=3,i=t.radius,a=[],o=0,s=0;s<n;s++){var c=0,u=1,l=2,d=null;1===s?(c=1,u=0,l=2):2===s&&(c=0,u=2,l=1);for(var h=0;h<r;h++)d=2*Math.PI*(h/r),a[o+c]=i*Math.cos(d),a[o+u]=0,a[o+l]=i*Math.sin(d),o+=3,d=2*Math.PI*((h+1)/r),a[o+c]=i*Math.cos(d),a[o+u]=0,a[o+l]=i*Math.sin(d),o+=3}e.vertices=a},__decorate([e.require(function(t){e.assert(this.debugObject,e.Log.info.FUNC_SHOULD("build debugObject"))})],SphereBoundingRegion.prototype,"updateDebugObjectFromShape",null),__decorate([e.require(function(t,r){e.assert(r.radius>0,e.Log.info.FUNC_SHOULD("radius","> 0"))})],SphereBoundingRegion.prototype,"setDebugObjectGeometry",null),SphereBoundingRegion}(e.BoundingRegion);e.SphereBoundingRegion=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BoundingRegionUtils(){}return BoundingRegionUtils.isAABBInFrustum=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null,n=null;if(2===e.length)r=e[0],n=e[1];else if(3===e.length){var i=e[0],a=e[1];r=this.buildBoundingVectors(i,a),n=e[2]}for(var o=0;o<6;o++)for(var s=0;s<8;s++)if(n[o].dotCoordinate(r[s])<0)return!1;return!0},BoundingRegionUtils.isAABBIntersectFrustum=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=null,n=null;if(2===e.length)r=e[0],n=e[1];else if(3===e.length){var i=e[0],a=e[1];r=this.buildBoundingVectors(i,a),n=e[2]}for(var o=0;o<6;o++){for(var s=8,c=0;c<8&&n[o].dotCoordinate(r[c])<0;c++)s--;if(0===s)return!1}return!0},BoundingRegionUtils.buildBoundingVectors=function(e,t){var r=[];return r.push(e.clone()),r.push(t.clone()),r.push(e.clone()),r[2].x=t.x,r.push(e.clone()),r[3].y=t.y,r.push(e.clone()),r[4].z=t.z,r.push(t.clone()),r[5].z=e.z,r.push(t.clone()),r[6].x=e.x,r.push(t.clone()),r[7].y=e.y,r},BoundingRegionUtils}();e.BoundingRegionUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Shape(){this.center=e.Vector3.create(0,0,0)}return Shape.prototype.clone=function(){return e.CloneUtils.clone(this)},Shape.prototype.isBoxAndSphereIntersected=function(e,t){var r=t.center,n=t.radius;return r.distanceToSquared(e.closestPointTo(r))<Math.pow(n,2)},__decorate([e.cloneAttributeAsCloneable()],Shape.prototype,"center",void 0),Shape}();e.Shape=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function AABBShape(){t.apply(this,arguments),this.halfExtents=e.Vector3.create(.5,.5,.5)}return __extends(AABBShape,t),AABBShape.create=function(){var e=new this;return e},AABBShape.getCenter=function(t,r){return e.Vector3.create().add2(r,t).scale(.5)},AABBShape.getHalfExtents=function(t,r){return e.Vector3.create().sub2(r,t).scale(.5)},AABBShape.prototype.setMinMax=function(e,t){this.center=AABBShape.getCenter(e,t),this.halfExtents=AABBShape.getHalfExtents(e,t)},AABBShape.prototype.getMin=function(){return this.center.clone().sub(this.halfExtents)},AABBShape.prototype.getMax=function(){return this.center.clone().add(this.halfExtents)},AABBShape.prototype.setFromShapeParam=function(e,t){this.center=e,this.halfExtents=t},AABBShape.prototype.setFromPoints=function(t){var r=this,n=this._getEmptyMin(),i=this._getEmptyMax();return e.GeometryUtils.iterateThreeComponent(t,function(e){r._expandByPoint(e,n,i)}),this.setMinMax(n,i),this},AABBShape.prototype.setFromTransformedAABB=function(e,t){var r=this.center,n=this.halfExtents,i=e.center.values,a=e.halfExtents.values,o=t.values,s=o[0],c=o[4],u=o[8],l=o[1],d=o[5],h=o[9],p=o[2],f=o[6],m=o[10],g=Math.abs(s),_=Math.abs(c),y=Math.abs(u),v=Math.abs(l),b=Math.abs(d),C=Math.abs(h),S=Math.abs(p),T=Math.abs(f),E=Math.abs(m);r.set(o[12]+s*i[0]+c*i[1]+u*i[2],o[13]+l*i[0]+d*i[1]+h*i[2],o[14]+p*i[0]+f*i[1]+m*i[2]),n.set(g*a[0]+_*a[1]+y*a[2],v*a[0]+b*a[1]+C*a[2],S*a[0]+T*a[1]+E*a[2])},AABBShape.prototype.setFromTranslationAndScale=function(e,t){var r=t.getTranslation(),n=t.getScale();this.center=e.center.clone().add(r),this.halfExtents=e.halfExtents.clone().mul(n)},AABBShape.prototype.setFromObject=function(t){var r=t.transform.localToWorldMatrix,n=e.ColliderUtils.getVertices(t),i=this,a=this._getEmptyMin(),o=this._getEmptyMax();e.GeometryUtils.iterateThreeComponent(n,function(e){e.applyMatrix4(r),i._expandByPoint(e,a,o)}),this.setMinMax(a,o)},AABBShape.prototype.isIntersectWithBox=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=this.getMax(),n=this.getMin(),i=null,a=null;if(1===e.length){var o=e[0];a=o.getMin(),i=o.getMax()}else 2===e.length&&(a=e[0],i=e[1]);return n.x<=i.x&&r.x>=a.x&&n.y<=i.y&&r.y>=a.y&&n.z<=i.z&&r.z>=a.z},AABBShape.prototype.isIntersectWithSphere=function(e){return this.isBoxAndSphereIntersected(this,e)},AABBShape.prototype.isIntersectWithRay=function(e){return e.isIntersectWithAABB(this)},AABBShape.prototype.closestPointTo=function(t){var r=this.getMin(),n=this.getMax(),i=e.Vector3.create();return t.x<r.x?i.x=r.x:t.x>n.x?i.x=n.x:i.x=t.x,t.y<r.y?i.y=r.y:t.y>n.y?i.y=n.y:i.y=t.y,t.z<r.z?i.z=r.z:t.z>n.z?i.z=n.z:i.z=t.z,i},AABBShape.prototype.containPoint=function(e){for(var t=this.getMin(),r=this.getMax(),n=0;n<3;++n)if(e.values[n]<t.values[n]||e.values[n]>r.values[n])return!1;return!0},AABBShape.prototype._getEmptyMin=function(){return e.Vector3.create(1/0,1/0,1/0)},AABBShape.prototype._getEmptyMax=function(){return e.Vector3.create(-(1/0),-(1/0),-(1/0))},AABBShape.prototype._expandByPoint=function(e,t,r){t.min(e),r.max(e)},__decorate([e.cloneAttributeAsCloneable()],AABBShape.prototype,"halfExtents",void 0),__decorate([e.require(function(t){var r=e.ColliderUtils.getVertices(t);e.assert(r&&r.length>0,e.Log.info.FUNC_MUST_DEFINE("vertices"))})],AABBShape.prototype,"setFromObject",null),AABBShape}(e.Shape);e.AABBShape=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SphereShape(){t.apply(this,arguments),this.radius=1}return __extends(SphereShape,t),SphereShape.create=function(){var e=new this;return e},SphereShape.prototype.setFromShapeParam=function(e,t){this.center=e,this.radius=t},SphereShape.prototype.setFromPoints=function(t){var r=e.AABBShape.create();this.center=r.setFromPoints(t).center,this.radius=this._findMaxDistanceOfPointsToCenter(t)},SphereShape.prototype.setFromTranslationAndScale=function(e,t){var r=t.getTranslation(),n=t.getScale();this.center=e.center.clone().add(r),this.radius=e.radius*Math.max(n.x,n.y,n.z)},SphereShape.prototype.isIntersectWithSphere=function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=Math.pow(t,2)},SphereShape.prototype.isIntersectWithBox=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;if(1===t.length)n=t[0];else if(2===t.length){var i=t[0],a=t[1];n=e.AABBShape.create(),n.setMinMax(i,a)}return this.isBoxAndSphereIntersected(n,this)},SphereShape.prototype.isIntersectWithRay=function(e){return e.isIntersectWithSphere(this)},SphereShape.prototype.containPoint=function(e){return e.distanceToSquared(this.center)<=Math.pow(this.radius,2)},SphereShape.prototype._findMaxDistanceOfPointsToCenter=function(t){var r=0,n=this.center;return e.GeometryUtils.iterateThreeComponent(t,function(e){r=Math.max(r,n.distanceToSquared(e))}),Math.sqrt(r)},__decorate([e.cloneAttributeAsBasicType()],SphereShape.prototype,"radius",void 0),SphereShape}(e.Shape);e.SphereShape=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BOX="box"]="BOX",e[e.SPHERE="sphere"]="SPHERE"}(e.EColliderType||(e.EColliderType={}));e.EColliderType}(wd||(wd={}));var wd;!function(e){var t=function(){function ColliderUtils(){}return ColliderUtils.getVertices=function(t){return t.hasComponent(e.Geometry)?t.getComponent(e.Geometry).geometryData.vertices:t.hasTag(e.EWDTag.CONTAINER)?t.getChild(0).getComponent(e.Geometry).vertices:null},__decorate([e.require(function(t){if(!t.hasComponent(e.Geometry)&&t.hasTag(e.EWDTag.CONTAINER)){var r=t.getChild(0).getComponent(e.Geometry).vertices,n=t.getChild(1).getComponent(e.Geometry).vertices;e.assert(!!r&&r.length===n.length,e.Log.info.FUNC_SHOULD("if entityObject is EWDTag.CONTAINER, then its children should has its vertices"))}})],ColliderUtils,"getVertices",null),ColliderUtils}();e.ColliderUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RigidBody(){t.apply(this,arguments),this._friction=0,this._restitution=0,this._children=wdCb.Collection.create(),this.lockConstraint=e.LockConstraint.create(this),this.distanceConstraint=e.DistanceConstraint.create(this),this.hingeConstraint=e.HingeConstraint.create(this),this.pointToPointConstraintList=e.PointToPointConstraintList.create(this)}return __extends(RigidBody,t),Object.defineProperty(RigidBody.prototype,"friction",{get:function(){return this._friction},set:function(e){this._friction=e},enumerable:!0,configurable:!0}),Object.defineProperty(RigidBody.prototype,"restitution",{get:function(){return this._restitution},set:function(e){this._restitution=e},enumerable:!0,configurable:!0}),Object.defineProperty(RigidBody.prototype,"children",{get:function(){return this._children},set:function(t){if(e.JudgeUtils.isArrayExactly(t)){var r=t;this._children=wdCb.Collection.create(r)}else{var n=t;this._children=n}this._children.forEach(function(e){e.addTag("isRigidbodyChild")})},enumerable:!0,configurable:!0}),RigidBody.prototype.addToObject=function(r,n){void 0===n&&(n=!1);var i=e.PhysicsEngine.getInstance();t.prototype.addToObject.call(this,r,n),i.hasChild(this)||i.addChild(this)},RigidBody.prototype.addConstraint=function(){var e=this,t=this.getPhysicsEngineAdapter();this.lockConstraint&&this.lockConstraint.connectedBody&&t.addLockConstraint(this.entityObject,this.lockConstraint),
this.distanceConstraint&&this.distanceConstraint.connectedBody&&t.addDistanceConstraint(this.entityObject,this.distanceConstraint),this.hingeConstraint&&this.hingeConstraint.connectedBody&&t.addHingeConstraint(this.entityObject,this.hingeConstraint),this.pointToPointConstraintList&&this.pointToPointConstraintList.getCount()>0&&this.pointToPointConstraintList.forEach(function(r){t.addPointToPointConstraint(e.entityObject,r)},this)},RigidBody.prototype.removeFromObject=function(r){t.prototype.removeFromObject.call(this,r),e.PhysicsEngine.getInstance().removeChild(this)},RigidBody.prototype.dispose=function(){this._children.forEach(function(e){e.removeTag("isRigidbodyChild")},this)},RigidBody.prototype.getPhysicsEngineAdapter=function(){return e.PhysicsEngine.getInstance().physicsEngineAdapter},RigidBody.prototype.initBody=function(){this.addBody()},RigidBody.prototype.initConstraint=function(){this.addConstraint()},RigidBody.prototype.addBodyToPhysicsEngine=function(e,t){void 0===t&&(t={});var r=this.getPhysicsEngineAdapter(),n=this.entityObject.transform.position,i=this.entityObject.transform.rotation;r[e](this.entityObject,wdCb.ExtendUtils.extend({position:n,rotation:i,children:this._children,lockConstraint:this.lockConstraint,onContact:wdCb.FunctionUtils.bind(this,this._onContact),onCollisionStart:wdCb.FunctionUtils.bind(this,this._onCollisionStart),onCollisionEnd:wdCb.FunctionUtils.bind(this,this._onCollisionEnd),friction:this.friction,restitution:this.restitution},t))},RigidBody.prototype._onContact=function(t){e.ScriptEngine.getInstance().execEntityObjectScriptWithData(this.entityObject,"onContact",wdCb.Collection.create([t]))},RigidBody.prototype._onCollisionStart=function(t){e.ScriptEngine.getInstance().execEntityObjectScriptWithData(this.entityObject,"onCollisionStart",wdCb.Collection.create([t]))},RigidBody.prototype._onCollisionEnd=function(){e.ScriptEngine.getInstance().execEntityObjectScript(this.entityObject,"onCollisionEnd")},RigidBody.prototype._isContainer=function(e){var t=e.getComponent(RigidBody);return t.children.getCount()>0},__decorate([e.operateBodyDataGetterAndSetter("Friction"),e.cloneAttributeAsBasicType()],RigidBody.prototype,"friction",null),__decorate([e.operateBodyDataGetterAndSetter("Restitution"),e.cloneAttributeAsBasicType()],RigidBody.prototype,"restitution",null),__decorate([e.cloneAttributeAsCloneable()],RigidBody.prototype,"children",null),__decorate([e.cloneAttributeAsCloneable()],RigidBody.prototype,"lockConstraint",void 0),__decorate([e.cloneAttributeAsCloneable()],RigidBody.prototype,"distanceConstraint",void 0),__decorate([e.cloneAttributeAsCloneable()],RigidBody.prototype,"hingeConstraint",void 0),__decorate([e.cloneAttributeAsCloneable()],RigidBody.prototype,"pointToPointConstraintList",void 0),__decorate([e.execOnlyOnce("_initBody")],RigidBody.prototype,"initBody",null),__decorate([e.execOnlyOnce("_initConstraint")],RigidBody.prototype,"initConstraint",null),__decorate([e.require(function(){this._isContainer(this.entityObject)?e.assert(!this.entityObject.getComponent(e.Collider),e.Log.info.FUNC_SHOULD_NOT("container","add collider component in the case of compound")):(e.assert(!!this.entityObject.getComponent(e.Collider),e.Log.info.FUNC_MUST_DEFINE("collider component when add rigid body component")),e.assert(!!this.entityObject.getComponent(e.Collider).shape,e.Log.info.FUNC_SHOULD("create collider.shape before adding rigid body component")))})],RigidBody.prototype,"addBodyToPhysicsEngine",null),RigidBody}(e.Component);e.RigidBody=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DynamicRigidBody(){t.apply(this,arguments),this._linearDamping=0,this._angularDamping=0,this._velocity=e.Vector3.create(0,0,0),this._angularVelocity=e.Vector3.create(0,0,0),this._mass=1,this.impulse=null,this.force=null,this.hitPoint=null}return __extends(DynamicRigidBody,t),DynamicRigidBody.create=function(){var e=new this;return e},Object.defineProperty(DynamicRigidBody.prototype,"linearDamping",{get:function(){return this._linearDamping},set:function(e){this._linearDamping=e},enumerable:!0,configurable:!0}),Object.defineProperty(DynamicRigidBody.prototype,"angularDamping",{get:function(){return this._angularDamping},set:function(e){this._angularDamping=e},enumerable:!0,configurable:!0}),Object.defineProperty(DynamicRigidBody.prototype,"velocity",{get:function(){return this._velocity},set:function(e){this._velocity=e},enumerable:!0,configurable:!0}),Object.defineProperty(DynamicRigidBody.prototype,"angularVelocity",{get:function(){return this._angularVelocity},set:function(e){this._angularVelocity=e},enumerable:!0,configurable:!0}),Object.defineProperty(DynamicRigidBody.prototype,"mass",{get:function(){return this._mass},set:function(e){this._mass=e},enumerable:!0,configurable:!0}),DynamicRigidBody.prototype.addBody=function(){this.addBodyToPhysicsEngine("addDynamicBody",{mass:this.mass,linearDamping:this.linearDamping,angularDamping:this.angularDamping,velocity:this.velocity,angularVelocity:this.angularVelocity,impulse:this.impulse,force:this.force,hitPoint:this.hitPoint})},__decorate([e.operateBodyDataGetterAndSetter("LinearDamping"),e.cloneAttributeAsBasicType()],DynamicRigidBody.prototype,"linearDamping",null),__decorate([e.operateBodyDataGetterAndSetter("AngularDamping"),e.cloneAttributeAsBasicType()],DynamicRigidBody.prototype,"angularDamping",null),__decorate([e.operateBodyDataGetterAndSetter("Velocity"),e.cloneAttributeAsCloneable()],DynamicRigidBody.prototype,"velocity",null),__decorate([e.operateBodyDataGetterAndSetter("AngularVelocity"),e.cloneAttributeAsCloneable()],DynamicRigidBody.prototype,"angularVelocity",null),__decorate([e.operateBodyDataGetterAndSetter("Mass"),e.cloneAttributeAsBasicType()],DynamicRigidBody.prototype,"mass",null),__decorate([e.cloneAttributeAsCloneable()],DynamicRigidBody.prototype,"impulse",void 0),__decorate([e.cloneAttributeAsCloneable()],DynamicRigidBody.prototype,"force",void 0),__decorate([e.cloneAttributeAsCloneable()],DynamicRigidBody.prototype,"hitPoint",void 0),DynamicRigidBody}(e.RigidBody);e.DynamicRigidBody=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function KinematicRigidBody(){t.apply(this,arguments),this._velocity=e.Vector3.create(0,0,0),this._angularVelocity=e.Vector3.create(0,0,0),this._mass=1}return __extends(KinematicRigidBody,t),KinematicRigidBody.create=function(){var e=new this;return e},Object.defineProperty(KinematicRigidBody.prototype,"velocity",{get:function(){return this._velocity},set:function(e){this._velocity=e},enumerable:!0,configurable:!0}),Object.defineProperty(KinematicRigidBody.prototype,"angularVelocity",{get:function(){return this._angularVelocity},set:function(e){this._angularVelocity=e},enumerable:!0,configurable:!0}),Object.defineProperty(KinematicRigidBody.prototype,"mass",{get:function(){return this._mass},set:function(e){this._mass=e},enumerable:!0,configurable:!0}),KinematicRigidBody.prototype.addBody=function(){this.addBodyToPhysicsEngine("addKinematicBody",{mass:this.mass,velocity:this.velocity,angularVelocity:this.angularVelocity})},__decorate([e.operateBodyDataGetterAndSetter("Velocity"),e.cloneAttributeAsCloneable()],KinematicRigidBody.prototype,"velocity",null),__decorate([e.operateBodyDataGetterAndSetter("AngularVelocity"),e.cloneAttributeAsCloneable()],KinematicRigidBody.prototype,"angularVelocity",null),__decorate([e.operateBodyDataGetterAndSetter("Mass"),e.cloneAttributeAsBasicType()],KinematicRigidBody.prototype,"mass",null),KinematicRigidBody}(e.RigidBody);e.KinematicRigidBody=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function StaticRigidBody(){e.apply(this,arguments)}return __extends(StaticRigidBody,e),StaticRigidBody.create=function(){var e=new this;return e},StaticRigidBody.prototype.addBody=function(){this.addBodyToPhysicsEngine("addStaticBody")},StaticRigidBody}(e.RigidBody);e.StaticRigidBody=t}(wd||(wd={}));var wd;!function(e){var t=function(){function PhysicsConstraint(e){this.maxForce=null,this.rigidBody=null,this.rigidBody=e}return PhysicsConstraint.prototype.clone=function(t){return e.CloneUtils.clone(this,null,null,t)},__decorate([e.cloneAttributeAsBasicType()],PhysicsConstraint.prototype,"maxForce",void 0),PhysicsConstraint}();e.PhysicsConstraint=t;var r=function(t){function LockConstraint(){t.apply(this,arguments),this._connectedBody=null}return __extends(LockConstraint,t),LockConstraint.create=function(e){var t=new this(e);return t},Object.defineProperty(LockConstraint.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(e){var t=null;this._connectedBody=e,t=this.rigidBody.getPhysicsEngineAdapter(),t.removeLockConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint()},enumerable:!0,configurable:!0}),__decorate([e.cloneAttributeAsBasicType()],LockConstraint.prototype,"connectedBody",null),LockConstraint}(t);e.LockConstraint=r;var n=function(t){function DistanceConstraint(){t.apply(this,arguments),this._connectedBody=null,this.distance=null}return __extends(DistanceConstraint,t),DistanceConstraint.create=function(e){var t=new this(e);return t},Object.defineProperty(DistanceConstraint.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(e){var t=null;this._connectedBody=e,t=this.rigidBody.getPhysicsEngineAdapter(),t.removeDistanceConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint()},enumerable:!0,configurable:!0}),__decorate([e.cloneAttributeAsBasicType()],DistanceConstraint.prototype,"connectedBody",null),__decorate([e.cloneAttributeAsBasicType()],DistanceConstraint.prototype,"distance",void 0),DistanceConstraint}(t);e.DistanceConstraint=n;var i=function(t){function HingeConstraint(){t.apply(this,arguments),this._connectedBody=null,this.pivotA=null,this.pivotB=null,this.axisA=null,this.axisB=null}return __extends(HingeConstraint,t),HingeConstraint.create=function(e){var t=new this(e);return t},Object.defineProperty(HingeConstraint.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(e){var t=null;this._connectedBody=e,t=this.rigidBody.getPhysicsEngineAdapter(),t.removeHingeConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint()},enumerable:!0,configurable:!0}),__decorate([e.cloneAttributeAsBasicType()],HingeConstraint.prototype,"connectedBody",null),__decorate([e.cloneAttributeAsCloneable()],HingeConstraint.prototype,"pivotA",void 0),__decorate([e.cloneAttributeAsCloneable()],HingeConstraint.prototype,"pivotB",void 0),__decorate([e.cloneAttributeAsCloneable()],HingeConstraint.prototype,"axisA",void 0),__decorate([e.cloneAttributeAsCloneable()],HingeConstraint.prototype,"axisB",void 0),HingeConstraint}(t);e.HingeConstraint=i;var a=function(t){function PointToPointConstraint(){t.apply(this,arguments),this.connectedBody=null,this.pivotA=null,this.pivotB=null}return __extends(PointToPointConstraint,t),PointToPointConstraint.create=function(){var e=new this(null);return e},__decorate([e.cloneAttributeAsBasicType()],PointToPointConstraint.prototype,"connectedBody",void 0),__decorate([e.cloneAttributeAsCloneable()],PointToPointConstraint.prototype,"pivotA",void 0),__decorate([e.cloneAttributeAsCloneable()],PointToPointConstraint.prototype,"pivotB",void 0),PointToPointConstraint}(t);e.PointToPointConstraint=a;var o=function(){function PointToPointConstraintList(e){this._rigidBody=null,this._list=wdCb.Collection.create(),this._rigidBody=e}return PointToPointConstraintList.create=function(e){var t=new this(e);return t},PointToPointConstraintList.prototype.clone=function(t){return e.CloneUtils.clone(this,null,[t])},PointToPointConstraintList.prototype.forEach=function(t,r){void 0===r&&(r=e.root),this._list.forEach(t,r)},PointToPointConstraintList.prototype.getCount=function(){return this._list.getCount()},PointToPointConstraintList.prototype.getChildren=function(){return this._list},PointToPointConstraintList.prototype.getChild=function(e){return this._list.getChild(e)},PointToPointConstraintList.prototype.addChild=function(e){var t=null;this._list.addChild(e),t=this._rigidBody.getPhysicsEngineAdapter(),t.addPointToPointConstraint(this._rigidBody.entityObject,e)},PointToPointConstraintList.prototype.addChildren=function(t){var r=this;if(e.JudgeUtils.isArrayExactly(t))for(var n=0,i=t;n<i.length;n++){var a=i[n];this.addChild(a)}else{var o=t;o.forEach(function(e){r.addChild(e)},this)}},PointToPointConstraintList.prototype.removeChild=function(e){var t=null;this._list.removeChild(e),t=this._rigidBody.getPhysicsEngineAdapter(),t.removePointToPointConstraint(e)},__decorate([e.cloneAttributeAsCustomType(function(e,t,r){t[r]=e[r].clone(!0)})],PointToPointConstraintList.prototype,"_list",void 0),PointToPointConstraintList}();e.PointToPointConstraintList=o}(wd||(wd={}));var wd;!function(e){var t=function(){function PhysicsEngineFactory(){}return PhysicsEngineFactory.createNullAdapter=function(){return e.NullPhysicsEngineAdapter.create()},PhysicsEngineFactory.create=function(t,r){var n=null;if(!t)return e.NullPhysicsEngineAdapter.create();switch(r){case e.EPhysicsEngineType.CANNON:n=e.CannonAdapter.create();break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNEXPECT("physics engine type"))}return n},PhysicsEngineFactory}();e.PhysicsEngineFactory=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.CANNON=0]="CANNON"}(e.EPhysicsEngineType||(e.EPhysicsEngineType={}));e.EPhysicsEngineType}(wd||(wd={}));var wd;!function(e){var t=function(){function NullPhysicsEngineAdapter(){this.world=null}return NullPhysicsEngineAdapter.create=function(){var e=new this;return e},NullPhysicsEngineAdapter.prototype.getGravity=function(e){return null},NullPhysicsEngineAdapter.prototype.setGravity=function(e){},NullPhysicsEngineAdapter.prototype.getFriction=function(e,t){return null},NullPhysicsEngineAdapter.prototype.setFriction=function(e,t){},NullPhysicsEngineAdapter.prototype.getRestitution=function(e,t){return null},NullPhysicsEngineAdapter.prototype.setRestitution=function(e,t){},NullPhysicsEngineAdapter.prototype.getLinearDamping=function(e){return null},NullPhysicsEngineAdapter.prototype.setLinearDamping=function(e,t){},NullPhysicsEngineAdapter.prototype.getAngularDamping=function(e){return null},NullPhysicsEngineAdapter.prototype.setAngularDamping=function(e,t){},NullPhysicsEngineAdapter.prototype.getMass=function(e){return null},NullPhysicsEngineAdapter.prototype.setMass=function(e,t){},NullPhysicsEngineAdapter.prototype.getVelocity=function(e){return null},NullPhysicsEngineAdapter.prototype.setVelocity=function(e,t){},NullPhysicsEngineAdapter.prototype.getAngularVelocity=function(e){return null},NullPhysicsEngineAdapter.prototype.setAngularVelocity=function(e,t){},NullPhysicsEngineAdapter.prototype.init=function(){},NullPhysicsEngineAdapter.prototype.addDynamicBody=function(e,t){},NullPhysicsEngineAdapter.prototype.addKinematicBody=function(e,t){},NullPhysicsEngineAdapter.prototype.addStaticBody=function(e,t){},NullPhysicsEngineAdapter.prototype.addLockConstraint=function(e,t){},NullPhysicsEngineAdapter.prototype.removeLockConstraint=function(e){},NullPhysicsEngineAdapter.prototype.addDistanceConstraint=function(e,t){},NullPhysicsEngineAdapter.prototype.removeDistanceConstraint=function(e){},NullPhysicsEngineAdapter.prototype.addHingeConstraint=function(e,t){},NullPhysicsEngineAdapter.prototype.removeHingeConstraint=function(e){},NullPhysicsEngineAdapter.prototype.addPointToPointConstraint=function(e,t){},NullPhysicsEngineAdapter.prototype.removePointToPointConstraint=function(e){},NullPhysicsEngineAdapter.prototype.removeGameObject=function(e){},NullPhysicsEngineAdapter.prototype.removeConstraints=function(e){},NullPhysicsEngineAdapter.prototype.update=function(e){},NullPhysicsEngineAdapter}();e.NullPhysicsEngineAdapter=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CannonDataList(){this.dataList=wdCb.Collection.create()}return CannonDataList.prototype.getCount=function(){return this.dataList.getCount()},CannonDataList.prototype.removeByGameObject=function(t){this.dataList.removeChild(function(r){var n=r.entityObject;r.body;return e.JudgeUtils.isEqual(n,t)})},CannonDataList}();e.CannonDataList=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CannonGameObjectDataList(){t.apply(this,arguments)}return __extends(CannonGameObjectDataList,t),CannonGameObjectDataList.create=function(){var e=new this;return e},CannonGameObjectDataList.prototype.remove=function(e){this.removeByGameObject(e)},CannonGameObjectDataList.prototype.updateBodyTransformData=function(){this.dataList.forEach(function(t){var r=t.entityObject,n=t.body,i=r.transform;(i.isTranslate||i.isRotate)&&(n.position=e.CannonUtils.convertToCannonVector3(r.transform.position),n.quaternion=e.CannonUtils.convertToCannonQuaternion(r.transform.rotation))})},CannonGameObjectDataList.prototype.updateGameObjectTransformData=function(){this.dataList.forEach(function(t){var r=t.entityObject,n=t.body;r.hasTag("isRigidbodyChild")||(r.transform.position=e.CannonUtils.convertToWonderVector3(n.position),r.transform.rotation=e.CannonUtils.convertToWonderQuaternion(n.quaternion))})},CannonGameObjectDataList.prototype.add=function(e,t){this.dataList.addChild({entityObject:e,body:t})},CannonGameObjectDataList.prototype.findGameObjectByBody=function(e){var t=this.dataList.findOne(function(t){var r=(t.entityObject,t.body);return r===e});return null!==t?t.entityObject:null},CannonGameObjectDataList.prototype.findBodyByGameObject=function(t){var r=this.dataList.findOne(function(r){var n=r.entityObject;r.body;return e.JudgeUtils.isEqual(n,t)});return null!==r?r.body:null},CannonGameObjectDataList}(e.CannonDataList);e.CannonGameObjectDataList=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CannonMaterialList(){t.apply(this,arguments)}return __extends(CannonMaterialList,t),CannonMaterialList.create=function(){var e=new this;return e},CannonMaterialList.prototype.remove=function(e){this.removeByGameObject(e)},CannonMaterialList.prototype.findMaterialByGameObject=function(t){var r=this.dataList.findOne(function(r){var n=r.entityObject;r.material;return e.JudgeUtils.isEqual(n,t)});return null!==r?r.material:null},CannonMaterialList.prototype.add=function(e,t){this.dataList.addChild({entityObject:e,material:t})},CannonMaterialList.prototype.addContactMaterial=function(e,t,r,n){this.dataList.forEach(function(i){var a=(i.entityObject,i.material);e.addContactMaterial(new CANNON.ContactMaterial(a,t,{friction:r,restitution:n}))})},CannonMaterialList.prototype.getContactMaterialData=function(e,t,r){var n=null;return this.dataList.forEach(function(i){var a=(i.entityObject,i.material),o=e.getContactMaterial(a,t);if(o)return n=o[r],wdCb.$BREAK}),n},CannonMaterialList.prototype.getContactMaterials=function(e,t){var r=[];return this.dataList.forEach(function(n){var i=(n.entityObject,n.material),a=e.getContactMaterial(i,t);a&&r.push(a)}),r},CannonMaterialList.prototype.setContactMaterialData=function(e,t,r,n){this.dataList.forEach(function(i){var a=(i.entityObject,i.material),o=e.getContactMaterial(a,t);o&&(o[r]=n)})},CannonMaterialList}(e.CannonDataList);e.CannonMaterialList=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CannonConstraintDataList(){e.apply(this,arguments)}return __extends(CannonConstraintDataList,e),CannonConstraintDataList}(e.CannonDataList);e.CannonConstraintDataList=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CannonSingleConstraintDataList(){t.apply(this,arguments)}return __extends(CannonSingleConstraintDataList,t),CannonSingleConstraintDataList.prototype.add=function(e,t){this.dataList.addChild({entityObject:e,constraint:t})},CannonSingleConstraintDataList.prototype.remove=function(e){this.removeByGameObject(e)},CannonSingleConstraintDataList.prototype.findConstraintByGameObject=function(t){var r=this.dataList.findOne(function(r){var n=r.entityObject;return e.JudgeUtils.isEqual(n,t)});return null!==r?r.constraint:null},CannonSingleConstraintDataList}(e.CannonConstraintDataList);e.CannonSingleConstraintDataList=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CannonLockConstraintDataList(){e.apply(this,arguments)}return __extends(CannonLockConstraintDataList,e),CannonLockConstraintDataList.create=function(){var e=new this;return e},CannonLockConstraintDataList}(e.CannonSingleConstraintDataList);e.CannonLockConstraintDataList=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CannonPointToPointConstraintDataList(){t.apply(this,arguments)}return __extends(CannonPointToPointConstraintDataList,t),CannonPointToPointConstraintDataList.create=function(){var e=new this;return e},CannonPointToPointConstraintDataList.prototype.filter=function(e){return this.dataList.filter(e)},CannonPointToPointConstraintDataList.prototype.forEach=function(e){this.dataList.forEach(e)},CannonPointToPointConstraintDataList.prototype.add=function(e,t,r){this.dataList.addChild({entityObject:e,pointToPointConstraint:t,cannonConstraint:r})},CannonPointToPointConstraintDataList.prototype.remove=function(t){this.dataList.removeChild(function(r){var n=r.pointToPointConstraint;return e.JudgeUtils.isEqual(n,t)})},CannonPointToPointConstraintDataList.prototype.findCannonConstraintByPointToPointConstraint=function(t){var r=this.dataList.findOne(function(r){var n=r.pointToPointConstraint;return e.JudgeUtils.isEqual(n,t)});return null!==r?r.cannonConstraint:null},CannonPointToPointConstraintDataList}(e.CannonConstraintDataList);e.CannonPointToPointConstraintDataList=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CannonDistanceConstraintDataList(){e.apply(this,arguments)}return __extends(CannonDistanceConstraintDataList,e),CannonDistanceConstraintDataList.create=function(){var e=new this;return e},CannonDistanceConstraintDataList}(e.CannonSingleConstraintDataList);e.CannonDistanceConstraintDataList=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CannonHingeConstraintDataList(){e.apply(this,arguments)}return __extends(CannonHingeConstraintDataList,e),CannonHingeConstraintDataList.create=function(){var e=new this;return e},CannonHingeConstraintDataList}(e.CannonSingleConstraintDataList);e.CannonHingeConstraintDataList=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CannonUtils(){}return CannonUtils.convertToCannonVector3=function(e){return new CANNON.Vec3(e.x,e.y,e.z)},CannonUtils.convertToCannonQuaternion=function(e){return new CANNON.Quaternion(e.x,e.y,e.z,e.w)},CannonUtils.convertToWonderVector3=function(t){return e.Vector3.create(t.x,t.y,t.z)},CannonUtils.convertToWonderQuaternion=function(t){return e.Quaternion.create(t.x,t.y,t.z,t.w)},CannonUtils}();e.CannonUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CannonAdapter(){this.world=null,this._materialList=e.CannonMaterialList.create(),this._gameObjectDataList=e.CannonGameObjectDataList.create(),this._lockConstraintDataList=e.CannonLockConstraintDataList.create(),this._distanceConstraintDataList=e.CannonDistanceConstraintDataList.create(),this._hingeConstraintDataList=e.CannonHingeConstraintDataList.create(),this._pointToPointConstraintDataList=e.CannonPointToPointConstraintDataList.create(),this._dynamicBody=null,this._kinematicBody=null,this._staticBody=null,this._lockConstraint=null,this._distanceConstraint=null,this._hingeConstraint=null,this._pointToPointConstraint=null}return CannonAdapter.create=function(){var e=new this;return e},CannonAdapter.prototype.getGravity=function(t){return e.CannonUtils.convertToWonderVector3(this.world.gravity)},CannonAdapter.prototype.setGravity=function(t){this.world.gravity=e.CannonUtils.convertToCannonVector3(t)},CannonAdapter.prototype.getFriction=function(e,t){return this._getMaterialData(e,"friction")},CannonAdapter.prototype.setFriction=function(e,t){this._setMaterialData(e,"friction",t)},CannonAdapter.prototype.getRestitution=function(e,t){return this._getMaterialData(e,"restitution")},CannonAdapter.prototype.setRestitution=function(e,t){this._setMaterialData(e,"restitution",t)},CannonAdapter.prototype.getLinearDamping=function(e){return this._getNumberData(e,"linearDamping")},CannonAdapter.prototype.setLinearDamping=function(e,t){return this._setNumberData(e,"linearDamping",t)},CannonAdapter.prototype.getAngularDamping=function(e){return this._getNumberData(e,"angularDamping")},CannonAdapter.prototype.setAngularDamping=function(e,t){return this._setNumberData(e,"angularDamping",t)},CannonAdapter.prototype.getMass=function(e){return this._getNumberData(e,"mass")},CannonAdapter.prototype.setMass=function(e,t){return this._setNumberData(e,"mass",t)},CannonAdapter.prototype.getVelocity=function(e){return this._getVec3Data(e,"velocity")},CannonAdapter.prototype.setVelocity=function(e,t){this._setVec3Data(e,"velocity",t)},CannonAdapter.prototype.getAngularVelocity=function(e){return this._getVec3Data(e,"angularVelocity")},CannonAdapter.prototype.setAngularVelocity=function(e,t){this._setVec3Data(e,"angularVelocity",t)},CannonAdapter.prototype.init=function(){var t=e.Director.getInstance().scene.physics,r=t.gravity,n=t.iterations;this.world=new CANNON.World,this.world.broadphase=new CANNON.NaiveBroadphase,this.world.solver.iterations=n,this.world.gravity.set(r.x,r.y,r.z),this._dynamicBody=e.CannonDynamicBody.create(this.world,this._gameObjectDataList,this._materialList),this._kinematicBody=e.CannonKinematicBody.create(this.world,this._gameObjectDataList,this._materialList),this._staticBody=e.CannonStaticBody.create(this.world,this._gameObjectDataList,this._materialList),this._lockConstraint=e.CannonLockConstraint.create(this.world,this._gameObjectDataList,this._lockConstraintDataList),this._distanceConstraint=e.CannonDistanceConstraint.create(this.world,this._gameObjectDataList,this._distanceConstraintDataList),this._hingeConstraint=e.CannonHingeConstraint.create(this.world,this._gameObjectDataList,this._hingeConstraintDataList),this._pointToPointConstraint=e.CannonPointToPointConstraint.create(this.world,this._gameObjectDataList,this._pointToPointConstraintDataList)},CannonAdapter.prototype.addDynamicBody=function(e,t){this._dynamicBody.addBody(e,t)},CannonAdapter.prototype.addKinematicBody=function(e,t){this._kinematicBody.addBody(e,t)},CannonAdapter.prototype.addStaticBody=function(e,t){this._staticBody.addBody(e,t)},CannonAdapter.prototype.addLockConstraint=function(e,t){this._lockConstraint.addConstraint(e,t)},CannonAdapter.prototype.removeLockConstraint=function(e){this._lockConstraint.removeConstraint(e)},CannonAdapter.prototype.addDistanceConstraint=function(e,t){this._distanceConstraint.addConstraint(e,t)},CannonAdapter.prototype.removeDistanceConstraint=function(e){this._distanceConstraint.removeConstraint(e)},CannonAdapter.prototype.addHingeConstraint=function(e,t){this._hingeConstraint.addConstraint(e,t)},CannonAdapter.prototype.removeHingeConstraint=function(e){this._hingeConstraint.removeConstraint(e)},CannonAdapter.prototype.addPointToPointConstraint=function(e,t){this._pointToPointConstraint.addConstraint(e,t)},CannonAdapter.prototype.removePointToPointConstraint=function(e){this._pointToPointConstraint.removeConstraint(e)},CannonAdapter.prototype.removeGameObject=function(e){var t=(this._getMaterial(e),this._gameObjectDataList.findBodyByGameObject(e));t&&this.world.remove(t),this._gameObjectDataList.remove(e),this._materialList.remove(e)},CannonAdapter.prototype.removeConstraints=function(t){var r=this;this._lockConstraint.removeConstraint(t),this._distanceConstraint.removeConstraint(t),this._hingeConstraint.removeConstraint(t),this._pointToPointConstraintDataList.filter(function(r){var n=r.entityObject;return e.JudgeUtils.isEqual(n,t)}).forEach(function(e){var t=e.pointToPointConstraint;r._pointToPointConstraint.removeConstraint(t)})},CannonAdapter.prototype.update=function(t){this._gameObjectDataList.updateBodyTransformData(),this.world.step(e.Director.getInstance().getDeltaTime()/1e3),this._gameObjectDataList.updateGameObjectTransformData()},CannonAdapter.prototype._getMaterial=function(e){return this._materialList.findMaterialByGameObject(e)},CannonAdapter.prototype._getNumberData=function(e,t){var r=this._gameObjectDataList.findBodyByGameObject(e);return r?r[t]:null},CannonAdapter.prototype._setNumberData=function(e,t,r){var n=this._gameObjectDataList.findBodyByGameObject(e);return n?void(n[t]=r):null},CannonAdapter.prototype._getVec3Data=function(t,r){var n=this._gameObjectDataList.findBodyByGameObject(t);return n?e.CannonUtils.convertToWonderVector3(n[r]):null},CannonAdapter.prototype._setVec3Data=function(t,r,n){var i=this._gameObjectDataList.findBodyByGameObject(t);return i?void(i[r]=e.CannonUtils.convertToCannonVector3(n)):null},CannonAdapter.prototype._getMaterialData=function(e,t){var r=this._getMaterial(e);return r?this._materialList.getContactMaterialData(this.world,r,t):null},CannonAdapter.prototype._setMaterialData=function(t,r,n){var i=(this.world,this._getMaterial(t));return i?void this._materialList.setContactMaterialData(this.world,i,r,n):void e.Log.warn("no material find, please add material first")},__decorate([e.require(function(t,r){var n=[],i=null,a=this._getMaterial(t);if(!a)return null;n=this._materialList.getContactMaterials(this.world,a),i=n[0];for(var o=0,s=n;o<s.length;o++){var c=s[o];e.assert(c===i,e.Log.info.FUNC_SHOULD("the data of contact material which contains the same material","be the same"))}})],CannonAdapter.prototype,"_getMaterialData",null),CannonAdapter}();e.CannonAdapter=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CannonBody(e,t,r){this.world=null,this.materialList=null,this.gameObjectList=null,this.world=e,this.gameObjectList=t,this.materialList=r}return CannonBody.prototype.addBody=function(t,r){var n=this.createBody(r);return r.children.getCount()>0?this._addCompounds(t,r.children,n):n.addShape(this._createShape(t.getComponent(e.Collider).shape)),this.afterAddShape(n,r),n.material=this._createMaterial(t,r.friction,r.restitution),n.position=e.CannonUtils.convertToCannonVector3(r.position),n.quaternion=e.CannonUtils.convertToCannonQuaternion(r.rotation),this.world.addBody(n),this.gameObjectList.add(t,n),this._bindCollideEvent(n,r.onCollisionStart,r.onContact,r.onCollisionEnd),n},CannonBody.prototype.afterAddShape=function(e,t){},CannonBody.prototype._createShape=function(t){var r=null;return t instanceof e.AABBShape?r=new CANNON.Box(e.CannonUtils.convertToCannonVector3(t.halfExtents)):t instanceof e.SphereShape&&(r=new CANNON.Sphere(t.radius)),r},CannonBody.prototype._bindCollideEvent=function(e,t,r,n){var i=this;e.addEventListener("collide",function(e){var a=i.gameObjectList.findGameObjectByBody(e.body),o=null;a&&(o=a,t(o),r(o),n(o))})},CannonBody.prototype._createMaterial=function(e,t,r){var n=null,i=null;return(n=this._getMaterial(e))?n:(i=new CANNON.Material("material"),this._addMaterial(e,i,t,r),i)},CannonBody.prototype._getMaterial=function(e){return this.materialList.findMaterialByGameObject(e)},CannonBody.prototype._addMaterial=function(e,t,r,n){this.materialList.add(e,t),this.materialList.addContactMaterial(this.world,t,r,n)},CannonBody.prototype._addCompounds=function(t,r,n){var i=this,a=t.transform.position,o=t.transform.rotation;r.forEach(function(t){n.addShape(i._createShape(t.getComponent(e.Collider).shape),e.CannonUtils.convertToCannonVector3(t.transform.position.clone().sub(a)),e.CannonUtils.convertToCannonQuaternion(t.transform.rotation.clone().sub(o)))},this)},__decorate([e.virtual],CannonBody.prototype,"afterAddShape",null),__decorate([e.require(function(t,r,n){r.forEach(function(t){e.assert(!!t.getComponent(e.Collider),e.Log.info.FUNC_MUST_DEFINE("collider component")),e.assert(!!t.getComponent(e.Collider).shape,e.Log.info.FUNC_SHOULD("create collider.shape"))})})],CannonBody.prototype,"_addCompounds",null),CannonBody}();e.CannonBody=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CannonDynamicBody(){t.apply(this,arguments)}return __extends(CannonDynamicBody,t),
CannonDynamicBody.create=function(e,t,r){var n=new this(e,t,r);return n},CannonDynamicBody.prototype.createBody=function(t){var r=t.mass,n=t.linearDamping,i=t.angularDamping,a=t.velocity,o=t.angularVelocity;return new CANNON.Body({mass:r,linearDamping:n,angularDamping:i,velocity:e.CannonUtils.convertToCannonVector3(a),angularVelocity:e.CannonUtils.convertToCannonVector3(o)})},CannonDynamicBody.prototype.afterAddShape=function(t,r){var n=r.impulse,i=r.force,a=r.hitPoint;n&&a&&t.applyImpulse(e.CannonUtils.convertToCannonVector3(n),e.CannonUtils.convertToCannonVector3(a)),i&&a&&t.applyForce(e.CannonUtils.convertToCannonVector3(i),e.CannonUtils.convertToCannonVector3(a))},CannonDynamicBody}(e.CannonBody);e.CannonDynamicBody=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CannonKinematicBody(){t.apply(this,arguments)}return __extends(CannonKinematicBody,t),CannonKinematicBody.create=function(e,t,r){var n=new this(e,t,r);return n},CannonKinematicBody.prototype.createBody=function(t){var r=t.mass,n=t.velocity,i=t.angularVelocity;return new CANNON.Body({type:CANNON.Body.KINEMATIC,mass:r,velocity:e.CannonUtils.convertToCannonVector3(n),angularVelocity:e.CannonUtils.convertToCannonVector3(i)})},CannonKinematicBody}(e.CannonBody);e.CannonKinematicBody=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CannonStaticBody(){e.apply(this,arguments)}return __extends(CannonStaticBody,e),CannonStaticBody.create=function(e,t,r){var n=new this(e,t,r);return n},CannonStaticBody.prototype.createBody=function(e){return new CANNON.Body({mass:0})},CannonStaticBody}(e.CannonBody);e.CannonStaticBody=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CannonConstraint(e,t,r){this.world=null,this.gameObjectList=null,this.constraintDataList=null,this.world=e,this.gameObjectList=t,this.constraintDataList=r}return CannonConstraint.prototype.addConstraint=function(e,t){var r=null,n=this.gameObjectList.findBodyByGameObject(e);r=this.createCannonConstraint(n,t),this.world.addConstraint(r),this.addToConstraintDataList(e,t,r)},CannonConstraint.prototype.findBody=function(e){return this.gameObjectList.findBodyByGameObject(e.entityObject)},__decorate([e.require(function(t,r){e.assert(null!==this.gameObjectList.findBodyByGameObject(t),e.Log.info.FUNC_SHOULD("add rigid body")),e.assert(this.findBody(r.connectedBody),e.Log.info.FUNC_SHOULD("add connectedBody"))})],CannonConstraint.prototype,"addConstraint",null),CannonConstraint}();e.CannonConstraint=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CannonSingleConstraint(){e.apply(this,arguments)}return __extends(CannonSingleConstraint,e),CannonSingleConstraint.prototype.removeConstraint=function(e){var t=this.constraintDataList.findConstraintByGameObject(e);t&&this.world.removeConstraint(t),this.constraintDataList.remove(e)},CannonSingleConstraint.prototype.addToConstraintDataList=function(e,t,r){this.constraintDataList.add(e,r)},CannonSingleConstraint}(e.CannonConstraint);e.CannonSingleConstraint=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CannonLockConstraint(){e.apply(this,arguments)}return __extends(CannonLockConstraint,e),CannonLockConstraint.create=function(e,t,r){var n=new this(e,t,r);return n},CannonLockConstraint.prototype.createCannonConstraint=function(e,t){var r=null,n=this.findBody(t.connectedBody);return r=t.maxForce?new CANNON.LockConstraint(e,n,t.maxForce):new CANNON.LockConstraint(e,n)},CannonLockConstraint}(e.CannonSingleConstraint);e.CannonLockConstraint=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CannonPointToPointConstraint(){t.apply(this,arguments)}return __extends(CannonPointToPointConstraint,t),CannonPointToPointConstraint.create=function(e,t,r){var n=new this(e,t,r);return n},CannonPointToPointConstraint.prototype.removeConstraint=function(e){var t=this.constraintDataList.findCannonConstraintByPointToPointConstraint(e);t&&this.world.removeConstraint(t),this.constraintDataList.remove(e)},CannonPointToPointConstraint.prototype.createCannonConstraint=function(t,r){var n=null,i=this.findBody(r.connectedBody),a=e.CannonUtils.convertToCannonVector3(r.pivotA),o=e.CannonUtils.convertToCannonVector3(r.pivotB);return n=r.maxForce?new CANNON.PointToPointConstraint(t,a,i,o,r.maxForce):new CANNON.PointToPointConstraint(t,a,i,o)},CannonPointToPointConstraint.prototype.addToConstraintDataList=function(e,t,r){this.constraintDataList.add(e,t,r)},CannonPointToPointConstraint}(e.CannonConstraint);e.CannonPointToPointConstraint=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CannonDistanceConstraint(){e.apply(this,arguments)}return __extends(CannonDistanceConstraint,e),CannonDistanceConstraint.create=function(e,t,r){var n=new this(e,t,r);return n},CannonDistanceConstraint.prototype.createCannonConstraint=function(e,t){var r=null,n=this.findBody(t.connectedBody);return r=new CANNON.DistanceConstraint(e,n,null!==t.distance?t.distance:void 0,null!==t.maxForce?t.maxForce:void 0)},CannonDistanceConstraint}(e.CannonSingleConstraint);e.CannonDistanceConstraint=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CannonHingeConstraint(){t.apply(this,arguments)}return __extends(CannonHingeConstraint,t),CannonHingeConstraint.create=function(e,t,r){var n=new this(e,t,r);return n},CannonHingeConstraint.prototype.createCannonConstraint=function(t,r){var n=null,i=this.findBody(r.connectedBody),a=e.CannonUtils.convertToCannonVector3(r.pivotA),o=e.CannonUtils.convertToCannonVector3(r.axisA),s=e.CannonUtils.convertToCannonVector3(r.pivotB),c=e.CannonUtils.convertToCannonVector3(r.axisB),u={};return r.pivotA&&(u.pivotA=a),r.axisA&&(u.axisA=o),r.pivotB&&(u.pivotB=s),r.axisB&&(u.axisB=c),r.maxForce&&(u.maxForce=r.maxForce),n=new CANNON.HingeConstraint(t,i,u)},CannonHingeConstraint}(e.CannonSingleConstraint);e.CannonHingeConstraint=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Light(){t.apply(this,arguments),this._shadowMapWidth=null,this._shadowMapHeight=null,this.color=e.Color.create("#ffffff"),this.castShadow=!1,this.shadowCameraNear=.1,this.shadowCameraFar=5e3,this.shadowBias=e.ShaderChunk.NULL,this.shadowDarkness=0}return __extends(Light,t),Object.defineProperty(Light.prototype,"position",{get:function(){return this.entityObject.transform.position},enumerable:!0,configurable:!0}),Object.defineProperty(Light.prototype,"shadowMapWidth",{get:function(){var t=e.GPUDetector.getInstance().maxCubemapTextureSize;return!this._shadowMapWidth||this._shadowMapWidth>t?t:this._shadowMapWidth},set:function(e){this._shadowMapWidth=e},enumerable:!0,configurable:!0}),Object.defineProperty(Light.prototype,"shadowMapHeight",{get:function(){var t=e.GPUDetector.getInstance().maxCubemapTextureSize;return!this._shadowMapHeight||this._shadowMapHeight>t?t:this._shadowMapHeight},set:function(e){this._shadowMapHeight=e},enumerable:!0,configurable:!0}),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"shadowMapWidth",null),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"shadowMapHeight",null),__decorate([e.cloneAttributeAsCloneable()],Light.prototype,"color",void 0),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"castShadow",void 0),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"shadowCameraNear",void 0),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"shadowCameraFar",void 0),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"shadowBias",void 0),__decorate([e.cloneAttributeAsBasicType()],Light.prototype,"shadowDarkness",void 0),Light}(e.Component);e.Light=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function AmbientLight(){e.apply(this,arguments)}return __extends(AmbientLight,e),AmbientLight.create=function(){var e=new this;return e},AmbientLight.type="ambientLight",AmbientLight}(e.Light);e.AmbientLight=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SourceLight(){t.apply(this,arguments),this.intensity=1}return __extends(SourceLight,t),__decorate([e.cloneAttributeAsBasicType()],SourceLight.prototype,"intensity",void 0),SourceLight}(e.Light);e.SourceLight=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DirectionLight(){t.apply(this,arguments),this.shadowCameraLeft=-1e3,this.shadowCameraRight=1e3,this.shadowCameraTop=1e3,this.shadowCameraBottom=-1e3}return __extends(DirectionLight,t),DirectionLight.create=function(){var e=new this;return e},DirectionLight.type="directionLight",DirectionLight.defaultPosition=e.Vector3.create(0,0,1),__decorate([e.cloneAttributeAsBasicType()],DirectionLight.prototype,"shadowCameraLeft",void 0),__decorate([e.cloneAttributeAsBasicType()],DirectionLight.prototype,"shadowCameraRight",void 0),__decorate([e.cloneAttributeAsBasicType()],DirectionLight.prototype,"shadowCameraTop",void 0),__decorate([e.cloneAttributeAsBasicType()],DirectionLight.prototype,"shadowCameraBottom",void 0),DirectionLight}(e.SourceLight);e.DirectionLight=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function PointLight(){t.apply(this,arguments),this._rangeLevel=null,this._attenuation=e.Attenuation.create()}return __extends(PointLight,t),PointLight.create=function(){var e=new this;return e},Object.defineProperty(PointLight.prototype,"rangeLevel",{get:function(){return this._rangeLevel},set:function(e){this._rangeLevel=e,this._attenuation.rangeLevel=this._rangeLevel},enumerable:!0,configurable:!0}),Object.defineProperty(PointLight.prototype,"range",{get:function(){return this._attenuation.range},set:function(e){this._attenuation.range=e},enumerable:!0,configurable:!0}),Object.defineProperty(PointLight.prototype,"constant",{get:function(){return this._attenuation.constant},set:function(e){this._attenuation.constant=e},enumerable:!0,configurable:!0}),Object.defineProperty(PointLight.prototype,"linear",{get:function(){return this._attenuation.linear},set:function(e){this._attenuation.linear=e},enumerable:!0,configurable:!0}),Object.defineProperty(PointLight.prototype,"quadratic",{get:function(){return this._attenuation.quadratic},set:function(e){this._attenuation.quadratic=e},enumerable:!0,configurable:!0}),PointLight.type="pointLight",__decorate([e.cloneAttributeAsBasicType()],PointLight.prototype,"rangeLevel",null),__decorate([e.cloneAttributeAsBasicType()],PointLight.prototype,"range",null),__decorate([e.cloneAttributeAsBasicType()],PointLight.prototype,"constant",null),__decorate([e.cloneAttributeAsBasicType()],PointLight.prototype,"linear",null),__decorate([e.cloneAttributeAsBasicType()],PointLight.prototype,"quadratic",null),PointLight}(e.SourceLight);e.PointLight=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Attenuation(){this._constant=1,this._range=null,this._linear=0,this._quadratic=0,this._rangeLevel=0}return Attenuation.create=function(){var e=new this;return e},Object.defineProperty(Attenuation.prototype,"constant",{get:function(){return this._constant},set:function(e){this._constant=e},enumerable:!0,configurable:!0}),Object.defineProperty(Attenuation.prototype,"range",{get:function(){return this._range},set:function(e){this._range=e},enumerable:!0,configurable:!0}),Object.defineProperty(Attenuation.prototype,"linear",{get:function(){return this._linear},set:function(e){this._linear=e},enumerable:!0,configurable:!0}),Object.defineProperty(Attenuation.prototype,"quadratic",{get:function(){return this._quadratic},set:function(e){this._quadratic=e},enumerable:!0,configurable:!0}),Object.defineProperty(Attenuation.prototype,"rangeLevel",{get:function(){return this._rangeLevel},set:function(e){e&&(this._rangeLevel=e,this.setByRangeLevel())},enumerable:!0,configurable:!0}),Attenuation.prototype.setByRangeLevel=function(){switch(this._rangeLevel){case 0:this._range=7,this._linear=.7,this._quadratic=1.8;break;case 1:this._range=13,this._linear=.35,this._quadratic=.44;break;case 2:this._range=20,this._linear=.22,this._quadratic=.2;break;case 3:this._range=32,this._linear=.14,this._quadratic=.07;break;case 4:this._range=50,this._linear=.09,this._quadratic=.032;break;case 5:this._range=65,this._linear=.07,this._quadratic=.017;break;case 6:this._range=100,this._linear=.045,this._quadratic=.0075;break;case 7:this._range=160,this._linear=.027,this._quadratic=.0028;break;case 8:this._range=200,this._linear=.022,this._quadratic=.0019;break;case 9:this._range=325,this._linear=.014,this._quadratic=7e-4;break;case 10:this._range=600,this._linear=.007,this._quadratic=2e-4;break;case 11:this._range=3250,this._linear=.0014,this._quadratic=7e-6;break;default:e.Log.error(!0,"over light range")}},Attenuation}();e.Attenuation=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.PHONG="PHONG"]="PHONG",e[e.BLINN="BLINN"]="BLINN",e[e.LAMBERT="LAMBERT"]="LAMBERT",e[e.CONSTANT="CONSTANT"]="CONSTANT"}(e.ELightModel||(e.ELightModel={}));e.ELightModel}(wd||(wd={}));var wd;!function(e){var t=function(){function BitmapFontLayout(){this._layoutList=wdCb.Collection.create(),this._searchGlyph=e.BitmapFontSearchGlyph.create()}return BitmapFontLayout.create=function(){var e=new this;return e},BitmapFontLayout.prototype.getLayoutData=function(t,r,n){var i=n.width,a=void 0===i?0:i,o=n.tabSize,s=void 0===o?4:o,c=n.letterSpacing,u=void 0===c?0:c,l=n.align,d=void 0===l?e.EFontXAlignment.LEFT:l,h=this._getFntObj(r);if(!h)return void e.Log.log("impossible to create font: not find fnt file");this._searchGlyph.setupSpaceGlyphs(h,s);var p=e.BitmapFontWordWrapper.getLines(h,t,this._searchGlyph,{width:a,letterSpacing:u}),f=a,m=null,g=0,_=0,y=h.commonHeight;h.commonBase;this._layoutList.removeAllChildren(),m=p.reduce(function(e,t){return Math.max(e,t.width,f)},0);for(var v=0,b=p.length;v<b;v++){for(var C=p[v],S=C.start,T=C.end,E=C.width,M=null,w=S;w<T;w++){var L=t.charCodeAt(w),D=this._searchGlyph.getGlyph(h,L),x=null;D&&(M&&(g+=e.BitmapFontParser.getKerning(h,M.id,D.id)),x=g,d===e.EFontXAlignment.CENTER?x+=(m-E)/2:d===e.EFontXAlignment.RIGHT&&(x+=m-E),this._layoutList.addChild({position:[x+D.xOffset,_+D.yOffset],data:D,index:w,line:v}),g+=D.xAdvance+u,M=D)}_+=y,g=0}return this._layoutList},BitmapFontLayout.prototype._getFntObj=function(t){return e.LoaderManager.getInstance().get(t)},BitmapFontLayout}();e.BitmapFontLayout=t}(wd||(wd={}));var wd;!function(e){var t=function(){function BitmapFontParser(){}return BitmapFontParser.getKerning=function(e,t,r){if(!e.kerningArray||0===e.kerningArray.length)return 0;for(var n=e.kerningArray,i=0;i<n.length;i++){var a=n[i];if(a.first===t&&a.second===r)return a.amount}return 0},BitmapFontParser}();e.BitmapFontParser=t}(wd||(wd={}));var wd;!function(e){var t=["m","w"],r="\t".charCodeAt(0),n=" ".charCodeAt(0),i=function(){function BitmapFontSearchGlyph(){this._fallbackSpaceGlyph=null,this._fallbackTabGlyph=null}return BitmapFontSearchGlyph.create=function(){var e=new this;return e},BitmapFontSearchGlyph.prototype.getGlyph=function(e,t){var i=this.getGlyphById(e,t);return i?i:t===r?this._fallbackTabGlyph:t===n?this._fallbackSpaceGlyph:null},BitmapFontSearchGlyph.prototype.getGlyphById=function(e,t){var r=this._getFontDefDictionary(e);return r?r[String(t)]:null},BitmapFontSearchGlyph.prototype.setupSpaceGlyphs=function(e,t){if(this._getFontDefDictionary(e)){var i=this.getGlyphById(e,n)||this._getMGlyph(e)||this._getFirstGlyph(e),a=t*i.xAdvance;this._fallbackSpaceGlyph=i,this._fallbackTabGlyph={id:String(r),page:0,rect:{x:0,y:0,width:0,height:0},xOffset:0,yOffset:0,xAdvance:a}}},BitmapFontSearchGlyph.prototype._getMGlyph=function(e){for(var r=null,n=0;n<t.length;n++){var i=t[n].charCodeAt(0),a=this.getGlyphById(e,i);if(a)break}return r},BitmapFontSearchGlyph.prototype._getFirstGlyph=function(e){var t=this._getFontDefDictionary(e),r=null;for(var n in t){r=t[n];break}return r},BitmapFontSearchGlyph.prototype._getFontDefDictionary=function(e){return e.fontDefDictionary},BitmapFontSearchGlyph}();e.BitmapFontSearchGlyph=i}(wd||(wd={}));var wd;!function(e){var t="\n",r=/\s/,n=function(){function BitmapFontWordWrapper(){}return BitmapFontWordWrapper.getLines=function(e,t,r,n){var i=n.letterSpacing,a=n.width,o=void 0===a?Number.MAX_VALUE:a,s=n.start,c=void 0===s?0:s,u=n.end,l=void 0===u?t.length:u;return this._greedy(e,t,i,r,c,l,o)},BitmapFontWordWrapper._greedy=function(e,r,n,i,a,o,s){for(var c=[],u=s;a<o&&a<r.length;){for(var l=this._findNewLineIndex(r,t,a,o);a<l&&this._isWhitespace(r.charAt(a));)a++;var d=this._computeMetrics(e,r,n,i,a,l,u),h=a+(d.end-d.start),p=h+t.length;if(h<l){for(;h>a&&!this._isWhitespace(r.charAt(h));)h--;if(h===a)p>a+t.length&&p--,h=p;else for(p=h;h>a&&this._isWhitespace(r.charAt(h-t.length));)h--}h>=a&&c.push(this._computeMetrics(e,r,n,i,a,h,u)),a=p}return c},BitmapFontWordWrapper._computeMetrics=function(t,r,n,i,a,o,s){var c=0,u=0,l=0,d=null;if(!t.fontDefDictionary)return{start:a,end:a,width:0};o=Math.min(r.length,o);for(var h=a;h<o;h++){var p=r.charCodeAt(h),f=i.getGlyph(t,p);if(f){var m=d?e.BitmapFontParser.getKerning(t,d.id,f.id):0,g=null,_=null;if(c+=m,g=c+f.xAdvance+n,_=c+f.rect.width,_>s||g>s){0===l&&(l=1,u=_);break}c=g,u=_,d=f}l++}return d&&(u+=d.xOffset),{start:a,end:a+l,width:u}},BitmapFontWordWrapper._findNewLineIndex=function(e,t,r,n){var i=e.indexOf(t,r);return i===-1||i>n?n:i},BitmapFontWordWrapper._isWhitespace=function(e){return r.test(e)},BitmapFontWordWrapper}();e.BitmapFontWordWrapper=n}(wd||(wd={}));var wd;!function(e){var t=function(t){function ThreeDUI(){t.apply(this,arguments)}return __extends(ThreeDUI,t),ThreeDUI.prototype.update=function(e){},ThreeDUI.prototype.addToObject=function(r,n){void 0===n&&(n=!1);var i=e.ThreeDUIEngine.getInstance();t.prototype.addToObject.call(this,r,n),i.hasChild(this)||i.addChild(this)},ThreeDUI.prototype.removeFromObject=function(r){t.prototype.removeFromObject.call(this,r),e.ThreeDUIEngine.getInstance().removeChild(this)},__decorate([e.virtual],ThreeDUI.prototype,"update",null),__decorate([e.require(function(t){e.expect(t).instanceOf(e.GameObject)})],ThreeDUI.prototype,"addToObject",null),ThreeDUI}(e.Component);e.ThreeDUI=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function Line(){e.apply(this,arguments)}return __extends(Line,e),Line}(e.ThreeDUI);e.Line=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function SolidLine(){e.apply(this,arguments)}return __extends(SolidLine,e),SolidLine.create=function(){var e=new this;return e},SolidLine}(e.Line);e.SolidLine=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function DashLine(){e.apply(this,arguments)}return __extends(DashLine,e),DashLine.create=function(){var e=new this;return e},DashLine}(e.Line);e.DashLine=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function Arrow(){e.apply(this,arguments)}return __extends(Arrow,e),Arrow.create=function(){var e=new this;return e},Arrow}(e.ThreeDUI);e.Arrow=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ThreeDFont(){t.apply(this,arguments),this.needFormat=!1,this._isFirstUpdate=!0}return __extends(ThreeDFont,t),ThreeDFont.prototype.update=function(e){this._isFirstUpdate?this._isFirstUpdate=!1:this.needFormat&&this.reFormat(),this.needFormat=!1},ThreeDFont.prototype.reFormat=function(){},__decorate([e.virtual],ThreeDFont.prototype,"reFormat",null),ThreeDFont}(e.ThreeDUI);e.ThreeDFont=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ThreeDBitmapFont(){t.apply(this,arguments),this._text="",this._xAlignment=e.EFontXAlignment.LEFT,this.fntId=null,this._width=null,this.height=0,this.layoutDataList=null,this._layout=e.BitmapFontLayout.create()}return __extends(ThreeDBitmapFont,t),ThreeDBitmapFont.create=function(){var e=new this;return e},Object.defineProperty(ThreeDBitmapFont.prototype,"text",{get:function(){return this._text},set:function(e){this._text!==e&&(this._text=e,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDBitmapFont.prototype,"xAlignment",{get:function(){return this._xAlignment},set:function(e){this._xAlignment!==e&&(this._xAlignment=e,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDBitmapFont.prototype,"width",{get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this.needFormat=!0)},enumerable:!0,configurable:!0}),ThreeDBitmapFont.prototype.init=function(){t.prototype.init.call(this),this.layoutDataList=this._layout.getLayoutData(this.text,this.fntId,{width:this.width,align:this.xAlignment})},ThreeDBitmapFont.prototype.reFormat=function(){this.layoutDataList=this._layout.getLayoutData(this.text,this.fntId,{width:this.width,align:this.xAlignment}),this.entityObject.getComponent(e.BitmapFontGeometry).updateBuffers()},__decorate([e.cloneAttributeAsBasicType()],ThreeDBitmapFont.prototype,"text",null),__decorate([e.cloneAttributeAsBasicType()],ThreeDBitmapFont.prototype,"xAlignment",null),__decorate([e.cloneAttributeAsBasicType()],ThreeDBitmapFont.prototype,"fntId",void 0),__decorate([e.cloneAttributeAsBasicType()],ThreeDBitmapFont.prototype,"_width",void 0),__decorate([e.cloneAttributeAsBasicType()],ThreeDBitmapFont.prototype,"height",void 0),ThreeDBitmapFont}(e.ThreeDFont);e.ThreeDBitmapFont=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDUI(){t.apply(this,arguments),this.context=null}return __extends(TwoDUI,t),Object.defineProperty(TwoDUI.prototype,"dirty",{get:function(){var e=this.getUIRenderer();return!e||e.dirty},set:function(e){if(e){var t=this.getUIRenderer();if(!t)return;t.dirty=e}},enumerable:!0,configurable:!0}),Object.defineProperty(TwoDUI.prototype,"width",{get:function(){return this.entityObject?this.entityObject.transform.width:null},enumerable:!0,configurable:!0}),Object.defineProperty(TwoDUI.prototype,"height",{get:function(){return this.entityObject?this.entityObject.transform.height:null},enumerable:!0,configurable:!0}),TwoDUI.prototype.update=function(e){},TwoDUI.prototype.init=function(){this.context=this.getContext()},TwoDUI.prototype.addToObject=function(r,n){void 0===n&&(n=!1);var i=e.TwoDUIEngine.getInstance();t.prototype.addToObject.call(this,r,n),i.hasChild(this)||i.addChild(this)},TwoDUI.prototype.removeFromObject=function(r){t.prototype.removeFromObject.call(this,r),e.TwoDUIEngine.getInstance().removeChild(this)},TwoDUI.prototype.render=function(){var e=this.context;this.shouldNotRender()||(e.save(),this._setCanvasTransformForRotation(),this.draw(),e.restore())},TwoDUI.prototype.draw=function(){},TwoDUI.prototype.shouldNotRender=function(){return!1},TwoDUI.prototype.getContext=function(){return this.getUIRenderer().context},TwoDUI.prototype.getCanvas=function(){return this.getUIRenderer().canvas},TwoDUI.prototype.getUIRenderer=function(){return this.entityObject?this.entityObject.getComponent(e.UIRenderer):null},TwoDUI.prototype.drawInCenterPoint=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=e[0],n=e[1];if(5===e.length){var i=e[2],a=e[3],o=e[4];r.drawImage(n,i.x-a/2,i.y-o/2,a,o)}else if(9===e.length){var s=e[2],c=e[3],u=e[4],l=e[5],i=e[6],a=e[7],o=e[8];r.drawImage(n,s,c,u,l,i.x-a/2,i.y-o/2,a,o)}},TwoDUI.prototype._setCanvasTransformForRotation=function(){var e=this.entityObject.transform.rotationMatrix;this.context.setTransform(e.a,e.b,e.c,e.d,e.tx,e.ty)},__decorate([e.virtual],TwoDUI.prototype,"dirty",null),__decorate([e.virtual],TwoDUI.prototype,"update",null),__decorate([e.require(function(t){e.expect(t).instanceOf(e.UIObject)})],TwoDUI.prototype,"addToObject",null),__decorate([e.require(function(){e.assert(null!==this.context,e.Log.info.FUNC_SHOULD("set context"))})],TwoDUI.prototype,"render",null),__decorate([e.virtual],TwoDUI.prototype,"draw",null),__decorate([e.virtual],TwoDUI.prototype,"shouldNotRender",null),TwoDUI}(e.Component);e.TwoDUI=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(e.EFontXAlignment||(e.EFontXAlignment={}));e.EFontXAlignment}(wd||(wd={}));var wd;!function(e){!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(e.EFontYAlignment||(e.EFontYAlignment={}));e.EFontYAlignment}(wd||(wd={}));var wd;!function(e){!function(e){e[e.AUTO="auto"]="AUTO"}(e.EFontDimension||(e.EFontDimension={}));e.EFontDimension}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDFont(){t.apply(this,arguments),this.needFormat=!1,this._isFirstUpdate=!0,this._sizeChangeEventSubscription=null}return __extends(TwoDFont,t),TwoDFont.prototype.init=function(){var r=this;t.prototype.init.call(this),this._sizeChangeEventSubscription=e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.UI_WIDTH_CHANGE).merge(e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.UI_HEIGHT_CHANGE)).subscribe(function(){r.dirty=!0,r.needFormat=!0})},TwoDFont.prototype.dispose=function(){this._sizeChangeEventSubscription&&this._sizeChangeEventSubscription.dispose()},TwoDFont.prototype.update=function(e){this._isFirstUpdate?this._isFirstUpdate=!1:this.needFormat&&this.reFormat(),this.needFormat=!1},TwoDFont.prototype.reFormat=function(){},TwoDFont.prototype.getLeftCornerPosition=function(){var t=this.entityObject.transform,r=t.position;return e.Vector2.create(r.x-t.width/2,r.y-t.height/2)},__decorate([e.virtual],TwoDFont.prototype,"reFormat",null),TwoDFont}(e.TwoDUI);e.TwoDFont=t}(wd||(wd={}));var wd;!function(e){var t=/([a-zA-Z0-9]+|\S)/,r=/^[a-zA-Z0-9]/,n=/[a-zA-Z0-9]+$/,i=/\s+$/,a=function(a){function PlainFont(){a.apply(this,arguments),this._text="",this._fontSize=10,this._fontFamily="sans-serif",this._xAlignment=e.EFontXAlignment.LEFT,this._yAlignment=e.EFontYAlignment.TOP,this._fillEnabled=!0,this._fillStyle="rgba(0, 0, 0, 1)",this._strokeEnabled=!1,this._strokeStyle=null,this._strokeSize=null,this._fontClientHeightCache=wdCb.Hash.create(),this._lineHeight=null,this._strArr=[]}return __extends(PlainFont,a),PlainFont.create=function(){var e=new this;return e},Object.defineProperty(PlainFont.prototype,"text",{get:function(){return this._text},set:function(e){this._text!==e&&(this._text=e,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(PlainFont.prototype,"fontSize",{get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(PlainFont.prototype,"fontFamily",{get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(PlainFont.prototype,"xAlignment",{get:function(){return this._xAlignment},set:function(e){this._xAlignment!==e&&(this._xAlignment=e,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(PlainFont.prototype,"yAlignment",{get:function(){return this._yAlignment},set:function(e){this._yAlignment!==e&&(this._yAlignment=e,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),PlainFont.prototype.init=function(){a.prototype.init.call(this),this._formatText(),this._lineHeight||(this._lineHeight=this._getDefaultLineHeight())},PlainFont.prototype.setFillStyle=function(e){this._fillStyle=e},PlainFont.prototype.enableStroke=function(e,t){this._strokeEnabled=!0,this._fillEnabled=!1,this._strokeStyle=e,this._strokeSize=t},PlainFont.prototype.enableFill=function(e){this._fillEnabled=!0,this._strokeEnabled=!1,this._fillStyle=e},PlainFont.prototype.setLineHeight=function(e){this._lineHeight=e},PlainFont.prototype.reFormat=function(){this._formatText(),this._lineHeight=this._getDefaultLineHeight()},PlainFont.prototype.draw=function(){var e=this.context;e.font=this.fontSize+"px '"+this.fontFamily+"'",e.textBaseline="top",e.textAlign="start",this._strArr.length>1?this._drawMultiLine():this._drawSingleLine()},PlainFont.prototype._formatText=function(){var e=this.width;if(this._trimStr(),0!==e){this._strArr=this._text.split("\n");for(var t=0;t<this._strArr.length;t++){var r=this._strArr[t],n=this._measure(r);n>e&&r.length>1&&this._formatMultiLine(t,r,n,e)}}},PlainFont.prototype._trimStr=function(){this._text=this._text.replace(i,"")},PlainFont.prototype._formatMultiLine=function(e,i,a,o){var s=this,c=100,u=this,l=null,d=i.length*(o/a)|0,h=i.substr(d),p=0,f=a-this._measure(h),m=0,g=function(){for(;f>o&&p<c;)d*=o/f,d=Math.floor(d),h=i.substr(d),f=a-s._measure(h),p+=1;p=0},_=function(){for(;f<o&&p<c;){if(h){var e=t.exec(h);m=e?e[0].length:1}d+=m,h=i.substr(d),f=a-s._measure(h),p+=1}},y=function(){if(r.test(h)){var e=i.substr(0,d),t=n.exec(e);t&&(d-=t[0].length)}else d-=m;0===d&&(d=1)},v=function(){h=i.substr(d),l=i.substr(0,d),u._strArr[e]=h,u._strArr.splice(e,0,l)};g(),_(),y(),v()},PlainFont.prototype._measure=function(e){var t=this.context;return t.font=this.fontSize+"px '"+this.fontFamily+"'",t.measureText(e).width},PlainFont.prototype._getDefaultLineHeight=function(){return this._computeLineHeight("normal")},PlainFont.prototype._computeLineHeight=function(e){var t=wdCb.DomQuery.create("<div></div>"),r=t.get(0),n=null;return r.style.cssText="\n             font-family: "+this.fontFamily+";\n             font-size: "+this.fontSize+"px;\n             position: absolute;\n             left: -100px;\n             top: -100px;\n             line-height: "+e+";\n             ",t.prependTo("body"),r.innerHTML="abc!",n=r.clientHeight,t.remove(),n},PlainFont.prototype._getFontClientHeight=function(){var e=this.fontSize,t=this.fontFamily,r=e+"."+t,n=this._fontClientHeightCache.getChild(r),i=null;return n?n:(i=this._computeLineHeight(1),this._fontClientHeightCache.addChild(r,i),i)},PlainFont.prototype._drawMultiLine=function(){var t=this.context,r=this.getLeftCornerPosition(),n=r.x,i=r.y,a=this._lineHeight,o=this._getFontClientHeight(),s=this,c=this._strArr.length,u=(c-1)*a+o;s.yAlignment===e.EFontYAlignment.BOTTOM?i=i+s.height-u:s.yAlignment===e.EFontYAlignment.MIDDLE&&(i+=(s.height-u)/2);for(var l=0,d=this._strArr;l<d.length;l++){var h=d[l];s.xAlignment===e.EFontXAlignment.RIGHT?n=n+s.width-s._measure(h):s.xAlignment==e.EFontXAlignment.CENTER&&(n+=(s.width-s._measure(h))/2),s._fillEnabled?(t.fillStyle=s._fillStyle,t.fillText(h,n,i)):s._strokeEnabled&&(t.strokeStyle=s._strokeStyle,t.lineWidth=s._strokeSize,t.strokeText(h,n,i)),n=r.x,i+=a}},PlainFont.prototype._drawSingleLine=function(){var t=this.context,r=this.getLeftCornerPosition(),n=r.x,i=r.y,a=this._getFontClientHeight(),o=this,s=a,c=this._strArr[0];o.yAlignment===e.EFontYAlignment.BOTTOM?i=i+o.height-s:o.yAlignment===e.EFontYAlignment.MIDDLE&&(i+=(o.height-s)/2),o.xAlignment===e.EFontXAlignment.RIGHT?n=n+o.width-o._measure(c):o.xAlignment==e.EFontXAlignment.CENTER&&(n+=(o.width-o._measure(c))/2),o._fillEnabled?(t.fillStyle=o._fillStyle,t.fillText(c,n,i)):o._strokeEnabled&&(t.strokeStyle=o._strokeStyle,t.lineWidth=o._strokeSize,t.strokeText(c,n,i))},__decorate([e.cloneAttributeAsBasicType()],PlainFont.prototype,"text",null),__decorate([e.cloneAttributeAsBasicType()],PlainFont.prototype,"fontSize",null),__decorate([e.cloneAttributeAsBasicType()],PlainFont.prototype,"fontFamily",null),__decorate([e.cloneAttributeAsBasicType()],PlainFont.prototype,"xAlignment",null),__decorate([e.cloneAttributeAsBasicType()],PlainFont.prototype,"yAlignment",null),__decorate([e.cloneAttributeAsBasicType()],PlainFont.prototype,"_fillEnabled",void 0),__decorate([e.cloneAttributeAsBasicType()],PlainFont.prototype,"_fillStyle",void 0),__decorate([e.cloneAttributeAsBasicType()],PlainFont.prototype,"_strokeEnabled",void 0),__decorate([e.cloneAttributeAsBasicType()],PlainFont.prototype,"_strokeStyle",void 0),__decorate([e.cloneAttributeAsBasicType()],PlainFont.prototype,"_strokeSize",void 0),__decorate([e.cloneAttributeAsBasicType()],PlainFont.prototype,"_lineHeight",void 0),PlainFont}(e.TwoDFont);e.PlainFont=a}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDBitmapFont(){t.apply(this,arguments),this._text="",this._xAlignment=e.EFontXAlignment.LEFT,this.fntId=null,this.bitmapId=null,this._charFontList=wdCb.Collection.create(),this._layout=e.BitmapFontLayout.create()}return __extends(TwoDBitmapFont,t),TwoDBitmapFont.create=function(){var e=new this;
return e},Object.defineProperty(TwoDBitmapFont.prototype,"text",{get:function(){return this._text},set:function(e){this._text!==e&&(this._text=e,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(TwoDBitmapFont.prototype,"xAlignment",{get:function(){return this._xAlignment},set:function(e){this._xAlignment!==e&&(this._xAlignment=e,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),TwoDBitmapFont.prototype.init=function(){var r=this._getImageAsset();if(!r)return e.Log.log("impossible to create font: not find bitmap file"),!1;t.prototype.init.call(this);var n=this._layout.getLayoutData(this.text,this.fntId,{width:this.width,align:this.xAlignment});n&&this._createAndAddFontCharUIObjects(n,r)},TwoDBitmapFont.prototype.dispose=function(){t.prototype.dispose.call(this),this._removeAllCharFont()},TwoDBitmapFont.prototype.reFormat=function(){var t=this._getImageAsset();if(this._removeAllCharFont(),!t)return e.Log.log("impossible to create font: not find bitmap file"),!1;var r=this._layout.getLayoutData(this.text,this.fntId,{width:this.width,align:this.xAlignment});r&&this._createAndAddFontCharUIObjects(r,t)},TwoDBitmapFont.prototype._getImageAsset=function(){return e.LoaderManager.getInstance().get(this.bitmapId)},TwoDBitmapFont.prototype._createAndAddFontCharUIObjects=function(t,r){var n=this,i=r.source,a=this.getUIRenderer(),o=this.text,s=this.getLeftCornerPosition();t.forEach(function(t){var r=t.data,c=e.RectRegion.create(r.rect.x,r.rect.y,r.rect.width,r.rect.height),u=n._createCharFont(t.index,a),l=u.charFontUIObject,d=u.charFont,h=null;h=l.transform,d.image=i,d.rectRegion=c,h.width=c.width,h.height=c.height,d.char=o[t.index],n._addCharFontUIObject(l),n._setCharFontUIObjectPosition(l,s.x+t.position[0],s.y+t.position[1])})},TwoDBitmapFont.prototype._createCharFont=function(t,r){var n=e.UIObject.create(),i=e.CharFont.create();return n.addComponent(i),n.addComponent(r),n.addTag(String(t)),n.init(),{charFontUIObject:n,charFont:i}},TwoDBitmapFont.prototype._addCharFontUIObject=function(e){this._charFontList.addChild(e),this.entityObject.addChild(e)},TwoDBitmapFont.prototype._setCharFontUIObjectPosition=function(t,r,n){var i=t.transform;t.transform.position=e.CoordinateUtils.convertLeftCornerPositionToCenterPositionInCanvas(e.Vector2.create(r,n),i.width,i.height)},TwoDBitmapFont.prototype._removeAllCharFont=function(){this._charFontList.forEach(function(e){e.dispose()}),this._charFontList.removeAllChildren()},__decorate([e.cloneAttributeAsBasicType()],TwoDBitmapFont.prototype,"text",null),__decorate([e.cloneAttributeAsBasicType()],TwoDBitmapFont.prototype,"xAlignment",null),__decorate([e.cloneAttributeAsBasicType()],TwoDBitmapFont.prototype,"fntId",void 0),__decorate([e.cloneAttributeAsBasicType()],TwoDBitmapFont.prototype,"bitmapId",void 0),TwoDBitmapFont}(e.TwoDFont);e.TwoDBitmapFont=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CharFont(){t.apply(this,arguments),this._char=null,this.startPosX=null,this.xAdvance=null,this.image=null,this.rectRegion=null,this._subscription=null}return __extends(CharFont,t),CharFont.create=function(){var e=new this;return e},Object.defineProperty(CharFont.prototype,"x",{get:function(){return this.entityObject.transform.position.x},set:function(t){var r=this.entityObject.transform.position;this.entityObject.transform.position=e.Vector2.create(t,r.y)},enumerable:!0,configurable:!0}),Object.defineProperty(CharFont.prototype,"y",{get:function(){return this.entityObject.transform.position.y},enumerable:!0,configurable:!0}),Object.defineProperty(CharFont.prototype,"char",{get:function(){return this._char},set:function(t){return null!==this._char?void e.Log.log(e.Log.info.FUNC_NOT_SUPPORT("change char")):void(this._char=t)},enumerable:!0,configurable:!0}),CharFont.prototype.clone=function(){return e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("clone")),null},CharFont.prototype.init=function(){var r=this;t.prototype.init.call(this),this._subscription=wdFrp.fromArray([e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.TRANSFORM_TRANSLATE),e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.TRANSFORM_ROTATE),e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.TRANSFORM_SCALE)]).mergeAll().subscribe(function(){r.dirty=!0})},CharFont.prototype.dispose=function(){t.prototype.dispose.call(this),this._subscription.dispose()},CharFont.prototype.shouldNotRender=function(){return null===this.rectRegion||0===this.width&&0===this.height},CharFont.prototype.draw=function(){var e=null,t=null,r=null,n=null;e=this.entityObject.transform,t=e.position,r=this.width,n=this.height,this.drawInCenterPoint(this.context,this.image,this.rectRegion.x,this.rectRegion.y,this.rectRegion.width,this.rectRegion.height,t,r,n)},__decorate([e.execOnlyOnce("_isInit")],CharFont.prototype,"init",null),CharFont}(e.TwoDFont);e.CharFont=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ProgressBar(){t.apply(this,arguments),this._percent=0,this.borderStyle="rgba(0, 0, 0, 1)",this.fillStyle="rgba(255, 0, 0, 1)",this.radius=5,this._offScreenCanvas=null,this._offScreenContext=null}return __extends(ProgressBar,t),ProgressBar.create=function(){var e=new this;return e},Object.defineProperty(ProgressBar.prototype,"percent",{get:function(){return this._percent},set:function(e){this._percent!==e&&(this._percent=e,this.dirty=!0)},enumerable:!0,configurable:!0}),ProgressBar.prototype.init=function(){t.prototype.init.call(this),this._createOffScreenCanvas(),this._drawProgressBar()},ProgressBar.prototype.shouldNotRender=function(){return this.percent<=0},ProgressBar.prototype.draw=function(){var e=this.entityObject.transform.position;this._drawFromLeft(e),this._drawBorder(e)},ProgressBar.prototype._drawFromLeft=function(t){var r=this._offScreenCanvas,n=this.width*this.percent;this.drawInCenterPoint(this.context,r,0,0,n,this.height,e.Vector2.create(t.x-this.width/2+n/2,t.y),n,this.height)},ProgressBar.prototype._drawBorder=function(t){e.RoundedRectUtils.drawRoundedRect(this.context,this.borderStyle,null,t.x-this.width/2,t.y-this.height/2,this.width,this.height,this.radius)},ProgressBar.prototype._createOffScreenCanvas=function(){var e=wdCb.DomQuery.create("<canvas></canvas>");e.attr("width",this.context.canvas.width),e.attr("height",this.context.canvas.height),this._offScreenCanvas=e.get(0),this._offScreenContext=this._offScreenCanvas.getContext("2d")},ProgressBar.prototype._drawProgressBar=function(){this._offScreenContext.clearRect(0,0,this._offScreenCanvas.width,this._offScreenCanvas.height),e.RoundedRectUtils.drawRoundedRect(this._offScreenContext,this.borderStyle,this.fillStyle,0,0,this.width,this.height,this.radius)},__decorate([e.cloneAttributeAsBasicType()],ProgressBar.prototype,"percent",null),__decorate([e.cloneAttributeAsBasicType()],ProgressBar.prototype,"borderStyle",void 0),__decorate([e.cloneAttributeAsBasicType()],ProgressBar.prototype,"fillStyle",void 0),__decorate([e.cloneAttributeAsBasicType()],ProgressBar.prototype,"radius",void 0),__decorate([e.require(function(){e.assert(this.percent>=0&&this.percent<=1,e.Log.info.FUNC_SHOULD("percent"," >= 0 and <= 1"))})],ProgressBar.prototype,"draw",null),ProgressBar}(e.TwoDUI);e.ProgressBar=t}(wd||(wd={}));var wd;!function(e){function _canUseNewCanvasBlendModes(){var e=null,t=null;return"undefined"!=typeof document&&(e=document.createElement("canvas"),e.width=1,e.height=1,t=e.getContext("2d"),t.fillStyle="#000",t.fillRect(0,0,1,1),t.globalCompositeOperation="multiply",t.fillStyle="#fff",t.fillRect(0,0,1,1),0===t.getImageData(0,0,1,1).data[0])}var t=function(t){function Image(){t.apply(this,arguments),this._source=null,this.color=null,this.targetSource=null,this.targetColor=null}return __extends(Image,t),Image.create=function(){var e=new this;return e},Object.defineProperty(Image.prototype,"source",{get:function(){return this._source},set:function(e){e!==this._source&&(this._source=e,this.dirty=!0)},enumerable:!0,configurable:!0}),Image.prototype.shouldNotRender=function(){return null===this._getDrawSource()&&null===this._getDrawColor()},Image.prototype.draw=function(){var e=this._getDrawColor(),t=this._getDrawSource();if(null!==e){var r=this.entityObject.transform.position;this._setFillStyle(e.toString()),e.a<1&&this._setGlobalAlpha(this.context,e.a),this.context.fillRect(r.x-this.width/2,r.y-this.height/2,this.width,this.height),t&&this._blendColorWithSource()}else this.drawInCenterPoint(this.context,t.source,this.entityObject.transform.position,this.width,this.height)},Image.prototype._setFillStyle=function(e){this.context.fillStyle=e},Image.prototype._getDrawSource=function(){return this.targetSource?this.targetSource:this.source},Image.prototype._getDrawColor=function(){return this.targetColor?this.targetColor:this.color},Image.prototype._blendByMultiply=function(){this._setGlobalCompositeOperation(this.context,"multiply"),this.drawInCenterPoint(this.context,this._getDrawSource().source,this.entityObject.transform.position,this.width,this.height)},Image.prototype._blendByPerPixel=function(){var e=this.context,t=this.getCanvas(),r=this.color.r,n=this.color.g,i=this.color.b,a=null,o=null;e.globalCompositeOperation="clone",this.drawInCenterPoint(this.context,this._getDrawSource().source,this.entityObject.transform.position,this.width,this.height),a=e.getImageData(0,0,t.width,t.height),o=a.data;for(var s=0,c=o.length;s<c;s+=4)o[s]*=r,o[s+1]*=n,o[s+2]*=i;e.putImageData(a,0,0)},Image.prototype._setGlobalCompositeOperation=function(e,t){e.globalCompositeOperation=t},Image.prototype._setGlobalAlpha=function(e,t){e.globalAlpha=t},Image.constructorForBlend=function(e){return e._blendColorWithSource=_canUseNewCanvasBlendModes()?e._blendByMultiply:e._blendByPerPixel,!0},Image.constructorInitForBlend=Image.constructorForBlend(Image.prototype),__decorate([e.cloneAttributeAsCloneable()],Image.prototype,"source",null),__decorate([e.cloneAttributeAsCloneable()],Image.prototype,"color",void 0),__decorate([e.cloneAttributeAsCustomType(function(t,r,n){t[n]&&(r[n]=e.ImageTextureAsset.create(t[n].source))})],Image.prototype,"targetSource",void 0),__decorate([e.cloneAttributeAsCloneable()],Image.prototype,"targetColor",void 0),__decorate([e.require(function(){e.assert(!!this._getDrawSource(),e.Log.info.FUNC_SHOULD("source","exist"))})],Image.prototype,"_blendByMultiply",null),__decorate([e.require(function(){e.assert(!!this._getDrawSource(),e.Log.info.FUNC_SHOULD("source","exist"))})],Image.prototype,"_blendByPerPixel",null),Image}(e.TwoDUI);e.Image=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function InteractionUI(){t.apply(this,arguments),this.p_transitionMode=null,this.transitionManager=e.TransitionManager.create(this)}return __extends(InteractionUI,t),Object.defineProperty(InteractionUI.prototype,"transitionMode",{get:function(){return this.p_transitionMode},set:function(e){this.p_transitionMode=e},enumerable:!0,configurable:!0}),__decorate([e.cloneAttributeAsBasicType()],InteractionUI.prototype,"transitionMode",null),__decorate([e.cloneAttributeAsCloneable()],InteractionUI.prototype,"transitionManager",void 0),InteractionUI}(e.TwoDUI);e.InteractionUI=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Button(){t.apply(this,arguments),this._text=null,this._mousedownSubscription=null,this._mouseupSubscription=null,this._mouseoverSubscription=null,this._mouseoutSubscription=null,this._stateMachine=e.UIStateMachine.create(this)}return __extends(Button,t),Button.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(Button.prototype,"text",{get:function(){var t=null;return null===this.entityObject?this._text:(t=this.getObject(e.EButtonObjectName.TEXT),t?t.getComponent(e.PlainFont).text:null)},set:function(t){var r=null;this._text=t,null!==this.entityObject&&this.getUIRenderer()&&(r=this.getObject(e.EButtonObjectName.TEXT),r?r.getComponent(e.PlainFont).text=t:this.entityObject.addChild(this._createFontObject()))},enumerable:!0,configurable:!0}),Object.defineProperty(Button.prototype,"isDisabled",{get:function(){return this._stateMachine.currentState===e.EUIState.DISABLED},enumerable:!0,configurable:!0}),Object.defineProperty(Button.prototype,"currentState",{get:function(){return this._stateMachine.currentState},enumerable:!0,configurable:!0}),Button.prototype.initWhenCreate=function(){this.transitionMode=e.ETransitionMode.SPRITE,this.text="button"},Button.prototype.init=function(){t.prototype.init.call(this),this.entityObject.addChild(this._createBackgroundObject()),this._hasFontObject()||this.entityObject.addChild(this._createFontObject()),this._bindEvent()},Button.prototype.dispose=function(){t.prototype.dispose.call(this),this._mousedownSubscription.dispose(),this._mouseupSubscription.dispose(),this._mouseoverSubscription.dispose(),this._mouseoutSubscription.dispose()},Button.prototype.getObject=function(e){return this.entityObject.findChildByName(e)},Button.prototype.getObjectTransition=function(e){return this.transitionManager.getObjectTransition(e)},Button.prototype.enable=function(){this._stateMachine.changeState(e.EUIState.NORMAL)},Button.prototype.disable=function(){this._stateMachine.changeState(e.EUIState.DISABLED)},Button.prototype.update=function(t){var r=this.transitionManager.getObjectTarget(e.EButtonObjectName.BACKGROUND);if(r)switch(this.p_transitionMode){case e.ETransitionMode.SPRITE:this.getObject(e.EButtonObjectName.BACKGROUND).getComponent(e.Image).targetSource=r;break;case e.ETransitionMode.COLOR:this.getObject(e.EButtonObjectName.BACKGROUND).getComponent(e.Image).targetColor=r;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("transitionMode"))}else{var n=this.getObject(e.EButtonObjectName.BACKGROUND).getComponent(e.Image);switch(this.p_transitionMode){case e.ETransitionMode.SPRITE:n.targetSource=null;break;case e.ETransitionMode.COLOR:n.targetColor=null;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("transitionMode"))}}},Button.prototype.render=function(){},Button.prototype._createBackgroundObject=function(){var t=e.UIObject.create(),r=e.Image.create(),n=this.entityObject.transform;return t.addComponent(r),t.addComponent(this.getUIRenderer()),t.transform.width=n.width,t.transform.height=n.height,t.transform.zIndex=1,t.name=e.EButtonObjectName.BACKGROUND,e.CloneUtils.markNotClone(t),t},Button.prototype._createFontObject=function(){var t=e.UIObject.create(),r=e.PlainFont.create(),n=this.entityObject.transform;return r.text=this._text,r.enableFill("#000000"),r.xAlignment=e.EFontXAlignment.CENTER,r.yAlignment=e.EFontYAlignment.MIDDLE,t.addComponent(r),t.addComponent(this.getUIRenderer()),t.transform.width=n.width,t.transform.height=n.height,t.transform.zIndex=2,t.name=e.EButtonObjectName.TEXT,e.CloneUtils.markNotClone(t),t},Button.prototype._hasFontObject=function(){return!!this.getObject(e.EButtonObjectName.TEXT)},Button.prototype._bindEvent=function(){var t=this;this._mousedownSubscription=e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.MOUSE_DOWN).filter(function(e){return!t.isDisabled}).subscribe(function(r){t._stateMachine.changeState(e.EUIState.PRESSED)}),this._mouseupSubscription=e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.MOUSE_UP).filter(function(e){return!t.isDisabled}).subscribe(function(e){t._stateMachine.backState()}),this._mouseoverSubscription=e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.MOUSE_OVER).filter(function(e){return!t.isDisabled}).subscribe(function(r){t._stateMachine.changeState(e.EUIState.HIGHLIGHT)}),this._mouseoutSubscription=e.EventManager.fromEvent(this.entityObject,e.EEngineEvent.MOUSE_OUT).filter(function(e){return!t.isDisabled}).subscribe(function(r){t._stateMachine.isState(e.EUIState.PRESSED)?(t._stateMachine.backState(),t._stateMachine.backState()):t._stateMachine.backState()})},__decorate([e.cloneAttributeAsBasicType()],Button.prototype,"_text",void 0),__decorate([e.cloneAttributeAsCloneable()],Button.prototype,"_stateMachine",void 0),__decorate([e.require(function(){e.assert(this.getObject(e.EButtonObjectName.BACKGROUND).hasComponent(e.Image),e.Log.info.FUNC_SHOULD("Button UIObject","contain Image component"))})],Button.prototype,"update",null),Button}(e.InteractionUI);e.Button=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BACKGROUND="background"]="BACKGROUND",e[e.TEXT="text"]="TEXT"}(e.EButtonObjectName||(e.EButtonObjectName={}));e.EButtonObjectName}(wd||(wd={}));var wd;!function(e){!function(e){e[e.NORMAL=0]="NORMAL",e[e.HIGHLIGHT=1]="HIGHLIGHT",e[e.PRESSED=2]="PRESSED",e[e.DISABLED=3]="DISABLED"}(e.EUIState||(e.EUIState={}));e.EUIState}(wd||(wd={}));var wd;!function(e){var t=function(){function UIStateMachine(e){this._ui=null,this._stateHistory=wdCb.Stack.create(),this._ui=e}return UIStateMachine.create=function(e){var t=new this(e);return t},Object.defineProperty(UIStateMachine.prototype,"transitionManager",{get:function(){return this._ui.transitionManager},enumerable:!0,configurable:!0}),Object.defineProperty(UIStateMachine.prototype,"currentState",{get:function(){return this._stateHistory.top||e.EUIState.NORMAL},enumerable:!0,configurable:!0}),UIStateMachine.prototype.clone=function(t){return e.CloneUtils.clone(this,null,null,t)},UIStateMachine.prototype.changeState=function(e){this._stateHistory.push(e),this.transitionManager.changeState(e),this._ui.dirty=!0},UIStateMachine.prototype.backState=function(){var t=null;this._stateHistory.pop(),t=this._stateHistory.top,t||(t=e.EUIState.NORMAL),this.transitionManager.changeState(t),this._ui.dirty=!0},UIStateMachine.prototype.isState=function(e){return this.currentState===e},__decorate([e.cloneAttributeAsCloneable()],UIStateMachine.prototype,"_stateHistory",void 0),UIStateMachine}();e.UIStateMachine=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Transition(){this._target=null}return Object.defineProperty(Transition.prototype,"target",{get:function(){return null===this._target&&this.changeState(e.EUIState.NORMAL),this._target},set:function(e){this._target=e},enumerable:!0,configurable:!0}),Transition.prototype.clone=function(){return e.CloneUtils.clone(this)},Transition}();e.Transition=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SpriteTransition(){t.apply(this,arguments),this.normalSprite=null,this.highlightSprite=null,this.pressedSprite=null,this.disabledSprite=null}return __extends(SpriteTransition,t),SpriteTransition.create=function(){var e=new this;return e},SpriteTransition.prototype.changeState=function(t){switch(t){case e.EUIState.NORMAL:this.target=this.normalSprite;break;case e.EUIState.HIGHLIGHT:this.target=this.highlightSprite;break;case e.EUIState.PRESSED:this.target=this.pressedSprite;break;case e.EUIState.DISABLED:this.target=this.disabledSprite;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("state"))}},__decorate([e.cloneAttributeAsCloneable()],SpriteTransition.prototype,"normalSprite",void 0),__decorate([e.cloneAttributeAsCloneable()],SpriteTransition.prototype,"highlightSprite",void 0),__decorate([e.cloneAttributeAsCloneable()],SpriteTransition.prototype,"pressedSprite",void 0),__decorate([e.cloneAttributeAsCloneable()],SpriteTransition.prototype,"disabledSprite",void 0),SpriteTransition}(e.Transition);e.SpriteTransition=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ColorTransition(){t.apply(this,arguments),this.normalColor=null,this.highlightColor=null,this.pressedColor=null,this.disabledColor=null}return __extends(ColorTransition,t),ColorTransition.create=function(){var e=new this;return e},ColorTransition.prototype.changeState=function(t){switch(t){case e.EUIState.NORMAL:this.target=this.normalColor;break;case e.EUIState.HIGHLIGHT:this.target=this.highlightColor;break;case e.EUIState.PRESSED:this.target=this.pressedColor;break;case e.EUIState.DISABLED:this.target=this.disabledColor;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("state"))}},__decorate([e.cloneAttributeAsCloneable()],ColorTransition.prototype,"normalColor",void 0),__decorate([e.cloneAttributeAsCloneable()],ColorTransition.prototype,"highlightColor",void 0),__decorate([e.cloneAttributeAsCloneable()],ColorTransition.prototype,"pressedColor",void 0),__decorate([e.cloneAttributeAsCloneable()],ColorTransition.prototype,"disabledColor",void 0),ColorTransition}(e.Transition);e.ColorTransition=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.SPRITE=0]="SPRITE",e[e.COLOR=1]="COLOR"}(e.ETransitionMode||(e.ETransitionMode={}));e.ETransitionMode}(wd||(wd={}));var wd;!function(e){var t=function(){function TransitionManager(e){this._ui=null,this._spriteTransitionMap=wdCb.Hash.create(),this._colorTransitionMap=wdCb.Hash.create(),this._ui=e}return TransitionManager.create=function(e){var t=new this(e);return t},TransitionManager.prototype.clone=function(t){return e.CloneUtils.clone(this,null,null,t)},TransitionManager.prototype.getObjectTransition=function(e){var t=this._getTransitionMap().getChild(e);return t||(t=this._createTransitionInstance(),this._getTransitionMap().addChild(e,t)),t},TransitionManager.prototype.getObjectTarget=function(e){return this.getObjectTransition(e).target},TransitionManager.prototype.changeState=function(e){wdFrp.fromArray([this._spriteTransitionMap,this._colorTransitionMap]).subscribe(function(t){t.forEach(function(t){t.changeState(e)})})},TransitionManager.prototype._getTransitionMap=function(){var t=null;switch(this._ui.transitionMode){case e.ETransitionMode.SPRITE:t=this._spriteTransitionMap;break;case e.ETransitionMode.COLOR:t=this._colorTransitionMap;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("transitionMode"))}return t},TransitionManager.prototype._createTransitionInstance=function(){var t=null;switch(this._ui.transitionMode){case e.ETransitionMode.SPRITE:t=e.SpriteTransition.create();break;case e.ETransitionMode.COLOR:t=e.ColorTransition.create();break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("transitionMode"))}return t},__decorate([e.cloneAttributeAsCustomType(function(e,t,r){t[r]=e[r].clone(!0)})],TransitionManager.prototype,"_spriteTransitionMap",void 0),__decorate([e.cloneAttributeAsCustomType(function(e,t,r){t[r]=e[r].clone(!0)})],TransitionManager.prototype,"_colorTransitionMap",void 0),TransitionManager}();e.TransitionManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function RoundedRectUtils(){}return RoundedRectUtils.drawRoundedRect=function(e,t,r,n,i,a,o,s){e.save(),e.beginPath(),a>0?e.moveTo(n+s,i):e.moveTo(n-s,i),e.arcTo(n+a,i,n+a,i+o,s),e.arcTo(n+a,i+o,n,i+o,s),e.arcTo(n,i+o,n,i,s),a>0?e.arcTo(n,i,n+s,i,s):e.arcTo(n,i,n-s,i,s),e.closePath(),e.strokeStyle=t,e.fillStyle=r,t&&e.stroke(),r&&e.fill(),e.restore()},RoundedRectUtils}();e.RoundedRectUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function RenderTargetRenderer(e){this.texture=null,this.frameBufferOperator=null,this._isRenderListEmpty=!1,this._renderCount=0,this.texture=e}return RenderTargetRenderer.prototype.initWhenCreate=function(){this.frameBufferOperator=e.FrameBuffer.create(this.texture.width,this.texture.height)},RenderTargetRenderer.prototype.init=function(){this.texture.createEmptyTexture(),this.initFrameBuffer()},RenderTargetRenderer.prototype.needRender=function(){var e=this.texture.renderRate,t=!1;return t=0===e?this._shouldRenderOnce():this._shouldRenderAtRate(e),this._renderCount++,t},RenderTargetRenderer.prototype.render=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=e[0],n=this.getRenderList();if(this._isRenderListEmpty=this.isRenderListEmpty(n),this.beforeRender(),1===e.length)this.renderFrameBufferTexture(n,r);else{var i=e[1];this.renderFrameBufferTexture(n,r,i)}this.afterRender()},RenderTargetRenderer.prototype.dispose=function(){this.frameBufferOperator.dispose(),this.disposeFrameBuffer(),this.texture.dispose()},RenderTargetRenderer.prototype.beforeRender=function(){},RenderTargetRenderer.prototype.afterRender=function(){},RenderTargetRenderer.prototype.isRenderListEmptyWhenRender=function(){return this._isRenderListEmpty},RenderTargetRenderer.prototype._shouldRenderOnce=function(){return 0===this._renderCount},RenderTargetRenderer.prototype._shouldRenderAtRate=function(e){var t=this._renderCount;return 0===t||t===e&&(this._renderCount=0,!0)},__decorate([e.require(function(){e.assert(this.texture.renderRate>=0,e.Log.info.FUNC_SHOULD("renderTargetTexture->renderRate",">= 0, but actual is "+this.texture.renderRate))}),e.virtual],RenderTargetRenderer.prototype,"needRender",null),__decorate([e.virtual],RenderTargetRenderer.prototype,"beforeRender",null),__decorate([e.virtual],RenderTargetRenderer.prototype,"afterRender",null),__decorate([e.ensure(function(t){t&&e.assert(this.isRenderListEmpty(this.getRenderList()),e.Log.info.FUNC_SHOULD("renderList","be empty"))})],RenderTargetRenderer.prototype,"isRenderListEmptyWhenRender",null),RenderTargetRenderer}();e.RenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CommonRenderTargetRenderer(){e.apply(this,arguments)}return __extends(CommonRenderTargetRenderer,e),CommonRenderTargetRenderer}(e.RenderTargetRenderer);e.CommonRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDRenderTargetRenderer(){t.apply(this,arguments),this.frameBuffer=null,this._renderBuffer=null,this._lastCamera=null}return __extends(TwoDRenderTargetRenderer,t),TwoDRenderTargetRenderer.prototype.isNeedCreateCamera=function(){return!0},TwoDRenderTargetRenderer.prototype.createCamera=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return null},TwoDRenderTargetRenderer.prototype.setFrameBufferTexture=function(){var t=this.frameBufferOperator,r=e.DeviceManager.getInstance().gl;t.attachTexture(r.TEXTURE_2D,this.texture.glTexture,e.EFrameBufferAttachType.COLOR_ATTACHMENT0)},TwoDRenderTargetRenderer.prototype.createAndAttachDepthBuffer=function(){var t=this.frameBufferOperator;e.DeviceManager.getInstance().gl;this._renderBuffer=t.createRenderBuffer(),t.attachRenderBuffer("DEPTH_ATTACHMENT",this._renderBuffer)},TwoDRenderTargetRenderer.prototype.deleteRenderBuffer=function(){var t=e.DeviceManager.getInstance().gl;t.deleteRenderbuffer(this._renderBuffer)},TwoDRenderTargetRenderer.prototype.isRenderListEmpty=function(e){return 0===e.getCount()},TwoDRenderTargetRenderer.prototype.initFrameBuffer=function(){var e=this.frameBufferOperator;this.frameBuffer=e.createFrameBuffer(),e.bindFrameBuffer(this.frameBuffer),this.setFrameBufferTexture(),this.createAndAttachDepthBuffer(),e.check(),e.unBindAll()},TwoDRenderTargetRenderer.prototype.renderFrameBufferTexture=function(e,t,r){var n=null;this.isRenderListEmptyWhenRender()||(this.texture.bindToUnit(0),this.isNeedCreateCamera()?(n=this.createCamera(r),this._lastCamera&&this._lastCamera.dispose(),this._lastCamera=n):n=r,this.beforeRenderFrameBufferTexture(n),this.frameBufferOperator.bindFrameBuffer(this.frameBuffer),this.frameBufferOperator.setViewport(),e.forEach(function(e){e.render(t,n)}),t.clear(),this.renderRenderer(t),this.frameBufferOperator.unBindFrameBuffer(),this.frameBufferOperator.restoreViewport())},TwoDRenderTargetRenderer.prototype.disposeFrameBuffer=function(){var t=e.DeviceManager.getInstance().gl;t.deleteFramebuffer(this.frameBuffer),this.deleteRenderBuffer()},__decorate([e.virtual],TwoDRenderTargetRenderer.prototype,"isNeedCreateCamera",null),__decorate([e.virtual],TwoDRenderTargetRenderer.prototype,"createCamera",null),__decorate([e.virtual],TwoDRenderTargetRenderer.prototype,"setFrameBufferTexture",null),__decorate([e.virtual],TwoDRenderTargetRenderer.prototype,"createAndAttachDepthBuffer",null),__decorate([e.virtual],TwoDRenderTargetRenderer.prototype,"deleteRenderBuffer",null),__decorate([e.require(function(t,r,n){e.assert(!!n,e.Log.info.FUNC_SHOULD("pass param->camera"))})],TwoDRenderTargetRenderer.prototype,"renderFrameBufferTexture",null),TwoDRenderTargetRenderer}(e.CommonRenderTargetRenderer);e.TwoDRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MirrorRenderTargetRenderer(){t.apply(this,arguments)}return __extends(MirrorRenderTargetRenderer,t),MirrorRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},MirrorRenderTargetRenderer.prototype.beforeRenderFrameBufferTexture=function(e){},MirrorRenderTargetRenderer.prototype.getRenderList=function(){return this.texture.renderList},MirrorRenderTargetRenderer.prototype.renderRenderer=function(t){this._setSceneSide(e.ESide.FRONT),t.webglState=e.BasicState.create(),t.render(),this._setSceneSide(null)},MirrorRenderTargetRenderer.prototype.beforeRender=function(){this.isRenderListEmptyWhenRender()?e.Director.getInstance().scene.glslData.addChild(e.EShaderGLSLData.MIRROR,{isRenderListEmpty:!0}):e.Director.getInstance().scene.glslData.addChild(e.EShaderGLSLData.MIRROR,{isRenderListEmpty:!1})},MirrorRenderTargetRenderer.prototype.createCamera=function(t){var r=null,n=null,i=t.getComponent(e.CameraController),a=null,o=null;return n=this.texture.getPlane(),a=n.getReflectionMatrix().applyMatrix(i.worldToCameraMatrix),o=this._setClipPlane(a,i.pMatrix,n),r=e.PerspectiveCamera.create(),r.worldToCameraMatrix=a.clone(),r.pMatrix=o,e.GameObject.create().addComponent(e.RenderTargetRendererCameraController.create(r)).init()},MirrorRenderTargetRenderer.prototype._setSceneSide=function(t){var r=e.Director.getInstance().scene;r.side=t},MirrorRenderTargetRenderer.prototype._setClipPlane=function(t,r,n){var i=r.clone(),a=e.Vector4.create(),o=this._getClipPlaneInCameraSpace(t,n),s=e.Vector4.create();return a.x=(Math.sign(o.x)+i.values[8])/i.values[0],a.y=(Math.sign(o.y)+i.values[9])/i.values[5],a.z=-1,a.w=(1+i.values[10])/i.values[14],s=o.multiplyScalar(2/o.dot(a)),i.values[2]=s.x,i.values[6]=s.y,i.values[10]=s.z+1,i.values[14]=s.w,i},MirrorRenderTargetRenderer.prototype._getClipPlaneInCameraSpace=function(t,r){var n=e.Vector4.create(),i=t.multiplyPoint(this.texture.getPosition()),a=t.clone().invert().transpose().multiplyPoint(r.normal).normalize();return n.set(a.x,a.y,a.z,-i.dot(a)),n},MirrorRenderTargetRenderer}(e.TwoDRenderTargetRenderer);e.MirrorRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RefractionRenderTargetRenderer(){t.apply(this,arguments)}return __extends(RefractionRenderTargetRenderer,t),RefractionRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},RefractionRenderTargetRenderer.prototype.beforeRenderFrameBufferTexture=function(e){},RefractionRenderTargetRenderer.prototype.getRenderList=function(){return this.texture.renderList},RefractionRenderTargetRenderer.prototype.renderRenderer=function(t){t.webglState=e.BasicState.create(),t.render()},RefractionRenderTargetRenderer.prototype.beforeRender=function(){this.isRenderListEmptyWhenRender()?e.Director.getInstance().scene.glslData.addChild(e.EShaderGLSLData.REFRACTION,{isRenderListEmpty:!0}):e.Director.getInstance().scene.glslData.addChild(e.EShaderGLSLData.REFRACTION,{isRenderListEmpty:!1})},RefractionRenderTargetRenderer.prototype.isNeedCreateCamera=function(){return!1},RefractionRenderTargetRenderer}(e.TwoDRenderTargetRenderer);e.RefractionRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDShadowMapRenderTargetRenderer(e,r,n){t.call(this,e),this._light=null,this._layer=null,this._shadowMapRendererUtils=null,this._light=r,this._layer=n}return __extends(TwoDShadowMapRenderTargetRenderer,t),TwoDShadowMapRenderTargetRenderer.create=function(e,t,r){var n=new this(e,t,r);return n.initWhenCreate(),n},TwoDShadowMapRenderTargetRenderer.prototype.initWhenCreate=function(){this._shadowMapRendererUtils=e.TwoDShadowMapRenderTargetRendererUtils.create(this._light,this.texture),t.prototype.initWhenCreate.call(this)},TwoDShadowMapRenderTargetRenderer.prototype.beforeRenderFrameBufferTexture=function(t){e.Director.getInstance().scene.glslData.appendChild(e.EShaderGLSLData.TWOD_SHADOWMAP,{camera:t.getComponent(e.CameraController),light:this._light,isRenderListEmpty:!1
})},TwoDShadowMapRenderTargetRenderer.prototype.getRenderList=function(){return e.Director.getInstance().scene.gameObjectScene.shadowManager.getShadowRenderListByLayer(this._layer)},TwoDShadowMapRenderTargetRenderer.prototype.renderRenderer=function(e){this._shadowMapRendererUtils.renderRenderer(e)},TwoDShadowMapRenderTargetRenderer.prototype.beforeRender=function(){return this.isRenderListEmptyWhenRender()?void e.Director.getInstance().scene.glslData.appendChild(e.EShaderGLSLData.TWOD_SHADOWMAP,{isRenderListEmpty:!0}):void this._shadowMapRendererUtils.beforeRender(e.EShaderTypeOfScene.BUILD_TWOD_SHADOWMAP)},TwoDShadowMapRenderTargetRenderer.prototype.afterRender=function(){this.isRenderListEmptyWhenRender()||this._shadowMapRendererUtils.afterRender()},TwoDShadowMapRenderTargetRenderer.prototype.createCamera=function(){var t=e.OrthographicCamera.create(),r=this._light,n=e.GameObject.create();return t.left=r.shadowCameraLeft,t.right=r.shadowCameraRight,t.top=r.shadowCameraTop,t.bottom=r.shadowCameraBottom,t.near=r.shadowCameraNear,t.far=r.shadowCameraFar,n.addComponent(e.RenderTargetRendererCameraController.create(t)),n.transform.translate(r.position),n.transform.lookAt(0,0,0),n.init(),n},TwoDShadowMapRenderTargetRenderer.prototype.setFrameBufferTexture=function(){if(e.GPUDetector.getInstance().extensionDepthTexture){var r=this.frameBufferOperator,n=e.DeviceManager.getInstance().gl;return r.attachTexture(n.TEXTURE_2D,this._createEmptyColorTexture(),e.EFrameBufferAttachType.COLOR_ATTACHMENT0),void r.attachTexture(n.TEXTURE_2D,this.texture.glTexture,e.EFrameBufferAttachType.DEPTH_ATTACHMENT)}t.prototype.setFrameBufferTexture.call(this)},TwoDShadowMapRenderTargetRenderer.prototype.createAndAttachDepthBuffer=function(){e.GPUDetector.getInstance().extensionDepthTexture||t.prototype.createAndAttachDepthBuffer.call(this)},TwoDShadowMapRenderTargetRenderer.prototype.deleteRenderBuffer=function(){e.GPUDetector.getInstance().extensionDepthTexture||t.prototype.deleteRenderBuffer.call(this)},TwoDShadowMapRenderTargetRenderer.prototype._createEmptyColorTexture=function(){var t=e.DeviceManager.getInstance().gl,r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.texture.width,this.texture.height,0,t.RGBA,t.UNSIGNED_BYTE,null),r},TwoDShadowMapRenderTargetRenderer}(e.TwoDRenderTargetRenderer);e.TwoDShadowMapRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapRenderTargetRenderer(){t.apply(this,arguments),this._frameBufferList=wdCb.Collection.create(),this._renderBufferList=wdCb.Collection.create(),this._lastCameraList=null,this._lastPosition=null}return __extends(CubemapRenderTargetRenderer,t),CubemapRenderTargetRenderer.prototype.renderRenderer=function(t){t.webglState=e.BasicState.create(),t.render()},CubemapRenderTargetRenderer.prototype.beforeRenderFrameBufferTexture=function(e){},CubemapRenderTargetRenderer.prototype.initFrameBuffer=function(){for(var t=this.frameBufferOperator,r=e.DeviceManager.getInstance().gl,n=0;n<6;n++){var i=t.createFrameBuffer(),a=t.createRenderBuffer();this._frameBufferList.addChild(i),this._renderBufferList.addChild(a),t.bindFrameBuffer(i),t.attachTexture(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,this.texture.glTexture),t.attachRenderBuffer("DEPTH_ATTACHMENT",a),t.check()}t.unBindAll()},CubemapRenderTargetRenderer.prototype.renderFrameBufferTexture=function(e,t,r){var n=null,i=null,a=null,o=null,s=null;if(!this.isRenderListEmptyWhenRender()){this.texture.bindToUnit(0),o=this.getPosition(),s=this._isNeedCreateCamera(o),s&&(a=wdCb.Collection.create());for(var c=0;c<6;c++)i=e.getChild(this._convertIndexToFaceKey(c)),this._isEmpty(i)||(s?(n=this.createCamera(c),a.addChild(n)):n=this._lastCameraList.getChild(c),this.beforeRenderFrameBufferTexture(n),this.frameBufferOperator.bindFrameBuffer(this._frameBufferList.getChild(c)),this.frameBufferOperator.setViewport(),i.forEach(function(e){e.render(t,n)}),t.clear(),this.renderRenderer(t));s&&(this._lastCameraList&&this._lastCameraList.forEach(function(e){e.dispose()}),this._lastCameraList=a,this._lastPosition=o),this.frameBufferOperator.unBindFrameBuffer(),this.frameBufferOperator.restoreViewport()}},CubemapRenderTargetRenderer.prototype.disposeFrameBuffer=function(){var t=e.DeviceManager.getInstance().gl;this._frameBufferList.forEach(function(e){return t.deleteFramebuffer(e)}),this._renderBufferList.forEach(function(e){return t.deleteRenderbuffer(e)})},CubemapRenderTargetRenderer.prototype.createCamera=function(t){var r=e.PerspectiveCamera.create(),n=e.GameObject.create(),i=this.getPosition();return r.fovy=90,this.setCamera(r),n.addComponent(e.RenderTargetRendererCameraController.create(r)),n.transform.translate(i),this._lookAtFace(n,i,t),n.init(),n},CubemapRenderTargetRenderer.prototype.isRenderListEmpty=function(e){var t=this,r=!0;return e.forEach(function(e){if(!t._isEmpty(e))return r=!1,wdCb.$BREAK},this),r},CubemapRenderTargetRenderer.prototype._isEmpty=function(e){return void 0===e||0===e.getCount()},CubemapRenderTargetRenderer.prototype._convertIndexToFaceKey=function(e){var t=null;switch(e){case 0:t="px";break;case 1:t="nx";break;case 2:t="py";break;case 3:t="ny";break;case 4:t="pz";break;case 5:t="nz"}return t},CubemapRenderTargetRenderer.prototype._lookAtFace=function(e,t,r){switch(r){case 0:e.transform.lookAt(t.x+1,t.y,t.z,0,-1,0);break;case 1:e.transform.lookAt(t.x-1,t.y,t.z,0,-1,0);break;case 2:e.transform.lookAt(t.x,t.y+1,t.z,0,0,1);break;case 3:e.transform.lookAt(t.x,t.y-1,t.z,0,0,-1);break;case 4:e.transform.lookAt(t.x,t.y,t.z+1,0,-1,0);break;case 5:e.transform.lookAt(t.x,t.y,t.z-1,0,-1,0)}},CubemapRenderTargetRenderer.prototype._isNeedCreateCamera=function(e){return null===this._lastPosition||null===this._lastCameraList||0===this._lastCameraList.getCount()||!e.isEqual(this._lastPosition)},__decorate([e.virtual],CubemapRenderTargetRenderer.prototype,"renderRenderer",null),__decorate([e.virtual],CubemapRenderTargetRenderer.prototype,"beforeRenderFrameBufferTexture",null),__decorate([e.require(function(t,r,n){e.assert(!!n,e.Log.info.FUNC_SHOULD("pass param->camera"))})],CubemapRenderTargetRenderer.prototype,"renderFrameBufferTexture",null),CubemapRenderTargetRenderer}(e.CommonRenderTargetRenderer);e.CubemapRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapShadowMapRenderTargetRenderer(e,r,n){t.call(this,e),this._light=null,this._layer=null,this._shadowMapRendererUtils=null,this._light=r,this._layer=n}return __extends(CubemapShadowMapRenderTargetRenderer,t),CubemapShadowMapRenderTargetRenderer.create=function(e,t,r){var n=new this(e,t,r);return n.initWhenCreate(),n},CubemapShadowMapRenderTargetRenderer.prototype.initWhenCreate=function(){this._shadowMapRendererUtils=e.CubemapShadowMapRenderTargetRendererUtils.create(this._light,this.texture),t.prototype.initWhenCreate.call(this)},CubemapShadowMapRenderTargetRenderer.prototype.getRenderList=function(){var t=e.Director.getInstance().scene.gameObjectScene.shadowManager.getShadowRenderListByLayer(this._layer);return wdCb.Hash.create({px:t,nx:t,py:t,ny:t,pz:t,nz:t})},CubemapShadowMapRenderTargetRenderer.prototype.renderRenderer=function(e){this._shadowMapRendererUtils.renderRenderer(e)},CubemapShadowMapRenderTargetRenderer.prototype.beforeRender=function(){var t=null;return this.isRenderListEmptyWhenRender()?void e.Director.getInstance().scene.glslData.appendChild(e.EShaderGLSLData.CUBEMAP_SHADOWMAP,{light:this._light,isRenderListEmpty:!0}):(e.Director.getInstance().scene.glslData.appendChild(e.EShaderGLSLData.CUBEMAP_SHADOWMAP,{light:this._light,isRenderListEmpty:!1}),t=e.Director.getInstance().scene,t.glslData.appendChild(e.EShaderGLSLData.BUILD_CUBEMAP_SHADOWMAP,{light:this._light}),void this._shadowMapRendererUtils.beforeRender(e.EShaderTypeOfScene.BUILD_CUBEMAP_SHADOWMAP))},CubemapShadowMapRenderTargetRenderer.prototype.afterRender=function(){this.isRenderListEmptyWhenRender()||this._shadowMapRendererUtils.afterRender()},CubemapShadowMapRenderTargetRenderer.prototype.setCamera=function(e){var t=this._light;e.aspect=t.shadowMapWidth/t.shadowMapHeight,e.near=t.shadowCameraNear,e.far=t.shadowCameraFar},CubemapShadowMapRenderTargetRenderer.prototype.getPosition=function(){return this._light.position},CubemapShadowMapRenderTargetRenderer}(e.CubemapRenderTargetRenderer);e.CubemapShadowMapRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DynamicCubemapRenderTargetRenderer(){t.apply(this,arguments)}return __extends(DynamicCubemapRenderTargetRenderer,t),DynamicCubemapRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},DynamicCubemapRenderTargetRenderer.prototype.getRenderList=function(){return this.texture.renderList},DynamicCubemapRenderTargetRenderer.prototype.setCamera=function(e){e.aspect=1,e.near=this.texture.near,e.far=this.texture.far},DynamicCubemapRenderTargetRenderer.prototype.getPosition=function(){return this.texture.getPosition()},DynamicCubemapRenderTargetRenderer.prototype.beforeRender=function(){this.isRenderListEmptyWhenRender()?e.Director.getInstance().scene.glslData.addChild(e.EShaderGLSLData.DYNAMIC_CUBEMAP,{isRenderListEmpty:!0}):e.Director.getInstance().scene.glslData.addChild(e.EShaderGLSLData.DYNAMIC_CUBEMAP,{isRenderListEmpty:!1})},DynamicCubemapRenderTargetRenderer}(e.CubemapRenderTargetRenderer);e.DynamicCubemapRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ShadowMapRenderTargetRendererUtils(e,t){this._texture=null,this._light=null,this._light=e,this._texture=t}return ShadowMapRenderTargetRendererUtils.prototype.initWhenCreate=function(){this._texture.width=this._light.shadowMapWidth,this._texture.height=this._light.shadowMapHeight},ShadowMapRenderTargetRendererUtils.prototype.beforeRender=function(t){e.Director.getInstance().scene.useShaderType(t)},ShadowMapRenderTargetRendererUtils.prototype.afterRender=function(){e.Director.getInstance().scene.unUseShader()},ShadowMapRenderTargetRendererUtils.prototype.renderRenderer=function(e){this.setWebglState(e),e.render()},ShadowMapRenderTargetRendererUtils}();e.ShadowMapRenderTargetRendererUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapShadowMapRenderTargetRendererUtils(){t.apply(this,arguments)}return __extends(CubemapShadowMapRenderTargetRendererUtils,t),CubemapShadowMapRenderTargetRendererUtils.create=function(e,t){var r=new this(e,t);return r.initWhenCreate(),r},CubemapShadowMapRenderTargetRendererUtils.prototype.setWebglState=function(t){t.webglState=e.BuildCubemapShadowMapState.create()},CubemapShadowMapRenderTargetRendererUtils}(e.ShadowMapRenderTargetRendererUtils);e.CubemapShadowMapRenderTargetRendererUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDShadowMapRenderTargetRendererUtils(){t.apply(this,arguments)}return __extends(TwoDShadowMapRenderTargetRendererUtils,t),TwoDShadowMapRenderTargetRendererUtils.create=function(e,t){var r=new this(e,t);return r.initWhenCreate(),r},TwoDShadowMapRenderTargetRendererUtils.prototype.setWebglState=function(t){t.webglState=e.BuildTwoDShadowMapState.create()},TwoDShadowMapRenderTargetRendererUtils}(e.ShadowMapRenderTargetRendererUtils);e.TwoDShadowMapRenderTargetRendererUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Renderer(){this._webglState=null,this.skyboxCommand=null}return Object.defineProperty(Renderer.prototype,"webglState",{get:function(){return this._webglState?this._webglState:e.BasicState.create()},set:function(e){this._webglState=e},enumerable:!0,configurable:!0}),Renderer.prototype.init=function(){},__decorate([e.virtual],Renderer.prototype,"init",null),Renderer}();e.Renderer=t}(wd||(wd={}));var wd;!function(e){var t=31,r=31,n=1024,i=1024,a=1024,o=30,s=o-5,c=o-5-5,u=o-5-5-10,l=function(o){function WebGLRenderer(){o.apply(this,arguments),this._commandQueue=wdCb.Collection.create(),this._clearOptions={color:e.Color.create("#000000")}}return __extends(WebGLRenderer,o),WebGLRenderer.create=function(){var e=new this;return e},WebGLRenderer.prototype.addCommand=function(e){this._commandQueue.addChild(e),e.init()},WebGLRenderer.prototype.hasCommand=function(){return this._commandQueue.getCount()>0||!!this.skyboxCommand},WebGLRenderer.prototype.clear=function(){e.DeviceManager.getInstance().clear(this._clearOptions)},WebGLRenderer.prototype.render=function(){var t=this,r=e.DeviceManager.getInstance(),n=this.webglState,i=[],a=[];if(this._commandQueue.forEach(function(r){r.webglState=n,r.blend?i.push(r):r instanceof e.QuadCommand?(t._buildOpaqueCommandSortId(r),a.push(r)):r.execute()},this),a.length>0){this._sortOpaqueQuadCommand(a);for(var o=0,s=a;o<s.length;o++){var c=s[o];c.execute()}}i.length>0&&(r.depthWrite=!1,this._renderSortedTransparentCommands(i),r.depthWrite=!0),this.skyboxCommand&&(r.depthFunc=e.EDepthFunction.LEQUAL,this.skyboxCommand.webglState=n,this.skyboxCommand.execute(),r.depthFunc=e.EDepthFunction.LESS),this._clearCommand(),this.webglState=null},WebGLRenderer.prototype.init=function(){var t=e.DeviceManager.getInstance();t.depthTest=!0,t.blend=!1,t.setColorWrite(!0,!0,!0,!0),t.side=e.ESide.FRONT,t.depthWrite=!0},WebGLRenderer.prototype.setClearColor=function(e){this._setClearOptions({color:e})},WebGLRenderer.prototype._renderSortedTransparentCommands=function(t){for(var r=this,n=0,i=e.SortUtils.insertSort(t,function(e,t){return r._getObjectZDistanceInCameraCoordinate(e)<r._getObjectZDistanceInCameraCoordinate(t)});n<i.length;n++){var a=i[n];a.execute()}},WebGLRenderer.prototype._getObjectZDistanceInCameraCoordinate=function(e){return e.mMatrix.applyMatrix(e.vMatrix,!0).getTranslation().z},WebGLRenderer.prototype._clearCommand=function(){this._commandQueue.forEach(function(e){e.dispose()}),this._commandQueue.removeAllChildren(),this.skyboxCommand&&(this.skyboxCommand.dispose(),this.skyboxCommand=null)},WebGLRenderer.prototype._setClearOptions=function(e){wdCb.ExtendUtils.extend(this._clearOptions,e)},WebGLRenderer.prototype._buildOpaqueCommandSortId=function(e){var t=e.target,r=e.material;e.sortId=(t.renderGroup<<s|t.renderPriority<<c|this._buildShaderSortId(r.shader)<<u|this._mapEntityIdToRenderId(this._getTargetTexture(r),i))*a+this._mapEntityIdToRenderId(this._getTargetBuffer(r),a)},WebGLRenderer.prototype._buildShaderSortId=function(e){return this._mapEntityIdToRenderId(e.program,n)},WebGLRenderer.prototype._getTargetTexture=function(e){return e.getTextureForRenderSort()},WebGLRenderer.prototype._getTargetBuffer=function(e){return e.geometry.buffers.getBufferForRenderSort()},WebGLRenderer.prototype._mapEntityIdToRenderId=function(e,t){return e?e.uid%t:1},WebGLRenderer.prototype._sortOpaqueQuadCommand=function(t){e.SortUtils.quickSort(t,function(e,t){return e.sortId<t.sortId},!0)},__decorate([e.ensure(function(){e.assert(!this._commandQueue.hasRepeatItems(),e.Log.info.FUNC_SHOULD_NOT("has duplicate render command"))})],WebGLRenderer.prototype,"addCommand",null),__decorate([e.require(function(){e.assert(!!this.webglState,e.Log.info.FUNC_MUST_DEFINE("webglState"))})],WebGLRenderer.prototype,"render",null),__decorate([e.require(function(t){e.assert(!!e.Director.getInstance().scene.currentCamera,e.Log.info.FUNC_NOT_EXIST("current camera"));for(var r=0,n=t;r<n.length;r++){var i=n[r];e.assert(i instanceof e.QuadCommand,e.Log.info.FUNC_MUST_BE("transparent command","QuadCommand"))}})],WebGLRenderer.prototype,"_renderSortedTransparentCommands",null),__decorate([e.require(function(n){var i=n.target;e.assert(i.renderGroup<=t&&i.renderGroup>=0,e.Log.info.FUNC_SHOULD("renderGroup:"+i.renderGroup,"in range:[0, "+t+"]")),e.assert(i.renderPriority<=r&&i.renderPriority>=0,e.Log.info.FUNC_SHOULD("renderPriority:"+i.renderPriority,"in range:[0, "+r+"]"))})],WebGLRenderer.prototype,"_buildOpaqueCommandSortId",null),__decorate([e.ensure(function(t,r,n){e.assert(t>=0&&t<=n,e.Log.info.FUNC_SHOULD("mappedId:"+t,"in range:[0, "+n+"]"))})],WebGLRenderer.prototype,"_mapEntityIdToRenderId",null),__decorate([e.require(function(t){for(var r=0,n=t;r<n.length;r++){var i=n[r];e.assert(i instanceof e.QuadCommand,e.Log.info.FUNC_MUST_BE("command","QuadCommand")),e.assert(i.blend===!1,e.Log.info.FUNC_MUST_BE("command","opaque command"))}})],WebGLRenderer.prototype,"_sortOpaqueQuadCommand",null),WebGLRenderer}(e.Renderer);e.WebGLRenderer=l}(wd||(wd={}));var wd;!function(e){var t=function(){function WebGLState(){}return WebGLState.prototype.getSide=function(t){var r=e.Director.getInstance().scene;return r.side?r.side:t.side},WebGLState}();e.WebGLState=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BasicState(){t.apply(this,arguments)}return __extends(BasicState,t),BasicState.create=function(){var e=new this;return e},BasicState.prototype.setState=function(t){var r=e.DeviceManager.getInstance();r.setColorWrite(t.redWrite,t.greenWrite,t.blueWrite,t.alphaWrite),r.polygonOffsetMode=t.polygonOffsetMode,r.side=this.getSide(t),r.blend=t.blend,t.blendFuncSeparate&&t.blendEquationSeparate?(r.setBlendFuncSeparate(t.blendFuncSeparate),r.setBlendEquationSeparate(t.blendEquationSeparate)):(r.setBlendFunc(t.blendSrc,t.blendDst),r.setBlendEquation(t.blendEquation)),t.alphaToCoverage&&(r.alphaToCoverage=t.alphaToCoverage)},__decorate([e.require(function(t){t.blendFuncSeparate&&t.blendEquationSeparate||e.assert(!!t.blendSrc&&!!t.blendDst&&!!t.blendEquation,wdCb.Log.info.FUNC_MUST("material.blendSrc && material.blendDst && material.blendEquation","be set"))})],BasicState.prototype,"setState",null),BasicState}(e.WebGLState);e.BasicState=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BuildShadowMapState(){t.apply(this,arguments)}return __extends(BuildShadowMapState,t),BuildShadowMapState.prototype.setState=function(t){var r=e.DeviceManager.getInstance();r.side=this.getSide(t),r.blend=!1},BuildShadowMapState}(e.WebGLState);e.BuildShadowMapState=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BuildTwoDShadowMapState(){t.apply(this,arguments)}return __extends(BuildTwoDShadowMapState,t),BuildTwoDShadowMapState.create=function(){var e=new this;return e},BuildTwoDShadowMapState.prototype.setState=function(r){var n=e.DeviceManager.getInstance();t.prototype.setState.call(this,r),e.GPUDetector.getInstance().extensionDepthTexture&&n.setColorWrite(!1,!1,!1,!1)},BuildTwoDShadowMapState}(e.BuildShadowMapState);e.BuildTwoDShadowMapState=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BuildCubemapShadowMapState(){e.apply(this,arguments)}return __extends(BuildCubemapShadowMapState,e),BuildCubemapShadowMapState.create=function(){var e=new this;return e},BuildCubemapShadowMapState}(e.BuildShadowMapState);e.BuildCubemapShadowMapState=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.POINTS="POINTS"]="POINTS",e[e.LINES="LINES"]="LINES",e[e.LINE_LOOP="LINE_LOOP"]="LINE_LOOP",e[e.LINE_STRIP="LINE_STRIP"]="LINE_STRIP",e[e.TRIANGLES="TRIANGLES"]="TRIANGLES",e[e.TRIANGLE_STRIP="TRIANGLE_STRIP"]="TRIANGLE_STRIP",e[e.TRANGLE_FAN="TRIANGLE_FAN"]="TRANGLE_FAN"}(e.EDrawMode||(e.EDrawMode={}));e.EDrawMode}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BYTE="BYTE"]="BYTE",e[e.UNSIGNED_BYTE="UNSIGNED_BYTE"]="UNSIGNED_BYTE",e[e.SHORT="SHORT"]="SHORT",e[e.UNSIGNED_SHORT="UNSIGNED_SHORT"]="UNSIGNED_SHORT",e[e.INT="INT"]="INT",e[e.UNSIGNED_INT="UNSIGNED_INT"]="UNSIGNED_INT",e[e.FLOAT="FLOAT"]="FLOAT"}(e.EBufferType||(e.EBufferType={}));e.EBufferType}(wd||(wd={}));var wd;!function(e){!function(e){e[e.VERTICE="VERTICE"]="VERTICE",e[e.INDICE="INDICE"]="INDICE",e[e.NORMAL="NORMAL"]="NORMAL",e[e.TEXCOORD="TEXCOORD"]="TEXCOORD",e[e.TANGENT="TANGENT"]="TANGENT",e[e.COLOR="COLOR"]="COLOR",e[e.CUSTOM="CUSTOM"]="CUSTOM"}(e.EBufferDataType||(e.EBufferDataType={}));e.EBufferDataType}(wd||(wd={}));var wd;!function(e){!function(e){e[e.STREAM_DRAW="STREAM_DRAW"]="STREAM_DRAW",e[e.STATIC_DRAW="STATIC_DRAW"]="STATIC_DRAW",e[e.DYNAMIC_DRAW="DYNAMIC_DRAW"]="DYNAMIC_DRAW"}(e.EBufferUsage||(e.EBufferUsage={}));e.EBufferUsage}(wd||(wd={}));var wd;!function(e){var t=function(t){function Buffer(){t.apply(this,arguments),this.buffer=null}return __extends(Buffer,t),Buffer.prototype.dispose=function(){e.DeviceManager.getInstance().gl.deleteBuffer(this.buffer),delete this.buffer},Buffer}(e.Entity);e.Buffer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function InstanceBuffer(){t.apply(this,arguments),this._capacity=2048,this._cacheMap=wdCb.Hash.create()}return __extends(InstanceBuffer,t),InstanceBuffer.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(InstanceBuffer.prototype,"float32InstanceArraySize",{get:function(){return this._capacity/4},enumerable:!0,configurable:!0}),InstanceBuffer.prototype.initWhenCreate=function(){this.buffer=this._createBuffer()},InstanceBuffer.prototype.setCapacity=function(t){for(var r=this._capacity;r<t;)r*=2;this._capacity<r&&(this._capacity=r,this.buffer&&e.DeviceManager.getInstance().gl.deleteBuffer(this.buffer),this.buffer=this._createBuffer())},InstanceBuffer.prototype.resetData=function(t){var r=e.DeviceManager.getInstance().gl;r.bindBuffer(r.ARRAY_BUFFER,this.buffer),r.bufferSubData(r.ARRAY_BUFFER,0,t)},InstanceBuffer.prototype.bindBuffer=function(){var t=e.DeviceManager.getInstance().gl;t.bindBuffer(t.ARRAY_BUFFER,this.buffer)},InstanceBuffer.prototype.addCache=function(e,t){this._cacheMap.addChild(e,t)},InstanceBuffer.prototype.getCache=function(e){return this._cacheMap.getChild(e)},InstanceBuffer.prototype._createBuffer=function(){var t=e.DeviceManager.getInstance().gl,r=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,this._capacity,t.DYNAMIC_DRAW),e.BufferTable.resetBindedArrayBuffer(),r},InstanceBuffer}(e.Buffer);e.InstanceBuffer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonBuffer(){t.apply(this,arguments),this.type=null,this.count=null,this.usage=null}return __extends(CommonBuffer,t),CommonBuffer.prototype.resetBufferData=function(t,r,n){void 0===n&&(n=0);var i=e.DeviceManager.getInstance().gl;return this.usage===e.EBufferUsage.STATIC_DRAW&&0===n?void i.bufferData(i[t],r,i.DYNAMIC_DRAW):void i.bufferSubData(i[t],n,r)},CommonBuffer}(e.Buffer);e.CommonBuffer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ElementBuffer(){t.apply(this,arguments),this.data=null}return __extends(ElementBuffer,t),ElementBuffer.create=function(t,r,n){void 0===r&&(r=null),void 0===n&&(n=e.EBufferUsage.STATIC_DRAW);var i=new this;return i.initWhenCreate(t,r,n),i},Object.defineProperty(ElementBuffer.prototype,"typeSize",{get:function(){return this.data.BYTES_PER_ELEMENT},enumerable:!0,configurable:!0}),ElementBuffer.prototype.initWhenCreate=function(t,r,n){var i=e.DeviceManager.getInstance().gl,a=null,o=null;return this.buffer=i.createBuffer(),this.buffer?t?(a=this._checkIsNeed32Bits(t,r),o=this._convertToTypedArray(a,t),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.buffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,o,i[n]),e.BufferTable.resetBindedElementBuffer(),this._saveData(o,this._getType(a,r),n),this.buffer):null:(e.Log.warn("Failed to create the this.buffer object"),null)},ElementBuffer.prototype.resetData=function(t,r,n){void 0===r&&(r=null),void 0===n&&(n=0);var i=e.DeviceManager.getInstance().gl,a=this._checkIsNeed32Bits(t,r),o=this._convertToTypedArray(a,t);return i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.buffer),this.resetBufferData("ELEMENT_ARRAY_BUFFER",o,n),this._saveData(o,this._getType(a,r),e.EBufferUsage.DYNAMIC_DRAW),this},ElementBuffer.prototype._convertToTypedArray=function(e,t){return e?new Uint32Array(t):new Uint16Array(t)},ElementBuffer.prototype._checkIsNeed32Bits=function(t,r){var n=!1;if(null!==r)return r===e.EBufferType.UNSIGNED_INT;if(e.GPUDetector.getInstance().extensionUintIndices)for(var i=0,a=t;i<a.length;i++){var o=a[i];if(o>65535){n=!0;break}}else n=!1;return n},ElementBuffer.prototype._getType=function(t,r){return null===r?t?e.EBufferType.UNSIGNED_INT:e.EBufferType.UNSIGNED_SHORT:r},ElementBuffer.prototype._saveData=function(e,t,r){this.type=t,this.count=e.length,this.data=e,this.usage=r},__decorate([e.ensureGetter(function(t){e.assert(t>0,e.Log.info.FUNC_SHOULD("typeSize","> 0, but actual is "+t))})],ElementBuffer.prototype,"typeSize",null),__decorate([e.require(function(t,r,n){void 0===r&&(r=null),void 0===n&&(n=0),e.assert(this.buffer,e.Log.info.FUNC_MUST("create gl buffer"))})],ElementBuffer.prototype,"resetData",null),__decorate([e.require(function(t,r){null!==r&&(t?e.assert(r===e.EBufferType.UNSIGNED_INT,e.Log.info.FUNC_MUST_BE("type","UNSIGNED_SHORT, but actual is "+r)):e.assert(r===e.EBufferType.UNSIGNED_SHORT||r===e.EBufferType.UNSIGNED_INT,e.Log.info.FUNC_MUST_BE("type","UNSIGNED_SHORT or UNSIGNED_INT, but actual is "+r)))})],ElementBuffer.prototype,"_getType",null),ElementBuffer}(e.CommonBuffer);e.ElementBuffer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ArrayBuffer(){t.apply(this,arguments),this.size=null,this.data=null}return __extends(ArrayBuffer,t),ArrayBuffer.create=function(t,r,n,i){void 0===n&&(n=e.EBufferType.FLOAT),void 0===i&&(i=e.EBufferUsage.STATIC_DRAW);var a=new this;return a.initWhenCreate(t,r,n,i),a},ArrayBuffer.prototype.initWhenCreate=function(t,r,n,i){var a=e.DeviceManager.getInstance().gl,o=null;return this.buffer=a.createBuffer(),this.buffer?t?(o=this._convertToTypedArray(t,n),a.bindBuffer(a.ARRAY_BUFFER,this.buffer),a.bufferData(a.ARRAY_BUFFER,o,a[i]),e.BufferTable.resetBindedArrayBuffer(),this._saveData(o,r,n,i),this.buffer):null:(e.Log.warn("Failed to create the this.buffer object"),null)},ArrayBuffer.prototype.resetData=function(t,r,n,i){void 0===r&&(r=this.size),void 0===n&&(n=this.type),void 0===i&&(i=0);var a=e.DeviceManager.getInstance().gl,o=this._convertToTypedArray(t,n);return a.bindBuffer(a.ARRAY_BUFFER,this.buffer),this.resetBufferData("ARRAY_BUFFER",o,i),this._saveData(o,r,n,e.EBufferUsage.DYNAMIC_DRAW),this},ArrayBuffer.prototype._convertToTypedArray=function(e,t){return new Float32Array(e)},ArrayBuffer.prototype._saveData=function(e,t,r,n){this.size=t,this.type=r,this.count=e.length/t,this.usage=n,this.data=e},__decorate([e.require(function(t,r,n,i){void 0===r&&(r=this.size),void 0===n&&(n=this.type),void 0===i&&(i=0),e.assert(this.buffer,e.Log.info.FUNC_MUST("create gl buffer"))})],ArrayBuffer.prototype,"resetData",null),ArrayBuffer}(e.CommonBuffer);e.ArrayBuffer=t}(wd||(wd={}));var wd;!function(e){var t=wdCb.Hash.create();t.addChild(e.EBufferDataType.VERTICE,"vertices"),t.addChild(e.EBufferDataType.INDICE,"indices"),t.addChild(e.EBufferDataType.NORMAL,"normals"),t.addChild(e.EBufferDataType.TEXCOORD,"texCoords"),t.addChild(e.EBufferDataType.COLOR,"colors"),t.addChild(e.EBufferDataType.TANGENT,"tangents");var r=function(){function BufferDataTable(){}return BufferDataTable.getGeometryDataName=function(e){var r=t.getChild(e);return r},__decorate([e.ensure(function(t,r){e.Log.error(void 0===t,e.Log.info.FUNC_NOT_EXIST(r,"in BufferDataTable"))})],BufferDataTable,"getGeometryDataName",null),BufferDataTable}();e.BufferDataTable=r}(wd||(wd={}));var wd;!function(e){var t=function(t){function Program(){t.apply(this,arguments),this.glProgram=null,this._getAttribLocationCache=wdCb.Hash.create(),this._sender=e.GLSLDataSender.create(this)}return __extends(Program,t),Program.create=function(){var e=new this;return e},Program.prototype.use=function(){e.JudgeUtils.isEqual(this,e.ProgramTable.lastUsedProgram)||(e.ProgramTable.lastUsedProgram=this,e.DeviceManager.getInstance().gl.useProgram(this.glProgram),this._sender.disableVertexAttribArray(),e.BufferTable.lastBindedArrayBufferListUidStr=null)},Program.prototype.getAttribLocation=function(t){var r=null,n=e.DeviceManager.getInstance().gl;return r=this._getAttribLocationCache.getChild(t),void 0!==r?r:(r=n.getAttribLocation(this.glProgram,t),this._getAttribLocationCache.addChild(t,r),r)},Program.prototype.getUniformLocation=function(e){return this._sender.getUniformLocation(e)},Program.prototype.sendUniformData=function(t,r,n){if(null!==n)switch(r){case e.EVariableType.FLOAT_1:this._sender.sendFloat1(t,n);break;case e.EVariableType.FLOAT_2:this._sender.sendFloat2(t,n);break;case e.EVariableType.FLOAT_3:this._sender.sendFloat3(t,n);break;case e.EVariableType.FLOAT_4:this._sender.sendFloat4(t,n);break;case e.EVariableType.VECTOR_2:this._sender.sendVector2(t,n);break;case e.EVariableType.VECTOR_3:this._sender.sendVector3(t,n);break;case e.EVariableType.VECTOR_4:this._sender.sendVector4(t,n);break;case e.EVariableType.FLOAT_MAT3:this._sender.sendMatrix3(t,n);break;case e.EVariableType.FLOAT_MAT4:this._sender.sendMatrix4(t,n);break;case e.EVariableType.NUMBER_1:case e.EVariableType.SAMPLER_CUBE:case e.EVariableType.SAMPLER_2D:this._sender.sendNum1(t,n);break;case e.EVariableType.SAMPLER_ARRAY:this._sender.sendSampleArray(t,n);break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("EVariableType:",r))}},Program.prototype.sendAttributeBuffer=function(e,t,r){var n=null;n=this.getAttribLocation(e),n!==-1&&this._sender.addBufferToToSendList(n,r)},Program.prototype.sendStructureData=function(e,t,r){this.sendUniformData(e,t,r)},Program.prototype.sendFloat1=function(e,t){this._sender.sendFloat1(e,t)},Program.prototype.sendFloat2=function(e,t){this._sender.sendFloat2(e,t)},Program.prototype.sendFloat3=function(e,t){this._sender.sendFloat3(e,t)},Program.prototype.sendFloat4=function(e,t){this._sender.sendFloat4(e,t)},Program.prototype.sendVector2=function(e,t){this._sender.sendVector2(e,t)},Program.prototype.sendVector3=function(e,t){this._sender.sendVector3(e,t)},Program.prototype.sendVector4=function(e,t){this._sender.sendVector4(e,t)},Program.prototype.sendColor4=function(e,t){this._sender.sendColor4(e,t)},Program.prototype.sendNum1=function(e,t){this._sender.sendNum1(e,t)},Program.prototype.sendMatrix3=function(e,t){this._sender.sendMatrix3(e,t)},Program.prototype.sendMatrix4=function(e,t){this._sender.sendMatrix4(e,t)},Program.prototype.sendSampleArray=function(e,t){this._sender.sendSampleArray(e,t)},Program.prototype.sendAllBufferData=function(e){this._sender.sendAllBufferData(e),this._sender.clearBufferList()},Program.prototype.initWithShader=function(t){var r=e.DeviceManager.getInstance().gl,n=null,i=null;return this.glProgram&&this.dispose(),this.glProgram=e.DeviceManager.getInstance().gl.createProgram(),n=t.createVsShader(),i=t.createFsShader(),r.attachShader(this.glProgram,n),r.attachShader(this.glProgram,i),r.bindAttribLocation(this.glProgram,0,"a_position"),r.linkProgram(this.glProgram),e.Log.error(r.getProgramParameter(this.glProgram,r.LINK_STATUS)===!1,r.getProgramInfoLog(this.glProgram)),r.deleteShader(n),r.deleteShader(i),this},Program.prototype.dispose=function(){var t=e.DeviceManager.getInstance().gl;t.deleteProgram(this.glProgram),this.glProgram=null,this._sender.dispose(),this._clearAllCache()},Program.prototype._clearAllCache=function(){this._getAttribLocationCache.removeAllChildren(),this._sender.clearAllCache()},__decorate([e.require(function(t,r,n){e.assert(n instanceof e.ArrayBuffer,e.Log.info.FUNC_MUST_BE("ArrayBuffer")),e.assert(r===e.EVariableType.BUFFER,e.Log.info.FUNC_SHOULD("type","be EVariableType.BUFFER, but actual is "+r))})],Program.prototype,"sendAttributeBuffer",null),Program}(e.Entity);e.Program=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GLSLDataSender(e){this._program=null,this._uniformCache={},this._vertexAttribHistory=[],this._getUniformLocationCache={},this._toSendBufferArr=[],this._toSendBuffersUidStr="",this._program=e}return GLSLDataSender.create=function(e){var t=new this(e);return t},GLSLDataSender.prototype.sendFloat1=function(t,r){var n=null,i=null;this._uniformCache[t]!=r&&(this._recordUniformData(t,r),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform1f(i,Number(r)))},GLSLDataSender.prototype.sendFloat2=function(t,r){var n=null,i=null,a=this._uniformCache[t];a&&a[0]===r[0]&&a[1]===r[1]||(this._recordUniformData(t,r),n=e.DeviceManager.getInstance().gl,
i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform2f(i,r[0],r[1]))},GLSLDataSender.prototype.sendFloat3=function(t,r){var n=null,i=null,a=this._uniformCache[t];a&&a[0]===r[0]&&a[1]===r[1]&&a[2]===r[2]||(this._recordUniformData(t,r),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform3f(i,r[0],r[1],r[2]))},GLSLDataSender.prototype.sendFloat4=function(t,r){var n=null,i=null,a=this._uniformCache[t];a&&a[0]===r[0]&&a[1]===r[1]&&a[2]===r[2]&&a[3]===r[3]||(this._recordUniformData(t,r),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform4f(i,r[0],r[1],r[2],r[3]))},GLSLDataSender.prototype.sendVector2=function(t,r){var n=null,i=null,a=this._uniformCache[t];if(!a||a[0]!=r.x||a[1]!=r.y){var o=r.x,s=r.y;this._recordUniformData(t,[o,s]),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform2f(i,o,s)}},GLSLDataSender.prototype.sendVector3=function(t,r){var n=null,i=null,a=this._uniformCache[t];if(!a||a[0]!=r.x||a[1]!=r.y||a[2]!=r.z){var o=r.x,s=r.y,c=r.z;this._recordUniformData(t,[o,s,c]),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform3f(i,o,s,c)}},GLSLDataSender.prototype.sendVector4=function(t,r){var n=null,i=null,a=this._uniformCache[t];if(!a||a[0]!=r.x||a[1]!=r.y||a[2]!=r.z||a[3]!=r.w){var o=r.x,s=r.y,c=r.z,u=r.w;this._recordUniformData(t,[o,s,c,u]),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform4f(i,o,s,c,u)}},GLSLDataSender.prototype.sendColor4=function(t,r){var n=null,i=null,a=this._uniformCache[t];if(!a||a[0]!=r.r||a[1]!=r.g||a[2]!=r.b||a[3]!=r.a){var o=r.r,s=r.g,c=r.b,u=r.a;this._recordUniformData(t,[o,s,c,u]),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform4f(i,o,s,c,u)}},GLSLDataSender.prototype.sendNum1=function(t,r){var n=null,i=null;this._uniformCache[t]!==r&&(this._recordUniformData(t,r),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform1i(i,r))},GLSLDataSender.prototype.sendMatrix3=function(t,r){var n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t);this._isUniformDataNotExistByLocation(i)||n.uniformMatrix3fv(i,!1,r.values)},GLSLDataSender.prototype.sendMatrix4=function(t,r){var n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t);this._isUniformDataNotExistByLocation(i)||n.uniformMatrix4fv(i,!1,r.values)},GLSLDataSender.prototype.sendSampleArray=function(t,r){var n=null,i=null,a=this._uniformCache[t],o=!0;if(a){for(var s=0,c=r.length;s<c;s++)if(a[s]!==r[s]){o=!1;break}if(o)return}this._recordUniformData(t,r),n=e.DeviceManager.getInstance().gl,i=this.getUniformLocation(t),this._isUniformDataNotExistByLocation(i)||n.uniform1iv(i,r)},GLSLDataSender.prototype.getUniformLocation=function(t){var r=null,n=e.DeviceManager.getInstance().gl;return r=this._getUniformLocationCache[t],void 0!==r?r:(r=n.getUniformLocation(this._program.glProgram,t),this._getUniformLocationCache[t]=r,r)},GLSLDataSender.prototype.addBufferToToSendList=function(e,t){this._toSendBufferArr[e]=t,this._toSendBuffersUidStr+=String(t.uid)},GLSLDataSender.prototype.sendAllBufferData=function(e){var t=this._toSendBufferArr;if(e)return void e.sendAllBufferData(this._toSendBuffersUidStr,t);for(var r=0,n=t.length;r<n;r++){var i=t[r];i&&this.sendBuffer(r,i)}},GLSLDataSender.prototype.clearBufferList=function(){this._toSendBufferArr=[],this._toSendBuffersUidStr=""},GLSLDataSender.prototype.sendBuffer=function(t,r){var n=e.DeviceManager.getInstance().gl;n.bindBuffer(n.ARRAY_BUFFER,r.buffer),n.vertexAttribPointer(t,r.size,n[r.type],!1,0,0),this._vertexAttribHistory[t]!==!0&&(n.enableVertexAttribArray(t),this._vertexAttribHistory[t]=!0)},GLSLDataSender.prototype.disableVertexAttribArray=function(){var t=e.DeviceManager.getInstance().gl;for(var r in this._vertexAttribHistory){var n=+r;n>t.VERTEX_ATTRIB_ARRAY_ENABLED||!this._vertexAttribHistory[n]||(this._vertexAttribHistory[n]=!1,t.disableVertexAttribArray(n))}this._vertexAttribHistory=[]},GLSLDataSender.prototype.clearAllCache=function(){this._getUniformLocationCache={},this._uniformCache={}},GLSLDataSender.prototype.dispose=function(){this.disableVertexAttribArray()},GLSLDataSender.prototype._recordUniformData=function(e,t){this._uniformCache[e]=t},GLSLDataSender.prototype._isUniformDataNotExistByLocation=function(e){return null===e},__decorate([e.require(function(t,r){e.assert(e.JudgeUtils.isNumber(r),e.Log.info.FUNC_MUST_BE("data","be number"))})],GLSLDataSender.prototype,"sendNum1",null),__decorate([e.require(function(t,r){e.assert(e.JudgeUtils.isArrayExactly(r),e.Log.info.FUNC_SHOULD("data","be array, but actual is "+r));for(var n=0,i=r;n<i.length;n++){var a=i[n];e.assert(e.JudgeUtils.isNumber(a),e.Log.info.FUNC_SHOULD("data","be Array<number>, but actual is "+r))}})],GLSLDataSender.prototype,"sendSampleArray",null),__decorate([e.require(function(){e.assert(!e.ArrayUtils.hasRepeatItems(this._toSendBufferArr),e.Log.info.FUNC_SHOULD_NOT("_toSendBufferArr","has repeat buffer"))}),e.cache(function(){return e.BufferTable.lastBindedArrayBufferListUidStr===this._toSendBuffersUidStr},function(){},function(){e.BufferTable.lastBindedArrayBufferListUidStr=this._toSendBuffersUidStr})],GLSLDataSender.prototype,"sendAllBufferData",null),GLSLDataSender}();e.GLSLDataSender=t}(wd||(wd={}));var wd;!function(e){var t=function(){function RenderCommand(){this._webglState=null,this.drawMode=e.EDrawMode.TRIANGLES,this.blend=!1,this.vaoManager=null}return Object.defineProperty(RenderCommand.prototype,"webglState",{get:function(){return this._webglState?this._webglState:e.BasicState.create()},set:function(e){this._webglState=e},enumerable:!0,configurable:!0}),RenderCommand.prototype.init=function(){},RenderCommand.prototype.dispose=function(){},RenderCommand.prototype.drawElements=function(t){var r=0,n=e.DeviceManager.getInstance().gl;e.BufferTable.bindIndexBuffer(t),e.GlUtils.drawElements(n[this.drawMode],t.count,n[t.type],t.typeSize*r)},RenderCommand.prototype.drawArray=function(t){var r=0,n=e.DeviceManager.getInstance().gl;e.GlUtils.drawArrays(n[this.drawMode],r,t.count)},__decorate([e.virtual],RenderCommand.prototype,"init",null),__decorate([e.virtual],RenderCommand.prototype,"dispose",null),RenderCommand}();e.RenderCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function QuadCommand(){t.apply(this,arguments),this.mMatrix=null,this.vMatrix=null,this.pMatrix=null,this.buffers=null,this.material=null,this.target=null,this.sortId=null}return __extends(QuadCommand,t),Object.defineProperty(QuadCommand.prototype,"program",{get:function(){return this.material.program},enumerable:!0,configurable:!0}),Object.defineProperty(QuadCommand.prototype,"mvpMatrix",{get:function(){return this.mMatrix.applyMatrix(this.vMatrix,!0).applyMatrix(this.pMatrix,!1)},enumerable:!0,configurable:!0}),Object.defineProperty(QuadCommand.prototype,"vpMatrix",{get:function(){return this.vMatrix.applyMatrix(this.pMatrix,!0)},enumerable:!0,configurable:!0}),QuadCommand.prototype.execute=function(){var e=this.material;e.updateShader(this),this.draw(e)},__decorate([e.requireGetter(function(){e.assert(!!this.mMatrix&&!!this.vMatrix&&!!this.pMatrix,e.Log.info.FUNC_NOT_EXIST("mMatrix or vMatrix or pMatrix"))})],QuadCommand.prototype,"mvpMatrix",null),__decorate([e.requireGetter(function(){e.assert(!!this.vMatrix&&!!this.pMatrix,e.Log.info.FUNC_NOT_EXIST("vMatrix or pMatrix"))})],QuadCommand.prototype,"vpMatrix",null),QuadCommand}(e.RenderCommand);e.QuadCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SingleDrawCommand(){t.apply(this,arguments),this.normalMatrix=null}return __extends(SingleDrawCommand,t),SingleDrawCommand.create=function(){var e=new this;return e},SingleDrawCommand.prototype.draw=function(t){var r=null,n=this.buffers.getChild(e.EBufferDataType.INDICE);this.webglState.setState(t),n?this.drawElements(n):(r=this.buffers.getChild(e.EBufferDataType.VERTICE),this.drawArray(r))},SingleDrawCommand}(e.QuadCommand);e.SingleDrawCommand=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.MODELMATRIX=0]="MODELMATRIX",e[e.NORMALMATRIX_MODELMATRIX=1]="NORMALMATRIX_MODELMATRIX",e[e.ONE_MANY=2]="ONE_MANY"}(e.EInstanceGLSLData||(e.EInstanceGLSLData={}));e.EInstanceGLSLData}(wd||(wd={}));var wd;!function(e){var t=function(e){function InstanceCommand(){e.apply(this,arguments)}return __extends(InstanceCommand,e),InstanceCommand}(e.QuadCommand);e.InstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function HardwareInstanceCommand(){e.apply(this,arguments),this.glslData=null,this.instanceBuffer=null}return __extends(HardwareInstanceCommand,e),HardwareInstanceCommand}(e.InstanceCommand);e.HardwareInstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToOneHardwareInstanceCommand(){t.apply(this,arguments),this.instanceList=null}return __extends(OneToOneHardwareInstanceCommand,t),OneToOneHardwareInstanceCommand.create=function(){var e=new this;return e},OneToOneHardwareInstanceCommand.prototype.draw=function(t){var r=null;if(this._hasInstance()){switch(this.webglState.setState(t),this.glslData){case e.EInstanceGLSLData.MODELMATRIX:r=e.ModelMatrixHardwareInstanceDrawer.getInstance();break;case e.EInstanceGLSLData.NORMALMATRIX_MODELMATRIX:r=e.NormalMatrixModelMatrixHardwareInstanceDrawer.getInstance();break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("glslData:"+this.glslData))}r.draw(this.instanceList,this.instanceBuffer,this.program,this.buffers,this.drawMode)}},OneToOneHardwareInstanceCommand.prototype._hasInstance=function(){return!!this.instanceList&&this.instanceList.getCount()>0},__decorate([e.ensure(function(t){e.assert(e.JudgeUtils.isBoolean(t),e.Log.info.FUNC_SHOULD("return boolean value")),t&&(e.assert(e.InstanceUtils.isHardwareSupport(),e.Log.info.FUNC_SHOULD("hardware","support instance")),e.assert(!!this.instanceBuffer,e.Log.info.FUNC_MUST_DEFINE("instanceBuffer")))})],OneToOneHardwareInstanceCommand.prototype,"_hasInstance",null),OneToOneHardwareInstanceCommand}(e.HardwareInstanceCommand);e.OneToOneHardwareInstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToManyHardwareInstanceCommand(){t.apply(this,arguments),this.geometry=null}return __extends(OneToManyHardwareInstanceCommand,t),OneToManyHardwareInstanceCommand.create=function(){var e=new this;return e},OneToManyHardwareInstanceCommand.prototype.draw=function(t){var r=null;this.webglState.setState(t),r=e.OneToManyHardwareInstanceDrawer.getInstance(),r.draw(this.geometry,this.instanceBuffer,this.program,this.buffers,this.drawMode)},__decorate([e.require(function(t){var r=this;e.it("glslData should be ONE_MANY",function(){e.expect(r.glslData).equals(e.EInstanceGLSLData.ONE_MANY)},this)})],OneToManyHardwareInstanceCommand.prototype,"draw",null),OneToManyHardwareInstanceCommand}(e.HardwareInstanceCommand);e.OneToManyHardwareInstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ProceduralCommand(){t.apply(this,arguments),this.shader=null,this.indexBuffer=null,this.vertexBuffer=null}return __extends(ProceduralCommand,t),ProceduralCommand.create=function(){var e=new this;return e},ProceduralCommand.prototype.init=function(){this.blend=!1,this.drawMode=e.EDrawMode.TRIANGLES},ProceduralCommand.prototype.execute=function(){this.shader.update(this),this.drawElements(this.indexBuffer)},ProceduralCommand}(e.RenderCommand);e.ProceduralCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(){function InstanceDrawer(){}return InstanceDrawer}();e.InstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function HardwareInstanceDrawer(){t.apply(this,arguments)}return __extends(HardwareInstanceDrawer,t),HardwareInstanceDrawer.prototype.unBind=function(t,r){var n=e.DeviceManager.getInstance().gl,i=e.GPUDetector.getInstance().extensionInstancedArrays;n.bindBuffer(n.ARRAY_BUFFER,t.buffer);for(var a=0,o=r;a<o.length;a++){var s=o[a];n.disableVertexAttribArray(s),i.vertexAttribDivisorANGLE(s,0)}},HardwareInstanceDrawer.prototype.drawElementsInstancedANGLE=function(t,r,n){var i=0,a=e.DeviceManager.getInstance().gl;e.BufferTable.bindIndexBuffer(t),e.GlUtils.drawElementsInstancedANGLE(a[n],t.count,a[t.type],t.typeSize*i,r)},HardwareInstanceDrawer}(e.InstanceDrawer);e.HardwareInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToOneHardwareInstanceDrawer(){t.apply(this,arguments)}return __extends(OneToOneHardwareInstanceDrawer,t),OneToOneHardwareInstanceDrawer.prototype.draw=function(t,r,n,i,a){var o=null,s=this.getOffsetLocationArray(n);if(this.setCapacity(t,r),this.sendGLSLData(t,r,s),o=i.getChild(e.EBufferDataType.INDICE))this.drawElementsInstancedANGLE(o,t.getCount(),a);else{var c=i.getChild(e.EBufferDataType.VERTICE);this._drawArraysInstancedANGLE(c,t.getCount(),a)}this.unBind(r,s)},OneToOneHardwareInstanceDrawer.prototype._drawArraysInstancedANGLE=function(t,r,n){var i=0,a=e.DeviceManager.getInstance().gl;e.GlUtils.drawArraysInstancedANGLE(a[n],i,t.count,r)},__decorate([e.require(function(){e.assert(e.InstanceUtils.isHardwareSupport(),e.Log.info.FUNC_SHOULD("hardware","support instance"))})],OneToOneHardwareInstanceDrawer.prototype,"draw",null),OneToOneHardwareInstanceDrawer}(e.HardwareInstanceDrawer);e.OneToOneHardwareInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToManyHardwareInstanceDrawer(){t.call(this),this._geometry=null}return __extends(OneToManyHardwareInstanceDrawer,t),OneToManyHardwareInstanceDrawer.getInstance=function(){},OneToManyHardwareInstanceDrawer.prototype.draw=function(t,r,n,i,a){var o=null,s=null;this._geometry=t,s=this.getOffsetLocationArray(n,r),this.setCapacity(r),this.sendGLSLData(r,s),o=i.getChild(e.EBufferDataType.INDICE),this.drawElementsInstancedANGLE(o,this._geometry.instanceCount,a),this.unBind(r,s),this._geometry.dirty&&(this._geometry.dirty=!1)},OneToManyHardwareInstanceDrawer.prototype.getOffsetLocationArray=function(e,t){return this._geometry.instanceAttributeData.map(function(t){return e.getAttribLocation(t.attributeName)}).toArray()},OneToManyHardwareInstanceDrawer.prototype.setCapacity=function(e){e.setCapacity(this._geometry.instanceCount*this._getStride(e))},OneToManyHardwareInstanceDrawer.prototype.sendGLSLData=function(t,r){var n=new Float32Array(t.float32InstanceArraySize),i=0,a=this._geometry.attributeData,o=this._geometry.instanceAttributeData,s=e.DeviceManager.getInstance().gl,c=e.GPUDetector.getInstance().extensionInstancedArrays;this._geometry.dirty?(a.forEach(function(e){e.forEach(function(e){n.set(e.data,i),i+=e.data.length})}),t.resetData(n)):t.bindBuffer();var u=this._getStride(t);i=0,o.forEach(function(e,t){var n=r[t],a=e.data.length;s.enableVertexAttribArray(n),s.vertexAttribPointer(n,a,s.FLOAT,!1,u,i),c.vertexAttribDivisorANGLE(n,e.meshPerAttribute),i+=4*a})},OneToManyHardwareInstanceDrawer.prototype._getStride=function(e){var t=0;return this._geometry.instanceAttributeData.forEach(function(e){t+=4*e.data.length}),t},__decorate([e.require(function(t,r,n,i,a){e.it("hardware should support instance",function(){e.expect(e.InstanceUtils.isHardwareSupport()).true}),e.it("indexBuffer should exist",function(){e.expect(i.getChild(e.EBufferDataType.INDICE)).exist})})],OneToManyHardwareInstanceDrawer.prototype,"draw",null),__decorate([e.require(function(t,r){var n=this;e.it("if cached, should geometry.dirty === false && has cache data",function(){n._geometry.dirty||e.expect(r.getCache("offsetLocationArray")).exist})}),e.cache(function(e,t){return!this._geometry.dirty},function(e,t){return t.getCache("offsetLocationArray")},function(e,t,r){r.addCache("offsetLocationArray",e)})],OneToManyHardwareInstanceDrawer.prototype,"getOffsetLocationArray",null),__decorate([e.require(function(t){var r=this;e.it("if cached, should geometry.dirty === false && has cache data",function(){r._geometry.dirty||e.expect(t.getCache("stride")).exist})}),e.cache(function(e){return!this._geometry.dirty},function(e){return e.getCache("stride")},function(e,t){t.addCache("stride",e)})],OneToManyHardwareInstanceDrawer.prototype,"_getStride",null),OneToManyHardwareInstanceDrawer=__decorate([e.singleton()],OneToManyHardwareInstanceDrawer)}(e.HardwareInstanceDrawer);e.OneToManyHardwareInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ModelMatrixHardwareInstanceDrawer(){t.call(this)}return __extends(ModelMatrixHardwareInstanceDrawer,t),ModelMatrixHardwareInstanceDrawer.getInstance=function(){},ModelMatrixHardwareInstanceDrawer.prototype.getOffsetLocationArray=function(e){return[e.getAttribLocation("a_mVec4_0"),e.getAttribLocation("a_mVec4_1"),e.getAttribLocation("a_mVec4_2"),e.getAttribLocation("a_mVec4_3")]},ModelMatrixHardwareInstanceDrawer.prototype.setCapacity=function(e,t){t.setCapacity(64*e.getCount())},ModelMatrixHardwareInstanceDrawer.prototype.sendGLSLData=function(t,r,n){var i=new Float32Array(r.float32InstanceArraySize),a=0,o=e.DeviceManager.getInstance().gl,s=e.GPUDetector.getInstance().extensionInstancedArrays;t.forEach(function(e){var t=e.transform.localToWorldMatrix;t.cloneToArray(i,a),a+=16}),r.resetData(i);for(var c=0;c<4;c++){var u=n[c];o.enableVertexAttribArray(u),o.vertexAttribPointer(u,4,o.FLOAT,!1,64,16*c),s.vertexAttribDivisorANGLE(u,1)}},ModelMatrixHardwareInstanceDrawer=__decorate([e.singleton()],ModelMatrixHardwareInstanceDrawer)}(e.OneToOneHardwareInstanceDrawer);e.ModelMatrixHardwareInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function NormalMatrixModelMatrixHardwareInstanceDrawer(){t.call(this)}return __extends(NormalMatrixModelMatrixHardwareInstanceDrawer,t),NormalMatrixModelMatrixHardwareInstanceDrawer.getInstance=function(){},NormalMatrixModelMatrixHardwareInstanceDrawer.prototype.getOffsetLocationArray=function(e){return[e.getAttribLocation("a_mVec4_0"),e.getAttribLocation("a_mVec4_1"),e.getAttribLocation("a_mVec4_2"),e.getAttribLocation("a_mVec4_3"),e.getAttribLocation("a_normalVec4_0"),e.getAttribLocation("a_normalVec4_1"),e.getAttribLocation("a_normalVec4_2")]},NormalMatrixModelMatrixHardwareInstanceDrawer.prototype.setCapacity=function(e,t){t.setCapacity(112*e.getCount())},NormalMatrixModelMatrixHardwareInstanceDrawer.prototype.sendGLSLData=function(t,r,n){var i=new Float32Array(r.float32InstanceArraySize),a=0,o=e.DeviceManager.getInstance().gl,s=e.GPUDetector.getInstance().extensionInstancedArrays;t.forEach(function(e){var t=e.transform.localToWorldMatrix,r=e.transform.normalMatrix;t.cloneToArray(i,a),a+=16,r.cloneToArray(i,a),a+=9}),r.resetData(i);for(var c=0;c<4;c++){var u=n[c];o.enableVertexAttribArray(u),o.vertexAttribPointer(u,4,o.FLOAT,!1,100,16*c),s.vertexAttribDivisorANGLE(u,1)}for(var c=4;c<7;c++){var u=n[c];o.enableVertexAttribArray(u),o.vertexAttribPointer(u,3,o.FLOAT,!1,100,12*(c-4)+64),s.vertexAttribDivisorANGLE(u,1)}},NormalMatrixModelMatrixHardwareInstanceDrawer=__decorate([e.singleton()],NormalMatrixModelMatrixHardwareInstanceDrawer)}(e.OneToOneHardwareInstanceDrawer);e.NormalMatrixModelMatrixHardwareInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BatchInstanceCommand(){e.apply(this,arguments),this.glslData=null}return __extends(BatchInstanceCommand,e),BatchInstanceCommand}(e.InstanceCommand);e.BatchInstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToOneBatchInstanceCommand(){t.apply(this,arguments),this.instanceList=null}return __extends(OneToOneBatchInstanceCommand,t),OneToOneBatchInstanceCommand.create=function(){var e=new this;return e},OneToOneBatchInstanceCommand.prototype.draw=function(t){var r=null;if(this._hasInstance()){switch(this.webglState.setState(t),this.glslData){case e.EInstanceGLSLData.MODELMATRIX:r=e.ModelMatrixBatchInstanceDrawer.getInstance();break;case e.EInstanceGLSLData.NORMALMATRIX_MODELMATRIX:r=e.NormalMatrixModelMatrixBatchInstanceDrawer.getInstance();break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("glslData:"+this.glslData))}r.draw(this.instanceList,this.program,this.buffers,this.drawMode)}},OneToOneBatchInstanceCommand.prototype._hasInstance=function(){return!!this.instanceList&&this.instanceList.getCount()>0},__decorate([e.ensure(function(t){e.assert(e.JudgeUtils.isBoolean(t),e.Log.info.FUNC_SHOULD("return boolean value")),t&&e.assert(!e.InstanceUtils.isHardwareSupport(),e.Log.info.FUNC_SHOULD_NOT("hardware","support instance"))})],OneToOneBatchInstanceCommand.prototype,"_hasInstance",null),OneToOneBatchInstanceCommand}(e.BatchInstanceCommand);e.OneToOneBatchInstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToManyBatchInstanceCommand(){t.apply(this,arguments),this.geometry=null}return __extends(OneToManyBatchInstanceCommand,t),OneToManyBatchInstanceCommand.create=function(){var e=new this;return e},OneToManyBatchInstanceCommand.prototype.draw=function(t){var r=null;r=e.OneToManyBatchInstanceDrawer.getInstance(),r.draw(this.geometry,this.program,this.buffers,this.drawMode)},OneToManyBatchInstanceCommand}(e.BatchInstanceCommand);e.OneToManyBatchInstanceCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BatchInstanceDrawer(){e.apply(this,arguments)}return __extends(BatchInstanceDrawer,e),BatchInstanceDrawer}(e.InstanceDrawer);e.BatchInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToOneBatchInstanceDrawer(){t.apply(this,arguments)}return __extends(OneToOneBatchInstanceDrawer,t),OneToOneBatchInstanceDrawer.prototype.draw=function(t,r,n,i){var a=this,o=null,s=null,c=e.DeviceManager.getInstance().gl;if(s=this.getUniformDataNameArray(r),o=n.getChild(e.EBufferDataType.INDICE))e.BufferTable.bindIndexBuffer(o),t.forEach(function(t){var n=0;a.sendGLSLData(r,t,s),e.GlUtils.drawElements(c[i],o.count,c[o.type],o.typeSize*n)},this);else{var u=n.getChild(e.EBufferDataType.VERTICE);t.forEach(function(t){var n=0;a.sendGLSLData(r,t,s),e.GlUtils.drawArrays(c[i],n,u.count)},this)}},__decorate([e.require(function(t,r,n,i){e.it("hardware shouldn't support instance",function(){e.expect(e.InstanceUtils.isHardwareSupport()).false})})],OneToOneBatchInstanceDrawer.prototype,"draw",null),OneToOneBatchInstanceDrawer}(e.BatchInstanceDrawer);e.OneToOneBatchInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function OneToManyBatchInstanceDrawer(){t.call(this),this._geometry=null}return __extends(OneToManyBatchInstanceDrawer,t),OneToManyBatchInstanceDrawer.getInstance=function(){},OneToManyBatchInstanceDrawer.prototype.draw=function(t,r,n,i){var a=this,o=null,s=null,c=e.DeviceManager.getInstance().gl;this._geometry=t,o=n.getChild(e.EBufferDataType.INDICE),e.BufferTable.bindIndexBuffer(o),this._geometry.attributeData.forEach(function(t){a.sendGLSLData(r,t),s=0,e.GlUtils.drawElements(c[i],o.count,c[o.type],o.typeSize*s)},this)},OneToManyBatchInstanceDrawer.prototype.sendGLSLData=function(e,t){var r=this;t.forEach(function(t){var n=t.data;e.sendUniformData(t.attributeName,r._getVariableType(n.length),n)})},OneToManyBatchInstanceDrawer.prototype._getVariableType=function(t){switch(t){case 1:return e.EVariableType.FLOAT_1;case 2:return e.EVariableType.FLOAT_2;case 3:return e.EVariableType.FLOAT_3;case 4:return e.EVariableType.FLOAT_4;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("size:"+t))}},__decorate([e.require(function(t,r,n,i){e.it("hardware shouldn't support instance",function(){e.expect(e.InstanceUtils.isHardwareSupport()).false}),e.it("indexBuffer should exist",function(){e.expect(n.getChild(e.EBufferDataType.INDICE)).exist})})],OneToManyBatchInstanceDrawer.prototype,"draw",null),OneToManyBatchInstanceDrawer=__decorate([e.singleton()],OneToManyBatchInstanceDrawer)}(e.BatchInstanceDrawer);e.OneToManyBatchInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ModelMatrixBatchInstanceDrawer(){t.call(this)}return __extends(ModelMatrixBatchInstanceDrawer,t),ModelMatrixBatchInstanceDrawer.getInstance=function(){},ModelMatrixBatchInstanceDrawer.prototype.getUniformDataNameArray=function(e){return["u_mMatrix"]},ModelMatrixBatchInstanceDrawer.prototype.sendGLSLData=function(t,r,n){var i=n[0];t.sendUniformData(i,e.EVariableType.FLOAT_MAT4,r.transform.localToWorldMatrix)},ModelMatrixBatchInstanceDrawer=__decorate([e.singleton()],ModelMatrixBatchInstanceDrawer)}(e.OneToOneBatchInstanceDrawer);e.ModelMatrixBatchInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function NormalMatrixModelMatrixBatchInstanceDrawer(){t.call(this)}return __extends(NormalMatrixModelMatrixBatchInstanceDrawer,t),NormalMatrixModelMatrixBatchInstanceDrawer.getInstance=function(){},NormalMatrixModelMatrixBatchInstanceDrawer.prototype.getUniformDataNameArray=function(e){return["u_mMatrix","u_normalMatrix"]},NormalMatrixModelMatrixBatchInstanceDrawer.prototype.sendGLSLData=function(t,r,n){var i=n[0],a=n[1];t.sendUniformData(i,e.EVariableType.FLOAT_MAT4,r.transform.localToWorldMatrix),t.sendUniformData(a,e.EVariableType.FLOAT_MAT3,r.transform.normalMatrix)},NormalMatrixModelMatrixBatchInstanceDrawer=__decorate([e.singleton()],NormalMatrixModelMatrixBatchInstanceDrawer)}(e.OneToOneBatchInstanceDrawer);e.NormalMatrixModelMatrixBatchInstanceDrawer=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GlUtils(){}return GlUtils.drawElements=function(t,r,n,i){e.DebugStatistics.count.drawCalls++,e.DebugStatistics.count.renderGameObjects++,this._getGl().drawElements(t,r,n,i)},GlUtils.drawArrays=function(t,r,n){e.DebugStatistics.count.drawCalls++,e.DebugStatistics.count.renderGameObjects++,this._getGl().drawArrays(t,r,n)},GlUtils.drawElementsInstancedANGLE=function(t,r,n,i,a){var o=e.GPUDetector.getInstance().extensionInstancedArrays;e.DebugStatistics.count.drawCalls++,e.DebugStatistics.count.renderGameObjects+=a,o.drawElementsInstancedANGLE(t,r,n,i,a)},GlUtils.drawArraysInstancedANGLE=function(t,r,n,i){var a=e.GPUDetector.getInstance().extensionInstancedArrays;e.DebugStatistics.count.drawCalls++,e.DebugStatistics.count.renderGameObjects+=i,a.drawArraysInstancedANGLE(t,r,n,i)},GlUtils._getGl=function(){return e.DeviceManager.getInstance().gl},GlUtils}();e.GlUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function FrameBuffer(e,t){this.width=null,this.height=null,this._originScissorTest=null,this._glTarget=null,this.width=e,this.height=t}return FrameBuffer.create=function(e,t){var r=new this(e,t);return r},Object.defineProperty(FrameBuffer.prototype,"gl",{get:function(){return e.DeviceManager.getInstance().gl},enumerable:!0,configurable:!0}),FrameBuffer.prototype.createFrameBuffer=function(){return this.gl.createFramebuffer()},FrameBuffer.prototype.bindFrameBuffer=function(e){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e)},FrameBuffer.prototype.setViewport=function(){var t=e.DeviceManager.getInstance();t.setViewport(0,0,this.width,this.height),this._originScissorTest=t.scissorTest,t.scissorTest=!1},FrameBuffer.prototype.restoreViewport=function(){var t=e.DeviceManager.getInstance(),r=t.view;t.setViewport(0,0,r.width,r.height),t.scissorTest=this._originScissorTest},FrameBuffer.prototype.dispose=function(){this.unBindAll()},FrameBuffer.prototype.unBindAll=function(){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null)},FrameBuffer.prototype.unBindFrameBuffer=function(){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)},FrameBuffer.prototype.createRenderBuffer=function(){var e=this.gl,t=e.createRenderbuffer();return t},FrameBuffer.prototype.attachTexture=function(t,r,n){void 0===n&&(n=e.EFrameBufferAttachType.COLOR_ATTACHMENT0);var i=this.gl;i.framebufferTexture2D(i.FRAMEBUFFER,i[n],t,r,0),this._glTarget=t},FrameBuffer.prototype.attachRenderBuffer=function(e,t){var r=this.gl;r.bindRenderbuffer(r.RENDERBUFFER,t),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,this.width,this.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r[e],r.RENDERBUFFER,t)},FrameBuffer.prototype.check=function(){var t=this.gl,r=t.checkFramebufferStatus(t.FRAMEBUFFER);r!==t.FRAMEBUFFER_COMPLETE&&e.Log.error(!0,"Frame buffer object is incomplete:"+r.toString())},__decorate([e.ensure(function(){var t=e.DeviceManager.getInstance();e.assert(null!==t.scissorTest,e.Log.info.FUNC_SHOULD_NOT("DeviceManager->scissorTest","be null"))})],FrameBuffer.prototype,"restoreViewport",null),__decorate([e.require(function(){})],FrameBuffer.prototype,"unBindAll",null),__decorate([e.ensure(function(t){e.assert(!!t,e.Log.info.FUNC_NOT_EXIST("renderbuffer object"))})],FrameBuffer.prototype,"createRenderBuffer",null),FrameBuffer}();e.FrameBuffer=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.COLOR_ATTACHMENT0="COLOR_ATTACHMENT0"]="COLOR_ATTACHMENT0",e[e.DEPTH_ATTACHMENT="DEPTH_ATTACHMENT"]="DEPTH_ATTACHMENT"}(e.EFrameBufferAttachType||(e.EFrameBufferAttachType={}));e.EFrameBufferAttachType}(wd||(wd={}));var wd;!function(e){var t=function(){function Shader(){this._attributes=wdCb.Hash.create(),this._uniforms=wdCb.Hash.create(),this._vsSource="",this._fsSource="",this.libDirty=!1,this.definitionDataDirty=!1,this.mapManager=e.MapManager.create(),this.libs=wdCb.Collection.create(),this.sourceBuilder=this.createShaderSourceBuilder(),this._programCache=null,this._instanceStateCache=null}return Object.defineProperty(Shader.prototype,"attributes",{get:function(){return this._attributes},set:function(e){this._isNotEqual(e,this._attributes)&&(this.definitionDataDirty=!0),this._attributes=e},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"uniforms",{get:function(){return this._uniforms},set:function(e){this._isNotEqual(e,this._uniforms)&&(this.definitionDataDirty=!0),this._uniforms=e},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"vsSource",{get:function(){return this._vsSource},set:function(e){e!==this._vsSource&&(this.definitionDataDirty=!0),this._vsSource=e},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"fsSource",{get:function(){return this._fsSource},set:function(e){e!==this._fsSource&&(this.definitionDataDirty=!0),this._fsSource=e},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"dirty",{get:function(){return this.libDirty||this.definitionDataDirty},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"program",{get:function(){return e.ProgramTable.getProgram(this._getProgramTableKey())},enumerable:!0,configurable:!0}),Shader.prototype.createVsShader=function(){var t=e.DeviceManager.getInstance().gl;return this._initShader(t.createShader(t.VERTEX_SHADER),this.vsSource)},Shader.prototype.createFsShader=function(){var t=e.DeviceManager.getInstance().gl;return this._initShader(t.createShader(t.FRAGMENT_SHADER),this.fsSource)},Shader.prototype.init=function(e){this.libs.forEach(function(e){e.init()}),this.judgeRefreshShader(null,e),this.mapManager.init()},Shader.prototype.dispose=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.libs.forEach(function(e){e.dispose()}),this.mapManager.dispose(),this._clearAllCache()},Shader.prototype.hasLib=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];if(t[0]instanceof e.ShaderLib){var n=t[0];return this.libs.hasChild(n)}var i=t[0];return this.libs.hasChildWithFunc(function(e){return e instanceof i})},Shader.prototype.addLib=function(e){this.libs.addChild(e),e.shader=this,this.libDirty=!0},Shader.prototype.addShaderLibToTop=function(e){this.libs.unShiftChild(e),e.shader=this,this.libDirty=!0},Shader.prototype.getLib=function(e){return this.libs.findOne(function(t){return t instanceof e})},Shader.prototype.getLibs=function(){return this.libs},Shader.prototype.removeLib=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return this.libDirty=!0,this.libs.removeChild(e[0])},Shader.prototype.removeAllLibs=function(){
this.libDirty=!0,this.libs.removeAllChildren()},Shader.prototype.sortLib=function(e){this.libDirty=!0,this.libs.sort(e,!0)},Shader.prototype.getInstanceState=function(){var t=!1,r=!1,n=!1,i=!1;return this.libs.forEach(function(a){if(a instanceof e.InstanceShaderLib)return a instanceof e.NormalMatrixHardwareInstanceShaderLib?(r=!0,n=!0,wdCb.$BREAK):a instanceof e.NormalMatrixBatchInstanceShaderLib?(r=!0,i=!0,wdCb.$BREAK):a instanceof e.ModelMatrixHardwareInstanceShaderLib?(t=!0,void(n=!0)):a instanceof e.ModelMatrixBatchInstanceShaderLib?(t=!0,void(i=!0)):void 0}),{isModelMatrixInstance:t,isNormalMatrixInstance:r,isHardwareInstance:n,isBatchInstance:i}},Shader.prototype.judgeRefreshShader=function(e,t){this.libDirty&&(this._instanceStateCache=null,this.buildDefinitionData(e,t)),this.definitionDataDirty&&(this._programCache=null,this._registerAndUpdateProgram(),this._programCache=null),this.libDirty=!1,this.definitionDataDirty=!1},Shader.prototype._registerAndUpdateProgram=function(){var t=this._getProgramTableKey();e.ProgramTable.hasProgram(t)||(e.ProgramTable.addProgram(t,e.Program.create()),this._updateProgram())},Shader.prototype._updateProgram=function(){this.program.initWithShader(this)},Shader.prototype._getProgramTableKey=function(){return this.vsSource+"\n"+this.fsSource},Shader.prototype._initShader=function(t,r){var n=e.DeviceManager.getInstance().gl;return n.shaderSource(t,r),n.compileShader(t),n.getShaderParameter(t,n.COMPILE_STATUS)?t:(e.Log.log(n.getShaderInfoLog(t)),e.Log.log("attributes:\n",this.attributes),e.Log.log("uniforms:\n",this.uniforms),e.Log.log("source:\n",r),void 0)},Shader.prototype._isNotEqual=function(e,t){var r=!1;return e.forEach(function(e,n){var i=t.getChild(n);if(!i||e.type!==i.type||e.value!==i.value)return r=!0,wdCb.$BREAK}),r},Shader.prototype._clearAllCache=function(){this._programCache=null,this._instanceStateCache=null},__decorate([e.ensureGetter(function(t){e.it("program should exist(its table key is "+this._getProgramTableKey(),function(){e.expect(t).exist},this)}),e.cacheGetter(function(){return null!==this._programCache},function(){return this._programCache},function(e){this._programCache=e})],Shader.prototype,"program",null),__decorate([e.execOnlyOnce("_isInit")],Shader.prototype,"init",null),__decorate([e.ensure(function(){var t=this;e.it("should set ShaderLib.shader to be this",function(){t.libs.forEach(function(r){e.expect(r.shader===t).true})},this),e.it("libDirty should be true",function(){e.expect(t.libDirty).true},this)})],Shader.prototype,"addLib",null),__decorate([e.ensure(function(t,r){var n=this;e.it("should add shader lib to the top",function(){e.expect(e.JudgeUtils.isEqual(r,n.libs.getChild(0))).true},this),e.it("should set ShaderLib.shader to be this",function(){n.libs.forEach(function(t){e.expect(t.shader===n).true})},this),e.it("libDirty should be true",function(){e.expect(n.libDirty).true},this)})],Shader.prototype,"addShaderLibToTop",null),__decorate([e.ensure(function(t){var r=t.isModelMatrixInstance,n=t.isNormalMatrixInstance,i=t.isHardwareInstance,a=t.isBatchInstance;n&&e.it("if is normalMatrixInstance, should also be modelMatrixInstance",function(){e.expect(r).true}),e.it("shouldn't both be hardware insstance and batch instance",function(){e.expect(i&&a).false})}),e.cache(function(){return this._instanceStateCache},function(){return this._instanceStateCache},function(e){this._instanceStateCache=e})],Shader.prototype,"getInstanceState",null),Shader}();e.Shader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomShader(){t.apply(this,arguments)}return __extends(CustomShader,t),CustomShader.create=function(){var e=new this;return e},CustomShader.prototype.update=function(e,t){var r=null;this.judgeRefreshShader(e,t),r=this.program,r.use(),this.libs.forEach(function(n){n.sendShaderVariables(r,e,t)}),this.mapManager.bindAndUpdate(),this.mapManager.sendData(r)},CustomShader.prototype.read=function(e){this.sourceBuilder.clearShaderDefinition(),this.sourceBuilder.read(e),this.libDirty=!0},CustomShader.prototype.getSampler2DUniformsAfterRead=function(){return this.sourceBuilder.uniforms.filter(function(t,r){return t.type===e.EVariableType.SAMPLER_2D})},CustomShader.prototype.buildDefinitionData=function(e,t){this.sourceBuilder.build(),this.attributes=this.sourceBuilder.attributes,this.uniforms=this.sourceBuilder.uniforms,this.vsSource=this.sourceBuilder.vsSource,this.fsSource=this.sourceBuilder.fsSource},CustomShader.prototype.createShaderSourceBuilder=function(){return e.CustomShaderSourceBuilder.create()},CustomShader}(e.Shader);e.CustomShader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EngineShader(){t.apply(this,arguments)}return __extends(EngineShader,t),EngineShader.prototype.buildDefinitionData=function(e,t){this.libs.forEach(function(r){r.setShaderDefinition(e,t)}),this.sourceBuilder.clearShaderDefinition(),this.sourceBuilder.build(this.libs),this.attributes=this.sourceBuilder.attributes,this.uniforms=this.sourceBuilder.uniforms,this.vsSource=this.sourceBuilder.vsSource,this.fsSource=this.sourceBuilder.fsSource},EngineShader.prototype.createShaderSourceBuilder=function(){return e.EngineShaderSourceBuilder.create()},EngineShader}(e.Shader);e.EngineShader=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CommonShader(){e.apply(this,arguments)}return __extends(CommonShader,e),CommonShader.create=function(){var e=new this;return e},CommonShader.prototype.update=function(e,t){var r=null;this.judgeRefreshShader(e,t),r=this.program,r.use(),this.libs.forEach(function(n){n.sendShaderVariables(r,e,t)}),this.mapManager.bindAndUpdate(),this.mapManager.sendData(r)},CommonShader}(e.EngineShader);e.CommonShader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ProceduralShader(){t.apply(this,arguments)}return __extends(ProceduralShader,t),ProceduralShader.prototype.init=function(){this.addLib(e.CommonProceduralShaderLib.create()),t.prototype.init.call(this,null)},ProceduralShader.prototype.update=function(e){var t=null;this.judgeRefreshShader(e,null),t=this.program,t.use(),this.libs.forEach(function(r){r.sendShaderVariables(t,e)})},ProceduralShader}(e.EngineShader);e.ProceduralShader=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CommonProceduralShader(){e.apply(this,arguments)}return __extends(CommonProceduralShader,e),CommonProceduralShader.create=function(){var e=new this;return e},CommonProceduralShader}(e.ProceduralShader);e.CommonProceduralShader=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CustomProceduralShader(t){e.call(this),this._texture=null,this._texture=t}return __extends(CustomProceduralShader,e),CustomProceduralShader.create=function(e){var t=new this(e);return t},CustomProceduralShader.prototype.update=function(t){e.prototype.update.call(this,t),this._texture.mapManager.bindAndUpdate(),this._texture.mapManager.sendData(this.program)},CustomProceduralShader}(e.ProceduralShader);e.CustomProceduralShader=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.MIRROR="MIRROR"]="MIRROR",e[e.DYNAMIC_CUBEMAP="DYNAMIC_CUBEMAP"]="DYNAMIC_CUBEMAP",e[e.REFRACTION="REFRACTION"]="REFRACTION",e[e.TWOD_SHADOWMAP="TWOD_SHADOWMAP"]="TWOD_SHADOWMAP",e[e.BUILD_CUBEMAP_SHADOWMAP="BUILD_CUBEMAP_SHADOWMAP"]="BUILD_CUBEMAP_SHADOWMAP",e[e.CUBEMAP_SHADOWMAP="CUBEMAP_SHADOWMAP"]="CUBEMAP_SHADOWMAP"}(e.EShaderGLSLData||(e.EShaderGLSLData={}));e.EShaderGLSLData}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BUILD_TWOD_SHADOWMAP="BUILD_TWOD_SHADOWMAP"]="BUILD_TWOD_SHADOWMAP",e[e.BUILD_CUBEMAP_SHADOWMAP="BUILD_CUBEMAP_SHADOWMAP"]="BUILD_CUBEMAP_SHADOWMAP"}(e.EShaderTypeOfScene||(e.EShaderTypeOfScene={}));e.EShaderTypeOfScene}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BUILD_TWOD_SHADOWMAP_INSTANCE="BUILD_TWOD_SHADOWMAP_INSTANCE"]="BUILD_TWOD_SHADOWMAP_INSTANCE",e[e.BUILD_TWOD_SHADOWMAP_NO_INSTANCE="BUILD_TWOD_SHADOWMAP_NO_INSTANCE"]="BUILD_TWOD_SHADOWMAP_NO_INSTANCE",e[e.BUILD_CUBEMAP_SHADOWMAP_INSTANCE="BUILD_CUBEMAP_SHADOWMAP_INSTANCE"]="BUILD_CUBEMAP_SHADOWMAP_INSTANCE",e[e.BUILD_CUBEMAP_SHADOWMAP_NO_INSTANCE="BUILD_CUBEMAP_SHADOWMAP_NO_INSTANCE"]="BUILD_CUBEMAP_SHADOWMAP_NO_INSTANCE"}(e.EShaderMapKeyOfScene||(e.EShaderMapKeyOfScene={}));e.EShaderMapKeyOfScene}(wd||(wd={}));var wd;!function(e){!function(e){e[e.DEFAULT="DEFAULT"]="DEFAULT"}(e.EShaderMapKey||(e.EShaderMapKey={}));e.EShaderMapKey}(wd||(wd={}));var wd;!function(e){var t=function(){function MapManager(){this._material=null,this._textureDirty=!1,this._allMapsCache=null,this._allSingleMapsCache=null,this._shadowMapController=e.ShadowMapController.create(),this._arrayMapController=e.MapArrayController.create(),this._envMapController=e.EnvMapController.create(),this._commonMapController=e.CommonMapController.create()}return MapManager.create=function(){var e=new this;return e},Object.defineProperty(MapManager.prototype,"material",{get:function(){return this._material},set:function(e){this._material=e,this._envMapController.material=e,this._commonMapController.material=e},enumerable:!0,configurable:!0}),MapManager.prototype.init=function(){for(var e=this._getAllMaps(),t=0,r=e.length;t<r;t++){var n=e[t];n.init()}},MapManager.prototype.addMap=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;if(t[0]instanceof e.TextureAsset){var i=t[0];n=i.toTexture()}else t[0]instanceof e.Texture&&(n=t[0]);1===t.length?this._commonMapController.addMap(n):this._commonMapController.addMap(n,t[1]),this._textureDirty=!0},MapManager.prototype.addMapArray=function(e,t){this._arrayMapController.addMapArray(e,t),this._textureDirty=!0},MapManager.prototype.addTwoDShadowMap=function(e){this._shadowMapController.addTwoDShadowMap(e),this._textureDirty=!0},MapManager.prototype.getTwoDShadowMapList=function(){return this._shadowMapController.getTwoDShadowMapList()},MapManager.prototype.hasTwoDShadowMap=function(e){return this._shadowMapController.hasTwoDShadowMap(e)},MapManager.prototype.addCubemapShadowMap=function(e){this._shadowMapController.addCubemapShadowMap(e),this._textureDirty=!0},MapManager.prototype.getCubemapShadowMapList=function(){return this._shadowMapController.getCubemapShadowMapList()},MapManager.prototype.hasCubemapShadowMap=function(e){return this._shadowMapController.hasCubemapShadowMap(e)},MapManager.prototype.getMapList=function(){return this._commonMapController.getMapList()},MapManager.prototype.hasMap=function(e){return this._commonMapController.hasMap(e)},MapManager.prototype.getMapCount=function(){return this.getMapList().getCount()},MapManager.prototype.getEnvMap=function(){return this._envMapController.getEnvMap()},MapManager.prototype.setEnvMap=function(e){return e?(this._envMapController.setEnvMap(e),void(this._textureDirty=!0)):(this._envMapController.setEnvMap(null),void(this._textureDirty=!0))},MapManager.prototype.removeChild=function(e){for(var t=0,r=this._getAllControllerArr();t<r.length;t++){var n=r[t];n.removeChild(e)}this._textureDirty=!0},MapManager.prototype.removeAllChildren=function(){for(var e=0,t=this._getAllControllerArr();e<t.length;e++){var r=t[e];r.removeAllChildren()}this._textureDirty=!0},MapManager.prototype.removeAllShdaowMaps=function(){this._shadowMapController.removeAllChildren(),this._textureDirty=!0},MapManager.prototype.dispose=function(){for(var e=this._getAllMaps(),t=0,r=e.length;t<r;t++){var n=e[t];n.dispose()}this.removeAllChildren()},MapManager.prototype.bindAndUpdate=function(){for(var e=this._getAllMaps(),t=0,r=e.length;t<r;t++){var n=e[t];n.bindToUnit(t),n.needUpdate&&n.update(t)}},MapManager.prototype.sendData=function(e){this._sendSingleMapData(e),this._arrayMapController.sendMapData(e,this._getMaxUnitOfBindedSingleMap())},MapManager.prototype._sendSingleMapData=function(e){for(var t=this._getAllSingleMaps(),r=t.length,n=0;n<r;n++){var i=t[n];i.sendData(e,i.getSamplerName(n),n)}},MapManager.prototype._getAllMaps=function(){return[].concat(this._getAllSingleMaps(),this._arrayMapController.getAllMapArr())},MapManager.prototype._getMaxUnitOfBindedSingleMap=function(){return this._getAllSingleMaps().length},MapManager.prototype._getAllSingleMaps=function(){for(var e=[],t=0,r=this._getAllSingleMapControllerArr();t<r.length;t++){var n=r[t];e=e.concat(n.getAllMapArr())}return e},MapManager.prototype._getAllSingleMapControllerArr=function(){return[this._shadowMapController,this._envMapController,this._commonMapController]},MapManager.prototype._getAllControllerArr=function(){return[this._shadowMapController,this._envMapController,this._arrayMapController,this._commonMapController]},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(t[0]instanceof e.TextureAsset||t[0]instanceof e.Texture,e.Log.info.FUNC_SHOULD("arguments[0]","be TextureAsset || Texture"))})],MapManager.prototype,"addMap",null),__decorate([e.require(function(t,r){e.assert(e.JudgeUtils.isArrayExactly(r),e.Log.info.FUNC_SHOULD("second param","be array"));for(var n=0,i=r;n<i.length;n++){var a=i[n];e.assert(a instanceof e.Texture,e.Log.info.FUNC_SHOULD(e.Log.info.FUNC_SHOULD("second param","be Array<Texture>")))}})],MapManager.prototype,"addMapArray",null),__decorate([e.require(function(t){e.assert(!this._shadowMapController.hasTwoDShadowMap(t),e.Log.info.FUNC_SHOULD_NOT("add the shadowMap which is already exist"))})],MapManager.prototype,"addTwoDShadowMap",null),__decorate([e.require(function(t){e.assert(!this._shadowMapController.hasCubemapShadowMap(t),e.Log.info.FUNC_SHOULD_NOT("add the shadowMap which is already exist"))})],MapManager.prototype,"addCubemapShadowMap",null),__decorate([e.ensure(function(t){t.forEach(function(t){e.assert(t instanceof e.BasicTexture||t instanceof e.ProceduralTexture,e.Log.info.FUNC_SHOULD("mapList","only contain BasicTexture or ProceduralTexture"))})})],MapManager.prototype,"getMapList",null),__decorate([e.require(function(t){for(var r={},n=this._getAllMaps(),i=0,a=n.length;i<a;i++){var o=n[i],s=o.getSamplerName(i);e.assert(1!==r[s],e.Log.info.FUNC_SHOULD_NOT("has duplicate maps, but actual has the ones with the same samplerName:"+s)),r[s]=1}})],MapManager.prototype,"sendData",null),__decorate([e.ensure(function(t){for(var r=0,n=t;r<n.length;r++){var i=n[r];e.assert(i instanceof e.Texture,e.Log.info.FUNC_SHOULD("each element","be Texture"))}}),e.cache(function(){return!this._textureDirty&&this._allMapsCache},function(){return this._allMapsCache},function(e){this._allMapsCache=e,this._textureDirty=!1})],MapManager.prototype,"_getAllMaps",null),__decorate([e.cache(function(){return!this._textureDirty&&this._allSingleMapsCache},function(){return this._allSingleMapsCache},function(e){this._allSingleMapsCache=e,this._textureDirty=!1})],MapManager.prototype,"_getAllSingleMaps",null),MapManager}();e.MapManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function MapController(){}return MapController.prototype.hasMapHelper=function(e,t){return!!e&&e.hasChild(t)},MapController.prototype.setMapOption=function(e,t){e.variableData=t},MapController}();e.MapController=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ShadowMapController(){e.apply(this,arguments),this._twoDShadowMapList=wdCb.Collection.create(),this._cubemapShadowMapList=wdCb.Collection.create()}return __extends(ShadowMapController,e),ShadowMapController.create=function(){var e=new this;return e},ShadowMapController.prototype.addTwoDShadowMap=function(e){this.setMapOption(e,{samplerData:this._twoDShadowMapList.getCount()}),this._twoDShadowMapList.addChild(e)},ShadowMapController.prototype.addCubemapShadowMap=function(e){this.setMapOption(e,{samplerData:this._cubemapShadowMapList.getCount()}),this._cubemapShadowMapList.addChild(e)},ShadowMapController.prototype.hasTwoDShadowMap=function(e){return this.hasMapHelper(this._twoDShadowMapList,e)},ShadowMapController.prototype.hasCubemapShadowMap=function(e){return this.hasMapHelper(this._cubemapShadowMapList,e)},ShadowMapController.prototype.getTwoDShadowMapList=function(){return this._twoDShadowMapList},ShadowMapController.prototype.getCubemapShadowMapList=function(){return this._cubemapShadowMapList},ShadowMapController.prototype.getAllMapArr=function(){return this._twoDShadowMapList.clone(!1).addChildren(this._cubemapShadowMapList).toArray()},ShadowMapController.prototype.removeChild=function(e){this._twoDShadowMapList.removeChild(e),this._cubemapShadowMapList.removeChild(e)},ShadowMapController.prototype.removeAllChildren=function(){this._twoDShadowMapList.removeAllChildren(),this._cubemapShadowMapList.removeAllChildren()},ShadowMapController}(e.MapController);e.ShadowMapController=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EnvMapController(){t.apply(this,arguments),this.material=null,this._map=null}return __extends(EnvMapController,t),EnvMapController.create=function(){var e=new this;return e},EnvMapController.prototype.setEnvMap=function(e){return e?(e.material=this.material,void(this._map=e)):void(this._map=null)},EnvMapController.prototype.getEnvMap=function(){return this._map},EnvMapController.prototype.getAllMapArr=function(){return null!==this._map?[this._map]:[]},EnvMapController.prototype.removeChild=function(t){e.JudgeUtils.isEqual(this._map,t)&&(this._map=null)},EnvMapController.prototype.removeAllChildren=function(){this._map=null},EnvMapController}(e.MapController);e.EnvMapController=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MapArrayController(){t.apply(this,arguments),this._mapArrayList=wdCb.Collection.create()}return __extends(MapArrayController,t),MapArrayController.create=function(){var e=new this;return e},MapArrayController.prototype.addMapArray=function(e,t){this._mapArrayList.addChild({samplerName:e,mapArray:t})},MapArrayController.prototype.sendMapData=function(t,r){var n=this;this._mapArrayList.forEach(function(i){var a=i.mapArray.length;t.sendUniformData(i.samplerName+"[0]",e.EVariableType.SAMPLER_ARRAY,n._generateMapArrayUnitArray(r,r+a)),r+=a})},MapArrayController.prototype.getAllMapArr=function(){var e=[];return this._mapArrayList.forEach(function(t){e=e.concat(t.mapArray)}),e},MapArrayController.prototype.removeChild=function(e){this._mapArrayList.removeChild(e)},MapArrayController.prototype.removeAllChildren=function(){this._mapArrayList.removeAllChildren()},MapArrayController.prototype._generateMapArrayUnitArray=function(e,t){for(var r=[];t>e;)r.push(e),e++;return r},__decorate([e.ensure(function(t){for(var r=0,n=t;r<n.length;r++){var i=n[r];e.assert(i instanceof e.Texture,e.Log.info.FUNC_SHOULD("each element","be Texture"))}})],MapArrayController.prototype,"getAllMapArr",null),__decorate([e.ensure(function(t,r,n){e.assert(t.length===n-r,e.Log.info.FUNC_SHOULD("length","be "+(n-r)+", but actual is "+t.length)),t.length>0&&(e.assert(t[0]===r,e.Log.info.FUNC_SHOULD("first element","be "+r+", but actual is "+t[0])),e.assert(t[t.length-1]===n-1,e.Log.info.FUNC_SHOULD("last element","be "+(n-1)+", but actual is "+t[t.length-1])))})],MapArrayController.prototype,"_generateMapArrayUnitArray",null),MapArrayController}(e.MapController);e.MapArrayController=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonMapController(){t.apply(this,arguments),this.material=null,this._list=wdCb.Collection.create()}return __extends(CommonMapController,t),CommonMapController.create=function(){var e=new this;return e},CommonMapController.prototype.addMap=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=e[0];if(2===e.length){var n=e[1];this.setMapOption(r,n)}r.material=this.material,this._list.addChild(r)},CommonMapController.prototype.getAllMapArr=function(){return this._list.toArray()},CommonMapController.prototype.getMapList=function(){return this._list.filter(function(t){return t instanceof e.BasicTexture||t instanceof e.ProceduralTexture})},CommonMapController.prototype.hasMap=function(e){return this.hasMapHelper(this._list,e)},CommonMapController.prototype.removeChild=function(e){this._list.removeChild(e)},CommonMapController.prototype.removeAllChildren=function(){this._list.removeAllChildren()},CommonMapController}(e.MapController);e.CommonMapController=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ShaderSourceBuilder(){this.attributes=wdCb.Hash.create(),this.uniforms=wdCb.Hash.create(),this.vsSource=null,this.fsSource=null}return ShaderSourceBuilder.prototype.dispose=function(){this.clearShaderDefinition()},ShaderSourceBuilder.prototype.convertAttributesData=function(){this.attributes.filter(function(t){return t.value!==e.EVariableCategory.ENGINE&&e.JudgeUtils.isArrayExactly(t.value)}).forEach(function(t,r){t.value=e.BufferUtils.convertArrayToArrayBuffer(t.type,t.value)})},__decorate([e.require(function(){this.attributes.forEach(function(t){e.assert(!e.JudgeUtils.isFloatArray(t.value),e.Log.info.FUNC_SHOULD_NOT("attribute->value","be Float array"))})})],ShaderSourceBuilder.prototype,"convertAttributesData",null),ShaderSourceBuilder}();e.ShaderSourceBuilder=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomShaderSourceBuilder(){t.apply(this,arguments)}return __extends(CustomShaderSourceBuilder,t),CustomShaderSourceBuilder.create=function(){var e=new this;return e},CustomShaderSourceBuilder.prototype.read=function(t){t.attributes&&(this.attributes=wdCb.Hash.create(t.attributes)),t.uniforms&&(this.uniforms=wdCb.Hash.create(t.uniforms)),this.vsSource=e.LoaderManager.getInstance().get(t.vsSourceId),this.fsSource=e.LoaderManager.getInstance().get(t.fsSourceId)},CustomShaderSourceBuilder.prototype.build=function(){this.convertAttributesData()},CustomShaderSourceBuilder.prototype.clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSource=null,this.fsSource=null},CustomShaderSourceBuilder}(e.ShaderSourceBuilder);e.CustomShaderSourceBuilder=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EngineShaderSourceBuilder(){t.apply(this,arguments),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.vsSourceDefineList=wdCb.Collection.create(),this.fsSourceDefineList=wdCb.Collection.create(),this.vsSourceExtensionList=wdCb.Collection.create(),this.fsSourceExtensionList=wdCb.Collection.create()}return __extends(EngineShaderSourceBuilder,t),EngineShaderSourceBuilder.create=function(){var e=new this;return e},EngineShaderSourceBuilder.prototype.build=function(e){this._readLibSource(e),null===this.vsSource&&this._buildVsSource(),null===this.fsSource&&this._buildFsSource(),this.convertAttributesData()},EngineShaderSourceBuilder.prototype.clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSourceDefineList.removeAllChildren(),this.fsSourceDefineList.removeAllChildren(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null},EngineShaderSourceBuilder.prototype._readLibSource=function(e){var t=e.filter(function(e){return null!==e.vsSource||null!==e.fsSource});this._judgeAndSetVsSource(t),this._judgeAndSetFsSource(t),this._judgeAndSetPartSource(e)},EngineShaderSourceBuilder.prototype._judgeAndSetVsSource=function(e){var t=e.findOne(function(e){return null!==e.vsSource});t&&(this.vsSource=t.vsSource)},EngineShaderSourceBuilder.prototype._judgeAndSetFsSource=function(e){var t=e.findOne(function(e){return null!==e.fsSource});t&&(this.fsSource=t.fsSource)},EngineShaderSourceBuilder.prototype._judgeAndSetPartSource=function(e){var t=this.vsSource,r=this.fsSource,n=this.attributes,i=this.uniforms,a=this.vsSourceDefineList,o=this.fsSourceDefineList,s=this.vsSourceExtensionList,c=this.fsSourceExtensionList,u="",l="",d="",h="",p="",f="",m="",g="",_="",y="",v="",b="";e.forEach(function(e){n.addChildren(e.attributes),i.addChildren(e.uniforms),null===t&&(u+=e.vsSourceTop,l+=e.vsSourceDefine,d+=e.vsSourceVarDeclare,h+=e.vsSourceFuncDeclare,p+=e.vsSourceFuncDefine,f+=e.vsSourceBody,a.addChildren(e.vsSourceDefineList),s.addChildren(e.vsSourceExtensionList)),null===r&&(m+=e.fsSourceTop,g+=e.fsSourceDefine,_+=e.fsSourceVarDeclare,y+=e.fsSourceFuncDeclare,v+=e.fsSourceFuncDefine,b+=e.fsSourceBody,o.addChildren(e.fsSourceDefineList),c.addChildren(e.fsSourceExtensionList))}),null===t&&(this.vsSourceTop=u,this.vsSourceDefine=l,this.vsSourceVarDeclare=d,this.vsSourceFuncDeclare=h,this.vsSourceFuncDefine=p,this.vsSourceBody=f),null===r&&(this.fsSourceTop=m,this.fsSourceDefine=g,this.fsSourceVarDeclare=_,this.fsSourceFuncDeclare=y,this.fsSourceFuncDefine=v,this.fsSourceBody=b)},EngineShaderSourceBuilder.prototype._buildVsSource=function(){this.vsSource=this._buildVsSourceTop()+this._buildVsSourceDefine()+this._buildVsSourceVarDeclare()+this._buildVsSourceFuncDeclare()+this._buildVsSourceFuncDefine()+this._buildVsSourceBody()},EngineShaderSourceBuilder.prototype._buildFsSource=function(){this.fsSource=this._buildFsSourceTop()+this._buildFsSourceDefine()+this._buildFsSourceVarDeclare()+this._buildFsSourceFuncDeclare()+this._buildFsSourceFuncDefine()+this._buildFsSourceBody()},EngineShaderSourceBuilder.prototype._buildVsSourceTop=function(){return this._buildVsSourceExtension()+this._getPrecisionSource()+this.vsSourceTop},EngineShaderSourceBuilder.prototype._buildVsSourceDefine=function(){return this._buildSourceDefine(this.vsSourceDefineList)+this.vsSourceDefine},EngineShaderSourceBuilder.prototype._buildVsSourceExtension=function(){return this._buildSourceExtension(this.vsSourceExtensionList)},EngineShaderSourceBuilder.prototype._buildVsSourceVarDeclare=function(){return this._generateAttributeSource()+this._generateUniformSource(this.vsSourceVarDeclare,this.vsSourceFuncDefine,this.vsSourceBody)+this.vsSourceVarDeclare},EngineShaderSourceBuilder.prototype._buildVsSourceFuncDeclare=function(){return this.vsSourceFuncDeclare},EngineShaderSourceBuilder.prototype._buildVsSourceFuncDefine=function(){return this.vsSourceFuncDefine},EngineShaderSourceBuilder.prototype._buildVsSourceBody=function(){return e.ShaderSnippet.main_begin+this.vsSourceBody+e.ShaderSnippet.main_end},EngineShaderSourceBuilder.prototype._buildFsSourceTop=function(){return this._buildFsSourceExtension()+this._getPrecisionSource()+this.fsSourceTop},EngineShaderSourceBuilder.prototype._buildFsSourceDefine=function(){return this._buildSourceDefine(this.fsSourceDefineList)+this.fsSourceDefine},EngineShaderSourceBuilder.prototype._buildFsSourceExtension=function(){return this._buildSourceExtension(this.fsSourceExtensionList)},EngineShaderSourceBuilder.prototype._buildFsSourceVarDeclare=function(){return this._generateUniformSource(this.fsSourceVarDeclare,this.fsSourceFuncDefine,this.fsSourceBody)+this.fsSourceVarDeclare},EngineShaderSourceBuilder.prototype._buildFsSourceFuncDeclare=function(){return this.fsSourceFuncDeclare},EngineShaderSourceBuilder.prototype._buildFsSourceFuncDefine=function(){return this.fsSourceFuncDefine},EngineShaderSourceBuilder.prototype._buildFsSourceBody=function(){return e.ShaderSnippet.main_begin+this.fsSourceBody+e.ShaderSnippet.main_end},EngineShaderSourceBuilder.prototype._buildSourceDefine=function(e){var t="";return e.forEach(function(e){t+=void 0===e.value?"#define "+e.name+"\n":"#define "+e.name+" "+e.value+"\n"}),t},EngineShaderSourceBuilder.prototype._buildSourceExtension=function(e){var t="";return e.forEach(function(e){t+="#extension "+e+" : enable\n"}),t},EngineShaderSourceBuilder.prototype._getPrecisionSource=function(){var t=e.GPUDetector.getInstance().precision,r=null;switch(t){case e.EGPUPrecision.HIGHP:r=e.ShaderChunk.highp_fragment.top;break;case e.EGPUPrecision.MEDIUMP:r=e.ShaderChunk.mediump_fragment.top;break;case e.EGPUPrecision.LOWP:r=e.ShaderChunk.lowp_fragment.top;break;default:r=""}return r},EngineShaderSourceBuilder.prototype._generateAttributeSource=function(){var t="";return this.attributes.filter(function(e,t){return!!e}).forEach(function(r,n){t+="attribute "+e.VariableTypeTable.getVariableType(r.type)+" "+n+";\n"}),t},EngineShaderSourceBuilder.prototype._generateUniformSource=function(t,r,n){var i="",a=this;return this.uniforms.filter(function(i,o){return!!i&&i.type!==e.EVariableType.STRUCTURE&&i.type!==e.EVariableType.STRUCTURES&&!a._isExistInSource(o,t)&&(a._isExistInSource(o,r)||a._isExistInSource(o,n))}).forEach(function(t,r){i+="uniform "+e.VariableTypeTable.getVariableType(t.type)+" "+r+";\n"}),i},EngineShaderSourceBuilder.prototype._isExistInSource=function(e,t){return t.indexOf(e)!==-1},__decorate([e.require(function(t){e.assert(null===this.vsSource,e.Log.info.FUNC_SHOULD("vsSource","be null")),e.assert(null===this.fsSource,e.Log.info.FUNC_SHOULD("fsSource","be null"))})],EngineShaderSourceBuilder.prototype,"build",null),EngineShaderSourceBuilder}(e.ShaderSourceBuilder);e.EngineShaderSourceBuilder=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.FLOAT_1="FLOAT_1"]="FLOAT_1",e[e.FLOAT_2="FLOAT_2"]="FLOAT_2",e[e.FLOAT_3="FLOAT_3"]="FLOAT_3",e[e.FLOAT_4="FLOAT_4"]="FLOAT_4",e[e.VECTOR_2="VECTOR_2"]="VECTOR_2",e[e.VECTOR_3="VECTOR_3"]="VECTOR_3",e[e.VECTOR_4="VECTOR_4"]="VECTOR_4",e[e.FLOAT_MAT3="FLOAT_MAT3"]="FLOAT_MAT3",e[e.FLOAT_MAT4="FLOAT_MAT4"]="FLOAT_MAT4",e[e.BUFFER="BUFFER"]="BUFFER",e[e.SAMPLER_CUBE="SAMPLER_CUBE"]="SAMPLER_CUBE",e[e.SAMPLER_2D="SAMPLER_2D"]="SAMPLER_2D",e[e.NUMBER_1="NUMBER_1"]="NUMBER_1",e[e.STRUCTURE="STRUCTURE"]="STRUCTURE",e[e.STRUCTURES="STRUCTURES"]="STRUCTURES",e[e.SAMPLER_ARRAY="SAMPLER_ARRAY"]="SAMPLER_ARRAY"}(e.EVariableType||(e.EVariableType={}));e.EVariableType}(wd||(wd={}));var wd;!function(e){!function(e){e[e.POSITION="POSITION"]="POSITION",e[e.NORMAL="NORMAL"]="NORMAL",e[e.TEXCOORD="TEXCOORD"]="TEXCOORD",e[e.TANGENT="TANGENT"]="TANGENT",e[e.COLOR="COLOR"]="COLOR",e[e.MODEL="MODEL"]="MODEL",e[e.VIEW="VIEW"]="VIEW",e[e.PROJECTION="PROJECTION"]="PROJECTION",e[e.MODEL_VIEW="MODEL_VIEW"]="MODEL_VIEW",e[e.MODEL_VIEW_PROJECTION="MODEL_VIEW_PROJECTION"]="MODEL_VIEW_PROJECTION",e[e.MODEL_INVERSE="MODEL_INVERSE"]="MODEL_INVERSE",e[e.VIEW_INVERSE="VIEW_INVERSE"]="VIEW_INVERSE",e[e.PROJECTION_INVERSE="PROJECTION_INVERSE"]="PROJECTION_INVERSE",e[e.MODEL_VIEW_INVERSE="MODEL_VIEW_INVERSE"]="MODEL_VIEW_INVERSE",e[e.MODEL_VIEW_PROJECTION_INVERSE="MODEL_VIEW_PROJECTION_INVERSE"]="MODEL_VIEW_PROJECTION_INVERSE",e[e.MODEL_INVERSE_TRANSPOSE="MODEL_INVERSE_TRANSPOSE"]="MODEL_INVERSE_TRANSPOSE",e[e.MODEL_VIEW_INVERSE_TRANSPOSE="MODEL_VIEW_INVERSE_TRANSPOSE"]="MODEL_VIEW_INVERSE_TRANSPOSE",e[e.VIEWPORT="VIEWPORT"]="VIEWPORT"}(e.EVariableSemantic||(e.EVariableSemantic={}));e.EVariableSemantic}(wd||(wd={}));var wd;!function(e){!function(e){e[e.ENGINE="ENGINE"]="ENGINE",e[e.CUSTOM="CUSTOM"]="CUSTOM"}(e.EVariableCategory||(e.EVariableCategory={}));e.EVariableCategory}(wd||(wd={}));var wd;!function(e){var t=function(){function VariableLib(){}return VariableLib.a_position={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_positionVec2={type:e.EVariableType.FLOAT_2,value:e.EVariableCategory.ENGINE},VariableLib.a_currentFramePosition={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_nextFramePosition={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_normal={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_currentFrameNormal={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_nextFrameNormal={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_color={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_texCoord={type:e.EVariableType.FLOAT_2,
value:e.EVariableCategory.ENGINE},VariableLib.a_tangent={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.u_mMatrix={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_vMatrix={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_pMatrix={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_mvpMatrix={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_vpMatrix={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_normalMatrix={type:e.EVariableType.FLOAT_MAT3,value:e.EVariableCategory.ENGINE},VariableLib.u_samplerCube0={type:e.EVariableType.SAMPLER_CUBE,value:e.EVariableCategory.ENGINE},VariableLib.u_sampler2D0={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_sampler2D1={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_lightMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMap1Sampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMap2Sampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMap3Sampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_specularMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_emissionMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_normalMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_reflectionMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_refractionMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_cameraPos={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_refractionRatio={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_reflectivity={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_map0SourceRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_map1SourceRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMapSourceRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_map0RepeatRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_map1RepeatRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMapRepeatRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_combineMode={type:e.EVariableType.NUMBER_1,value:e.EVariableCategory.ENGINE},VariableLib.u_mixRatio={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_lightMapIntensity={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuse={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_specular={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_emission={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_shininess={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_lightModel={type:e.EVariableType.NUMBER_1,value:e.EVariableCategory.ENGINE},VariableLib.u_isBothSide={type:e.EVariableType.NUMBER_1,value:e.EVariableCategory.ENGINE},VariableLib.u_opacity={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_ambient={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_directionLights={type:e.EVariableType.STRUCTURES,value:e.EVariableCategory.ENGINE},VariableLib.u_pointLights={type:e.EVariableType.STRUCTURES,value:e.EVariableCategory.ENGINE},VariableLib.u_vpMatrixFromLight={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_lightPos={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_farPlane={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_interpolation={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_tilesHeightNumber={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_tilesWidthNumber={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_amplitude={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_jointColor={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_time={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_speed={type:e.EVariableType.VECTOR_2,value:e.EVariableCategory.ENGINE},VariableLib.u_shift={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_alphaThreshold={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_fireColor={type:e.EVariableType.STRUCTURE,value:e.EVariableCategory.ENGINE},VariableLib.u_layerHeightDatas={type:e.EVariableType.STRUCTURES,value:e.EVariableCategory.ENGINE},VariableLib.u_layerSampler2Ds={type:e.EVariableType.SAMPLER_ARRAY,value:e.EVariableCategory.ENGINE},VariableLib.u_herb1Color={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_herb2Color={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_herb3Color={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_groundColor={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_ampScale={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_woodColor={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_roadColor={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_skyColor={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_cloudColor={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_brickColor={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib.u_waveData={type:e.EVariableType.STRUCTURE,value:e.EVariableCategory.ENGINE},VariableLib.u_windMatrix={type:e.EVariableType.FLOAT_MAT4,value:e.EVariableCategory.ENGINE},VariableLib.u_bumpMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_bumpMap1Sampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_bumpMap2Sampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_bumpMap3Sampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_levelData={type:e.EVariableType.STRUCTURE,value:e.EVariableCategory.ENGINE},VariableLib.a_mVec4_0={type:e.EVariableType.FLOAT_4,value:e.EVariableCategory.ENGINE},VariableLib.a_mVec4_1={type:e.EVariableType.FLOAT_4,value:e.EVariableCategory.ENGINE},VariableLib.a_mVec4_2={type:e.EVariableType.FLOAT_4,value:e.EVariableCategory.ENGINE},VariableLib.a_mVec4_3={type:e.EVariableType.FLOAT_4,value:e.EVariableCategory.ENGINE},VariableLib.a_normalVec4_0={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_normalVec4_1={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.a_normalVec4_2={type:e.EVariableType.FLOAT_3,value:e.EVariableCategory.ENGINE},VariableLib.u_isRenderListEmpty={type:e.EVariableType.NUMBER_1,value:e.EVariableCategory.ENGINE},VariableLib.u_isReflectionRenderListEmpty={type:e.EVariableType.NUMBER_1,value:e.EVariableCategory.ENGINE},VariableLib.u_isRefractionRenderListEmpty={type:e.EVariableType.NUMBER_1,value:e.EVariableCategory.ENGINE},VariableLib.u_bitmapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.a_page={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_pageSampler2Ds={type:e.EVariableType.SAMPLER_ARRAY,value:e.EVariableCategory.ENGINE},VariableLib.u_mixMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMap1RepeatRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMap2RepeatRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_diffuseMap3RepeatRegion={type:e.EVariableType.VECTOR_4,value:e.EVariableCategory.ENGINE},VariableLib.u_grassMapDatas={type:e.EVariableType.STRUCTURES,value:e.EVariableCategory.ENGINE},VariableLib.a_quadIndex={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_grassMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_windData={type:e.EVariableType.STRUCTURES,value:e.EVariableCategory.ENGINE},VariableLib.a_vertexIndex={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_grassRangeWidth={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_grassRangeHeight={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainRangeWidth={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainRangeHeight={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainMinHeight={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainMaxHeight={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainSubdivisions={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainScaleY={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_terrainPositionY={type:e.EVariableType.FLOAT_1,value:e.EVariableCategory.ENGINE},VariableLib.u_heightMapSampler={type:e.EVariableType.SAMPLER_2D,value:e.EVariableCategory.ENGINE},VariableLib.u_lightColor={type:e.EVariableType.VECTOR_3,value:e.EVariableCategory.ENGINE},VariableLib}();e.VariableLib=t}(wd||(wd={}));var wd;!function(e){var t=wdCb.Hash.create();t.addChild(e.EVariableType.FLOAT_1,"float"),t.addChild(e.EVariableType.FLOAT_2,"vec2"),t.addChild(e.EVariableType.FLOAT_3,"vec3"),t.addChild(e.EVariableType.FLOAT_4,"vec4"),t.addChild(e.EVariableType.VECTOR_2,"vec2"),t.addChild(e.EVariableType.VECTOR_3,"vec3"),t.addChild(e.EVariableType.VECTOR_4,"vec4"),t.addChild(e.EVariableType.FLOAT_MAT3,"mat3"),t.addChild(e.EVariableType.FLOAT_MAT4,"mat4"),t.addChild(e.EVariableType.NUMBER_1,"int"),t.addChild(e.EVariableType.SAMPLER_CUBE,"samplerCube"),t.addChild(e.EVariableType.SAMPLER_2D,"sampler2D");var r=function(){function VariableTypeTable(){}return VariableTypeTable.getVariableType=function(r){var n=t.getChild(r);return e.Log.error(void 0===n,e.Log.info.FUNC_NOT_EXIST(r,"in VariableTypeTable")),n},VariableTypeTable}();e.VariableTypeTable=r}(wd||(wd={}));var wd;!function(e){var t=wdCb.Hash.create();t.addChild("lightMap","u_lightMapSampler"),t.addChild("diffuseMap","u_diffuseMapSampler"),t.addChild("diffuseMap1","u_diffuseMap1Sampler"),t.addChild("diffuseMap2","u_diffuseMap2Sampler"),t.addChild("diffuseMap3","u_diffuseMap3Sampler"),t.addChild("specularMap","u_specularMapSampler"),t.addChild("emissionMap","u_emissionMapSampler"),t.addChild("normalMap","u_normalMapSampler"),t.addChild("reflectionMap","u_reflectionMapSampler"),t.addChild("refractionMap","u_refractionMapSampler"),t.addChild("bitmap","u_bitmapSampler"),t.addChild("bumpMap","u_bumpMapSampler"),t.addChild("bumpMap1","u_bumpMap1Sampler"),t.addChild("bumpMap2","u_bumpMap2Sampler"),t.addChild("bumpMap3","u_bumpMap3Sampler"),t.addChild("mixMap","u_mixMapSampler"),t.addChild("grassMap","u_grassMapSampler"),t.addChild("heightMap","u_heightMapSampler");var r=function(){function VariableNameTable(){}return VariableNameTable.getVariableName=function(e){return t.getChild(e)},__decorate([e.ensure(function(t){e.it("variableName should in VariableNameTable",function(){e.expect(t).exist})})],VariableNameTable,"getVariableName",null),VariableNameTable}();e.VariableNameTable=r}(wd||(wd={}));var wd;!function(e){e.POINT_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME=[{position:"u_pointLights[0].position",color:"u_pointLights[0].color",intensity:"u_pointLights[0].intensity",constant:"u_pointLights[0].constant",linear:"u_pointLights[0].linear",quadratic:"u_pointLights[0].quadratic",range:"u_pointLights[0].range"},{position:"u_pointLights[1].position",color:"u_pointLights[1].color",intensity:"u_pointLights[1].intensity",constant:"u_pointLights[1].constant",linear:"u_pointLights[1].linear",quadratic:"u_pointLights[1].quadratic",range:"u_pointLights[1].range"},{position:"u_pointLights[2].position",color:"u_pointLights[2].color",intensity:"u_pointLights[2].intensity",constant:"u_pointLights[2].constant",linear:"u_pointLights[2].linear",quadratic:"u_pointLights[2].quadratic",range:"u_pointLights[2].range"},{position:"u_pointLights[3].position",color:"u_pointLights[3].color",intensity:"u_pointLights[3].intensity",constant:"u_pointLights[3].constant",linear:"u_pointLights[3].linear",quadratic:"u_pointLights[3].quadratic",range:"u_pointLights[3].range"}],e.DIRECTION_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME=[{position:"u_directionLights[0].position",color:"u_directionLights[0].color",intensity:"u_directionLights[0].intensity"},{position:"u_directionLights[1].position",color:"u_directionLights[1].color",intensity:"u_directionLights[1].intensity"},{position:"u_directionLights[2].position",color:"u_directionLights[2].color",intensity:"u_directionLights[2].intensity"},{position:"u_directionLights[3].position",color:"u_directionLights[3].color",intensity:"u_directionLights[3].intensity"}]}(wd||(wd={}));var wd;!function(e){var t=function(){function ShaderLib(){this.shader=null}return ShaderLib.prototype.sendShaderVariables=function(e,t,r){},ShaderLib.prototype.init=function(){},ShaderLib.prototype.dispose=function(){},__decorate([e.virtual],ShaderLib.prototype,"sendShaderVariables",null),__decorate([e.virtual],ShaderLib.prototype,"init",null),__decorate([e.virtual],ShaderLib.prototype,"dispose",null),ShaderLib}();e.ShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomShaderLib(){t.apply(this,arguments)}return __extends(CustomShaderLib,t),CustomShaderLib.create=function(){var e=new this;return e},CustomShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=this.shader;i.attributes.forEach(function(n,i){e.CustomShaderLibUtils.sendAttributeBufferWithSemantic(i,n.type,n.value,t,r)}),i.uniforms.forEach(function(n,i){n.type!==e.EVariableType.SAMPLER_2D&&e.CustomShaderLibUtils.sendUniformDataWithSemantic(i,n.type,n.value,t,r)})},CustomShaderLib}(e.ShaderLib);e.CustomShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EngineShaderLib(){t.apply(this,arguments),this.type=null,this.attributes=wdCb.Hash.create(),this.uniforms=wdCb.Hash.create(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null,this.vsSourceDefineList=wdCb.Collection.create(),this.fsSourceDefineList=wdCb.Collection.create(),this.vsSourceExtensionList=wdCb.Collection.create(),this.fsSourceExtensionList=wdCb.Collection.create()}return __extends(EngineShaderLib,t),EngineShaderLib.prototype.setShaderDefinition=function(e,t){var r=null,n=null;this._clearShaderDefinition(),r=this.getVsChunk(),n=this.getFsChunk(),r&&this.setVsSource(r),n&&this.setFsSource(n)},EngineShaderLib.prototype.sendAttributeBuffer=function(t,r,n){t.sendAttributeBuffer(r,e.EVariableType.BUFFER,n)},EngineShaderLib.prototype.sendUniformData=function(t,r,n){t.sendUniformData(r,e.VariableLib[r].type,n)},EngineShaderLib.prototype.getVsChunk=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=0===e.length?this.type:e[0];return this._getChunk(n,r.vs)},EngineShaderLib.prototype.getFsChunk=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=0===e.length?this.type:e[0];return this._getChunk(n,r.fs)},EngineShaderLib.prototype.setVsSource=function(t,n){void 0===n&&(n="="),e.JudgeUtils.isString(t)?this.vsSource=t:this._setSource(t,r.vs,n)},EngineShaderLib.prototype.setFsSource=function(t,n){void 0===n&&(n="="),e.JudgeUtils.isString(t)?this.fsSource=t:this._setSource(t,r.fs,n)},EngineShaderLib.prototype.addAttributeVariable=function(e){this._addVariable(this.attributes,e)},EngineShaderLib.prototype.addUniformVariable=function(e){this._addVariable(this.uniforms,e)},EngineShaderLib.prototype._addVariable=function(t,r){r.forEach(function(r){e.assert(e.VariableLib[r],e.Log.info.FUNC_SHOULD(r,"exist in VariableLib")),t.addChild(r,e.VariableLib[r])})},EngineShaderLib.prototype._clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSourceDefineList.removeAllChildren(),this.fsSourceDefineList.removeAllChildren(),this.vsSourceExtensionList.removeAllChildren(),this.fsSourceExtensionList.removeAllChildren(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null},EngineShaderLib.prototype._getChunk=function(t,n){var i=null;return t?(i=t.indexOf(".glsl")>-1?""+wdCb.PathUtils.basename(t,".glsl"):n===r.vs?t+"_vertex":t+"_fragment",e.ShaderChunk[i]?e.ShaderChunk[i]:e.ShaderChunk.empty):null},EngineShaderLib.prototype._setSource=function(t,r,n){if(t)switch(n){case"+":this[r+"SourceTop"]+=t.top,this[r+"SourceDefine"]+=t.define,this[r+"SourceVarDeclare"]+=t.varDeclare,this[r+"SourceFuncDeclare"]+=t.funcDeclare,this[r+"SourceFuncDefine"]+=t.funcDefine,this[r+"SourceBody"]+=t.body;break;case"=":this[r+"SourceTop"]=t.top,this[r+"SourceDefine"]=t.define,this[r+"SourceVarDeclare"]=t.varDeclare,this[r+"SourceFuncDeclare"]=t.funcDeclare,this[r+"SourceFuncDefine"]=t.funcDefine,this[r+"SourceBody"]=t.body;break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("opertor:",n))}},__decorate([e.virtual],EngineShaderLib.prototype,"setShaderDefinition",null),__decorate([e.require(function(t,r,n){e.assert(!!e.VariableLib[r],r+" should exist in VariableLib")})],EngineShaderLib.prototype,"sendUniformData",null),__decorate([e.require(function(){e.assert(null===this.vsSource,e.Log.info.FUNC_SHOULD("vsSource","be null"))})],EngineShaderLib.prototype,"setVsSource",null),__decorate([e.require(function(){e.assert(null===this.fsSource,e.Log.info.FUNC_SHOULD("fsSource","be null"))})],EngineShaderLib.prototype,"setFsSource",null),__decorate([e.require(function(t,r){r.forEach(function(t){e.it("should exist in VariableLib",function(){e.expect(e.VariableLib[t]).exist})})})],EngineShaderLib.prototype,"_addVariable",null),EngineShaderLib}(e.ShaderLib);e.EngineShaderLib=t;var r;!function(e){e[e.vs="vs"]="vs",e[e.fs="fs"]="fs"}(r||(r={}))}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonShaderLib(){t.apply(this,arguments),this.type="common"}return __extends(CommonShaderLib,t),CommonShaderLib.create=function(){var e=new this;return e},CommonShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_vMatrix",t.vMatrix),this.sendUniformData(e,"u_pMatrix",t.pMatrix)},CommonShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable(["u_vMatrix","u_pMatrix"]),this.vsSourceDefine=e.ShaderChunk.common_define.define+e.ShaderChunk.common_vertex.define,this.vsSourceFuncDefine=e.ShaderChunk.common_function.funcDefine+e.ShaderChunk.common_vertex.funcDefine,this.fsSourceDefine=e.ShaderChunk.common_define.define+e.ShaderChunk.common_fragment.define,this.fsSourceFuncDefine=e.ShaderChunk.common_function.funcDefine+e.ShaderChunk.common_fragment.funcDefine},CommonShaderLib}(e.EngineShaderLib);e.CommonShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function EndShaderLib(){e.apply(this,arguments),this.type="end"}return __extends(EndShaderLib,e),EndShaderLib.create=function(){var e=new this;return e},EndShaderLib.prototype.sendShaderVariables=function(e,t,r){e.sendAllBufferData(t.vaoManager)},EndShaderLib}(e.EngineShaderLib);e.EndShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function VerticeCommonShaderLib(){t.apply(this,arguments),this.type="vertice_common"}return __extends(VerticeCommonShaderLib,t),VerticeCommonShaderLib.create=function(){var e=new this;return e},VerticeCommonShaderLib.prototype.sendShaderVariables=function(e,t,r){this._sendAttributeVariables(e,t)},VerticeCommonShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addAttributeVariable(["a_position"])},VerticeCommonShaderLib.prototype._sendAttributeVariables=function(t,r){var n=r.buffers.getChild(e.EBufferDataType.VERTICE);n&&this.sendAttributeBuffer(t,"a_position",n)},VerticeCommonShaderLib}(e.EngineShaderLib);e.VerticeCommonShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function NormalCommonShaderLib(){t.apply(this,arguments),this.type="normal_common"}return __extends(NormalCommonShaderLib,t),NormalCommonShaderLib.create=function(){var e=new this;return e},NormalCommonShaderLib.prototype.sendShaderVariables=function(e,t,r){this._sendAttributeVariables(e,t)},NormalCommonShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addAttributeVariable(["a_normal"])},NormalCommonShaderLib.prototype._sendAttributeVariables=function(t,r){var n=r.buffers.getChild(e.EBufferDataType.NORMAL);n&&this.sendAttributeBuffer(t,"a_normal",n)},NormalCommonShaderLib}(e.EngineShaderLib);e.NormalCommonShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BasicShaderLib(){t.apply(this,arguments),this.type="basic"}return __extends(BasicShaderLib,t),BasicShaderLib.create=function(){var e=new this;return e},BasicShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=r.buffers.getChild(e.EBufferDataType.COLOR);i&&(this.sendAttributeBuffer(t,"a_color",i),this.sendUniformData(t,"u_opacity",n.opacity))},BasicShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addAttributeVariable(["a_color"]),this.addUniformVariable(["u_opacity"]),this.vsSourceBody=e.ShaderSnippet.setPos_mvp+e.ShaderChunk.basic_vertex.body},BasicShaderLib}(e.EngineShaderLib);e.BasicShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function EndBasicShaderLib(){e.apply(this,arguments),this.type="end_basic"}return __extends(EndBasicShaderLib,e),EndBasicShaderLib.create=function(){var e=new this;return e},EndBasicShaderLib.prototype.sendShaderVariables=function(e,t,r){},EndBasicShaderLib}(e.EngineShaderLib);e.EndBasicShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonMorphShaderLib(){t.apply(this,arguments),this.type="common_morph"}return __extends(CommonMorphShaderLib,t),CommonMorphShaderLib.create=function(){var e=new this;return e},CommonMorphShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=r.target.getComponent(e.MorphAnimation);this.sendUniformData(t,"u_interpolation",i.interpolation)},CommonMorphShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_interpolation"])},__decorate([e.require(function(t,r,n){e.assert(r.target.hasComponent(e.MorphAnimation),e.Log.info.FUNC_SHOULD("entityObject","has MorphAnimation component"))})],CommonMorphShaderLib.prototype,"sendShaderVariables",null),CommonMorphShaderLib}(e.EngineShaderLib);e.CommonMorphShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function VerticeMorphShaderLib(){t.apply(this,arguments),this.type="vertice_morph"}return __extends(VerticeMorphShaderLib,t),VerticeMorphShaderLib.create=function(){var e=new this;return e},VerticeMorphShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=r.buffers.getChild(e.EBufferDataType.VERTICE);i&&(this.sendAttributeBuffer(t,"a_currentFramePosition",i[0]),this.sendAttributeBuffer(t,"a_nextFramePosition",i[1]))},VerticeMorphShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addAttributeVariable(["a_currentFramePosition","a_nextFramePosition"])},__decorate([e.require(function(t,r,n){e.assert(r.target.hasComponent(e.MorphAnimation),e.Log.info.FUNC_SHOULD("entityObject","has MorphAnimation component"))})],VerticeMorphShaderLib.prototype,"sendShaderVariables",null),VerticeMorphShaderLib}(e.EngineShaderLib);e.VerticeMorphShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function NormalMorphShaderLib(){t.apply(this,arguments),this.type="normal_morph"}return __extends(NormalMorphShaderLib,t),NormalMorphShaderLib.create=function(){var e=new this;return e},NormalMorphShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=r.buffers.getChild(e.EBufferDataType.NORMAL);i&&(this.sendAttributeBuffer(t,"a_currentFrameNormal",i[0]),this.sendAttributeBuffer(t,"a_nextFrameNormal",i[1]))},NormalMorphShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addAttributeVariable(["a_currentFrameNormal","a_nextFrameNormal"])},NormalMorphShaderLib}(e.EngineShaderLib);e.NormalMorphShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function SkyboxShaderLib(){e.apply(this,arguments),this.type="skybox"}return __extends(SkyboxShaderLib,e),SkyboxShaderLib.create=function(){var e=new this;return e},SkyboxShaderLib.prototype.sendShaderVariables=function(e,t,r){},SkyboxShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_samplerCube0"])},SkyboxShaderLib}(e.EngineShaderLib);e.SkyboxShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function EnvMapShaderLib(){e.apply(this,arguments)}return __extends(EnvMapShaderLib,e),EnvMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_samplerCube0"]),this.vsSourceBody=this.getVsChunk().body},EnvMapShaderLib}(e.EngineShaderLib);e.EnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonEnvMapShaderLib(){t.apply(this,arguments),this.type="common_envMap"}return __extends(CommonEnvMapShaderLib,t),CommonEnvMapShaderLib.create=function(){var e=new this;return e},CommonEnvMapShaderLib.prototype.sendShaderVariables=function(t,r,n){e.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(t,e.EShaderGLSLData.DYNAMIC_CUBEMAP)},CommonEnvMapShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_isRenderListEmpty"])},CommonEnvMapShaderLib}(e.EnvMapShaderLib);e.CommonEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ForBasicEnvMapShaderLib(){t.apply(this,arguments)}return __extends(ForBasicEnvMapShaderLib,t),ForBasicEnvMapShaderLib.prototype.sendShaderVariables=function(r,n,i){t.prototype.sendShaderVariables.call(this,r,n,i),this.sendUniformData(r,"u_cameraPos",e.Director.getInstance().scene.currentCamera.transform.position)},ForBasicEnvMapShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_cameraPos"])},ForBasicEnvMapShaderLib.prototype.setEnvMapSource=function(){var e=this.getVsChunk("forBasic_envMap"),t=this.getFsChunk("forBasic_envMap");this.vsSourceTop=e.top,this.vsSourceDefine=e.define,this.vsSourceVarDeclare=e.varDeclare,this.vsSourceFuncDeclare=e.funcDeclare,this.vsSourceFuncDefine=e.funcDefine,this.vsSourceBody+=e.body,this.setFsSource(t)},ForBasicEnvMapShaderLib}(e.EnvMapShaderLib);e.ForBasicEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicForBasicEnvMapShaderLib(){e.apply(this,arguments),this.type="basic_forBasic_envMap"}return __extends(BasicForBasicEnvMapShaderLib,e),BasicForBasicEnvMapShaderLib.create=function(){var e=new this;return e},BasicForBasicEnvMapShaderLib}(e.ForBasicEnvMapShaderLib);e.BasicForBasicEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ReflectionForBasicEnvMapShaderLib(){e.apply(this,arguments),this.type="reflection_forBasic_envMap"}return __extends(ReflectionForBasicEnvMapShaderLib,e),ReflectionForBasicEnvMapShaderLib.create=function(){var e=new this;return e},ReflectionForBasicEnvMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},ReflectionForBasicEnvMapShaderLib}(e.ForBasicEnvMapShaderLib);e.ReflectionForBasicEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function RefractionForBasicEnvMapShaderLib(){e.apply(this,arguments),this.type="refraction_forBasic_envMap"}return __extends(RefractionForBasicEnvMapShaderLib,e),RefractionForBasicEnvMapShaderLib.create=function(){var e=new this;return e},RefractionForBasicEnvMapShaderLib.prototype.sendShaderVariables=function(t,r,n){e.prototype.sendShaderVariables.call(this,t,r,n),this.sendUniformData(t,"u_refractionRatio",n.refractionRatio)},RefractionForBasicEnvMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_refractionRatio"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},RefractionForBasicEnvMapShaderLib}(e.ForBasicEnvMapShaderLib);e.RefractionForBasicEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function FresnelForBasicEnvMapShaderLib(){e.apply(this,arguments),this.type="fresnel_forBasic_envMap"}return __extends(FresnelForBasicEnvMapShaderLib,e),FresnelForBasicEnvMapShaderLib.create=function(){var e=new this;return e},FresnelForBasicEnvMapShaderLib.prototype.sendShaderVariables=function(t,r,n){e.prototype.sendShaderVariables.call(this,t,r,n),this.sendUniformData(t,"u_refractionRatio",n.refractionRatio),this.sendUniformData(t,"u_reflectivity",n.reflectivity)},FresnelForBasicEnvMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_refractionRatio","u_reflectivity"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},FresnelForBasicEnvMapShaderLib}(e.ForBasicEnvMapShaderLib);e.FresnelForBasicEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ForLightEnvMapShaderLib(){e.apply(this,arguments)}return __extends(ForLightEnvMapShaderLib,e),ForLightEnvMapShaderLib.prototype.setEnvMapSource=function(){var e=this.getVsChunk("forLight_envMap"),t=this.getFsChunk("forLight_envMap");this.vsSourceTop=e.top,this.vsSourceDefine=e.define,this.vsSourceVarDeclare=e.varDeclare,this.vsSourceFuncDeclare=e.funcDeclare,this.vsSourceFuncDefine=e.funcDefine,this.vsSourceBody+=e.body,this.setFsSource(t)},ForLightEnvMapShaderLib}(e.EnvMapShaderLib);e.ForLightEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicForLightEnvMapShaderLib(){e.apply(this,arguments),this.type="basic_forLight_envMap"}return __extends(BasicForLightEnvMapShaderLib,e),BasicForLightEnvMapShaderLib.create=function(){var e=new this;return e},BasicForLightEnvMapShaderLib}(e.ForLightEnvMapShaderLib);e.BasicForLightEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ReflectionForLightEnvMapShaderLib(){e.apply(this,arguments),this.type="reflection_forLight_envMap"}return __extends(ReflectionForLightEnvMapShaderLib,e),ReflectionForLightEnvMapShaderLib.create=function(){var e=new this;return e},ReflectionForLightEnvMapShaderLib.prototype.setShaderDefinition=function(t,r){
e.prototype.setShaderDefinition.call(this,t,r),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},ReflectionForLightEnvMapShaderLib}(e.ForLightEnvMapShaderLib);e.ReflectionForLightEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function RefractionForLightEnvMapShaderLib(){e.apply(this,arguments),this.type="refraction_forLight_envMap"}return __extends(RefractionForLightEnvMapShaderLib,e),RefractionForLightEnvMapShaderLib.create=function(){var e=new this;return e},RefractionForLightEnvMapShaderLib.prototype.sendShaderVariables=function(t,r,n){e.prototype.sendShaderVariables.call(this,t,r,n),this.sendUniformData(t,"u_refractionRatio",n.refractionRatio)},RefractionForLightEnvMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_refractionRatio"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},RefractionForLightEnvMapShaderLib}(e.ForLightEnvMapShaderLib);e.RefractionForLightEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function FresnelForLightEnvMapShaderLib(){t.apply(this,arguments),this.type="fresnel_forLight_envMap"}return __extends(FresnelForLightEnvMapShaderLib,t),FresnelForLightEnvMapShaderLib.create=function(){var e=new this;return e},FresnelForLightEnvMapShaderLib.prototype.sendShaderVariables=function(r,n,i){t.prototype.sendShaderVariables.call(this,r,n,i),null!==i.reflectivity?this.sendUniformData(r,"u_reflectivity",i.reflectivity):(this.sendUniformData(r,"u_reflectivity",e.ShaderChunk.NULL),this.sendUniformData(r,"u_refractionRatio",i.refractionRatio))},FresnelForLightEnvMapShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_refractionRatio","u_reflectivity"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},FresnelForLightEnvMapShaderLib}(e.ForLightEnvMapShaderLib);e.FresnelForLightEnvMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MapShaderLib(){t.apply(this,arguments)}return __extends(MapShaderLib,t),MapShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=r.buffers.getChild(e.EBufferDataType.TEXCOORD),a=null,o=null;i&&(this.sendAttributeBuffer(t,"a_texCoord",i),a=n.mapList,o=a.getChild(0),this.sendUniformData(t,"u_map0SourceRegion",o.sourceRegionForGLSL),this.sendUniformData(t,"u_map0RepeatRegion",o.repeatRegion),this.sendMapShaderVariables(t,r,n))},MapShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addAttributeVariable(["a_texCoord"]),this.addUniformVariable(["u_sampler2D0","u_map0SourceRegion","u_map0RepeatRegion"]),this._setMapSource()},MapShaderLib.prototype.sendMapShaderVariables=function(e,t,r){},MapShaderLib.prototype._setMapSource=function(){var e=this.getVsChunk("map_forBasic"),t=this.getFsChunk("map_forBasic");this.vsSourceTop=e.top,this.vsSourceDefine=e.define,this.vsSourceVarDeclare=e.varDeclare,this.vsSourceFuncDeclare=e.funcDeclare,this.vsSourceFuncDefine=e.funcDefine,this.vsSourceBody=e.body,this.setFsSource(t)},__decorate([e.virtual],MapShaderLib.prototype,"sendMapShaderVariables",null),MapShaderLib}(e.EngineShaderLib);e.MapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicMapShaderLib(){e.apply(this,arguments),this.type="map_forBasic"}return __extends(BasicMapShaderLib,e),BasicMapShaderLib.create=function(){var e=new this;return e},BasicMapShaderLib}(e.MapShaderLib);e.BasicMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function MultiMapShaderLib(){e.apply(this,arguments),this.type="multi_map_forBasic"}return __extends(MultiMapShaderLib,e),MultiMapShaderLib.create=function(){var e=new this;return e},MultiMapShaderLib.prototype.sendMapShaderVariables=function(e,t,r){var n=r.mapList,i=n.getChild(1);this.sendUniformData(e,"u_combineMode",r.mapCombineMode),this.sendUniformData(e,"u_mixRatio",r.mapMixRatio),this.sendUniformData(e,"u_map1SourceRegion",i.sourceRegionForGLSL),this.sendUniformData(e,"u_map1RepeatRegion",i.repeatRegion)},MultiMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_sampler2D1","u_combineMode","u_mixRatio","u_map1SourceRegion","u_map1RepeatRegion"]),this.vsSourceVarDeclare+=this.getVsChunk().varDeclare,this.vsSourceBody+=this.getVsChunk().body,this.fsSourceVarDeclare=this.getFsChunk().varDeclare,this.fsSourceFuncDefine=this.getFsChunk().funcDefine,this.fsSourceBody=this.getFsChunk().body},MultiMapShaderLib}(e.MapShaderLib);e.MultiMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function LightCommonShaderLib(){e.apply(this,arguments),this.type="lightCommon"}return __extends(LightCommonShaderLib,e),LightCommonShaderLib.create=function(){var e=new this;return e},LightCommonShaderLib.prototype.sendShaderVariables=function(e,t,r){},LightCommonShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.setVsSource(this.getVsChunk("light_common.glsl")),this.setVsSource(this.getVsChunk(),"+"),this.setFsSource(this.getFsChunk("light_common.glsl")),this.setFsSource(this.getFsChunk(),"+")},LightCommonShaderLib}(e.EngineShaderLib);e.LightCommonShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function LightSetWorldPositionShaderLib(){e.apply(this,arguments),this.type="light_setWorldPosition"}return __extends(LightSetWorldPositionShaderLib,e),LightSetWorldPositionShaderLib.create=function(){var e=new this;return e},LightSetWorldPositionShaderLib}(e.EngineShaderLib);e.LightSetWorldPositionShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function LightShaderLib(){t.apply(this,arguments),this.type="light"}return __extends(LightShaderLib,t),LightShaderLib.create=function(){var e=new this;return e},LightShaderLib.prototype.sendShaderVariables=function(t,r,n){this.sendUniformData(t,"u_cameraPos",e.Director.getInstance().scene.currentCamera.transform.position),this.sendUniformData(t,"u_shininess",n.shininess),this.sendUniformData(t,"u_opacity",n.opacity),this.sendUniformData(t,"u_lightModel",this._convertLightModelToGLSLVariable(n.lightModel)),this._sendLightVariables(t)},LightShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_normalMatrix","u_cameraPos","u_shininess","u_ambient","u_opacity","u_isBothSide","u_lightModel"]),this._setLightDefinition(r)},LightShaderLib.prototype._sendLightVariables=function(t){var r=e.Director.getInstance().scene,n=r.directionLights,i=r.ambientLight,a=r.pointLights;i&&this.sendUniformData(t,"u_ambient",i.getComponent(e.AmbientLight).color.toVector4()),a&&this._sendPointLightVariables(t,a),n&&this._sendDirectionLightVariables(t,n)},LightShaderLib.prototype._sendPointLightVariables=function(t,r){r.forEach(function(r,n){var i=r.getComponent(e.PointLight),a=e.POINT_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME[n];t.sendVector3(a.position,e.LightUtils.getPointLightPosition(i)),t.sendColor4(a.color,i.color),t.sendFloat1(a.intensity,i.intensity),t.sendFloat1(a.constant,i.constant),t.sendFloat1(a.linear,i.linear),t.sendFloat1(a.quadratic,i.quadratic),null!==i.range?t.sendFloat1(a.range,i.range):t.sendFloat1(a.range,e.ShaderChunk.NULL)})},LightShaderLib.prototype._sendDirectionLightVariables=function(t,r){r.forEach(function(r,n){var i=r.getComponent(e.DirectionLight),a=e.DIRECTION_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME[n];t.sendVector3(a.position,e.LightUtils.getDirectionLightPosition(i)),t.sendColor4(a.color,i.color),t.sendFloat1(a.intensity,i.intensity)})},LightShaderLib.prototype._setLightDefinition=function(t){var r=e.Director.getInstance().scene,n=r.directionLights,i=r.pointLights,a=0,o=0;n&&(this.addUniformVariable(["u_directionLights"]),a=n.getCount()),i&&(this.addUniformVariable(["u_pointLights"]),o=i.getCount()),this._addDefine(this.vsSourceDefineList,a,o),this._addDefine(this.fsSourceDefineList,a,o),t.side===e.ESide.BOTH&&this.fsSourceDefineList.addChildren([{name:"BOTH_SIDE"}])},LightShaderLib.prototype._addDefine=function(e,t,r){e.addChildren([{name:"DIRECTION_LIGHTS_COUNT",value:t},{name:"POINT_LIGHTS_COUNT",value:r}])},LightShaderLib.prototype._convertLightModelToGLSLVariable=function(t){switch(t){case e.ELightModel.BLINN:return 1;case e.ELightModel.PHONG:return 2;case e.ELightModel.CONSTANT:return 3;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("lightModel:"+t))}},__decorate([e.require(function(t){e.assert(t!==e.ELightModel.LAMBERT,e.Log.info.FUNC_SHOULD_NOT("lightModel","=== ELightModel.LAMBERT"))})],LightShaderLib.prototype,"_convertLightModelToGLSLVariable",null),LightShaderLib}(e.EngineShaderLib);e.LightShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function LightEndShaderLib(){e.apply(this,arguments),this.type="lightEnd"}return __extends(LightEndShaderLib,e),LightEndShaderLib.create=function(){var e=new this;return e},LightEndShaderLib.prototype.sendShaderVariables=function(e,t,r){},LightEndShaderLib}(e.EngineShaderLib);e.LightEndShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BaseLightMapShaderLib(){e.apply(this,arguments)}return __extends(BaseLightMapShaderLib,e),BaseLightMapShaderLib.prototype.sendShaderVariables=function(e,t,r){},BaseLightMapShaderLib}(e.EngineShaderLib);e.BaseLightMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonLightMapShaderLib(){t.apply(this,arguments)}return __extends(CommonLightMapShaderLib,t),CommonLightMapShaderLib.create=function(){var e=new this;return e},CommonLightMapShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=r.buffers.getChild(e.EBufferDataType.TEXCOORD);i&&this.sendAttributeBuffer(t,"a_texCoord",i)},CommonLightMapShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addAttributeVariable(["a_texCoord"])},CommonLightMapShaderLib}(e.EngineShaderLib);e.CommonLightMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function LightMapShaderLib(){t.apply(this,arguments),this.type="lightMap"}return __extends(LightMapShaderLib,t),LightMapShaderLib.create=function(){var e=new this;return e},LightMapShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_lightMapIntensity",r.lightMapIntensity)},LightMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([e.VariableNameTable.getVariableName("lightMap"),"u_lightMapIntensity"])},LightMapShaderLib}(e.BaseLightMapShaderLib);e.LightMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DiffuseMapShaderLib(){t.apply(this,arguments),this.type="diffuseMap"}return __extends(DiffuseMapShaderLib,t),DiffuseMapShaderLib.create=function(){var e=new this;return e},DiffuseMapShaderLib.prototype.sendShaderVariables=function(e,t,r){var n=r.diffuseMap;return this.sendUniformData(e,"u_diffuseMapSourceRegion",n.sourceRegionForGLSL),this.sendUniformData(e,"u_diffuseMapRepeatRegion",n.repeatRegion),this},DiffuseMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([e.VariableNameTable.getVariableName("diffuseMap"),"u_diffuseMapSourceRegion","u_diffuseMapRepeatRegion"])},__decorate([e.require(function(t,r,n){var i=n.diffuseMap;e.assert(!!i,e.Log.info.FUNC_MUST_DEFINE("diffuseMap")),e.assert(!!i.sourceRegionForGLSL&&!!i.repeatRegion,e.Log.info.FUNC_SHOULD("material.diffuseMap","has sourceRegionForGLSL,repeatRegion data"))})],DiffuseMapShaderLib.prototype,"sendShaderVariables",null),DiffuseMapShaderLib}(e.BaseLightMapShaderLib);e.DiffuseMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SpecularMapShaderLib(){t.apply(this,arguments),this.type="specularMap"}return __extends(SpecularMapShaderLib,t),SpecularMapShaderLib.create=function(){var e=new this;return e},SpecularMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([e.VariableNameTable.getVariableName("specularMap")])},SpecularMapShaderLib}(e.BaseLightMapShaderLib);e.SpecularMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EmissionMapShaderLib(){t.apply(this,arguments),this.type="emissionMap"}return __extends(EmissionMapShaderLib,t),EmissionMapShaderLib.create=function(){var e=new this;return e},EmissionMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([e.VariableNameTable.getVariableName("emissionMap")])},EmissionMapShaderLib}(e.BaseLightMapShaderLib);e.EmissionMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function NormalMapShaderLib(){t.apply(this,arguments),this.type="normalMap"}return __extends(NormalMapShaderLib,t),NormalMapShaderLib.create=function(){var e=new this;return e},NormalMapShaderLib.prototype.sendShaderVariables=function(r,n,i){var a=null;t.prototype.sendShaderVariables.call(this,r,n,i),a=n.buffers.getChild(e.EBufferDataType.TANGENT),a&&this.sendAttributeBuffer(r,"a_tangent",a)},NormalMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addAttributeVariable(["a_tangent"]),this.addUniformVariable([e.VariableNameTable.getVariableName("normalMap")])},NormalMapShaderLib}(e.BaseLightMapShaderLib);e.NormalMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NoLightMapShaderLib(){e.apply(this,arguments),this.type="noLightMap"}return __extends(NoLightMapShaderLib,e),NoLightMapShaderLib.create=function(){var e=new this;return e},NoLightMapShaderLib.prototype.sendShaderVariables=function(e,t,r){},NoLightMapShaderLib}(e.EngineShaderLib);e.NoLightMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NoDiffuseMapShaderLib(){e.apply(this,arguments),this.type="noDiffuseMap"}return __extends(NoDiffuseMapShaderLib,e),NoDiffuseMapShaderLib.create=function(){var e=new this;return e},NoDiffuseMapShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_diffuse",r.color.toVector4())},NoDiffuseMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_diffuse"])},NoDiffuseMapShaderLib}(e.EngineShaderLib);e.NoDiffuseMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NoSpecularMapShaderLib(){e.apply(this,arguments),this.type="noSpecularMap"}return __extends(NoSpecularMapShaderLib,e),NoSpecularMapShaderLib.create=function(){var e=new this;return e},NoSpecularMapShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_specular",r.specularColor.toVector4())},NoSpecularMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_specular"])},NoSpecularMapShaderLib}(e.EngineShaderLib);e.NoSpecularMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NoEmissionMapShaderLib(){e.apply(this,arguments),this.type="noEmissionMap"}return __extends(NoEmissionMapShaderLib,e),NoEmissionMapShaderLib.create=function(){var e=new this;return e},NoEmissionMapShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_emission",r.emissionColor.toVector4())},NoEmissionMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_emission"])},NoEmissionMapShaderLib}(e.EngineShaderLib);e.NoEmissionMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function NoNormalMapShaderLib(){t.apply(this,arguments),this.type="noNormalMap"}return __extends(NoNormalMapShaderLib,t),NoNormalMapShaderLib.create=function(){var e=new this;return e},NoNormalMapShaderLib.prototype.sendShaderVariables=function(e,t,r){},NoNormalMapShaderLib.prototype.setShaderDefinition=function(r,n){var i=null;t.prototype.setShaderDefinition.call(this,r,n),i=e.ShaderChunk.noNormalMap_light_fragment,this.fsSourceVarDeclare=i.varDeclare,this.fsSourceFuncDefine+=i.funcDefine},NoNormalMapShaderLib}(e.EngineShaderLib);e.NoNormalMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BuildShadowMapShaderLib(){e.apply(this,arguments)}return __extends(BuildShadowMapShaderLib,e),BuildShadowMapShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.setFsSource(this.getFsChunk("commonBuildShadowMap_fragment.glsl")),this.setFsSource(this.getFsChunk(),"+")},BuildShadowMapShaderLib}(e.EngineShaderLib);e.BuildShadowMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BuildTwoDShadowMapShaderLib(){t.apply(this,arguments),this.type="buildTwoDShadowMap"}return __extends(BuildTwoDShadowMapShaderLib,t),BuildTwoDShadowMapShaderLib.create=function(){var e=new this;return e},BuildTwoDShadowMapShaderLib.prototype.sendShaderVariables=function(e,t,r){e.sendMatrix4("u_vpMatrixFromLight",t.vMatrix.applyMatrix(t.pMatrix,!0))},BuildTwoDShadowMapShaderLib.prototype.setShaderDefinition=function(r,n){var i=null;t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable(["u_vpMatrixFromLight"]),i=e.GPUDetector.getInstance().extensionDepthTexture?this.getFsChunk("buildTwoDShadowMap_depthMap"):this.getFsChunk("buildTwoDShadowMap_packDepth"),this.fsSourceBody=i.body},BuildTwoDShadowMapShaderLib}(e.BuildShadowMapShaderLib);e.BuildTwoDShadowMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BuildCubemapShadowMapShaderLib(){t.apply(this,arguments),this.type="buildCubemapShadowMap"}return __extends(BuildCubemapShadowMapShaderLib,t),BuildCubemapShadowMapShaderLib.create=function(){var e=new this;return e},BuildCubemapShadowMapShaderLib.prototype.sendShaderVariables=function(t,r,n){e.Director.getInstance().scene.glslData.getChild(e.EShaderGLSLData.BUILD_CUBEMAP_SHADOWMAP).forEach(function(e,r){var n=e.light;t.sendVector3("u_lightPos",n.position),t.sendFloat1("u_farPlane",n.shadowCameraFar)})},BuildCubemapShadowMapShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_lightPos","u_farPlane"])},BuildCubemapShadowMapShaderLib}(e.BuildShadowMapShaderLib);e.BuildCubemapShadowMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function TotalShadowMapShaderLib(){e.apply(this,arguments),this.type="totalShadowMap"}return __extends(TotalShadowMapShaderLib,e),TotalShadowMapShaderLib.create=function(){var e=new this;return e},TotalShadowMapShaderLib.prototype.sendShaderVariables=function(e,t,r){},TotalShadowMapShaderLib}(e.EngineShaderLib);e.TotalShadowMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ShadowMapShaderLib(){t.apply(this,arguments),this._softTypeChangeSubscription=null}return __extends(ShadowMapShaderLib,t),ShadowMapShaderLib.prototype.init=function(){var t=this.shader;this._softTypeChangeSubscription=e.EventManager.fromEvent(e.Director.getInstance().scene.gameObjectScene,e.EEngineEvent.SHADOWMAP_SOFTTYPE_CHANGE).subscribe(function(){t.libDirty=!0})},ShadowMapShaderLib.prototype.dispose=function(){this._softTypeChangeSubscription&&this._softTypeChangeSubscription.dispose()},ShadowMapShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this._setShadowMapSource()},ShadowMapShaderLib.prototype._setShadowMapSource=function(){var t=e.Director.getInstance().scene,r=t.gameObjectScene.shadowManager,n=r.twoDShadowMapCountForGLSL,i=r.cubemapShadowMapCountForGLSL;t.shadowMap.softType===e.EShadowMapSoftType.PCF&&this.fsSourceDefineList.addChildren([{name:"SHADOWMAP_TYPE_PCF"}]),this.vsSourceDefineList.addChild({name:"TWOD_SHADOWMAP_COUNT",value:n}),this.fsSourceDefineList.addChildren([{name:"TWOD_SHADOWMAP_COUNT",value:n},{name:"CUBEMAP_SHADOWMAP_COUNT",value:i}])},ShadowMapShaderLib}(e.EngineShaderLib);e.ShadowMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDShadowMapShaderLib(){t.apply(this,arguments),this.type="twoDShadowMap"}return __extends(TwoDShadowMapShaderLib,t),TwoDShadowMapShaderLib.create=function(){var e=new this;return e},TwoDShadowMapShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=null;i=e.Director.getInstance().scene.glslData.getChild(e.EShaderGLSLData.TWOD_SHADOWMAP),i&&i.forEach(function(e,r){var n=e.camera,i=e.light;return e.isRenderListEmpty?void t.sendNum1("u_isTwoDRenderListEmpty["+r+"]",1):(t.sendNum1("u_isTwoDRenderListEmpty["+r+"]",0),t.sendMatrix4("u_vpMatrixFromLight["+r+"]",n.worldToCameraMatrix.applyMatrix(n.pMatrix,!0)),t.sendFloat2("u_twoDShadowSize["+r+"]",[i.shadowMapWidth,i.shadowMapHeight]),t.sendFloat1("u_twoDShadowBias["+r+"]",i.shadowBias),t.sendFloat1("u_twoDShadowDarkness["+r+"]",i.shadowDarkness),void t.sendVector3("u_twoDLightPos["+r+"]",i.position))})},TwoDShadowMapShaderLib.prototype.setShaderDefinition=function(r,n){var i=null;t.prototype.setShaderDefinition.call(this,r,n),i=e.GPUDetector.getInstance().extensionDepthTexture?this.getFsChunk("twoDShadowMap_depthMap"):this.getFsChunk("twoDShadowMap_unpackDepth"),this.fsSourceFuncDeclare+=i.funcDeclare,this.fsSourceFuncDefine+=i.funcDefine},TwoDShadowMapShaderLib}(e.ShadowMapShaderLib);e.TwoDShadowMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapShadowMapShaderLib(){t.apply(this,arguments),this.type="cubemapShadowMap"}return __extends(CubemapShadowMapShaderLib,t),CubemapShadowMapShaderLib.create=function(){var e=new this;return e},CubemapShadowMapShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=e.Director.getInstance().scene.glslData.getChild(e.EShaderGLSLData.CUBEMAP_SHADOWMAP);i&&i.forEach(function(e,r){var n=e.light;e.isRenderListEmpty?t.sendNum1("u_isCubemapRenderListEmpty["+r+"]",1):t.sendNum1("u_isCubemapRenderListEmpty["+r+"]",0),t.sendVector3("u_cubemapLightPos["+r+"]",n.position),t.sendFloat1("u_farPlane["+r+"]",n.shadowCameraFar),t.sendFloat1("u_cubemapShadowBias["+r+"]",n.shadowBias),t.sendFloat1("u_cubemapShadowDarkness["+r+"]",n.shadowDarkness)})},CubemapShadowMapShaderLib}(e.ShadowMapShaderLib);e.CubemapShadowMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NoShadowMapShaderLib(){e.apply(this,arguments),this.type="noShadowMap"}return __extends(NoShadowMapShaderLib,e),NoShadowMapShaderLib.create=function(){var e=new this;return e},NoShadowMapShaderLib.prototype.sendShaderVariables=function(e,t,r){},NoShadowMapShaderLib}(e.EngineShaderLib);e.NoShadowMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CustomShaderLibUtils(){}return CustomShaderLibUtils.sendUniformData=function(t,r,n,i){r===e.EVariableType.STRUCTURE?this._sendStructureData(t,n,i):i.sendUniformData(t,r,n)},CustomShaderLibUtils.sendUniformDataWithSemantic=function(t,r,n,i,a){r===e.EVariableType.STRUCTURE?this._sendStructureDataWithSemantic(t,n,i,a):i.sendUniformData(t,r,this._getUniformData(n,a))},CustomShaderLibUtils.sendAttributeBufferWithSemantic=function(e,t,r,n,i){n.sendAttributeBuffer(e,this._getAttributeType(t),this._getAttributeData(r,t,i))},CustomShaderLibUtils._sendStructureData=function(e,t,r){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];r.sendStructureData(e+"."+n,i.type,i.value)}},CustomShaderLibUtils._sendStructureDataWithSemantic=function(e,t,r,n){for(var i in t)if(t.hasOwnProperty(i)){var a=t[i];r.sendStructureData(e+"."+i,a.type,this._getUniformData(a.value,n))}},CustomShaderLibUtils._getAttributeData=function(t,r,n){switch(t){case e.EVariableSemantic.POSITION:return n.buffers.getChild(e.EBufferDataType.VERTICE);case e.EVariableSemantic.TEXCOORD:return n.buffers.getChild(e.EBufferDataType.TEXCOORD);case e.EVariableSemantic.COLOR:return n.buffers.getChild(e.EBufferDataType.COLOR);case e.EVariableSemantic.NORMAL:return n.buffers.getChild(e.EBufferDataType.NORMAL);case e.EVariableSemantic.TANGENT:return n.buffers.getChild(e.EBufferDataType.TANGENT);default:return t}},CustomShaderLibUtils._getAttributeType=function(t){return e.EVariableType.BUFFER},CustomShaderLibUtils._getUniformData=function(t,r){switch(t){case e.EVariableSemantic.MODEL:return r.mMatrix;case e.EVariableSemantic.VIEW:return r.vMatrix;case e.EVariableSemantic.PROJECTION:return r.pMatrix;case e.EVariableSemantic.MODEL_VIEW_PROJECTION:return r.mvpMatrix;case e.EVariableSemantic.MODEL_INVERSE:return r.mMatrix.clone().invert();case e.EVariableSemantic.VIEW_INVERSE:return r.vMatrix.clone().invert();case e.EVariableSemantic.PROJECTION_INVERSE:return r.pMatrix.clone().invert();case e.EVariableSemantic.MODEL_VIEW_INVERSE:return r.mMatrix.applyMatrix(r.vMatrix,!0).invert();case e.EVariableSemantic.MODEL_VIEW_PROJECTION_INVERSE:return r.mMatrix.applyMatrix(r.vMatrix,!0).applyMatrix(r.pMatrix,!1).invert();case e.EVariableSemantic.MODEL_INVERSE_TRANSPOSE:return r.normalMatrix;case e.EVariableSemantic.MODEL_VIEW_INVERSE_TRANSPOSE:return r.mMatrix.applyMatrix(r.vMatrix,!0).invertTo3x3().transpose();case e.EVariableSemantic.VIEWPORT:return e.DeviceManager.getInstance().getViewport();default:return t}},__decorate([e.require(function(t,r,n,i){e.assert(r!==e.EVariableType.SAMPLER_2D&&r!==e.EVariableType.SAMPLER_CUBE,e.Log.info.FUNC_SHOULD_NOT("type","be SAMPLER_2D or SAMPLER_CUBE, but actual is "+r)),e.assert(r!==e.EVariableType.STRUCTURES,e.Log.info.FUNC_NOT_SUPPORT("type === STRUCTURES")),r===e.EVariableType.STRUCTURE&&e.assert(e.JudgeUtils.isDirectObject(n),e.Log.info.FUNC_MUST_BE("value","object when type === STRUCTURE"))})],CustomShaderLibUtils,"sendUniformData",null),__decorate([e.require(function(t,r,n,i,a){e.assert(r!==e.EVariableType.SAMPLER_2D&&r!==e.EVariableType.SAMPLER_CUBE,e.Log.info.FUNC_SHOULD_NOT("type","be SAMPLER_2D or SAMPLER_CUBE, but actual is "+r)),e.assert(r!==e.EVariableType.STRUCTURES,e.Log.info.FUNC_NOT_SUPPORT("type === STRUCTURES")),r===e.EVariableType.STRUCTURE&&e.assert(e.JudgeUtils.isDirectObject(n),e.Log.info.FUNC_MUST_BE("value","object when type === STRUCTURE"))})],CustomShaderLibUtils,"sendUniformDataWithSemantic",null),__decorate([e.require(function(t,r,n){switch(e.assert("INDICE"!==t,e.Log.info.FUNC_NOT_SUPPORT("semantic:INDICE")),t){case"POSITION":case"COLOR":case"NORMAL":case"TANGENT":e.assert(r===e.EVariableType.FLOAT_3,e.Log.info.FUNC_SHOULD("type","be EVariableType.FLOAT_3"));break;case"TEXCOORD":e.assert(r===e.EVariableType.FLOAT_2,e.Log.info.FUNC_SHOULD("type","be EVariableType.FLOAT_2"))}}),e.ensure(function(t){e.assert(t&&t instanceof e.Buffer,e.Log.info.FUNC_SHOULD("attributeData","be Buffer, but actual is "+t))})],CustomShaderLibUtils,"_getAttributeData",null),CustomShaderLibUtils}();e.CustomShaderLibUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function RenderTargerRendererShaderLibUtils(){}return RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=t[0],a=t[1],o=null;n=e.Director.getInstance().scene.glslData.getChild(a),n&&(o=3===t.length?t[2]:"u_isRenderListEmpty",n.isRenderListEmpty?i.sendUniformData(o,e.EVariableType.NUMBER_1,1):i.sendUniformData(o,e.EVariableType.NUMBER_1,0))},RenderTargerRendererShaderLibUtils}();e.RenderTargerRendererShaderLibUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function InstanceShaderLib(){e.apply(this,arguments)}return __extends(InstanceShaderLib,e),InstanceShaderLib}(e.EngineShaderLib);e.InstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NoInstanceShaderLib(){e.apply(this,arguments)}return __extends(NoInstanceShaderLib,e),NoInstanceShaderLib}(e.EngineShaderLib);e.NoInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ModelMatrixInstanceShaderLib(){e.apply(this,arguments)}return __extends(ModelMatrixInstanceShaderLib,e),ModelMatrixInstanceShaderLib}(e.InstanceShaderLib);e.ModelMatrixInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NormalMatrixModelMatrixInstanceShaderLib(){e.apply(this,arguments)}return __extends(NormalMatrixModelMatrixInstanceShaderLib,e),NormalMatrixModelMatrixInstanceShaderLib}(e.InstanceShaderLib);e.NormalMatrixModelMatrixInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ModelMatrixHardwareInstanceShaderLib(){e.apply(this,arguments),this.type="modelMatrix_hardware_instance"}return __extends(ModelMatrixHardwareInstanceShaderLib,e),ModelMatrixHardwareInstanceShaderLib.create=function(){var e=new this;return e},ModelMatrixHardwareInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){},ModelMatrixHardwareInstanceShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addAttributeVariable(["a_mVec4_0","a_mVec4_1","a_mVec4_2","a_mVec4_3"])},ModelMatrixHardwareInstanceShaderLib}(e.ModelMatrixInstanceShaderLib);e.ModelMatrixHardwareInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NormalMatrixHardwareInstanceShaderLib(){e.apply(this,arguments),this.type="normalMatrix_hardware_instance"}return __extends(NormalMatrixHardwareInstanceShaderLib,e),NormalMatrixHardwareInstanceShaderLib.create=function(){var e=new this;return e},NormalMatrixHardwareInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){},NormalMatrixHardwareInstanceShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addAttributeVariable(["a_normalVec4_0","a_normalVec4_1","a_normalVec4_2"])},NormalMatrixHardwareInstanceShaderLib}(e.NormalMatrixModelMatrixInstanceShaderLib);e.NormalMatrixHardwareInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ModelMatrixBatchInstanceShaderLib(){e.apply(this,arguments),this.type="modelMatrix_batch_instance"}return __extends(ModelMatrixBatchInstanceShaderLib,e),ModelMatrixBatchInstanceShaderLib.create=function(){var e=new this;return e},ModelMatrixBatchInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){},ModelMatrixBatchInstanceShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_mMatrix"])},ModelMatrixBatchInstanceShaderLib}(e.ModelMatrixInstanceShaderLib);e.ModelMatrixBatchInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NormalMatrixBatchInstanceShaderLib(){e.apply(this,arguments),this.type="normalMatrix_batch_instance"}return __extends(NormalMatrixBatchInstanceShaderLib,e),NormalMatrixBatchInstanceShaderLib.create=function(){var e=new this;return e},NormalMatrixBatchInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){},NormalMatrixBatchInstanceShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_normalMatrix"])},NormalMatrixBatchInstanceShaderLib}(e.NormalMatrixModelMatrixInstanceShaderLib);e.NormalMatrixBatchInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function ModelMatrixNoInstanceShaderLib(){e.apply(this,arguments),this.type="modelMatrix_noInstance"}return __extends(ModelMatrixNoInstanceShaderLib,e),ModelMatrixNoInstanceShaderLib.create=function(){var e=new this;return e},ModelMatrixNoInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_mMatrix",t.mMatrix)},ModelMatrixNoInstanceShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_mMatrix"])},ModelMatrixNoInstanceShaderLib}(e.NoInstanceShaderLib);e.ModelMatrixNoInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function NormalMatrixNoInstanceShaderLib(){e.apply(this,arguments),this.type="normalMatrix_noInstance"}return __extends(NormalMatrixNoInstanceShaderLib,e),NormalMatrixNoInstanceShaderLib.create=function(){var e=new this;
return e},NormalMatrixNoInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_normalMatrix",t.normalMatrix)},NormalMatrixNoInstanceShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_normalMatrix"])},NormalMatrixNoInstanceShaderLib}(e.NoInstanceShaderLib);e.NormalMatrixNoInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ShaderChunk(){}return ShaderChunk.empty={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.NULL=-1,ShaderChunk.normal_morph_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 a_normal = a_currentFrameNormal + (a_nextFrameNormal - a_currentFrameNormal) * u_interpolation;\n"},ShaderChunk.vertice_morph_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 a_position = a_currentFramePosition + (a_nextFramePosition - a_currentFramePosition) * u_interpolation;\n"},ShaderChunk.basic_fragment={top:"",define:"",varDeclare:"varying vec3 v_color;\n",funcDeclare:"",funcDefine:"",body:"vec4 totalColor = vec4(v_color, 1.0);\n"},ShaderChunk.basic_vertex={top:"",define:"",varDeclare:"varying vec3 v_color;\n",funcDeclare:"",funcDefine:"",body:"v_color = a_color;\n"},ShaderChunk.end_basic_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragColor = vec4(totalColor.rgb, totalColor.a * u_opacity);\n"},ShaderChunk.common_define={top:"",define:"#define NULL -1.0\n",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.common_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.common_function={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"mat2 transpose(mat2 m) {\n  return mat2(  m[0][0], m[1][0],   // new col 0\n                m[0][1], m[1][1]    // new col 1\n             );\n  }\nmat3 transpose(mat3 m) {\n  return mat3(  m[0][0], m[1][0], m[2][0],  // new col 0\n                m[0][1], m[1][1], m[2][1],  // new col 1\n                m[0][2], m[1][2], m[2][2]   // new col 1\n             );\n  }\n\nbool isRenderListEmpty(int isRenderListEmpty){\n  return isRenderListEmpty == 1;\n}\n",body:""},ShaderChunk.common_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.highp_fragment={top:"precision highp float;\nprecision highp int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.lowp_fragment={top:"precision lowp float;\nprecision lowp int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.mediump_fragment={top:"precision mediump float;\nprecision mediump int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.noNormalMap_light_fragment={top:"",define:"",varDeclare:"varying vec3 v_normal;\n",funcDeclare:"",funcDefine:"#if POINT_LIGHTS_COUNT > 0\nvec3 getPointLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return getPointLightDirByLightPos(u_pointLights[x].position);\n        }\n    }\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvec3 getDirectionLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return getDirectionLightDirByLightPos(u_directionLights[x].position);\n        }\n    }\n\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n\nvec3 getViewDir(){\n    return normalize(u_cameraPos - v_worldPosition);\n}\n",body:""},ShaderChunk.common_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 flipNormal(vec3 normal){\n    vec3 normalForRefraction = normal;\n    normalForRefraction.y = -normalForRefraction.y;\n    normalForRefraction.z = -normalForRefraction.z;\n\n    return normalForRefraction;\n}\n",body:""},ShaderChunk.lightCommon_fragment={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n#if POINT_LIGHTS_COUNT > 0\nstruct PointLight {\n    vec3 position;\n    vec4 color;\n    float intensity;\n\n    float range;\n    float constant;\n    float linear;\n    float quadratic;\n};\nuniform PointLight u_pointLights[POINT_LIGHTS_COUNT];\n\n#endif\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\nstruct DirectionLight {\n    vec3 position;\n\n    float intensity;\n\n    vec4 color;\n};\nuniform DirectionLight u_directionLights[DIRECTION_LIGHTS_COUNT];\n#endif\n",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.lightCommon_vertex={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n#if POINT_LIGHTS_COUNT > 0\n    struct PointLight {\n    vec3 position;\n    vec4 color;\n    float intensity;\n\n    float range;\n    float constant;\n    float linear;\n    float quadratic;\n};\nuniform PointLight u_pointLights[POINT_LIGHTS_COUNT];\n\n#endif\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\n    struct DirectionLight {\n    vec3 position;\n\n    float intensity;\n\n    vec4 color;\n};\nuniform DirectionLight u_directionLights[DIRECTION_LIGHTS_COUNT];\n#endif\n",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.lightEnd_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragColor = vec4(totalColor.rgb, totalColor.a * u_opacity);\n"},ShaderChunk.light_common={top:"",define:"",varDeclare:"",funcDeclare:"vec3 getDirectionLightDirByLightPos(vec3 lightPos);\nvec3 getPointLightDirByLightPos(vec3 lightPos);\nvec3 getPointLightDirByLightPos(vec3 lightPos, vec3 worldPosition);\n",funcDefine:"vec3 getDirectionLightDirByLightPos(vec3 lightPos){\n    return lightPos - vec3(0.0);\n    //return vec3(0.0) - lightPos;\n}\nvec3 getPointLightDirByLightPos(vec3 lightPos){\n    return lightPos - v_worldPosition;\n}\nvec3 getPointLightDirByLightPos(vec3 lightPos, vec3 worldPosition){\n    return lightPos - worldPosition;\n}\n",body:""},ShaderChunk.light_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float getBlinnShininess(float shininess, vec3 normal, vec3 lightDir, vec3 viewDir, float dotResultBetweenNormAndLight){\n        vec3 halfAngle = normalize(lightDir + viewDir);\n        float blinnTerm = dot(normal, halfAngle);\n\n        blinnTerm = clamp(blinnTerm, 0.0, 1.0);\n        blinnTerm = dotResultBetweenNormAndLight != 0.0 ? blinnTerm : 0.0;\n        blinnTerm = pow(blinnTerm, shininess);\n\n        return blinnTerm;\n}\n\nfloat getPhongShininess(float shininess, vec3 normal, vec3 lightDir, vec3 viewDir, float dotResultBetweenNormAndLight){\n        vec3 reflectDir = reflect(-lightDir, normal);\n        float phongTerm = dot(viewDir, reflectDir);\n\n        phongTerm = clamp(phongTerm, 0.0, 1.0);\n        phongTerm = dotResultBetweenNormAndLight != 0.0 ? phongTerm : 0.0;\n        phongTerm = pow(phongTerm, shininess);\n\n        return phongTerm;\n}\n\nvec4 calcLight(vec3 lightDir, vec4 color, float intensity, float attenuation, vec3 normal, vec3 viewDir)\n{\n        vec4 materialLight = getMaterialLight();\n        vec4 materialDiffuse = getMaterialDiffuse();\n        vec4 materialSpecular = getMaterialSpecular();\n        vec4 materialEmission = getMaterialEmission();\n\n        float dotResultBetweenNormAndLight = dot(normal, lightDir);\n        float diff = max(dotResultBetweenNormAndLight, 0.0);\n\n        vec4 emissionColor = materialEmission;\n\n        vec4 ambientColor = (u_ambient + materialLight) * materialDiffuse;\n\n\n        if(u_lightModel == 3){\n            return emissionColor + ambientColor;\n        }\n\n\n        vec4 diffuseColor = color * materialDiffuse;\n\n        //not affect alpha data\n        diffuseColor = vec4(diff * vec3(diffuseColor) * intensity, diffuseColor.a);\n\n\n        float spec = 0.0;\n\n        if(u_lightModel == 2){\n                spec = getPhongShininess(u_shininess, normal, lightDir, viewDir, diff);\n        }\n        else if(u_lightModel == 1){\n                spec = getBlinnShininess(u_shininess, normal, lightDir, viewDir, diff);\n        }\n\n        //not affect alpha data\n        vec4 specularColor = vec4(spec * vec3(materialSpecular) * intensity, materialSpecular.a);\n\n        vec4 tColor = diffuseColor + specularColor;\n\n        //not affect alpha data\n        return emissionColor + ambientColor + vec4(attenuation * vec3(tColor), tColor.a);\n}\n\n\n\n\n#if POINT_LIGHTS_COUNT > 0\n        vec4 calcPointLight(vec3 lightDir, PointLight light, vec3 normal, vec3 viewDir)\n{\n        //lightDir is not normalize computing distance\n        float distance = length(lightDir);\n\n        float attenuation = 0.0;\n\n        if(light.range == NULL || distance < light.range)\n        {\n            attenuation = 1.0 / (light.constant + light.linear * distance + light.quadratic * (distance * distance));\n        }\n\n        lightDir = normalize(lightDir);\n\n        return calcLight(lightDir, light.color, light.intensity, attenuation, normal, viewDir);\n}\n#endif\n\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\n        vec4 calcDirectionLight(vec3 lightDir, DirectionLight light, vec3 normal, vec3 viewDir)\n{\n        float attenuation = 1.0;\n\n        lightDir = normalize(lightDir);\n\n        return calcLight(lightDir, light.color, light.intensity, attenuation, normal, viewDir);\n}\n#endif\n\n\n\nvec4 calcTotalLight(vec3 norm, vec3 viewDir){\n    vec4 totalLight = vec4(0.0);\n\n    #if POINT_LIGHTS_COUNT > 0\n                for(int i = 0; i < POINT_LIGHTS_COUNT; i++){\n                totalLight += calcPointLight(getPointLightDir(i), u_pointLights[i], norm, viewDir);\n        }\n    #endif\n\n    #if DIRECTION_LIGHTS_COUNT > 0\n                for(int i = 0; i < DIRECTION_LIGHTS_COUNT; i++){\n                totalLight += calcDirectionLight(getDirectionLightDir(i), u_directionLights[i], norm, viewDir);\n        }\n    #endif\n\n        return totalLight;\n}\n",body:"vec3 normal = normalize(getNormal());\n\n#ifdef BOTH_SIDE\nnormal = normal * (-1.0 + 2.0 * float(gl_FrontFacing));\n#endif\n\nvec3 viewDir = normalize(getViewDir());\n\nvec4 totalColor = calcTotalLight(normal, viewDir);\n\ntotalColor *= vec4(getShadowVisibility(), 1.0);\n"},ShaderChunk.light_setWorldPosition_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"v_worldPosition = vec3(mMatrix * vec4(a_position, 1.0));\n"},ShaderChunk.light_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_Position = u_pMatrix * u_vMatrix * vec4(v_worldPosition, 1.0);\n"},ShaderChunk.map_forBasic_fragment={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= texture2D(u_sampler2D0, v_mapCoord0);\n"},ShaderChunk.map_forBasic_vertex={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord0 = a_texCoord * u_map0SourceRegion.zw + u_map0SourceRegion.xy;\n\n    v_mapCoord0 = sourceTexCoord0 * u_map0RepeatRegion.zw + u_map0RepeatRegion.xy;\n"},ShaderChunk.multi_map_forBasic_fragment={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\nvarying vec2 v_mapCoord1;\n",funcDeclare:"",funcDefine:"vec4 getMapColor(){\n            vec4 color0 = texture2D(u_sampler2D0, v_mapCoord0);\n            vec4 color1 = texture2D(u_sampler2D1, v_mapCoord1);\n\n            if(u_combineMode == 0){\n                return mix(color0, color1, u_mixRatio);\n            }\n            else if(u_combineMode == 1){\n                return color0 * color1;\n            }\n            else if(u_combineMode == 2){\n                return color0 + color1;\n            }\n\n            /*!\n            solve error in window7 chrome/firefox:\n            not all control paths return a value.\n            failed to create d3d shaders\n            */\n            return vec4(1.0);\n\t\t}\n",body:"totalColor *= getMapColor();\n"},ShaderChunk.multi_map_forBasic_vertex={top:"",define:"",varDeclare:"varying vec2 v_mapCoord1;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord1 = a_texCoord * u_map1SourceRegion.zw + u_map1SourceRegion.xy;\n\n    v_mapCoord1 = sourceTexCoord1 * u_map1RepeatRegion.zw + u_map1RepeatRegion.xy;\n"},ShaderChunk.skybox_fragment={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"gl_FragColor = textureCube(u_samplerCube0, v_dir);\n"},ShaderChunk.skybox_vertex={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"vec4 pos = u_pMatrix * mat4(mat3(u_vMatrix)) * mMatrix * vec4(a_position, 1.0);\n\n    gl_Position = pos.xyww;\n\n    v_dir = a_position;\n"},ShaderChunk.basic_forBasic_envMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, v_dir);\n"},ShaderChunk.basic_forBasic_envMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"v_dir = a_position;\n"},ShaderChunk.forBasic_envMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_normal;\nvarying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"vec3 inDir = normalize(v_position - u_cameraPos);\n"},ShaderChunk.forBasic_envMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_normal;\nvarying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"v_normal = normalize( normalMatrix * a_normal);\n    v_position = vec3(mMatrix * vec4(a_position, 1.0));\n"},ShaderChunk.fresnel_forBasic_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float computeFresnelRatio(vec3 inDir, vec3 normal, float refractionRatio){\n    float f = pow(1.0 - refractionRatio, 2.0) / pow(1.0 + refractionRatio, 2.0);\n    float fresnelPower = 5.0;\n    float ratio = f + (1.0 - f) * pow((1.0 - dot(inDir, normal)), fresnelPower);\n\n    return ratio / 100.0;\n}\nvec4 getEnvMapTotalColor(vec3 inDir, vec3 normal){\n    vec3 reflectDir = reflect(inDir, normal);\n    vec3 refractDir = refract(inDir, flipNormal(normal), u_refractionRatio);\n\n    vec4 reflectColor = textureCube(u_samplerCube0, reflectDir);\n    vec4 refractColor = textureCube(u_samplerCube0, refractDir);\n\n    vec4 totalColor = vec4(0.0);\n\n\tif(u_reflectivity != NULL){\n        totalColor = mix(reflectColor, refractColor, u_reflectivity);\n\t}\n\telse{\n        totalColor = mix(reflectColor, refractColor, computeFresnelRatio(inDir, normal, u_refractionRatio));\n\t}\n\n\treturn totalColor;\n}\n",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= getEnvMapTotalColor(inDir, normalize(v_normal));\n}\n"},ShaderChunk.reflection_forBasic_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, reflect(inDir, normalize(v_normal)));\n}\n"},ShaderChunk.refraction_forBasic_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, refract(inDir, v_normal, u_refractionRatio));\n}\n"},ShaderChunk.basic_forLight_envMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_basicEnvMap_dir;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, v_basicEnvMap_dir);\n"},ShaderChunk.basic_forLight_envMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_basicEnvMap_dir;\n",funcDeclare:"",funcDefine:"",body:"v_basicEnvMap_dir = a_position;\n"},ShaderChunk.forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 inDir = normalize(v_worldPosition - u_cameraPos);\n"},ShaderChunk.forLight_envMap_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.fresnel_forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float computeFresnelRatio(vec3 inDir, vec3 normal, float refractionRatio){\n    float f = pow(1.0 - refractionRatio, 2.0) / pow(1.0 + refractionRatio, 2.0);\n    float fresnelPower = 5.0;\n    float ratio = f + (1.0 - f) * pow((1.0 - dot(inDir, normal)), fresnelPower);\n\n    return ratio / 100.0;\n}\n\nvec4 getEnvMapTotalColor(vec3 inDir, vec3 normal){\n    vec3 reflectDir = reflect(inDir, normal);\n\n/*!\n//todo why only fresnel->refraction need flip normal, but refraction don't need?\n*/\n    vec3 refractDir = refract(inDir, flipNormal(normal), u_refractionRatio);\n\n    vec4 reflectColor = textureCube(u_samplerCube0, reflectDir);\n    vec4 refractColor = textureCube(u_samplerCube0, refractDir);\n\n\n    vec4 totalColor = vec4(0.0);\n\n\tif(u_reflectivity != NULL){\n        totalColor = mix(reflectColor, refractColor, u_reflectivity);\n\t}\n\telse{\n        totalColor = mix(reflectColor, refractColor, computeFresnelRatio(inDir, normal, u_refractionRatio));\n\t}\n\n\treturn totalColor;\n}\n",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n\ttotalColor *= getEnvMapTotalColor(inDir, normalize(getNormal()));\n}\n"},ShaderChunk.reflection_forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, reflect(inDir, normalize(getNormal())));\n}\n"},ShaderChunk.refraction_forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, refract(inDir, flipNormal(normal), u_refractionRatio));\n}\n"},ShaderChunk.diffuseMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_diffuseMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialDiffuse() {\n        return texture2D(u_diffuseMapSampler, v_diffuseMapTexCoord);\n    }\n",body:""},ShaderChunk.diffuseMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_diffuseMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"//todo optimize(combine, reduce compute numbers)\n    //todo BasicTexture extract textureMatrix\n    vec2 sourceTexCoord = a_texCoord * u_diffuseMapSourceRegion.zw + u_diffuseMapSourceRegion.xy;\n    v_diffuseMapTexCoord = sourceTexCoord * u_diffuseMapRepeatRegion.zw + u_diffuseMapRepeatRegion.xy;\n"},ShaderChunk.emissionMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_emissionMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialEmission() {\n        return texture2D(u_emissionMapSampler, v_emissionMapTexCoord);\n    }\n",body:""},ShaderChunk.emissionMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_emissionMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_emissionMapTexCoord = a_texCoord;\n"},ShaderChunk.lightMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_lightMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialLight() {\n        return texture2D(u_lightMapSampler, v_lightMapTexCoord) * u_lightMapIntensity;\n    }\n",body:""},ShaderChunk.lightMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_lightMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_lightMapTexCoord = a_texCoord;\n"},ShaderChunk.noDiffuseMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialDiffuse() {\n        return u_diffuse;\n    }\n",body:""},ShaderChunk.noEmissionMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialEmission() {\n        return u_emission;\n    }\n",body:""},ShaderChunk.noLightMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialLight() {\n        return vec4(0.0);\n    }\n",body:""},ShaderChunk.noNormalMap_fragment={top:"",define:"",varDeclare:"//varying vec3 v_normal;\n//",funcDeclare:"vec3 getNormal();\n\n",funcDefine:"//#if POINT_LIGHTS_COUNT > 0\n//vec3 getPointLightDir(int index){\n//    //workaround '[] : Index expression must be constant' error\n//    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n//        if(x == index){\n//            return getPointLightDirByLightPos(u_pointLights[x].position);\n//        }\n//    }\n//    /*!\n//    solve error in window7 chrome/firefox:\n//    not all control paths return a value.\n//    failed to create d3d shaders\n//    */\n//    return vec3(0.0);\n//}\n//#endif\n//\n//#if DIRECTION_LIGHTS_COUNT > 0\n//vec3 getDirectionLightDir(int index){\n//    //workaround '[] : Index expression must be constant' error\n//    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n//        if(x == index){\n//            return getDirectionLightDirByLightPos(u_directionLights[x].position);\n//        }\n//    }\n//\n//    /*!\n//    solve error in window7 chrome/firefox:\n//    not all control paths return a value.\n//    failed to create d3d shaders\n//    */\n//    return vec3(0.0);\n//}\n//#endif\n//\n//\n//vec3 getViewDir(){\n//    return normalize(u_cameraPos - v_worldPosition);\n//}\nvec3 getNormal(){\n    return v_normal;\n}\n\n",body:""},ShaderChunk.noNormalMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_normal;\n",funcDeclare:"",funcDefine:"",body:"v_normal = normalize(normalMatrix * a_normal);\n"},ShaderChunk.noSpecularMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialSpecular() {\n        return u_specular;\n    }\n",body:""},ShaderChunk.normalMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_normalMapTexCoord;\nvarying vec3 v_viewDir;\n#if POINT_LIGHTS_COUNT > 0\nvarying vec3 v_pointLightDir[POINT_LIGHTS_COUNT];\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvarying vec3 v_directionLightDir[DIRECTION_LIGHTS_COUNT];\n#endif\n\n",funcDeclare:"vec3 getNormal();\n\nvec3 getLightDir(vec3 lightPos);\n\n",funcDefine:"#if POINT_LIGHTS_COUNT > 0\nvec3 getPointLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return v_pointLightDir[x];\n        }\n    }\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\n\nvec3 getDirectionLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return v_directionLightDir[x];\n        }\n    }\n\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n\nvec3 getViewDir(){\n    return v_viewDir;\n}\nvec3 getNormal(){\n        // Obtain normal from normal map in range [0,1]\n        vec3 normal = texture2D(u_normalMapSampler, v_normalMapTexCoord).rgb;\n\n        // Transform normal vector to range [-1,1]\n        return normalize(normal * 2.0 - 1.0);  // this normal is in tangent space\n}\n",body:""},ShaderChunk.normalMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_normalMapTexCoord;\n\tvarying vec3 v_viewDir;\n\n\n#if POINT_LIGHTS_COUNT > 0\nvarying vec3 v_pointLightDir[POINT_LIGHTS_COUNT];\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvarying vec3 v_directionLightDir[DIRECTION_LIGHTS_COUNT];\n#endif\n\n",funcDeclare:"",funcDefine:"mat3 computeTBN(mat3 normalMatrix){\n            vec3 T = normalize(normalMatrix * a_tangent);\n            vec3 N = normalize(normalMatrix * a_normal);\n            // re-orthogonalize T with respect to N\n            T = normalize(T - dot(T, N) * N);\n            // then retrieve perpendicular vector B with the cross product of T and N\n            vec3 B = cross(T, N);\n\n\n            return transpose(mat3(T, B, N));\n        }\n",body:"mat3 TBN = computeTBN(normalMatrix);\n\n    //v_tangentLightPos = TBN * light.position;\n    //v_tangentCameraPos  = TBN * u_cameraPos;\n    //v_tangentPos  = TBN * v_position;\n\n\n    vec3 tangentPosition = TBN * vec3(mMatrix * vec4(a_position, 1.0));\n\n    v_normalMapTexCoord = a_texCoord;\n\n    v_viewDir = normalize(TBN * u_cameraPos - tangentPosition);\n\n\n#if POINT_LIGHTS_COUNT > 0\n       for(int i = 0; i < POINT_LIGHTS_COUNT; i++){\n            //not normalize for computing distance\n            v_pointLightDir[i] = TBN * getPointLightDirByLightPos(u_pointLights[i].position, tangentPosition);\n       }\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\n       for(int i = 0; i < DIRECTION_LIGHTS_COUNT; i++){\n            v_directionLightDir[i] = normalize(- TBN * getDirectionLightDirByLightPos(u_directionLights[i].position));\n       }\n#endif\n\n"},ShaderChunk.specularMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_specularMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialSpecular() {\n        return texture2D(u_specularMapSampler, v_specularMapTexCoord);\n    }\n",body:""},ShaderChunk.specularMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_specularMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_specularMapTexCoord = a_texCoord;\n"},ShaderChunk.buildCubemapShadowMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n",funcDeclare:"",funcDefine:"",body:"\n// get distance between fragment and light source\n    float lightDistance = length(v_worldPosition - u_lightPos);\n\n    // map to [0,1] range by dividing by farPlane\n    lightDistance = lightDistance / u_farPlane;\n\n\ngl_FragData[0] = packDepth(lightDistance);\n\n\n//gl_FragColor = vec4(0.5, 0.0, 1.0, 1.0);\n//gl_FragData[0] = vec4(lightDistance, 1.0, 1.0, 1.0);\n"},ShaderChunk.buildCubemapShadowMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n",funcDeclare:"",funcDefine:"",body:"v_worldPosition = vec3(mMatrix * vec4(a_position, 1.0));\n    gl_Position = u_pMatrix * u_vMatrix * vec4(v_worldPosition, 1.0);\n"},ShaderChunk.buildTwoDShadowMap_depthMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.buildTwoDShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.buildTwoDShadowMap_packDepth_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragData[0] = packDepth(gl_FragCoord.z);\n"},ShaderChunk.buildTwoDShadowMap_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_Position = u_vpMatrixFromLight * mMatrix * vec4(a_position, 1.0);\n"},ShaderChunk.commonBuildShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"// Packing a float in GLSL with multiplication and mod\nvec4 packDepth(in float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n\n    return res;\n}\n",body:""},ShaderChunk.cubemapShadowMap_fragment={top:"",define:"",varDeclare:"uniform samplerCube u_cubemapShadowMapSampler[ CUBEMAP_SHADOWMAP_COUNT ];\n\n    uniform int u_isCubemapRenderListEmpty[ CUBEMAP_SHADOWMAP_COUNT ];\n\tuniform float u_cubemapShadowDarkness[ CUBEMAP_SHADOWMAP_COUNT ];\n\tuniform float u_cubemapShadowBias[ CUBEMAP_SHADOWMAP_COUNT ];\n\tuniform float u_farPlane[ CUBEMAP_SHADOWMAP_COUNT ];\n\tuniform vec3 u_cubemapLightPos[ CUBEMAP_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"// PCF\nfloat getCubemapShadowVisibilityByPCF(float currentDepth, vec3 fragToLight, samplerCube cubemapShadowMapSampler, float shadowBias, float farPlane, float shadowDarkness){\n    //only support in opengl es 3.0+\n    //vec3 sampleOffsetDirections[20] = vec3[]\n    //(\n       //vec3( 1,  1,  1), vec3( 1, -1,  1), vec3(-1, -1,  1), vec3(-1,  1,  1),\n       //vec3( 1,  1, -1), vec3( 1, -1, -1), vec3(-1, -1, -1), vec3(-1,  1, -1),\n       //vec3( 1,  1,  0), vec3( 1, -1,  0), vec3(-1, -1,  0), vec3(-1,  1,  0),\n       //vec3( 1,  0,  1), vec3(-1,  0,  1), vec3( 1,  0, -1), vec3(-1,  0, -1),\n       //vec3( 0,  1,  1), vec3( 0, -1,  1), vec3( 0, -1, -1), vec3( 0,  1, -1)\n    //);\n\n    vec3 sampleOffsetDirections[20];\n\n    sampleOffsetDirections[0] = vec3( 1,  1,  1);\n    sampleOffsetDirections[1] = vec3( 1,  -1,  1);\n    sampleOffsetDirections[2] = vec3( -1,  -1,  1);\n    sampleOffsetDirections[3] = vec3( -1,  1,  1);\n\n    sampleOffsetDirections[4] = vec3( 1,  1,  -1);\n    sampleOffsetDirections[5] = vec3( 1,  -1,  -1);\n    sampleOffsetDirections[6] = vec3( -1,  -1,  -1);\n    sampleOffsetDirections[7] = vec3( -1,  1,  -1);\n\n    sampleOffsetDirections[8] = vec3( 1,  1,  0);\n    sampleOffsetDirections[9] = vec3( 1,  -1,  0);\n    sampleOffsetDirections[10] = vec3( -1,  -1,  0);\n    sampleOffsetDirections[11] = vec3( -1,  1,  0);\n\n    sampleOffsetDirections[12] = vec3( 1,  0,  1);\n    sampleOffsetDirections[13] = vec3( -1,  0,  1);\n    sampleOffsetDirections[14] = vec3( 1,  0,  -1);\n    sampleOffsetDirections[15] = vec3( -1,  0,  -1);\n\n    sampleOffsetDirections[16] = vec3( 0,  1,  1);\n    sampleOffsetDirections[17] = vec3( 0,  -1,  1);\n    sampleOffsetDirections[18] = vec3( 0,  -1,  -1);\n    sampleOffsetDirections[19] = vec3( 0,  1,  -1);\n\n    float shadow = 0.0;\n    int samples = 20;\n\n    //float diskRadius = 0.00000;\n    //Another interesting trick we can apply here is that we can change the diskRadius based on how far the viewer is away from a fragment; this way we can increase the offset radius by the distance to the viewer, making the shadows softer when far away and sharper when close by.\n    float viewDistance = length(u_cameraPos - v_worldPosition);\n    float diskRadius = (1.0 + (viewDistance / farPlane)) / 25.0;\n\n    //for(int i = 0; i < samples; ++i)\n    for(int i = 0; i < 20; ++i)\n    {\n        float pcfDepth = unpackDepth(textureCube(cubemapShadowMapSampler, fragToLight + sampleOffsetDirections[i] * diskRadius));\n        pcfDepth *= farPlane;   // Undo mapping [0;1]\n        shadow += currentDepth - shadowBias > pcfDepth  ? shadowDarkness : 1.0;\n    }\n    shadow /= float(samples);\n\n    return shadow;\n}\n\n\nfloat getCubemapShadowVisibility(vec3 lightDir, samplerCube cubemapShadowMapSampler, vec3 lightPos, float farPlane, float shadowBias, float  shadowDarkness) {\n// Get vector between fragment position and light position\n    vec3 fragToLight= v_worldPosition - lightPos;\n    // Use the light to fragment vector to sample from the depth map\n    // Now get current linear depth as the length between the fragment and light position\n    float currentDepth = length(fragToLight);\n\n    #if defined(SHADOWMAP_TYPE_PCF)\n    return getCubemapShadowVisibilityByPCF(currentDepth, fragToLight, cubemapShadowMapSampler, getShadowBias(lightDir, shadowBias), farPlane, shadowDarkness);\n    #endif\n\n    float closestDepth = unpackDepth(textureCube(cubemapShadowMapSampler, fragToLight));\n\n    // It is currently in linear range between [0,1]. Re-transform back to original value\n    closestDepth *= farPlane;\n\n\n    return float(currentDepth > closestDepth + getShadowBias(lightDir, shadowBias) ? shadowDarkness : 1.0);\n}\n",body:""},ShaderChunk.noShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getShadowVisibility() {\n        return vec3(1.0);\n    }\n",body:""},ShaderChunk.totalShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"float getShadowBias(vec3 lightDir, float shadowBias);\nfloat unpackDepth(vec4 rgbaDepth);\n",funcDefine:"float getShadowBias(vec3 lightDir, float shadowBias){\n    float bias = shadowBias;\n\n    if(shadowBias == NULL){\n        bias = 0.005;\n    }\n\n\n     /*!\n     A shadow bias of 0.005 solves the issues of our scene by a large extent, but some surfaces that have a steep angle to the light source might still produce shadow acne. A more solid approach would be to change the amount of bias based on the surface angle towards the light: something we can solve with the dot product:\n     */\n\n     return max(bias * (1.0 - dot(normalize(getNormal()), lightDir)), bias);\n\n    //return bias;\n}\n\nvec3 getShadowVisibility() {\n    vec3 shadowColor = vec3(1.0);\n    vec3 twoDLightDir = vec3(0.0);\n    vec3 cubemapLightDir = vec3(0.0);\n\n\n\n    //to normalMap, the lightDir use the origin one instead of normalMap's lightDir here(the lightDir is used for computing shadowBias, the origin one is enough for it)\n\n    #if TWOD_SHADOWMAP_COUNT > 0\n\tfor( int i = 0; i < TWOD_SHADOWMAP_COUNT; i ++ ) {\n        if(isRenderListEmpty(u_isTwoDRenderListEmpty[i])){\n            continue;\n        }\n\n        twoDLightDir = getDirectionLightDirByLightPos(u_twoDLightPos[i]);\n\n\t////if is opposite to direction of light rays, no shadow\n\n        shadowColor *= getTwoDShadowVisibility(twoDLightDir, u_twoDShadowMapSampler[i], v_positionFromLight[i], u_twoDShadowBias[i], u_twoDShadowDarkness[i], u_twoDShadowSize[i]);\n\t}\n\t#endif\n\n\n\t#if CUBEMAP_SHADOWMAP_COUNT > 0\n\n\tfor( int i = 0; i < CUBEMAP_SHADOWMAP_COUNT; i ++ ) {\n        if(isRenderListEmpty(u_isCubemapRenderListEmpty[i])){\n            continue;\n        }\n\n\t////if is opposite to direction of light rays, no shadow\n\n        shadowColor *= getCubemapShadowVisibility(cubemapLightDir, u_cubemapShadowMapSampler[i], u_cubemapLightPos[i], u_farPlane[i], u_cubemapShadowBias[i], u_cubemapShadowDarkness[i]);\n\t}\n\t#endif\n\n\treturn shadowColor;\n}\n\nfloat unpackDepth(vec4 rgbaDepth) {\n    /*! make sure that the visibility from the shadow map which is not builded is always be 1.0 */\n    if(rgbaDepth == vec4(0.0)){\n        return 100000.0;\n    }\n\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n\n",
body:""},ShaderChunk.twoDShadowMap_depthMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"float handleDepthMap(vec4 rgbaDepth);\n",funcDefine:"float handleDepthMap(vec4 rgbaDepth) {\n    return rgbaDepth.r;\n}\n",body:""},ShaderChunk.twoDShadowMap_fragment={top:"",define:"",varDeclare:"varying vec4 v_positionFromLight[ TWOD_SHADOWMAP_COUNT ];\n    uniform int u_isTwoDRenderListEmpty[ TWOD_SHADOWMAP_COUNT ];\n\tuniform sampler2D u_twoDShadowMapSampler[ TWOD_SHADOWMAP_COUNT ];\n\tuniform float u_twoDShadowDarkness[ TWOD_SHADOWMAP_COUNT ];\n\tuniform float u_twoDShadowBias[ TWOD_SHADOWMAP_COUNT ];\n\tuniform vec2 u_twoDShadowSize[ TWOD_SHADOWMAP_COUNT ];\n\tuniform vec3 u_twoDLightPos[ TWOD_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"// PCF\nfloat getTwoDShadowVisibilityByPCF(float currentDepth, vec2 shadowCoord, sampler2D twoDShadowMapSampler, float shadowBias, float shadowDarkness, vec2 shadowMapSize){\n\n    float shadow = 0.0;\n    vec2 texelSize = vec2(1.0 / shadowMapSize[0], 1.0 / shadowMapSize[1]);\n\n    for(int x = -1; x <= 1; ++x)\n    {\n        for(int y = -1; y <= 1; ++y)\n        {\n            float pcfDepth = handleDepthMap(texture2D(twoDShadowMapSampler, shadowCoord + vec2(x, y) * texelSize));\n            shadow += currentDepth - shadowBias > pcfDepth  ? shadowDarkness : 1.0;\n        }\n    }\n    shadow /= 9.0;\n\n    return shadow;\n}\n\n\n\nfloat getTwoDShadowVisibility(vec3 lightDir, sampler2D twoDShadowMapSampler, vec4 v_positionFromLight, float shadowBias, float shadowDarkness, vec2 shadowSize) {\n    //project texture\n    vec3 shadowCoord = (v_positionFromLight.xyz / v_positionFromLight.w) / 2.0 + 0.5;\n    //vec3 shadowCoord = vec3(0.5, 0.5, 0.5);\n\n    #ifdef SHADOWMAP_TYPE_PCF\n    // Percentage-close filtering\n    // (9 pixel kernel)\n    return getTwoDShadowVisibilityByPCF(shadowCoord.z, shadowCoord.xy, twoDShadowMapSampler, getShadowBias(lightDir, shadowBias), shadowDarkness, shadowSize);\n\n    #else\n    return shadowCoord.z > handleDepthMap(texture2D(twoDShadowMapSampler, shadowCoord.xy)) + getShadowBias(lightDir, shadowBias) ? shadowDarkness : 1.0;\n    #endif\n}\n",body:""},ShaderChunk.twoDShadowMap_unpackDepth_fragment={top:"",define:"",varDeclare:"",funcDeclare:"float handleDepthMap(vec4 rgbaDepth);\n",funcDefine:"float handleDepthMap(vec4 rgbaDepth) {\n    return unpackDepth(rgbaDepth);\n}\n",body:""},ShaderChunk.twoDShadowMap_vertex={top:"",define:"",varDeclare:"varying vec4 v_positionFromLight[ TWOD_SHADOWMAP_COUNT ];\nuniform mat4 u_vpMatrixFromLight[ TWOD_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"",body:"for( int i = 0; i < TWOD_SHADOWMAP_COUNT; i ++ ) {\n    v_positionFromLight[i] = u_vpMatrixFromLight[i] * vec4(v_worldPosition, 1.0);\n\t}\n"},ShaderChunk.modelMatrix_hardware_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat4 mMatrix = mat4(a_mVec4_0, a_mVec4_1, a_mVec4_2, a_mVec4_3);\n"},ShaderChunk.normalMatrix_hardware_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat3 normalMatrix = mat3(a_normalVec4_0, a_normalVec4_1, a_normalVec4_2);\n"},ShaderChunk.modelMatrix_noInstance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat4 mMatrix = u_mMatrix;\n"},ShaderChunk.normalMatrix_noInstance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat3 normalMatrix = u_normalMatrix;\n"},ShaderChunk.modelMatrix_batch_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat4 mMatrix = u_mMatrix;\n"},ShaderChunk.normalMatrix_batch_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat3 normalMatrix = u_normalMatrix;\n"},ShaderChunk.basic_bitmapFont_fragment={top:"",define:"",varDeclare:"varying vec2 v_bitmapCoord;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= texture2D(u_bitmapSampler, v_bitmapCoord);\n"},ShaderChunk.common_bitmapFont_vertex={top:"",define:"",varDeclare:"varying vec2 v_bitmapCoord;\n",funcDeclare:"",funcDefine:"",body:"v_bitmapCoord = a_texCoord;\n"},ShaderChunk.grass_batch_instance_vertex={top:"",define:"",varDeclare:"uniform vec4 a_offset; // {x:x, y:y, z:z, w:rot} (blade's position & rotation)\n\tuniform vec4 a_shape; // {x:width, y:height, z:lean, w:curve} (blade's a_shape properties)\n",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.grass_common_instance_fragment={top:"",define:"",varDeclare:"//\tuniform vec3 fogColor;\n//\tuniform float fogNear;\n//\tuniform float fogFar;\n//\tuniform vec3 grassFogColor;\n//\tuniform float grassFogFar;\nvarying vec4 v_color;\nvarying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"vec4 color = v_color * texture2D(u_grassMapSampler, vec2(v_texCoord.s, v_texCoord.t));\n\n\n//\t\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n//\t\t// apply 'grass fog' first\n//\t\tfloat fogFactor = smoothstep(fogNear, grassFogFar, depth);\n//\t\tcolor.rgb = mix(color.rgb, grassFogColor, fogFactor);\n//\t\t// then apply atmosphere fog\n//\t\tfogFactor = smoothstep(fogNear, fogFar, depth);\n//\t\tcolor.rgb = mix(color.rgb, fogColor, fogFactor);\n\t\t// output\n\t\tgl_FragColor = color;\n"},ShaderChunk.grass_common_instance_vertex={top:"",define:"",varDeclare:"varying vec4 v_color;\n    varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"// Rotate by an angle\nvec2 rotate (float x, float y, float r) {\n    float c = cos(r);\n    float s = sin(r);\n    return vec2(x * c - y * s, x * s + y * c);\n}\n\n// Rotate by a vector\nvec2 rotate (float x, float y, vec2 r) {\n    return vec2(x * r.x - y * r.y, x * r.y + y * r.x);\n}\n\nvec3 _getLightDir(){\n/*!\nregard any light as direction light\n*/\n    return getDirectionLightDir(u_lightPos);\n}\n\nvec4 computeLightColor(vec3 normal, float hpct){\n/*!\nonly consider one light\n\nnot consider ambient light\n*/\n    float c = max(-dot(normal, _getLightDir()), 0.0);\n\n    c = max(c - (1.0 - hpct) * 0.75, 0.0);\n    c = 0.3 + 0.7 * c;\n\n    vec4 color = vec4(\n        c * 0.85 + cos(a_offset.x * 80.0) * 0.05,\n        c * 0.95 + sin(a_offset.z * 140.0) * 0.05,\n        c * 0.95 + sin(a_offset.x * 99.0) * 0.05,\n        1.0\n    );\n\n    color.rgb = color.rgb * u_lightColor;\n\n    return color;\n}\n\n",body:"float vi = mod(a_vertexIndex, BLADE_VERTS); // vertex index for this side of the blade\n    float di = floor(vi / 2.0);  // div index (0 .. BLADE_DIVS)\n    float hpct = di / BLADE_SEGS;  // percent of height of blade this vertex is at\n    float bside = floor(a_vertexIndex / BLADE_VERTS);  // front/back side of blade\n    float bedge = mod(vi, 2.0);  // left/right edge (x=0 or x=1)\n    // Vertex position - start with 2D a_shape, no bend applied\n    vec4 pos = vec4(\n        a_shape.x * (bedge - 0.5) * (1.0 - pow(hpct, 3.0)), // taper blade edges as approach tip\n        a_shape.y * di / BLADE_SEGS, // height of vtx, unbent\n        0.0, // flat z, unbent\n        1.0\n    );\n\n\n    // Start computing a normal for this vertex\n    vec3 normal = vec3(rotate(0.0, bside * 2.0 - 1.0, a_offset.w), 0.0);\n\n//vec3 normal = vec3(0.0);\n//\n//if(bside == 0.0){\n//normal.x = -1.0;\n//}\n//else{\n//normal.x = 1.0;\n//}\n\n    // Apply blade's natural curve amount\n    float curve = a_shape.w;\n    // Then add animated curve amount by u_time using this blade's\n    // unique properties to randomize its oscillation\n    curve += a_shape.w + 0.125 * (sin(u_time * 4.0 + a_offset.w * 0.2 * a_shape.y + a_offset.x + a_offset.z));\n    // put lean and curve together\n    float rot = a_shape.z + curve * hpct;\n    vec2 rotv = vec2(cos(rot), sin(rot));\n    pos.zy = rotate(pos.z, pos.y, rotv);\n    normal.zy = rotate(normal.z, normal.y, rotv);\n//    normal.yx = rotate(normal.y, normal.x, rotv);\n\n    // rotation of this blade as a vector\n    rotv = vec2(cos(a_offset.w), sin(a_offset.w));\n    pos.xz = rotate(pos.x, pos.z, rotv);\n    normal.xz = rotate(normal.x, normal.z, rotv);\n\n    pos.x += u_grassRangeWidth / 2.0 - a_offset.x;\n    pos.z += u_grassRangeHeight / 2.0 - a_offset.z;\n\n    pos = u_mMatrix * pos;\n\n\n    pos.y += getHeightFromHeightMap(pos.x, pos.z) * u_terrainScaleY + u_terrainPositionY;\n\n\n\n\n    //todo add wind\n    //todo pass wind direction uniform\n\n    // Compute wind effect\n//    float wind = getHeightFromHeightMap(vec2(heightMapSampleTexCoord.x - u_time / 100.0, heightMapSampleTexCoord.y - u_time / 50.0));\n\n//    wind = (clamp(wind, 0.35, 0.85) - 0.35) * 2.0;\n//    wind = wind * wind * 1.5;\n\n//    wind *= hpct; // min(hpct * a_shape.y / BLADE_HEIGHT_TALL, 1.0); // scale wind by height of blade\n//    wind = -wind;\n//    rotv = vec2(cos(wind), sin(wind));\n    // Wind blows in axis-aligned direction to make things simpler\n//    pos.zy = rotate(pos.z, pos.y, rotv);\n//    normal.yz = rotate(normal.y, normal.z, rotv);\n\n    // Sample the data texture to get altitude for this blade position\n//    float altitude = texture2D(heightMap, heightMapSampleTexCoord).r;\n//    float altclr = (clamp(altitude, 0.45, 0.75) - 0.45) * 3.3333333;\n//    vec3 grassColor = mix(grassColorLow, grassColorHigh, altclr);\n    // Vertex color must be brighter because it is multiplied with blade texture\n//    grassColor = min(vec3(grassColor.r * 1.5, grassColor.g * 1.5, grassColor.b * 0.95), 1.0);\n//    altitude *= heightMapScale.z;\n\n    v_color = computeLightColor(normal, hpct);\n//    v_color.rgb = v_color.rgb * LIGHT_COLOR * grassColor;\n\n\n    // grass texture coordinate for this vertex\n    v_texCoord = vec2(bedge, di * 2.0);\n\n    gl_Position = u_vpMatrix * pos;\n"},ShaderChunk.grass_hardware_instance_vertex={top:"",define:"",varDeclare:"attribute vec4 a_offset; // {x:x, y:y, z:z, w:rot} (blade's position & rotation)\n\tattribute vec4 a_shape; // {x:width, y:height, z:lean, w:curve} (blade's a_shape properties)\n",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.grass_map_fragment={top:"",define:"",varDeclare:"struct GrassMapData {\n    vec4 sourceRegion;\n};\nuniform GrassMapData u_grassMapDatas[3];\n\n\nvarying vec2 v_grassTexCoord;\nvarying float v_quadIndex;\n",funcDeclare:"",funcDefine:"vec4 getGrassMapColor(in sampler2D grassMapSampler, in GrassMapData grassMapDatas[3]){\n    vec4 sourceRegion;\n\n    if(v_quadIndex == 0.0){\n        sourceRegion = grassMapDatas[0].sourceRegion;\n    }\n    else if(v_quadIndex == 1.0){\n        sourceRegion = grassMapDatas[1].sourceRegion;\n    }\n    else if(v_quadIndex == 2.0){\n        sourceRegion = grassMapDatas[2].sourceRegion;\n    }\n\n    return texture2D(grassMapSampler, v_grassTexCoord * sourceRegion.zw + sourceRegion.xy);\n}\n",body:"totalColor *= getGrassMapColor(u_grassMapSampler, u_grassMapDatas);\n"},ShaderChunk.grass_map_setWorldPosition_vertex={top:"",define:"",varDeclare:"struct GrassWindData {\n    vec2 direction;\n    float time;\n    float strength;\n};\nuniform GrassWindData u_windData;\n",funcDeclare:"",funcDefine:"bool isTopPartOfGrass(){\n    return a_texCoord.y >= 0.9;\n}\n\nfloat getWindPower(){\n    float windPower = sin(u_windData.time) * u_windData.strength;\n\n    return windPower;\n}\n\nvec3 computeVertexPositionForAnimation(vec3 position, float time, vec2 windDirection){\n    vec2 windData = windDirection * getWindPower();\n    vec3 translation = vec3(windData.x, 0, windData.y);\n\n    return position + translation;\n}\n",body:"vec3 position;\n\n    if(isTopPartOfGrass()){\n        position = computeVertexPositionForAnimation(a_position, u_windData.time, u_windData.direction);\n    }\n    else{\n        position = a_position;\n    }\n\n    v_worldPosition = vec3(mMatrix * vec4(position, 1.0));\n"},ShaderChunk.grass_map_vertex={top:"",define:"",varDeclare:"varying vec2 v_grassTexCoord;\nvarying float v_quadIndex;\n",funcDeclare:"",funcDefine:"",body:"v_grassTexCoord = a_texCoord;\nv_quadIndex = a_quadIndex;\n"},ShaderChunk.terrain_layer_fragment={top:"",define:"",varDeclare:"struct LayerHeightData {\n    float minHeight;\n    float maxHeight;\n    vec4 repeatRegion;\n};\nuniform LayerHeightData u_layerHeightDatas[LAYER_COUNT];\n//sampler2D can't be contained in struct\nuniform sampler2D u_layerSampler2Ds[LAYER_COUNT];\n\n\nvarying vec2 v_layerTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getLayerMapColor(in sampler2D layerSampler2Ds[LAYER_COUNT], in LayerHeightData layerHeightDatas[LAYER_COUNT]){\n    vec4 color = vec4(0.0);\n    bool isInLayer = false;\n\n    float height = v_worldPosition.y;\n\n    for(int i = 0; i < LAYER_COUNT; i++){\n        if(height >= layerHeightDatas[i].minHeight && height < layerHeightDatas[i].maxHeight){\n            vec4 repeatRegion = layerHeightDatas[i].repeatRegion;\n\n            //todo blend color\n            //todo optimize:move 'v_layerTexCoord * repeatRegion.zw + repeatRegion.xy' to vertex shader?\n            color += texture2D(layerSampler2Ds[i], v_layerTexCoord * repeatRegion.zw + repeatRegion.xy);\n\n            isInLayer = true;\n\n            break;\n        }\n    }\n\n    return isInLayer ? color : vec4(1.0);\n}\n",body:"\ntotalColor *= getLayerMapColor(u_layerSampler2Ds, u_layerHeightDatas);\n"},ShaderChunk.terrain_layer_vertex={top:"",define:"",varDeclare:"varying vec2 v_layerTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_layerTexCoord = a_texCoord;\n"},ShaderChunk.terrain_mix_bump_cotangentFrame_fallback={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"mat3 cotangentFrame(vec3 normal,vec3 p,vec2 uv)\n{\n    //todo how to implement dFdx,dFdy?\n    vec3 dp1=p;\n    vec3 dp2=p;\n    vec2 duv1=uv;\n    vec2 duv2=uv;\n    vec3 dp2perp=cross(dp2,normal);\n    vec3 dp1perp=cross(normal,dp1);\n    vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;\n    vec3 binormal=dp2perp*duv1.y+dp1perp*duv2.y;\n\n    float invmax=inversesqrt(max(dot(tangent,tangent),dot(binormal,binormal)));\n    return mat3(tangent*invmax,binormal*invmax,normal);\n}\n",body:""},ShaderChunk.terrain_mix_bump_cotangentFrame_standardDerivatives={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"mat3 cotangentFrame(vec3 normal,vec3 p,vec2 uv)\n{\n    vec3 dp1=dFdx(p);\n    vec3 dp2=dFdy(p);\n    vec2 duv1=dFdx(uv);\n    vec2 duv2=dFdy(uv);\n    vec3 dp2perp=cross(dp2,normal);\n    vec3 dp1perp=cross(normal,dp1);\n    vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;\n    vec3 binormal=dp2perp*duv1.y+dp1perp*duv2.y;\n\n    float invmax=inversesqrt(max(dot(tangent,tangent),dot(binormal,binormal)));\n    return mat3(tangent*invmax,binormal*invmax,normal);\n}\n",body:""},ShaderChunk.terrain_mix_bump_fragment={top:"",define:"",varDeclare:"",funcDeclare:"vec3 getNormal();\n",funcDefine:"vec3 getNormal(){\n    vec3 viewDir = getViewDir();\n    vec3 mixColor = baseColor.rgb;\n\n    vec3 bump1Color=texture2D(u_bumpMap1Sampler,v_diffuseMap1TexCoord).xyz;\n    vec3 bump2Color=texture2D(u_bumpMap2Sampler,v_diffuseMap2TexCoord).xyz;\n    vec3 bump3Color=texture2D(u_bumpMap3Sampler,v_diffuseMap3TexCoord).xyz;\n    bump1Color.rgb*=mixColor.r;\n    bump2Color.rgb=mix(bump1Color.rgb,bump2Color.rgb,mixColor.g);\n    vec3 map=mix(bump2Color.rgb,bump3Color.rgb,mixColor.b);\n    map=map*255./127.-128./127.;\n\n    mat3 TBN=cotangentFrame(v_normal,-viewDir,v_mixMapTexCoord);\n\n    return normalize(TBN*map);\n}\n",body:""},ShaderChunk.terrain_mix_bump_vertex={top:"",define:"",varDeclare:"//varying vec3 v_normal;\n//\n//",funcDeclare:"",funcDefine:"",body:"//    v_normal = normalize(normalMatrix * a_normal);\n//"},ShaderChunk.terrain_mix_common_fragment={top:"",define:"",varDeclare:"vec4 baseColor;\n",funcDeclare:"",funcDefine:"",body:"baseColor = texture2D(u_mixMapSampler,v_mixMapTexCoord);\n"},ShaderChunk.terrain_mix_fragment={top:"",define:"",varDeclare:"varying vec2 v_mixMapTexCoord;\nvarying vec2 v_diffuseMap1TexCoord;\nvarying vec2 v_diffuseMap2TexCoord;\nvarying vec2 v_diffuseMap3TexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMixMapColor(){\n    vec4 diffuse1Color=texture2D(u_diffuseMap1Sampler,v_diffuseMap1TexCoord);\n    vec4 diffuse2Color=texture2D(u_diffuseMap2Sampler,v_diffuseMap2TexCoord);\n    vec4 diffuse3Color=texture2D(u_diffuseMap3Sampler,v_diffuseMap3TexCoord);\n\n    diffuse1Color.rgb*=baseColor.r;\n    diffuse2Color.rgb=mix(diffuse1Color.rgb,diffuse2Color.rgb,baseColor.g);\n    baseColor.rgb=mix(diffuse2Color.rgb,diffuse3Color.rgb,baseColor.b);\n\n    return baseColor;\n}\n",body:"totalColor *= getMixMapColor();\n"},ShaderChunk.terrain_mix_vertex={top:"",define:"",varDeclare:"varying vec2 v_mixMapTexCoord;\nvarying vec2 v_diffuseMap1TexCoord;\nvarying vec2 v_diffuseMap2TexCoord;\nvarying vec2 v_diffuseMap3TexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_mixMapTexCoord = a_texCoord;\n\nv_diffuseMap1TexCoord = a_texCoord * u_diffuseMap1RepeatRegion.zw + u_diffuseMap1RepeatRegion.xy;\n\n\nv_diffuseMap2TexCoord = a_texCoord * u_diffuseMap2RepeatRegion.zw + u_diffuseMap2RepeatRegion.xy;\n\n\nv_diffuseMap3TexCoord = a_texCoord * u_diffuseMap3RepeatRegion.zw + u_diffuseMap3RepeatRegion.xy;\n"},ShaderChunk.multiPages_bitmapFont_fragment={top:"",define:"",varDeclare:"uniform sampler2D u_pageSampler2Ds[PAGE_COUNT];\nvarying vec2 v_bitmapCoord;\nvarying float v_page;\n",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.multiPages_bitmapFont_vertex={top:"",define:"",varDeclare:"varying float v_page;\n",funcDeclare:"",funcDefine:"",body:"v_page = a_page;\n"},ShaderChunk.sdf_bitmapFont_smoothStep_fallback={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float sdfSmoothStep(float value) {\n    /*! gl_FragCoord.w is wrong, need fix! */\n    float afwidth = (1.0 / 32.0) * (1.4142135623730951 / (2.0 * gl_FragCoord.w));\n    return smoothstep(0.5 - afwidth, 0.5 + afwidth, value);\n}\n",body:""},ShaderChunk.sdf_bitmapFont_smoothStep_standardDerivatives={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float sdfSmoothStep(float value) {\n      float afwidth = length(vec2(dFdx(value), dFdy(value))) * 0.70710678118654757;\n    return smoothstep(0.5 - afwidth, 0.5 + afwidth, value);\n}\n",body:""},ShaderChunk.sdf_bitmapFont_smooth_fragment={top:"",define:"",varDeclare:"varying vec2 v_bitmapCoord;\n",funcDeclare:"",funcDefine:"",body:"gl_FragColor.a *= sdfSmoothStep(texture2D(u_bitmapSampler, v_bitmapCoord).a);\n"},ShaderChunk.common_heightMap={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float _getHeightFromHeightMap(vec2 heightMapSampleTexCoord){\nheightMapSampleTexCoord.x /= u_terrainSubdivisions;\nheightMapSampleTexCoord.y =  1.0 - heightMapSampleTexCoord.y / u_terrainSubdivisions;\n\n    vec4 data = texture2D(u_heightMapSampler, heightMapSampleTexCoord);\n    /*!\n     compute gradient from rgb heightMap->r,g,b components\n     */\n    float r = data.r,\n    g = data.g,\n    b = data.b,\n    gradient = r * 0.3 + g * 0.59 + b * 0.11;\n\n    return u_terrainMinHeight + (u_terrainMaxHeight - u_terrainMinHeight) * gradient;\n}\n\n\nfloat _getBilinearInterpolatedHeight(vec2 offset, float heightMinXMinZ, float heightMaxXMinZ, float heightMaxXMaxZ, float heightMinXMaxZ){\n    return (heightMinXMinZ * (1.0 - offset.x) + heightMaxXMinZ * offset.x) * (1.0 - offset.y) + (heightMaxXMaxZ * offset.x + heightMinXMaxZ * (1.0 - offset.x)) * offset.y;\n}\n\n\nfloat getHeightFromHeightMap(float x, float z){\n    x += u_terrainRangeWidth / 2.0;\n    z += u_terrainRangeHeight / 2.0;\n\n    if(x > u_terrainRangeWidth || z > u_terrainRangeHeight || x < 0.0 || z < 0.0){\n        return 0.0;\n    }\n\n\n\n/*!\n1.get grid subdivisions row,col\n2.get grid height\n3.get bilinear interpolated height\n*/\n\n\n\n    float sx = x / u_terrainRangeWidth * u_terrainSubdivisions,\n        sz = z / u_terrainRangeHeight * u_terrainSubdivisions;\n\n    float sFloorX = floor(sx),\n        sFloorZ = floor(sz);\n\n    float sMinX,\n    sMaxX,\n    sMinZ,\n    sMaxZ;\n\n    if(sFloorX < u_terrainSubdivisions){\n        sMinX = sFloorX;\n        sMaxX = sFloorX + 1.0;\n    }\n    else{\n        sMinX = sFloorX - 1.0;\n        sMaxX = sFloorX;\n    }\n\n    if(sFloorZ < u_terrainSubdivisions){\n        sMinZ = sFloorZ;\n        sMaxZ = sFloorZ + 1.0;\n    }\n    else{\n        sMinZ = sFloorZ - 1.0;\n        sMaxZ = sFloorZ;\n    }\n\n    vec2 quadSubdivisionsCoordinateArr[5];\n\n    quadSubdivisionsCoordinateArr[0] = vec2(sMinX, sMinZ);\n    quadSubdivisionsCoordinateArr[1] = vec2(sMaxX, sMinZ);\n    quadSubdivisionsCoordinateArr[2] = vec2(sMaxX, sMaxZ);\n    quadSubdivisionsCoordinateArr[3] = vec2(sMinX, sMaxZ);\n\n    quadSubdivisionsCoordinateArr[4] = vec2(sx - sMinX, sz - sMinZ);\n\n\n    float heightMinXMinZ = _getHeightFromHeightMap(quadSubdivisionsCoordinateArr[0]);\n    float heightMaxXMinZ = _getHeightFromHeightMap(quadSubdivisionsCoordinateArr[1]);\n    float heightMaxXMaxZ = _getHeightFromHeightMap(quadSubdivisionsCoordinateArr[2]);\n    float heightMinXMaxZ = _getHeightFromHeightMap(quadSubdivisionsCoordinateArr[3]);\n\n    return _getBilinearInterpolatedHeight(quadSubdivisionsCoordinateArr[4], heightMinXMinZ, heightMaxXMinZ, heightMaxXMaxZ, heightMinXMaxZ);\n}\n",body:""},ShaderChunk.common_light={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getDirectionLightDir(vec3 lightPos){\n    return normalize(lightPos - vec3(0.0));\n}\n",body:""},ShaderChunk.mirror_fragment={top:"",define:"",varDeclare:"varying vec4 v_reflectionMapCoord;\n",funcDeclare:"",funcDefine:"//todo add more blend way to mix reflectionMap color and textureColor\n\t\tfloat blendOverlay(float base, float blend) {\n\t\t\treturn( base < 0.5 ? ( 2.0 * base * blend ) : (1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n\t\t}\n\t\tvec4 getReflectionMapColor(in vec4 materialColor){\n\t\t\tvec4 color = texture2DProj(u_reflectionMapSampler, v_reflectionMapCoord);\n\n\t\t\tcolor = vec4(blendOverlay(materialColor.r, color.r), blendOverlay(materialColor.g, color.g), blendOverlay(materialColor.b, color.b), 1.0);\n\n\t\t\treturn color;\n\t\t}\n",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= getReflectionMapColor(totalColor);\n}\n"},ShaderChunk.mirror_vertex={top:"",define:"",varDeclare:"varying vec4 v_reflectionMapCoord;\n",funcDeclare:"",funcDefine:"",body:"mat4 textureMatrix = mat4(\n                        0.5, 0.0, 0.0, 0.0,\n                        0.0, 0.5, 0.0, 0.0,\n                        0.0, 0.0, 0.5, 0.0,\n                        0.5, 0.5, 0.5, 1.0\n);\n\nv_reflectionMapCoord = textureMatrix * gl_Position;\n"},ShaderChunk.water_bump_fragment={top:"",define:"",varDeclare:"varying vec2 v_bumpTexCoord;\n",funcDeclare:"",funcDefine:"",body:"// fetch bump texture, unpack from [0..1] to [-1..1]\n\tvec3 bumpNormal = 2.0 * texture2D(u_bumpMapSampler, v_bumpTexCoord).rgb - 1.0;\n\tvec2 perturbation = u_waveData.height * bumpNormal.rg;\n"},ShaderChunk.water_bump_vertex={top:"",define:"",varDeclare:"struct WaveData {\n    float length;\n    float height;\n};\nuniform WaveData u_waveData;\nvarying vec2 v_bumpTexCoord;\n",funcDeclare:"",funcDefine:"",body:"vec2 bumpTexCoord = vec2(u_windMatrix * vec4(a_texCoord, 0.0, 1.0));\n\tv_bumpTexCoord = bumpTexCoord / u_waveData.length;\n"},ShaderChunk.water_fragment={top:"",define:"",varDeclare:"struct WaveData {\n    float length;\n    float height;\n};\nuniform WaveData u_waveData;\nstruct LevelData {\n    float fresnelLevel;\n    float reflectionLevel;\n    float refractionLevel;\n};\nuniform LevelData u_levelData;\n\nvarying vec4 v_reflectionAndRefractionMapCoord;\n",funcDeclare:"",funcDefine:"",body:"vec2 projectedTexCoords = v_reflectionAndRefractionMapCoord.xy / v_reflectionAndRefractionMapCoord.w + perturbation;\n\n\n\n\n//totalColor = vec4(1.0 - fresnelTerm);\n//totalColor *= vec4(refractionColor, 1.0);\n//totalColor *= vec4(mix(reflectionColor, refractionColor, fresnelTerm), 1.0);\n//totalColor += vec4(reflectionColor * fresnelTerm * u_levelData.reflectionLevel + (1.0 - fresnelTerm) * refractionColor * u_levelData.refractionLevel, 1.0);\n\n//totalColor += vec4(reflectionColor * fresnelTerm * u_levelData.reflectionLevel + (1.0 - fresnelTerm) * refractionColor * u_levelData.refractionLevel, 1.0);\n\ntotalColor += vec4(getLightEffectColor(projectedTexCoords), 1.0);\n\n\n//totalColor *= vec4(mix(reflectionColor, refractionColor, 0.5), 1.0);\n"},ShaderChunk.water_fresnel_fragment={top:"",define:"",varDeclare:"varying vec3 v_position;\n",funcDeclare:"",funcDefine:"vec3 getLightEffectColor(vec2 projectedTexCoords){\n\tvec3 reflectionColor;\n\tvec3 refractionColor;\n\n    vec3 inDir = normalize(v_position - u_cameraPos);\n\n\tfloat fresnelTerm = max(dot(inDir, v_normal), 0.0);\n\tfresnelTerm = clamp((1.0 - fresnelTerm) * u_levelData.fresnelLevel, 0., 1.);\n\n    if(!isRenderListEmpty(u_isReflectionRenderListEmpty)){\n        reflectionColor = texture2D(u_reflectionMapSampler, projectedTexCoords).rgb;\n        reflectionColor = reflectionColor * fresnelTerm * u_levelData.reflectionLevel;\n\t}\n\telse{\n        reflectionColor = vec3(0.0);\n\t}\n\n    if(!isRenderListEmpty(u_isRefractionRenderListEmpty)){\n        refractionColor = texture2D(u_refractionMapSampler, projectedTexCoords).rgb;\n        refractionColor = (1.0 - fresnelTerm) * refractionColor * u_levelData.refractionLevel;\n\t}\n\telse{\n        refractionColor = vec3(0.0);\n\t}\n\n\treturn reflectionColor + refractionColor;\n}\n",body:""},ShaderChunk.water_fresnel_vertex={top:"",define:"",varDeclare:"varying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"v_position = a_position;\n"},ShaderChunk.water_noBump_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec2 perturbation = vec2(0.0);\n"},ShaderChunk.water_noLightEffect_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getLightEffectColor(vec2 projectedTexCoords){\n    return vec3(0.0);\n}\n",body:""},ShaderChunk.water_reflection_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getLightEffectColor(vec2 projectedTexCoords){\n    if(!isRenderListEmpty(u_isReflectionRenderListEmpty)){\n        return texture2D(u_reflectionMapSampler, projectedTexCoords).rgb * u_levelData.reflectionLevel;\n    }\n    return vec3(0.0);\n}\n",body:""},ShaderChunk.water_refraction_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getLightEffectColor(vec2 projectedTexCoords){\n    if(!isRenderListEmpty(u_isRefractionRenderListEmpty)){\n        return texture2D(u_refractionMapSampler, projectedTexCoords).rgb * u_levelData.refractionLevel;\n    }\n    return vec3(0.0);\n}\n",body:""},ShaderChunk.water_vertex={top:"",define:"",varDeclare:"varying vec4 v_reflectionAndRefractionMapCoord;\n",funcDeclare:"",funcDefine:"",body:"mat4 textureMatrix = mat4(\n                        0.5, 0.0, 0.0, 0.0,\n                        0.0, 0.5, 0.0, 0.0,\n                        0.0, 0.0, 0.5, 0.0,\n                        0.5, 0.5, 0.5, 1.0\n);\n\nv_reflectionAndRefractionMapCoord = textureMatrix * gl_Position;\n"},ShaderChunk.brick_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"float brickW = 1.0 / u_tilesWidthNumber;\n\tfloat brickH = 1.0 / u_tilesWidthNumber;\n\tfloat jointWPercentage = 0.01;\n\tfloat jointHPercentage = 0.05;\n\tvec3 color = u_brickColor;\n\tfloat yi = v_texCoord.y / brickH;\n\tfloat nyi = round(yi);\n\tfloat xi = v_texCoord.x / brickW;\n\n\tif (mod(floor(yi), 2.0) == 0.0){\n\t\txi = xi - 0.5;\n\t}\n\n\tfloat nxi = round(xi);\n\tvec2 brickv_texCoord = vec2((xi - floor(xi)) / brickH, (yi - floor(yi)) /  brickW);\n\n\tif (yi < nyi + jointHPercentage && yi > nyi - jointHPercentage){\n\t\tcolor = mix(u_jointColor, vec3(0.37, 0.25, 0.25), (yi - nyi) / jointHPercentage + 0.2);\n\t}\n\telse if (xi < nxi + jointWPercentage && xi > nxi - jointWPercentage){\n\t\tcolor = mix(u_jointColor, vec3(0.44, 0.44, 0.44), (xi - nxi) / jointWPercentage + 0.2);\n\t}\n\telse {\n\t\tfloat u_brickColorSwitch = mod(floor(yi) + floor(xi), 3.0);\n\n\t\tif (u_brickColorSwitch == 0.0)\n\t\t\tcolor = mix(color, vec3(0.33, 0.33, 0.33), 0.3);\n\t\telse if (u_brickColorSwitch == 2.0)\n\t\t\tcolor = mix(color, vec3(0.11, 0.11, 0.11), 0.3);\n\t}\n\n\tgl_FragColor = vec4(color, 1.0);\n"},ShaderChunk.cloud_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"gl_FragColor = mix(u_skyColor, u_cloudColor, fbm(v_texCoord * 12.0));\n"},ShaderChunk.common_proceduralTexture_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float rand(vec2 n) {\n\treturn fract(cos(dot(n, vec2(12.9898, 4.1414))) * 43758.5453);\n}\nfloat noise(vec2 n) {\n\tconst vec2 d = vec2(0.0, 1.0);\n\tvec2 b = floor(n), f = smoothstep(vec2(0.0), vec2(1.0), fract(n));\n\treturn mix(mix(rand(b), rand(b + d.yx), f.x), mix(rand(b + d.xy), rand(b + d.yy), f.x), f.y);\n}\n\nfloat turbulence(vec2 P)\n{\n\tfloat val = 0.0;\n\tfloat freq = 1.0;\n\tfor (int i = 0; i < 4; i++)\n\t{\n\t\tval += abs(noise(P*freq) / freq);\n\t\tfreq *= 2.07;\n\t}\n\treturn val;\n}\n\nfloat fbm(vec2 n) {\n\tfloat total = 0.0, amplitude = 1.0;\n\tfor (int i = 0; i < 4; i++) {\n\t\ttotal += noise(n) * amplitude;\n\t\tn += n;\n\t\tamplitude *= 0.5;\n\t}\n\treturn total;\n}\n\nfloat round(float number){\n\treturn sign(number)*floor(abs(number) + 0.5);\n}\n",body:""},ShaderChunk.common_proceduralTexture_vertex={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nconst vec2 MADD=vec2(0.5,0.5);\n",funcDeclare:"",funcDefine:"",body:"v_texCoord=a_positionVec2*MADD+MADD;\n\n    gl_Position=vec4(a_positionVec2, 0.0 ,1.0);\n"},ShaderChunk.fire_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nstruct FireColor {\n    vec3 c1;\n    vec3 c2;\n    vec3 c3;\n    vec3 c4;\n    vec3 c5;\n    vec3 c6;\n};\nuniform FireColor u_fireColor;\n",funcDeclare:"",funcDefine:"",body:"vec2 p = v_texCoord * 8.0;\n\tfloat q = fbm(p - u_time * 0.1);\n\tvec2 r = vec2(fbm(p + q + u_time * u_speed.x - p.x - p.y), fbm(p + q - u_time * u_speed.y));\n\tvec3 c = mix(u_fireColor.c1, u_fireColor.c2, fbm(p + r)) + mix(u_fireColor.c3, u_fireColor.c4, r.x) - mix(u_fireColor.c5, u_fireColor.c6, r.y);\n\tvec3 color = c * cos(u_shift * v_texCoord.y);\n\tfloat luminance = dot(color.rgb, vec3(0.3, 0.59, 0.11));\n\n\tgl_FragColor = vec4(color, luminance * u_alphaThreshold + (1.0 - u_alphaThreshold));\n"},ShaderChunk.grass_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"vec3 color = mix(u_groundColor, u_herb1Color, rand(gl_FragCoord.xy * 4.0));\n\tcolor = mix(color, u_herb2Color, rand(gl_FragCoord.xy * 8.0));\n\tcolor = mix(color, u_herb3Color, rand(gl_FragCoord.xy));\n\tcolor = mix(color, u_herb1Color, fbm(gl_FragCoord.xy * 16.0));\n\n\tgl_FragColor = vec4(color, 1.0);\n"},ShaderChunk.marble_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nconst vec3 TILE_SIZE = vec3(1.1, 1.0, 1.1);\n//const vec3 TILE_PCT = vec3(0.98, 1.0, 0.98);\n",funcDeclare:"",funcDefine:"vec3 marble_color(float x)\n{\n\tvec3 col;\n\tx = 0.5*(x + 1.);\n\tx = sqrt(x);\n\tx = sqrt(x);\n\tx = sqrt(x);\n\tcol = vec3(.2 + .75*x);\n\tcol.b *= 0.95;\n\treturn col;\n}\n",body:"vec3 color;\n\tfloat brickW = 1.0 / u_tilesHeightNumber;\n\tfloat brickH = 1.0 / u_tilesWidthNumber;\n\tfloat jointWPercentage = 0.01;\n\tfloat jointHPercentage = 0.01;\n\tfloat yi = v_texCoord.y / brickH;\n\tfloat nyi = round(yi);\n\tfloat xi = v_texCoord.x / brickW;\n\n\tif (mod(floor(yi), 2.0) == 0.0){\n\t\txi = xi - 0.5;\n\t}\n\n\tfloat nxi = round(xi);\n\tvec2 brickv_texCoord = vec2((xi - floor(xi)) / brickH, (yi - floor(yi)) / brickW);\n\n\tif (yi < nyi + jointHPercentage && yi > nyi - jointHPercentage){\n\t\tcolor = mix(u_jointColor, vec3(0.37, 0.25, 0.25), (yi - nyi) / jointHPercentage + 0.2);\n\t}\n\telse if (xi < nxi + jointWPercentage && xi > nxi - jointWPercentage){\n\t\tcolor = mix(u_jointColor, vec3(0.44, 0.44, 0.44), (xi - nxi) / jointWPercentage + 0.2);\n\t}\n\telse {\n\t\tfloat t = 6.28 * brickv_texCoord.x / (TILE_SIZE.x + noise(vec2(v_texCoord)*6.0));\n\t\tt += u_amplitude * turbulence(brickv_texCoord.xy);\n\t\tt = sin(t);\n\t\tcolor = marble_color(t);\n\t}\n\n\tgl_FragColor = vec4(color, 1.0);\n"
},ShaderChunk.road_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"float ratioy = mod(gl_FragCoord.y * 100.0 , fbm(v_texCoord * 2.0));\n\tvec3 color = u_roadColor * ratioy;\n\n\tgl_FragColor = vec4(color, 1.0);\n"},ShaderChunk.wood_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"float ratioy = mod(v_texCoord.x * u_ampScale, 2.0 + fbm(v_texCoord * 0.8));\n\tvec3 wood = u_woodColor * ratioy;\n\n\tgl_FragColor = vec4(wood, 1.0);\n"},ShaderChunk}();e.ShaderChunk=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ShaderSnippet(){}return ShaderSnippet.main_begin="void main(void){\n",ShaderSnippet.main_end="}\n",ShaderSnippet.setPos_mvp="gl_Position = u_pMatrix * u_vMatrix * mMatrix * vec4(a_position, 1.0);\n",ShaderSnippet}();e.ShaderSnippet=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Material(){this._blendType=null,this._blendSrc=e.EBlendFunc.ONE,this._blendDst=e.EBlendFunc.ZERO,this._blendEquation=e.EBlendEquation.ADD,this._alphaToCoverage=!1,this._color=e.Color.create("#ffffff"),this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this.polygonOffsetMode=e.EPolygonOffsetMode.NONE,this.side=e.ESide.FRONT,this.blend=!1,this.blendFuncSeparate=null,this.blendEquationSeparate=[e.EBlendEquation.ADD,e.EBlendEquation.ADD],this.shading=e.EShading.FLAT,this.geometry=null,this._shaderManager=e.ShaderManager.create(this)}return Object.defineProperty(Material.prototype,"program",{get:function(){return this.shader.program},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"blendType",{get:function(){return this._blendType},set:function(t){if(null!==t){switch(t){case e.EBlendType.NONE:this.blend=!1,this.blendSrc=e.EBlendFunc.ONE,this.blendDst=e.EBlendFunc.ZERO,this.blendEquation=e.EBlendEquation.ADD;break;case e.EBlendType.NORMAL:this.blend=!0,this.blendSrc=e.EBlendFunc.SRC_ALPHA,this.blendDst=e.EBlendFunc.ONE_MINUS_SRC_ALPHA,this.blendEquation=e.EBlendEquation.ADD;break;case e.EBlendType.PREMULTIPLIED:this.blend=!0,this.blendSrc=e.EBlendFunc.ONE,this.blendDst=e.EBlendFunc.ONE_MINUS_SRC_ALPHA,this.blendEquation=e.EBlendEquation.ADD;break;case e.EBlendType.ADDITIVE:this.blend=!0,this.blendSrc=e.EBlendFunc.ONE,this.blendDst=e.EBlendFunc.ONE,this.blendEquation=e.EBlendEquation.ADD;break;case e.EBlendType.ADDITIVEALPHA:this.blend=!0,this.blendSrc=e.EBlendFunc.SRC_ALPHA,this.blendDst=e.EBlendFunc.ONE,this.blendEquation=e.EBlendEquation.ADD;break;case e.EBlendType.MULTIPLICATIVE:this.blend=!0,this.blendSrc=e.EBlendFunc.DST_COLOR,this.blendDst=e.EBlendFunc.ZERO,this.blendEquation=e.EBlendEquation.ADD;break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("blendType"))}this._blendType=t}},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"envMap",{get:function(){return this.mapManager.getEnvMap()},set:function(e){this.mapManager.setEnvMap(e)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"blendSrc",{get:function(){return this._blendSrc},set:function(e){this._blendSrc!==e&&(this._blendSrc=e,this.blendFuncSeparate=null)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"blendDst",{get:function(){return this._blendDst},set:function(e){this._blendDst!==e&&(this._blendDst=e,this.blendFuncSeparate=null)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"blendEquation",{get:function(){return this._blendEquation},set:function(e){this._blendEquation!==e&&(this._blendEquation=e,this.blendEquationSeparate=null)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"alphaToCoverage",{get:function(){return this._alphaToCoverage},set:function(e){this._alphaToCoverage=e},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"color",{get:function(){return this._color},set:function(t){this._color.isEqual(t)||(this.geometry&&this.geometry.entityObject&&e.EventManager.trigger(this.geometry.entityObject,e.CustomEvent.create(e.EEngineEvent.MATERIAL_COLOR_CHANGE)),this._color=t)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"mapManager",{get:function(){return this._shaderManager.mapManager},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"shader",{get:function(){return this._shaderManager.shader},enumerable:!0,configurable:!0}),Material.prototype.clone=function(){return e.CloneUtils.clone(this)},Material.prototype.initWhenCreate=function(){this._shaderManager.setShader(this.createShader())},Material.prototype.init=function(){this._shaderManager.init()},Material.prototype.dispose=function(){this._shaderManager.dispose()},Material.prototype.updateShader=function(e){this._shaderManager.update(e)},Material.prototype.addShader=function(e,t){this._shaderManager.addShader(e,t)},Material.prototype.hasShader=function(e){return this._shaderManager.hasShader(e)},Material.prototype.getShader=function(e){return this._shaderManager.getShader(e)},Material.prototype.hasMap=function(e){return this.mapManager.hasMap(e)},__decorate([e.cloneAttributeAsBasicType({order:1})],Material.prototype,"blendType",null),__decorate([e.cloneAttributeAsCloneable()],Material.prototype,"envMap",null),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"blendSrc",null),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"blendDst",null),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"blendEquation",null),__decorate([e.cloneAttributeAsBasicType(),e.ensureGetter(function(t){e.it("if enable alphaToCoverage, multiSample should be enabled",function(){t&&e.expect(e.DeviceManager.getInstance().contextConfig.options.antialias).true})})],Material.prototype,"alphaToCoverage",null),__decorate([e.cloneAttributeAsCloneable()],Material.prototype,"color",null),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"redWrite",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"greenWrite",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"blueWrite",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"alphaWrite",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"polygonOffsetMode",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"side",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"blend",void 0),__decorate([e.cloneAttributeAsBasicType({order:-1})],Material.prototype,"blendFuncSeparate",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"blendEquationSeparate",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"shading",void 0),__decorate([e.cloneAttributeAsBasicType()],Material.prototype,"geometry",void 0),Material}();e.Material=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function EngineMaterial(){t.apply(this,arguments),this.refractionRatio=0,this.reflectivity=null,this.mapCombineMode=e.ETextureCombineMode.MIX,this.mapMixRatio=.5}return __extends(EngineMaterial,t),EngineMaterial.prototype.init=function(){this._addTopShaderLib(),this.addShaderLib(),this._addEndShaderLib(),t.prototype.init.call(this)},EngineMaterial.prototype.addShaderLib=function(){},EngineMaterial.prototype.addNormalShaderLib=function(){e.GlobalGeometryUtils.hasAnimation(this.geometry)&&!this.shader.hasLib(e.NormalMorphShaderLib)?this._addShaderLibToTop(e.NormalMorphShaderLib.create()):this.shader.hasLib(e.NormalCommonShaderLib)||this._addShaderLibToTop(e.NormalCommonShaderLib.create())},EngineMaterial.prototype.createShader=function(){return e.CommonShader.create()},EngineMaterial.prototype._addTopShaderLib=function(){this.shader.addLib(e.CommonShaderLib.create()),e.InstanceUtils.addModelMatrixShaderLib(this.shader,this.geometry.entityObject),e.GlobalGeometryUtils.hasAnimation(this.geometry)?(this.shader.addLib(e.CommonMorphShaderLib.create()),this.shader.addLib(e.VerticeMorphShaderLib.create())):this.shader.addLib(e.VerticeCommonShaderLib.create())},EngineMaterial.prototype._addShaderLibToTop=function(e){this.shader.addShaderLibToTop(e)},EngineMaterial.prototype._addEndShaderLib=function(){this.shader.addLib(e.EndShaderLib.create())},__decorate([e.cloneAttributeAsBasicType()],EngineMaterial.prototype,"refractionRatio",void 0),__decorate([e.cloneAttributeAsBasicType()],EngineMaterial.prototype,"reflectivity",void 0),__decorate([e.cloneAttributeAsBasicType()],EngineMaterial.prototype,"mapCombineMode",void 0),__decorate([e.cloneAttributeAsBasicType()],EngineMaterial.prototype,"mapMixRatio",void 0),__decorate([e.virtual],EngineMaterial.prototype,"addShaderLib",null),EngineMaterial}(e.Material);e.EngineMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function StandardLightMaterial(){t.apply(this,arguments),this._lightMap=null,this._diffuseMap=null,this._specularMap=null,this._emissionMap=null,this._normalMap=null,this._shininess=32,this.opacity=1,this.lightModel=e.ELightModel.PHONG,this.specularColor=e.Color.create("#ffffff"),this.emissionColor=e.Color.create("rgba(0,0,0,0)"),this.lightMapIntensity=1}return __extends(StandardLightMaterial,t),Object.defineProperty(StandardLightMaterial.prototype,"lightMap",{get:function(){return this._lightMap},set:function(e){this._lightMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"diffuseMap",{get:function(){return this._diffuseMap},set:function(e){this._diffuseMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"specularMap",{get:function(){return this._specularMap},set:function(e){this._specularMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"emissionMap",{get:function(){return this._emissionMap},set:function(e){this._emissionMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"normalMap",{get:function(){return this._normalMap},set:function(e){this._normalMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"shininess",{get:function(){return Number(this._shininess)<=0?32:this._shininess},set:function(e){this._shininess=e},enumerable:!0,configurable:!0}),StandardLightMaterial.prototype.init=function(){this._addMap(),t.prototype.init.call(this)},StandardLightMaterial.prototype.addTopExtendShaderLib=function(){},StandardLightMaterial.prototype.addExtendShaderLib=function(){},StandardLightMaterial.prototype.addEndShaderLib=function(){},StandardLightMaterial.prototype.addNormalRelatedShaderLib=function(){this._normalMap?this.shader.addLib(e.NormalMapShaderLib.create()):this.shader.addLib(e.NoNormalMapShaderLib.create())},StandardLightMaterial.prototype.addLightSetWorldPositionShaderLib=function(){this.shader.addLib(e.LightSetWorldPositionShaderLib.create())},StandardLightMaterial.prototype.addShaderLib=function(){var t=null;this.addTopExtendShaderLib(),e.InstanceUtils.addNormalModelMatrixShaderLib(this.shader,this.geometry.entityObject),this.addNormalShaderLib(),this.shader.addLib(e.LightCommonShaderLib.create()),this.addLightSetWorldPositionShaderLib(),this._setLightMapShaderLib(),this.shader.addLib(e.LightShaderLib.create()),t=this.envMap,t&&this._setEnvMapShaderLib(t),this.addExtendShaderLib(),this.shader.addLib(e.LightEndShaderLib.create()),this.addEndShaderLib()},StandardLightMaterial.prototype._setLightMapShaderLib=function(){var t=e.Director.getInstance().scene;if(this.shader.addLib(e.CommonLightMapShaderLib.create()),this._lightMap?this.shader.addLib(e.LightMapShaderLib.create()):this.shader.addLib(e.NoLightMapShaderLib.create()),this._diffuseMap?this.shader.addLib(e.DiffuseMapShaderLib.create()):this.shader.addLib(e.NoDiffuseMapShaderLib.create()),this._specularMap?this.shader.addLib(e.SpecularMapShaderLib.create()):this.shader.addLib(e.NoSpecularMapShaderLib.create()),this._emissionMap?this.shader.addLib(e.EmissionMapShaderLib.create()):this.shader.addLib(e.NoEmissionMapShaderLib.create()),this.addNormalRelatedShaderLib(),t.shadowMap.enable){var r=!1,n=!1;this._hasTwoDShadowMap()&&(r=!0,this.shader.addLib(e.TwoDShadowMapShaderLib.create())),this._hasCubemapShadowMap()&&(n=!0,this.shader.addLib(e.CubemapShadowMapShaderLib.create())),r||n?this.shader.addLib(e.TotalShadowMapShaderLib.create()):this.shader.addLib(e.NoShadowMapShaderLib.create())}else this.shader.addLib(e.NoShadowMapShaderLib.create())},StandardLightMaterial.prototype._setEnvMapShaderLib=function(t){switch(this.shader.addLib(e.CommonEnvMapShaderLib.create()),t.mode){case e.EEnvMapMode.BASIC:this.shader.addLib(e.BasicForLightEnvMapShaderLib.create());break;case e.EEnvMapMode.REFLECTION:this.shader.addLib(e.ReflectionForLightEnvMapShaderLib.create());break;case e.EEnvMapMode.REFRACTION:this.shader.addLib(e.RefractionForLightEnvMapShaderLib.create());break;case e.EEnvMapMode.FRESNEL:this.shader.addLib(e.FresnelForLightEnvMapShaderLib.create());break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("EEnvMapMode"))}},StandardLightMaterial.prototype._hasTwoDShadowMap=function(){return e.ShadowUtils.isReceive(this.geometry.entityObject)&&this.mapManager.getTwoDShadowMapList().getCount()>0},StandardLightMaterial.prototype._hasCubemapShadowMap=function(){return e.ShadowUtils.isReceive(this.geometry.entityObject)&&this.mapManager.getCubemapShadowMapList().getCount()>0},StandardLightMaterial.prototype._addMap=function(){null!==this._lightMap&&this.mapManager.addMap(this._lightMap,{samplerVariableName:e.VariableNameTable.getVariableName("lightMap")}),null!==this._diffuseMap&&this.mapManager.addMap(this._diffuseMap,{samplerVariableName:e.VariableNameTable.getVariableName("diffuseMap")}),null!==this._specularMap&&this.mapManager.addMap(this._specularMap,{samplerVariableName:e.VariableNameTable.getVariableName("specularMap")}),null!==this._emissionMap&&this.mapManager.addMap(this._emissionMap,{samplerVariableName:e.VariableNameTable.getVariableName("emissionMap")}),null!==this._normalMap&&this.mapManager.addMap(this._normalMap,{samplerVariableName:e.VariableNameTable.getVariableName("normalMap")})},__decorate([e.requireSetter(function(t){e.assert(t instanceof e.ImageTexture||t instanceof e.ProceduralTexture,e.Log.info.FUNC_SHOULD("lightMap","be ImageTexture or ProceduralTexture"))}),e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"lightMap",null),__decorate([e.requireSetter(function(t){e.assert(t instanceof e.ImageTexture||t instanceof e.ProceduralTexture,e.Log.info.FUNC_SHOULD("diffuseMap","be ImageTexture or ProceduralTexture"))}),e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"diffuseMap",null),__decorate([e.requireSetter(function(t){e.assert(t instanceof e.ImageTexture||t instanceof e.ProceduralTexture,e.Log.info.FUNC_SHOULD("specularMap","be ImageTexture or ProceduralTexture"))}),e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"specularMap",null),__decorate([e.requireSetter(function(t){e.assert(t instanceof e.ImageTexture||t instanceof e.ProceduralTexture,e.Log.info.FUNC_SHOULD("emissionMap","be ImageTexture or ProceduralTexture"))}),e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"emissionMap",null),__decorate([e.requireSetter(function(t){e.assert(t instanceof e.ImageTexture,e.Log.info.FUNC_SHOULD("normalMap","be ImageTexture"))}),e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"normalMap",null),__decorate([e.cloneAttributeAsBasicType()],StandardLightMaterial.prototype,"shininess",null),__decorate([e.cloneAttributeAsBasicType()],StandardLightMaterial.prototype,"opacity",void 0),__decorate([e.cloneAttributeAsBasicType()],StandardLightMaterial.prototype,"lightModel",void 0),__decorate([e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"specularColor",void 0),__decorate([e.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"emissionColor",void 0),__decorate([e.cloneAttributeAsBasicType()],StandardLightMaterial.prototype,"lightMapIntensity",void 0),__decorate([e.virtual],StandardLightMaterial.prototype,"addTopExtendShaderLib",null),__decorate([e.virtual],StandardLightMaterial.prototype,"addExtendShaderLib",null),__decorate([e.virtual],StandardLightMaterial.prototype,"addEndShaderLib",null),__decorate([e.virtual],StandardLightMaterial.prototype,"addNormalRelatedShaderLib",null),__decorate([e.virtual],StandardLightMaterial.prototype,"addLightSetWorldPositionShaderLib",null),StandardLightMaterial}(e.EngineMaterial);e.StandardLightMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function StandardBasicMaterial(){t.apply(this,arguments),this._map=null,this.opacity=1}return __extends(StandardBasicMaterial,t),Object.defineProperty(StandardBasicMaterial.prototype,"mapList",{get:function(){return this.mapManager.getMapList()},enumerable:!0,configurable:!0}),Object.defineProperty(StandardBasicMaterial.prototype,"map",{set:function(e){this._map=e,this._addMap()},enumerable:!0,configurable:!0}),StandardBasicMaterial.prototype.addExtendShaderLib=function(){},StandardBasicMaterial.prototype.addShaderLib=function(){var t=null;this.shader.addLib(e.BasicShaderLib.create()),this._setMapShaderLib(),t=this.envMap,t&&(e.InstanceUtils.addNormalModelMatrixShaderLib(this.shader,this.geometry.entityObject),this._setEnvMapShaderLib(t)),this.addExtendShaderLib(),this.shader.addLib(e.EndBasicShaderLib.create())},StandardBasicMaterial.prototype._setMapShaderLib=function(){var t=this.mapManager,r=t.getMapCount();r>0&&(r>1?this.shader.addLib(e.MultiMapShaderLib.create()):this.shader.addLib(e.BasicMapShaderLib.create()))},StandardBasicMaterial.prototype._setEnvMapShaderLib=function(t){switch(this.addNormalShaderLib(),this.shader.addLib(e.CommonEnvMapShaderLib.create()),t.mode){case e.EEnvMapMode.BASIC:this.shader.addLib(e.BasicForBasicEnvMapShaderLib.create());break;case e.EEnvMapMode.REFLECTION:this.shader.addLib(e.ReflectionForBasicEnvMapShaderLib.create());break;case e.EEnvMapMode.REFRACTION:this.shader.addLib(e.RefractionForBasicEnvMapShaderLib.create());break;case e.EEnvMapMode.FRESNEL:this.shader.addLib(e.FresnelForBasicEnvMapShaderLib.create());break;default:e.Log.error(!0,e.Log.info.FUNC_INVALID("EEnvMapMode"))}},StandardBasicMaterial.prototype._addMap=function(){var t=this._map;if(null!==t)if(t instanceof e.Texture||t instanceof e.TextureAsset)this.mapManager.addMap(t);else for(var r=0,n=t;r<n.length;r++){var i=n[r];this.mapManager.addMap(i)}},__decorate([e.ensureGetter(function(t){e.assert(t.getCount()<=2,wdCb.Log.info.FUNC_SUPPORT("only","map.count <= 2"))}),e.cloneAttributeAsCustomType(function(e,t,r){e[r].forEach(function(e){t.mapManager.addMap(e.clone())})})],StandardBasicMaterial.prototype,"mapList",null),__decorate([e.requireSetter(function(t){if(t instanceof e.Texture||t instanceof e.TextureAsset);else{var r=t;e.it("map should be array",function(){e.expect(r).be.a("array")}),e.it("map.count should < 3",function(){e.expect(r.length).lessThan(3)})}})],StandardBasicMaterial.prototype,"map",null),__decorate([e.cloneAttributeAsBasicType()],StandardBasicMaterial.prototype,"opacity",void 0),__decorate([e.virtual],StandardBasicMaterial.prototype,"addExtendShaderLib",null),StandardBasicMaterial}(e.EngineMaterial);e.StandardBasicMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function LineMaterial(){t.apply(this,arguments),this._lineWidth=1}return __extends(LineMaterial,t),LineMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(LineMaterial.prototype,"lineWidth",{get:function(){return this._lineWidth},set:function(e){this._lineWidth=e},enumerable:!0,configurable:!0}),LineMaterial.prototype.getTextureForRenderSort=function(){return this.mapList.getChild(0)},__decorate([e.cloneAttributeAsBasicType(),e.requireSetter(function(t){e.it("lineWidth should <= 1",function(){e.expect(t).not.to.greaterThan(1)})}),e.ensureGetter(function(t){e.it("lineWidth should <= 1",function(){e.expect(t).not.to.greaterThan(1)})})],LineMaterial.prototype,"lineWidth",null),LineMaterial}(e.StandardBasicMaterial);e.LineMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicMaterial(){e.apply(this,arguments)}return __extends(BasicMaterial,e),BasicMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},BasicMaterial.prototype.getTextureForRenderSort=function(){return this.mapList.getChild(0)},BasicMaterial}(e.StandardBasicMaterial);e.BasicMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SkyboxMaterial(){t.apply(this,arguments)}return __extends(SkyboxMaterial,t),SkyboxMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},SkyboxMaterial.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.side=e.ESide.BACK},SkyboxMaterial.prototype.getTextureForRenderSort=function(){return null},SkyboxMaterial.prototype.addShaderLib=function(){this.shader.addLib(e.SkyboxShaderLib.create())},SkyboxMaterial}(e.EngineMaterial);e.SkyboxMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function LightMaterial(){e.apply(this,arguments)}return __extends(LightMaterial,e),LightMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},LightMaterial.prototype.getTextureForRenderSort=function(){return this.diffuseMap},LightMaterial}(e.StandardLightMaterial);e.LightMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ShaderMaterial(){t.apply(this,arguments),this.definitionData=null}return __extends(ShaderMaterial,t),ShaderMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},ShaderMaterial.prototype.init=function(){var r=this;this.shader.read(this.definitionData),this.shader.getSampler2DUniformsAfterRead().forEach(function(t,n){r.mapManager.addMap(e.LoaderManager.getInstance().get(t.textureId),{samplerVariableName:n})}),this.shader.addLib(e.CustomShaderLib.create()),this.shader.addLib(e.EndShaderLib.create()),t.prototype.init.call(this)},ShaderMaterial.prototype.getTextureForRenderSort=function(){return null},ShaderMaterial.prototype.read=function(t){this.definitionData=e.LoaderManager.getInstance().get(t)},ShaderMaterial.prototype.createShader=function(){return e.CustomShader.create()},__decorate([e.cloneAttributeAsBasicType()],ShaderMaterial.prototype,"definitionData",void 0),__decorate([e.ensure(function(){var t=this;e.it("should only has CustomShaderLib and EndShaderLib, not has other shader libs",function(){e.expect(2===t.shader.getLibs().getCount()&&t.shader.hasLib(e.CustomShaderLib)).true})})],ShaderMaterial.prototype,"init",null),ShaderMaterial}(e.Material);e.ShaderMaterial=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.FLAT=0]="FLAT",e[e.SMOOTH=1]="SMOOTH"}(e.EShading||(e.EShading={}));e.EShading}(wd||(wd={}));var wd;!function(e){var t=function(){function ShaderManager(e){this._material=null,this._otherShaderMap=wdCb.Hash.create(),this._mainShader=null,this._material=e}return ShaderManager.create=function(e){var t=new this(e);return t},Object.defineProperty(ShaderManager.prototype,"shader",{get:function(){var t=e.Director.getInstance().scene;return t.isUseShader?this._otherShaderMap.getChild(t.currentShaderType):this._mainShader},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderManager.prototype,"mapManager",{get:function(){return this.shader.mapManager},enumerable:!0,configurable:!0}),ShaderManager.prototype.setShader=function(e){this._mainShader=e,this._mainShader.mapManager.material=this._material},ShaderManager.prototype.init=function(){var e=this._material;this._otherShaderMap.forEach(function(t){t.init(e)}),this._mainShader.init(e)},ShaderManager.prototype.dispose=function(){this._otherShaderMap.forEach(function(e){e.dispose()}),this._mainShader.dispose()},ShaderManager.prototype.update=function(e){this.shader.update(e,this._material)},ShaderManager.prototype.addShader=function(e,t){this._otherShaderMap.addChild(e,t)},ShaderManager.prototype.hasShader=function(e){return this._otherShaderMap.hasChild(e)},ShaderManager.prototype.getShader=function(e){return this._otherShaderMap.getChild(e)},__decorate([e.ensureGetter(function(t){e.assert(!!t,e.Log.info.FUNC_NOT_EXIST("shader"))})],ShaderManager.prototype,"shader",null),ShaderManager}();e.ShaderManager=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.UNKNOW=0]="UNKNOW",e[e.FONT=1]="FONT"}(e.EAssetType||(e.EAssetType={}));e.EAssetType}(wd||(wd={}));var wd;!function(e){var t=function(){function Loader(){this._container=wdCb.Hash.create()}return Loader.prototype.load=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=null,a=this,o=null,s=null;return i=1===t.length?e.JudgeUtils.isArrayExactly(n)?n.join("-"):n:t[1],o=this._container.getChild(i),s=o?wdFrp.just(o):this.loadAsset(n,i).do(function(t){a._container.addChild(i,t),e.LoaderManager.getInstance().add(i,a)},function(e){a._errorHandle(n,e)},null)},Loader.prototype.get=function(e){return this._container.getChild(e)},Loader.prototype.has=function(e){return this._container.hasChild(e)},Loader.prototype.dispose=function(){this._container.removeAllChildren()},Loader.prototype._errorHandle=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null;n=e.JudgeUtils.isArrayExactly(t[0])?t[0].join(","):t[0],i=t[1],e.Log.log("load "+n+" asset fail:"+i)},Loader}();e.Loader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GLSLLoader(){t.call(this)}return __extends(GLSLLoader,t),GLSLLoader.getInstance=function(){},GLSLLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0];return e.AjaxLoader.load(n,"text")},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],GLSLLoader.prototype,"loadAsset",null),GLSLLoader=__decorate([e.singleton()],GLSLLoader)}(e.Loader);e.GLSLLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function JsLoader(){t.call(this)}return __extends(JsLoader,t),JsLoader.getInstance=function(){},JsLoader.prototype.loadAsset=function(){for(var e=this,t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=this,i=t[0];return wdFrp.fromPromise(new RSVP.Promise(function(t,r){var a=n._createScript();a.async=!1,a.addEventListener("error",function(e){r("load js file error. url:"+i)}),a.readyState?a.onreadystatechange=function(){"loaded"!==a.readyState&&"complete"!==a.readyState||(a.onreadystatechange=null,t(i))}:a.onload=function(){t(i)},a.src=i,e._appendScript(a)}))},JsLoader.prototype._createScript=function(){var e=document.createElement("script");return e.type="text/javascript",e},JsLoader.prototype._appendScript=function(e){document.getElementsByTagName("head")[0].appendChild(e)},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],JsLoader.prototype,"loadAsset",null),JsLoader=__decorate([e.singleton()],JsLoader)}(e.Loader);e.JsLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function JSONLoader(){t.call(this)}return __extends(JSONLoader,t),JSONLoader.getInstance=function(){},JSONLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0];return e.AjaxLoader.load(n,"json")},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],JSONLoader.prototype,"loadAsset",null),JSONLoader=__decorate([e.singleton()],JSONLoader)}(e.Loader);e.JSONLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function VideoLoader(){t.call(this)}return __extends(VideoLoader,t),VideoLoader.getInstance=function(){},VideoLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null;return n=e.JudgeUtils.isString(t[0])?[t[0]]:t[0],wdFrp.fromPromise(new RSVP.Promise(function(t,r){e.Video.create({urlArr:n,onLoad:function(r){t(e.VideoTextureAsset.create(r))},onError:function(e){r(e)}})}))},VideoLoader=__decorate([e.singleton()],VideoLoader)}(e.Loader);e.VideoLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TextureLoader(){t.call(this)}return __extends(TextureLoader,t),TextureLoader.getInstance=function(){},TextureLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=null,i=null,a=t[0];switch(n=wdCb.PathUtils.extname(a).toLowerCase()){case".jpg":case".jpeg":case".gif":case".bmp":i=e.ImageLoader.load(a).map(function(t){var r=e.ImageTextureAsset.create(t);return r.format=e.ETextureFormat.RGB,r});break;case".png":i=e.ImageLoader.load(a).map(function(t){return e.ImageTextureAsset.create(t)});break;case".dds":i=e.CompressedTextureLoader.load(a);break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT(n))}return i},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],TextureLoader.prototype,"loadAsset",null),TextureLoader=__decorate([e.singleton()],TextureLoader)}(e.Loader);e.TextureLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ImageLoader(){}return ImageLoader.load=function(t){return wdFrp.fromPromise(new RSVP.Promise(function(r,n){var i=null;i=new e.root.Image,i.onload=function(){this.onload=null,r(i)},i.onerror=function(){n("error")},i.src=t}))},ImageLoader}();e.ImageLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(){function AjaxLoader(){}return AjaxLoader.load=function(e,t){return wdFrp.fromPromise(new RSVP.Promise(function(r,n){wdCb.AjaxUtils.ajax({type:"get",url:e,contentType:"text/plain; charset=utf-8",dataType:t,success:function(e){r(e)},error:function(t,r){n("url:"+e+"\nreadyState:"+t.readyState+"\nstatus:"+t.status+"\nmessage:"+r.message+"\nresponseText:"+t.responseText)}})}))},AjaxLoader}();e.AjaxLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ModelLoaderUtils(){}return ModelLoaderUtils.getPath=function(e,t){return wdCb.PathUtils.dirname(e)+"/"+t},ModelLoaderUtils}();e.ModelLoaderUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CompressedTextureLoader(){}return CompressedTextureLoader.load=function(t){var r=this;return e.AjaxLoader.load(t,"arraybuffer").map(function(t){var n=e.DDSParser.parse(t,!0),i=e.CompressedTextureAsset.create();return i.width=n.width,i.height=n.height,i.mipmaps=n.mipmaps,1==n.mipmapCount&&(i.minFilter=e.ETextureFilterMode.LINEAR),i.format=r._getCompressedFormat(n.format),i})},CompressedTextureLoader._getCompressedFormat=function(t){var r=e.GPUDetector.getInstance().extensionCompressedTextureS3TC;if(t===e.ETextureFormat.RGBA)return t;if(!r)return null;switch(t){case e.ETextureFormat.RGB_S3TC_DXT1:t=r.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case e.ETextureFormat.RGBA_S3TC_DXT1:t=r.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case e.ETextureFormat.RGBA_S3TC_DXT3:t=r.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case e.ETextureFormat.RGBA_S3TC_DXT5:t=r.COMPRESSED_RGBA_S3TC_DXT5_EXT}return t},CompressedTextureLoader}();e.CompressedTextureLoader=t}(wd||(wd={}));var wd;!function(e){var t=542327876,r=131072,n=512,i=4,a=function(){function DDSParser(){}return DDSParser.parse=function(a,s){void 0===s&&(s=!0);var c=new o,u=this._fourCCToInt32("DXT1"),l=this._fourCCToInt32("DXT3"),d=this._fourCCToInt32("DXT5"),h=31,p=0,f=1,m=2,g=3,_=4,y=7,v=20,b=21,C=22,S=23,T=24,E=25,M=26,w=28,L=new Int32Array(a,0,h),D=null,x=null,A=null,O=null,R=null,I=null,B=null;if(L[p]!==t)return e.Log.error(!0,"Invalid magic number in DDS header."),c;if(!L[v]&i)return e.Log.error(!0,"Unsupported format, must contain a FourCC code."),c;switch(x=L[b],A=!1,x){case u:D=8,c.format=e.ETextureFormat.RGB_S3TC_DXT1;break;case l:D=16,c.format=e.ETextureFormat.RGBA_S3TC_DXT3;break;case d:D=16,c.format=e.ETextureFormat.RGBA_S3TC_DXT5;
break;default:if(!(32==L[C]&&16711680&L[S]&&65280&L[T]&&255&L[E]&&4278190080&L[M]))return e.Log.error(!0,"Unsupported FourCC code "+this._int32ToFourCC(x)),c;A=!0,D=64,c.format=e.ETextureFormat.RGBA}c.mipmapCount=1,L[m]&r&&s!==!1&&(c.mipmapCount=Math.max(1,L[y])),c.isCubemap=!!(L[w]&n),c.width=L[_],c.height=L[g],O=L[f]+4,R=c.width,I=c.height,B=c.isCubemap?6:1;for(var F=0;F<B;F++){for(var P=0;P<c.mipmapCount;P++){var N=null,U=null,G=null;A?(U=this._loadARGBMip(a,O,R,I),G=U.length):(G=Math.max(4,R)/4*Math.max(4,I)/4*D,U=new Uint8Array(a,O,G)),N={data:U,width:R,height:I},c.mipmaps.addChild(N),O+=G,R=Math.max(.5*R,1),I=Math.max(.5*I,1)}R=c.width,I=c.height}return c},DDSParser._fourCCToInt32=function(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)},DDSParser._int32ToFourCC=function(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)},DDSParser._loadARGBMip=function(e,t,r,n){for(var i=r*n*4,a=new Uint8Array(e,t,i),o=new Uint8Array(i),s=0,c=0,u=0;u<n;u++)for(var l=0;l<r;l++){var d=null,h=null,p=null,f=null;d=a[c],c++,h=a[c],c++,p=a[c],c++,f=a[c],c++,o[s]=p,s++,o[s]=h,s++,o[s]=d,s++,o[s]=f,s++}return o},DDSParser}();e.DDSParser=a;var o=function(){function DDSData(){this.mipmaps=wdCb.Collection.create(),this.width=0,this.height=0,this.format=null,this.mipmapCount=1,this.isCubemap=!1}return DDSData}();e.DDSData=o}(wd||(wd={}));var wd;!function(e){var t=function(){function TextureAsset(){this._width=null,this._height=null,this.generateMipmaps=!0,this.sourceRegionMethod=e.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL,this.format=e.ETextureFormat.RGBA,this.source=TextureAsset.defaultTexture,this.repeatRegion=e.RectRegion.create(0,0,1,1),this.sourceRegion=null,this.sourceRegionMapping=e.ETextureSourceRegionMapping.CANVAS,this.packAlignment=4,this.unpackAlignment=4,this.flipY=!0,this.premultiplyAlpha=!1,this.colorspaceConversion=e.DeviceManager.getInstance().gl.BROWSER_DEFAULT_WEBGL,this.wrapS=e.ETextureWrapMode.CLAMP_TO_EDGE,this.wrapT=e.ETextureWrapMode.CLAMP_TO_EDGE,this.magFilter=e.ETextureFilterMode.LINEAR,this.minFilter=e.ETextureFilterMode.LINEAR_MIPMAP_LINEAR,this.type=e.ETextureType.UNSIGNED_BYTE,this.mipmaps=wdCb.Collection.create(),this.anisotropy=0,this.needUpdate=!0}return Object.defineProperty(TextureAsset.prototype,"width",{get:function(){return null===this._width?this.source?this.source.width:null:this._width},set:function(e){this._width=e},enumerable:!0,configurable:!0}),Object.defineProperty(TextureAsset.prototype,"height",{get:function(){return null===this._height?this.source?this.source.height:null:this._height},set:function(e){this._height=e},enumerable:!0,configurable:!0}),TextureAsset.prototype.clone=function(){return e.CloneUtils.clone(this)},TextureAsset.prototype.cloneToCubemapTexture=function(t){t.generateMipmaps=this.generateMipmaps,t.minFilter=this.minFilter,t.magFilter=this.magFilter,t.width=this.width,t.height=this.height,t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.anisotropy=this.anisotropy,t.premultiplyAlpha=this.premultiplyAlpha,t.flipY=!1,t.unpackAlignment=this.unpackAlignment,t.packAlignment=this.packAlignment,t.colorspaceConversion=this.colorspaceConversion,t.needUpdate=this.needUpdate,t.mode=e.EEnvMapMode.BASIC},TextureAsset.prototype.cloneTo=function(t){return e.Log.error(!t,e.Log.info.FUNC_MUST_DEFINE("texture")),t.source=this.source,t.width=this.width,t.height=this.height,t.mipmaps=this.mipmaps.clone(),t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.magFilter=this.magFilter,t.minFilter=this.minFilter,t.anisotropy=this.anisotropy,t.format=this.format,t.type=this.type,t.repeatRegion=this.repeatRegion.clone(),t.sourceRegion=this.sourceRegion&&this.sourceRegion.clone(),t.sourceRegionMapping=this.sourceRegionMapping,t.sourceRegionMethod=this.sourceRegionMethod,t.generateMipmaps=this.generateMipmaps,t.premultiplyAlpha=this.premultiplyAlpha,t.flipY=this.flipY,t.unpackAlignment=this.unpackAlignment,t.packAlignment=this.packAlignment,t.colorspaceConversion=this.colorspaceConversion,t.needUpdate=this.needUpdate,t},TextureAsset.defaultTexture=null,__decorate([e.cloneAttributeAsBasicType()],TextureAsset.prototype,"source",void 0),TextureAsset}();e.TextureAsset=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ImageTextureAsset(e){t.call(this),this.source=e}return __extends(ImageTextureAsset,t),ImageTextureAsset.create=function(e){var t=new this(e);return t},ImageTextureAsset.prototype.toTexture=function(){return e.ImageTexture.create(this)},ImageTextureAsset.prototype.toCubemapFaceTexture=function(){return e.CubemapFaceImageTexture.create(this)},ImageTextureAsset.prototype.cloneToCubemapFaceTexture=function(t){t.source=this.source,t.type=this.type,t.format=this.format,t.width=this.width,t.height=this.height,t.sourceRegion=this.sourceRegion,t.sourceRegionMethod=e.ETextureSourceRegionMethod.DRAW_IN_CANVAS},ImageTextureAsset}(e.TextureAsset);e.ImageTextureAsset=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function VideoTextureAsset(e){t.call(this),this.video=null,this.video=e,this.source=this.video.source}return __extends(VideoTextureAsset,t),VideoTextureAsset.create=function(e){var t=new this(e);return t.initWhenCreate(),t},VideoTextureAsset.prototype.initWhenCreate=function(){this.width=0,this.height=0,this.generateMipmaps=!1,this.minFilter=null,this.magFilter=null,this.sourceRegion=null,this.sourceRegionMethod=null},VideoTextureAsset.prototype.toTexture=function(){return e.VideoTexture.create(this)},VideoTextureAsset.prototype.toCubemapFaceTexture=function(){return e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("video texture","cubemap"))},VideoTextureAsset.prototype.cloneToCubemapFaceTexture=function(t){e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("video texture","cubemap"))},VideoTextureAsset}(e.TextureAsset);e.VideoTextureAsset=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CompressedTextureAsset(){t.apply(this,arguments)}return __extends(CompressedTextureAsset,t),CompressedTextureAsset.create=function(){var e=new this;return e.initWhenCreate(),e},CompressedTextureAsset.prototype.initWhenCreate=function(){this.generateMipmaps=!1,this.flipY=!1},CompressedTextureAsset.prototype.toTexture=function(){return e.CompressedTexture.create(this)},CompressedTextureAsset.prototype.toCubemapFaceTexture=function(){return e.CubemapFaceCompressedTexture.create(this)},CompressedTextureAsset.prototype.cloneToCubemapFaceTexture=function(e){e.type=this.type,e.format=this.format,e.width=this.width,e.height=this.height,e.mipmaps=this.mipmaps,e.minFilter=this.minFilter},CompressedTextureAsset}(e.TextureAsset);e.CompressedTextureAsset=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.NEAREST="NEAREST"]="NEAREST",e[e.NEAREST_MIPMAP_MEAREST="NEAREST_MIPMAP_MEAREST"]="NEAREST_MIPMAP_MEAREST",e[e.NEAREST_MIPMAP_LINEAR="NEAREST_MIPMAP_LINEAR"]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR="LINEAR"]="LINEAR",e[e.LINEAR_MIPMAP_NEAREST="LINEAR_MIPMAP_NEAREST"]="LINEAR_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_LINEAR="LINEAR_MIPMAP_LINEAR"]="LINEAR_MIPMAP_LINEAR"}(e.ETextureFilterMode||(e.ETextureFilterMode={}));e.ETextureFilterMode}(wd||(wd={}));var wd;!function(e){!function(e){e[e.REPEAT="REPEAT"]="REPEAT",e[e.MIRRORED_REPEAT="MIRRORED_REPEAT"]="MIRRORED_REPEAT",e[e.CLAMP_TO_EDGE="CLAMP_TO_EDGE"]="CLAMP_TO_EDGE"}(e.ETextureWrapMode||(e.ETextureWrapMode={}));e.ETextureWrapMode}(wd||(wd={}));var wd;!function(e){!function(e){e[e.RGB="RGB"]="RGB",e[e.RGBA="RGBA"]="RGBA",e[e.ALPHA="ALPHA"]="ALPHA",e[e.LUMINANCE="LUMINANCE"]="LUMINANCE",e[e.LUMINANCE_ALPHA="LUMINANCE_ALPHA"]="LUMINANCE_ALPHA",e[e.RGB_S3TC_DXT1="RGB_S3TC_DXT1"]="RGB_S3TC_DXT1",e[e.RGBA_S3TC_DXT1="RGBA_S3TC_DXT1"]="RGBA_S3TC_DXT1",e[e.RGBA_S3TC_DXT3="RGBA_S3TC_DXT3"]="RGBA_S3TC_DXT3",e[e.RGBA_S3TC_DXT5="RGBA_S3TC_DXT5"]="RGBA_S3TC_DXT5"}(e.ETextureFormat||(e.ETextureFormat={}));e.ETextureFormat}(wd||(wd={}));var wd;!function(e){!function(e){e[e.UNSIGNED_BYTE="UNSIGNED_BYTE"]="UNSIGNED_BYTE",e[e.UNSIGNED_SHORT_5_6_5="UNSIGNED_SHORT_5_6_5"]="UNSIGNED_SHORT_5_6_5",e[e.UNSIGNED_SHORT_4_4_4_4="UNSIGNED_SHORT_4_4_4_4"]="UNSIGNED_SHORT_4_4_4_4",e[e.UNSIGNED_SHORT_5_5_5_1="UNSIGNED_SHORT_5_5_5_1"]="UNSIGNED_SHORT_5_5_5_1"}(e.ETextureType||(e.ETextureType={}));e.ETextureType}(wd||(wd={}));var wd;!function(e){!function(e){e[e.BASIC=0]="BASIC",e[e.REFLECTION=1]="REFLECTION",e[e.REFRACTION=2]="REFRACTION",e[e.FRESNEL=3]="FRESNEL"}(e.EEnvMapMode||(e.EEnvMapMode={}));e.EEnvMapMode}(wd||(wd={}));var wd;!function(e){!function(e){e[e.MIX=0]="MIX",e[e.MULTIPLY=1]="MULTIPLY",e[e.ADD=2]="ADD"}(e.ETextureCombineMode||(e.ETextureCombineMode={}));e.ETextureCombineMode}(wd||(wd={}));var wd;!function(e){!function(e){e[e.CANVAS=0]="CANVAS",e[e.UV=1]="UV"}(e.ETextureSourceRegionMapping||(e.ETextureSourceRegionMapping={}));e.ETextureSourceRegionMapping}(wd||(wd={}));var wd;!function(e){!function(e){e[e.CHANGE_TEXCOORDS_IN_GLSL=0]="CHANGE_TEXCOORDS_IN_GLSL",e[e.DRAW_IN_CANVAS=1]="DRAW_IN_CANVAS"}(e.ETextureSourceRegionMethod||(e.ETextureSourceRegionMethod={}));e.ETextureSourceRegionMethod}(wd||(wd={}));var wd;!function(e){!function(e){e[e.TEXTURE_2D="TEXTURE_2D"]="TEXTURE_2D",e[e.TEXTURE_CUBE_MAP="TEXTURE_CUBE_MAP"]="TEXTURE_CUBE_MAP"}(e.ETextureTarget||(e.ETextureTarget={}));e.ETextureTarget}(wd||(wd={}));var wd;!function(e){var t=function(){function LoaderManager(){this.assetCount=0,this.currentLoadedCount=0,this._assetTable=wdCb.Hash.create()}return LoaderManager.getInstance=function(){},LoaderManager.prototype.load=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=this;if(e.JudgeUtils.isString(t[0])){var i=t[0],a=i;return this._createLoadSingleAssetStream(i,a)}var o=t[0];return wdFrp.fromArray(o).concatMap(function(t){return n._createLoadMultiAssetStream(t.type||e.EAssetType.UNKNOW,t.url,t.id)})},LoaderManager.prototype.reset=function(){this.assetCount=0,this.currentLoadedCount=0},LoaderManager.prototype.dispose=function(){this.reset(),e.LoaderFactory.createAllLoader().forEach(function(e){e.dispose()})},LoaderManager.prototype.get=function(e){var t=this._assetTable.getChild(e);return t?t.get(e):null},LoaderManager.prototype.add=function(e,t){this._assetTable.addChild(e,t)},LoaderManager.prototype._createLoadMultiAssetStream=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=e[0],n=e[1],i=e[2],a=this._getLoader(r,n),o=this;return a.has(i)||o.assetCount++,a.load(n,i).map(function(){return o.currentLoadedCount++,{currentLoadedCount:o.currentLoadedCount,assetCount:o.assetCount}})},LoaderManager.prototype._createLoadSingleAssetStream=function(t,r){var n=this._getLoader(e.EAssetType.UNKNOW,t);return n.load(t,r)},LoaderManager.prototype._getLoader=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=null;return i=e.JudgeUtils.isArrayExactly(t[1])?wdCb.PathUtils.extname(t[1][0]):wdCb.PathUtils.extname(t[1]),e.LoaderFactory.create(n,i.toLowerCase())},LoaderManager=__decorate([e.singleton()],LoaderManager)}();e.LoaderManager=t}(wd||(wd={}));var wd;!function(e){var t=function(){function LoaderFactory(){}return LoaderFactory.create=function(t,r){var n=null;switch(t){case e.EAssetType.FONT:n=e.FontLoader.getInstance();break;case e.EAssetType.UNKNOW:n=this._getLoaderByExtname(r);break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("asset type:"+t))}return n},LoaderFactory.createAllLoader=function(){return wdCb.Collection.create([e.JsLoader.getInstance(),e.GLSLLoader.getInstance(),e.TextureLoader.getInstance(),e.VideoLoader.getInstance(),e.FontLoader.getInstance(),e.FntLoader.getInstance()])},LoaderFactory._getLoaderByExtname=function(t){var r=null;switch(t){case".json":r=e.JSONLoader.getInstance();break;case".js":r=e.JsLoader.getInstance();break;case".glsl":r=e.GLSLLoader.getInstance();break;case".jpg":case".jpeg":case".png":case".dds":case".gif":case".bmp":r=e.TextureLoader.getInstance();break;case".mp4":case".ogv":case".webm":r=e.VideoLoader.getInstance();break;case".gltf":r=e.GLTFLoader.getInstance();break;case".wd":r=e.WDLoader.getInstance();break;case".eot":case".ttf":case".woff":case".svg":r=e.FontLoader.getInstance();break;case".fnt":r=e.FntLoader.getInstance();break;default:e.Log.error(!0,e.Log.info.FUNC_UNKNOW("extname:"+t))}return r},LoaderFactory}();e.LoaderFactory=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GLTFLoader(){t.call(this),this._arrayBufferMap=wdCb.Hash.create(),this._imageMap=wdCb.Hash.create()}return __extends(GLTFLoader,t),GLTFLoader.getInstance=function(){},GLTFLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=this,a=null;return e.AjaxLoader.load(n,"json").flatMap(function(e){return a=e,i._createLoadAllAssetsStream(n,e)}).lastOrDefault().map(function(){return e.GLTFAssembler.create().build(e.GLTFParser.create().parse(a,i._arrayBufferMap,i._imageMap))})},GLTFLoader.prototype._createLoadAllAssetsStream=function(e,t){return wdFrp.fromArray([this._createLoadBuffersStream(e,t),this._createLoadImageAssetStream(e,t)]).mergeAll()},GLTFLoader.prototype._createLoadBuffersStream=function(t,r){var n=this._arrayBufferMap;return this._createLoadAssetStream(t,r,r.buffers,n,function(t,r){return e.AjaxLoader.load(r,"arraybuffer").do(function(r){e.Log.error(!(r instanceof ArrayBuffer),e.Log.info.FUNC_SHOULD("Buffer:"+t,"be an array buffer")),e.Log.error(r.byteLength!==r.byteLength,e.Log.info.FUNC_SHOULD("Buffer:"+t+"'s length is "+r.byteLength+", but it","be "+r.byteLength)),n.addChild(t,r)})})},GLTFLoader.prototype._createLoadImageAssetStream=function(t,r){var n=this._imageMap;return this._createLoadAssetStream(t,r,r.images,n,function(t,r){return e.ImageLoader.load(r).do(function(e){n.addChild(t,e)})})},GLTFLoader.prototype._createLoadAssetStream=function(t,r,n,i,a){var o=[];if(n){var s=null;for(s in n)if(n.hasOwnProperty(s)){var c=n[s];if(e.GLTFUtils.isBase64(c.uri))i.addChild(s,e.GLTFUtils.decodeArrayBuffer(c.uri));else{var u=e.ModelLoaderUtils.getPath(t,c.uri);o.push(a(s,u))}}}return wdFrp.fromArray(o).mergeAll()},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],GLTFLoader.prototype,"loadAsset",null),GLTFLoader=__decorate([e.singleton()],GLTFLoader)}(e.Loader);e.GLTFLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GLTFAssembler(){this._result=wdCb.Hash.create()}return GLTFAssembler.create=function(){var e=new this;return e},GLTFAssembler.prototype.build=function(e){return this._buildMetadata(e),this._buildModels(e),this._result},GLTFAssembler.prototype._buildMetadata=function(e){var t=wdCb.Hash.create();for(var r in e.metadata)e.metadata.hasOwnProperty(r)&&t.addChild(r,e.metadata[r]);this._result.addChild("metadata",t)},GLTFAssembler.prototype._buildModels=function(t){var r=wdCb.Collection.create(),n=this,i=function(t){var r=e.GameObject.create();return t.name&&(r.name=t.name),n._isModelContainer(t)&&r.addTag(e.EWDTag.CONTAINER),n._addComponentsFromGLTF(r,t.components),r.addComponent(e.MeshRenderer.create()),t.children&&t.children.forEach(function(e){r.addChild(i(e))}),r};t.objects&&(t.objects.forEach(function(e){r.addChild(i(e))}),this._result.addChild("models",r))},GLTFAssembler.prototype._isModelContainer=function(e){return e.isContainer},GLTFAssembler.prototype._addComponentsFromGLTF=function(e,t){var r=this;t.forEach(function(t){r._isTransform(t)?e.addComponent(r._createTransform(t)):r._isCamera(t)?e.addComponent(r._createCamera(t)):r._isLight(t)?e.addComponent(r._createLight(t)):r._isGeometry(t)?e.addComponent(r._createGeometry(t)):r._isArticulatedAnimation(t)&&e.addComponent(r._createArticulatedAnimation(t))})},GLTFAssembler.prototype._isTransform=function(e){return!!e.matrix||!!e.position},GLTFAssembler.prototype._isCamera=function(e){return!!e.camera},GLTFAssembler.prototype._isLight=function(e){return!!e.lightColor&&!!e.type},GLTFAssembler.prototype._isGeometry=function(e){return!!e.material},GLTFAssembler.prototype._isArticulatedAnimation=function(t){return e.GLTFUtils.isIGLTFArticulatedAnimation(t)},GLTFAssembler.prototype._createTransform=function(t){var r=e.ThreeDTransform.create();return t.matrix?(r.localPosition=t.matrix.getTranslation(),r.localRotation=t.matrix.getRotation(),r.localScale=t.matrix.getScale()):(r.localPosition=t.position,r.localRotation=t.rotation,r.localScale=t.scale),r},GLTFAssembler.prototype._createCamera=function(t){return e.BasicCameraController.create(t.camera)},GLTFAssembler.prototype._createLight=function(t){var r=null;switch(t.type){case"ambient":r=e.AmbientLight.create(),r.color=t.lightColor;break;case"directional":r=e.DirectionLight.create(),r.color=t.lightColor;break;case"point":r=e.PointLight.create(),r.color=t.lightColor,e.GLTFUtils.addData(r,"range",t.distance),e.GLTFUtils.addData(r,"constant",t.constantAttenuation),e.GLTFUtils.addData(r,"linear",t.linearAttenuation),e.GLTFUtils.addData(r,"quadratic",t.quadraticAttenuation)}return r},GLTFAssembler.prototype._createGeometry=function(t){var r=e.ModelGeometry.create();return r.vertices=t.vertices,r.faces=t.faces,e.GLTFUtils.addData(r,"colors",t.colors),e.GLTFUtils.addData(r,"texCoords",t.texCoords),r.drawMode=t.drawMode,r.material=this._createMaterial(t.material),r},GLTFAssembler.prototype._createMaterial=function(t){var r=null;switch(t.type){case"BasicMaterial":r=this._createBasicMaterial(t);break;case"LightMaterial":r=this._createLightMaterial(t);break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("material type:"+t.type))}return r},GLTFAssembler.prototype._createBasicMaterial=function(t){var r=e.BasicMaterial.create();return this._setBasicDataOfMaterial(r,t),r},GLTFAssembler.prototype._createLightMaterial=function(t){var r=e.LightMaterial.create();return this._setBasicDataOfMaterial(r,t),t.transparent===!0&&void 0!==t.opacity&&(r.opacity=t.opacity,r.blendType=e.EBlendType.NORMAL),t.lightModel===e.ELightModel.LAMBERT?(e.Log.log(e.Log.info.FUNC_NOT_SUPPORT("LAMBERT light model, use PHONG light model instead")),r.lightModel=e.ELightModel.PHONG):r.lightModel=t.lightModel,e.GLTFUtils.addData(r,"color",t.diffuseColor),e.GLTFUtils.addData(r,"specularColor",t.specularColor),e.GLTFUtils.addData(r,"emissionColor",t.emissionColor),e.GLTFUtils.addData(r,"diffuseMap",t.diffuseMap),e.GLTFUtils.addData(r,"specularMap",t.specularMap),e.GLTFUtils.addData(r,"emissionMap",t.emissionMap),e.GLTFUtils.addData(r,"shininess",t.shininess),r},GLTFAssembler.prototype._setBasicDataOfMaterial=function(t,r){r.doubleSided&&r.doubleSided===!0?t.side=e.ESide.BOTH:t.side=e.ESide.FRONT},GLTFAssembler.prototype._createArticulatedAnimation=function(t){var r=e.ArticulatedAnimation.create();return r.data=wdCb.Hash.create(t),r},GLTFAssembler}();e.GLTFAssembler=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GLTFParser(){this._data={},this._arrayBufferMap=null,this._imageMap=null,this._json=null,this._geometryParser=e.GLTFGeometryParser.create(),this._articulatedAnimationParser=e.GLTFArticulatedAnimationParser.create()}return GLTFParser.create=function(){var e=new this;return e},GLTFParser.prototype.parse=function(e,t,r){return this._json=e,this._arrayBufferMap=t,this._imageMap=r,e.asset&&this._parseMetadata(),this._parseObjects(),e.animations&&this._articulatedAnimationParser.parse(e,this._data.objects,this._arrayBufferMap),this._data},GLTFParser.prototype._parseMetadata=function(){var e={},t=this._json;for(var r in t.asset)t.asset.hasOwnProperty(r)&&(e[r]=t.asset[r]);this._data.metadata=e},GLTFParser.prototype._parseObjects=function(){var t=this,r=this._json,n=wdCb.Collection.create(),i=function(n,a){var o=e.GLTFUtils.createObjectData();if(o.id=n,a.name&&(o.name=a.name),a.meshes&&a.meshes.length>0){var s=null;a.meshes.length>1&&e.Log.warn(e.Log.info.FUNC_NOT_SUPPORT("multi mesh(geometry), just use the first mesh(geometry)")),s=r.meshes[a.meshes[0]],!a.name&&s.name&&(o.name=s.name),t._geometryParser.parse(r,o,s,t._arrayBufferMap,t._imageMap)}if(a.extensions&&a.extensions.KHR_materials_common&&a.extensions.KHR_materials_common.light&&o.components.addChild(t._parseLight(a.extensions.KHR_materials_common.light)),a.camera&&o.components.addChild(t._parseCamera(a.camera)),a.matrix?o.components.addChild(t._parseTransform(a.matrix)):a.rotation&&a.scale&&a.translation&&o.components.addChild(t._parseTransform(a.translation,a.rotation,a.scale)),a.children)for(var c=0,u=a.children;c<u.length;c++){var l=u[c];o.children.addChild(i(l,r.nodes[l]))}return o};if(!r.scenes[r.scene])return void(this._data.objects=n);for(var a=0,o=r.scenes[r.scene].nodes;a<o.length;a++){var s=o[a];n.addChild(i(s,r.nodes[s]))}this._data.objects=n},GLTFParser.prototype._parseLight=function(t){var r=this._json.extensions.KHR_materials_common.lights[t],n={};return e.GLTFUtils.addData(n,"type",r.type),this._parseLightDataByType(n,r,n.type),n},GLTFParser.prototype._parseLightDataByType=function(t,r,n){var i=r[n];switch(n){case"ambient":case"directional":t.lightColor=e.GLTFUtils.getColor(i.color);break;case"point":t.lightColor=e.GLTFUtils.getColor(i.color),e.GLTFUtils.addData(t,"distance",i.distance),e.GLTFUtils.addData(t,"constantAttenuation",i.constantAttenuation),e.GLTFUtils.addData(t,"linearAttenuation",i.linearAttenuation),e.GLTFUtils.addData(t,"quadraticAttenuation",i.quadraticAttenuation)}},GLTFParser.prototype._parseCamera=function(e){var t=this._json.cameras[e],r={};return this._parseCameraDataByType(r,t),r},GLTFParser.prototype._parseCameraDataByType=function(t,r){var n=null,i=r.type,a=r[i];switch(i){case"perspective":if(a=r[i],n=e.PerspectiveCamera.create(),n.near=a.znear,n.far=a.zfar,a.aspectRatio)n.aspect=a.aspectRatio;else{var o=e.DeviceManager.getInstance().view;n.aspect=o.width/o.height}n.fovy=a.yfov,t.camera=n;break;case"orthographic":n=e.OrthographicCamera.create(),n.near=a.znear,n.far=a.zfar,n.left=-a.xmag,n.right=a.xmag,n.top=a.ymag,n.bottom=-a.ymag,t.camera=n;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("camera type:"+i))}},GLTFParser.prototype._parseTransform=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n={};if(1===t.length){var i=t[0];n.matrix=e.Matrix4.create(new Float32Array(i))}else if(3===t.length){var a=t[0],o=t[1],s=t[2];n.position=e.Vector3.create(a[0],a[1],a[2]),n.rotation=e.Quaternion.create(o[0],o[1],o[2],o[3]),n.scale=e.Vector3.create(s[0],s[1],s[2])}return n},__decorate([e.require(function(t){var r=this._json.extensions.KHR_materials_common.lights;e.assert(r&&r[t],e.Log.info.FUNC_NOT_EXIST("lightId:"+t))})],GLTFParser.prototype,"_parseLight",null),__decorate([e.require(function(t){var r=this._json.cameras;e.assert(r&&r[t],e.Log.info.FUNC_NOT_EXIST("cameraId:"+t))})],GLTFParser.prototype,"_parseCamera",null),GLTFParser}();e.GLTFParser=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GLTFGeometryParser(){this._arrayBufferMap=null,this._imageMap=null,this._json=null,this._materialParser=e.GLTFMaterialParser.create()}return GLTFGeometryParser.create=function(){var e=new this;return e},GLTFGeometryParser.prototype.parse=function(t,r,n,i,a){if(this._json=t,this._arrayBufferMap=i,this._imageMap=a,n.primitives.length>1){for(var o=0,s=n.primitives;o<s.length;o++){var c=s[o],u=e.GLTFUtils.createObjectData();this._setChildObjectNameWithMultiPrimitives(u,c),u.components.addChild(this._parseGeometry(c)),r.children.addChild(u)}r.isContainer=!0}else 1===n.primitives.length&&r.components.addChild(this._parseGeometry(n.primitives[0]))},GLTFGeometryParser.prototype._setChildObjectNameWithMultiPrimitives=function(e,t){e.name=t.material},GLTFGeometryParser.prototype._parseGeometry=function(t){var r=this._json,n=this._arrayBufferMap,i=null,a=null,o={},s=null,c=null,u=null,l=null,d=null;for(var h in t.attributes)if(t.attributes.hasOwnProperty(h)){var p=t.attributes[h];if(i=r.accessors[p],a=e.GLTFUtils.getBufferArrFromAccessor(r,i,n),"POSITION"===h)s=[],this._addGeometryData(s,a);else if(h.indexOf("TEXCOORD_")>-1)c=[],this._addGeometryData(c,a),this._normalizeTexCoords(c);else if("NORMAL"===h){l=[];for(var f=0,m=a;f<m.length;f++){var g=m[f];l.push(g)}}else"COLOR"===h&&(u=[],this._addGeometryData(u,a))}return d=this._getFaces(r,t.indices,l),e.GLTFUtils.addData(o,"vertices",s),e.GLTFUtils.addData(o,"colors",u),e.GLTFUtils.addData(o,"texCoords",c),e.GLTFUtils.addData(o,"faces",d),e.GLTFUtils.addData(o,"drawMode",this._parseDrawMode(t.mode)),o.material=this._materialParser.parse(r,t.material,this._imageMap),o},GLTFGeometryParser.prototype._addGeometryData=function(e,t){for(var r=0,n=t.length;r<n;r++)e.push(t[r])},GLTFGeometryParser.prototype._getFaces=function(t,r,n){var i=null,a=null,o=null,s=[];if(!r)return[];i=t.accessors[r],a=e.GLTFUtils.getBufferArrFromAccessor(t,i,this._arrayBufferMap);for(var c=0,u=a.length;c<u;c+=3){var l=a[c],d=a[c+1],h=a[c+2],p=[l,d,h];o=e.Face3.create(l,d,h),e.GeometryUtils.hasData(n)&&this._addNormalData(o.vertexNormals,n,p),s.push(o)}return s},GLTFGeometryParser.prototype._addNormalData=function(e,t,r){var n=r[0],i=r[1],a=r[2];e.addChildren([this._getThreeComponentData(t,n),this._getThreeComponentData(t,i),this._getThreeComponentData(t,a)])},GLTFGeometryParser.prototype._getThreeComponentData=function(t,r){var n=3*r;return e.Vector3.create(t[n],t[n+1],t[n+2])},GLTFGeometryParser.prototype._parseDrawMode=function(t){var r=null;if(!t)return null;switch(t){case 0:r=e.EDrawMode.POINTS;break;case 1:r=e.EDrawMode.LINES;break;case 2:r=e.EDrawMode.LINE_LOOP;break;case 3:r=e.EDrawMode.LINE_STRIP;break;case 4:r=e.EDrawMode.TRIANGLES;break;case 5:r=e.EDrawMode.TRIANGLE_STRIP;break;case 6:r=e.EDrawMode.TRANGLE_FAN;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("mode:"+t))}return r},GLTFGeometryParser.prototype._normalizeTexCoords=function(e){if(e)for(var t=0,r=e.length/2;t<r;t++)e[2*t+1]=1-e[2*t+1]},__decorate([e.require(function(t,r,n){var i=null,a=null;return r?(i=t.accessors[r],a=e.GLTFUtils.getBufferArrFromAccessor(t,i,this._arrayBufferMap),void e.assert(a.length%3===0,e.Log.info.FUNC_SHOULD("indices' count","3 times"))):[]})],GLTFGeometryParser.prototype,"_getFaces",null),GLTFGeometryParser}();e.GLTFGeometryParser=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GLTFMaterialParser(){this._imageMap=null,this._json=null}return GLTFMaterialParser.create=function(){var e=new this;return e},GLTFMaterialParser.prototype.parse=function(t,r,n){var i=null,a=null;if(this._json=t,this._imageMap=n,!this._isUseKHRMaterialExtension()){e.Log.log("no KHR_materials_common extension found, will use default material instead");var o={type:"BasicMaterial",doubleSided:!1};return o}var s={};return i=t.materials[r],e.Log.error(!i.extensions||!i.extensions.KHR_materials_common,e.Log.info.FUNC_SHOULD("materials","define KHR_materials_common extensions")),a=i.extensions.KHR_materials_common,e.GLTFUtils.addData(s,"doubleSided",a.doubleSided),e.GLTFUtils.addData(s,"transparent",Boolean(a.transparent)),s.type=this._getMaterialType(a.technique),s.lightModel=this._getLightModel(a.technique),this._addMaterialExtensionValues(s,a.values),s},GLTFMaterialParser.prototype._isUseKHRMaterialExtension=function(){var e=this._json.extensionsUsed;return!!e&&e.indexOf("KHR_materials_common")>-1},GLTFMaterialParser.prototype._getMaterialType=function(t){var r=null;switch(t){case"PHONG":case"BLINN":case"CONSTANT":case"LAMBERT":r="LightMaterial";break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("technique:"+t))}return r},GLTFMaterialParser.prototype._getLightModel=function(t){var r=null;switch(t){case"PHONG":r=e.ELightModel.PHONG;break;case"BLINN":r=e.ELightModel.BLINN;break;case"CONSTANT":r=e.ELightModel.CONSTANT;break;case"LAMBERT":r=e.ELightModel.LAMBERT;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("technique:"+t))}return r},GLTFMaterialParser.prototype._addMaterialExtensionValues=function(t,r){r&&(r.ambient&&e.Log.warn(e.Log.info.FUNC_NOT_SUPPORT("ambient of material")),this._addMaterialLightColor(t,"diffuse",r.diffuse),this._addMaterialLightColor(t,"specular",r.specular),this._addMaterialLightColor(t,"emission",r.emission),r.shininess&&(t.shininess=r.shininess.value),r.transparency&&(t.opacity=r.transparency.value))},GLTFMaterialParser.prototype._addMaterialLightColor=function(t,r,n){n&&(e.JudgeUtils.isArrayExactly(n)?t[r+"Color"]=e.GLTFUtils.getColor(n):this._isColor(n.type)?t[r+"Color"]=e.GLTFUtils.getColor(n.value):t[r+"Map"]=this._getTexture(n.value))},GLTFMaterialParser.prototype._isColor=function(e){return 35666===Number(e)},GLTFMaterialParser.prototype._getTexture=function(t){var r=null,n=null;return this._json.textures&&this._json.textures[t]?(r=this._json.textures[t],n=this._createTextureAsset(r.target,r.source),r.internalFormat!==r.format&&e.Log.warn("texture.internalFormat("+r.internalFormat+") !== texture.format("+r.format+"), here take texture.format value as their value"),r.format&&(n.format=this._getTextureFormat(r.format)),r.type&&(n.type=this._getTextureType(r.type)),this._addTextureSampler(n,r.sampler),n.toTexture()):null},GLTFMaterialParser.prototype._createTextureAsset=function(t,r){var n=null,i=this._imageMap.getChild(r);switch(i||e.Log.warn("no image found in loader(id:"+r+")"),t){case 3553:n=e.ImageTextureAsset.create(i);break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("target except TEXTURE_2D"))}return n},GLTFMaterialParser.prototype._getTextureType=function(t){var r=null;switch(t){case 5121:r=e.ETextureType.UNSIGNED_BYTE;break;case 33635:r=e.ETextureType.UNSIGNED_SHORT_5_6_5;break;case 32819:r=e.ETextureType.UNSIGNED_SHORT_4_4_4_4;break;case 32820:r=e.ETextureType.UNSIGNED_SHORT_5_5_5_1;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("texture->type:"+t))}return r},GLTFMaterialParser.prototype._getTextureFormat=function(t){var r=null;switch(t){case 6406:r=e.ETextureFormat.ALPHA;break;case 6407:r=e.ETextureFormat.RGB;break;case 6408:r=e.ETextureFormat.RGBA;break;case 6409:r=e.ETextureFormat.LUMINANCE;break;case 6410:r=e.ETextureFormat.LUMINANCE_ALPHA;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("texture->format:"+t))}return r},GLTFMaterialParser.prototype._addTextureSampler=function(e,t){var r=this._json.samplers[t];e.wrapT=this._getTextureWrap(r.wrapT),e.wrapS=this._getTextureWrap(r.wrapS),e.minFilter=this._getTextureFilter(r.minFilter),e.magFilter=this._getTextureFilter(r.magFilter)},GLTFMaterialParser.prototype._getTextureFilter=function(t){var r=null;switch(t){case 9728:r=e.ETextureFilterMode.NEAREST;break;case 9729:r=e.ETextureFilterMode.LINEAR;break;case 9984:r=e.ETextureFilterMode.NEAREST_MIPMAP_MEAREST;break;case 9985:r=e.ETextureFilterMode.LINEAR_MIPMAP_NEAREST;break;case 9986:r=e.ETextureFilterMode.NEAREST_MIPMAP_LINEAR;break;case 9987:r=e.ETextureFilterMode.LINEAR_MIPMAP_LINEAR;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("texture filter:"+t))}return r},GLTFMaterialParser.prototype._getTextureWrap=function(t){var r=null;switch(t){case 33071:r=e.ETextureWrapMode.CLAMP_TO_EDGE;break;case 33648:r=e.ETextureWrapMode.MIRRORED_REPEAT;break;case 10497:r=e.ETextureWrapMode.REPEAT;break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("texture wrap:"+t))}return r},__decorate([e.require(function(t,r){e.assert(!!this._json.samplers[r],e.Log.info.FUNC_NOT_EXIST("samplerId:"+r))})],GLTFMaterialParser.prototype,"_addTextureSampler",null),GLTFMaterialParser}();e.GLTFMaterialParser=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GLTFArticulatedAnimationParser(){this._arrayBufferMap=null,this._json=null,this._translationArrayOffset=null,this._rotationArrayOffset=null,this._scaleArrayOffset=null}return GLTFArticulatedAnimationParser.create=function(){var e=new this;return e},GLTFArticulatedAnimationParser.prototype.parse=function(t,r,n){var i=this,a=wdCb.Hash.create(),o=this;this._json=t,this._arrayBufferMap=n;var s=function(s){if(t.animations.hasOwnProperty(s)){for(var c=t.animations[s],u=wdCb.Hash.create(),l=0,d=c.channels.length;l<d;l++){var h=c.channels[l],p=h.target.id;u.appendChild(p,h)}u.forEach(function(u,l){var d=wdCb.Collection.create(),h=o._findNode(r,l),p=null,f=null;
if(null===h)return void e.Log.warn("can't find node whose id is "+l+" to attach to animation named "+s);o._addAnimationToNode(a,l,h,o._getAnimName(c,s),d),p=o._getInputData(c,u),f=e.GLTFUtils.getBufferArrFromAccessor(t,t.accessors[p],n),i._translationArrayOffset=0,i._rotationArrayOffset=0,i._scaleArrayOffset=0;for(var m=0;m<f.length;m++){var g={};g.time=i._convertSecondToMillisecond(f[m]),g.targets=i._getKeyFrameDataTargets(c,u),d.addChild(g)}})}};for(var c in t.animations)s(c);this._addAnimationComponent(a)},GLTFArticulatedAnimationParser.prototype._getAnimName=function(e,t){return e.name?e.name:t},GLTFArticulatedAnimationParser.prototype._getInputData=function(e,t){var r=null;return t.forEach(function(t){var n=e.samplers[t.sampler];if(n)return r=e.parameters[n.input],wdCb.$BREAK}),r},GLTFArticulatedAnimationParser.prototype._addAnimationToNode=function(e,t,r,n,i){e.hasChild(t)||e.addChild(t,{node:r,animationData:{}}),e.getChild(t).animationData[n]=i},GLTFArticulatedAnimationParser.prototype._getKeyFrameDataTargets=function(t,r){var n=this,i=wdCb.Collection.create();return r.forEach(function(r){var a=t.samplers[r.sampler],o=null,s=null,c=null,u={};if(a){switch(c=r.target.path,o=t.parameters[a.output],s=e.GLTFUtils.getBufferArrFromAccessor(n._json,n._json.accessors[o],n._arrayBufferMap),u.interpolationMethod=n._convertTointerpolationMethod(a.interpolation),c){case"translation":u.target=e.EArticulatedAnimationTarget.TRANSLATION,u.data=e.Vector3.create(s[n._translationArrayOffset],s[n._translationArrayOffset+1],s[n._translationArrayOffset+2]),n._translationArrayOffset+=3;break;case"rotation":u.target=e.EArticulatedAnimationTarget.ROTATION,u.data=e.Quaternion.create(s[n._rotationArrayOffset],s[n._rotationArrayOffset+1],s[n._rotationArrayOffset+2],s[n._rotationArrayOffset+3]),n._rotationArrayOffset+=4;break;case"scale":u.target=e.EArticulatedAnimationTarget.SCALE,u.data=e.Vector3.create(s[n._scaleArrayOffset],s[n._scaleArrayOffset+1],s[n._scaleArrayOffset+2]),n._scaleArrayOffset+=3;break;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("path:"+c))}i.addChild(u)}}),i},GLTFArticulatedAnimationParser.prototype._findNode=function(e,t){var r=function(e){var n=e.findOne(function(e){return e.id===t});return n?n:(e.forEach(function(e){if(n=r(e.children))return wdCb.$BREAK}),n)};return r(e)},GLTFArticulatedAnimationParser.prototype._addAnimationComponent=function(e){e.forEach(function(e){var t=e.node,r=e.animationData;t.components.addChild(r)})},GLTFArticulatedAnimationParser.prototype._convertSecondToMillisecond=function(e){return 1e3*e},GLTFArticulatedAnimationParser.prototype._convertTointerpolationMethod=function(t){switch(t){case"LINEAR":return e.EKeyFrameInterpolation.LINEAR;default:e.Log.error(!0,e.Log.info.FUNC_NOT_SUPPORT("interpolation:"+t))}},__decorate([e.require(function(t,r){var n=wdCb.Collection.create();for(var i in t.samplers)if(t.samplers.hasOwnProperty(i)){var a=t.samplers[i];n.addChild(a.input)}e.assert(1===n.removeRepeatItems().getCount(),e.Log.info.FUNC_SHOULD("all sampler->input","be the same"))})],GLTFArticulatedAnimationParser.prototype,"_getInputData",null),__decorate([e.ensure(function(t,r){r.forEach(function(t){var r=t.node;t.animationData;e.assert(r.components.filter(function(t){return e.GLTFUtils.isIGLTFArticulatedAnimation(t)}).getCount()<=1,e.Log.info.FUNC_SHOULD("node","only has 1 IGLTFArticulatedAnimation component"))})})],GLTFArticulatedAnimationParser.prototype,"_addAnimationComponent",null),GLTFArticulatedAnimationParser}();e.GLTFArticulatedAnimationParser=t}(wd||(wd={}));var wd;!function(e){var t=function(){function GLTFUtils(){}return GLTFUtils.addData=function(e,t,r){void 0!==r&&null!==r&&(e[t]=r)},GLTFUtils.isBase64=function(e){return!(e.length<5)&&"data:"===e.substr(0,5)},GLTFUtils.decodeArrayBuffer=function(e){for(var t=e.split(",")[1],r=atob(t),n=r.length,i=new Uint8Array(new ArrayBuffer(n)),a=0;a<n;a++)i[a]=r.charCodeAt(a);return i.buffer},GLTFUtils.createObjectData=function(){return{id:null,isContainer:!1,components:wdCb.Collection.create(),children:wdCb.Collection.create()}},GLTFUtils.getColor=function(t){var r=e.Color.create();return r.r=Number(t[0]),r.g=Number(t[1]),r.b=Number(t[2]),4===t.length&&(r.a=Number(t[3])),r},GLTFUtils.getBufferArrFromAccessor=function(t,r,n){var i=t.bufferViews[r.bufferView],a=n.getChild(i.buffer),o=r.byteOffset+i.byteOffset,s=r.count*this.getAccessorTypeSize(r);switch(r.componentType){case 5120:return new Int8Array(a,o,s);case 5121:return new Uint8Array(a,o,s);case 5122:return new Int16Array(a,o,s);case 5123:return new Uint16Array(a,o,s);case 5126:return new Float32Array(a,o,s);default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("componentType:"+r.componentType))}},GLTFUtils.getAccessorTypeSize=function(e){var t=e.type;switch(t){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}},GLTFUtils.isIGLTFArticulatedAnimation=function(t){if(!e.JudgeUtils.isDirectObject(t))return!1;for(var r in t)return t[r]instanceof wdCb.Collection&&t[r].getCount()>0&&void 0!==t[r].getChild(0).time},GLTFUtils}();e.GLTFUtils=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.CONTAINER="CONTAINER"]="CONTAINER"}(e.EWDTag||(e.EWDTag={}));e.EWDTag}(wd||(wd={}));var wd;!function(e){var t=function(t){function WDLoader(){t.call(this),this._parseData=null}return __extends(WDLoader,t),WDLoader.getInstance=function(){},WDLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=this;return e.AjaxLoader.load(n,"json").flatMap(function(t){return i._parseData=e.WDParser.create().parse(t),i._createLoadMapStream(n,i._parseData)}).lastOrDefault().map(function(){return e.WDBuilder.create().build(i._parseData)})},WDLoader.prototype._createLoadMapStream=function(t,r){var n=[];return r.materials.forEach(function(e){var t=[];e.diffuseMapUrl&&t.push(["diffuseMap",e.diffuseMapUrl,e]),e.specularMapUrl&&t.push(["specularMap",e.specularMapUrl,e]),e.normalMapUrl&&t.push(["normalMap",e.normalMapUrl,e]),n=n.concat(t)}),wdFrp.fromArray(n).flatMap(function(r){var n=r[0],i=r[1],a=r[2];return e.TextureLoader.getInstance().load(e.ModelLoaderUtils.getPath(t,i)).do(function(e){a[n]=e.toTexture()})})},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],WDLoader.prototype,"loadAsset",null),WDLoader=__decorate([e.singleton()],WDLoader)}(e.Loader);e.WDLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(){function WDParser(){this._data={},this._objectParser=e.WDObjectParser.create()}return WDParser.create=function(){var e=new this;return e},WDParser.prototype.parse=function(e){return this._parseMetadata(e),this._parseScene(e),this._parseMaterial(e),this._parseObject(e),this._data},WDParser.prototype._parseMetadata=function(e){this._data.metadata=e.metadata},WDParser.prototype._parseObject=function(e){this._objectParser.parse(this._data,e)},WDParser.prototype._parseScene=function(e){this._data.scene=e.scene,e.scene.ambientColor&&(this._data.scene.ambientColor=this._createColor(e.scene.ambientColor))},WDParser.prototype._parseMaterial=function(e){var t=this;this._data.materials=wdCb.Hash.create(e.materials),this._data.materials.forEach(function(e){e.diffuseColor&&(e.diffuseColor=t._createColor(e.diffuseColor)),e.specularColor&&(e.specularColor=t._createColor(e.specularColor))})},WDParser.prototype._createColor=function(t){return e.Color.create("rgb("+t.join(",").replace(/^(\d+),/g,"$1.0,").replace(/,(\d+),/g,",$1.0,").replace(/,(\d+)$/g,",$1.0")+")")},WDParser}();e.WDParser=t}(wd||(wd={}));var wd;!function(e){var t=function(){function WDObjectParser(){}return WDObjectParser.create=function(){var e=new this;return e},WDObjectParser.prototype.parse=function(e,t){var r=null,n=this;e.objects=wdCb.Collection.create(t.objects),r=function(e){n._isObjectContainer(e)?e.isContainer=!0:(e.isContainer=!1,n._parseFromIndices(e)),e.children&&(e.children=wdCb.Collection.create(e.children),e.children.forEach(function(t){t.parent=e,r(t)}))},e.objects.forEach(function(e){e.parent=null,r(e),n._removeObjectContainerData(e)})},WDObjectParser.prototype._isObjectContainer=function(t){return!e.GeometryUtils.hasData(t.verticeIndices)},WDObjectParser.prototype._parseFromIndices=function(e){this._duplicateVertexWithDifferentUvs(e),this._parseObjectFromIndices(e),this._removeRebundantIndiceData(e)},WDObjectParser.prototype._duplicateVertexWithDifferentUvs=function(t){var r=[],n=wdCb.Hash.create(),i=t.verticeIndices,a=t.uvIndices;if(e.GeometryUtils.hasData(a))for(var o=0,s=i.length;o<s;o++){var c=i[o];this._isSameVertexWithDifferentUvsByCompareToFirstOne(r,a[o],c)&&(this._isUvIndiceEqualTheOneOfAddedVertex(n,c,a[o])?i[o]=this._getVerticeIndexOfAddedVertexByFindContainer(n,c,a[o]):this._addVertexData(t,n,c,o),c=i[o]),r[c]=a[o]}},WDObjectParser.prototype._isSameVertexWithDifferentUvsByCompareToFirstOne=function(e,t,r){return void 0!==e[r]&&e[r]!==t},WDObjectParser.prototype._addVertexData=function(t,r,n,i){var a=t.verticeIndices,o=t.uvIndices,s=t.normalIndices,c=this._findData(t,"vertices"),u=this._findData(t,"normals"),l=this._findData(t,"morphTargets"),d=null;if(this._addThreeComponent(c,n),d=this._getVerticeIndexOfAddedVertex(c),a[i]=d,e.GeometryUtils.hasData(l))for(var h=0,p=l;h<p.length;h++){var f=p[h];this._addThreeComponent(f.vertices,n),e.GeometryUtils.hasData(f.normals)&&this._addDuplicateNormalOfAddedVertex(f.normals,s,i,n)}e.GeometryUtils.hasData(u)&&(this._addDuplicateNormalOfAddedVertex(u,s,i,n),e.GeometryUtils.hasData(s)&&(s[i]=d)),r.appendChild(String(n),[o[i],d])},WDObjectParser.prototype._addDuplicateNormalOfAddedVertex=function(t,r,n,i){return e.GeometryUtils.hasData(r)?void this._addThreeComponent(t,t,r[n]):void this._addThreeComponent(t,t,i)},WDObjectParser.prototype._isUvIndiceEqualTheOneOfAddedVertex=function(e,t,r){var n=e.getChild(String(t));return!!n&&n.hasChildWithFunc(function(e){var t=e[0];e[1];return t===r})},WDObjectParser.prototype._getVerticeIndexOfAddedVertexByFindContainer=function(e,t,r){var n=e.getChild(String(t));return n.findOne(function(e){var t=e[0];e[1];return t===r})[1]},WDObjectParser.prototype._getVerticeIndexOfAddedVertex=function(e){return e.length/3-1},WDObjectParser.prototype._addThreeComponent=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(2===e.length){var r=e[0],n=e[1];r.push(r[3*n],r[3*n+1],r[3*n+2])}else{var i=e[0],a=e[1],n=e[2];i.push(a[3*n],a[3*n+1],a[3*n+2])}},WDObjectParser.prototype._parseObjectFromIndices=function(t){for(var r=[],n=[],i=null,a=this._findData(t,"vertices"),o=this._findData(t,"uvs"),s=this._findData(t,"normals"),c=this._findData(t,"colors"),u=0,l=t.verticeIndices.length;u<l;u+=3){var d=t.verticeIndices[u],h=t.verticeIndices[u+1],p=t.verticeIndices[u+2],f=[u,u+1,u+2],m=[d,h,p];i=e.Face3.create(d,h,p),e.GeometryUtils.hasData(t.uvIndices)&&e.GeometryUtils.hasData(o)&&this._setUV(r,o,t.uvIndices,f,m),e.GeometryUtils.hasData(s)&&this._setNormal(i.vertexNormals,s,t.normalIndices,f,m),n.push(i)}t.vertices=a,e.GeometryUtils.hasData(t.uvIndices)?t.uvs=r:t.uvs=o,t.colors=c,t.faces=n,this._setMorphTargets(t,t.verticeIndices,t.normalIndices)},WDObjectParser.prototype._getAnimName=function(e){var t=/([a-z]+)_?(\d+)/,r="default",n=e.match(t);return n&&n.length>1?n[1]:r},WDObjectParser.prototype._removeRebundantIndiceData=function(e){delete e.verticeIndices,delete e.uvIndices,delete e.normalIndices},WDObjectParser.prototype._removeObjectContainerData=function(e){var t=null;(t=function(e){e.isContainer&&(delete e.vertices,delete e.uvs,delete e.colors),e.children&&e.children.forEach(function(e){t(e)})})(e)},WDObjectParser.prototype._findData=function(e,t){var r=null;do r=e[t];while(!r&&null!==(e=e.parent));return r},WDObjectParser.prototype._setUV=function(e,t,r,n,i){var a=null,o=null,s=null,c=n[0],u=n[1],l=n[2],d=i[0],h=i[1],p=i[2];a=r[c],o=r[u],s=r[l],this._setTwoComponentData(e,t,d,a),this._setTwoComponentData(e,t,h,o),this._setTwoComponentData(e,t,p,s)},WDObjectParser.prototype._setTwoComponentData=function(e,t,r,n){e[2*r]=t[2*n],e[2*r+1]=t[2*n+1]},WDObjectParser.prototype._setThreeComponentData=function(e,t,r,n){e[3*r]=t[3*n],e[3*r+1]=t[3*n+1],e[3*r+2]=t[3*n+2]},WDObjectParser.prototype._getThreeComponentData=function(t,r){var n=3*r;return e.Vector3.create(t[n],t[n+1],t[n+2])},WDObjectParser.prototype._setNormal=function(t,r,n,i,a){var o=i[0],s=i[1],c=i[2];return e.GeometryUtils.hasData(n)?void this._addNormalData(t,r,[n[o],n[s],n[c]]):void this._addNormalData(t,r,a)},WDObjectParser.prototype._addNormalData=function(e,t,r){var n=r[0],i=r[1],a=r[2];if(e instanceof wdCb.Collection)e.addChildren([this._getThreeComponentData(t,n),this._getThreeComponentData(t,i),this._getThreeComponentData(t,a)]);else for(var o=e,s=0,c=[this._getThreeComponentData(t,n),this._getThreeComponentData(t,i),this._getThreeComponentData(t,a)];s<c.length;s++){var u=c[s];o.push(u.x,u.y,u.z)}},WDObjectParser.prototype._setMorphTargets=function(t,r,n){var i=this._findData(t,"morphTargets"),a=null,o=null;if(e.GeometryUtils.hasData(i)){a=wdCb.Hash.create(),o=wdCb.Hash.create();for(var s=0,c=i;s<c.length;s++){var u=c[s],l=this._getAnimName(u.name);if(a.appendChild(l,u.vertices),e.GeometryUtils.hasData(u.normals))if(e.GeometryUtils.hasData(n)){for(var d=[],h=0,p=r.length;h<p;h++)this._setThreeComponentData(d,u.normals,r[h],n[h]);o.appendChild(l,d)}else o.appendChild(l,u.normals)}}t.morphTargets=a,t.morphNormals=o},__decorate([e.require(function(t,r,n){e.assert(this._isUvIndiceEqualTheOneOfAddedVertex(t,r,n),e.Log.info.FUNC_SHOULD("uvIndex","equal the one of added vertex"))})],WDObjectParser.prototype,"_getVerticeIndexOfAddedVertexByFindContainer",null),__decorate([e.ensure(function(t,r){e.assert(!r.verticeIndices,e.Log.info.FUNC_SHOULD("object.verticeIndices","be removed")),e.assert(!r.uvIndices,e.Log.info.FUNC_SHOULD("object.uvIndices","be removed")),e.assert(!r.normalIndices,e.Log.info.FUNC_SHOULD("object.normalIndices","be removed"))})],WDObjectParser.prototype,"_removeRebundantIndiceData",null),WDObjectParser}();e.WDObjectParser=t}(wd||(wd={}));var wd;!function(e){var t=function(){function WDBuilder(){this._result=wdCb.Hash.create()}return WDBuilder.create=function(){var e=new this;return e},WDBuilder.prototype.build=function(e){return this._buildMetadata(e),this._buildScene(e),this._buildModels(e),this._result},WDBuilder.prototype._buildMetadata=function(e){var t=wdCb.Hash.create();for(var r in e.metadata)e.metadata.hasOwnProperty(r)&&t.addChild(r,e.metadata[r]);this._result.addChild("metadata",t)},WDBuilder.prototype._buildScene=function(e){var t=wdCb.Hash.create();e.scene.ambientColor&&t.addChild("ambientColor",e.scene.ambientColor),this._result.addChild("scene",t)},WDBuilder.prototype._buildModels=function(t){var r=wdCb.Collection.create(),n=this,i=null;i=function(r,a){r.forEach(function(r){var o=null,s=null;s=e.GameObject.create(),n._isModelContainer(r)?s.addTag(e.EWDTag.CONTAINER):(o=e.ModelGeometry.create(),o.vertices=r.vertices,o.faces=r.faces,o.texCoords=r.uvs,o.colors=r.colors,r.material&&(o.material=n._buildMaterial(r.material,t.materials)),o.morphTargets=r.morphTargets,o.morphFaceNormals=r.morphNormals,o.morphVertexNormals=r.morphNormals,e.GeometryUtils.hasData(o.morphTargets)&&s.addComponent(e.MorphAnimation.create()),s.addComponent(o)),s.name=r.name,s.addComponent(e.MeshRenderer.create()),a.addChild(s),r.children&&i(r.children,s)})},i(t.objects,r),this._result.addChild("models",r)},WDBuilder.prototype._isModelContainer=function(e){return e.isContainer},WDBuilder.prototype._buildMaterial=function(t,r){var n="LightMaterial",i=null,a=null,o=null;return s=r.findOne(function(e,r){return r===t}),i=s[1],a=i.type||n,wdCb.Log.error(!e[a],wdCb.Log.info.FUNC_NOT_EXIST("materialClass:"+a)),o=e[a].create(),o.name=t,i.diffuseColor&&(o.color=i.diffuseColor),i.specularColor&&(o.specularColor=i.specularColor),i.diffuseMap&&(o.diffuseMap=i.diffuseMap),i.specularMap&&(o.specularMap=i.specularMap),i.normalMap&&(o.normalMap=i.normalMap),null!==i.shininess&&(o.shininess=i.shininess),null!==i.opacity&&(o.opacity=i.opacity),o;var s},WDBuilder}();e.WDBuilder=t}(wd||(wd={}));var wd;!function(e){var t={".eot":"embedded-opentype",".ttf":"truetype",".woff":"woff",".svg":"svg"},r=function(r){function FontLoader(){r.call(this),this._familyName=null}return __extends(FontLoader,r),FontLoader.getInstance=function(){},FontLoader.prototype.dispose=function(){r.prototype.dispose.call(this),wdCb.DomQuery.create("#"+this._familyName).remove()},FontLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[1],i=this;return this._familyName=n,wdFrp.fromPromise(new RSVP.Promise(function(r,a){i._addStyleElement(t,n),document.fonts?document.fonts.load("1em "+n).then(function(){r()},function(e){a(e)}):(e.Log.warn("your browser not support document.fonts api, so it can't ensure that the font is loaded"),r())}))},FontLoader.prototype._getType=function(e){return t[wdCb.PathUtils.extname(e).toLowerCase()]},FontLoader.prototype._addStyleElement=function(t,r){var n=wdCb.DomQuery.create('<style id="'+r+'"></style>'),i=null;if(n.prependTo("body"),i="@font-face { font-family:"+r+"; src:",e.JudgeUtils.isArrayExactly(t[0])){for(var a=t[0],o=0,s=a;o<s.length;o++){var c=s[o];i+="url('"+c+"') format('"+this._getType(c)+"'),"}i=i.replace(/,$/,";")}else{var c=t[0];i+="url('"+c+"') format('"+this._getType(c)+"');"}n.get(0).textContent+=i+"};"},__decorate([e.require(function(r){var n=wdCb.PathUtils.extname(r).toLowerCase();e.assert(!!t[n],e.Log.info.FUNC_UNKNOW("type:"+n))})],FontLoader.prototype,"_getType",null),FontLoader=__decorate([e.singleton()],FontLoader)}(e.Loader);e.FontLoader=r}(wd||(wd={}));var wd;!function(e){var t=/common [^\n]*(\n|$)/gi,r=/page [^\n]*(\n|$)/gi,n=/char [^\n]*(\n|$)/gi,i=/kerning [^\n]*(\n|$)/gi,a=/\w+=[^ \r\n]+/gi,o=/^[\-]?\d+$/,s=function(){function FntParser(){}return FntParser.create=function(){var e=new this;return e},FntParser.prototype.parseFnt=function(n,i){var a={},o=null,s=null;return o=this._parseStrToObj(n.match(t)[0]),a.commonHeight=o.lineHeight,a.commonBase=o.base,a.scaleW=o.scaleW,a.scaleH=o.scaleH,1!==o.pages?a.isMultiPages=!0:a.isMultiPages=!1,s=this._parseStrToObj(n.match(r)[0]),0!==s.id&&e.Log.log("file could not be found"),a.atlasName=wdCb.PathUtils.changeBasename(i,s.file),this._parseChar(n,a),this._parseKerning(n,a),a},FntParser.prototype._parseStrToObj=function(e){var t=e.match(a),r={};if(t)for(var n=0,i=t;n<i.length;n++){var s=i[n],c=s.indexOf("="),u=s.substring(0,c),l=s.substring(c+1);l.match(o)?l=parseInt(l):'"'==l[0]&&(l=l.substring(1,l.length-1)),r[u]=l}return r},FntParser.prototype._parseChar=function(e,t){for(var r=e.match(n),i={},a=0,o=r;a<o.length;a++){var s=o[a],c=this._parseStrToObj(s),u=c.id;i[u]={id:u,rect:{x:c.x,y:c.y,width:c.width,height:c.height},xOffset:c.xoffset,yOffset:c.yoffset,xAdvance:c.xadvance,page:c.page}}t.fontDefDictionary=i},FntParser.prototype._parseKerning=function(e,t){var r=e.match(i),n=[];if(null===r)return void(t.kerningArray=[]);for(var a=0,o=r;a<o.length;a++){var s=o[a],c=this._parseStrToObj(s);n.push({first:c.first,second:c.second,amount:c.amount})}t.kerningArray=n},FntParser}();e.FntParser=s}(wd||(wd={}));var wd;!function(e){var t=function(t){function FntLoader(){t.call(this),this._parser=e.FntParser.create()}return __extends(FntLoader,t),FntLoader.getInstance=function(){},FntLoader.prototype.loadAsset=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0],i=this;return e.AjaxLoader.load(n,"text").map(function(e){return i._parser.parseFnt(e,n)})},__decorate([e.require(function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];e.assert(!e.JudgeUtils.isArrayExactly(t[0]),e.Log.info.FUNC_MUST_BE("url","string"))})],FntLoader.prototype,"loadAsset",null),FntLoader=__decorate([e.singleton()],FntLoader)}(e.Loader);e.FntLoader=t}(wd||(wd={}));var wd;!function(e){var t=function(){function DeviceManager(){this._scissorTest=!1,this._depthTest=null,this._depthFunc=null,this._side=null,this.polygonOffset=null,this._polygonOffsetMode=null,this._depthWrite=null,this._blend=null,this._alphaToCoverage=null,this.view=null,this.gl=null,this.contextConfig=null,this._writeRed=null,this._writeGreen=null,this._writeBlue=null,this._writeAlpha=null,this._blendSrc=null,this._blendDst=null,this._blendEquation=null,this._blendFuncSeparate=null,this._blendEquationSeparate=null,this._scissorRegion=e.RectRegion.create(),this._viewport=e.RectRegion.create(),this._clearColor=null,this._pixelRatio=null}return DeviceManager.getInstance=function(){},Object.defineProperty(DeviceManager.prototype,"scissorTest",{get:function(){return this._scissorTest},set:function(e){var t=this.gl;this._scissorTest!==e&&(e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST),this._scissorTest=e)},enumerable:!0,configurable:!0}),DeviceManager.prototype.setScissor=function(e,t,r,n){this._scissorRegion.y===t&&this._scissorRegion.width===r&&this._scissorRegion.height===n||(this.gl.scissor(e,t,r,n),this._scissorRegion.set(e,t,r,n),this.scissorTest=!0)},DeviceManager.prototype.setViewport=function(e,t,r,n){this._viewport.x===e&&this._viewport.y===t&&this._viewport.width===r&&this._viewport.height===n||(this._viewport.set(e,t,r,n),this.gl.viewport(e,t,r,n))},DeviceManager.prototype.getViewport=function(){return this._viewport},Object.defineProperty(DeviceManager.prototype,"depthTest",{get:function(){return this._depthTest},set:function(e){var t=this.gl;this._depthTest!==e&&(e?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this._depthTest=e)},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(e){var t=this.gl;this._depthFunc!==e&&(t.depthFunc(t[e]),this._depthFunc=e)},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"side",{get:function(){return this._side},set:function(t){var n=this.gl;if(this._side!==t){switch(t){case r.NONE:n.enable(n.CULL_FACE),n.cullFace(n.FRONT_AND_BACK);break;case r.BOTH:n.disable(n.CULL_FACE);break;case r.FRONT:n.enable(n.CULL_FACE),n.cullFace(n.BACK);break;case r.BACK:n.enable(n.CULL_FACE),n.cullFace(n.FRONT);break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("side",t))}this._side=t}},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"polygonOffsetMode",{get:function(){return this._polygonOffsetMode},set:function(t){var r=this.gl;if(this._polygonOffsetMode!==t){switch(t){case n.NONE:r.polygonOffset(0,0),r.disable(r.POLYGON_OFFSET_FILL);break;case n.IN:r.enable(r.POLYGON_OFFSET_FILL),r.polygonOffset(1,1);break;case n.OUT:r.enable(r.POLYGON_OFFSET_FILL),r.polygonOffset(-1,-1);break;case n.CUSTOM:r.enable(r.POLYGON_OFFSET_FILL),e.Log.error(!this.polygonOffset,e.Log.info.FUNC_MUST_DEFINE("polygonOffset")),r.polygonOffset(this.polygonOffset.x,this.polygonOffset.y)}this._polygonOffsetMode=t}},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"depthWrite",{get:function(){return this._depthWrite},set:function(e){this._depthWrite!==e&&(this.gl.depthMask(e),this._depthWrite=e)},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"blend",{get:function(){return this._blend},set:function(e){var t=this.gl;this._blend!==e&&(e?t.enable(t.BLEND):t.disable(t.BLEND),this._blend=e)},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"alphaToCoverage",{get:function(){return this._alphaToCoverage},set:function(e){var t=this.gl;this._alphaToCoverage!==e&&(e?t.enable(t.SAMPLE_ALPHA_TO_COVERAGE):t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),this._alphaToCoverage=e)},enumerable:!0,configurable:!0}),DeviceManager.prototype.setBlendFunc=function(e,t){this._blendSrc===e&&this._blendDst===t||(this._blend&&this.gl.blendFunc(this.gl[e],this.gl[t]),this._blendSrc=e,this._blendDst=t)},DeviceManager.prototype.setBlendEquation=function(e){this._blendEquation!==e&&(this._blend&&this.gl.blendEquation(this.gl[e]),this._blendEquation=e)},DeviceManager.prototype.setBlendFuncSeparate=function(e){var t=this.gl;this._blendFuncSeparate&&this._blendFuncSeparate[0]===e[0]&&this._blendFuncSeparate[1]===e[1]||(this._blend&&t.blendFuncSeparate(t[e[0]],t[e[1]],t[e[2]],t[e[3]]),this._blendFuncSeparate=e)},DeviceManager.prototype.setBlendEquationSeparate=function(e){var t=this.gl;this._blendEquationSeparate&&this._blendEquationSeparate[0]===e[0]&&this._blendEquationSeparate[1]===e[1]||(this._blend&&t.blendEquationSeparate(t[e[0]],t[e[1]]),this._blendEquationSeparate=e)},DeviceManager.prototype.setColorWrite=function(e,t,r,n){this._writeRed===e&&this._writeGreen===t&&this._writeBlue===r&&this._writeAlpha===n||(this.gl.colorMask(e,t,r,n),this._writeRed=e,this._writeGreen=t,this._writeBlue=r,this._writeAlpha=n)},DeviceManager.prototype.clear=function(e){var t=this.gl,r=e.color;this._setClearColor(r),this.setColorWrite(!0,!0,!0,!0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT)},DeviceManager.prototype.createGL=function(t,r,n){var i=null;this.contextConfig=r,i=t?wdCb.DomQuery.create(this._getCanvasId(t)).get(0):wdCb.DomQuery.create("<canvas></canvas>").prependTo("body").get(0),this.view=e.ViewWebGL.create(i),n&&this.setPixelRatio(window.devicePixelRatio),this.gl=this.view.getContext(r)},DeviceManager.prototype.setScreen=function(){var t=e.Main.screenSize,r=null,n=null,i=null,a=null,o=null,s=null;t===e.EScreenSize.FULL?(r=0,n=0,i=e.root.innerWidth,a=e.root.innerHeight,o="100%",s="100%",wdCb.DomQuery.create("body").css("margin","0")):(r=t.x||0,n=t.y||0,i=t.width||e.root.innerWidth,a=t.height||e.root.innerHeight,o=i+"px",s=a+"px"),this.view.initCanvas(),this.view.x=r,this.view.y=n,this.view.width=i,this.view.height=a,this.view.styleWidth=o,this.view.styleHeight=s,this.setViewport(0,0,i,a)},DeviceManager.prototype.setHardwareScaling=function(e){var t=this.view.width/e,r=this.view.height/e;this.view.width=t,this.view.height=r,this.setViewport(0,0,t,r)},DeviceManager.prototype.setPixelRatio=function(e){this.view.width=Math.round(this.view.width*e),this.view.height=Math.round(this.view.height*e),this._pixelRatio=e},DeviceManager.prototype.getPixelRatio=function(){return this._pixelRatio},DeviceManager.prototype._setClearColor=function(e){this._clearColor&&this._clearColor.isEqual(e)||(this.gl.clearColor(e.r,e.g,e.b,e.a),this._clearColor=e)},DeviceManager.prototype._getCanvasId=function(e){return e.indexOf("#")>-1?e:"#"+e},__decorate([e.require(function(){e.assert(null!==e.Main.screenSize,e.Log.info.FUNC_NOT_EXIST("Main.screenSize"))})],DeviceManager.prototype,"setScreen",null),__decorate([e.require(function(t){e.assert(t>0,e.Log.info.FUNC_SHOULD("level","> 0, but actual is "+t))})],DeviceManager.prototype,"setHardwareScaling",null),__decorate([e.ensure(function(t){e.it("canvas id should be #xxx",function(){e.expect(/#[^#]+/.test(t)).true})})],DeviceManager.prototype,"_getCanvasId",null),DeviceManager=__decorate([e.singleton()],DeviceManager)}();e.DeviceManager=t,function(e){e[e.NEVER="NEVER"]="NEVER",e[e.ALWAYS="ALWAYS"]="ALWAYS",e[e.LESS="LESS"]="LESS",e[e.LEQUAL="LEQUAL"]="LEQUAL",e[e.EQUAL="EQUAL"]="EQUAL",e[e.GEQUAL="GEQUAL"]="GEQUAL",e[e.GREATER="GREATER"]="GREATER",e[e.NOTEQUAL="NOTEQUAL"]="NOTEQUAL"}(e.EDepthFunction||(e.EDepthFunction={}));e.EDepthFunction;!function(e){e[e.NONE=0]="NONE",e[e.BOTH=1]="BOTH",e[e.BACK=2]="BACK",e[e.FRONT=3]="FRONT"}(e.ESide||(e.ESide={}));var r=e.ESide;!function(e){e[e.NONE=0]="NONE",e[e.IN=1]="IN",e[e.OUT=2]="OUT",e[e.CUSTOM=3]="CUSTOM"}(e.EPolygonOffsetMode||(e.EPolygonOffsetMode={}));var n=e.EPolygonOffsetMode;!function(e){e[e.ZERO="ZEOR"]="ZERO",e[e.ONE="ONE"]="ONE",e[e.SRC_COLOR="SRC_COLOR"]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR="ONE_MINUS_SRC_COLOR"]="ONE_MINUS_SRC_COLOR",e[e.DST_COLOR="DST_COLOR"]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR="ONE_MINUS_DST_COLOR"]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA="SRC_ALPHA"]="SRC_ALPHA",e[e.SRC_ALPHA_SATURATE="SRC_ALPHA_SATURATE"]="SRC_ALPHA_SATURATE",e[e.ONE_MINUS_SRC_ALPHA="ONE_MINUS_SRC_ALPHA"]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA="DST_ALPHA"]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPH="ONE_MINUS_DST_ALPHA"]="ONE_MINUS_DST_ALPH"}(e.EBlendFunc||(e.EBlendFunc={}));e.EBlendFunc;!function(e){e[e.ADD="FUNC_ADD"]="ADD",e[e.SUBTRACT="FUNC_SUBTRACT"]="SUBTRACT",e[e.REVERSE_SUBTRAC="FUNC_REVERSE_SUBTRACT"]="REVERSE_SUBTRAC"}(e.EBlendEquation||(e.EBlendEquation={}));e.EBlendEquation;!function(e){e[e.NONE=0]="NONE",e[e.NORMAL=1]="NORMAL",e[e.ADDITIVE=2]="ADDITIVE",e[e.ADDITIVEALPHA=3]="ADDITIVEALPHA",e[e.MULTIPLICATIVE=4]="MULTIPLICATIVE",e[e.PREMULTIPLIED=5]="PREMULTIPLIED"}(e.EBlendType||(e.EBlendType={}));e.EBlendType;!function(e){e[e.TwoDUI="TwoDUI"]="TwoDUI"}(e.ECanvasType||(e.ECanvasType={}));e.ECanvasType}(wd||(wd={}));var wd;!function(e){var t=function(){function GPUDetector(){this.maxTextureUnit=null,this.maxTextureSize=null,this.maxCubemapTextureSize=null,this.maxAnisotropy=null,this.extensionCompressedTextureS3TC=null,this.extensionTextureFilterAnisotropic=null,this.extensionInstancedArrays=null,this.extensionUintIndices=null,this.extensionDepthTexture=null,this.extensionVAO=null,this.extensionStandardDerivatives=null,this.precision=null,this._isDetected=!1}return GPUDetector.getInstance=function(){},Object.defineProperty(GPUDetector.prototype,"gl",{get:function(){return e.DeviceManager.getInstance().gl},enumerable:!0,configurable:!0}),GPUDetector.prototype.detect=function(){this._isDetected=!0,this._detectExtension(),this._detectCapabilty()},GPUDetector.prototype._detectExtension=function(){this.extensionCompressedTextureS3TC=this._getExtension("WEBGL_compressed_texture_s3tc"),this.extensionTextureFilterAnisotropic=this._getExtension("EXT_texture_filter_anisotropic"),this.extensionInstancedArrays=this._getExtension("ANGLE_instanced_arrays"),this.extensionUintIndices=this._getExtension("element_index_uint"),this.extensionDepthTexture=this._getExtension("depth_texture"),this.extensionVAO=this._getExtension("vao"),this.extensionStandardDerivatives=this._getExtension("standard_derivatives")},GPUDetector.prototype._detectCapabilty=function(){var e=this.gl;this.maxTextureUnit=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxCubemapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxAnisotropy=this._getMaxAnisotropy(),this._detectPrecision()},GPUDetector.prototype._getExtension=function(e){var t,r=this.gl;switch(e){case"EXT_texture_filter_anisotropic":t=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":t=r.getExtension("WEBGL_compressed_texture_s3tc")||r.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":t=r.getExtension("WEBGL_compressed_texture_pvrtc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"ANGLE_instanced_arrays":t=r.getExtension("ANGLE_instanced_arrays");break;case"element_index_uint":t=null!==r.getExtension("OES_element_index_uint");break;case"depth_texture":t=null!==r.getExtension("WEBKIT_WEBGL_depth_texture")||null!==r.getExtension("WEBGL_depth_texture");break;case"vao":t=r.getExtension("OES_vertex_array_object");break;case"standard_derivatives":t=r.getExtension("OES_standard_derivatives");break;default:t=r.getExtension(e)}return t},GPUDetector.prototype._getMaxAnisotropy=function(){var e=this.extensionTextureFilterAnisotropic,t=this.gl;return null!==e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0},GPUDetector.prototype._detectPrecision=function(){var t=this.gl,n=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),a=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),o=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),s=n.precision>0&&a.precision>0,c=i.precision>0&&o.precision>0;
s?this.precision=r.HIGHP:c?(this.precision=r.MEDIUMP,e.Log.warn(e.Log.info.FUNC_NOT_SUPPORT("gpu","highp, using mediump"))):(this.precision=r.LOWP,e.Log.warn(e.Log.info.FUNC_NOT_SUPPORT("gpu","highp and mediump, using lowp")))},GPUDetector=__decorate([e.singleton()],GPUDetector)}();e.GPUDetector=t,function(e){e[e.HIGHP=0]="HIGHP",e[e.MEDIUMP=1]="MEDIUMP",e[e.LOWP=2]="LOWP"}(e.EGPUPrecision||(e.EGPUPrecision={}));var r=e.EGPUPrecision}(wd||(wd={}));var wd;!function(e){!function(e){e[e.FULL=0]="FULL"}(e.EScreenSize||(e.EScreenSize={}));e.EScreenSize}(wd||(wd={}));var wd;!function(e){var t=function(){function Point(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.x=null,this.y=null,this.x=e,this.y=t}return Point.create=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null);var r=new this(e,t);return r},Point}();e.Point=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Face3(e,t,r,n,i){this._faceNormal=null,this.aIndex=null,this.bIndex=null,this.cIndex=null,this.vertexNormals=null,this.aIndex=e,this.bIndex=t,this.cIndex=r,this._faceNormal=n,this.vertexNormals=i}return Face3.create=function(e,t,r,n,i){void 0===n&&(n=null),void 0===i&&(i=wdCb.Collection.create());var a=new this(e,t,r,n,i);return a},Object.defineProperty(Face3.prototype,"faceNormal",{get:function(){return null!==this._faceNormal?this._faceNormal:e.Vector3.create(0,0,0)},set:function(e){this._faceNormal=e},enumerable:!0,configurable:!0}),Face3.prototype.clone=function(){return e.CloneUtils.clone(this)},Face3.prototype.hasFaceNormal=function(){return null!==this._faceNormal},Face3.prototype.hasVertexNormal=function(){return this.vertexNormals.getCount()>0},__decorate([e.cloneAttributeAsCloneable()],Face3.prototype,"_faceNormal",void 0),__decorate([e.cloneAttributeAsBasicType()],Face3.prototype,"aIndex",void 0),__decorate([e.cloneAttributeAsBasicType()],Face3.prototype,"bIndex",void 0),__decorate([e.cloneAttributeAsBasicType()],Face3.prototype,"cIndex",void 0),__decorate([e.cloneAttributeAsCustomType(function(e,t,r){t[r]=e[r].clone(!0)})],Face3.prototype,"vertexNormals",void 0),Face3}();e.Face3=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function RectRegion(){e.apply(this,arguments)}return __extends(RectRegion,e),Object.defineProperty(RectRegion.prototype,"width",{get:function(){return this.z},set:function(e){this.z=e},enumerable:!0,configurable:!0}),Object.defineProperty(RectRegion.prototype,"height",{get:function(){return this.w},set:function(e){this.w=e},enumerable:!0,configurable:!0}),RectRegion.prototype.clone=function(){return this.copyHelper(RectRegion.create())},RectRegion.prototype.isNotEmpty=function(){return 0!==this.x||0!==this.y||0!==this.width||0!==this.height},RectRegion}(e.Vector4);e.RectRegion=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ViewWebGL(e){this._dom=null,this._dom=e}return ViewWebGL.create=function(e){var t=new this(e);return t},Object.defineProperty(ViewWebGL.prototype,"offset",{get:function(){for(var e=this._dom,t={x:e.offsetLeft,y:e.offsetTop};e=e.offsetParent;)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"dom",{get:function(){return this._dom},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"width",{get:function(){return this._dom.clientWidth},set:function(e){this._dom.width=e},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"height",{get:function(){return this._dom.clientHeight},set:function(e){this._dom.height=e},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"styleWidth",{get:function(){return this._dom.style.width},set:function(e){this._dom.style.width=e},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"styleHeight",{get:function(){return this._dom.style.height},set:function(e){this._dom.style.height=e},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"x",{get:function(){return Number(this._dom.style.left.slice(0,-2))},set:function(e){this._dom.style.left=e+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"y",{get:function(){return Number(this._dom.style.top.slice(0,-2))},set:function(e){this._dom.style.top=e+"px"},enumerable:!0,configurable:!0}),ViewWebGL.prototype.initCanvas=function(){this._dom.style.cssText="position:absolute;left:0;top:0;"},ViewWebGL.prototype.getContext=function(e){return this._dom.getContext("webgl",e.options)||this._dom.getContext("experimental-webgl",e.options)},ViewWebGL}();e.ViewWebGL=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Color(){this._r=null,this._g=null,this._b=null,this._a=null,this._colorString=null,this._colorVec3Cache=null,this._colorVec4Cache=null}return Color.create=function(e){var t=new this;return t.initWhenCreate(e),t},Object.defineProperty(Color.prototype,"dirty",{set:function(e){e&&this._clearCache()},enumerable:!0,configurable:!0}),Object.defineProperty(Color.prototype,"r",{get:function(){return this._r},set:function(e){this._r!==e&&(this.dirty=!0,this._r=e)},enumerable:!0,configurable:!0}),Object.defineProperty(Color.prototype,"g",{get:function(){return this._g},set:function(e){this._g!==e&&(this.dirty=!0,this._g=e)},enumerable:!0,configurable:!0}),Object.defineProperty(Color.prototype,"b",{get:function(){return this._b},set:function(e){this._b!==e&&(this.dirty=!0,this._b=e)},enumerable:!0,configurable:!0}),Object.defineProperty(Color.prototype,"a",{get:function(){return this._a},set:function(e){this._a!==e&&(this.dirty=!0,this._a=e)},enumerable:!0,configurable:!0}),Color.prototype.initWhenCreate=function(e){e&&(this._colorString=e,this._setColor(e))},Color.prototype.toVector3=function(){return e.Vector3.create(this.r,this.g,this.b)},Color.prototype.toVector4=function(){return e.Vector4.create(this.r,this.g,this.b,this.a)},Color.prototype.toString=function(){return this._colorString},Color.prototype.clone=function(){return Color.create(this._colorString)},Color.prototype.isEqual=function(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a},Color.prototype._setColor=function(e){var t=/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*([^\)]+)\)$/i,r=/^rgba\((\d+\.\d+),\s*(\d+\.\d+),\s*(\d+\.\d+),\s*([^\)]+)\)$/i,n=/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/i,i=/^rgb\((\d+\.\d+),\s*(\d+\.\d+),\s*(\d+\.\d+)\)$/i,a=/^\#([0-9a-f]{6})$/i,o=null;return t.test(e)?(o=t.exec(e),this.r=this._getColorValue(o,1),this.g=this._getColorValue(o,2),this.b=this._getColorValue(o,3),this.a=Number(o[4]),this):r.test(e)?(o=r.exec(e),this.r=parseFloat(o[1]),this.g=parseFloat(o[2]),this.b=parseFloat(o[3]),this.a=Number(o[4]),this):n.test(e)?(o=n.exec(e),this.r=this._getColorValue(o,1),this.g=this._getColorValue(o,2),this.b=this._getColorValue(o,3),this.a=1,this):i.test(e)?(o=i.exec(e),this.r=parseFloat(o[1]),this.g=parseFloat(o[2]),this.b=parseFloat(o[3]),this.a=1,this):a.test(e)?(o=a.exec(e),this._setHex(parseInt(o[1],16)),this):void 0},Color.prototype._getColorValue=function(e,t,r){return void 0===r&&(r=255),Math.min(r,parseInt(e[t],10))/r},Color.prototype._setHex=function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this.a=1,this},Color.prototype._clearCache=function(){this._colorVec3Cache=null,this._colorVec4Cache=null},__decorate([e.ensureGetter(function(t){e.assert(t>=0,e.Log.info.FUNC_SHOULD("r",">= 0, but actual is "+t))})],Color.prototype,"r",null),__decorate([e.ensureGetter(function(t){e.assert(t>=0,e.Log.info.FUNC_SHOULD("g",">= 0, but actual is "+t))})],Color.prototype,"g",null),__decorate([e.ensureGetter(function(t){e.assert(t>=0,e.Log.info.FUNC_SHOULD("b",">= 0, but actual is "+t))})],Color.prototype,"b",null),__decorate([e.ensureGetter(function(t){e.assert(t>=0,e.Log.info.FUNC_SHOULD("a",">= 0, but actual is "+t))})],Color.prototype,"a",null),__decorate([e.cache(function(){return null!==this._colorVec3Cache},function(){return this._colorVec3Cache},function(e){this._colorVec3Cache=e})],Color.prototype,"toVector3",null),__decorate([e.cache(function(){return null!==this._colorVec4Cache},function(){return this._colorVec4Cache},function(e){this._colorVec4Cache=e})],Color.prototype,"toVector4",null),Color}();e.Color=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function Texture(){t.apply(this,arguments),this.name="",this.material=null,this.width=null,this.height=null,this.variableData=null,this.wrapS=null,this.wrapT=null,this.magFilter=null,this.minFilter=null,this.glTexture=null,this.needUpdate=null,this.target=e.ETextureTarget.TEXTURE_2D}return __extends(Texture,t),Object.defineProperty(Texture.prototype,"geometry",{get:function(){return this.material.geometry},enumerable:!0,configurable:!0}),Texture.prototype.clone=function(){return e.CloneUtils.clone(this)},Texture.prototype.bindToUnit=function(t){var r=e.DeviceManager.getInstance().gl;if(!e.TextureCache.isCached(t,this))return e.TextureCache.addActiveTexture(t,this),r.activeTexture(r["TEXTURE"+String(t)]),r.bindTexture(r[this.target],this.glTexture),this},Texture.prototype.sendData=function(e,t,r){e.sendUniformData(t,this.getSamplerType(),r)},Texture.prototype.dispose=function(){var t=e.DeviceManager.getInstance().gl;t.deleteTexture(this.glTexture),delete this.glTexture,this._unBindAllUnit()},Texture.prototype.filterFallback=function(t){return t===e.ETextureFilterMode.NEAREST||t===e.ETextureFilterMode.NEAREST_MIPMAP_MEAREST||t===e.ETextureFilterMode.NEAREST_MIPMAP_LINEAR?e.ETextureFilterMode.NEAREST:e.ETextureFilterMode.LINEAR},Texture.prototype.getSamplerNameByVariableData=function(t,r){var n=null;return this.variableData?this.variableData.samplerVariableName&&(n=this.variableData.samplerVariableName):n=r===e.EVariableType.SAMPLER_2D?"u_sampler2D"+t:"u_samplerCube"+t,n},Texture.prototype.getSamplerType=function(){var t=null;switch(this.target){case e.ETextureTarget.TEXTURE_2D:t=e.EVariableType.SAMPLER_2D;break;case e.ETextureTarget.TEXTURE_CUBE_MAP:t=e.EVariableType.SAMPLER_CUBE}return t},Texture.prototype.isSourcePowerOfTwo=function(){return e.TextureUtils.isPowerOfTwo(this.width,this.height)},Texture.prototype.setTextureParameters=function(t,r){var n=e.DeviceManager.getInstance().gl;r?(n.texParameteri(t,n.TEXTURE_WRAP_S,n[this.wrapS]),n.texParameteri(t,n.TEXTURE_WRAP_T,n[this.wrapT]),n.texParameteri(t,n.TEXTURE_MAG_FILTER,n[this.magFilter]),n.texParameteri(t,n.TEXTURE_MIN_FILTER,n[this.minFilter])):(n.texParameteri(t,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(t,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(t,n.TEXTURE_MAG_FILTER,n[this.filterFallback(this.magFilter)]),n.texParameteri(t,n.TEXTURE_MIN_FILTER,n[this.filterFallback(this.minFilter)]))},Texture.prototype._unBindAllUnit=function(){for(var t=e.DeviceManager.getInstance().gl,r=e.GPUDetector.getInstance().maxTextureUnit,n=0;n<r;n++)t.activeTexture(t["TEXTURE"+n]),t.bindTexture(t.TEXTURE_2D,null),t.bindTexture(t.TEXTURE_CUBE_MAP,null);e.TextureCache.clearAllBindTextureUnitCache()},__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"name",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"material",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"width",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"height",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"variableData",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"wrapS",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"wrapT",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"magFilter",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"minFilter",void 0),__decorate([e.cloneAttributeAsBasicType()],Texture.prototype,"needUpdate",void 0),__decorate([e.require(function(t,r){var n=e.GPUDetector.getInstance().maxTextureUnit;e.assert(t>=0,e.Log.info.FUNC_SHOULD("texture unit",">= 0, but actual is "+t)),e.assert(t<n,"trying to cache "+t+" texture units, but GPU only supports "+n+" units")})],Texture.prototype,"bindToUnit",null),__decorate([e.virtual],Texture.prototype,"isSourcePowerOfTwo",null),Texture}(e.Entity);e.Texture=t}(wd||(wd={}));var wd;!function(e){var t=function(){function TextureUtils(){}return TextureUtils.isPowerOfTwo=function(t,r){return e.JudgeUtils.isPowerOfTwo(t)&&e.JudgeUtils.isPowerOfTwo(r)},TextureUtils}();e.TextureUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BasicTextureUtils(){t.apply(this,arguments)}return __extends(BasicTextureUtils,t),BasicTextureUtils.isDrawPartOfTexture=function(t,r){return t&&t.isNotEmpty()&&r===e.ETextureSourceRegionMethod.DRAW_IN_CANVAS},BasicTextureUtils.drawPartOfTextureByCanvas=function(e,t,r,n,i,a,o,s,c,u,l){var d=wdCb.DomQuery.create("<canvas></canvas>").get(0),h=null;return d.width=t,d.height=r,h=d.getContext("2d"),h.drawImage(e,n,i,a,o,s,c,u,l),d},BasicTextureUtils.isSourcePowerOfTwo=function(e,t,r,n){return this.isDrawPartOfTexture(e,t)?this.isPowerOfTwo(e.width,e.height):this.isPowerOfTwo(r,n)},BasicTextureUtils.needClampMaxSize=function(e,t,r){return t>e||r>e},BasicTextureUtils.clampToMaxSize=function(t,r){var n=null,i=null,a=null,o=null;return n=Math.max(t.width,t.height),i=Math.floor(t.width*r/n),a=Math.floor(t.height*r/n),o=this.drawPartOfTextureByCanvas(t,i,a,0,0,t.width,t.height,0,0,i,a),e.Log.log("source is too big (width:"+t.width+", height:"+t.height+"), resize it to be width:"+o.width+", height:"+o.height+"."),o},BasicTextureUtils}(e.TextureUtils);e.BasicTextureUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RenderTargetTexture(){t.apply(this,arguments),this._renderRate=1}return __extends(RenderTargetTexture,t),Object.defineProperty(RenderTargetTexture.prototype,"renderRate",{get:function(){return this._renderRate},set:function(e){this._renderRate=e},enumerable:!0,configurable:!0}),RenderTargetTexture.prototype.initWhenCreate=function(){this.needUpdate=!1,this.minFilter=e.ETextureFilterMode.LINEAR,this.magFilter=e.ETextureFilterMode.LINEAR,this.wrapS=e.ETextureWrapMode.CLAMP_TO_EDGE,this.wrapT=e.ETextureWrapMode.CLAMP_TO_EDGE},RenderTargetTexture.prototype.init=function(){},RenderTargetTexture.prototype.update=function(){},RenderTargetTexture.prototype.getPosition=function(){return this.geometry.entityObject.transform.position},RenderTargetTexture.prototype.setEmptyTexture=function(t){var r=e.DeviceManager.getInstance().gl;r.bindTexture(r[this.target],t),this.setTextureParameters(r[this.target],this.isSourcePowerOfTwo())},__decorate([e.require(function(t){e.assert(!!t,e.Log.info.FUNC_NOT_EXIST("texture object"))})],RenderTargetTexture.prototype,"setEmptyTexture",null),RenderTargetTexture}(e.Texture);e.RenderTargetTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDRenderTargetTexture(){t.apply(this,arguments),this._renderList=null}return __extends(TwoDRenderTargetTexture,t),Object.defineProperty(TwoDRenderTargetTexture.prototype,"renderList",{get:function(){return this._renderList},set:function(t){e.JudgeUtils.isArrayExactly(t)?this._renderList=wdCb.Collection.create(t):this._renderList=t},enumerable:!0,configurable:!0}),TwoDRenderTargetTexture.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.width=256,this.height=256},TwoDRenderTargetTexture.prototype.createEmptyTexture=function(){var t=e.DeviceManager.getInstance().gl,r=t.createTexture();this.setEmptyTexture(r),this.texImageEmpty(),this.glTexture=r},TwoDRenderTargetTexture.prototype.texImageEmpty=function(){var t=e.DeviceManager.getInstance().gl;t.texImage2D(t[this.target],0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null)},__decorate([e.requireSetter(function(t){e.assert(e.JudgeUtils.isArrayExactly(t)||e.JudgeUtils.isCollection(t),e.Log.info.FUNC_MUST_BE("renderList","array or collection"))}),e.cloneAttributeAsCloneable()],TwoDRenderTargetTexture.prototype,"renderList",null),__decorate([e.virtual],TwoDRenderTargetTexture.prototype,"texImageEmpty",null),TwoDRenderTargetTexture}(e.RenderTargetTexture);e.TwoDRenderTargetTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ShadowMapTextureUtils(){}return ShadowMapTextureUtils.setTextureParameters=function(t){var r=e.DeviceManager.getInstance().gl,n=e.Director.getInstance().scene;n.shadowMap.softType===e.EShadowMapSoftType.PCF&&(r.texParameteri(t,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(t,r.TEXTURE_MIN_FILTER,r.NEAREST))},ShadowMapTextureUtils}();e.ShadowMapTextureUtils=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function LightEffectTexture(){t.apply(this,arguments),this._plane=null}return __extends(LightEffectTexture,t),LightEffectTexture.prototype.getSamplerName=function(t){return this.getSamplerNameByVariableData(t,e.EVariableType.SAMPLER_2D)},LightEffectTexture.prototype.getPlane=function(){var t=null,r=null,n=null;return this._plane&&!this.geometry.entityObject.transform.dirtyLocal?this._plane:(e.Log.error(!(this.geometry instanceof e.PlaneGeometry),e.Log.info.FUNC_MUST_BE("geometry","PlaneGeometry")),t=this.geometry.geometryData.normals,r=this.geometry.entityObject.transform.localRotation.multiplyVector3(e.Vector3.create(t[0],t[1],t[2])).normalize(),n=this.getPosition(),this._plane=e.Plane.create(r.x,r.y,r.z,-n.dot(r)),this._plane)},LightEffectTexture}(e.TwoDRenderTargetTexture);e.LightEffectTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MirrorTexture(){t.apply(this,arguments)}return __extends(MirrorTexture,t),MirrorTexture.create=function(){var e=new this;return e.initWhenCreate(),e},MirrorTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addCommonRenderTargetRenderer(e.MirrorRenderTargetRenderer.create(this)),this},MirrorTexture}(e.LightEffectTexture);e.MirrorTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RefractionTexture(){t.apply(this,arguments)}return __extends(RefractionTexture,t),RefractionTexture.create=function(){var e=new this;return e.initWhenCreate(),e},RefractionTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addCommonRenderTargetRenderer(e.RefractionRenderTargetRenderer.create(this)),this},RefractionTexture}(e.LightEffectTexture);e.RefractionTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDShadowMapTexture(){t.apply(this,arguments)}return __extends(TwoDShadowMapTexture,t),TwoDShadowMapTexture.create=function(){var e=new this;return e.initWhenCreate(),e},TwoDShadowMapTexture.prototype.getSamplerName=function(e){return"u_twoDShadowMapSampler["+this.variableData.samplerData+"]"},TwoDShadowMapTexture.prototype.setTextureParameters=function(r,n){t.prototype.setTextureParameters.call(this,r,n),e.ShadowMapTextureUtils.setTextureParameters(r)},TwoDShadowMapTexture.prototype.texImageEmpty=function(){if(e.GPUDetector.getInstance().extensionDepthTexture){var r=e.DeviceManager.getInstance().gl;return void r.texImage2D(r[this.target],0,r.DEPTH_COMPONENT,this.width,this.height,0,r.DEPTH_COMPONENT,r.UNSIGNED_SHORT,null)}t.prototype.texImageEmpty.call(this)},__decorate([e.require(function(t){e.assert(e.JudgeUtils.isNumber(this.variableData.samplerData),e.Log.info.FUNC_MUST_BE("shadowMapTexture->variableData.samplerData","samplerIndex"))})],TwoDShadowMapTexture.prototype,"getSamplerName",null),TwoDShadowMapTexture}(e.TwoDRenderTargetTexture);e.TwoDShadowMapTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapRenderTargetTexture(){t.apply(this,arguments),this.target=e.ETextureTarget.TEXTURE_CUBE_MAP}return __extends(CubemapRenderTargetTexture,t),CubemapRenderTargetTexture.prototype.createEmptyTexture=function(){var t=e.DeviceManager.getInstance().gl,r=t.createTexture(),n=null;for(this.setEmptyTexture(r),n=0;n<6;n++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,t.RGBA,this.width,this.height,0,t.RGBA,t.UNSIGNED_BYTE,null);this.glTexture=r},CubemapRenderTargetTexture}(e.RenderTargetTexture);e.CubemapRenderTargetTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapShadowMapTexture(){t.apply(this,arguments)}return __extends(CubemapShadowMapTexture,t),CubemapShadowMapTexture.create=function(){var e=new this;return e.initWhenCreate(),e},CubemapShadowMapTexture.prototype.getSamplerName=function(e){return"u_cubemapShadowMapSampler["+this.variableData.samplerData+"]"},__decorate([e.require(function(t){e.assert(e.JudgeUtils.isNumber(this.variableData.samplerData),e.Log.info.FUNC_MUST_BE("shadowMapTexture->variableData.samplerData","samplerIndex"))})],CubemapShadowMapTexture.prototype,"getSamplerName",null),CubemapShadowMapTexture}(e.CubemapRenderTargetTexture);e.CubemapShadowMapTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DynamicCubemapTexture(){t.apply(this,arguments),this._renderList=null,this.size=256,this.near=.1,this.far=100,this.mode=null}return __extends(DynamicCubemapTexture,t),DynamicCubemapTexture.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(DynamicCubemapTexture.prototype,"renderList",{get:function(){return this._renderList},set:function(t){var r=wdCb.Hash.create();t instanceof wdCb.Hash||(e.JudgeUtils.isDirectObject(t)?t=wdCb.Hash.create(t):e.Log.error(!0,e.Log.info.FUNC_MUST_BE("renderList","array or wdCb.Collection"))),t.forEach(function(t,n){e.JudgeUtils.isArrayExactly(t)?r.addChild(n,wdCb.Collection.create(t)):e.JudgeUtils.isCollection(t)?r.addChild(n,t):e.Log.error(!0,e.Log.info.FUNC_MUST_BE("faceRenderList","array or wdCb.Collection"))}),this._renderList=r},enumerable:!0,configurable:!0}),DynamicCubemapTexture.prototype.init=function(){return t.prototype.init.call(this),this.width=this.size,this.height=this.size,e.Director.getInstance().scene.addCommonRenderTargetRenderer(e.DynamicCubemapRenderTargetRenderer.create(this)),this},DynamicCubemapTexture.prototype.getSamplerName=function(t){return this.getSamplerNameByVariableData(t,e.EVariableType.SAMPLER_CUBE)},__decorate([e.cloneAttributeAsCustomType(function(e,t,r){var n=null;null!==e[r]&&(n=wdCb.Hash.create(),e[r].forEach(function(e,t){n.addChild(t,e.clone())}),t[r]=n)})],DynamicCubemapTexture.prototype,"renderList",null),__decorate([e.cloneAttributeAsBasicType()],DynamicCubemapTexture.prototype,"size",void 0),__decorate([e.cloneAttributeAsBasicType()],DynamicCubemapTexture.prototype,"near",void 0),__decorate([e.cloneAttributeAsBasicType()],DynamicCubemapTexture.prototype,"far",void 0),__decorate([e.cloneAttributeAsBasicType()],DynamicCubemapTexture.prototype,"mode",void 0),DynamicCubemapTexture}(e.CubemapRenderTargetTexture);e.DynamicCubemapTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BasicTexture(){t.apply(this,arguments),this.p_sourceRegionMethod=null,this._sourceRegion=null,this.generateMipmaps=null,this.format=null,this.source=null,this.repeatRegion=null,this.sourceRegionMapping=null,this.packAlignment=null,this.unpackAlignment=null,this.flipY=null,this.premultiplyAlpha=null,this.colorspaceConversion=null,this.type=null,this.mipmaps=null,this.anisotropy=null,this._sourceRegionDirty=!1,this._sourceRegionForGLSLCache=null}return __extends(BasicTexture,t),Object.defineProperty(BasicTexture.prototype,"sourceRegionMethod",{get:function(){return this.p_sourceRegionMethod},set:function(e){this.p_sourceRegionMethod=e},enumerable:!0,configurable:!0}),Object.defineProperty(BasicTexture.prototype,"sourceRegion",{get:function(){return this._sourceRegion},set:function(e){this._sourceRegion=e,this._sourceRegionDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(BasicTexture.prototype,"sourceRegionForGLSL",{get:function(){return this.sourceRegion&&this.sourceRegionMethod===e.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL?this._convertSourceRegionToUV(this.sourceRegion):e.RectRegion.create(0,0,1,1)},enumerable:!0,configurable:!0}),BasicTexture.prototype.initWhenCreate=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=e.DeviceManager.getInstance().gl;this.glTexture=n.createTexture(),this.needUpdate=!0},BasicTexture.prototype.init=function(){},BasicTexture.prototype.dispose=function(){t.prototype.dispose.call(this),this._sourceRegionForGLSLCache=null},BasicTexture.prototype.update=function(){var t=e.DeviceManager.getInstance().gl,r=this.isSourcePowerOfTwo();return t.pixelStorei(t.PACK_ALIGNMENT,this.packAlignment),t.pixelStorei(t.UNPACK_ALIGNMENT,this.unpackAlignment),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,this.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,this.colorspaceConversion),this.needClampMaxSize()&&(this.clampToMaxSize(),r=this.isSourcePowerOfTwo(),r||e.Log.warn("texture size is not power of two after clampToMaxSize()")),this.setTextureParameters(t[this.target],r),this.allocateSourceToTexture(r),this.generateMipmaps&&r&&t.generateMipmap(t[this.target]),this.needUpdate=!1,this},BasicTexture.prototype.getSamplerName=function(t){return this.getSamplerNameByVariableData(t,e.EVariableType.SAMPLER_2D)},BasicTexture.prototype.needClampMaxSize=function(){return!!this.source&&e.BasicTextureUtils.needClampMaxSize(e.GPUDetector.getInstance().maxTextureSize,this.source.width,this.source.height)},BasicTexture.prototype.clampToMaxSize=function(){this.source=e.BasicTextureUtils.clampToMaxSize(this.source,e.GPUDetector.getInstance().maxTextureSize)},BasicTexture.prototype.setTextureParameters=function(e,r){t.prototype.setTextureParameters.call(this,e,r),this._setAnisotropy(e)},BasicTexture.prototype.isSourcePowerOfTwo=function(){return e.BasicTextureUtils.isSourcePowerOfTwo(this.sourceRegion,this.sourceRegionMethod,this.width,this.height)},BasicTexture.prototype._setAnisotropy=function(t){var r=e.GPUDetector.getInstance(),n=e.DeviceManager.getInstance().gl;r.extensionTextureFilterAnisotropic&&this.anisotropy>1&&n.texParameterf(t,r.extensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(this.anisotropy,r.maxAnisotropy))},BasicTexture.prototype._convertSourceRegionToUV=function(t){return this.sourceRegionMapping===e.ETextureSourceRegionMapping.CANVAS?e.GlobalTextureUtils.convertSourceRegionCanvasMapToUV(t,this.width,this.height):this.sourceRegionMapping===e.ETextureSourceRegionMapping.UV?t:void 0},__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"sourceRegionMethod",null),__decorate([e.cloneAttributeAsCloneable()],BasicTexture.prototype,"sourceRegion",null),__decorate([e.cacheGetter(function(){return!this._sourceRegionDirty&&null!==this._sourceRegionForGLSLCache},function(){return this._sourceRegionForGLSLCache},function(e){this._sourceRegionForGLSLCache=e,this._sourceRegionDirty=!1})],BasicTexture.prototype,"sourceRegionForGLSL",null),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"generateMipmaps",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"format",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"source",void 0),__decorate([e.cloneAttributeAsCloneable()],BasicTexture.prototype,"repeatRegion",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"sourceRegionMapping",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"packAlignment",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"unpackAlignment",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"flipY",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"premultiplyAlpha",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"colorspaceConversion",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"type",void 0),__decorate([e.cloneAttributeAsCloneable()],BasicTexture.prototype,"mipmaps",void 0),__decorate([e.cloneAttributeAsBasicType()],BasicTexture.prototype,"anisotropy",void 0),__decorate([e.virtual],BasicTexture.prototype,"needClampMaxSize",null),BasicTexture}(e.Texture);e.BasicTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDTexture(e){t.call(this),this.asset=null,this.asset=e}return __extends(TwoDTexture,t),TwoDTexture.prototype.clone=function(){return e.CloneUtils.clone(this,null,[this.asset])},TwoDTexture.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.asset.cloneTo(this)},TwoDTexture}(e.BasicTexture);e.TwoDTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CommonTexture(){t.apply(this,arguments)}return __extends(CommonTexture,t),CommonTexture.prototype.allocateSourceToTexture=function(t){var r=null,n=null,i=e.DeviceManager.getInstance().gl;t&&this.mipmaps.getCount()>0?(r=e.DrawMipmapTwoDTextureCommand.create(),r.mipmaps=this.mipmaps,r.format=this.format,r.type=this.type,r.sourceRegion=this.sourceRegion,r.sourceRegionMethod=this.sourceRegionMethod,r.glTarget=i.TEXTURE_2D,r.execute(),this.generateMipmaps=!1):(n=e.DrawNoMipmapTwoDTextureCommand.create(),n.source=this.source,n.format=this.format,n.type=this.type,n.sourceRegion=this.sourceRegion,n.sourceRegionMethod=this.sourceRegionMethod,n.glTarget=i.TEXTURE_2D,n.execute())},CommonTexture}(e.TwoDTexture);e.CommonTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ImageTexture(r){if(r instanceof e.ImageTextureAsset){var n=r;t.call(this,n)}else{var i=r;t.call(this,e.ImageTextureAsset.create(i))}}return __extends(ImageTexture,t),ImageTexture.create=function(e){var t=new this(e);return t.initWhenCreate(),t},ImageTexture}(e.CommonTexture);e.ImageTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function VideoTexture(){t.apply(this,arguments),this._video=null,this._startLoopSubscription=null}return __extends(VideoTexture,t),VideoTexture.create=function(e){var t=new this(e);return t.initWhenCreate(),t},VideoTexture.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this._video=this.asset.video},VideoTexture.prototype.init=function(){var r=this;return t.prototype.init.call(this),this._startLoopSubscription=e.EventManager.fromEvent(e.EEngineEvent.STARTLOOP).subscribe(function(){r._video.isStop?r.needUpdate=!1:r.needUpdate=!0}),this},VideoTexture.prototype.dispose=function(){this._startLoopSubscription&&this._startLoopSubscription.dispose()},VideoTexture.prototype.needClampMaxSize=function(){return!1},VideoTexture}(e.CommonTexture);e.VideoTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapTexture(r){t.call(this),this.assets=null,this.textures=wdCb.Collection.create(),this.mode=null,this.target=e.ETextureTarget.TEXTURE_CUBE_MAP,this._areAllCompressedAsset=!1,this.assets=r}return __extends(CubemapTexture,t),CubemapTexture.create=function(e){var t=new this(e);return t.initWhenCreate(e),t},CubemapTexture.prototype.clone=function(){var t=null;return t=null!==this.assets?[].concat(this.assets):null,e.CloneUtils.clone(this,null,[t])},CubemapTexture.prototype.initWhenCreate=function(e){t.prototype.initWhenCreate.call(this),this._areAssetsAllCompressedAsset(e)?this._areAllCompressedAsset=!0:this._areAllCompressedAsset=!1,this._createTextures(e),this._getRepresentAsset(e).cloneToCubemapTexture(this),this._areAllCompressedAsset?(this.generateMipmaps=!1,this._hasNoMipmapCompressedAsset()&&(this.minFilter=this.filterFallback(this.minFilter))):this.generateMipmaps=!0,this.flipY=!1},CubemapTexture.prototype.getSamplerName=function(t){return this.getSamplerNameByVariableData(t,e.EVariableType.SAMPLER_CUBE)},CubemapTexture.prototype.allocateSourceToTexture=function(e){this._areAllCompressedAsset?this.textures.forEach(function(e,t){e.draw(t)}):this.textures.forEach(function(e,t){e.draw(t)})},CubemapTexture.prototype.needClampMaxSize=function(){var e=!1;return this.textures.forEach(function(t){if(t.needClampMaxSize())return e=!0,wdCb.$BREAK}),e},CubemapTexture.prototype.isSourcePowerOfTwo=function(){var e=!0;return this.textures.forEach(function(t){if(!t.isSourcePowerOfTwo())return e=!1,wdCb.$BREAK}),e},CubemapTexture.prototype.clampToMaxSize=function(){
this.textures.forEach(function(e){e.clampToMaxSize()})},CubemapTexture.prototype._hasNoMipmapCompressedAsset=function(){var e=this;return!!this._areAllCompressedAsset&&this.textures.filter(function(t){return!e._isMipmapFilter(t.minFilter)}).getCount()>0},CubemapTexture.prototype._isMipmapFilter=function(t){return t===e.ETextureFilterMode.LINEAR_MIPMAP_LINEAR||t===e.ETextureFilterMode.LINEAR_MIPMAP_NEAREST||t===e.ETextureFilterMode.NEAREST_MIPMAP_LINEAR||t===e.ETextureFilterMode.NEAREST_MIPMAP_MEAREST},CubemapTexture.prototype._getRepresentAsset=function(e){return e[0].asset},CubemapTexture.prototype._areAssetsAllImageAssets=function(t){for(var r=[],n=0,i=t;n<i.length;n++){var a=i[n];a.asset instanceof e.ImageTextureAsset&&r.push(a)}return 6===r.length},CubemapTexture.prototype._areAssetsAllCompressedAsset=function(t){for(var r=[],n=0,i=t;n<i.length;n++){var a=i[n];a.asset instanceof e.CompressedTextureAsset&&r.push(a)}return 6===r.length},CubemapTexture.prototype._createTextures=function(t){for(var r=this,n=0,i=t;n<i.length;n++){var a=i[n],o=a.asset.toCubemapFaceTexture();if(a.sourceRegion&&o instanceof e.CubemapFaceImageTexture){var s=o;s.sourceRegion=a.sourceRegion}a.type&&(o.type=a.type),r.textures.addChild(o)}},CubemapTexture.prototype._areTextureSizOfAllFaceseEqual=function(e){for(var t=[],r=[],n=0,i=e;n<i.length;n++){var a=i[n];a.sourceRegion?(t.push(a.sourceRegion.width),r.push(a.sourceRegion.height)):(t.push(a.asset.width),r.push(a.asset.height))}return this._areAllElementsEqual(t)&&this._areAllElementsEqual(r)},CubemapTexture.prototype._hasSourceRegion=function(e){for(var t=0,r=e;t<r.length;t++){var n=r[t];if(n.sourceRegion)return!0}return!1},CubemapTexture.prototype._areAllElementsEqual=function(e){for(var t=e[0],r=0,n=e;r<n.length;r++){var i=n[r];if(i!==t)return!1}return!0},__decorate([e.cloneAttributeAsBasicType()],CubemapTexture.prototype,"mode",void 0),__decorate([e.require(function(t){e.assert(6===t.length,e.Log.info.FUNC_MUST("cubemap","has 6 assets")),e.assert(this._areAssetsAllImageAssets(t)||this._areAssetsAllCompressedAsset(t),e.Log.info.FUNC_MUST_BE("cubemap six face's assets","all ImageTextureAsset or all CompressedTextureAsset")),this._areAssetsAllCompressedAsset(t)&&e.assert(!this._hasSourceRegion(t),e.Log.info.FUNC_SHOULD_NOT("compressed face","contain sourceRegion data")),e.assert(this._areTextureSizOfAllFaceseEqual(t),e.Log.info.FUNC_MUST_BE("all cubemap faces' texture size","equal"))})],CubemapTexture.prototype,"initWhenCreate",null),CubemapTexture}(e.BasicTexture);e.CubemapTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(){function CubemapFaceTexture(){this.type=e.ETextureType.UNSIGNED_BYTE,this.format=null,this.width=null,this.height=null}return CubemapFaceTexture}();e.CubemapFaceTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapFaceImageTexture(){t.apply(this,arguments),this.sourceRegion=null,this.source=null}return __extends(CubemapFaceImageTexture,t),CubemapFaceImageTexture.create=function(e){var t=new this;return t.initWhenCreate(e),t},Object.defineProperty(CubemapFaceImageTexture.prototype,"sourceRegionMethod",{get:function(){return e.ETextureSourceRegionMethod.DRAW_IN_CANVAS},set:function(e){},enumerable:!0,configurable:!0}),CubemapFaceImageTexture.prototype.initWhenCreate=function(e){e.cloneToCubemapFaceTexture(this)},CubemapFaceImageTexture.prototype.isSourcePowerOfTwo=function(){return e.BasicTextureUtils.isSourcePowerOfTwo(this.sourceRegion,this.sourceRegionMethod,this.width,this.height)},CubemapFaceImageTexture.prototype.needClampMaxSize=function(){return!!this.source&&e.BasicTextureUtils.needClampMaxSize(e.GPUDetector.getInstance().maxCubemapTextureSize,this.source.width,this.source.height)},CubemapFaceImageTexture.prototype.clampToMaxSize=function(){var t=e.GPUDetector.getInstance().maxCubemapTextureSize;this.source=e.BasicTextureUtils.clampToMaxSize(this.source,t)},CubemapFaceImageTexture.prototype.draw=function(t){var r=e.DrawNoMipmapTwoDTextureCommand.create(),n=e.DeviceManager.getInstance().gl;r.source=this.source,r.sourceRegion=this.sourceRegion,r.sourceRegionMethod=this.sourceRegionMethod,r.glTarget=n.TEXTURE_CUBE_MAP_POSITIVE_X+t,r.format=this.format,r.type=this.type,r.execute()},__decorate([e.requireSetter(function(t){e.assert(t===e.ETextureSourceRegionMethod.DRAW_IN_CANVAS,e.Log.info.FUNC_SUPPORT("cubemap twoD face texture->sourceRegionMethod only","DRAW_IN_CANVAS"))})],CubemapFaceImageTexture.prototype,"sourceRegionMethod",null),CubemapFaceImageTexture}(e.CubemapFaceTexture);e.CubemapFaceImageTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CubemapFaceCompressedTexture(){t.apply(this,arguments),this.mipmaps=null,this.minFilter=null}return __extends(CubemapFaceCompressedTexture,t),CubemapFaceCompressedTexture.create=function(e){var t=new this;return t.initWhenCreate(e),t},CubemapFaceCompressedTexture.prototype.initWhenCreate=function(e){e.cloneToCubemapFaceTexture(this)},CubemapFaceCompressedTexture.prototype.isSourcePowerOfTwo=function(){return e.BasicTextureUtils.isSourcePowerOfTwo(null,null,this.width,this.height)},CubemapFaceCompressedTexture.prototype.needClampMaxSize=function(){return e.BasicTextureUtils.needClampMaxSize(e.GPUDetector.getInstance().maxCubemapTextureSize,this.width,this.height)},CubemapFaceCompressedTexture.prototype.clampToMaxSize=function(){e.Log.warn("CubemapFaceCompressedTexture's texture size is over maxCubemapTextureSize")},CubemapFaceCompressedTexture.prototype.draw=function(t){var r=e.DrawCompressedTextureCommand.create(),n=e.DeviceManager.getInstance().gl;r.glTarget=n.TEXTURE_CUBE_MAP_POSITIVE_X+t,r.type=this.type,r.format=this.format,r.mipmaps=this.mipmaps,r.execute()},CubemapFaceCompressedTexture}(e.CubemapFaceTexture);e.CubemapFaceCompressedTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CompressedTexture(){t.apply(this,arguments)}return __extends(CompressedTexture,t),CompressedTexture.create=function(e){var t=new this(e);return t.initWhenCreate(),t},Object.defineProperty(CompressedTexture.prototype,"sourceRegionMethod",{get:function(){return e.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL},set:function(e){this.p_sourceRegionMethod=e},enumerable:!0,configurable:!0}),CompressedTexture.prototype.allocateSourceToTexture=function(t){var r=e.DeviceManager.getInstance().gl,n=e.DrawCompressedTextureCommand.create();n.glTarget=r.TEXTURE_2D,n.type=this.type,n.format=this.format,n.mipmaps=this.mipmaps,n.sourceRegion=this.sourceRegion,n.sourceRegionMethod=this.sourceRegionMethod,n.execute(),this.mipmaps.getCount()>1&&(this.generateMipmaps=!1)},CompressedTexture.prototype.needClampMaxSize=function(){return!1},__decorate([e.ensureGetter(function(t){e.it("compressed texture not support ETextureSourceRegionMethod.DRAW_IN_CANVAS, will use ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL instead",function(){e.expect(this.p_sourceRegionMethod).not.to.equal(e.ETextureSourceRegionMethod.DRAW_IN_CANVAS),e.expect(t).to.equal(e.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL)},this)})],CompressedTexture.prototype,"sourceRegionMethod",null),CompressedTexture}(e.TwoDTexture);e.CompressedTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(){function DrawTextureCommand(){this.format=null,this.type=null,this.sourceRegion=null,this.sourceRegionMethod=e.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL,this.glTarget=null}return DrawTextureCommand.prototype.getDrawTarget=function(t,r){void 0===r&&(r=this.sourceRegion);var n=null;return n=e.BasicTextureUtils.isDrawPartOfTexture(r,this.sourceRegionMethod)?e.BasicTextureUtils.drawPartOfTextureByCanvas(t,r.width,r.height,r.x,r.y,r.width,r.height,0,0,r.width,r.height):t},DrawTextureCommand}();e.DrawTextureCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DrawCompressedTextureCommand(){t.apply(this,arguments),this.mipmaps=null}return __extends(DrawCompressedTextureCommand,t),DrawCompressedTextureCommand.create=function(){var e=new this;return e},DrawCompressedTextureCommand.prototype.execute=function(){var t=e.DeviceManager.getInstance().gl,r=this;e.Log.error(null===this.format,e.Log.info.FUNC_NOT_SUPPORT(this.format)),this.format!==e.ETextureFormat.RGBA?this.mipmaps.forEach(function(e,n){t.compressedTexImage2D(r.glTarget,n,r.format,e.width,e.height,0,r.getDrawTarget(e.data))}):this.mipmaps.forEach(function(e,n){t.texImage2D(r.glTarget,n,t[r.format],e.width,e.height,0,t[r.format],t[r.type],r.getDrawTarget(e.data))})},DrawCompressedTextureCommand}(e.DrawTextureCommand);e.DrawCompressedTextureCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function DrawTwoDTextureCommand(){t.apply(this,arguments),this.source=null}return __extends(DrawTwoDTextureCommand,t),DrawTwoDTextureCommand.prototype.drawTexture=function(t,r){var n=e.DeviceManager.getInstance().gl;n.texImage2D(this.glTarget,t,n[this.format],n[this.format],n[this.type],this.getDrawTarget(r))},DrawTwoDTextureCommand}(e.DrawTextureCommand);e.DrawTwoDTextureCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function DrawMipmapTwoDTextureCommand(){e.apply(this,arguments),this.mipmaps=null}return __extends(DrawMipmapTwoDTextureCommand,e),DrawMipmapTwoDTextureCommand.create=function(){var e=new this;return e},DrawMipmapTwoDTextureCommand.prototype.execute=function(){var e=this;this.mipmaps.forEach(function(t,r){e.drawTexture(r,t)})},DrawMipmapTwoDTextureCommand}(e.DrawTwoDTextureCommand);e.DrawMipmapTwoDTextureCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function DrawNoMipmapTwoDTextureCommand(){e.apply(this,arguments)}return __extends(DrawNoMipmapTwoDTextureCommand,e),DrawNoMipmapTwoDTextureCommand.create=function(){var e=new this;return e},DrawNoMipmapTwoDTextureCommand.prototype.execute=function(){this.drawTexture(0,this.source)},DrawNoMipmapTwoDTextureCommand}(e.DrawTwoDTextureCommand);e.DrawNoMipmapTwoDTextureCommand=t}(wd||(wd={}));var wd;!function(e){var t=function(){function Video(e){var t=e.urlArr,r=e.onLoad,n=void 0===r?function(e){}:r,i=e.onError,a=void 0===i?function(e){}:i;this.url=null,this.source=null,this.isStop=!1,this._urlArr=null,this._onLoad=null,this._onError=null,this._urlArr=wdCb.Collection.create(t),this._onLoad=n,this._onError=a}return Video.create=function(e){var t=new this(e);return t.initWhenCreate(),t},Video.prototype.initWhenCreate=function(){this.url=this._getCanPlayUrl(),this.source=document.createElement("video"),this.source.src=this.url,this._bindEvent()},Video.prototype.play=function(){this.isStop=!1,this.source.play()},Video.prototype._getCanPlayUrl=function(){var t=this,r=null,n=[];return this._urlArr.forEach(function(e){var i=wdCb.PathUtils.extname(e);if(n.push(i),t._canplay(i))return r=e,wdCb.$BREAK}),e.Log.error(null===r,e.Log.info.FUNC_NOT_SUPPORT("browser",n.join(","))),r},Video.prototype._canplay=function(t){var r=document.createElement("video"),n=null;switch(t){case".mp4":n='video/mp4; codecs="avc1.42e01e, mp4a.40.2"';break;case".ogv":n='video/ogg; codecs="theora, vorbis"';break;case".webm":n='video/webm; codecs="vp8, vorbis"';break;default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT(t))}return!!r.canPlayType&&""!==r.canPlayType(n)},Video.prototype._bindEvent=function(){var e=this;this.source.addEventListener("canplaythrough",function(){e._onLoad(e)},!1),this.source.addEventListener("error",function(){e._onError("errorCode "+e.source.error.code)},!1),this.source.addEventListener("ended",function(){e.isStop=!0},!1)},Video}();e.Video=t}(wd||(wd={}));var wd;!function(e){var t=function(){function VideoManager(){}return VideoManager.getInstance=function(){},VideoManager.prototype.play=function(t){var r=e.VideoLoader.getInstance().get(t),n=null;e.Log.error(!r,e.Log.info.FUNC_NOT_EXIST("video asset which id is "+t)),n=r.video,n.play()},VideoManager=__decorate([e.singleton()],VideoManager)}();e.VideoManager=t}(wd||(wd={}));var wd;!function(e){e.JudgeUtils.isNodeJs()?e.root=global:e.root=window}(wd||(wd={}));var wd;!function(e){var t=function(t){function ProceduralShaderLib(){t.apply(this,arguments)}return __extends(ProceduralShaderLib,t),ProceduralShaderLib.prototype.sendShaderVariables=function(e,t){},ProceduralShaderLib.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e,null)},__decorate([e.virtual],ProceduralShaderLib.prototype,"sendShaderVariables",null),__decorate([e.virtual],ProceduralShaderLib.prototype,"setShaderDefinition",null),ProceduralShaderLib}(e.EngineShaderLib);e.ProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ProceduralRenderTargetRenderer(){t.apply(this,arguments),this.frameBuffer=null,this._indexBuffer=null,this._vertexBuffer=null,this._shader=null,this._vaoManager=e.GPUDetector.getInstance().extensionVAO?e.VAOManager.create():null}return __extends(ProceduralRenderTargetRenderer,t),ProceduralRenderTargetRenderer.prototype.init=function(){t.prototype.init.call(this),this._initBuffer(),this._shader=this.createShader(),this._shader.init(),this._vaoManager&&this._vaoManager.init()},ProceduralRenderTargetRenderer.prototype.dispose=function(){t.prototype.dispose.call(this),this._indexBuffer.dispose(),this._vertexBuffer.dispose(),this._shader.dispose(),this._vaoManager&&this._vaoManager.dispose()},ProceduralRenderTargetRenderer.prototype.initFrameBuffer=function(){var t=this.frameBufferOperator,r=e.DeviceManager.getInstance().gl;this.frameBuffer=t.createFrameBuffer(),t.bindFrameBuffer(this.frameBuffer),t.attachTexture(r.TEXTURE_2D,this.texture.glTexture),t.check(),t.unBindAll()},ProceduralRenderTargetRenderer.prototype.renderFrameBufferTexture=function(t,r){this.frameBufferOperator.bindFrameBuffer(this.frameBuffer),this.texture.bindToUnit(0),this.frameBufferOperator.setViewport(),r.addCommand(this._createRenderCommand()),r.clear(),r.webglState=e.BasicState.create(),r.render(),this.frameBufferOperator.unBindFrameBuffer(),this.frameBufferOperator.restoreViewport()},ProceduralRenderTargetRenderer.prototype.disposeFrameBuffer=function(){var t=e.DeviceManager.getInstance().gl;t.deleteFramebuffer(this.frameBuffer)},ProceduralRenderTargetRenderer.prototype.getRenderList=function(){return null},ProceduralRenderTargetRenderer.prototype.isRenderListEmpty=function(){return!1},ProceduralRenderTargetRenderer.prototype._initBuffer=function(){e.BufferTable.hasBuffer(e.BufferTableKey.PROCEDURAL_VERTEX)?this._vertexBuffer=e.BufferTable.getBuffer(e.BufferTableKey.PROCEDURAL_VERTEX):(this._vertexBuffer=e.ArrayBuffer.create([1,1,-1,1,-1,-1,1,-1],2,e.EBufferType.FLOAT),e.BufferTable.addBuffer(e.BufferTableKey.PROCEDURAL_VERTEX,this._vertexBuffer)),e.BufferTable.hasBuffer(e.BufferTableKey.PROCEDURAL_INDEX)?this._indexBuffer=e.BufferTable.getBuffer(e.BufferTableKey.PROCEDURAL_INDEX):(this._indexBuffer=e.ElementBuffer.create([0,1,2,0,2,3],e.EBufferType.UNSIGNED_SHORT),e.BufferTable.addBuffer(e.BufferTableKey.PROCEDURAL_INDEX,this._indexBuffer))},ProceduralRenderTargetRenderer.prototype._createRenderCommand=function(){var t=e.ProceduralCommand.create();return t.vertexBuffer=this._vertexBuffer,t.indexBuffer=this._indexBuffer,t.shader=this._shader,t.vaoManager=this._vaoManager,t},ProceduralRenderTargetRenderer}(e.RenderTargetRenderer);e.ProceduralRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ProceduralTexture(){t.apply(this,arguments),this.repeatRegion=e.RectRegion.create(0,0,1,1)}return __extends(ProceduralTexture,t),Object.defineProperty(ProceduralTexture.prototype,"sourceRegionForGLSL",{get:function(){return e.RectRegion.create(0,0,1,1)},enumerable:!0,configurable:!0}),ProceduralTexture.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.renderRate=0},ProceduralTexture.prototype.getSamplerName=function(t){return this.getSamplerNameByVariableData(t,e.EVariableType.SAMPLER_2D)},__decorate([e.cloneAttributeAsCloneable()],ProceduralTexture.prototype,"repeatRegion",void 0),ProceduralTexture}(e.TwoDRenderTargetTexture);e.ProceduralTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CommonProceduralShaderLib(){e.apply(this,arguments),this.type="common_proceduralTexture"}return __extends(CommonProceduralShaderLib,e),CommonProceduralShaderLib.create=function(){var e=new this;return e},CommonProceduralShaderLib.prototype.sendShaderVariables=function(e,t){this.sendAttributeBuffer(e,"a_positionVec2",t.vertexBuffer),e.sendAllBufferData(t.vaoManager)},CommonProceduralShaderLib.prototype.setShaderDefinition=function(t){e.prototype.setShaderDefinition.call(this,t),this.addAttributeVariable(["a_positionVec2"])},CommonProceduralShaderLib}(e.ProceduralShaderLib);e.CommonProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function FireProceduralShaderLib(e){t.call(this),this.type="fire_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(FireProceduralShaderLib,t),FireProceduralShaderLib.create=function(e){var t=new this(e);return t},FireProceduralShaderLib.prototype.sendShaderVariables=function(t,r){var n=this._proceduralTexture;n.computeTime(),this.sendUniformData(t,"u_time",n.time),this.sendUniformData(t,"u_speed",n.speed),this.sendUniformData(t,"u_shift",n.shift),this.sendUniformData(t,"u_alphaThreshold",n.alphaThreshold),n.fireColorMap.forEach(function(r,n){t.sendStructureData("u_fireColor."+n,e.EVariableType.VECTOR_3,r.toVector3())})},FireProceduralShaderLib.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_time","u_speed","u_shift","u_alphaThreshold","u_fireColor"])},FireProceduralShaderLib}(e.ProceduralShaderLib);e.FireProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function FireProceduralRenderTargetRenderer(){t.apply(this,arguments)}return __extends(FireProceduralRenderTargetRenderer,t),FireProceduralRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},FireProceduralRenderTargetRenderer.prototype.createShader=function(){var t=e.CommonProceduralShader.create();return t.addLib(e.FireProceduralShaderLib.create(this.texture)),t},FireProceduralRenderTargetRenderer}(e.ProceduralRenderTargetRenderer);e.FireProceduralRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function FireProceduralTexture(){t.apply(this,arguments),this._fireColorMap=null,this.fireColorType=r.RED,this.speed=e.Vector2.create(.5,.3),this.alphaThreshold=.5,this.shift=1,this.time=0}return __extends(FireProceduralTexture,t),FireProceduralTexture.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(FireProceduralTexture.prototype,"fireColorMap",{get:function(){if(null!==this._fireColorMap)return this._fireColorMap;switch(this.fireColorType){case r.CUSTOM:return this._fireColorMap;case r.RED:return wdCb.Hash.create({c1:e.Color.create("rgb(0.5, 0.0, 0.1)"),c2:e.Color.create("rgb(0.9, 0.0, 0.0)"),c3:e.Color.create("rgb(0.2, 0.0, 0.0)"),c4:e.Color.create("rgb(1.0, 0.9, 0.0)"),c5:e.Color.create("rgb(0.1, 0.1, 0.1)"),c6:e.Color.create("rgb(0.9, 0.9, 0.9)")});case r.BLUE:return wdCb.Hash.create({c1:e.Color.create("rgb(0.1, 0.0, 0.5)"),c2:e.Color.create("rgb(0.0, 0.0, 0.5)"),c3:e.Color.create("rgb(0.1, 0.0, 0.2)"),c4:e.Color.create("rgb(0.0, 0.0, 1.0)"),c5:e.Color.create("rgb(0.1, 0.2, 0.3)"),c6:e.Color.create("rgb(0.0, 0.2, 0.9)")});case r.PURPLE:return wdCb.Hash.create({c1:e.Color.create("rgb(0.5, 0.0, 1.0)"),c2:e.Color.create("rgb(0.9, 0.0, 1.0)"),c3:e.Color.create("rgb(0.2, 0.0, 1.0)"),c4:e.Color.create("rgb(1.0, 0.9, 1.0)"),c5:e.Color.create("rgb(0.1, 0.1, 1.0)"),c6:e.Color.create("rgb(0.9, 0.9, 1.0)")});case r.GREEN:return wdCb.Hash.create({c1:e.Color.create("rgb(0.5, 1.0, 0.0)"),c2:e.Color.create("rgb(0.5, 1.0, 0.0)"),c3:e.Color.create("rgb(0.3, 0.4, 0.0)"),c4:e.Color.create("rgb(0.5, 1.0, 0.0)"),c5:e.Color.create("rgb(0.2, 0.0, 0.0)"),c6:e.Color.create("rgb(0.5, 1.0, 0.0)")});default:e.Log.error(!0,e.Log.info.FUNC_UNEXPECT("fireColorType:"+this.fireColorType))}},set:function(e){this._fireColorMap=e},enumerable:!0,configurable:!0}),FireProceduralTexture.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.renderRate=1},FireProceduralTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addProceduralRenderTargetRenderer(e.FireProceduralRenderTargetRenderer.create(this)),this},FireProceduralTexture.prototype.computeTime=function(){this.time+=.1},__decorate([e.cloneAttributeAsBasicType()],FireProceduralTexture.prototype,"_fireColorMap",void 0),__decorate([e.requireSetter(function(t){e.assert(6===t.getCount(),e.Log.info.FUNC_SHOULD("contain 6 colors"))}),e.ensureGetter(function(t){e.assert(6===t.getCount(),e.Log.info.FUNC_SHOULD("contain 6 colors"))})],FireProceduralTexture.prototype,"fireColorMap",null),__decorate([e.cloneAttributeAsBasicType()],FireProceduralTexture.prototype,"fireColorType",void 0),__decorate([e.cloneAttributeAsCloneable()],FireProceduralTexture.prototype,"speed",void 0),__decorate([e.cloneAttributeAsBasicType()],FireProceduralTexture.prototype,"alphaThreshold",void 0),__decorate([e.cloneAttributeAsBasicType()],FireProceduralTexture.prototype,"shift",void 0),__decorate([e.cloneAttributeAsBasicType()],FireProceduralTexture.prototype,"time",void 0),FireProceduralTexture}(e.ProceduralTexture);e.FireProceduralTexture=t,function(e){e[e.CUSTOM=0]="CUSTOM",e[e.RED=1]="RED",e[e.PURPLE=2]="PURPLE",e[e.GREEN=3]="GREEN",e[e.BLUE=4]="BLUE"}(e.EFireProceduralTextureColorType||(e.EFireProceduralTextureColorType={}));var r=e.EFireProceduralTextureColorType}(wd||(wd={}));var wd;!function(e){var t=function(t){function MarbleProceduralRenderTargetRenderer(){t.apply(this,arguments)}return __extends(MarbleProceduralRenderTargetRenderer,t),MarbleProceduralRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},MarbleProceduralRenderTargetRenderer.prototype.createShader=function(){var t=e.CommonProceduralShader.create();return t.addLib(e.MarbleProceduralShaderLib.create(this.texture)),t},MarbleProceduralRenderTargetRenderer}(e.ProceduralRenderTargetRenderer);e.MarbleProceduralRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MarbleProceduralTexture(){t.apply(this,arguments),this.tilesHeightNumber=3,this.tilesWidthNumber=3,this.amplitude=9,this.jointColor=e.Color.create("rgb(0.72, 0.72, 0.72)")}return __extends(MarbleProceduralTexture,t),MarbleProceduralTexture.create=function(){var e=new this;return e.initWhenCreate(),e},MarbleProceduralTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addProceduralRenderTargetRenderer(e.MarbleProceduralRenderTargetRenderer.create(this)),this},__decorate([e.cloneAttributeAsBasicType()],MarbleProceduralTexture.prototype,"tilesHeightNumber",void 0),__decorate([e.cloneAttributeAsBasicType()],MarbleProceduralTexture.prototype,"tilesWidthNumber",void 0),__decorate([e.cloneAttributeAsBasicType()],MarbleProceduralTexture.prototype,"amplitude",void 0),__decorate([e.cloneAttributeAsCloneable()],MarbleProceduralTexture.prototype,"jointColor",void 0),MarbleProceduralTexture}(e.ProceduralTexture);e.MarbleProceduralTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function MarbleProceduralShaderLib(t){e.call(this),this.type="marble_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=t}return __extends(MarbleProceduralShaderLib,e),MarbleProceduralShaderLib.create=function(e){var t=new this(e);return t},MarbleProceduralShaderLib.prototype.sendShaderVariables=function(e,t){var r=this._proceduralTexture;this.sendUniformData(e,"u_tilesHeightNumber",r.tilesHeightNumber),this.sendUniformData(e,"u_tilesWidthNumber",r.tilesWidthNumber),this.sendUniformData(e,"u_amplitude",r.amplitude),this.sendUniformData(e,"u_jointColor",r.jointColor.toVector3())},MarbleProceduralShaderLib.prototype.setShaderDefinition=function(t){e.prototype.setShaderDefinition.call(this,t),this.addUniformVariable(["u_tilesHeightNumber","u_tilesWidthNumber","u_amplitude","u_jointColor"])},MarbleProceduralShaderLib}(e.ProceduralShaderLib);e.MarbleProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GrassProceduralRenderTargetRenderer(){t.apply(this,arguments)}return __extends(GrassProceduralRenderTargetRenderer,t),GrassProceduralRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},GrassProceduralRenderTargetRenderer.prototype.createShader=function(){var t=e.CommonProceduralShader.create();return t.addLib(e.GrassProceduralShaderLib.create(this.texture)),t},GrassProceduralRenderTargetRenderer}(e.ProceduralRenderTargetRenderer);e.GrassProceduralRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GrassProceduralTexture(){t.apply(this,arguments),this.herb1Color=e.Color.create("rgb(0.29, 0.38, 0.02)"),this.herb2Color=e.Color.create("rgb(0.36, 0.49, 0.09)"),this.herb3Color=e.Color.create("rgb(0.51, 0.6, 0.28)"),this.groundColor=e.Color.create("rgb(1.0,1.0,1.0)")}return __extends(GrassProceduralTexture,t),GrassProceduralTexture.create=function(){var e=new this;return e.initWhenCreate(),e},GrassProceduralTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addProceduralRenderTargetRenderer(e.GrassProceduralRenderTargetRenderer.create(this)),this},__decorate([e.cloneAttributeAsCloneable()],GrassProceduralTexture.prototype,"herb1Color",void 0),__decorate([e.cloneAttributeAsCloneable()],GrassProceduralTexture.prototype,"herb2Color",void 0),__decorate([e.cloneAttributeAsCloneable()],GrassProceduralTexture.prototype,"herb3Color",void 0),__decorate([e.cloneAttributeAsCloneable()],GrassProceduralTexture.prototype,"groundColor",void 0),GrassProceduralTexture}(e.ProceduralTexture);e.GrassProceduralTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function GrassProceduralShaderLib(t){e.call(this),this.type="grass_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=t}return __extends(GrassProceduralShaderLib,e),GrassProceduralShaderLib.create=function(e){var t=new this(e);return t},GrassProceduralShaderLib.prototype.sendShaderVariables=function(e,t){var r=this._proceduralTexture;this.sendUniformData(e,"u_herb1Color",r.herb1Color.toVector3()),this.sendUniformData(e,"u_herb2Color",r.herb2Color.toVector3()),this.sendUniformData(e,"u_herb3Color",r.herb3Color.toVector3()),this.sendUniformData(e,"u_groundColor",r.groundColor.toVector3())},GrassProceduralShaderLib.prototype.setShaderDefinition=function(t){e.prototype.setShaderDefinition.call(this,t),this.addUniformVariable(["u_herb1Color","u_herb2Color","u_herb3Color","u_groundColor"])},GrassProceduralShaderLib}(e.ProceduralShaderLib);e.GrassProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WoodProceduralRenderTargetRenderer(){t.apply(this,arguments)}return __extends(WoodProceduralRenderTargetRenderer,t),WoodProceduralRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},WoodProceduralRenderTargetRenderer.prototype.createShader=function(){var t=e.CommonProceduralShader.create();return t.addLib(e.WoodProceduralShaderLib.create(this.texture)),t},WoodProceduralRenderTargetRenderer}(e.ProceduralRenderTargetRenderer);e.WoodProceduralRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WoodProceduralTexture(){t.apply(this,arguments),this.ampScale=100,this.woodColor=e.Color.create("rgb(0.32, 0.17, 0.09)")}return __extends(WoodProceduralTexture,t),WoodProceduralTexture.create=function(){var e=new this;return e.initWhenCreate(),e},WoodProceduralTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addProceduralRenderTargetRenderer(e.WoodProceduralRenderTargetRenderer.create(this)),this},__decorate([e.cloneAttributeAsBasicType()],WoodProceduralTexture.prototype,"ampScale",void 0),__decorate([e.cloneAttributeAsCloneable()],WoodProceduralTexture.prototype,"woodColor",void 0),WoodProceduralTexture}(e.ProceduralTexture);e.WoodProceduralTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function WoodProceduralShaderLib(t){e.call(this),this.type="wood_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=t}return __extends(WoodProceduralShaderLib,e),WoodProceduralShaderLib.create=function(e){var t=new this(e);return t},WoodProceduralShaderLib.prototype.sendShaderVariables=function(e,t){var r=this._proceduralTexture;this.sendUniformData(e,"u_ampScale",r.ampScale),this.sendUniformData(e,"u_woodColor",r.woodColor.toVector3())},WoodProceduralShaderLib.prototype.setShaderDefinition=function(t){e.prototype.setShaderDefinition.call(this,t),this.addUniformVariable(["u_ampScale","u_woodColor"])},WoodProceduralShaderLib}(e.ProceduralShaderLib);e.WoodProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RoadProceduralRenderTargetRenderer(){t.apply(this,arguments)}return __extends(RoadProceduralRenderTargetRenderer,t),RoadProceduralRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},RoadProceduralRenderTargetRenderer.prototype.createShader=function(){var t=e.CommonProceduralShader.create();return t.addLib(e.RoadProceduralShaderLib.create(this.texture)),t},RoadProceduralRenderTargetRenderer}(e.ProceduralRenderTargetRenderer);e.RoadProceduralRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function RoadProceduralTexture(){t.apply(this,arguments),this.roadColor=e.Color.create("rgb(0.53, 0.53, 0.53)")}return __extends(RoadProceduralTexture,t),RoadProceduralTexture.create=function(){var e=new this;return e.initWhenCreate(),e},RoadProceduralTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addProceduralRenderTargetRenderer(e.RoadProceduralRenderTargetRenderer.create(this)),this},__decorate([e.cloneAttributeAsCloneable()],RoadProceduralTexture.prototype,"roadColor",void 0),RoadProceduralTexture}(e.ProceduralTexture);e.RoadProceduralTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function RoadProceduralShaderLib(t){e.call(this),this.type="road_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=t}return __extends(RoadProceduralShaderLib,e),RoadProceduralShaderLib.create=function(e){var t=new this(e);return t},RoadProceduralShaderLib.prototype.sendShaderVariables=function(e,t){var r=this._proceduralTexture;this.sendUniformData(e,"u_roadColor",r.roadColor.toVector3())},RoadProceduralShaderLib.prototype.setShaderDefinition=function(t){e.prototype.setShaderDefinition.call(this,t),this.addUniformVariable(["u_roadColor"])},RoadProceduralShaderLib}(e.ProceduralShaderLib);e.RoadProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CloudProceduralRenderTargetRenderer(){t.apply(this,arguments)}return __extends(CloudProceduralRenderTargetRenderer,t),CloudProceduralRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},CloudProceduralRenderTargetRenderer.prototype.createShader=function(){var t=e.CommonProceduralShader.create();return t.addLib(e.CloudProceduralShaderLib.create(this.texture)),t},CloudProceduralRenderTargetRenderer}(e.ProceduralRenderTargetRenderer);e.CloudProceduralRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CloudProceduralTexture(){t.apply(this,arguments),this.skyColor=e.Color.create("rgb(0.15, 0.68, 1.0)"),this.cloudColor=e.Color.create("rgb(1.0, 1.0, 1.0)")}return __extends(CloudProceduralTexture,t),CloudProceduralTexture.create=function(){var e=new this;return e.initWhenCreate(),e},CloudProceduralTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addProceduralRenderTargetRenderer(e.CloudProceduralRenderTargetRenderer.create(this)),this},__decorate([e.cloneAttributeAsCloneable()],CloudProceduralTexture.prototype,"skyColor",void 0),
__decorate([e.cloneAttributeAsCloneable()],CloudProceduralTexture.prototype,"cloudColor",void 0),CloudProceduralTexture}(e.ProceduralTexture);e.CloudProceduralTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CloudProceduralShaderLib(t){e.call(this),this.type="cloud_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=t}return __extends(CloudProceduralShaderLib,e),CloudProceduralShaderLib.create=function(e){var t=new this(e);return t},CloudProceduralShaderLib.prototype.sendShaderVariables=function(e,t){var r=this._proceduralTexture;this.sendUniformData(e,"u_skyColor",r.skyColor.toVector4()),this.sendUniformData(e,"u_cloudColor",r.cloudColor.toVector4())},CloudProceduralShaderLib.prototype.setShaderDefinition=function(t){e.prototype.setShaderDefinition.call(this,t),this.addUniformVariable(["u_skyColor","u_cloudColor"])},CloudProceduralShaderLib}(e.ProceduralShaderLib);e.CloudProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BrickProceduralRenderTargetRenderer(){t.apply(this,arguments)}return __extends(BrickProceduralRenderTargetRenderer,t),BrickProceduralRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},BrickProceduralRenderTargetRenderer.prototype.createShader=function(){var t=e.CommonProceduralShader.create();return t.addLib(e.BrickProceduralShaderLib.create(this.texture)),t},BrickProceduralRenderTargetRenderer}(e.ProceduralRenderTargetRenderer);e.BrickProceduralRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BrickProceduralTexture(){t.apply(this,arguments),this.tilesHeightNumber=15,this.tilesWidthNumber=5,this.brickColor=e.Color.create("rgb(0.77, 0.47, 0.40)"),this.jointColor=e.Color.create("rgb(0.72, 0.72, 0.72)")}return __extends(BrickProceduralTexture,t),BrickProceduralTexture.create=function(){var e=new this;return e.initWhenCreate(),e},BrickProceduralTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addProceduralRenderTargetRenderer(e.BrickProceduralRenderTargetRenderer.create(this)),this},__decorate([e.cloneAttributeAsBasicType()],BrickProceduralTexture.prototype,"tilesHeightNumber",void 0),__decorate([e.cloneAttributeAsBasicType()],BrickProceduralTexture.prototype,"tilesWidthNumber",void 0),__decorate([e.cloneAttributeAsCloneable()],BrickProceduralTexture.prototype,"brickColor",void 0),__decorate([e.cloneAttributeAsCloneable()],BrickProceduralTexture.prototype,"jointColor",void 0),BrickProceduralTexture}(e.ProceduralTexture);e.BrickProceduralTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BrickProceduralShaderLib(t){e.call(this),this.type="brick_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=t}return __extends(BrickProceduralShaderLib,e),BrickProceduralShaderLib.create=function(e){var t=new this(e);return t},BrickProceduralShaderLib.prototype.sendShaderVariables=function(e,t){var r=this._proceduralTexture;this.sendUniformData(e,"u_tilesWidthNumber",r.tilesWidthNumber),this.sendUniformData(e,"u_tilesHeightNumber",r.tilesHeightNumber),this.sendUniformData(e,"u_brickColor",r.brickColor.toVector3()),this.sendUniformData(e,"u_jointColor",r.jointColor.toVector3())},BrickProceduralShaderLib.prototype.setShaderDefinition=function(t){e.prototype.setShaderDefinition.call(this,t),this.addUniformVariable(["u_tilesHeightNumber","u_tilesWidthNumber","u_brickColor","u_jointColor"])},BrickProceduralShaderLib}(e.ProceduralShaderLib);e.BrickProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomProceduralRenderTargetRenderer(){t.apply(this,arguments)}return __extends(CustomProceduralRenderTargetRenderer,t),CustomProceduralRenderTargetRenderer.create=function(e){var t=new this(e);return t.initWhenCreate(),t},CustomProceduralRenderTargetRenderer.prototype.createShader=function(){var t=e.CustomProceduralShader.create(this.texture);return t.addLib(e.CustomProceduralShaderLib.create(this.texture)),t},CustomProceduralRenderTargetRenderer}(e.ProceduralRenderTargetRenderer);e.CustomProceduralRenderTargetRenderer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomProceduralTexture(){t.apply(this,arguments),this.mapManager=e.MapManager.create(),this.uniformMap=wdCb.Hash.create(),this.fsSource=null}return __extends(CustomProceduralTexture,t),CustomProceduralTexture.create=function(){var e=new this;return e.initWhenCreate(),e},CustomProceduralTexture.prototype.init=function(){return t.prototype.init.call(this),e.Director.getInstance().scene.addProceduralRenderTargetRenderer(e.CustomProceduralRenderTargetRenderer.create(this)),this},CustomProceduralTexture.prototype.read=function(t){var r=e.LoaderManager.getInstance().get(t),n=r.uniforms;this.fsSource=e.LoaderManager.getInstance().get(r.fsSourceId),this.renderRate=r.renderRate||0;for(var i in n)if(n.hasOwnProperty(i)){var a=n[i];a.type===e.EVariableType.SAMPLER_2D?this.mapManager.addMap(e.LoaderManager.getInstance().get(a.textureId),{samplerVariableName:i}):this.uniformMap.addChild(i,a)}},__decorate([e.cloneAttributeAsCustomType(function(e,t,r){e[r].getMapList().forEach(function(e){t[r].addMap(e.clone())})})],CustomProceduralTexture.prototype,"mapManager",void 0),__decorate([e.cloneAttributeAsCloneable()],CustomProceduralTexture.prototype,"uniformMap",void 0),__decorate([e.cloneAttributeAsBasicType()],CustomProceduralTexture.prototype,"fsSource",void 0),__decorate([e.require(function(t){var r=e.LoaderManager.getInstance().get(t),n=r.uniforms;for(var i in n)if(n.hasOwnProperty(i)){var a=n[i];e.assert(a.type!==e.EVariableType.SAMPLER_CUBE,e.Log.info.FUNC_NOT_SUPPORT("uniforms","EVariableType.SAMPLER_CUBE type"))}}),e.ensure(function(){e.assert(null!==this.fsSource,e.Log.info.FUNC_SHOULD("read fragment glsl source"))})],CustomProceduralTexture.prototype,"read",null),CustomProceduralTexture}(e.ProceduralTexture);e.CustomProceduralTexture=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CustomProceduralShaderLib(e){t.call(this),this.type="custom_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(CustomProceduralShaderLib,t),CustomProceduralShaderLib.create=function(e){var t=new this(e);return t},CustomProceduralShaderLib.prototype.sendShaderVariables=function(t,r){var n=this._proceduralTexture,i=n.uniformMap;i.forEach(function(r,n){e.CustomShaderLibUtils.sendUniformData(n,r.type,r.value,t)})},CustomProceduralShaderLib.prototype.setShaderDefinition=function(e){var r=this._proceduralTexture;t.prototype.setShaderDefinition.call(this,e),this.setFsSource(r.fsSource)},CustomProceduralShaderLib}(e.ProceduralShaderLib);e.CustomProceduralShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MirrorMaterial(){t.apply(this,arguments),this._reflectionMap=null}return __extends(MirrorMaterial,t),MirrorMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(MirrorMaterial.prototype,"reflectionMap",{get:function(){return this._reflectionMap},set:function(t){this.mapManager.addMap(t,{samplerVariableName:e.VariableNameTable.getVariableName("reflectionMap")}),this._reflectionMap=t},enumerable:!0,configurable:!0}),MirrorMaterial.prototype.getTextureForRenderSort=function(){return this.reflectionMap},MirrorMaterial.prototype.addExtendShaderLib=function(){this.reflectionMap&&this.shader.addLib(e.MirrorShaderLib.create())},__decorate([e.cloneAttributeAsCloneable()],MirrorMaterial.prototype,"reflectionMap",null),MirrorMaterial}(e.StandardLightMaterial);e.MirrorMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MirrorShaderLib(){t.apply(this,arguments),this.type="mirror"}return __extends(MirrorShaderLib,t),MirrorShaderLib.create=function(){var e=new this;return e},MirrorShaderLib.prototype.sendShaderVariables=function(t,r,n){e.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(t,e.EShaderGLSLData.MIRROR)},MirrorShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable(["u_isRenderListEmpty",e.VariableNameTable.getVariableName("reflectionMap")])},MirrorShaderLib}(e.EngineShaderLib);e.MirrorShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TerrainMaterial(){t.apply(this,arguments),this.layer=e.TerrainLayer.create(),this.mix=e.TerrainMix.create()}return __extends(TerrainMaterial,t),TerrainMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},TerrainMaterial.prototype.init=function(){this.layer.hasData()&&this.layer.addMap(this.mapManager),this.mix.hasData()&&this.mix.addMap(this.mapManager),t.prototype.init.call(this)},TerrainMaterial.prototype.getTextureForRenderSort=function(){return this.layer.hasData()?this.layer.getTextureForRenderSort():this.mix.hasData()?this.mix.getTextureForRenderSort():void 0},TerrainMaterial.prototype.addExtendShaderLib=function(){this.layer.hasData()&&this.shader.addLib(e.TerrainLayerShaderLib.create()),this.mix.hasData()&&this.shader.addLib(e.TerrainMixMapShaderLib.create())},TerrainMaterial.prototype.addTopExtendShaderLib=function(){this.mix.hasData()&&this.shader.addLib(e.TerrainMixCommonShaderLib.create())},TerrainMaterial.prototype.addNormalRelatedShaderLib=function(){this.mix.hasBumpMap()?this.shader.addLib(e.TerrainMixBumpShaderLib.create()):t.prototype.addNormalRelatedShaderLib.call(this)},__decorate([e.cloneAttributeAsCloneable()],TerrainMaterial.prototype,"layer",void 0),__decorate([e.cloneAttributeAsCloneable()],TerrainMaterial.prototype,"mix",void 0),TerrainMaterial}(e.StandardLightMaterial);e.TerrainMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(){function TerrainLayer(){this._mapData=[]}return TerrainLayer.create=function(){var e=new this;return e},Object.defineProperty(TerrainLayer.prototype,"mapData",{get:function(){return this._mapData},set:function(e){this._mapData=e},enumerable:!0,configurable:!0}),Object.defineProperty(TerrainLayer.prototype,"mapArray",{get:function(){return this._mapData.map(function(e){return e.diffuseMap})},enumerable:!0,configurable:!0}),TerrainLayer.prototype.addMap=function(e){e.addMapArray("u_layerSampler2Ds",this.mapArray)},TerrainLayer.prototype.hasData=function(){return this.mapData.length>0},TerrainLayer.prototype.getMapCount=function(){return this.mapData.length},TerrainLayer.prototype.getTextureForRenderSort=function(){return this.mapArray[0]},TerrainLayer.prototype.clone=function(t){return e.CloneUtils.clone(this,null,null,t)},__decorate([e.requireSetter(function(t){e.it("mapData should be Array type",function(){e.expect(t).be.a("array")}),e.it("minHeight should < maxHeight",function(){t.forEach(function(t){e.expect(t.minHeight).lessThan(t.maxHeight)})}),e.it("height range should not overlap",function(){t.forEach(function(r){t.filter(function(e){return e.minHeight!==r.minHeight||e.maxHeight!==r.maxHeight}).forEach(function(t){e.expect(r.minHeight>=t.maxHeight||r.maxHeight<=t.minHeight).true})})})}),e.cloneAttributeAsCustomType(function(e,t,r){for(var n=e[r],i=[],a=0,o=n;a<o.length;a++){var s=o[a];i.push({minHeight:s.minHeight,maxHeight:s.maxHeight,diffuseMap:s.diffuseMap.clone()})}t[r]=i})],TerrainLayer.prototype,"mapData",null),__decorate([e.ensureGetter(function(t){e.it("should return Array<Texture>",function(){e.expect(t).be.a("array");for(var r=0,n=t;r<n.length;r++){var i=n[r];e.expect(i).instanceOf(e.Texture)}})})],TerrainLayer.prototype,"mapArray",null),TerrainLayer}();e.TerrainLayer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TerrainLayerShaderLib(){t.apply(this,arguments),this.type="terrain_layer"}return __extends(TerrainLayerShaderLib,t),TerrainLayerShaderLib.create=function(){var e=new this;return e},TerrainLayerShaderLib.prototype.sendShaderVariables=function(t,r,n){n.layer.mapData.forEach(function(r,n){t.sendStructureData("u_layerHeightDatas["+n+"].minHeight",e.EVariableType.FLOAT_1,r.minHeight),t.sendStructureData("u_layerHeightDatas["+n+"].maxHeight",e.EVariableType.FLOAT_1,r.maxHeight),t.sendStructureData("u_layerHeightDatas["+n+"].repeatRegion",e.EVariableType.VECTOR_4,r.diffuseMap.repeatRegion)})},TerrainLayerShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_layerHeightDatas","u_layerSampler2Ds"]),this.fsSourceDefineList.addChildren([{name:"LAYER_COUNT",value:r.layer.getMapCount()}])},__decorate([e.require(function(t,r){e.it("TerrainMaterial->layer->mapData->count should > 0",function(){e.expect(r).exist,e.expect(r.layer.getMapCount()).greaterThan(0)})})],TerrainLayerShaderLib.prototype,"setShaderDefinition",null),TerrainLayerShaderLib}(e.EngineShaderLib);e.TerrainLayerShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(){function TerrainMix(){this._mapData={},this.alphaTest=.4}return TerrainMix.create=function(){var e=new this;return e},Object.defineProperty(TerrainMix.prototype,"mapData",{get:function(){return this._mapData},set:function(e){this._mapData=e},enumerable:!0,configurable:!0}),TerrainMix.prototype.addMap=function(t){t.addMap(this.mapData.mixMap,{samplerVariableName:e.VariableNameTable.getVariableName("mixMap")}),t.addMap(this.mapData.diffuseMap1,{samplerVariableName:e.VariableNameTable.getVariableName("diffuseMap1")}),t.addMap(this.mapData.diffuseMap2,{samplerVariableName:e.VariableNameTable.getVariableName("diffuseMap2")}),t.addMap(this.mapData.diffuseMap3,{samplerVariableName:e.VariableNameTable.getVariableName("diffuseMap3")}),this.hasBumpMap()&&(this._addBumpMap(t,this.mapData.bumpMap1,this.mapData.diffuseMap1,"bumpMap1"),this._addBumpMap(t,this.mapData.bumpMap2,this.mapData.diffuseMap2,"bumpMap2"),this._addBumpMap(t,this.mapData.bumpMap3,this.mapData.diffuseMap3,"bumpMap3"))},TerrainMix.prototype.hasData=function(){for(var e in this.mapData)if(this.mapData.hasOwnProperty(e))return!0;return!1},TerrainMix.prototype.hasBumpMap=function(){return!!this.mapData.bumpMap1||!!this.mapData.bumpMap2||!!this.mapData.bumpMap3},TerrainMix.prototype.getTextureForRenderSort=function(){return this.mapData.mixMap},TerrainMix.prototype.clone=function(t){return e.CloneUtils.clone(this,null,null,t)},TerrainMix.prototype._setBumpMapRepeatRegion=function(e,t){e.wrapS=t.wrapS,e.wrapT=t.wrapT},TerrainMix.prototype._addBumpMap=function(t,r,n,i){this._setBumpMapRepeatRegion(r,n),t.addMap(r,{samplerVariableName:e.VariableNameTable.getVariableName(i)})},__decorate([e.requireSetter(function(t){e.it("mapData should be Object type",function(){e.expect(t).be.a("object"),e.expect(t.mixMap).exist})}),e.cloneAttributeAsCustomType(function(e,t,r){var n=e[r],i=t[r];for(var a in n)i[a]=n[a].clone()})],TerrainMix.prototype,"mapData",null),__decorate([e.cloneAttributeAsBasicType()],TerrainMix.prototype,"alphaTest",void 0),__decorate([e.require(function(t){var r=this;e.it("mapData at least should has mixMap and 3 diffuseMaps",function(){var t=r.mapData;e.expect(t.mixMap).exist,e.expect(t.diffuseMap1).exist,e.expect(t.diffuseMap2).exist,e.expect(t.diffuseMap3).exist}),e.describe("if has bump map",function(){var t=this;e.it("should has 3 bump maps",function(){var r=t.mapData;e.expect(r.bumpMap1).exist,e.expect(r.bumpMap2).exist,e.expect(r.bumpMap3).exist}),e.it("bump map should be ImageTexture",function(){var r=t.mapData;e.expect(r.bumpMap1).instanceOf(e.ImageTexture),e.expect(r.bumpMap2).instanceOf(e.ImageTexture),e.expect(r.bumpMap3).instanceOf(e.ImageTexture)})},function(){return r.hasBumpMap()},this)})],TerrainMix.prototype,"addMap",null),__decorate([e.ensure(function(t){var r=this;e.it("if has bump map, should has 3 bump maps",function(){if(t){var n=r.mapData;e.expect(n.bumpMap1).exist,e.expect(n.bumpMap2).exist,e.expect(n.bumpMap3).exist}})})],TerrainMix.prototype,"hasBumpMap",null),TerrainMix}();e.TerrainMix=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TerrainMixBumpShaderLib(){t.apply(this,arguments),this.type="terrain_mix_bump"}return __extends(TerrainMixBumpShaderLib,t),TerrainMixBumpShaderLib.create=function(){var e=new this;return e},TerrainMixBumpShaderLib.prototype.setShaderDefinition=function(r,n){var i=null;t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([e.VariableNameTable.getVariableName("bumpMap1"),e.VariableNameTable.getVariableName("bumpMap2"),e.VariableNameTable.getVariableName("bumpMap3")]),this.vsSourceVarDeclare=e.ShaderChunk.noNormalMap_vertex.varDeclare,this.vsSourceBody=e.ShaderChunk.noNormalMap_vertex.body,i=e.ShaderChunk.noNormalMap_light_fragment,this.fsSourceVarDeclare=i.varDeclare,this.fsSourceFuncDefine=i.funcDefine+this.fsSourceFuncDefine,e.GPUDetector.getInstance().extensionStandardDerivatives?(this.fsSourceExtensionList.addChild("GL_OES_standard_derivatives"),this.fsSourceFuncDefine=e.ShaderChunk.terrain_mix_bump_cotangentFrame_standardDerivatives.funcDefine+this.fsSourceFuncDefine):this.fsSourceFuncDefine=e.ShaderChunk.terrain_mix_bump_cotangentFrame_fallback.funcDefine+this.fsSourceFuncDefine},TerrainMixBumpShaderLib}(e.EngineShaderLib);e.TerrainMixBumpShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function TerrainMixCommonShaderLib(){e.apply(this,arguments),this.type="terrain_mix_common"}return __extends(TerrainMixCommonShaderLib,e),TerrainMixCommonShaderLib.create=function(){var e=new this;return e},TerrainMixCommonShaderLib}(e.EngineShaderLib);e.TerrainMixCommonShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TerrainMixMapShaderLib(){t.apply(this,arguments),this.type="terrain_mix"}return __extends(TerrainMixMapShaderLib,t),TerrainMixMapShaderLib.create=function(){var e=new this;return e},TerrainMixMapShaderLib.prototype.sendShaderVariables=function(e,t,r){var n=r.mix.mapData;this.sendUniformData(e,"u_diffuseMap1RepeatRegion",n.diffuseMap1.repeatRegion),this.sendUniformData(e,"u_diffuseMap2RepeatRegion",n.diffuseMap2.repeatRegion),this.sendUniformData(e,"u_diffuseMap3RepeatRegion",n.diffuseMap3.repeatRegion)},TerrainMixMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([e.VariableNameTable.getVariableName("mixMap"),e.VariableNameTable.getVariableName("diffuseMap1"),e.VariableNameTable.getVariableName("diffuseMap2"),e.VariableNameTable.getVariableName("diffuseMap3"),"u_diffuseMap1RepeatRegion","u_diffuseMap2RepeatRegion","u_diffuseMap3RepeatRegion"]),this.fsSourceBody="if (baseColor.a < "+n.mix.alphaTest+"){\n            discard;\n            }\n            "+this.fsSourceBody},TerrainMixMapShaderLib}(e.EngineShaderLib);e.TerrainMixMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GrassMapBufferContainer(){t.apply(this,arguments),this._quadIndexBuffer=null}return __extends(GrassMapBufferContainer,t),GrassMapBufferContainer.create=function(e){var t=new this(e);return t},GrassMapBufferContainer.prototype.createBuffersFromGeometryData=function(){t.prototype.createBuffersFromGeometryData.call(this),this.getChild(e.EBufferDataType.CUSTOM,"quadIndices")},GrassMapBufferContainer.prototype.getBufferForRenderSort=function(){var t=this.getChild(e.EBufferDataType.VERTICE);return t?t:null},GrassMapBufferContainer.prototype.getCustomData=function(e){var t=this.geometryData[e];return this.hasData(t)?(this.createOnlyOnceAndUpdateArrayBuffer("_quadIndexBuffer",t,1),this._quadIndexBuffer):null},__decorate([e.cacheBufferForBufferContainer()],GrassMapBufferContainer.prototype,"getCustomData",null),GrassMapBufferContainer}(e.CommonBufferContainer);e.GrassMapBufferContainer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GrassMapGeometry(){t.apply(this,arguments),this.width=null,this.height=null,this._vertices=[],this._texCoords=[],this._indices=[],this._normals=[],this._quadIndices=[]}return __extends(GrassMapGeometry,t),GrassMapGeometry.create=function(){var e=new this;return e},GrassMapGeometry.prototype.computeData=function(){return this._generateFirstRect(),this._generateSecondRect(),this._generateThirdRect(),this._generateQuadIndices(),{vertices:this._vertices,faces:e.GeometryUtils.convertToFaces(this._indices,this._normals),texCoords:this._texCoords}},GrassMapGeometry.prototype.createBufferContainer=function(){return e.GrassMapBufferContainer.create(this.entityObject)},GrassMapGeometry.prototype.createGeometryData=function(t,r,n,i,a){var o=e.GrassMapGeometryData.create(this);return o.vertices=t,o.faces=r,o.texCoords=n,o.colors=i,o.quadIndices=this._quadIndices,o},GrassMapGeometry.prototype._generateFirstRect=function(){this._generateRect(null,0)},GrassMapGeometry.prototype._generateSecondRect=function(){this._generateRect(e.Matrix4.create().rotate(45,e.Vector3.up),1)},GrassMapGeometry.prototype._generateThirdRect=function(){this._generateRect(e.Matrix4.create().rotate(-45,e.Vector3.up),2)},GrassMapGeometry.prototype._generateRect=function(t,r){var n=this.width,i=this.height,a=-n/2,o=n/2,s=i/2,c=-i/2;null===t?this._vertices=this._vertices.concat([o,s,0,a,s,0,a,c,0,o,c,0]):this._vertices=this._vertices.concat(t.multiplyVector3(e.Vector3.create(o,s,0)).toArray(),t.multiplyVector3(e.Vector3.create(a,s,0)).toArray(),t.multiplyVector3(e.Vector3.create(a,c,0)).toArray(),t.multiplyVector3(e.Vector3.create(o,c,0)).toArray()),this._indices=this._indices.concat([0+4*r,1+4*r,2+4*r,0+4*r,2+4*r,3+4*r]),this._texCoords=this._texCoords.concat([1,1,0,1,0,0,1,0]),this._normals=this._normals.concat([0,1,0,0,1,0,0,1,0,0,1,0])},GrassMapGeometry.prototype._generateQuadIndices=function(){this._quadIndices=[0,0,0,0,1,1,1,1,2,2,2,2]},__decorate([e.cloneAttributeAsBasicType()],GrassMapGeometry.prototype,"width",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassMapGeometry.prototype,"height",void 0),GrassMapGeometry}(e.Geometry);e.GrassMapGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function GrassMapGeometryData(){e.apply(this,arguments),this._quadIndices=null}return __extends(GrassMapGeometryData,e),GrassMapGeometryData.create=function(e){var t=new this(e);return t},Object.defineProperty(GrassMapGeometryData.prototype,"quadIndices",{get:function(){return this._quadIndices},set:function(e){this._quadIndices=e,this.geometry.buffers.removeCache("quadIndices")},enumerable:!0,configurable:!0}),GrassMapGeometryData}(e.GeometryData);e.GrassMapGeometryData=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GrassMapMaterial(){t.apply(this,arguments),this._mapData=[],this.grassMap=null,this.alphaTest=1e-4,this.wind=r.create()}return __extends(GrassMapMaterial,t),GrassMapMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(GrassMapMaterial.prototype,"mapData",{get:function(){return this._mapData},set:function(e){this._mapData=e},enumerable:!0,configurable:!0}),GrassMapMaterial.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.side=e.ESide.BOTH},GrassMapMaterial.prototype.init=function(){this.mapManager.addMap(this.grassMap,{samplerVariableName:e.VariableNameTable.getVariableName("grassMap")}),t.prototype.init.call(this)},GrassMapMaterial.prototype.getTextureForRenderSort=function(){return this.grassMap},GrassMapMaterial.prototype.updateShader=function(e){this.wind.computeTime(),t.prototype.updateShader.call(this,e)},GrassMapMaterial.prototype.addExtendShaderLib=function(){this.shader.addLib(e.GrassMapShaderLib.create())},GrassMapMaterial.prototype.addLightSetWorldPositionShaderLib=function(){this.shader.addLib(e.GrassMapSetWorldPositionShaderLib.create())},__decorate([e.requireSetter(function(t){e.it("should contain 3 sourceRegion data",function(){e.expect(t.length).equal(3);for(var r=0,n=t;r<n.length;r++){var i=n[r];e.expect(i.sourceRegion).exist}})}),e.cloneAttributeAsCustomType(function(e,t,r){for(var n=e[r],i=[],a=0,o=n;a<o.length;a++){var s=o[a];i.push({sourceRegion:s.sourceRegion.clone()})}t[r]=i})],GrassMapMaterial.prototype,"mapData",null),__decorate([e.cloneAttributeAsCloneable()],GrassMapMaterial.prototype,"grassMap",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassMapMaterial.prototype,"alphaTest",void 0),__decorate([e.cloneAttributeAsCloneable()],GrassMapMaterial.prototype,"wind",void 0),GrassMapMaterial}(e.StandardLightMaterial);e.GrassMapMaterial=t;var r=function(){function GrassWindModel(){this.time=0,this.speed=.1,this.direction=e.Vector2.create(1,1),this.strength=.5}return GrassWindModel.create=function(){var e=new this;return e},GrassWindModel.prototype.clone=function(){return e.CloneUtils.clone(this)},GrassWindModel.prototype.computeTime=function(){this.time+=this.speed},__decorate([e.cloneAttributeAsBasicType()],GrassWindModel.prototype,"time",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassWindModel.prototype,"speed",void 0),__decorate([e.cloneAttributeAsCloneable()],GrassWindModel.prototype,"direction",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassWindModel.prototype,"strength",void 0),GrassWindModel}();e.GrassWindModel=r}(wd||(wd={}));var wd;!function(e){var t=function(t){function GrassMapSetWorldPositionShaderLib(){t.apply(this,arguments),this.type="grass_map_setWorldPosition"}return __extends(GrassMapSetWorldPositionShaderLib,t),GrassMapSetWorldPositionShaderLib.create=function(){var e=new this;return e},GrassMapSetWorldPositionShaderLib.prototype.sendShaderVariables=function(t,r,n){t.sendStructureData("u_windData.direction",e.EVariableType.VECTOR_2,n.wind.direction),t.sendStructureData("u_windData.time",e.EVariableType.FLOAT_1,n.wind.time),t.sendStructureData("u_windData.strength",e.EVariableType.FLOAT_1,n.wind.strength)},GrassMapSetWorldPositionShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_windData"])},GrassMapSetWorldPositionShaderLib}(e.EngineShaderLib);e.GrassMapSetWorldPositionShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GrassMapShaderLib(){t.apply(this,arguments),this.type="grass_map"}return __extends(GrassMapShaderLib,t),GrassMapShaderLib.create=function(){var e=new this;return e},GrassMapShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=r.buffers.getChild(e.EBufferDataType.CUSTOM,"quadIndices");if(i){var a=n.grassMap;this.sendAttributeBuffer(t,"a_quadIndex",i),t.sendStructureData("u_windData.direction",e.EVariableType.VECTOR_2,n.wind.direction),t.sendStructureData("u_windData.time",e.EVariableType.FLOAT_1,n.wind.time),t.sendStructureData("u_windData.strength",e.EVariableType.FLOAT_1,n.wind.strength),n.mapData.forEach(function(r,n){t.sendStructureData("u_grassMapDatas["+n+"].sourceRegion",e.EVariableType.VECTOR_4,e.GlobalTextureUtils.convertSourceRegionCanvasMapToUV(r.sourceRegion,a.width,a.height))})}},GrassMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addAttributeVariable(["a_quadIndex"]),this.addUniformVariable([e.VariableNameTable.getVariableName("grassMap"),"u_grassMapDatas","u_windData"]),this.fsSourceBody+="if (totalColor.a < "+n.alphaTest+"){\n    discard;\n}\n"},GrassMapShaderLib}(e.EngineShaderLib);e.GrassMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GrassInstanceGeometry(){t.apply(this,arguments),this.bladeCount=10,this.bladeSegments=4,this.bladeWidth=.15,this.bladeMinHeight=2,this.bladeMaxHeight=4,this.rangeWidth=5,this.rangeHeight=5,this.vertexIndexBuffer=null}return __extends(GrassInstanceGeometry,t),GrassInstanceGeometry.create=function(){var e=new this;return e},Object.defineProperty(GrassInstanceGeometry.prototype,"bladeVerts",{get:function(){return 2*this.bladeDivs},enumerable:!0,configurable:!0}),Object.defineProperty(GrassInstanceGeometry.prototype,"bladeDivs",{get:function(){return this.bladeSegments+1},enumerable:!0,configurable:!0}),GrassInstanceGeometry.prototype.computeData=function(){for(var r=0;r<this.bladeCount;r++)this.addInstanceAttributes([{attributeName:"a_shape",data:this._generateShapes(),meshPerAttribute:1},{attributeName:"a_offset",data:this._generateOffsets(),meshPerAttribute:1}]);return this.vertexIndexBuffer=e.BufferUtils.convertArrayToArrayBuffer(e.EVariableType.FLOAT_1,this._generateVertexIndex()),this.indices=this._generateIndices(),this.vertices=this._generateVerticesForCollisionCheck(),t.prototype.computeData.call(this)},GrassInstanceGeometry.prototype._generateVertexIndex=function(){for(var e=[],t=2*this.bladeVerts*1,r=0;r<t;r++)e[r]=r;return e},GrassInstanceGeometry.prototype._generateVerticesForCollisionCheck=function(){var e=this.rangeWidth/2,t=this.bladeMaxHeight,r=this.rangeHeight/2;return[-e,t,r,e,t,r,e,0,r,-e,0,r,-e,t,-r,e,t,-r,e,0,-r,-e,0,-r]},GrassInstanceGeometry.prototype._generateShapes=function(){var e=[],t=this.bladeWidth+Math.random()*this.bladeWidth*.5,r=this.bladeMinHeight+Math.pow(Math.random(),4)*(this.bladeMaxHeight-this.bladeMinHeight),n=0+.2*Math.random(),i=.2+.2*Math.random();return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e},GrassInstanceGeometry.prototype._generateOffsets=function(){var t=[],r=e.MathUtils.generateMinToMax(-1,1)*this.rangeWidth,n=0,i=e.MathUtils.generateMinToMax(-1,1)*this.rangeHeight,a=2*Math.PI*Math.random();return t[0]=r,t[1]=n,t[2]=i,t[3]=a,t},GrassInstanceGeometry.prototype._generateIndices=function(){var e=null,t=0,r=0,n=this.bladeVerts,i=[];for(e=0;e<this.bladeSegments;e++)i[t++]=r+0,i[t++]=r+1,i[t++]=r+2,i[t++]=r+2,i[t++]=r+1,i[t++]=r+3,r+=2;for(e=0;e<this.bladeSegments;e++)i[t++]=n+2,i[t++]=n+1,i[t++]=n+0,i[t++]=n+3,i[t++]=n+1,i[t++]=n+2,n+=2;return i},__decorate([e.cloneAttributeAsBasicType()],GrassInstanceGeometry.prototype,"bladeCount",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassInstanceGeometry.prototype,"bladeSegments",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassInstanceGeometry.prototype,"bladeWidth",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassInstanceGeometry.prototype,"bladeMinHeight",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassInstanceGeometry.prototype,"bladeMaxHeight",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassInstanceGeometry.prototype,"rangeWidth",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassInstanceGeometry.prototype,"rangeHeight",void 0),GrassInstanceGeometry}(e.InstanceGeometry);e.GrassInstanceGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GrassInstanceMaterial(){t.apply(this,arguments),this.map=null,this.time=0,this.speed=.01,this.terrainGeometry=null}return __extends(GrassInstanceMaterial,t),GrassInstanceMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},GrassInstanceMaterial.prototype.init=function(){this.mapManager.addMap(this.map,{samplerVariableName:e.VariableNameTable.getVariableName("grassMap")}),this.terrainGeometry&&this.terrainGeometry.heightMapAsset&&this.mapManager.addMap(this.terrainGeometry.heightMapAsset.toTexture(),{samplerVariableName:e.VariableNameTable.getVariableName("heightMap")}),this._addShaderLib(),t.prototype.init.call(this)},GrassInstanceMaterial.prototype.getTextureForRenderSort=function(){return this.map},GrassInstanceMaterial.prototype.updateShader=function(e){this._computeTime(),t.prototype.updateShader.call(this,e)},GrassInstanceMaterial.prototype.createShader=function(){return e.CommonShader.create()},GrassInstanceMaterial.prototype._addShaderLib=function(){this.shader.addLib(e.GrassCommonInstanceShaderLib.create()),e.InstanceUtils.isHardwareSupport()?this.shader.addLib(e.GrassHardwareInstanceShaderLib.create()):this.shader.addLib(e.GrassBatchInstanceShaderLib.create()),this.shader.addLib(e.EndShaderLib.create())},GrassInstanceMaterial.prototype._computeTime=function(){this.time+=this.speed},__decorate([e.cloneAttributeAsCloneable()],GrassInstanceMaterial.prototype,"map",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassInstanceMaterial.prototype,"time",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassInstanceMaterial.prototype,"speed",void 0),__decorate([e.cloneAttributeAsBasicType()],GrassInstanceMaterial.prototype,"terrainGeometry",void 0),
GrassInstanceMaterial}(e.Material);e.GrassInstanceMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function GrassInstanceShaderLib(){e.apply(this,arguments)}return __extends(GrassInstanceShaderLib,e),GrassInstanceShaderLib}(e.EngineShaderLib);e.GrassInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function GrassBatchInstanceShaderLib(){e.apply(this,arguments),this.type="grass_batch_instance"}return __extends(GrassBatchInstanceShaderLib,e),GrassBatchInstanceShaderLib.create=function(){var e=new this;return e},GrassBatchInstanceShaderLib}(e.GrassInstanceShaderLib);e.GrassBatchInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function GrassCommonInstanceShaderLib(){t.apply(this,arguments),this.type="grass_common_instance"}return __extends(GrassCommonInstanceShaderLib,t),GrassCommonInstanceShaderLib.create=function(){var e=new this;return e},GrassCommonInstanceShaderLib.prototype.sendShaderVariables=function(e,t,r){var n=r.geometry;this.sendAttributeBuffer(e,"a_vertexIndex",r.geometry.vertexIndexBuffer),this.sendUniformData(e,"u_mMatrix",t.mMatrix),this.sendUniformData(e,"u_vpMatrix",t.vpMatrix),this.sendUniformData(e,"u_grassRangeWidth",n.rangeWidth),this.sendUniformData(e,"u_grassRangeHeight",n.rangeHeight),this.sendUniformData(e,"u_time",r.time),this._sendTerrainData(r,e),this._sendLightData(e)},GrassCommonInstanceShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addAttributeVariable(["a_vertexIndex"]),this.addUniformVariable(["u_grassMapSampler","u_mMatrix","u_vpMatrix","u_grassRangeWidth","u_grassRangeHeight","u_time","u_terrainRangeWidth","u_terrainRangeHeight","u_terrainMinHeight","u_terrainMaxHeight","u_terrainSubdivisions","u_terrainScaleY","u_terrainPositionY","u_heightMapSampler","u_lightPos","u_lightColor"]),this.vsSourceFuncDefine=e.ShaderChunk.common_heightMap.funcDefine+e.ShaderChunk.common_light.funcDefine+this.vsSourceFuncDefine;var i=n.geometry;this.vsSourceDefineList.addChildren([{name:"BLADE_SEGS",value:i.bladeSegments+".0"},{name:"BLADE_DIVS",value:i.bladeDivs+".0"},{name:"BLADE_VERTS",value:i.bladeVerts+".0"}])},GrassCommonInstanceShaderLib.prototype._sendTerrainData=function(e,t){var r=e.terrainGeometry;this.sendUniformData(t,"u_terrainRangeWidth",r.rangeWidth),this.sendUniformData(t,"u_terrainRangeHeight",r.rangeHeight),this.sendUniformData(t,"u_terrainMinHeight",r.minHeight),this.sendUniformData(t,"u_terrainMaxHeight",r.maxHeight),this.sendUniformData(t,"u_terrainSubdivisions",r.subdivisions);var n=r.entityObject.transform;this.sendUniformData(t,"u_terrainScaleY",n.scale.y),this.sendUniformData(t,"u_terrainPositionY",n.position.y)},GrassCommonInstanceShaderLib.prototype._sendLightData=function(t){var r=e.Director.getInstance().scene,n=r.directionLights,i=r.pointLights;if(n){var a=n.getChild(0).getComponent(e.DirectionLight);this.sendUniformData(t,"u_lightPos",e.LightUtils.getDirectionLightPosition(a)),this.sendUniformData(t,"u_lightColor",a.color.toVector3())}else if(i){var a=i.getChild(0).getComponent(e.PointLight);this.sendUniformData(t,"u_lightPos",e.LightUtils.getPointLightPosition(a)),this.sendUniformData(t,"u_lightColor",a.color.toVector3())}},__decorate([e.require(function(t,r,n){e.it("geometry should be GrassInstanceGeometry",function(){e.expect(n.geometry).instanceOf(e.GrassInstanceGeometry)})})],GrassCommonInstanceShaderLib.prototype,"sendShaderVariables",null),__decorate([e.require(function(t,r){var n=t.terrainGeometry;e.it("material.terrainGeometry should exist ",function(){e.expect(n).exist}),e.it("subdivisions should >= 2",function(){e.expect(n.subdivisions).greaterThan(1)}),e.it("rangeWidth,rangeHeight should > 0",function(){e.expect(n.rangeWidth).greaterThan(0),e.expect(n.rangeHeight).greaterThan(0)}),e.it("min height should < max height",function(){e.expect(n.minHeight).lessThan(n.maxHeight)})})],GrassCommonInstanceShaderLib.prototype,"_sendTerrainData",null),__decorate([e.require(function(){var t=e.Director.getInstance().scene,r=t.directionLights,n=t.pointLights;e.it("should exist light",function(){e.expect(!r&&!n).false,r&&e.expect(r).not.empty,n&&e.expect(n).not.empty})})],GrassCommonInstanceShaderLib.prototype,"_sendLightData",null),GrassCommonInstanceShaderLib}(e.EngineShaderLib);e.GrassCommonInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function GrassHardwareInstanceShaderLib(){e.apply(this,arguments),this.type="grass_hardware_instance"}return __extends(GrassHardwareInstanceShaderLib,e),GrassHardwareInstanceShaderLib.create=function(){var e=new this;return e},GrassHardwareInstanceShaderLib}(e.GrassInstanceShaderLib);e.GrassHardwareInstanceShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WaterBumpMapShaderLib(){t.apply(this,arguments),this.type="water_bump"}return __extends(WaterBumpMapShaderLib,t),WaterBumpMapShaderLib.create=function(){var e=new this;return e},WaterBumpMapShaderLib.prototype.sendShaderVariables=function(e,t,r){this.sendUniformData(e,"u_windMatrix",r.wind.matrix)},WaterBumpMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([e.VariableNameTable.getVariableName("bumpMap"),"u_windMatrix"])},WaterBumpMapShaderLib}(e.EngineShaderLib);e.WaterBumpMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WaterFresnelShaderLib(){t.apply(this,arguments),this.type="water_fresnel"}return __extends(WaterFresnelShaderLib,t),WaterFresnelShaderLib.create=function(){var e=new this;return e},WaterFresnelShaderLib.prototype.sendShaderVariables=function(t,r,n){e.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(t,e.EShaderGLSLData.MIRROR,"u_isReflectionRenderListEmpty"),e.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(t,e.EShaderGLSLData.REFRACTION,"u_isRefractionRenderListEmpty"),t.sendStructureData("u_levelData.fresnelLevel",e.EVariableType.FLOAT_1,n.fresnelLevel),t.sendStructureData("u_levelData.refractionLevel",e.EVariableType.FLOAT_1,n.refractionLevel),t.sendStructureData("u_levelData.reflectionLevel",e.EVariableType.FLOAT_1,n.reflectionLevel)},WaterFresnelShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable(["u_levelData","u_isReflectionRenderListEmpty","u_isRefractionRenderListEmpty",e.VariableNameTable.getVariableName("reflectionMap"),e.VariableNameTable.getVariableName("refractionMap")])},WaterFresnelShaderLib}(e.EngineShaderLib);e.WaterFresnelShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WaterMaterial(){t.apply(this,arguments),this._bumpMap=null,this._reflectionMap=null,this._refractionMap=null,this.wind=r.create(),this.wave=n.create(),this.fresnelLevel=1,this.reflectionLevel=.6,this.refractionLevel=.8}return __extends(WaterMaterial,t),WaterMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(WaterMaterial.prototype,"bumpMap",{get:function(){return this._bumpMap},set:function(t){t.wrapS=e.ETextureWrapMode.REPEAT,t.wrapT=e.ETextureWrapMode.REPEAT,this.mapManager.addMap(t,{samplerVariableName:e.VariableNameTable.getVariableName("bumpMap")}),this._bumpMap=t},enumerable:!0,configurable:!0}),Object.defineProperty(WaterMaterial.prototype,"reflectionMap",{get:function(){return this._reflectionMap},set:function(t){this.mapManager.addMap(t,{samplerVariableName:e.VariableNameTable.getVariableName("reflectionMap")}),this._reflectionMap=t},enumerable:!0,configurable:!0}),Object.defineProperty(WaterMaterial.prototype,"refractionMap",{get:function(){return this._refractionMap},set:function(t){this.mapManager.addMap(t,{samplerVariableName:e.VariableNameTable.getVariableName("refractionMap")}),this._refractionMap=t},enumerable:!0,configurable:!0}),WaterMaterial.prototype.updateShader=function(e){this.wind.computeTime(),t.prototype.updateShader.call(this,e)},WaterMaterial.prototype.getTextureForRenderSort=function(){return this.reflectionMap},WaterMaterial.prototype.addExtendShaderLib=function(){this.bumpMap?this.shader.addLib(e.WaterBumpMapShaderLib.create()):this.shader.addLib(e.WaterNoBumpMapShaderLib.create()),this.shader.addLib(e.WaterShaderLib.create()),this.reflectionMap&&this.refractionMap?this.shader.addLib(e.WaterFresnelShaderLib.create()):this.reflectionMap?this.shader.addLib(e.WaterReflectionMapShaderLib.create()):this.refractionMap?this.shader.addLib(e.WaterRefractionMapShaderLib.create()):this.shader.addLib(e.WaterNoLightEffectShaderLib.create())},__decorate([e.requireSetter(function(t){e.assert(t instanceof e.ImageTexture)}),e.cloneAttributeAsCloneable()],WaterMaterial.prototype,"bumpMap",null),__decorate([e.cloneAttributeAsCloneable()],WaterMaterial.prototype,"reflectionMap",null),__decorate([e.cloneAttributeAsCloneable()],WaterMaterial.prototype,"refractionMap",null),__decorate([e.cloneAttributeAsCloneable()],WaterMaterial.prototype,"wind",void 0),__decorate([e.cloneAttributeAsCloneable()],WaterMaterial.prototype,"wave",void 0),__decorate([e.cloneAttributeAsBasicType()],WaterMaterial.prototype,"fresnelLevel",void 0),__decorate([e.cloneAttributeAsBasicType()],WaterMaterial.prototype,"reflectionLevel",void 0),__decorate([e.cloneAttributeAsBasicType()],WaterMaterial.prototype,"refractionLevel",void 0),WaterMaterial}(e.StandardLightMaterial);e.WaterMaterial=t;var r=function(){function WaterWindModel(){this.time=0,this.direction=e.Vector2.create(0,1),this.speed=1e-4}return WaterWindModel.create=function(){var e=new this;return e},Object.defineProperty(WaterWindModel.prototype,"matrix",{get:function(){return e.Matrix4.create().translate(this.direction.x*this.time,this.direction.y*this.time,0)},enumerable:!0,configurable:!0}),WaterWindModel.prototype.clone=function(t){return e.CloneUtils.clone(this,null,null,t)},WaterWindModel.prototype.computeTime=function(){this.time+=this.speed},__decorate([e.cloneAttributeAsBasicType()],WaterWindModel.prototype,"time",void 0),__decorate([e.cloneAttributeAsBasicType()],WaterWindModel.prototype,"direction",void 0),__decorate([e.cloneAttributeAsBasicType()],WaterWindModel.prototype,"speed",void 0),WaterWindModel}();e.WaterWindModel=r;var n=function(){function WaterWaveModel(){this.height=.15,this.length=.1}return WaterWaveModel.create=function(){var e=new this;return e},WaterWaveModel.prototype.clone=function(t){return e.CloneUtils.clone(this,null,null,t)},__decorate([e.cloneAttributeAsBasicType()],WaterWaveModel.prototype,"height",void 0),__decorate([e.cloneAttributeAsBasicType()],WaterWaveModel.prototype,"length",void 0),WaterWaveModel}();e.WaterWaveModel=n}(wd||(wd={}));var wd;!function(e){var t=function(e){function WaterNoBumpMapShaderLib(){e.apply(this,arguments),this.type="water_noBump"}return __extends(WaterNoBumpMapShaderLib,e),WaterNoBumpMapShaderLib.create=function(){var e=new this;return e},WaterNoBumpMapShaderLib.prototype.sendShaderVariables=function(e,t,r){},WaterNoBumpMapShaderLib}(e.EngineShaderLib);e.WaterNoBumpMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function WaterNoLightEffectShaderLib(){e.apply(this,arguments),this.type="water_noLightEffect"}return __extends(WaterNoLightEffectShaderLib,e),WaterNoLightEffectShaderLib.create=function(){var e=new this;return e},WaterNoLightEffectShaderLib.prototype.sendShaderVariables=function(e,t,r){},WaterNoLightEffectShaderLib}(e.EngineShaderLib);e.WaterNoLightEffectShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WaterReflectionMapShaderLib(){t.apply(this,arguments),this.type="water_reflection"}return __extends(WaterReflectionMapShaderLib,t),WaterReflectionMapShaderLib.create=function(){var e=new this;return e},WaterReflectionMapShaderLib.prototype.sendShaderVariables=function(t,r,n){e.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(t,e.EShaderGLSLData.MIRROR,"u_isReflectionRenderListEmpty"),t.sendStructureData("u_levelData.reflectionLevel",e.EVariableType.FLOAT_1,n.reflectionLevel)},WaterReflectionMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable(["u_levelData","u_isReflectionRenderListEmpty",e.VariableNameTable.getVariableName("reflectionMap")])},WaterReflectionMapShaderLib}(e.EngineShaderLib);e.WaterReflectionMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WaterRefractionMapShaderLib(){t.apply(this,arguments),this.type="water_refraction"}return __extends(WaterRefractionMapShaderLib,t),WaterRefractionMapShaderLib.create=function(){var e=new this;return e},WaterRefractionMapShaderLib.prototype.sendShaderVariables=function(t,r,n){e.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(t,e.EShaderGLSLData.REFRACTION,"u_isRefractionRenderListEmpty"),t.sendStructureData("u_levelData.refractionLevel",e.EVariableType.FLOAT_1,n.refractionLevel)},WaterRefractionMapShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable(["u_levelData","u_isRefractionRenderListEmpty",e.VariableNameTable.getVariableName("refractionMap")])},WaterRefractionMapShaderLib}(e.EngineShaderLib);e.WaterRefractionMapShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function WaterShaderLib(){t.apply(this,arguments),this.type="water"}return __extends(WaterShaderLib,t),WaterShaderLib.create=function(){var e=new this;return e},WaterShaderLib.prototype.sendShaderVariables=function(t,r,n){t.sendStructureData("u_waveData.length",e.EVariableType.FLOAT_1,n.wave.length),t.sendStructureData("u_waveData.height",e.EVariableType.FLOAT_1,n.wave.height)},WaterShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_waveData"])},WaterShaderLib}(e.EngineShaderLib);e.WaterShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BitmapFontBufferContainer(){t.apply(this,arguments),this._pageBuffer=null}return __extends(BitmapFontBufferContainer,t),BitmapFontBufferContainer.create=function(e){var t=new this(e);return t},BitmapFontBufferContainer.prototype.createBuffersFromGeometryData=function(){t.prototype.createBuffersFromGeometryData.call(this),this.getChild(e.EBufferDataType.CUSTOM,"pages")},BitmapFontBufferContainer.prototype.getBufferForRenderSort=function(){var t=this.getChild(e.EBufferDataType.VERTICE);return t?t:null},BitmapFontBufferContainer.prototype.getCustomData=function(e){var t=this.geometryData[e];return this.hasData(t)?(this.createOnlyOnceAndUpdateArrayBuffer("_pageBuffer",t,1),this._pageBuffer):null},__decorate([e.cacheBufferForBufferContainer()],BitmapFontBufferContainer.prototype,"getCustomData",null),BitmapFontBufferContainer}(e.CommonBufferContainer);e.BitmapFontBufferContainer=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BitmapFontGeometry(){t.apply(this,arguments),this._pages=null}return __extends(BitmapFontGeometry,t),BitmapFontGeometry.create=function(){var e=new this;return e},BitmapFontGeometry.prototype.computeData=function(){var t=this.entityObject.getComponent(e.ThreeDBitmapFont),r=t.layoutDataList,n=null,i=null,a=null,o=e.LoaderManager.getInstance().get(t.fntId);return r?(n=this._generateVertices(r,t.width,t.height),i=this._generateTexCoords(r,o.scaleW,o.scaleH,this.material.isMapFlipY()),a=this._generateIndices(r),o.isMultiPages&&(this._pages=this._generatePages(r))):(n=[],i=[],a=[],this._pages=[]),{vertices:n,faces:e.GeometryUtils.convertToFaces(a,null),texCoords:i}},BitmapFontGeometry.prototype.updateBuffers=function(){if(null!==this.buffers){var e=this.computeData(),t=e.vertices,r=e.faces,n=e.texCoords;this.buffers.geometryData.vertices=t,this.buffers.geometryData.faces=r,this.buffers.geometryData.texCoords=n,this.hasMultiPages()&&(this.buffers.geometryData.pages=this._pages)}},BitmapFontGeometry.prototype.hasMultiPages=function(){return null!==this._pages&&this._pages.length>0},BitmapFontGeometry.prototype.createBufferContainer=function(){return this.hasMultiPages()?e.BitmapFontBufferContainer.create(this.entityObject):e.BasicBufferContainer.create(this.entityObject)},BitmapFontGeometry.prototype.createGeometryData=function(t,r,n,i,a){if(this.hasMultiPages()){var o=e.BitmapFontGeometryData.create(this);return o.vertices=t,o.faces=r,o.texCoords=n,o.colors=i,o.pages=this._pages,o}return this.createBasicGeometryData(t,r,n,i)},BitmapFontGeometry.prototype._generatePages=function(e){var t=[],r=0;return e.forEach(function(e){var n=e.data.page||0;t[r++]=n,t[r++]=n,t[r++]=n,t[r++]=n}),t},BitmapFontGeometry.prototype._generateVertices=function(t,r,n){var i=[],a=0;return t.forEach(function(t){var o=t.data.rect,s=0,c=o.width,u=o.height,l=e.CoordinateUtils.convertLeftCornerPositionToCenterPositionInWebGL(e.Vector2.create(t.position[0],t.position[1]),r,n),d=l.x,h=l.y;i[a++]=d,i[a++]=-h,i[a++]=s,i[a++]=d,i[a++]=-(h+u),i[a++]=s,i[a++]=d+c,i[a++]=-(h+u),i[a++]=s,i[a++]=d+c,i[a++]=-h,i[a++]=s}),i},BitmapFontGeometry.prototype._generateTexCoords=function(e,t,r,n){var i=[],a=0;return e.forEach(function(e){var o=e.data.rect,s=o.x+o.width,c=o.y+o.height,u=o.x/t,l=o.y/r,d=s/t,h=c/r;n&&(l=(r-o.y)/r,h=(r-c)/r),i[a++]=u,i[a++]=l,i[a++]=u,i[a++]=h,i[a++]=d,i[a++]=h,i[a++]=d,i[a++]=l}),i},BitmapFontGeometry.prototype._generateIndices=function(e){for(var t=6*e.getCount(),r=[],n=0,i=0;n<t;n+=6,i+=4)r[n]=i,r[n+1]=i+1,r[n+2]=i+2,r[n+3]=i,r[n+4]=i+2,r[n+5]=i+3;return r},BitmapFontGeometry}(e.Geometry);e.BitmapFontGeometry=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BitmapFontGeometryData(){e.apply(this,arguments),this._pages=null}return __extends(BitmapFontGeometryData,e),BitmapFontGeometryData.create=function(e){var t=new this(e);return t},Object.defineProperty(BitmapFontGeometryData.prototype,"pages",{get:function(){return this._pages},set:function(e){this._pages=e,this.geometry.buffers.removeCache("pages")},enumerable:!0,configurable:!0}),BitmapFontGeometryData}(e.GeometryData);e.BitmapFontGeometryData=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BitmapFontMaterial(){t.apply(this,arguments),this.enableSdf=!1,this.sdfType=e.SdfBitmapFontType.SMOOTH,this.alphaTest=1e-4,this._bitmap=null,this._pageMapData=null}return __extends(BitmapFontMaterial,t),BitmapFontMaterial.create=function(){var e=new this;return e.initWhenCreate(),e},Object.defineProperty(BitmapFontMaterial.prototype,"bitmap",{get:function(){return this._bitmap},set:function(t){this.mapManager.addMap(t,{samplerVariableName:e.VariableNameTable.getVariableName("bitmap")}),this._bitmap=t},enumerable:!0,configurable:!0}),Object.defineProperty(BitmapFontMaterial.prototype,"pageMapData",{get:function(){return this._pageMapData},set:function(e){this._pageMapData=e},enumerable:!0,configurable:!0}),BitmapFontMaterial.prototype.isMapFlipY=function(){return null!==this.pageMapData&&this.pageMapData.length>0?this.pageMapData[0].flipY:this.bitmap.flipY},BitmapFontMaterial.prototype.initWhenCreate=function(){t.prototype.initWhenCreate.call(this),this.blend=!0},BitmapFontMaterial.prototype.init=function(){this._hasMultiPages()&&this.mapManager.addMapArray("u_pageSampler2Ds",this.pageMapData),t.prototype.init.call(this)},BitmapFontMaterial.prototype.getTextureForRenderSort=function(){return this.bitmap?this.bitmap:this.pageMapData?this.pageMapData[0]:null},BitmapFontMaterial.prototype.addExtendShaderLib=function(){this._hasMultiPages()?this.shader.addLib(e.MultiPagesBitmapFontShaderLib.create()):this._isSdfFont()||this.shader.addLib(e.BasicBitmapFontShaderLib.create())},BitmapFontMaterial.prototype.addEndShaderLib=function(){if(this.shader.addLib(e.CommonBitmapFontShaderLib.create()),this._isSdfFont())switch(this.sdfType){case e.SdfBitmapFontType.SMOOTH:this.shader.addLib(e.SdfBitmapFontSmoothShaderLib.create());break;default:e.Log.error(!0,e.Log.info.FUNC_UNKNOW("sdfType:"+this.sdfType))}},BitmapFontMaterial.prototype._hasMultiPages=function(){return this.geometry.hasMultiPages()},BitmapFontMaterial.prototype._isSdfFont=function(){return this.enableSdf},__decorate([e.cloneAttributeAsBasicType()],BitmapFontMaterial.prototype,"enableSdf",void 0),__decorate([e.cloneAttributeAsBasicType()],BitmapFontMaterial.prototype,"sdfType",void 0),__decorate([e.cloneAttributeAsBasicType()],BitmapFontMaterial.prototype,"alphaTest",void 0),__decorate([e.requireSetter(function(t){e.it("should add ImageTexture",function(){e.expect(t).instanceOf(e.ImageTexture)})}),e.cloneAttributeAsCloneable()],BitmapFontMaterial.prototype,"bitmap",null),__decorate([e.requireSetter(function(t){e.it("pageMapData should be Array type",function(){e.expect(t).be.a("array")})}),e.cloneAttributeAsCustomType(function(t,r,n){r[n]=e.CloneUtils.cloneArray(t[n],!0)})],BitmapFontMaterial.prototype,"pageMapData",null),__decorate([e.virtual,e.require(function(){e.it("should only set pageMap or bitmap ",function(){e.expect(null!==this.pageMapData&&null===this.bitmap||null===this.pageMapData&&null!==this.bitmap).true},this),e.describe("if has multi pages",function(){e.it("each map in pageMapData should be all flipY or all not",function(){var t=this.pageMapData.filter(function(e){return e.flipY===!0}).length;e.expect(0===t||t===this.pageMapData.length).true})},function(){return null!==this.pageMapData&&this.pageMapData.length>0},this)})],BitmapFontMaterial.prototype,"isMapFlipY",null),__decorate([e.ensure(function(t){t&&e.it("should has one page map at least",function(){e.expect(this.pageMapData.length).greaterThan(0)},this)})],BitmapFontMaterial.prototype,"_hasMultiPages",null),BitmapFontMaterial}(e.StandardLightMaterial);e.BitmapFontMaterial=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function BasicBitmapFontShaderLib(){e.apply(this,arguments),this.type="basic_bitmapFont"}return __extends(BasicBitmapFontShaderLib,e),BasicBitmapFontShaderLib.create=function(){var e=new this;return e},BasicBitmapFontShaderLib}(e.EngineShaderLib);e.BasicBitmapFontShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(e){function CommonBitmapFontShaderLib(){e.apply(this,arguments),this.type="common_bitmapFont"}return __extends(CommonBitmapFontShaderLib,e),CommonBitmapFontShaderLib.create=function(){var e=new this;return e},CommonBitmapFontShaderLib.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_bitmapSampler"])},CommonBitmapFontShaderLib}(e.EngineShaderLib);e.CommonBitmapFontShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function MultiPagesBitmapFontShaderLib(){t.apply(this,arguments),this.type="multiPages_bitmapFont"}return __extends(MultiPagesBitmapFontShaderLib,t),MultiPagesBitmapFontShaderLib.create=function(){var e=new this;return e},MultiPagesBitmapFontShaderLib.prototype.sendShaderVariables=function(t,r,n){var i=r.buffers.getChild(e.EBufferDataType.CUSTOM,"pages");i&&this.sendAttributeBuffer(t,"a_page",i)},MultiPagesBitmapFontShaderLib.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addAttributeVariable(["a_page"]),this.addUniformVariable(["u_pageSampler2Ds"]),this.fsSourceBody+=r.pageMapData.map(function(e,t){var r=0===t?"if":"else if";return r+"(v_page == "+t+".0) {\n                    totalColor *= texture2D(u_pageSampler2Ds["+t+"], v_bitmapCoord);\n                    }"}).join("\n")+"\n",this.fsSourceDefineList.addChildren([{name:"PAGE_COUNT",value:r.pageMapData.length}])},__decorate([e.require(function(t,r,n){e.it("should exist page buffer",function(){e.expect(r.buffers.getChild(e.EBufferDataType.CUSTOM,"pages")).exist})})],MultiPagesBitmapFontShaderLib.prototype,"sendShaderVariables",null),MultiPagesBitmapFontShaderLib}(e.EngineShaderLib);e.MultiPagesBitmapFontShaderLib=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SdfBitmapFontSmoothShaderLib(){t.apply(this,arguments),this.type="sdf_bitmapFont_smooth"}return __extends(SdfBitmapFontSmoothShaderLib,t),SdfBitmapFontSmoothShaderLib.create=function(){var e=new this;return e},SdfBitmapFontSmoothShaderLib.prototype.setShaderDefinition=function(r,n){t.prototype.setShaderDefinition.call(this,r,n),e.GPUDetector.getInstance().extensionStandardDerivatives?(this.fsSourceExtensionList.addChild("GL_OES_standard_derivatives"),this.fsSourceFuncDefine=e.ShaderChunk.sdf_bitmapFont_smoothStep_standardDerivatives.funcDefine):this.fsSourceFuncDefine=e.ShaderChunk.sdf_bitmapFont_smoothStep_fallback.funcDefine,this.fsSourceBody+="if (gl_FragColor.a < "+n.alphaTest+"){\n    discard;\n}"},SdfBitmapFontSmoothShaderLib}(e.EngineShaderLib);e.SdfBitmapFontSmoothShaderLib=t}(wd||(wd={}));var wd;!function(e){!function(e){e[e.SMOOTH=0]="SMOOTH"}(e.SdfBitmapFontType||(e.SdfBitmapFontType={}));e.SdfBitmapFontType}(wd||(wd={}));var wd;!function(e){var t=function(t){function ActionEngine(){t.call(this)}return __extends(ActionEngine,t),ActionEngine.getInstance=function(){},ActionEngine.prototype.update=function(e){var t=[];this.list.forEach(function(r){return r.isFinish?void t.push(r):void(r.isStop||r.isPause||r.update(e))});for(var r=0,n=t;r<n.length;r++){var i=n[r];i.entityObject.removeComponent(i)}},ActionEngine=__decorate([e.singleton()],ActionEngine)}(e.ComponentContainer);e.ActionEngine=t}(wd||(wd={}));var wd;!function(e){var t=function(){function ScriptEngine(){this._scriptList=wdCb.Collection.create()}return ScriptEngine.getInstance=function(){},ScriptEngine.prototype.addChild=function(e,t,r){e.scriptManager.addChild(t,r),this._scriptList.addChild(r)},ScriptEngine.prototype.removeChild=function(e,t){e.scriptManager.removeChild(t),this._scriptList.removeChild(t)},ScriptEngine.prototype.removeAllChildren=function(){this._scriptList.removeAllChildren()},ScriptEngine.prototype.findScript=function(e,t){return e.scriptManager.getChild(t)},ScriptEngine.prototype.execEntityObjectScript=function(e,t){e.scriptManager.execScript(t)},ScriptEngine.prototype.execEntityObjectScriptOnlyOnce=function(e,t){e.scriptManager.execScriptOnlyOnce(t)},ScriptEngine.prototype.execEntityObjectScriptWithData=function(e,t,r){e.scriptManager.execScriptWithData(t,r)},ScriptEngine.prototype.execScript=function(e){this._scriptList.forEach(function(t){t[e]&&t[e]()})},ScriptEngine.prototype.execScriptWithData=function(e,t){this._scriptList.forEach(function(r){r[e]&&r[e](t)})},ScriptEngine.prototype.execEntityObjectEventScriptWithData=function(e,t,r){e.scriptManager.execEventScriptWithData(t,r)},ScriptEngine=__decorate([e.singleton()],ScriptEngine)}();e.ScriptEngine=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function LODEngine(){t.call(this)}return __extends(LODEngine,t),LODEngine.getInstance=function(){},LODEngine.prototype.update=function(e){this.list.forEach(function(t){t.update(e)})},LODEngine=__decorate([e.singleton()],LODEngine)}(e.ComponentContainer);e.LODEngine=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function SpacePartitionEngine(){t.call(this)}return __extends(SpacePartitionEngine,t),SpacePartitionEngine.getInstance=function(){},SpacePartitionEngine.prototype.update=function(e){this.list.forEach(function(t){t.update(e)})},SpacePartitionEngine=__decorate([e.singleton()],SpacePartitionEngine)}(e.ComponentContainer);e.SpacePartitionEngine=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function AnimationEngine(){t.call(this)}return __extends(AnimationEngine,t),AnimationEngine.getInstance=function(){},AnimationEngine.prototype.update=function(e){this.list.forEach(function(t){t.update(e)})},AnimationEngine=__decorate([e.singleton()],AnimationEngine)}(e.ComponentContainer);e.AnimationEngine=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function CollisionEngine(){t.call(this),this._collisionDetector=e.CollisionDetector.create()}return __extends(CollisionEngine,t),CollisionEngine.getInstance=function(){},CollisionEngine.prototype.update=function(e){this.list.forEach(function(t){t.update(e)})},CollisionEngine.prototype.detect=function(e){this._collisionDetector.update(e)},CollisionEngine=__decorate([e.singleton()],CollisionEngine)}(e.ComponentContainer);e.CollisionEngine=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function PhysicsEngine(){t.call(this),this.physicsEngineAdapter=e.PhysicsEngineFactory.createNullAdapter()}return __extends(PhysicsEngine,t),PhysicsEngine.getInstance=function(){},PhysicsEngine.prototype.removeChild=function(e){var r=this.physicsEngineAdapter;if(t.prototype.removeChild.call(this,e),r){var n=e.entityObject;r.removeGameObject(n),r.removeConstraints(n)}},PhysicsEngine.prototype.initPhysicsEngineAdapter=function(){var t=e.Director.getInstance().scene.physics;this.physicsEngineAdapter=e.PhysicsEngineFactory.create(t.enable,t.engine),this.physicsEngineAdapter.init()},PhysicsEngine.prototype.initBody=function(){this.list.forEach(function(e){e.initBody()})},PhysicsEngine.prototype.initConstraint=function(){this.list.forEach(function(e){e.initConstraint()})},PhysicsEngine.prototype.update=function(t){var r=e.Director.getInstance().scene.physics;r.enable&&this.physicsEngineAdapter.update(t)},PhysicsEngine=__decorate([e.singleton()],PhysicsEngine)}(e.ComponentContainer);e.PhysicsEngine=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function BillboardEngine(){t.call(this)}return __extends(BillboardEngine,t),BillboardEngine.getInstance=function(){},BillboardEngine.prototype.update=function(e){this.list.forEach(function(t){t.update(e)})},BillboardEngine=__decorate([e.singleton()],BillboardEngine)}(e.ComponentContainer);e.BillboardEngine=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function UIEngine(){t.apply(this,arguments)}return __extends(UIEngine,t),UIEngine.prototype.update=function(e){this.list.forEach(function(t){t.update(e)})},UIEngine=__decorate([e.singleton()],UIEngine)}(e.ComponentContainer);e.UIEngine=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function ThreeDUIEngine(){t.call(this)}return __extends(ThreeDUIEngine,t),ThreeDUIEngine.getInstance=function(){},ThreeDUIEngine=__decorate([e.singleton()],ThreeDUIEngine)}(e.UIEngine);e.ThreeDUIEngine=t}(wd||(wd={}));var wd;!function(e){var t=function(t){function TwoDUIEngine(){t.call(this)}return __extends(TwoDUIEngine,t),TwoDUIEngine.getInstance=function(){},TwoDUIEngine.prototype.render=function(){var e=this;this.list.forEach(function(t){e._isDirty(t.entityObject)&&t.render()},this)},TwoDUIEngine.prototype._isDirty=function(t){return t.getComponent(e.UIRenderer).state===e.EUIRendererState.DIRTY},TwoDUIEngine=__decorate([e.singleton()],TwoDUIEngine)}(e.UIEngine);e.TwoDUIEngine=t}(wd||(wd={}));