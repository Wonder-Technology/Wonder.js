!function(name,definition){"undefined"!=typeof module&&module.exports?module.exports.browser=definition():"function"==typeof define&&define.amd?define(definition):this[name]=definition()}("bowser",function(){function detect(ua){function getFirstMatch(regex){var match=ua.match(regex);return match&&match.length>1&&match[1]||""}var result,iosdevice=getFirstMatch(/(ipod|iphone|ipad)/i).toLowerCase(),likeAndroid=/like android/i.test(ua),android=!likeAndroid&&/android/i.test(ua),versionIdentifier=getFirstMatch(/version\/(\d+(\.\d+)?)/i),tablet=/tablet/i.test(ua),mobile=!tablet&&/[^-]mobi/i.test(ua);/opera|opr/i.test(ua)?result={name:"Opera",opera:t,version:versionIdentifier||getFirstMatch(/(?:opera|opr)[\s\/](\d+(\.\d+)?)/i)}:/windows phone/i.test(ua)?result={name:"Windows Phone",windowsphone:t,msie:t,version:getFirstMatch(/iemobile\/(\d+(\.\d+)?)/i)}:/msie|trident/i.test(ua)?result={name:"Internet Explorer",msie:t,version:getFirstMatch(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:/chrome|crios|crmo/i.test(ua)?result={name:"Chrome",chrome:t,version:getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:iosdevice?(result={name:"iphone"==iosdevice?"iPhone":"ipad"==iosdevice?"iPad":"iPod"},versionIdentifier&&(result.version=versionIdentifier)):/sailfish/i.test(ua)?result={name:"Sailfish",sailfish:t,version:getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(ua)?result={name:"SeaMonkey",seamonkey:t,version:getFirstMatch(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel/i.test(ua)?(result={name:"Firefox",firefox:t,version:getFirstMatch(/(?:firefox|iceweasel)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(ua)&&(result.firefoxos=t)):/silk/i.test(ua)?result={name:"Amazon Silk",silk:t,version:getFirstMatch(/silk\/(\d+(\.\d+)?)/i)}:android?result={name:"Android",version:versionIdentifier}:/phantom/i.test(ua)?result={name:"PhantomJS",phantom:t,version:getFirstMatch(/phantomjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(ua)||/rim\stablet/i.test(ua)?result={name:"BlackBerry",blackberry:t,version:versionIdentifier||getFirstMatch(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:/(web|hpw)os/i.test(ua)?(result={name:"WebOS",webos:t,version:versionIdentifier||getFirstMatch(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(ua)&&(result.touchpad=t)):result=/bada/i.test(ua)?{name:"Bada",bada:t,version:getFirstMatch(/dolfin\/(\d+(\.\d+)?)/i)}:/tizen/i.test(ua)?{name:"Tizen",tizen:t,version:getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||versionIdentifier}:/safari/i.test(ua)?{name:"Safari",safari:t,version:versionIdentifier}:{},/(apple)?webkit/i.test(ua)?(result.name=result.name||"Webkit",result.webkit=t,!result.version&&versionIdentifier&&(result.version=versionIdentifier)):!result.opera&&/gecko\//i.test(ua)&&(result.name=result.name||"Gecko",result.gecko=t,result.version=result.version||getFirstMatch(/gecko\/(\d+(\.\d+)?)/i)),android||result.silk?result.android=t:iosdevice&&(result[iosdevice]=t,result.ios=t);var osVersion="";iosdevice?(osVersion=getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i),osVersion=osVersion.replace(/[_\s]/g,".")):android?osVersion=getFirstMatch(/android[ \/-](\d+(\.\d+)*)/i):result.windowsphone?osVersion=getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):result.webos?osVersion=getFirstMatch(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):result.blackberry?osVersion=getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i):result.bada?osVersion=getFirstMatch(/bada\/(\d+(\.\d+)*)/i):result.tizen&&(osVersion=getFirstMatch(/tizen[\/\s](\d+(\.\d+)*)/i)),osVersion&&(result.osversion=osVersion);var osMajorVersion=osVersion.split(".")[0];return tablet||"ipad"==iosdevice||android&&(3==osMajorVersion||4==osMajorVersion&&!mobile)||result.silk?result.tablet=t:(mobile||"iphone"==iosdevice||"ipod"==iosdevice||android||result.blackberry||result.webos||result.bada)&&(result.mobile=t),result.msie&&result.version>=10||result.chrome&&result.version>=20||result.firefox&&result.version>=20||result.safari&&result.version>=6||result.opera&&result.version>=10||result.ios&&result.osversion&&result.osversion.split(".")[0]>=6||result.blackberry&&result.version>=10.1?result.a=t:result.msie&&result.version<10||result.chrome&&result.version<20||result.firefox&&result.version<20||result.safari&&result.version<6||result.opera&&result.version<10||result.ios&&result.osversion&&result.osversion.split(".")[0]<6?result.c=t:result.x=t,result}var t=!0,bowser=detect("undefined"!=typeof navigator?navigator.userAgent:"");return bowser._detect=detect,bowser}),function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.chai=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){module.exports=require("./lib/chai")},{"./lib/chai":2}],2:[function(require,module,exports){var used=[],exports=module.exports={};exports.version="3.5.0",exports.AssertionError=require("assertion-error");var util=require("./chai/utils");exports.use=function(fn){return~used.indexOf(fn)||(fn(this,util),used.push(fn)),this},exports.util=util;var config=require("./chai/config");exports.config=config;var assertion=require("./chai/assertion");exports.use(assertion);var core=require("./chai/core/assertions");exports.use(core);var expect=require("./chai/interface/expect");exports.use(expect);var should=require("./chai/interface/should");exports.use(should);var assert=require("./chai/interface/assert");exports.use(assert)},{"./chai/assertion":3,"./chai/config":4,"./chai/core/assertions":5,"./chai/interface/assert":6,"./chai/interface/expect":7,"./chai/interface/should":8,"./chai/utils":22,"assertion-error":30}],3:[function(require,module,exports){var config=require("./config");module.exports=function(_chai,util){function Assertion(obj,msg,stack){flag(this,"ssfi",stack||arguments.callee),flag(this,"object",obj),flag(this,"message",msg)}var AssertionError=_chai.AssertionError,flag=util.flag;_chai.Assertion=Assertion,Object.defineProperty(Assertion,"includeStack",{get:function(){return console.warn("Assertion.includeStack is deprecated, use chai.config.includeStack instead."),config.includeStack},set:function(value){console.warn("Assertion.includeStack is deprecated, use chai.config.includeStack instead."),config.includeStack=value}}),Object.defineProperty(Assertion,"showDiff",{get:function(){return console.warn("Assertion.showDiff is deprecated, use chai.config.showDiff instead."),config.showDiff},set:function(value){console.warn("Assertion.showDiff is deprecated, use chai.config.showDiff instead."),config.showDiff=value}}),Assertion.addProperty=function(name,fn){util.addProperty(this.prototype,name,fn)},Assertion.addMethod=function(name,fn){util.addMethod(this.prototype,name,fn)},Assertion.addChainableMethod=function(name,fn,chainingBehavior){util.addChainableMethod(this.prototype,name,fn,chainingBehavior)},Assertion.overwriteProperty=function(name,fn){util.overwriteProperty(this.prototype,name,fn)},Assertion.overwriteMethod=function(name,fn){util.overwriteMethod(this.prototype,name,fn)},Assertion.overwriteChainableMethod=function(name,fn,chainingBehavior){util.overwriteChainableMethod(this.prototype,name,fn,chainingBehavior)},Assertion.prototype.assert=function(expr,msg,negateMsg,expected,_actual,showDiff){var ok=util.test(this,arguments);if(!0!==showDiff&&(showDiff=!1),!0!==config.showDiff&&(showDiff=!1),!ok){var msg=util.getMessage(this,arguments),actual=util.getActual(this,arguments);throw new AssertionError(msg,{actual:actual,expected:expected,showDiff:showDiff},config.includeStack?this.assert:flag(this,"ssfi"))}},Object.defineProperty(Assertion.prototype,"_obj",{get:function(){return flag(this,"object")},set:function(val){flag(this,"object",val)}})}},{"./config":4}],4:[function(require,module,exports){module.exports={includeStack:!1,showDiff:!0,truncateThreshold:40}},{}],5:[function(require,module,exports){module.exports=function(chai,_){function an(type,msg){msg&&flag(this,"message",msg),type=type.toLowerCase();var obj=flag(this,"object"),article=~["a","e","i","o","u"].indexOf(type.charAt(0))?"an ":"a ";this.assert(type===_.type(obj),"expected #{this} to be "+article+type,"expected #{this} not to be "+article+type)}function includeChainingBehavior(){flag(this,"contains",!0)}function include(val,msg){_.expectTypes(this,["array","object","string"]),msg&&flag(this,"message",msg);var obj=flag(this,"object"),expected=!1;if("array"===_.type(obj)&&"object"===_.type(val)){for(var i in obj)if(_.eql(obj[i],val)){expected=!0;break}}else if("object"===_.type(val)){if(!flag(this,"negate")){for(var k in val)new Assertion(obj).property(k,val[k]);return}var subset={};for(var k in val)subset[k]=obj[k];expected=_.eql(subset,val)}else expected=void 0!=obj&&~obj.indexOf(val);this.assert(expected,"expected #{this} to include "+_.inspect(val),"expected #{this} to not include "+_.inspect(val))}function checkArguments(){var obj=flag(this,"object"),type=Object.prototype.toString.call(obj);this.assert("[object Arguments]"===type,"expected #{this} to be arguments but got "+type,"expected #{this} to not be arguments")}function assertEqual(val,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object");return flag(this,"deep")?this.eql(val):void this.assert(val===obj,"expected #{this} to equal #{exp}","expected #{this} to not equal #{exp}",val,this._obj,!0)}function assertEql(obj,msg){msg&&flag(this,"message",msg),this.assert(_.eql(obj,flag(this,"object")),"expected #{this} to deeply equal #{exp}","expected #{this} to not deeply equal #{exp}",obj,this._obj,!0)}function assertAbove(n,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object");if(flag(this,"doLength")){new Assertion(obj,msg).to.have.property("length");var len=obj.length;this.assert(len>n,"expected #{this} to have a length above #{exp} but got #{act}","expected #{this} to not have a length above #{exp}",n,len)}else this.assert(obj>n,"expected #{this} to be above "+n,"expected #{this} to be at most "+n)}function assertLeast(n,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object");if(flag(this,"doLength")){new Assertion(obj,msg).to.have.property("length");var len=obj.length;this.assert(len>=n,"expected #{this} to have a length at least #{exp} but got #{act}","expected #{this} to have a length below #{exp}",n,len)}else this.assert(obj>=n,"expected #{this} to be at least "+n,"expected #{this} to be below "+n)}function assertBelow(n,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object");if(flag(this,"doLength")){new Assertion(obj,msg).to.have.property("length");var len=obj.length;this.assert(len<n,"expected #{this} to have a length below #{exp} but got #{act}","expected #{this} to not have a length below #{exp}",n,len)}else this.assert(obj<n,"expected #{this} to be below "+n,"expected #{this} to be at least "+n)}function assertMost(n,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object");if(flag(this,"doLength")){new Assertion(obj,msg).to.have.property("length");var len=obj.length;this.assert(len<=n,"expected #{this} to have a length at most #{exp} but got #{act}","expected #{this} to have a length above #{exp}",n,len)}else this.assert(obj<=n,"expected #{this} to be at most "+n,"expected #{this} to be above "+n)}function assertInstanceOf(constructor,msg){msg&&flag(this,"message",msg);var name=_.getName(constructor);this.assert(flag(this,"object")instanceof constructor,"expected #{this} to be an instance of "+name,"expected #{this} to not be an instance of "+name)}function assertOwnProperty(name,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object");this.assert(obj.hasOwnProperty(name),"expected #{this} to have own property "+_.inspect(name),"expected #{this} to not have own property "+_.inspect(name))}function assertOwnPropertyDescriptor(name,descriptor,msg){"string"==typeof descriptor&&(msg=descriptor,descriptor=null),msg&&flag(this,"message",msg);var obj=flag(this,"object"),actualDescriptor=Object.getOwnPropertyDescriptor(Object(obj),name);actualDescriptor&&descriptor?this.assert(_.eql(descriptor,actualDescriptor),"expected the own property descriptor for "+_.inspect(name)+" on #{this} to match "+_.inspect(descriptor)+", got "+_.inspect(actualDescriptor),"expected the own property descriptor for "+_.inspect(name)+" on #{this} to not match "+_.inspect(descriptor),descriptor,actualDescriptor,!0):this.assert(actualDescriptor,"expected #{this} to have an own property descriptor for "+_.inspect(name),"expected #{this} to not have an own property descriptor for "+_.inspect(name)),flag(this,"object",actualDescriptor)}function assertLengthChain(){flag(this,"doLength",!0)}function assertLength(n,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object");new Assertion(obj,msg).to.have.property("length");var len=obj.length;this.assert(len==n,"expected #{this} to have a length of #{exp} but got #{act}","expected #{this} to not have a length of #{act}",n,len)}function assertMatch(re,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object");this.assert(re.exec(obj),"expected #{this} to match "+re,"expected #{this} not to match "+re)}function assertKeys(keys){var str,obj=flag(this,"object"),ok=!0,mixedArgsMsg="keys must be given single argument of Array|Object|String, or multiple String arguments";switch(_.type(keys)){case"array":if(arguments.length>1)throw new Error(mixedArgsMsg);break;case"object":if(arguments.length>1)throw new Error(mixedArgsMsg);keys=Object.keys(keys);break;default:keys=Array.prototype.slice.call(arguments)}if(!keys.length)throw new Error("keys required");var actual=Object.keys(obj),expected=keys,len=keys.length,any=flag(this,"any"),all=flag(this,"all");if(any||all||(all=!0),any){var intersection=expected.filter(function(key){return~actual.indexOf(key)});ok=intersection.length>0}if(all&&(ok=keys.every(function(key){return~actual.indexOf(key)}),flag(this,"negate")||flag(this,"contains")||(ok=ok&&keys.length==actual.length)),len>1){keys=keys.map(function(key){return _.inspect(key)});var last=keys.pop();all&&(str=keys.join(", ")+", and "+last),any&&(str=keys.join(", ")+", or "+last)}else str=_.inspect(keys[0]);str=(len>1?"keys ":"key ")+str,str=(flag(this,"contains")?"contain ":"have ")+str,this.assert(ok,"expected #{this} to "+str,"expected #{this} to not "+str,expected.slice(0).sort(),actual.sort(),!0)}function assertThrows(constructor,errMsg,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object");new Assertion(obj,msg).is.a("function");var thrown=!1,desiredError=null,name=null,thrownError=null;0===arguments.length?(errMsg=null,constructor=null):constructor&&(constructor instanceof RegExp||"string"==typeof constructor)?(errMsg=constructor,constructor=null):constructor&&constructor instanceof Error?(desiredError=constructor,constructor=null,errMsg=null):"function"==typeof constructor?(name=constructor.prototype.name,(!name||"Error"===name&&constructor!==Error)&&(name=constructor.name||(new constructor).name)):constructor=null;try{obj()}catch(err){if(desiredError)return this.assert(err===desiredError,"expected #{this} to throw #{exp} but #{act} was thrown","expected #{this} to not throw #{exp}",desiredError instanceof Error?desiredError.toString():desiredError,err instanceof Error?err.toString():err),flag(this,"object",err),this;if(constructor&&(this.assert(err instanceof constructor,"expected #{this} to throw #{exp} but #{act} was thrown","expected #{this} to not throw #{exp} but #{act} was thrown",name,err instanceof Error?err.toString():err),!errMsg))return flag(this,"object",err),this;var message="error"===_.type(err)&&"message"in err?err.message:""+err;if(null!=message&&errMsg&&errMsg instanceof RegExp)return this.assert(errMsg.exec(message),"expected #{this} to throw error matching #{exp} but got #{act}","expected #{this} to throw error not matching #{exp}",errMsg,message),flag(this,"object",err),this;if(null!=message&&errMsg&&"string"==typeof errMsg)return this.assert(~message.indexOf(errMsg),"expected #{this} to throw error including #{exp} but got #{act}","expected #{this} to throw error not including #{act}",errMsg,message),flag(this,"object",err),this;thrown=!0,thrownError=err}var actuallyGot="",expectedThrown=null!==name?name:desiredError?"#{exp}":"an error";thrown&&(actuallyGot=" but #{act} was thrown"),this.assert(thrown===!0,"expected #{this} to throw "+expectedThrown+actuallyGot,"expected #{this} to not throw "+expectedThrown+actuallyGot,desiredError instanceof Error?desiredError.toString():desiredError,thrownError instanceof Error?thrownError.toString():thrownError),flag(this,"object",thrownError)}function respondTo(method,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object"),itself=flag(this,"itself"),context="function"!==_.type(obj)||itself?obj[method]:obj.prototype[method];this.assert("function"==typeof context,"expected #{this} to respond to "+_.inspect(method),"expected #{this} to not respond to "+_.inspect(method))}function satisfy(matcher,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object"),result=matcher(obj);this.assert(result,"expected #{this} to satisfy "+_.objDisplay(matcher),"expected #{this} to not satisfy"+_.objDisplay(matcher),!this.negate,result)}function closeTo(expected,delta,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object");if(new Assertion(obj,msg).is.a("number"),"number"!==_.type(expected)||"number"!==_.type(delta))throw new Error("the arguments to closeTo or approximately must be numbers");this.assert(Math.abs(obj-expected)<=delta,"expected #{this} to be close to "+expected+" +/- "+delta,"expected #{this} not to be close to "+expected+" +/- "+delta)}function isSubsetOf(subset,superset,cmp){return subset.every(function(elem){return cmp?superset.some(function(elem2){return cmp(elem,elem2)}):superset.indexOf(elem)!==-1})}function oneOf(list,msg){msg&&flag(this,"message",msg);var expected=flag(this,"object");new Assertion(list).to.be.an("array"),this.assert(list.indexOf(expected)>-1,"expected #{this} to be one of #{exp}","expected #{this} to not be one of #{exp}",list,expected)}function assertChanges(object,prop,msg){msg&&flag(this,"message",msg);var fn=flag(this,"object");new Assertion(object,msg).to.have.property(prop),new Assertion(fn).is.a("function");var initial=object[prop];fn(),this.assert(initial!==object[prop],"expected ."+prop+" to change","expected ."+prop+" to not change")}function assertIncreases(object,prop,msg){msg&&flag(this,"message",msg);var fn=flag(this,"object");new Assertion(object,msg).to.have.property(prop),new Assertion(fn).is.a("function");var initial=object[prop];fn(),this.assert(object[prop]-initial>0,"expected ."+prop+" to increase","expected ."+prop+" to not increase")}function assertDecreases(object,prop,msg){msg&&flag(this,"message",msg);var fn=flag(this,"object");new Assertion(object,msg).to.have.property(prop),new Assertion(fn).is.a("function");var initial=object[prop];fn(),this.assert(object[prop]-initial<0,"expected ."+prop+" to decrease","expected ."+prop+" to not decrease")}var Assertion=chai.Assertion,flag=(Object.prototype.toString,_.flag);["to","be","been","is","and","has","have","with","that","which","at","of","same"].forEach(function(chain){Assertion.addProperty(chain,function(){return this})}),Assertion.addProperty("not",function(){flag(this,"negate",!0)}),Assertion.addProperty("deep",function(){flag(this,"deep",!0)}),Assertion.addProperty("any",function(){flag(this,"any",!0),flag(this,"all",!1)}),Assertion.addProperty("all",function(){flag(this,"all",!0),flag(this,"any",!1)}),Assertion.addChainableMethod("an",an),Assertion.addChainableMethod("a",an),Assertion.addChainableMethod("include",include,includeChainingBehavior),Assertion.addChainableMethod("contain",include,includeChainingBehavior),Assertion.addChainableMethod("contains",include,includeChainingBehavior),Assertion.addChainableMethod("includes",include,includeChainingBehavior),Assertion.addProperty("ok",function(){this.assert(flag(this,"object"),"expected #{this} to be truthy","expected #{this} to be falsy")}),Assertion.addProperty("true",function(){this.assert(!0===flag(this,"object"),"expected #{this} to be true","expected #{this} to be false",!this.negate)}),Assertion.addProperty("false",function(){this.assert(!1===flag(this,"object"),"expected #{this} to be false","expected #{this} to be true",!!this.negate)}),Assertion.addProperty("null",function(){this.assert(null===flag(this,"object"),"expected #{this} to be null","expected #{this} not to be null")}),Assertion.addProperty("undefined",function(){this.assert(void 0===flag(this,"object"),"expected #{this} to be undefined","expected #{this} not to be undefined")}),Assertion.addProperty("NaN",function(){this.assert(isNaN(flag(this,"object")),"expected #{this} to be NaN","expected #{this} not to be NaN")}),Assertion.addProperty("exist",function(){this.assert(null!=flag(this,"object"),"expected #{this} to exist","expected #{this} to not exist")}),Assertion.addProperty("empty",function(){var obj=flag(this,"object"),expected=obj;Array.isArray(obj)||"string"==typeof object?expected=obj.length:"object"==typeof obj&&(expected=Object.keys(obj).length),this.assert(!expected,"expected #{this} to be empty","expected #{this} not to be empty")}),Assertion.addProperty("arguments",checkArguments),Assertion.addProperty("Arguments",checkArguments),Assertion.addMethod("equal",assertEqual),Assertion.addMethod("equals",assertEqual),Assertion.addMethod("eq",assertEqual),Assertion.addMethod("eql",assertEql),Assertion.addMethod("eqls",assertEql),Assertion.addMethod("above",assertAbove),Assertion.addMethod("gt",assertAbove),Assertion.addMethod("greaterThan",assertAbove),Assertion.addMethod("least",assertLeast),Assertion.addMethod("gte",assertLeast),Assertion.addMethod("below",assertBelow),Assertion.addMethod("lt",assertBelow),Assertion.addMethod("lessThan",assertBelow),Assertion.addMethod("most",assertMost),Assertion.addMethod("lte",assertMost),Assertion.addMethod("within",function(start,finish,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object"),range=start+".."+finish;if(flag(this,"doLength")){new Assertion(obj,msg).to.have.property("length");var len=obj.length;this.assert(len>=start&&len<=finish,"expected #{this} to have a length within "+range,"expected #{this} to not have a length within "+range)}else this.assert(obj>=start&&obj<=finish,"expected #{this} to be within "+range,"expected #{this} to not be within "+range)}),Assertion.addMethod("instanceof",assertInstanceOf),Assertion.addMethod("instanceOf",assertInstanceOf),Assertion.addMethod("property",function(name,val,msg){msg&&flag(this,"message",msg);var isDeep=!!flag(this,"deep"),descriptor=isDeep?"deep property ":"property ",negate=flag(this,"negate"),obj=flag(this,"object"),pathInfo=isDeep?_.getPathInfo(name,obj):null,hasProperty=isDeep?pathInfo.exists:_.hasProperty(name,obj),value=isDeep?pathInfo.value:obj[name];if(negate&&arguments.length>1){if(void 0===value)throw msg=null!=msg?msg+": ":"",new Error(msg+_.inspect(obj)+" has no "+descriptor+_.inspect(name))}else this.assert(hasProperty,"expected #{this} to have a "+descriptor+_.inspect(name),"expected #{this} to not have "+descriptor+_.inspect(name));arguments.length>1&&this.assert(val===value,"expected #{this} to have a "+descriptor+_.inspect(name)+" of #{exp}, but got #{act}","expected #{this} to not have a "+descriptor+_.inspect(name)+" of #{act}",val,value),flag(this,"object",value)}),Assertion.addMethod("ownProperty",assertOwnProperty),Assertion.addMethod("haveOwnProperty",assertOwnProperty),Assertion.addMethod("ownPropertyDescriptor",assertOwnPropertyDescriptor),Assertion.addMethod("haveOwnPropertyDescriptor",assertOwnPropertyDescriptor),Assertion.addChainableMethod("length",assertLength,assertLengthChain),Assertion.addMethod("lengthOf",assertLength),Assertion.addMethod("match",assertMatch),Assertion.addMethod("matches",assertMatch),Assertion.addMethod("string",function(str,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object");new Assertion(obj,msg).is.a("string"),this.assert(~obj.indexOf(str),"expected #{this} to contain "+_.inspect(str),"expected #{this} to not contain "+_.inspect(str))}),Assertion.addMethod("keys",assertKeys),Assertion.addMethod("key",assertKeys),Assertion.addMethod("throw",assertThrows),Assertion.addMethod("throws",assertThrows),Assertion.addMethod("Throw",assertThrows),Assertion.addMethod("respondTo",respondTo),Assertion.addMethod("respondsTo",respondTo),Assertion.addProperty("itself",function(){flag(this,"itself",!0)}),Assertion.addMethod("satisfy",satisfy),Assertion.addMethod("satisfies",satisfy),Assertion.addMethod("closeTo",closeTo),Assertion.addMethod("approximately",closeTo),Assertion.addMethod("members",function(subset,msg){msg&&flag(this,"message",msg);var obj=flag(this,"object");new Assertion(obj).to.be.an("array"),new Assertion(subset).to.be.an("array");var cmp=flag(this,"deep")?_.eql:void 0;return flag(this,"contains")?this.assert(isSubsetOf(subset,obj,cmp),"expected #{this} to be a superset of #{act}","expected #{this} to not be a superset of #{act}",obj,subset):void this.assert(isSubsetOf(obj,subset,cmp)&&isSubsetOf(subset,obj,cmp),"expected #{this} to have the same members as #{act}","expected #{this} to not have the same members as #{act}",obj,subset)}),Assertion.addMethod("oneOf",oneOf),Assertion.addChainableMethod("change",assertChanges),Assertion.addChainableMethod("changes",assertChanges),Assertion.addChainableMethod("increase",assertIncreases),Assertion.addChainableMethod("increases",assertIncreases),Assertion.addChainableMethod("decrease",assertDecreases),Assertion.addChainableMethod("decreases",assertDecreases),Assertion.addProperty("extensible",function(){var isExtensible,obj=flag(this,"object");try{isExtensible=Object.isExtensible(obj)}catch(err){if(!(err instanceof TypeError))throw err;isExtensible=!1}this.assert(isExtensible,"expected #{this} to be extensible","expected #{this} to not be extensible")}),Assertion.addProperty("sealed",function(){var isSealed,obj=flag(this,"object");try{isSealed=Object.isSealed(obj)}catch(err){if(!(err instanceof TypeError))throw err;isSealed=!0}this.assert(isSealed,"expected #{this} to be sealed","expected #{this} to not be sealed")}),Assertion.addProperty("frozen",function(){var isFrozen,obj=flag(this,"object");try{isFrozen=Object.isFrozen(obj)}catch(err){if(!(err instanceof TypeError))throw err;isFrozen=!0}this.assert(isFrozen,"expected #{this} to be frozen","expected #{this} to not be frozen")})}},{}],6:[function(require,module,exports){module.exports=function(chai,util){var Assertion=chai.Assertion,flag=util.flag,assert=chai.assert=function(express,errmsg){var test=new Assertion(null,null,chai.assert);test.assert(express,errmsg,"[ negation message unavailable ]")};assert.fail=function(actual,expected,message,operator){throw message=message||"assert.fail()",new chai.AssertionError(message,{actual:actual,expected:expected,operator:operator},assert.fail)},assert.isOk=function(val,msg){new Assertion(val,msg).is.ok},assert.isNotOk=function(val,msg){new Assertion(val,msg).is.not.ok},assert.equal=function(act,exp,msg){var test=new Assertion(act,msg,assert.equal);test.assert(exp==flag(test,"object"),"expected #{this} to equal #{exp}","expected #{this} to not equal #{act}",exp,act)},assert.notEqual=function(act,exp,msg){var test=new Assertion(act,msg,assert.notEqual);test.assert(exp!=flag(test,"object"),"expected #{this} to not equal #{exp}","expected #{this} to equal #{act}",exp,act)},assert.strictEqual=function(act,exp,msg){new Assertion(act,msg).to.equal(exp)},assert.notStrictEqual=function(act,exp,msg){new Assertion(act,msg).to.not.equal(exp)},assert.deepEqual=function(act,exp,msg){new Assertion(act,msg).to.eql(exp)},assert.notDeepEqual=function(act,exp,msg){new Assertion(act,msg).to.not.eql(exp)},assert.isAbove=function(val,abv,msg){new Assertion(val,msg).to.be.above(abv)},assert.isAtLeast=function(val,atlst,msg){new Assertion(val,msg).to.be.least(atlst)},assert.isBelow=function(val,blw,msg){new Assertion(val,msg).to.be.below(blw)},assert.isAtMost=function(val,atmst,msg){new Assertion(val,msg).to.be.most(atmst)},assert.isTrue=function(val,msg){new Assertion(val,msg).is.true},assert.isNotTrue=function(val,msg){new Assertion(val,msg).to.not.equal(!0)},assert.isFalse=function(val,msg){new Assertion(val,msg).is.false},assert.isNotFalse=function(val,msg){new Assertion(val,msg).to.not.equal(!1)},assert.isNull=function(val,msg){new Assertion(val,msg).to.equal(null)},assert.isNotNull=function(val,msg){new Assertion(val,msg).to.not.equal(null)},assert.isNaN=function(val,msg){new Assertion(val,msg).to.be.NaN},assert.isNotNaN=function(val,msg){new Assertion(val,msg).not.to.be.NaN},assert.isUndefined=function(val,msg){new Assertion(val,msg).to.equal(void 0)},assert.isDefined=function(val,msg){new Assertion(val,msg).to.not.equal(void 0)},assert.isFunction=function(val,msg){new Assertion(val,msg).to.be.a("function")},assert.isNotFunction=function(val,msg){new Assertion(val,msg).to.not.be.a("function")},assert.isObject=function(val,msg){new Assertion(val,msg).to.be.a("object")},assert.isNotObject=function(val,msg){new Assertion(val,msg).to.not.be.a("object")},assert.isArray=function(val,msg){new Assertion(val,msg).to.be.an("array")},assert.isNotArray=function(val,msg){new Assertion(val,msg).to.not.be.an("array")},assert.isString=function(val,msg){new Assertion(val,msg).to.be.a("string")},assert.isNotString=function(val,msg){new Assertion(val,msg).to.not.be.a("string")},assert.isNumber=function(val,msg){new Assertion(val,msg).to.be.a("number")},assert.isNotNumber=function(val,msg){new Assertion(val,msg).to.not.be.a("number")},assert.isBoolean=function(val,msg){new Assertion(val,msg).to.be.a("boolean")},assert.isNotBoolean=function(val,msg){new Assertion(val,msg).to.not.be.a("boolean")},assert.typeOf=function(val,type,msg){new Assertion(val,msg).to.be.a(type)},assert.notTypeOf=function(val,type,msg){new Assertion(val,msg).to.not.be.a(type)},assert.instanceOf=function(val,type,msg){new Assertion(val,msg).to.be.instanceOf(type)},assert.notInstanceOf=function(val,type,msg){new Assertion(val,msg).to.not.be.instanceOf(type)},assert.include=function(exp,inc,msg){new Assertion(exp,msg,assert.include).include(inc)},assert.notInclude=function(exp,inc,msg){new Assertion(exp,msg,assert.notInclude).not.include(inc)},assert.match=function(exp,re,msg){new Assertion(exp,msg).to.match(re)},assert.notMatch=function(exp,re,msg){new Assertion(exp,msg).to.not.match(re)},assert.property=function(obj,prop,msg){new Assertion(obj,msg).to.have.property(prop)},assert.notProperty=function(obj,prop,msg){new Assertion(obj,msg).to.not.have.property(prop)},assert.deepProperty=function(obj,prop,msg){new Assertion(obj,msg).to.have.deep.property(prop)},assert.notDeepProperty=function(obj,prop,msg){new Assertion(obj,msg).to.not.have.deep.property(prop)},assert.propertyVal=function(obj,prop,val,msg){new Assertion(obj,msg).to.have.property(prop,val)},assert.propertyNotVal=function(obj,prop,val,msg){new Assertion(obj,msg).to.not.have.property(prop,val)},assert.deepPropertyVal=function(obj,prop,val,msg){new Assertion(obj,msg).to.have.deep.property(prop,val)},assert.deepPropertyNotVal=function(obj,prop,val,msg){new Assertion(obj,msg).to.not.have.deep.property(prop,val)},assert.lengthOf=function(exp,len,msg){new Assertion(exp,msg).to.have.length(len)},assert.throws=function(fn,errt,errs,msg){("string"==typeof errt||errt instanceof RegExp)&&(errs=errt,errt=null);var assertErr=new Assertion(fn,msg).to.throw(errt,errs);
return flag(assertErr,"object")},assert.doesNotThrow=function(fn,type,msg){"string"==typeof type&&(msg=type,type=null),new Assertion(fn,msg).to.not.Throw(type)},assert.operator=function(val,operator,val2,msg){var ok;switch(operator){case"==":ok=val==val2;break;case"===":ok=val===val2;break;case">":ok=val>val2;break;case">=":ok=val>=val2;break;case"<":ok=val<val2;break;case"<=":ok=val<=val2;break;case"!=":ok=val!=val2;break;case"!==":ok=val!==val2;break;default:throw new Error('Invalid operator "'+operator+'"')}var test=new Assertion(ok,msg);test.assert(!0===flag(test,"object"),"expected "+util.inspect(val)+" to be "+operator+" "+util.inspect(val2),"expected "+util.inspect(val)+" to not be "+operator+" "+util.inspect(val2))},assert.closeTo=function(act,exp,delta,msg){new Assertion(act,msg).to.be.closeTo(exp,delta)},assert.approximately=function(act,exp,delta,msg){new Assertion(act,msg).to.be.approximately(exp,delta)},assert.sameMembers=function(set1,set2,msg){new Assertion(set1,msg).to.have.same.members(set2)},assert.sameDeepMembers=function(set1,set2,msg){new Assertion(set1,msg).to.have.same.deep.members(set2)},assert.includeMembers=function(superset,subset,msg){new Assertion(superset,msg).to.include.members(subset)},assert.includeDeepMembers=function(superset,subset,msg){new Assertion(superset,msg).to.include.deep.members(subset)},assert.oneOf=function(inList,list,msg){new Assertion(inList,msg).to.be.oneOf(list)},assert.changes=function(fn,obj,prop){new Assertion(fn).to.change(obj,prop)},assert.doesNotChange=function(fn,obj,prop){new Assertion(fn).to.not.change(obj,prop)},assert.increases=function(fn,obj,prop){new Assertion(fn).to.increase(obj,prop)},assert.doesNotIncrease=function(fn,obj,prop){new Assertion(fn).to.not.increase(obj,prop)},assert.decreases=function(fn,obj,prop){new Assertion(fn).to.decrease(obj,prop)},assert.doesNotDecrease=function(fn,obj,prop){new Assertion(fn).to.not.decrease(obj,prop)},assert.ifError=function(val){if(val)throw val},assert.isExtensible=function(obj,msg){new Assertion(obj,msg).to.be.extensible},assert.isNotExtensible=function(obj,msg){new Assertion(obj,msg).to.not.be.extensible},assert.isSealed=function(obj,msg){new Assertion(obj,msg).to.be.sealed},assert.isNotSealed=function(obj,msg){new Assertion(obj,msg).to.not.be.sealed},assert.isFrozen=function(obj,msg){new Assertion(obj,msg).to.be.frozen},assert.isNotFrozen=function(obj,msg){new Assertion(obj,msg).to.not.be.frozen},function alias(name,as){return assert[as]=assert[name],alias}("isOk","ok")("isNotOk","notOk")("throws","throw")("throws","Throw")("isExtensible","extensible")("isNotExtensible","notExtensible")("isSealed","sealed")("isNotSealed","notSealed")("isFrozen","frozen")("isNotFrozen","notFrozen")}},{}],7:[function(require,module,exports){module.exports=function(chai,util){chai.expect=function(val,message){return new chai.Assertion(val,message)},chai.expect.fail=function(actual,expected,message,operator){throw message=message||"expect.fail()",new chai.AssertionError(message,{actual:actual,expected:expected,operator:operator},chai.expect.fail)}}},{}],8:[function(require,module,exports){module.exports=function(chai,util){function loadShould(){function shouldGetter(){return this instanceof String||this instanceof Number||this instanceof Boolean?new Assertion(this.valueOf(),null,shouldGetter):new Assertion(this,null,shouldGetter)}function shouldSetter(value){Object.defineProperty(this,"should",{value:value,enumerable:!0,configurable:!0,writable:!0})}Object.defineProperty(Object.prototype,"should",{set:shouldSetter,get:shouldGetter,configurable:!0});var should={};return should.fail=function(actual,expected,message,operator){throw message=message||"should.fail()",new chai.AssertionError(message,{actual:actual,expected:expected,operator:operator},should.fail)},should.equal=function(val1,val2,msg){new Assertion(val1,msg).to.equal(val2)},should.Throw=function(fn,errt,errs,msg){new Assertion(fn,msg).to.Throw(errt,errs)},should.exist=function(val,msg){new Assertion(val,msg).to.exist},should.not={},should.not.equal=function(val1,val2,msg){new Assertion(val1,msg).to.not.equal(val2)},should.not.Throw=function(fn,errt,errs,msg){new Assertion(fn,msg).to.not.Throw(errt,errs)},should.not.exist=function(val,msg){new Assertion(val,msg).to.not.exist},should.throw=should.Throw,should.not.throw=should.not.Throw,should}var Assertion=chai.Assertion;chai.should=loadShould,chai.Should=loadShould}},{}],9:[function(require,module,exports){var transferFlags=require("./transferFlags"),flag=require("./flag"),config=require("../config"),hasProtoSupport="__proto__"in Object,excludeNames=/^(?:length|name|arguments|caller)$/,call=Function.prototype.call,apply=Function.prototype.apply;module.exports=function(ctx,name,method,chainingBehavior){"function"!=typeof chainingBehavior&&(chainingBehavior=function(){});var chainableBehavior={method:method,chainingBehavior:chainingBehavior};ctx.__methods||(ctx.__methods={}),ctx.__methods[name]=chainableBehavior,Object.defineProperty(ctx,name,{get:function(){chainableBehavior.chainingBehavior.call(this);var assert=function assert(){var old_ssfi=flag(this,"ssfi");old_ssfi&&config.includeStack===!1&&flag(this,"ssfi",assert);var result=chainableBehavior.method.apply(this,arguments);return void 0===result?this:result};if(hasProtoSupport){var prototype=assert.__proto__=Object.create(this);prototype.call=call,prototype.apply=apply}else{var asserterNames=Object.getOwnPropertyNames(ctx);asserterNames.forEach(function(asserterName){if(!excludeNames.test(asserterName)){var pd=Object.getOwnPropertyDescriptor(ctx,asserterName);Object.defineProperty(assert,asserterName,pd)}})}return transferFlags(this,assert),assert},configurable:!0})}},{"../config":4,"./flag":13,"./transferFlags":29}],10:[function(require,module,exports){var config=require("../config"),flag=require("./flag");module.exports=function(ctx,name,method){ctx[name]=function(){var old_ssfi=flag(this,"ssfi");old_ssfi&&config.includeStack===!1&&flag(this,"ssfi",ctx[name]);var result=method.apply(this,arguments);return void 0===result?this:result}}},{"../config":4,"./flag":13}],11:[function(require,module,exports){var config=require("../config"),flag=require("./flag");module.exports=function(ctx,name,getter){Object.defineProperty(ctx,name,{get:function addProperty(){var old_ssfi=flag(this,"ssfi");old_ssfi&&config.includeStack===!1&&flag(this,"ssfi",addProperty);var result=getter.call(this);return void 0===result?this:result},configurable:!0})}},{"../config":4,"./flag":13}],12:[function(require,module,exports){var AssertionError=require("assertion-error"),flag=require("./flag"),type=require("type-detect");module.exports=function(obj,types){var obj=flag(obj,"object");types=types.map(function(t){return t.toLowerCase()}),types.sort();var str=types.map(function(t,index){var art=~["a","e","i","o","u"].indexOf(t.charAt(0))?"an":"a",or=types.length>1&&index===types.length-1?"or ":"";return or+art+" "+t}).join(", ");if(!types.some(function(expected){return type(obj)===expected}))throw new AssertionError("object tested must be "+str+", but "+type(obj)+" given")}},{"./flag":13,"assertion-error":30,"type-detect":35}],13:[function(require,module,exports){module.exports=function(obj,key,value){var flags=obj.__flags||(obj.__flags=Object.create(null));return 3!==arguments.length?flags[key]:void(flags[key]=value)}},{}],14:[function(require,module,exports){module.exports=function(obj,args){return args.length>4?args[4]:obj._obj}},{}],15:[function(require,module,exports){module.exports=function(object){var result=[];for(var name in object)result.push(name);return result}},{}],16:[function(require,module,exports){var flag=require("./flag"),getActual=require("./getActual"),objDisplay=(require("./inspect"),require("./objDisplay"));module.exports=function(obj,args){var negate=flag(obj,"negate"),val=flag(obj,"object"),expected=args[3],actual=getActual(obj,args),msg=negate?args[2]:args[1],flagMsg=flag(obj,"message");return"function"==typeof msg&&(msg=msg()),msg=msg||"",msg=msg.replace(/#\{this\}/g,function(){return objDisplay(val)}).replace(/#\{act\}/g,function(){return objDisplay(actual)}).replace(/#\{exp\}/g,function(){return objDisplay(expected)}),flagMsg?flagMsg+": "+msg:msg}},{"./flag":13,"./getActual":14,"./inspect":23,"./objDisplay":24}],17:[function(require,module,exports){module.exports=function(func){if(func.name)return func.name;var match=/^\s?function ([^(]*)\(/.exec(func);return match&&match[1]?match[1]:""}},{}],18:[function(require,module,exports){function parsePath(path){var str=path.replace(/([^\\])\[/g,"$1.["),parts=str.match(/(\\\.|[^.]+?)+/g);return parts.map(function(value){var re=/^\[(\d+)\]$/,mArr=re.exec(value);return mArr?{i:parseFloat(mArr[1])}:{p:value.replace(/\\([.\[\]])/g,"$1")}})}function _getPathValue(parsed,obj,index){var res,tmp=obj;index=void 0===index?parsed.length:index;for(var i=0,l=index;i<l;i++){var part=parsed[i];tmp?("undefined"!=typeof part.p?tmp=tmp[part.p]:"undefined"!=typeof part.i&&(tmp=tmp[part.i]),i==l-1&&(res=tmp)):res=void 0}return res}var hasProperty=require("./hasProperty");module.exports=function(path,obj){var parsed=parsePath(path),last=parsed[parsed.length-1],info={parent:parsed.length>1?_getPathValue(parsed,obj,parsed.length-1):obj,name:last.p||last.i,value:_getPathValue(parsed,obj)};return info.exists=hasProperty(info.name,info.parent),info}},{"./hasProperty":21}],19:[function(require,module,exports){var getPathInfo=require("./getPathInfo");module.exports=function(path,obj){var info=getPathInfo(path,obj);return info.value}},{"./getPathInfo":18}],20:[function(require,module,exports){module.exports=function(object){function addProperty(property){result.indexOf(property)===-1&&result.push(property)}for(var result=Object.getOwnPropertyNames(object),proto=Object.getPrototypeOf(object);null!==proto;)Object.getOwnPropertyNames(proto).forEach(addProperty),proto=Object.getPrototypeOf(proto);return result}},{}],21:[function(require,module,exports){var type=require("type-detect"),literals={number:Number,string:String};module.exports=function(name,obj){var ot=type(obj);return"null"!==ot&&"undefined"!==ot&&(literals[ot]&&"object"!=typeof obj&&(obj=new literals[ot](obj)),name in obj)}},{"type-detect":35}],22:[function(require,module,exports){var exports=module.exports={};exports.test=require("./test"),exports.type=require("type-detect"),exports.expectTypes=require("./expectTypes"),exports.getMessage=require("./getMessage"),exports.getActual=require("./getActual"),exports.inspect=require("./inspect"),exports.objDisplay=require("./objDisplay"),exports.flag=require("./flag"),exports.transferFlags=require("./transferFlags"),exports.eql=require("deep-eql"),exports.getPathValue=require("./getPathValue"),exports.getPathInfo=require("./getPathInfo"),exports.hasProperty=require("./hasProperty"),exports.getName=require("./getName"),exports.addProperty=require("./addProperty"),exports.addMethod=require("./addMethod"),exports.overwriteProperty=require("./overwriteProperty"),exports.overwriteMethod=require("./overwriteMethod"),exports.addChainableMethod=require("./addChainableMethod"),exports.overwriteChainableMethod=require("./overwriteChainableMethod")},{"./addChainableMethod":9,"./addMethod":10,"./addProperty":11,"./expectTypes":12,"./flag":13,"./getActual":14,"./getMessage":16,"./getName":17,"./getPathInfo":18,"./getPathValue":19,"./hasProperty":21,"./inspect":23,"./objDisplay":24,"./overwriteChainableMethod":25,"./overwriteMethod":26,"./overwriteProperty":27,"./test":28,"./transferFlags":29,"deep-eql":31,"type-detect":35}],23:[function(require,module,exports){function inspect(obj,showHidden,depth,colors){var ctx={showHidden:showHidden,seen:[],stylize:function(str){return str}};return formatValue(ctx,obj,"undefined"==typeof depth?2:depth)}function formatValue(ctx,value,recurseTimes){if(value&&"function"==typeof value.inspect&&value.inspect!==exports.inspect&&(!value.constructor||value.constructor.prototype!==value)){var ret=value.inspect(recurseTimes);return"string"!=typeof ret&&(ret=formatValue(ctx,ret,recurseTimes)),ret}var primitive=formatPrimitive(ctx,value);if(primitive)return primitive;if(isDOMElement(value)){if("outerHTML"in value)return value.outerHTML;try{if(document.xmlVersion){var xmlSerializer=new XMLSerializer;return xmlSerializer.serializeToString(value)}var ns="http://www.w3.org/1999/xhtml",container=document.createElementNS(ns,"_");return container.appendChild(value.cloneNode(!1)),html=container.innerHTML.replace("><",">"+value.innerHTML+"<"),container.innerHTML="",html}catch(err){}}var visibleKeys=getEnumerableProperties(value),keys=ctx.showHidden?getProperties(value):visibleKeys;if(0===keys.length||isError(value)&&(1===keys.length&&"stack"===keys[0]||2===keys.length&&"description"===keys[0]&&"stack"===keys[1])){if("function"==typeof value){var name=getName(value),nameSuffix=name?": "+name:"";return ctx.stylize("[Function"+nameSuffix+"]","special")}if(isRegExp(value))return ctx.stylize(RegExp.prototype.toString.call(value),"regexp");if(isDate(value))return ctx.stylize(Date.prototype.toUTCString.call(value),"date");if(isError(value))return formatError(value)}var base="",array=!1,braces=["{","}"];if(isArray(value)&&(array=!0,braces=["[","]"]),"function"==typeof value){var name=getName(value),nameSuffix=name?": "+name:"";base=" [Function"+nameSuffix+"]"}if(isRegExp(value)&&(base=" "+RegExp.prototype.toString.call(value)),isDate(value)&&(base=" "+Date.prototype.toUTCString.call(value)),isError(value))return formatError(value);if(0===keys.length&&(!array||0==value.length))return braces[0]+base+braces[1];if(recurseTimes<0)return isRegExp(value)?ctx.stylize(RegExp.prototype.toString.call(value),"regexp"):ctx.stylize("[Object]","special");ctx.seen.push(value);var output;return output=array?formatArray(ctx,value,recurseTimes,visibleKeys,keys):keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)}),ctx.seen.pop(),reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){switch(typeof value){case"undefined":return ctx.stylize("undefined","undefined");case"string":var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string");case"number":return 0===value&&1/value===-(1/0)?ctx.stylize("-0","number"):ctx.stylize(""+value,"number");case"boolean":return ctx.stylize(""+value,"boolean")}if(null===value)return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){for(var output=[],i=0,l=value.length;i<l;++i)Object.prototype.hasOwnProperty.call(value,String(i))?output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),!0)):output.push("");return keys.forEach(function(key){key.match(/^\d+$/)||output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,!0))}),output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str;if(value.__lookupGetter__&&(value.__lookupGetter__(key)?str=value.__lookupSetter__(key)?ctx.stylize("[Getter/Setter]","special"):ctx.stylize("[Getter]","special"):value.__lookupSetter__(key)&&(str=ctx.stylize("[Setter]","special"))),visibleKeys.indexOf(key)<0&&(name="["+key+"]"),str||(ctx.seen.indexOf(value[key])<0?(str=null===recurseTimes?formatValue(ctx,value[key],null):formatValue(ctx,value[key],recurseTimes-1),str.indexOf("\n")>-1&&(str=array?str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2):"\n"+str.split("\n").map(function(line){return"   "+line}).join("\n"))):str=ctx.stylize("[Circular]","special")),"undefined"==typeof name){if(array&&key.match(/^\d+$/))return str;name=JSON.stringify(""+key),name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(name=name.substr(1,name.length-2),name=ctx.stylize(name,"name")):(name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),name=ctx.stylize(name,"string"))}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0,length=output.reduce(function(prev,cur){return numLinesEst++,cur.indexOf("\n")>=0&&numLinesEst++,prev+cur.length+1},0);return length>60?braces[0]+(""===base?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]:braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)||"object"==typeof ar&&"[object Array]"===objectToString(ar)}function isRegExp(re){return"object"==typeof re&&"[object RegExp]"===objectToString(re)}function isDate(d){return"object"==typeof d&&"[object Date]"===objectToString(d)}function isError(e){return"object"==typeof e&&"[object Error]"===objectToString(e)}function objectToString(o){return Object.prototype.toString.call(o)}var getName=require("./getName"),getProperties=require("./getProperties"),getEnumerableProperties=require("./getEnumerableProperties");module.exports=inspect;var isDOMElement=function(object){return"object"==typeof HTMLElement?object instanceof HTMLElement:object&&"object"==typeof object&&1===object.nodeType&&"string"==typeof object.nodeName}},{"./getEnumerableProperties":15,"./getName":17,"./getProperties":20}],24:[function(require,module,exports){var inspect=require("./inspect"),config=require("../config");module.exports=function(obj){var str=inspect(obj),type=Object.prototype.toString.call(obj);if(config.truncateThreshold&&str.length>=config.truncateThreshold){if("[object Function]"===type)return obj.name&&""!==obj.name?"[Function: "+obj.name+"]":"[Function]";if("[object Array]"===type)return"[ Array("+obj.length+") ]";if("[object Object]"===type){var keys=Object.keys(obj),kstr=keys.length>2?keys.splice(0,2).join(", ")+", ...":keys.join(", ");return"{ Object ("+kstr+") }"}return str}return str}},{"../config":4,"./inspect":23}],25:[function(require,module,exports){module.exports=function(ctx,name,method,chainingBehavior){var chainableBehavior=ctx.__methods[name],_chainingBehavior=chainableBehavior.chainingBehavior;chainableBehavior.chainingBehavior=function(){var result=chainingBehavior(_chainingBehavior).call(this);return void 0===result?this:result};var _method=chainableBehavior.method;chainableBehavior.method=function(){var result=method(_method).apply(this,arguments);return void 0===result?this:result}}},{}],26:[function(require,module,exports){module.exports=function(ctx,name,method){var _method=ctx[name],_super=function(){return this};_method&&"function"==typeof _method&&(_super=_method),ctx[name]=function(){var result=method(_super).apply(this,arguments);return void 0===result?this:result}}},{}],27:[function(require,module,exports){module.exports=function(ctx,name,getter){var _get=Object.getOwnPropertyDescriptor(ctx,name),_super=function(){};_get&&"function"==typeof _get.get&&(_super=_get.get),Object.defineProperty(ctx,name,{get:function(){var result=getter(_super).call(this);return void 0===result?this:result},configurable:!0})}},{}],28:[function(require,module,exports){var flag=require("./flag");module.exports=function(obj,args){var negate=flag(obj,"negate"),expr=args[0];return negate?!expr:expr}},{"./flag":13}],29:[function(require,module,exports){module.exports=function(assertion,object,includeAll){var flags=assertion.__flags||(assertion.__flags=Object.create(null));object.__flags||(object.__flags=Object.create(null)),includeAll=3!==arguments.length||includeAll;for(var flag in flags)(includeAll||"object"!==flag&&"ssfi"!==flag&&"message"!=flag)&&(object.__flags[flag]=flags[flag])}},{}],30:[function(require,module,exports){function exclude(){function excludeProps(res,obj){Object.keys(obj).forEach(function(key){~excludes.indexOf(key)||(res[key]=obj[key])})}var excludes=[].slice.call(arguments);return function(){for(var args=[].slice.call(arguments),i=0,res={};i<args.length;i++)excludeProps(res,args[i]);return res}}function AssertionError(message,_props,ssf){var extend=exclude("name","message","stack","constructor","toJSON"),props=extend(_props||{});this.message=message||"Unspecified AssertionError",this.showDiff=!1;for(var key in props)this[key]=props[key];ssf=ssf||arguments.callee,ssf&&Error.captureStackTrace?Error.captureStackTrace(this,ssf):this.stack=(new Error).stack}module.exports=AssertionError,AssertionError.prototype=Object.create(Error.prototype),AssertionError.prototype.name="AssertionError",AssertionError.prototype.constructor=AssertionError,AssertionError.prototype.toJSON=function(stack){var extend=exclude("constructor","toJSON","stack"),props=extend({name:this.name},this);return!1!==stack&&this.stack&&(props.stack=this.stack),props}},{}],31:[function(require,module,exports){module.exports=require("./lib/eql")},{"./lib/eql":32}],32:[function(require,module,exports){function deepEqual(a,b,m){return!!sameValue(a,b)||("date"===type(a)?dateEqual(a,b):"regexp"===type(a)?regexpEqual(a,b):Buffer.isBuffer(a)?bufferEqual(a,b):"arguments"===type(a)?argumentsEqual(a,b,m):!!typeEqual(a,b)&&("object"!==type(a)&&"object"!==type(b)&&"array"!==type(a)&&"array"!==type(b)?sameValue(a,b):objectEqual(a,b,m)))}function sameValue(a,b){return a===b?0!==a||1/a===1/b:a!==a&&b!==b}function typeEqual(a,b){return type(a)===type(b)}function dateEqual(a,b){return"date"===type(b)&&sameValue(a.getTime(),b.getTime())}function regexpEqual(a,b){return"regexp"===type(b)&&sameValue(a.toString(),b.toString())}function argumentsEqual(a,b,m){return"arguments"===type(b)&&(a=[].slice.call(a),b=[].slice.call(b),deepEqual(a,b,m))}function enumerable(a){var res=[];for(var key in a)res.push(key);return res}function iterableEqual(a,b){if(a.length!==b.length)return!1;for(var i=0,match=!0;i<a.length;i++)if(a[i]!==b[i]){match=!1;break}return match}function bufferEqual(a,b){return!!Buffer.isBuffer(b)&&iterableEqual(a,b)}function isValue(a){return null!==a&&void 0!==a}function objectEqual(a,b,m){if(!isValue(a)||!isValue(b))return!1;if(a.prototype!==b.prototype)return!1;var i;if(m){for(i=0;i<m.length;i++)if(m[i][0]===a&&m[i][1]===b||m[i][0]===b&&m[i][1]===a)return!0}else m=[];try{var ka=enumerable(a),kb=enumerable(b)}catch(ex){return!1}if(ka.sort(),kb.sort(),!iterableEqual(ka,kb))return!1;m.push([a,b]);var key;for(i=ka.length-1;i>=0;i--)if(key=ka[i],!deepEqual(a[key],b[key],m))return!1;return!0}var Buffer,type=require("type-detect");try{Buffer=require("buffer").Buffer}catch(ex){Buffer={},Buffer.isBuffer=function(){return!1}}module.exports=deepEqual},{buffer:void 0,"type-detect":33}],33:[function(require,module,exports){module.exports=require("./lib/type")},{"./lib/type":34}],34:[function(require,module,exports){function getType(obj){var str=Object.prototype.toString.call(obj);return natives[str]?natives[str]:null===obj?"null":void 0===obj?"undefined":obj===Object(obj)?"object":typeof obj}function Library(){this.tests={}}var exports=module.exports=getType,natives={"[object Array]":"array","[object RegExp]":"regexp","[object Function]":"function","[object Arguments]":"arguments","[object Date]":"date"};exports.Library=Library,Library.prototype.of=getType,Library.prototype.define=function(type,test){return 1===arguments.length?this.tests[type]:(this.tests[type]=test,this)},Library.prototype.test=function(obj,type){if(type===getType(obj))return!0;var test=this.tests[type];if(test&&"regexp"===getType(test))return test.test(obj);if(test&&"function"===getType(test))return test(obj);throw new ReferenceError('Type test "'+type+'" not defined or invalid.')}},{}],35:[function(require,module,exports){arguments[4][33][0].apply(exports,arguments)},{"./lib/type":36,dup:33}],36:[function(require,module,exports){function getType(obj){var type=Object.prototype.toString.call(obj).match(objectTypeRegexp)[1].toLowerCase();return"function"==typeof Promise&&obj instanceof Promise?"promise":null===obj?"null":void 0===obj?"undefined":type}function Library(){return this instanceof Library?void(this.tests={}):new Library}var exports=module.exports=getType,objectTypeRegexp=/^\[object (.*)\]$/;exports.Library=Library,Library.prototype.of=getType,Library.prototype.define=function(type,test){return 1===arguments.length?this.tests[type]:(this.tests[type]=test,this)},Library.prototype.test=function(obj,type){if(type===getType(obj))return!0;var test=this.tests[type];if(test&&"regexp"===getType(test))return test.test(obj);if(test&&"function"===getType(test))return test(obj);throw new ReferenceError('Type test "'+type+'" not defined or invalid.')}},{}]},{},[1])(1)}),function(){"use strict";function lib$rsvp$utils$$objectOrFunction(x){return"function"==typeof x||"object"==typeof x&&null!==x}function lib$rsvp$utils$$isFunction(x){return"function"==typeof x}function lib$rsvp$utils$$isMaybeThenable(x){return"object"==typeof x&&null!==x}function lib$rsvp$utils$$F(){}function lib$rsvp$events$$indexOf(callbacks,callback){for(var i=0,l=callbacks.length;i<l;i++)if(callbacks[i]===callback)return i;return-1}function lib$rsvp$events$$callbacksFor(object){var callbacks=object._promiseCallbacks;return callbacks||(callbacks=object._promiseCallbacks={}),callbacks}function lib$rsvp$config$$configure(name,value){return"onerror"===name?void lib$rsvp$config$$config.on("error",value):2!==arguments.length?lib$rsvp$config$$config[name]:void(lib$rsvp$config$$config[name]=value)}function lib$rsvp$instrument$$scheduleFlush(){setTimeout(function(){for(var entry,i=0;i<lib$rsvp$instrument$$queue.length;i++){entry=lib$rsvp$instrument$$queue[i];var payload=entry.payload;payload.guid=payload.key+payload.id,payload.childGuid=payload.key+payload.childId,payload.error&&(payload.stack=payload.error.stack),lib$rsvp$config$$config.trigger(entry.name,entry.payload)}lib$rsvp$instrument$$queue.length=0},50)}function lib$rsvp$instrument$$instrument(eventName,promise,child){1===lib$rsvp$instrument$$queue.push({name:eventName,payload:{key:promise._guidKey,id:promise._id,eventName:eventName,detail:promise._result,childId:child&&child._id,label:promise._label,timeStamp:lib$rsvp$utils$$now(),error:lib$rsvp$config$$config["instrument-with-stack"]?new Error(promise._label):null}})&&lib$rsvp$instrument$$scheduleFlush()}function lib$rsvp$$internal$$withOwnPromise(){return new TypeError("A promises callback cannot return that same promise.")}function lib$rsvp$$internal$$noop(){}function lib$rsvp$$internal$$getThen(promise){try{return promise.then}catch(error){return lib$rsvp$$internal$$GET_THEN_ERROR.error=error,lib$rsvp$$internal$$GET_THEN_ERROR}}function lib$rsvp$$internal$$tryThen(then,value,fulfillmentHandler,rejectionHandler){try{then.call(value,fulfillmentHandler,rejectionHandler)}catch(e){return e}}function lib$rsvp$$internal$$handleForeignThenable(promise,thenable,then){lib$rsvp$config$$config.async(function(promise){var sealed=!1,error=lib$rsvp$$internal$$tryThen(then,thenable,function(value){sealed||(sealed=!0,thenable!==value?lib$rsvp$$internal$$resolve(promise,value):lib$rsvp$$internal$$fulfill(promise,value))},function(reason){sealed||(sealed=!0,lib$rsvp$$internal$$reject(promise,reason))},"Settle: "+(promise._label||" unknown promise"));!sealed&&error&&(sealed=!0,lib$rsvp$$internal$$reject(promise,error))},promise)}function lib$rsvp$$internal$$handleOwnThenable(promise,thenable){thenable._state===lib$rsvp$$internal$$FULFILLED?lib$rsvp$$internal$$fulfill(promise,thenable._result):thenable._state===lib$rsvp$$internal$$REJECTED?(thenable._onError=null,lib$rsvp$$internal$$reject(promise,thenable._result)):lib$rsvp$$internal$$subscribe(thenable,void 0,function(value){thenable!==value?lib$rsvp$$internal$$resolve(promise,value):lib$rsvp$$internal$$fulfill(promise,value)},function(reason){lib$rsvp$$internal$$reject(promise,reason)})}function lib$rsvp$$internal$$handleMaybeThenable(promise,maybeThenable){if(maybeThenable.constructor===promise.constructor)lib$rsvp$$internal$$handleOwnThenable(promise,maybeThenable);else{var then=lib$rsvp$$internal$$getThen(maybeThenable);then===lib$rsvp$$internal$$GET_THEN_ERROR?lib$rsvp$$internal$$reject(promise,lib$rsvp$$internal$$GET_THEN_ERROR.error):void 0===then?lib$rsvp$$internal$$fulfill(promise,maybeThenable):lib$rsvp$utils$$isFunction(then)?lib$rsvp$$internal$$handleForeignThenable(promise,maybeThenable,then):lib$rsvp$$internal$$fulfill(promise,maybeThenable)}}function lib$rsvp$$internal$$resolve(promise,value){promise===value?lib$rsvp$$internal$$fulfill(promise,value):lib$rsvp$utils$$objectOrFunction(value)?lib$rsvp$$internal$$handleMaybeThenable(promise,value):lib$rsvp$$internal$$fulfill(promise,value)}function lib$rsvp$$internal$$publishRejection(promise){promise._onError&&promise._onError(promise._result),lib$rsvp$$internal$$publish(promise)}function lib$rsvp$$internal$$fulfill(promise,value){promise._state===lib$rsvp$$internal$$PENDING&&(promise._result=value,promise._state=lib$rsvp$$internal$$FULFILLED,0===promise._subscribers.length?lib$rsvp$config$$config.instrument&&lib$rsvp$instrument$$default("fulfilled",promise):lib$rsvp$config$$config.async(lib$rsvp$$internal$$publish,promise))}function lib$rsvp$$internal$$reject(promise,reason){promise._state===lib$rsvp$$internal$$PENDING&&(promise._state=lib$rsvp$$internal$$REJECTED,promise._result=reason,lib$rsvp$config$$config.async(lib$rsvp$$internal$$publishRejection,promise))}function lib$rsvp$$internal$$subscribe(parent,child,onFulfillment,onRejection){var subscribers=parent._subscribers,length=subscribers.length;parent._onError=null,subscribers[length]=child,subscribers[length+lib$rsvp$$internal$$FULFILLED]=onFulfillment,subscribers[length+lib$rsvp$$internal$$REJECTED]=onRejection,0===length&&parent._state&&lib$rsvp$config$$config.async(lib$rsvp$$internal$$publish,parent)}function lib$rsvp$$internal$$publish(promise){var subscribers=promise._subscribers,settled=promise._state;if(lib$rsvp$config$$config.instrument&&lib$rsvp$instrument$$default(settled===lib$rsvp$$internal$$FULFILLED?"fulfilled":"rejected",promise),0!==subscribers.length){for(var child,callback,detail=promise._result,i=0;i<subscribers.length;i+=3)child=subscribers[i],callback=subscribers[i+settled],child?lib$rsvp$$internal$$invokeCallback(settled,child,callback,detail):callback(detail);promise._subscribers.length=0}}function lib$rsvp$$internal$$ErrorObject(){this.error=null}function lib$rsvp$$internal$$tryCatch(callback,detail){try{return callback(detail)}catch(e){return lib$rsvp$$internal$$TRY_CATCH_ERROR.error=e,lib$rsvp$$internal$$TRY_CATCH_ERROR}}function lib$rsvp$$internal$$invokeCallback(settled,promise,callback,detail){var value,error,succeeded,failed,hasCallback=lib$rsvp$utils$$isFunction(callback);if(hasCallback){if(value=lib$rsvp$$internal$$tryCatch(callback,detail),value===lib$rsvp$$internal$$TRY_CATCH_ERROR?(failed=!0,error=value.error,value=null):succeeded=!0,promise===value)return void lib$rsvp$$internal$$reject(promise,lib$rsvp$$internal$$withOwnPromise())}else value=detail,succeeded=!0;promise._state!==lib$rsvp$$internal$$PENDING||(hasCallback&&succeeded?lib$rsvp$$internal$$resolve(promise,value):failed?lib$rsvp$$internal$$reject(promise,error):settled===lib$rsvp$$internal$$FULFILLED?lib$rsvp$$internal$$fulfill(promise,value):settled===lib$rsvp$$internal$$REJECTED&&lib$rsvp$$internal$$reject(promise,value))}function lib$rsvp$$internal$$initializePromise(promise,resolver){var resolved=!1;try{resolver(function(value){resolved||(resolved=!0,lib$rsvp$$internal$$resolve(promise,value))},function(reason){resolved||(resolved=!0,lib$rsvp$$internal$$reject(promise,reason))})}catch(e){lib$rsvp$$internal$$reject(promise,e)}}function lib$rsvp$enumerator$$makeSettledResult(state,position,value){return state===lib$rsvp$$internal$$FULFILLED?{state:"fulfilled",value:value}:{state:"rejected",reason:value}}function lib$rsvp$enumerator$$Enumerator(Constructor,input,abortOnReject,label){this._instanceConstructor=Constructor,this.promise=new Constructor(lib$rsvp$$internal$$noop,label),this._abortOnReject=abortOnReject,this._validateInput(input)?(this._input=input,this.length=input.length,this._remaining=input.length,this._init(),0===this.length?lib$rsvp$$internal$$fulfill(this.promise,this._result):(this.length=this.length||0,
this._enumerate(),0===this._remaining&&lib$rsvp$$internal$$fulfill(this.promise,this._result))):lib$rsvp$$internal$$reject(this.promise,this._validationError())}function lib$rsvp$promise$all$$all(entries,label){return new lib$rsvp$enumerator$$default(this,entries,(!0),label).promise}function lib$rsvp$promise$race$$race(entries,label){function onFulfillment(value){lib$rsvp$$internal$$resolve(promise,value)}function onRejection(reason){lib$rsvp$$internal$$reject(promise,reason)}var Constructor=this,promise=new Constructor(lib$rsvp$$internal$$noop,label);if(!lib$rsvp$utils$$isArray(entries))return lib$rsvp$$internal$$reject(promise,new TypeError("You must pass an array to race.")),promise;for(var length=entries.length,i=0;promise._state===lib$rsvp$$internal$$PENDING&&i<length;i++)lib$rsvp$$internal$$subscribe(Constructor.resolve(entries[i]),void 0,onFulfillment,onRejection);return promise}function lib$rsvp$promise$resolve$$resolve(object,label){var Constructor=this;if(object&&"object"==typeof object&&object.constructor===Constructor)return object;var promise=new Constructor(lib$rsvp$$internal$$noop,label);return lib$rsvp$$internal$$resolve(promise,object),promise}function lib$rsvp$promise$reject$$reject(reason,label){var Constructor=this,promise=new Constructor(lib$rsvp$$internal$$noop,label);return lib$rsvp$$internal$$reject(promise,reason),promise}function lib$rsvp$promise$$needsResolver(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function lib$rsvp$promise$$needsNew(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function lib$rsvp$promise$$Promise(resolver,label){this._id=lib$rsvp$promise$$counter++,this._label=label,this._state=void 0,this._result=void 0,this._subscribers=[],lib$rsvp$config$$config.instrument&&lib$rsvp$instrument$$default("created",this),lib$rsvp$$internal$$noop!==resolver&&(lib$rsvp$utils$$isFunction(resolver)||lib$rsvp$promise$$needsResolver(),this instanceof lib$rsvp$promise$$Promise||lib$rsvp$promise$$needsNew(),lib$rsvp$$internal$$initializePromise(this,resolver))}function lib$rsvp$all$settled$$AllSettled(Constructor,entries,label){this._superConstructor(Constructor,entries,!1,label)}function lib$rsvp$all$settled$$allSettled(entries,label){return new lib$rsvp$all$settled$$AllSettled(lib$rsvp$promise$$default,entries,label).promise}function lib$rsvp$all$$all(array,label){return lib$rsvp$promise$$default.all(array,label)}function lib$rsvp$asap$$asap(callback,arg){lib$rsvp$asap$$queue[lib$rsvp$asap$$len]=callback,lib$rsvp$asap$$queue[lib$rsvp$asap$$len+1]=arg,lib$rsvp$asap$$len+=2,2===lib$rsvp$asap$$len&&lib$rsvp$asap$$scheduleFlush()}function lib$rsvp$asap$$useNextTick(){var nextTick=process.nextTick,version=process.versions.node.match(/^(?:(\d+)\.)?(?:(\d+)\.)?(\*|\d+)$/);return Array.isArray(version)&&"0"===version[1]&&"10"===version[2]&&(nextTick=setImmediate),function(){nextTick(lib$rsvp$asap$$flush)}}function lib$rsvp$asap$$useVertxTimer(){return function(){lib$rsvp$asap$$vertxNext(lib$rsvp$asap$$flush)}}function lib$rsvp$asap$$useMutationObserver(){var iterations=0,observer=new lib$rsvp$asap$$BrowserMutationObserver(lib$rsvp$asap$$flush),node=document.createTextNode("");return observer.observe(node,{characterData:!0}),function(){node.data=iterations=++iterations%2}}function lib$rsvp$asap$$useMessageChannel(){var channel=new MessageChannel;return channel.port1.onmessage=lib$rsvp$asap$$flush,function(){channel.port2.postMessage(0)}}function lib$rsvp$asap$$useSetTimeout(){return function(){setTimeout(lib$rsvp$asap$$flush,1)}}function lib$rsvp$asap$$flush(){for(var i=0;i<lib$rsvp$asap$$len;i+=2){var callback=lib$rsvp$asap$$queue[i],arg=lib$rsvp$asap$$queue[i+1];callback(arg),lib$rsvp$asap$$queue[i]=void 0,lib$rsvp$asap$$queue[i+1]=void 0}lib$rsvp$asap$$len=0}function lib$rsvp$asap$$attemptVertex(){try{var r=require,vertx=r("vertx");return lib$rsvp$asap$$vertxNext=vertx.runOnLoop||vertx.runOnContext,lib$rsvp$asap$$useVertxTimer()}catch(e){return lib$rsvp$asap$$useSetTimeout()}}function lib$rsvp$defer$$defer(label){var deferred={};return deferred.promise=new lib$rsvp$promise$$default(function(resolve,reject){deferred.resolve=resolve,deferred.reject=reject},label),deferred}function lib$rsvp$filter$$filter(promises,filterFn,label){return lib$rsvp$promise$$default.all(promises,label).then(function(values){if(!lib$rsvp$utils$$isFunction(filterFn))throw new TypeError("You must pass a function as filter's second argument.");for(var length=values.length,filtered=new Array(length),i=0;i<length;i++)filtered[i]=filterFn(values[i]);return lib$rsvp$promise$$default.all(filtered,label).then(function(filtered){for(var results=new Array(length),newLength=0,i=0;i<length;i++)filtered[i]&&(results[newLength]=values[i],newLength++);return results.length=newLength,results})})}function lib$rsvp$promise$hash$$PromiseHash(Constructor,object,label){this._superConstructor(Constructor,object,!0,label)}function lib$rsvp$hash$settled$$HashSettled(Constructor,object,label){this._superConstructor(Constructor,object,!1,label)}function lib$rsvp$hash$settled$$hashSettled(object,label){return new lib$rsvp$hash$settled$$HashSettled(lib$rsvp$promise$$default,object,label).promise}function lib$rsvp$hash$$hash(object,label){return new lib$rsvp$promise$hash$$default(lib$rsvp$promise$$default,object,label).promise}function lib$rsvp$map$$map(promises,mapFn,label){return lib$rsvp$promise$$default.all(promises,label).then(function(values){if(!lib$rsvp$utils$$isFunction(mapFn))throw new TypeError("You must pass a function as map's second argument.");for(var length=values.length,results=new Array(length),i=0;i<length;i++)results[i]=mapFn(values[i]);return lib$rsvp$promise$$default.all(results,label)})}function lib$rsvp$node$$Result(){this.value=void 0}function lib$rsvp$node$$getThen(obj){try{return obj.then}catch(error){return lib$rsvp$node$$ERROR.value=error,lib$rsvp$node$$ERROR}}function lib$rsvp$node$$tryApply(f,s,a){try{f.apply(s,a)}catch(error){return lib$rsvp$node$$ERROR.value=error,lib$rsvp$node$$ERROR}}function lib$rsvp$node$$makeObject(_,argumentNames){for(var name,i,obj={},length=_.length,args=new Array(length),x=0;x<length;x++)args[x]=_[x];for(i=0;i<argumentNames.length;i++)name=argumentNames[i],obj[name]=args[i+1];return obj}function lib$rsvp$node$$arrayResult(_){for(var length=_.length,args=new Array(length-1),i=1;i<length;i++)args[i-1]=_[i];return args}function lib$rsvp$node$$wrapThenable(then,promise){return{then:function(onFulFillment,onRejection){return then.call(promise,onFulFillment,onRejection)}}}function lib$rsvp$node$$denodeify(nodeFunc,options){var fn=function(){for(var arg,self=this,l=arguments.length,args=new Array(l+1),promiseInput=!1,i=0;i<l;++i){if(arg=arguments[i],!promiseInput){if(promiseInput=lib$rsvp$node$$needsPromiseInput(arg),promiseInput===lib$rsvp$node$$GET_THEN_ERROR){var p=new lib$rsvp$promise$$default(lib$rsvp$$internal$$noop);return lib$rsvp$$internal$$reject(p,lib$rsvp$node$$GET_THEN_ERROR.value),p}promiseInput&&promiseInput!==!0&&(arg=lib$rsvp$node$$wrapThenable(promiseInput,arg))}args[i]=arg}var promise=new lib$rsvp$promise$$default(lib$rsvp$$internal$$noop);return args[l]=function(err,val){err?lib$rsvp$$internal$$reject(promise,err):void 0===options?lib$rsvp$$internal$$resolve(promise,val):options===!0?lib$rsvp$$internal$$resolve(promise,lib$rsvp$node$$arrayResult(arguments)):lib$rsvp$utils$$isArray(options)?lib$rsvp$$internal$$resolve(promise,lib$rsvp$node$$makeObject(arguments,options)):lib$rsvp$$internal$$resolve(promise,val)},promiseInput?lib$rsvp$node$$handlePromiseInput(promise,args,nodeFunc,self):lib$rsvp$node$$handleValueInput(promise,args,nodeFunc,self)};return fn.__proto__=nodeFunc,fn}function lib$rsvp$node$$handleValueInput(promise,args,nodeFunc,self){var result=lib$rsvp$node$$tryApply(nodeFunc,self,args);return result===lib$rsvp$node$$ERROR&&lib$rsvp$$internal$$reject(promise,result.value),promise}function lib$rsvp$node$$handlePromiseInput(promise,args,nodeFunc,self){return lib$rsvp$promise$$default.all(args).then(function(args){var result=lib$rsvp$node$$tryApply(nodeFunc,self,args);return result===lib$rsvp$node$$ERROR&&lib$rsvp$$internal$$reject(promise,result.value),promise})}function lib$rsvp$node$$needsPromiseInput(arg){return!(!arg||"object"!=typeof arg)&&(arg.constructor===lib$rsvp$promise$$default||lib$rsvp$node$$getThen(arg))}function lib$rsvp$race$$race(array,label){return lib$rsvp$promise$$default.race(array,label)}function lib$rsvp$reject$$reject(reason,label){return lib$rsvp$promise$$default.reject(reason,label)}function lib$rsvp$resolve$$resolve(value,label){return lib$rsvp$promise$$default.resolve(value,label)}function lib$rsvp$rethrow$$rethrow(reason){throw setTimeout(function(){throw reason}),reason}function lib$rsvp$$async(callback,arg){lib$rsvp$config$$config.async(callback,arg)}function lib$rsvp$$on(){lib$rsvp$config$$config.on.apply(lib$rsvp$config$$config,arguments)}function lib$rsvp$$off(){lib$rsvp$config$$config.off.apply(lib$rsvp$config$$config,arguments)}var lib$rsvp$utils$$_isArray;lib$rsvp$utils$$_isArray=Array.isArray?Array.isArray:function(x){return"[object Array]"===Object.prototype.toString.call(x)};var lib$rsvp$utils$$isArray=lib$rsvp$utils$$_isArray,lib$rsvp$utils$$now=Date.now||function(){return(new Date).getTime()},lib$rsvp$utils$$o_create=Object.create||function(o){if(arguments.length>1)throw new Error("Second argument not supported");if("object"!=typeof o)throw new TypeError("Argument must be an object");return lib$rsvp$utils$$F.prototype=o,new lib$rsvp$utils$$F},lib$rsvp$events$$default={mixin:function(object){return object.on=this.on,object.off=this.off,object.trigger=this.trigger,object._promiseCallbacks=void 0,object},on:function(eventName,callback){var callbacks,allCallbacks=lib$rsvp$events$$callbacksFor(this);callbacks=allCallbacks[eventName],callbacks||(callbacks=allCallbacks[eventName]=[]),lib$rsvp$events$$indexOf(callbacks,callback)===-1&&callbacks.push(callback)},off:function(eventName,callback){var callbacks,index,allCallbacks=lib$rsvp$events$$callbacksFor(this);return callback?(callbacks=allCallbacks[eventName],index=lib$rsvp$events$$indexOf(callbacks,callback),void(index!==-1&&callbacks.splice(index,1))):void(allCallbacks[eventName]=[])},trigger:function(eventName,options){var callbacks,callback,allCallbacks=lib$rsvp$events$$callbacksFor(this);if(callbacks=allCallbacks[eventName])for(var i=0;i<callbacks.length;i++)(callback=callbacks[i])(options)}},lib$rsvp$config$$config={instrument:!1};lib$rsvp$events$$default.mixin(lib$rsvp$config$$config);var lib$rsvp$instrument$$queue=[],lib$rsvp$instrument$$default=lib$rsvp$instrument$$instrument,lib$rsvp$$internal$$PENDING=void 0,lib$rsvp$$internal$$FULFILLED=1,lib$rsvp$$internal$$REJECTED=2,lib$rsvp$$internal$$GET_THEN_ERROR=new lib$rsvp$$internal$$ErrorObject,lib$rsvp$$internal$$TRY_CATCH_ERROR=new lib$rsvp$$internal$$ErrorObject,lib$rsvp$enumerator$$default=lib$rsvp$enumerator$$Enumerator;lib$rsvp$enumerator$$Enumerator.prototype._validateInput=function(input){return lib$rsvp$utils$$isArray(input)},lib$rsvp$enumerator$$Enumerator.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")},lib$rsvp$enumerator$$Enumerator.prototype._init=function(){this._result=new Array(this.length)},lib$rsvp$enumerator$$Enumerator.prototype._enumerate=function(){for(var length=this.length,promise=this.promise,input=this._input,i=0;promise._state===lib$rsvp$$internal$$PENDING&&i<length;i++)this._eachEntry(input[i],i)},lib$rsvp$enumerator$$Enumerator.prototype._eachEntry=function(entry,i){var c=this._instanceConstructor;lib$rsvp$utils$$isMaybeThenable(entry)?entry.constructor===c&&entry._state!==lib$rsvp$$internal$$PENDING?(entry._onError=null,this._settledAt(entry._state,i,entry._result)):this._willSettleAt(c.resolve(entry),i):(this._remaining--,this._result[i]=this._makeResult(lib$rsvp$$internal$$FULFILLED,i,entry))},lib$rsvp$enumerator$$Enumerator.prototype._settledAt=function(state,i,value){var promise=this.promise;promise._state===lib$rsvp$$internal$$PENDING&&(this._remaining--,this._abortOnReject&&state===lib$rsvp$$internal$$REJECTED?lib$rsvp$$internal$$reject(promise,value):this._result[i]=this._makeResult(state,i,value)),0===this._remaining&&lib$rsvp$$internal$$fulfill(promise,this._result)},lib$rsvp$enumerator$$Enumerator.prototype._makeResult=function(state,i,value){return value},lib$rsvp$enumerator$$Enumerator.prototype._willSettleAt=function(promise,i){var enumerator=this;lib$rsvp$$internal$$subscribe(promise,void 0,function(value){enumerator._settledAt(lib$rsvp$$internal$$FULFILLED,i,value)},function(reason){enumerator._settledAt(lib$rsvp$$internal$$REJECTED,i,reason)})};var lib$rsvp$promise$all$$default=lib$rsvp$promise$all$$all,lib$rsvp$promise$race$$default=lib$rsvp$promise$race$$race,lib$rsvp$promise$resolve$$default=lib$rsvp$promise$resolve$$resolve,lib$rsvp$promise$reject$$default=lib$rsvp$promise$reject$$reject,lib$rsvp$promise$$guidKey="rsvp_"+lib$rsvp$utils$$now()+"-",lib$rsvp$promise$$counter=0,lib$rsvp$promise$$default=lib$rsvp$promise$$Promise;lib$rsvp$promise$$Promise.cast=lib$rsvp$promise$resolve$$default,lib$rsvp$promise$$Promise.all=lib$rsvp$promise$all$$default,lib$rsvp$promise$$Promise.race=lib$rsvp$promise$race$$default,lib$rsvp$promise$$Promise.resolve=lib$rsvp$promise$resolve$$default,lib$rsvp$promise$$Promise.reject=lib$rsvp$promise$reject$$default,lib$rsvp$promise$$Promise.prototype={constructor:lib$rsvp$promise$$Promise,_guidKey:lib$rsvp$promise$$guidKey,_onError:function(reason){lib$rsvp$config$$config.async(function(promise){setTimeout(function(){promise._onError&&lib$rsvp$config$$config.trigger("error",reason)},0)},this)},then:function(onFulfillment,onRejection,label){var parent=this,state=parent._state;if(state===lib$rsvp$$internal$$FULFILLED&&!onFulfillment||state===lib$rsvp$$internal$$REJECTED&&!onRejection)return lib$rsvp$config$$config.instrument&&lib$rsvp$instrument$$default("chained",this,this),this;parent._onError=null;var child=new this.constructor(lib$rsvp$$internal$$noop,label),result=parent._result;if(lib$rsvp$config$$config.instrument&&lib$rsvp$instrument$$default("chained",parent,child),state){var callback=arguments[state-1];lib$rsvp$config$$config.async(function(){lib$rsvp$$internal$$invokeCallback(state,child,callback,result)})}else lib$rsvp$$internal$$subscribe(parent,child,onFulfillment,onRejection);return child},catch:function(onRejection,label){return this.then(null,onRejection,label)},finally:function(callback,label){var constructor=this.constructor;return this.then(function(value){return constructor.resolve(callback()).then(function(){return value})},function(reason){return constructor.resolve(callback()).then(function(){throw reason})},label)}},lib$rsvp$all$settled$$AllSettled.prototype=lib$rsvp$utils$$o_create(lib$rsvp$enumerator$$default.prototype),lib$rsvp$all$settled$$AllSettled.prototype._superConstructor=lib$rsvp$enumerator$$default,lib$rsvp$all$settled$$AllSettled.prototype._makeResult=lib$rsvp$enumerator$$makeSettledResult,lib$rsvp$all$settled$$AllSettled.prototype._validationError=function(){return new Error("allSettled must be called with an array")};var lib$rsvp$asap$$vertxNext,lib$rsvp$asap$$scheduleFlush,lib$rsvp$all$settled$$default=lib$rsvp$all$settled$$allSettled,lib$rsvp$all$$default=lib$rsvp$all$$all,lib$rsvp$asap$$len=0,lib$rsvp$asap$$default=({}.toString,lib$rsvp$asap$$asap),lib$rsvp$asap$$browserWindow="undefined"!=typeof window?window:void 0,lib$rsvp$asap$$browserGlobal=lib$rsvp$asap$$browserWindow||{},lib$rsvp$asap$$BrowserMutationObserver=lib$rsvp$asap$$browserGlobal.MutationObserver||lib$rsvp$asap$$browserGlobal.WebKitMutationObserver,lib$rsvp$asap$$isNode="undefined"!=typeof process&&"[object process]"==={}.toString.call(process),lib$rsvp$asap$$isWorker="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,lib$rsvp$asap$$queue=new Array(1e3);lib$rsvp$asap$$scheduleFlush=lib$rsvp$asap$$isNode?lib$rsvp$asap$$useNextTick():lib$rsvp$asap$$BrowserMutationObserver?lib$rsvp$asap$$useMutationObserver():lib$rsvp$asap$$isWorker?lib$rsvp$asap$$useMessageChannel():void 0===lib$rsvp$asap$$browserWindow&&"function"==typeof require?lib$rsvp$asap$$attemptVertex():lib$rsvp$asap$$useSetTimeout();var lib$rsvp$defer$$default=lib$rsvp$defer$$defer,lib$rsvp$filter$$default=lib$rsvp$filter$$filter,lib$rsvp$promise$hash$$default=lib$rsvp$promise$hash$$PromiseHash;lib$rsvp$promise$hash$$PromiseHash.prototype=lib$rsvp$utils$$o_create(lib$rsvp$enumerator$$default.prototype),lib$rsvp$promise$hash$$PromiseHash.prototype._superConstructor=lib$rsvp$enumerator$$default,lib$rsvp$promise$hash$$PromiseHash.prototype._init=function(){this._result={}},lib$rsvp$promise$hash$$PromiseHash.prototype._validateInput=function(input){return input&&"object"==typeof input},lib$rsvp$promise$hash$$PromiseHash.prototype._validationError=function(){return new Error("Promise.hash must be called with an object")},lib$rsvp$promise$hash$$PromiseHash.prototype._enumerate=function(){var promise=this.promise,input=this._input,results=[];for(var key in input)promise._state===lib$rsvp$$internal$$PENDING&&Object.prototype.hasOwnProperty.call(input,key)&&results.push({position:key,entry:input[key]});var length=results.length;this._remaining=length;for(var result,i=0;promise._state===lib$rsvp$$internal$$PENDING&&i<length;i++)result=results[i],this._eachEntry(result.entry,result.position)},lib$rsvp$hash$settled$$HashSettled.prototype=lib$rsvp$utils$$o_create(lib$rsvp$promise$hash$$default.prototype),lib$rsvp$hash$settled$$HashSettled.prototype._superConstructor=lib$rsvp$enumerator$$default,lib$rsvp$hash$settled$$HashSettled.prototype._makeResult=lib$rsvp$enumerator$$makeSettledResult,lib$rsvp$hash$settled$$HashSettled.prototype._validationError=function(){return new Error("hashSettled must be called with an object")};var lib$rsvp$hash$settled$$default=lib$rsvp$hash$settled$$hashSettled,lib$rsvp$hash$$default=lib$rsvp$hash$$hash,lib$rsvp$map$$default=lib$rsvp$map$$map,lib$rsvp$node$$ERROR=new lib$rsvp$node$$Result,lib$rsvp$node$$GET_THEN_ERROR=new lib$rsvp$node$$Result,lib$rsvp$node$$default=lib$rsvp$node$$denodeify,lib$rsvp$race$$default=lib$rsvp$race$$race,lib$rsvp$reject$$default=lib$rsvp$reject$$reject,lib$rsvp$resolve$$default=lib$rsvp$resolve$$resolve,lib$rsvp$rethrow$$default=lib$rsvp$rethrow$$rethrow;lib$rsvp$config$$config.async=lib$rsvp$asap$$default;if("undefined"!=typeof window&&"object"==typeof window.__PROMISE_INSTRUMENTATION__){var lib$rsvp$$callbacks=window.__PROMISE_INSTRUMENTATION__;lib$rsvp$config$$configure("instrument",!0);for(var lib$rsvp$$eventName in lib$rsvp$$callbacks)lib$rsvp$$callbacks.hasOwnProperty(lib$rsvp$$eventName)&&lib$rsvp$$on(lib$rsvp$$eventName,lib$rsvp$$callbacks[lib$rsvp$$eventName])}var lib$rsvp$umd$$RSVP={race:lib$rsvp$race$$default,Promise:lib$rsvp$promise$$default,allSettled:lib$rsvp$all$settled$$default,hash:lib$rsvp$hash$$default,hashSettled:lib$rsvp$hash$settled$$default,denodeify:lib$rsvp$node$$default,on:lib$rsvp$$on,off:lib$rsvp$$off,map:lib$rsvp$map$$default,filter:lib$rsvp$filter$$default,resolve:lib$rsvp$resolve$$default,reject:lib$rsvp$reject$$default,all:lib$rsvp$all$$default,rethrow:lib$rsvp$rethrow$$default,defer:lib$rsvp$defer$$default,EventTarget:lib$rsvp$events$$default,configure:lib$rsvp$config$$configure,async:lib$rsvp$$async};"function"==typeof define&&define.amd?define(function(){return lib$rsvp$umd$$RSVP}):"undefined"!=typeof module&&module.exports?module.exports=lib$rsvp$umd$$RSVP:"undefined"!=typeof this&&(this.RSVP=lib$rsvp$umd$$RSVP)}.call(this);var wdCb;!function(wdCb){var MAX_ARRAY_INDEX=Math.pow(2,53)-1,JudgeUtils=function(){function JudgeUtils(){}return JudgeUtils.isArray=function(arr){var length=arr&&arr.length;return"number"==typeof length&&length>=0&&length<=MAX_ARRAY_INDEX},JudgeUtils.isArrayExactly=function(arr){return"[object Array]"===Object.prototype.toString.call(arr)},JudgeUtils.isNumber=function(num){return"number"==typeof num},JudgeUtils.isNumberExactly=function(num){return"[object Number]"===Object.prototype.toString.call(num)},JudgeUtils.isString=function(str){return"string"==typeof str},JudgeUtils.isStringExactly=function(str){return"[object String]"===Object.prototype.toString.call(str)},JudgeUtils.isBoolean=function(bool){return bool===!0||bool===!1||"[boolect Boolean]"===toString.call(bool)},JudgeUtils.isDom=function(obj){return!(!obj||1!==obj.nodeType)},JudgeUtils.isObject=function(obj){var type=typeof obj;return"function"===type||"object"===type&&!!obj},JudgeUtils.isDirectObject=function(obj){return"[object Object]"===Object.prototype.toString.call(obj)},JudgeUtils.isHostMethod=function(object,property){var type=typeof object[property];return"function"===type||"object"===type&&!!object[property]||"unknown"===type},JudgeUtils.isNodeJs=function(){return("undefined"!=typeof global&&global.module||"undefined"!=typeof module)&&"undefined"!=typeof module.exports},JudgeUtils.isFunction=function(func){return!0},JudgeUtils}();wdCb.JudgeUtils=JudgeUtils,"function"!=typeof/./&&"object"!=typeof Int8Array?JudgeUtils.isFunction=function(func){return"function"==typeof func}:JudgeUtils.isFunction=function(func){return"[object Function]"===Object.prototype.toString.call(func)}}(wdCb||(wdCb={}));var wdCb;!function(wdCb){wdCb.JudgeUtils.isNodeJs()?wdCb.root=global:wdCb.root=window}(wdCb||(wdCb={}));var wdCb;!function(wdCb){if("performance"in wdCb.root==!1&&(wdCb.root.performance={}),Date.now=Date.now||function(){return(new Date).getTime()},"now"in wdCb.root.performance==!1){var offset=wdCb.root.performance.timing&&wdCb.root.performance.timing.navigationStart?performance.timing.navigationStart:Date.now();wdCb.root.performance.now=function(){return Date.now()-offset}}}(wdCb||(wdCb={}));var wdCb;!function(wdCb){wdCb.$BREAK={break:!0},wdCb.$REMOVE=void 0}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var Log=function(){function Log(){}return Log.log=function(){for(var messages=[],_i=0;_i<arguments.length;_i++)messages[_i-0]=arguments[_i];this._exec("log",messages)||wdCb.root.alert(messages.join(",")),this._exec("trace",messages)},Log.assert=function(cond){for(var messages=[],_i=1;_i<arguments.length;_i++)messages[_i-1]=arguments[_i];cond&&(this._exec("assert",arguments,1)||this.log.apply(this,Array.prototype.slice.call(arguments,1)))},Log.error=function(cond){for(var message=[],_i=1;_i<arguments.length;_i++)message[_i-1]=arguments[_i];if(cond)throw new Error(Array.prototype.slice.call(arguments,1).join("\n"))},Log.warn=function(){for(var message=[],_i=0;_i<arguments.length;_i++)message[_i-0]=arguments[_i];var result=this._exec("warn",arguments);result?this._exec("trace",["warn trace"]):this.log.apply(this,arguments)},Log._exec=function(consoleMethod,args,sliceBegin){return void 0===sliceBegin&&(sliceBegin=0),!(!wdCb.root.console||!wdCb.root.console[consoleMethod])&&(wdCb.root.console[consoleMethod].apply(wdCb.root.console,Array.prototype.slice.call(args,sliceBegin)),!0)},Log.info={INVALID_PARAM:"invalid parameter",ABSTRACT_ATTRIBUTE:"abstract attribute need override",ABSTRACT_METHOD:"abstract method need override",helperFunc:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var result="";return args.forEach(function(val){result+=String(val)+" "}),result.slice(0,-1)},assertion:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(2===args.length)return this.helperFunc(args[0],args[1]);if(3===args.length)return this.helperFunc(args[1],args[0],args[2]);throw new Error("args.length must <= 3")},FUNC_INVALID:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("invalid"),this.assertion.apply(this,args)},FUNC_MUST:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("must"),this.assertion.apply(this,args)},FUNC_MUST_BE:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("must be"),this.assertion.apply(this,args)},FUNC_MUST_NOT_BE:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("must not be"),this.assertion.apply(this,args)},FUNC_SHOULD:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("should"),this.assertion.apply(this,args)},FUNC_SHOULD_NOT:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("should not"),this.assertion.apply(this,args)},FUNC_SUPPORT:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("support"),this.assertion.apply(this,args)},FUNC_NOT_SUPPORT:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("not support"),this.assertion.apply(this,args)},FUNC_MUST_DEFINE:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("must define"),this.assertion.apply(this,args)},FUNC_MUST_NOT_DEFINE:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("must not define"),this.assertion.apply(this,args)},FUNC_UNKNOW:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("unknow"),this.assertion.apply(this,args)},FUNC_EXPECT:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("expect"),this.assertion.apply(this,args)},FUNC_UNEXPECT:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("unexpect"),this.assertion.apply(this,args)},FUNC_EXIST:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("exist"),this.assertion.apply(this,args)},FUNC_NOT_EXIST:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("not exist"),this.assertion.apply(this,args)},FUNC_ONLY:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("only"),this.assertion.apply(this,args)},FUNC_CAN_NOT:function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return args.unshift("can't"),this.assertion.apply(this,args)}},Log}();wdCb.Log=Log}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var List=function(){function List(){this.children=null}return List.prototype.getCount=function(){return this.children.length},List.prototype.hasChild=function(child){for(var c=null,children=this.children,i=0,len=children.length;i<len;i++){if(c=children[i],child.uid&&c.uid&&child.uid==c.uid)return!0;if(child===c)return!0}return!1},List.prototype.hasChildWithFunc=function(func){for(var i=0,len=this.children.length;i<len;i++)if(func(this.children[i],i))return!0;return!1},List.prototype.getChildren=function(){return this.children},List.prototype.getChild=function(index){return this.children[index]},List.prototype.addChild=function(child){return this.children.push(child),this},List.prototype.addChildren=function(arg){if(wdCb.JudgeUtils.isArray(arg)){var children=arg;this.children=this.children.concat(children)}else if(arg instanceof List){var children=arg;this.children=this.children.concat(children.getChildren())}else{var child=arg;this.addChild(child)}return this},List.prototype.unShiftChild=function(child){this.children.unshift(child)},List.prototype.removeAllChildren=function(){return this.children=[],this},List.prototype.forEach=function(func,context){return this._forEach(this.children,func,context),this},List.prototype.toArray=function(){return this.children},List.prototype.copyChildren=function(){return this.children.slice(0)},List.prototype.removeChildHelper=function(arg){var result=null;if(wdCb.JudgeUtils.isFunction(arg)){var func=arg;result=this._removeChild(this.children,func)}else result=arg.uid?this._removeChild(this.children,function(e){return!!e.uid&&e.uid===arg.uid}):this._removeChild(this.children,function(e){return e===arg});return result},List.prototype._forEach=function(arr,func,context){var scope=context,i=0,len=arr.length;for(i=0;i<len&&func.call(scope,arr[i],i)!==wdCb.$BREAK;i++);},List.prototype._removeChild=function(arr,func){var self=this,removedElementArr=[],remainElementArr=[];return this._forEach(arr,function(e,index){func.call(self,e)?removedElementArr.push(e):remainElementArr.push(e)}),this.children=remainElementArr,removedElementArr},List}();wdCb.List=List}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdCb;!function(wdCb){var Collection=function(_super){function Collection(children){void 0===children&&(children=[]),_super.call(this),this.children=children}return __extends(Collection,_super),Collection.create=function(children){void 0===children&&(children=[]);var obj=new this(children);return obj},Collection.prototype.clone=function(isDeep){return void 0===isDeep&&(isDeep=!1),isDeep?Collection.create(wdCb.ExtendUtils.extendDeep(this.children)):Collection.create().addChildren(this.children)},Collection.prototype.filter=function(func){for(var children=this.children,result=[],value=null,i=0,len=children.length;i<len;i++)value=children[i],func.call(children,value,i)&&result.push(value);return Collection.create(result)},Collection.prototype.findOne=function(func){var scope=this.children,result=null;return this.forEach(function(value,index){if(func.call(scope,value,index))return result=value,wdCb.$BREAK}),result},Collection.prototype.reverse=function(){return Collection.create(this.copyChildren().reverse())},Collection.prototype.removeChild=function(arg){return Collection.create(this.removeChildHelper(arg))},Collection.prototype.sort=function(func,isSortSelf){return void 0===isSortSelf&&(isSortSelf=!1),isSortSelf?(this.children.sort(func),this):Collection.create(this.copyChildren().sort(func))},Collection.prototype.map=function(func){var resultArr=[];return this.forEach(function(e,index){var result=func(e,index);result!==wdCb.$REMOVE&&resultArr.push(result)}),Collection.create(resultArr)},Collection.prototype.removeRepeatItems=function(){var noRepeatList=Collection.create();return this.forEach(function(item){noRepeatList.hasChild(item)||noRepeatList.addChild(item)}),noRepeatList},Collection.prototype.hasRepeatItems=function(){var noRepeatList=Collection.create(),hasRepeat=!1;return this.forEach(function(item){return noRepeatList.hasChild(item)?(hasRepeat=!0,wdCb.$BREAK):void noRepeatList.addChild(item)}),hasRepeat},Collection}(wdCb.List);wdCb.Collection=Collection}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var Hash=function(){function Hash(children){void 0===children&&(children={}),this._children=null,this._children=children}return Hash.create=function(children){void 0===children&&(children={});var obj=new this(children);return obj},Hash.prototype.getChildren=function(){return this._children},Hash.prototype.getCount=function(){var result=0,children=this._children,key=null;for(key in children)children.hasOwnProperty(key)&&result++;return result},Hash.prototype.getKeys=function(){var result=wdCb.Collection.create(),children=this._children,key=null;for(key in children)children.hasOwnProperty(key)&&result.addChild(key);return result},Hash.prototype.getValues=function(){var result=wdCb.Collection.create(),children=this._children,key=null;for(key in children)children.hasOwnProperty(key)&&result.addChild(children[key]);return result},Hash.prototype.getChild=function(key){return this._children[key]},Hash.prototype.setValue=function(key,value){return this._children[key]=value,this},Hash.prototype.addChild=function(key,value){return this._children[key]=value,this},Hash.prototype.addChildren=function(arg){
var i=null,children=null;children=arg instanceof Hash?arg.getChildren():arg;for(i in children)children.hasOwnProperty(i)&&this.addChild(i,children[i]);return this},Hash.prototype.appendChild=function(key,value){if(this._children[key]instanceof wdCb.Collection){var c=this._children[key];c.addChild(value)}else this._children[key]=wdCb.Collection.create().addChild(value);return this},Hash.prototype.removeChild=function(arg){var result=[];if(wdCb.JudgeUtils.isString(arg)){var key=arg;result.push(this._children[key]),this._children[key]=void 0,delete this._children[key]}else if(wdCb.JudgeUtils.isFunction(arg)){var func=arg,self_1=this;this.forEach(function(val,key){func(val,key)&&(result.push(self_1._children[key]),self_1._children[key]=void 0,delete self_1._children[key])})}return wdCb.Collection.create(result)},Hash.prototype.removeAllChildren=function(){this._children={}},Hash.prototype.hasChild=function(key){return void 0!==this._children[key]},Hash.prototype.hasChildWithFunc=function(func){var result=!1;return this.forEach(function(val,key){if(func(val,key))return result=!0,wdCb.$BREAK}),result},Hash.prototype.forEach=function(func,context){var children=this._children;for(var i in children)if(children.hasOwnProperty(i)&&func.call(context,children[i],i)===wdCb.$BREAK)break;return this},Hash.prototype.filter=function(func){var result={},children=this._children,value=null;for(var key in children)children.hasOwnProperty(key)&&(value=children[key],func.call(children,value,key)&&(result[key]=value));return Hash.create(result)},Hash.prototype.findOne=function(func){var result=[],self=this,scope=this._children;return this.forEach(function(val,key){if(func.call(scope,val,key))return result=[key,self.getChild(key)],wdCb.$BREAK}),result},Hash.prototype.map=function(func){var resultMap={};return this.forEach(function(val,key){var result=func(val,key);result!==wdCb.$REMOVE&&(wdCb.Log.error(!wdCb.JudgeUtils.isArray(result)||2!==result.length,wdCb.Log.info.FUNC_MUST_BE("iterator","[key, value]")),resultMap[result[0]]=result[1])}),Hash.create(resultMap)},Hash.prototype.toCollection=function(){var result=wdCb.Collection.create();return this.forEach(function(val,key){val instanceof wdCb.Collection?result.addChildren(val):result.addChild(val)}),result},Hash.prototype.toArray=function(){var result=[];return this.forEach(function(val,key){val instanceof wdCb.Collection?result=result.concat(val.getChildren()):result.push(val)}),result},Hash.prototype.clone=function(isDeep){return void 0===isDeep&&(isDeep=!1),isDeep?Hash.create(wdCb.ExtendUtils.extendDeep(this._children)):Hash.create().addChildren(this._children)},Hash}();wdCb.Hash=Hash}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdCb;!function(wdCb){var Queue=function(_super){function Queue(children){void 0===children&&(children=[]),_super.call(this),this.children=children}return __extends(Queue,_super),Queue.create=function(children){void 0===children&&(children=[]);var obj=new this(children);return obj},Object.defineProperty(Queue.prototype,"front",{get:function(){return this.children[this.children.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(Queue.prototype,"rear",{get:function(){return this.children[0]},enumerable:!0,configurable:!0}),Queue.prototype.push=function(element){this.children.unshift(element)},Queue.prototype.pop=function(){return this.children.pop()},Queue.prototype.clear=function(){this.removeAllChildren()},Queue}(wdCb.List);wdCb.Queue=Queue}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdCb;!function(wdCb){var Stack=function(_super){function Stack(children){void 0===children&&(children=[]),_super.call(this),this.children=children}return __extends(Stack,_super),Stack.create=function(children){void 0===children&&(children=[]);var obj=new this(children);return obj},Object.defineProperty(Stack.prototype,"top",{get:function(){return this.children[this.children.length-1]},enumerable:!0,configurable:!0}),Stack.prototype.push=function(element){this.children.push(element)},Stack.prototype.pop=function(){return this.children.pop()},Stack.prototype.clear=function(){this.removeAllChildren()},Stack.prototype.clone=function(isDeep){return void 0===isDeep&&(isDeep=!1),isDeep?Stack.create(wdCb.ExtendUtils.extendDeep(this.children)):Stack.create([].concat(this.children))},Stack}(wdCb.List);wdCb.Stack=Stack}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var AjaxUtils=function(){function AjaxUtils(){}return AjaxUtils.ajax=function(conf){var type=conf.type,url=conf.url,data=conf.data,dataType=conf.dataType,success=conf.success,error=conf.error,xhr=null,self=this;if(null===type&&(type="get"),null===dataType&&(dataType="text"),xhr=this._createAjax(error))try{xhr.open(type,url,!0),this._isSoundFile(dataType)&&(xhr.responseType="arraybuffer"),"GET"===type||"get"===type?xhr.send(null):"POST"!==type&&"post"!==type||(xhr.setRequestHeader("content-type","application/x-www-form-urlencoded"),xhr.send(data)),xhr.onreadystatechange=function(){4!==xhr.readyState||200!==xhr.status&&!self._isLocalFile(xhr.status)||("text"===dataType||"TEXT"===dataType?null!==success&&success(xhr.responseText):"xml"===dataType||"XML"===dataType?null!==success&&success(xhr.responseXML):"json"===dataType||"JSON"===dataType?null!==success&&success(eval("("+xhr.responseText+")")):self._isSoundFile(dataType)&&null!==success&&success(xhr.response))}}catch(e){error(xhr,e)}},AjaxUtils._createAjax=function(error){var xhr=null;try{xhr=new ActiveXObject("microsoft.xmlhttp")}catch(e1){try{xhr=new XMLHttpRequest}catch(e2){return error(xhr,{message:"ajax"}),null}}return xhr},AjaxUtils._isLocalFile=function(status){return document.URL.contain("file://")&&0===status},AjaxUtils._isSoundFile=function(dataType){return"arraybuffer"===dataType},AjaxUtils}();wdCb.AjaxUtils=AjaxUtils}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var ArrayUtils=function(){function ArrayUtils(){}return ArrayUtils.removeRepeatItems=function(arr,isEqual){void 0===isEqual&&(isEqual=function(a,b){return a===b});var resultArr=[],self=this;return arr.forEach(function(ele){self.contain(resultArr,function(val){return isEqual(val,ele)})||resultArr.push(ele)}),resultArr},ArrayUtils.contain=function(arr,ele){if(wdCb.JudgeUtils.isFunction(ele))for(var func=ele,i=0,len=arr.length;i<len;i++){var value=arr[i];if(func.call(null,value,i))return!0}else for(var i=0,len=arr.length;i<len;i++){var value=arr[i];if(ele===value||value.contain&&value.contain(ele))return!0}return!1},ArrayUtils}();wdCb.ArrayUtils=ArrayUtils}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var ConvertUtils=function(){function ConvertUtils(){}return ConvertUtils.toString=function(obj){return wdCb.JudgeUtils.isNumber(obj)?String(obj):wdCb.JudgeUtils.isFunction(obj)?this._convertCodeToString(obj):wdCb.JudgeUtils.isDirectObject(obj)||wdCb.JudgeUtils.isArray(obj)?JSON.stringify(obj):String(obj)},ConvertUtils._convertCodeToString=function(fn){return fn.toString().split("\n").slice(1,-1).join("\n")+"\n"},ConvertUtils}();wdCb.ConvertUtils=ConvertUtils}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var EventUtils=function(){function EventUtils(){}return EventUtils.bindEvent=function(context,func){return function(event){return func.call(context,event)}},EventUtils.addEvent=function(dom,eventName,handler){wdCb.JudgeUtils.isHostMethod(dom,"addEventListener")?dom.addEventListener(eventName,handler,!1):wdCb.JudgeUtils.isHostMethod(dom,"attachEvent")?dom.attachEvent("on"+eventName,handler):dom["on"+eventName]=handler},EventUtils.removeEvent=function(dom,eventName,handler){wdCb.JudgeUtils.isHostMethod(dom,"removeEventListener")?dom.removeEventListener(eventName,handler,!1):wdCb.JudgeUtils.isHostMethod(dom,"detachEvent")?dom.detachEvent("on"+eventName,handler):dom["on"+eventName]=null},EventUtils}();wdCb.EventUtils=EventUtils}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var ExtendUtils=function(){function ExtendUtils(){}return ExtendUtils.extendDeep=function(parent,child,filter){void 0===filter&&(filter=function(val,i){return!0});var i=null,len=0,toStr=Object.prototype.toString,sArr="[object Array]",sOb="[object Object]",type="",_child=null;if(toStr.call(parent)===sArr)for(_child=child||[],i=0,len=parent.length;i<len;i++){var member=parent[i];filter(member,i)&&(member.clone?_child[i]=member.clone():(type=toStr.call(member),type===sArr||type===sOb?(_child[i]=type===sArr?[]:{},arguments.callee(member,_child[i])):_child[i]=member))}else if(toStr.call(parent)===sOb){_child=child||{};for(i in parent){var member=parent[i];filter(member,i)&&(member.clone?_child[i]=member.clone():(type=toStr.call(member),type===sArr||type===sOb?(_child[i]=type===sArr?[]:{},arguments.callee(member,_child[i])):_child[i]=member))}}else _child=parent;return _child},ExtendUtils.extend=function(destination,source){var property="";for(property in source)destination[property]=source[property];return destination},ExtendUtils.copyPublicAttri=function(source){var destination={};return this.extendDeep(source,destination,function(item,property){return"_"!==property.slice(0,1)&&!wdCb.JudgeUtils.isFunction(item)}),destination},ExtendUtils}();wdCb.ExtendUtils=ExtendUtils}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var SPLITPATH_REGEX=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,PathUtils=function(){function PathUtils(){}return PathUtils.basename=function(path,ext){var f=this._splitPath(path)[2];return ext&&f.substr(-1*ext.length)===ext&&(f=f.substr(0,f.length-ext.length)),f},PathUtils.changeExtname=function(pathStr,extname){var extname=extname||"",index=pathStr.indexOf("?"),tempStr="";return index>0&&(tempStr=pathStr.substring(index),pathStr=pathStr.substring(0,index)),index=pathStr.lastIndexOf("."),index<0?pathStr+extname+tempStr:pathStr.substring(0,index)+extname+tempStr},PathUtils.changeBasename=function(pathStr,basename,isSameExt){void 0===isSameExt&&(isSameExt=!1);var index=null,tempStr=null,ext=null;return 0==basename.indexOf(".")?this.changeExtname(pathStr,basename):(index=pathStr.indexOf("?"),tempStr="",ext=isSameExt?this.extname(pathStr):"",index>0&&(tempStr=pathStr.substring(index),pathStr=pathStr.substring(0,index)),index=pathStr.lastIndexOf("/"),index=index<=0?0:index+1,pathStr.substring(0,index)+basename+ext+tempStr)},PathUtils.extname=function(path){return this._splitPath(path)[3]},PathUtils.dirname=function(path){var result=this._splitPath(path),root=result[0],dir=result[1];return root||dir?(dir&&(dir=dir.substr(0,dir.length-1)),root+dir):"."},PathUtils._splitPath=function(fileName){return SPLITPATH_REGEX.exec(fileName).slice(1)},PathUtils}();wdCb.PathUtils=PathUtils}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var FunctionUtils=function(){function FunctionUtils(){}return FunctionUtils.bind=function(object,func){return function(){return func.apply(object,arguments)}},FunctionUtils}();wdCb.FunctionUtils=FunctionUtils}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var DomQuery=function(){function DomQuery(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return this._doms=null,wdCb.JudgeUtils.isDom(args[0])?this._doms=[args[0]]:this._isDomEleStr(args[0])?this._doms=[this._buildDom(args[0])]:this._doms=document.querySelectorAll(args[0]),this}return DomQuery.create=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var obj=new this(args[0]);return obj},DomQuery.prototype.get=function(index){return this._doms[index]},DomQuery.prototype.prepend=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var targetDom=null;targetDom=this._buildDom(args[0]);for(var _a=0,_b=this._doms;_a<_b.length;_a++){var dom=_b[_a];1===dom.nodeType&&dom.insertBefore(targetDom,dom.firstChild)}return this},DomQuery.prototype.prependTo=function(eleStr){var targetDom=null;targetDom=DomQuery.create(eleStr);for(var _i=0,_a=this._doms;_i<_a.length;_i++){var dom=_a[_i];1===dom.nodeType&&targetDom.prepend(dom)}return this},DomQuery.prototype.remove=function(){for(var _i=0,_a=this._doms;_i<_a.length;_i++){var dom=_a[_i];dom&&dom.parentNode&&"BODY"!=dom.tagName&&dom.parentNode.removeChild(dom)}return this},DomQuery.prototype.css=function(property,value){for(var _i=0,_a=this._doms;_i<_a.length;_i++){var dom=_a[_i];dom.style[property]=value}},DomQuery.prototype.attr=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(1===args.length){var name_1=args[0];return this.get(0).getAttribute(name_1)}for(var name_2=args[0],value=args[1],_a=0,_b=this._doms;_a<_b.length;_a++){var dom=_b[_a];dom.setAttribute(name_2,value)}},DomQuery.prototype._isDomEleStr=function(eleStr){return null!==eleStr.match(/<(\w+)[^>]*><\/\1>/)},DomQuery.prototype._buildDom=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(wdCb.JudgeUtils.isString(args[0])){var div=this._createElement("div"),eleStr=args[0];return div.innerHTML=eleStr,div.firstChild}return args[0]},DomQuery.prototype._createElement=function(eleStr){return document.createElement(eleStr)},DomQuery}();wdCb.DomQuery=DomQuery}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var JudgeUtils=function(_super){function JudgeUtils(){_super.apply(this,arguments)}return __extends(JudgeUtils,_super),JudgeUtils.isPromise=function(obj){return!!obj&&!_super.isFunction.call(this,obj.subscribe)&&_super.isFunction.call(this,obj.then)},JudgeUtils.isEqual=function(ob1,ob2){return ob1.uid===ob2.uid},JudgeUtils.isIObserver=function(i){return i.next&&i.error&&i.completed},JudgeUtils}(wdCb.JudgeUtils);wdFrp.JudgeUtils=JudgeUtils}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){wdFrp.fromNodeCallback=function(func,context){return function(){for(var funcArgs=[],_i=0;_i<arguments.length;_i++)funcArgs[_i-0]=arguments[_i];return wdFrp.createStream(function(observer){var hander=function(err){for(var args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];return err?void observer.error(err):(args.length<=1?observer.next.apply(observer,args):observer.next(args),void observer.completed())};funcArgs.push(hander),func.apply(context,funcArgs)})}},wdFrp.fromStream=function(stream,finishEventName){return void 0===finishEventName&&(finishEventName="end"),stream.pause(),wdFrp.createStream(function(observer){var dataHandler=function(data){observer.next(data)},errorHandler=function(err){observer.error(err)},endHandler=function(){observer.completed()};return stream.addListener("data",dataHandler),stream.addListener("error",errorHandler),stream.addListener(finishEventName,endHandler),stream.resume(),function(){stream.removeListener("data",dataHandler),stream.removeListener("error",errorHandler),stream.removeListener(finishEventName,endHandler)}})},wdFrp.fromReadableStream=function(stream){return wdFrp.fromStream(stream,"end")},wdFrp.fromWritableStream=function(stream){return wdFrp.fromStream(stream,"finish")},wdFrp.fromTransformStream=function(stream){return wdFrp.fromStream(stream,"finish")}}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){var Entity=function(){function Entity(uidPre){this._uid=null,this._uid=uidPre+String(Entity.UID++)}return Object.defineProperty(Entity.prototype,"uid",{get:function(){return this._uid},set:function(uid){this._uid=uid},enumerable:!0,configurable:!0}),Entity.UID=1,Entity}();wdFrp.Entity=Entity}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){var Main=function(){function Main(){}return Main.isTest=!1,Main}();wdFrp.Main=Main}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){function assert(cond,message){void 0===message&&(message="contract error"),Log.error(!cond,message)}function require(InFunc){return function(target,name,descriptor){var value=descriptor.value;return descriptor.value=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return wdFrp.Main.isTest&&InFunc.apply(this,args),value.apply(this,args)},descriptor}}function ensure(OutFunc){return function(target,name,descriptor){var value=descriptor.value;return descriptor.value=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var result=value.apply(this,args),params=[result].concat(args);return wdFrp.Main.isTest&&OutFunc.apply(this,params),result},descriptor}}function requireGetter(InFunc){return function(target,name,descriptor){var getter=descriptor.get;return descriptor.get=function(){return wdFrp.Main.isTest&&InFunc.call(this),getter.call(this)},descriptor}}function requireSetter(InFunc){return function(target,name,descriptor){var setter=descriptor.set;return descriptor.set=function(val){wdFrp.Main.isTest&&InFunc.call(this,val),setter.call(this,val)},descriptor}}function ensureGetter(OutFunc){return function(target,name,descriptor){var getter=descriptor.get;return descriptor.get=function(){var result=getter.call(this);return wdFrp.Main.isTest&&OutFunc.call(this,result),result},descriptor}}function ensureSetter(OutFunc){return function(target,name,descriptor){var setter=descriptor.set;return descriptor.set=function(val){var result=setter.call(this,val),params=[result,val];wdFrp.Main.isTest&&OutFunc.apply(this,params)},descriptor}}function invariant(func){return function(target){wdFrp.Main.isTest&&func(target)}}var Log=wdCb.Log;wdFrp.assert=assert,wdFrp.require=require,wdFrp.ensure=ensure,wdFrp.requireGetter=requireGetter,wdFrp.requireSetter=requireSetter,wdFrp.ensureGetter=ensureGetter,wdFrp.ensureSetter=ensureSetter,wdFrp.invariant=invariant}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var SingleDisposable=function(_super){function SingleDisposable(disposeHandler){_super.call(this,"SingleDisposable"),this._disposeHandler=null,this._disposeHandler=disposeHandler}return __extends(SingleDisposable,_super),SingleDisposable.create=function(disposeHandler){void 0===disposeHandler&&(disposeHandler=function(){});var obj=new this(disposeHandler);return obj},SingleDisposable.prototype.setDisposeHandler=function(handler){this._disposeHandler=handler},SingleDisposable.prototype.dispose=function(){this._disposeHandler()},SingleDisposable}(wdFrp.Entity);wdFrp.SingleDisposable=SingleDisposable}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var GroupDisposable=function(_super){function GroupDisposable(disposable){_super.call(this,"GroupDisposable"),this._group=wdCb.Collection.create(),disposable&&this._group.addChild(disposable)}return __extends(GroupDisposable,_super),GroupDisposable.create=function(disposable){var obj=new this(disposable);return obj},GroupDisposable.prototype.add=function(disposable){return this._group.addChild(disposable),this},GroupDisposable.prototype.remove=function(disposable){return this._group.removeChild(disposable),this},GroupDisposable.prototype.dispose=function(){this._group.forEach(function(disposable){disposable.dispose()})},GroupDisposable}(wdFrp.Entity);wdFrp.GroupDisposable=GroupDisposable}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){var InnerSubscription=function(){function InnerSubscription(subject,observer){this._subject=null,this._observer=null,this._subject=subject,this._observer=observer}return InnerSubscription.create=function(subject,observer){var obj=new this(subject,observer);return obj},InnerSubscription.prototype.dispose=function(){this._subject.remove(this._observer),this._observer.dispose()},InnerSubscription}();wdFrp.InnerSubscription=InnerSubscription}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){var InnerSubscriptionGroup=function(){function InnerSubscriptionGroup(){this._container=wdCb.Collection.create()}return InnerSubscriptionGroup.create=function(){var obj=new this;return obj},InnerSubscriptionGroup.prototype.addChild=function(child){this._container.addChild(child)},InnerSubscriptionGroup.prototype.dispose=function(){this._container.forEach(function(child){child.dispose()})},InnerSubscriptionGroup}();wdFrp.InnerSubscriptionGroup=InnerSubscriptionGroup}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){wdFrp.JudgeUtils.isNodeJs()?wdFrp.root=global:wdFrp.root=window}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){wdFrp.ABSTRACT_ATTRIBUTE=null}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){wdFrp.root.RSVP&&(wdFrp.root.RSVP.onerror=function(e){throw e},wdFrp.root.RSVP.on("error",wdFrp.root.RSVP.onerror))}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){wdFrp.root.requestNextAnimationFrame=function(){var originalRequestAnimationFrame=void 0,wrapper=void 0,geckoVersion=null,userAgent=wdFrp.root.navigator&&wdFrp.root.navigator.userAgent,index=0,self=this;return wrapper=function(time){time=wdFrp.root.performance.now(),self.callback(time)},wdFrp.root.requestAnimationFrame?requestAnimationFrame:(wdFrp.root.webkitRequestAnimationFrame&&(originalRequestAnimationFrame=wdFrp.root.webkitRequestAnimationFrame,wdFrp.root.webkitRequestAnimationFrame=function(callback,element){return self.callback=callback,originalRequestAnimationFrame(wrapper,element)}),wdFrp.root.msRequestAnimationFrame&&(originalRequestAnimationFrame=wdFrp.root.msRequestAnimationFrame,wdFrp.root.msRequestAnimationFrame=function(callback){return self.callback=callback,originalRequestAnimationFrame(wrapper)}),wdFrp.root.mozRequestAnimationFrame&&(index=userAgent.indexOf("rv:"),userAgent.indexOf("Gecko")!=-1&&(geckoVersion=userAgent.substr(index+3,3),"2.0"===geckoVersion&&(wdFrp.root.mozRequestAnimationFrame=void 0))),wdFrp.root.webkitRequestAnimationFrame||wdFrp.root.mozRequestAnimationFrame||wdFrp.root.oRequestAnimationFrame||wdFrp.root.msRequestAnimationFrame||function(callback,element){var start,finish;wdFrp.root.setTimeout(function(){start=wdFrp.root.performance.now(),callback(start),finish=wdFrp.root.performance.now(),self.timeout=1e3/60-(finish-start)},self.timeout)})}(),wdFrp.root.cancelNextRequestAnimationFrame=wdFrp.root.cancelRequestAnimationFrame||wdFrp.root.webkitCancelAnimationFrame||wdFrp.root.webkitCancelRequestAnimationFrame||wdFrp.root.mozCancelRequestAnimationFrame||wdFrp.root.oCancelRequestAnimationFrame||wdFrp.root.msCancelRequestAnimationFrame||clearTimeout}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},__decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},wdFrp;!function(wdFrp){var Log=wdCb.Log,Stream=function(_super){function Stream(subscribeFunc){_super.call(this,"Stream"),this.scheduler=wdFrp.ABSTRACT_ATTRIBUTE,this.subscribeFunc=null,this.subscribeFunc=subscribeFunc||function(){}}return __extends(Stream,_super),Stream.prototype.buildStream=function(observer){return wdFrp.SingleDisposable.create(this.subscribeFunc(observer)||function(){})},Stream.prototype.do=function(onNext,onError,onCompleted){return wdFrp.DoStream.create(this,onNext,onError,onCompleted)},Stream.prototype.map=function(selector){return wdFrp.MapStream.create(this,selector)},Stream.prototype.flatMap=function(selector){return this.map(selector).mergeAll()},Stream.prototype.concatMap=function(selector){return this.map(selector).concatAll()},Stream.prototype.mergeAll=function(){return wdFrp.MergeAllStream.create(this)},Stream.prototype.concatAll=function(){return this.merge(1)},Stream.prototype.takeUntil=function(otherStream){return wdFrp.TakeUntilStream.create(this,otherStream)},Stream.prototype.take=function(count){void 0===count&&(count=1);var self=this;return 0===count?wdFrp.empty():wdFrp.createStream(function(observer){self.subscribe(function(value){count>0&&observer.next(value),count--,count<=0&&observer.completed()},function(e){observer.error(e)},function(){observer.completed()})})},Stream.prototype.takeLast=function(count){void 0===count&&(count=1);var self=this;return 0===count?wdFrp.empty():wdFrp.createStream(function(observer){var queue=[];self.subscribe(function(value){queue.push(value),queue.length>count&&queue.shift()},function(e){observer.error(e)},function(){for(;queue.length>0;)observer.next(queue.shift());observer.completed()})})},Stream.prototype.takeWhile=function(predicate,thisArg){void 0===thisArg&&(thisArg=this);var self=this,bindPredicate=null;return bindPredicate=wdCb.FunctionUtils.bind(thisArg,predicate),wdFrp.createStream(function(observer){var i=0,isStart=!1;self.subscribe(function(value){if(bindPredicate(value,i++,self))try{observer.next(value),isStart=!0}catch(e){return void observer.error(e)}else isStart&&observer.completed()},function(e){observer.error(e)},function(){observer.completed()})})},Stream.prototype.lastOrDefault=function(defaultValue){void 0===defaultValue&&(defaultValue=null);var self=this;return wdFrp.createStream(function(observer){var queue=[];self.subscribe(function(value){queue.push(value),queue.length>1&&queue.shift()},function(e){observer.error(e)},function(){if(0===queue.length)observer.next(defaultValue);else for(;queue.length>0;)observer.next(queue.shift());observer.completed()})})},Stream.prototype.filter=function(predicate,thisArg){if(void 0===thisArg&&(thisArg=this),this instanceof wdFrp.FilterStream){var self_1=this;return self_1.internalFilter(predicate,thisArg)}return wdFrp.FilterStream.create(this,predicate,thisArg)},Stream.prototype.filterWithState=function(predicate,thisArg){if(void 0===thisArg&&(thisArg=this),this instanceof wdFrp.FilterStream){var self_2=this;return self_2.internalFilter(predicate,thisArg)}return wdFrp.FilterWithStateStream.create(this,predicate,thisArg)},Stream.prototype.concat=function(){var args=null;return args=wdFrp.JudgeUtils.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments,0),args.unshift(this),wdFrp.ConcatStream.create(args)},Stream.prototype.merge=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(wdFrp.JudgeUtils.isNumber(args[0])){var maxConcurrent=args[0];return wdFrp.MergeStream.create(this,maxConcurrent)}wdFrp.JudgeUtils.isArray(args[0])&&(args=arguments[0]);var stream=null;return args.unshift(this),stream=wdFrp.fromArray(args).mergeAll()},Stream.prototype.repeat=function(count){return void 0===count&&(count=-1),wdFrp.RepeatStream.create(this,count)},Stream.prototype.ignoreElements=function(){return wdFrp.IgnoreElementsStream.create(this)},Stream.prototype.handleSubject=function(subject){return!!this._isSubject(subject)&&(this._setSubject(subject),!0)},Stream.prototype._isSubject=function(subject){return subject instanceof wdFrp.Subject},Stream.prototype._setSubject=function(subject){subject.source=this},__decorate([wdFrp.require(function(count){void 0===count&&(count=1),wdFrp.assert(count>=0,Log.info.FUNC_SHOULD("count",">= 0"))})],Stream.prototype,"take",null),__decorate([wdFrp.require(function(count){void 0===count&&(count=1),wdFrp.assert(count>=0,Log.info.FUNC_SHOULD("count",">= 0"))})],Stream.prototype,"takeLast",null),Stream}(wdFrp.Entity);wdFrp.Stream=Stream}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){var Scheduler=function(){function Scheduler(){this._requestLoopId=null}return Scheduler.create=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var obj=new this;return obj},Object.defineProperty(Scheduler.prototype,"requestLoopId",{get:function(){return this._requestLoopId},set:function(requestLoopId){this._requestLoopId=requestLoopId},enumerable:!0,configurable:!0}),Scheduler.prototype.publishRecursive=function(observer,initial,action){action(initial)},Scheduler.prototype.publishInterval=function(observer,initial,interval,action){return wdFrp.root.setInterval(function(){initial=action(initial)},interval)},Scheduler.prototype.publishIntervalRequest=function(observer,action){var self=this,loop=function(time){var isEnd=action(time);isEnd||(self._requestLoopId=wdFrp.root.requestNextAnimationFrame(loop))};this._requestLoopId=wdFrp.root.requestNextAnimationFrame(loop)},Scheduler.prototype.publishTimeout=function(observer,time,action){return wdFrp.root.setTimeout(function(){action(time),observer.completed()},time)},Scheduler}();wdFrp.Scheduler=Scheduler}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var Observer=function(_super){function Observer(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(_super.call(this,"Observer"),this._isDisposed=null,this.onUserNext=null,this.onUserError=null,this.onUserCompleted=null,this._isStop=!1,this._disposable=null,1===args.length){var observer=args[0];this.onUserNext=function(v){observer.next(v)},this.onUserError=function(e){observer.error(e)},this.onUserCompleted=function(){observer.completed()}}else{var onNext=args[0],onError=args[1],onCompleted=args[2];this.onUserNext=onNext||function(v){},this.onUserError=onError||function(e){throw e},this.onUserCompleted=onCompleted||function(){}}}return __extends(Observer,_super),Object.defineProperty(Observer.prototype,"isDisposed",{get:function(){return this._isDisposed},set:function(isDisposed){this._isDisposed=isDisposed},enumerable:!0,configurable:!0}),Observer.prototype.next=function(value){if(!this._isStop)return this.onNext(value)},Observer.prototype.error=function(error){this._isStop||(this._isStop=!0,this.onError(error))},Observer.prototype.completed=function(){this._isStop||(this._isStop=!0,this.onCompleted())},Observer.prototype.dispose=function(){this._isStop=!0,this._isDisposed=!0,this._disposable&&this._disposable.dispose()},Observer.prototype.setDisposable=function(disposable){this._disposable=disposable},Observer}(wdFrp.Entity);wdFrp.Observer=Observer}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){var Subject=function(){function Subject(){this._source=null,this._observer=new wdFrp.SubjectObserver}return Subject.create=function(){var obj=new this;return obj},Object.defineProperty(Subject.prototype,"source",{get:function(){return this._source},set:function(source){this._source=source},enumerable:!0,configurable:!0}),Subject.prototype.subscribe=function(arg1,onError,onCompleted){var observer=arg1 instanceof wdFrp.Observer?arg1:wdFrp.AutoDetachObserver.create(arg1,onError,onCompleted);return this._observer.addChild(observer),wdFrp.InnerSubscription.create(this,observer)},Subject.prototype.next=function(value){this._observer.next(value)},Subject.prototype.error=function(error){this._observer.error(error)},Subject.prototype.completed=function(){this._observer.completed()},Subject.prototype.start=function(){this._source&&this._observer.setDisposable(this._source.buildStream(this))},Subject.prototype.remove=function(observer){this._observer.removeChild(observer)},Subject.prototype.dispose=function(){this._observer.dispose()},Subject}();wdFrp.Subject=Subject}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);
d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var GeneratorSubject=function(_super){function GeneratorSubject(){_super.call(this,"GeneratorSubject"),this._isStart=!1,this.observer=new wdFrp.SubjectObserver}return __extends(GeneratorSubject,_super),GeneratorSubject.create=function(){var obj=new this;return obj},Object.defineProperty(GeneratorSubject.prototype,"isStart",{get:function(){return this._isStart},set:function(isStart){this._isStart=isStart},enumerable:!0,configurable:!0}),GeneratorSubject.prototype.onBeforeNext=function(value){},GeneratorSubject.prototype.onAfterNext=function(value){},GeneratorSubject.prototype.onIsCompleted=function(value){return!1},GeneratorSubject.prototype.onBeforeError=function(error){},GeneratorSubject.prototype.onAfterError=function(error){},GeneratorSubject.prototype.onBeforeCompleted=function(){},GeneratorSubject.prototype.onAfterCompleted=function(){},GeneratorSubject.prototype.subscribe=function(arg1,onError,onCompleted){var observer=arg1 instanceof wdFrp.Observer?arg1:wdFrp.AutoDetachObserver.create(arg1,onError,onCompleted);return this.observer.addChild(observer),wdFrp.InnerSubscription.create(this,observer)},GeneratorSubject.prototype.next=function(value){if(this._isStart&&!this.observer.isEmpty())try{this.onBeforeNext(value),this.observer.next(value),this.onAfterNext(value),this.onIsCompleted(value)&&this.completed()}catch(e){this.error(e)}},GeneratorSubject.prototype.error=function(error){this._isStart&&!this.observer.isEmpty()&&(this.onBeforeError(error),this.observer.error(error),this.onAfterError(error))},GeneratorSubject.prototype.completed=function(){this._isStart&&!this.observer.isEmpty()&&(this.onBeforeCompleted(),this.observer.completed(),this.onAfterCompleted())},GeneratorSubject.prototype.toStream=function(){var self=this,stream=null;return stream=wdFrp.AnonymousStream.create(function(observer){self.subscribe(observer)})},GeneratorSubject.prototype.start=function(){var self=this;this._isStart=!0,this.observer.setDisposable(wdFrp.SingleDisposable.create(function(){self.dispose()}))},GeneratorSubject.prototype.stop=function(){this._isStart=!1},GeneratorSubject.prototype.remove=function(observer){this.observer.removeChild(observer)},GeneratorSubject.prototype.dispose=function(){this.observer.dispose()},GeneratorSubject}(wdFrp.Entity);wdFrp.GeneratorSubject=GeneratorSubject}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var AnonymousObserver=function(_super){function AnonymousObserver(){_super.apply(this,arguments)}return __extends(AnonymousObserver,_super),AnonymousObserver.create=function(onNext,onError,onCompleted){return new this(onNext,onError,onCompleted)},AnonymousObserver.prototype.onNext=function(value){this.onUserNext(value)},AnonymousObserver.prototype.onError=function(error){this.onUserError(error)},AnonymousObserver.prototype.onCompleted=function(){this.onUserCompleted()},AnonymousObserver}(wdFrp.Observer);wdFrp.AnonymousObserver=AnonymousObserver}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var AutoDetachObserver=function(_super){function AutoDetachObserver(){_super.apply(this,arguments)}return __extends(AutoDetachObserver,_super),AutoDetachObserver.create=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return 1===args.length?new this(args[0]):new this(args[0],args[1],args[2])},AutoDetachObserver.prototype.dispose=function(){return this.isDisposed?void wdCb.Log.log("only can dispose once"):void _super.prototype.dispose.call(this)},AutoDetachObserver.prototype.onNext=function(value){try{this.onUserNext(value)}catch(e){this.onError(e)}},AutoDetachObserver.prototype.onError=function(error){try{this.onUserError(error)}catch(e){throw e}finally{this.dispose()}},AutoDetachObserver.prototype.onCompleted=function(){try{this.onUserCompleted(),this.dispose()}catch(e){throw e}},AutoDetachObserver}(wdFrp.Observer);wdFrp.AutoDetachObserver=AutoDetachObserver}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var MapObserver=function(_super){function MapObserver(currentObserver,selector){_super.call(this,null,null,null),this._currentObserver=null,this._selector=null,this._currentObserver=currentObserver,this._selector=selector}return __extends(MapObserver,_super),MapObserver.create=function(currentObserver,selector){return new this(currentObserver,selector)},MapObserver.prototype.onNext=function(value){var result=null;try{result=this._selector(value)}catch(e){this._currentObserver.error(e)}finally{this._currentObserver.next(result)}},MapObserver.prototype.onError=function(error){this._currentObserver.error(error)},MapObserver.prototype.onCompleted=function(){this._currentObserver.completed()},MapObserver}(wdFrp.Observer);wdFrp.MapObserver=MapObserver}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var DoObserver=function(_super){function DoObserver(currentObserver,prevObserver){_super.call(this,null,null,null),this._currentObserver=null,this._prevObserver=null,this._currentObserver=currentObserver,this._prevObserver=prevObserver}return __extends(DoObserver,_super),DoObserver.create=function(currentObserver,prevObserver){return new this(currentObserver,prevObserver)},DoObserver.prototype.onNext=function(value){try{this._prevObserver.next(value)}catch(e){this._prevObserver.error(e),this._currentObserver.error(e)}finally{this._currentObserver.next(value)}},DoObserver.prototype.onError=function(error){try{this._prevObserver.error(error)}catch(e){}finally{this._currentObserver.error(error)}},DoObserver.prototype.onCompleted=function(){try{this._prevObserver.completed()}catch(e){this._prevObserver.error(e),this._currentObserver.error(e)}finally{this._currentObserver.completed()}},DoObserver}(wdFrp.Observer);wdFrp.DoObserver=DoObserver}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},__decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},wdFrp;!function(wdFrp){var Log=wdCb.Log,MergeAllObserver=function(_super){function MergeAllObserver(currentObserver,streamGroup,groupDisposable){_super.call(this,null,null,null),this.done=!1,this.currentObserver=null,this._streamGroup=null,this._groupDisposable=null,this.currentObserver=currentObserver,this._streamGroup=streamGroup,this._groupDisposable=groupDisposable}return __extends(MergeAllObserver,_super),MergeAllObserver.create=function(currentObserver,streamGroup,groupDisposable){return new this(currentObserver,streamGroup,groupDisposable)},MergeAllObserver.prototype.onNext=function(innerSource){wdFrp.JudgeUtils.isPromise(innerSource)&&(innerSource=wdFrp.fromPromise(innerSource)),this._streamGroup.addChild(innerSource),this._groupDisposable.add(innerSource.buildStream(InnerObserver.create(this,this._streamGroup,innerSource)))},MergeAllObserver.prototype.onError=function(error){this.currentObserver.error(error)},MergeAllObserver.prototype.onCompleted=function(){this.done=!0,0===this._streamGroup.getCount()&&this.currentObserver.completed()},__decorate([wdFrp.require(function(innerSource){wdFrp.assert(innerSource instanceof wdFrp.Stream||wdFrp.JudgeUtils.isPromise(innerSource),Log.info.FUNC_MUST_BE("innerSource","Stream or Promise"))})],MergeAllObserver.prototype,"onNext",null),MergeAllObserver}(wdFrp.Observer);wdFrp.MergeAllObserver=MergeAllObserver;var InnerObserver=function(_super){function InnerObserver(parent,streamGroup,currentStream){_super.call(this,null,null,null),this._parent=null,this._streamGroup=null,this._currentStream=null,this._parent=parent,this._streamGroup=streamGroup,this._currentStream=currentStream}return __extends(InnerObserver,_super),InnerObserver.create=function(parent,streamGroup,currentStream){var obj=new this(parent,streamGroup,currentStream);return obj},InnerObserver.prototype.onNext=function(value){this._parent.currentObserver.next(value)},InnerObserver.prototype.onError=function(error){this._parent.currentObserver.error(error)},InnerObserver.prototype.onCompleted=function(){var currentStream=this._currentStream,parent=this._parent;this._streamGroup.removeChild(function(stream){return wdFrp.JudgeUtils.isEqual(stream,currentStream)}),this._isAsync()&&0===this._streamGroup.getCount()&&parent.currentObserver.completed()},InnerObserver.prototype._isAsync=function(){return this._parent.done},InnerObserver}(wdFrp.Observer)}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},__decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},wdFrp;!function(wdFrp){var Log=wdCb.Log,MergeObserver=function(_super){function MergeObserver(currentObserver,maxConcurrent,streamGroup,groupDisposable){_super.call(this,null,null,null),this.done=!1,this.currentObserver=null,this.activeCount=0,this.q=[],this._maxConcurrent=null,this._groupDisposable=null,this._streamGroup=null,this.currentObserver=currentObserver,this._maxConcurrent=maxConcurrent,this._streamGroup=streamGroup,this._groupDisposable=groupDisposable}return __extends(MergeObserver,_super),MergeObserver.create=function(currentObserver,maxConcurrent,streamGroup,groupDisposable){return new this(currentObserver,maxConcurrent,streamGroup,groupDisposable)},MergeObserver.prototype.handleSubscribe=function(innerSource){wdFrp.JudgeUtils.isPromise(innerSource)&&(innerSource=wdFrp.fromPromise(innerSource)),this._streamGroup.addChild(innerSource),this._groupDisposable.add(innerSource.buildStream(InnerObserver.create(this,this._streamGroup,innerSource)))},MergeObserver.prototype.onNext=function(innerSource){return this._isReachMaxConcurrent()?(this.activeCount++,void this.handleSubscribe(innerSource)):void this.q.push(innerSource)},MergeObserver.prototype.onError=function(error){this.currentObserver.error(error)},MergeObserver.prototype.onCompleted=function(){this.done=!0,0===this._streamGroup.getCount()&&this.currentObserver.completed()},MergeObserver.prototype._isReachMaxConcurrent=function(){return this.activeCount<this._maxConcurrent},__decorate([wdFrp.require(function(innerSource){wdFrp.assert(innerSource instanceof wdFrp.Stream||wdFrp.JudgeUtils.isPromise(innerSource),Log.info.FUNC_MUST_BE("innerSource","Stream or Promise"))})],MergeObserver.prototype,"onNext",null),MergeObserver}(wdFrp.Observer);wdFrp.MergeObserver=MergeObserver;var InnerObserver=function(_super){function InnerObserver(parent,streamGroup,currentStream){_super.call(this,null,null,null),this._parent=null,this._streamGroup=null,this._currentStream=null,this._parent=parent,this._streamGroup=streamGroup,this._currentStream=currentStream}return __extends(InnerObserver,_super),InnerObserver.create=function(parent,streamGroup,currentStream){var obj=new this(parent,streamGroup,currentStream);return obj},InnerObserver.prototype.onNext=function(value){this._parent.currentObserver.next(value)},InnerObserver.prototype.onError=function(error){this._parent.currentObserver.error(error)},InnerObserver.prototype.onCompleted=function(){var parent=this._parent;this._streamGroup.removeChild(this._currentStream),parent.q.length>0?(parent.activeCount=0,parent.handleSubscribe(parent.q.shift())):this._isAsync()&&0===this._streamGroup.getCount()&&parent.currentObserver.completed()},InnerObserver.prototype._isAsync=function(){return this._parent.done},InnerObserver}(wdFrp.Observer)}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var TakeUntilObserver=function(_super){function TakeUntilObserver(prevObserver){_super.call(this,null,null,null),this._prevObserver=null,this._prevObserver=prevObserver}return __extends(TakeUntilObserver,_super),TakeUntilObserver.create=function(prevObserver){return new this(prevObserver)},TakeUntilObserver.prototype.onNext=function(value){this._prevObserver.completed()},TakeUntilObserver.prototype.onError=function(error){this._prevObserver.error(error)},TakeUntilObserver.prototype.onCompleted=function(){},TakeUntilObserver}(wdFrp.Observer);wdFrp.TakeUntilObserver=TakeUntilObserver}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var ConcatObserver=function(_super){function ConcatObserver(currentObserver,startNextStream){_super.call(this,null,null,null),this.currentObserver=null,this._startNextStream=null,this.currentObserver=currentObserver,this._startNextStream=startNextStream}return __extends(ConcatObserver,_super),ConcatObserver.create=function(currentObserver,startNextStream){return new this(currentObserver,startNextStream)},ConcatObserver.prototype.onNext=function(value){this.currentObserver.next(value)},ConcatObserver.prototype.onError=function(error){this.currentObserver.error(error)},ConcatObserver.prototype.onCompleted=function(){this._startNextStream()},ConcatObserver}(wdFrp.Observer);wdFrp.ConcatObserver=ConcatObserver}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){var SubjectObserver=function(){function SubjectObserver(){this.observers=wdCb.Collection.create(),this._disposable=null}return SubjectObserver.prototype.isEmpty=function(){return 0===this.observers.getCount()},SubjectObserver.prototype.next=function(value){this.observers.forEach(function(ob){ob.next(value)})},SubjectObserver.prototype.error=function(error){this.observers.forEach(function(ob){ob.error(error)})},SubjectObserver.prototype.completed=function(){this.observers.forEach(function(ob){ob.completed()})},SubjectObserver.prototype.addChild=function(observer){this.observers.addChild(observer),observer.setDisposable(this._disposable)},SubjectObserver.prototype.removeChild=function(observer){this.observers.removeChild(function(ob){return wdFrp.JudgeUtils.isEqual(ob,observer)})},SubjectObserver.prototype.dispose=function(){this.observers.forEach(function(ob){ob.dispose()}),this.observers.removeAllChildren()},SubjectObserver.prototype.setDisposable=function(disposable){this.observers.forEach(function(observer){observer.setDisposable(disposable)}),this._disposable=disposable},SubjectObserver}();wdFrp.SubjectObserver=SubjectObserver}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var IgnoreElementsObserver=function(_super){function IgnoreElementsObserver(currentObserver){_super.call(this,null,null,null),this._currentObserver=null,this._currentObserver=currentObserver}return __extends(IgnoreElementsObserver,_super),IgnoreElementsObserver.create=function(currentObserver){return new this(currentObserver)},IgnoreElementsObserver.prototype.onNext=function(value){},IgnoreElementsObserver.prototype.onError=function(error){this._currentObserver.error(error)},IgnoreElementsObserver.prototype.onCompleted=function(){this._currentObserver.completed()},IgnoreElementsObserver}(wdFrp.Observer);wdFrp.IgnoreElementsObserver=IgnoreElementsObserver}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var FilterObserver=function(_super){function FilterObserver(prevObserver,predicate,source){_super.call(this,null,null,null),this.prevObserver=null,this.source=null,this.i=0,this.predicate=null,this.prevObserver=prevObserver,this.predicate=predicate,this.source=source}return __extends(FilterObserver,_super),FilterObserver.create=function(prevObserver,predicate,source){return new this(prevObserver,predicate,source)},FilterObserver.prototype.onNext=function(value){try{this.predicate(value,this.i++,this.source)&&this.prevObserver.next(value)}catch(e){this.prevObserver.error(e)}},FilterObserver.prototype.onError=function(error){this.prevObserver.error(error)},FilterObserver.prototype.onCompleted=function(){this.prevObserver.completed()},FilterObserver}(wdFrp.Observer);wdFrp.FilterObserver=FilterObserver}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var FilterWithStateObserver=function(_super){function FilterWithStateObserver(){_super.apply(this,arguments),this._isTrigger=!1}return __extends(FilterWithStateObserver,_super),FilterWithStateObserver.create=function(prevObserver,predicate,source){return new this(prevObserver,predicate,source)},FilterWithStateObserver.prototype.onNext=function(value){var data=null;try{this.predicate(value,this.i++,this.source)?(data=this._isTrigger?{value:value,state:wdFrp.FilterState.TRIGGER}:{value:value,state:wdFrp.FilterState.ENTER},this.prevObserver.next(data),this._isTrigger=!0):(this._isTrigger&&(data={value:value,state:wdFrp.FilterState.LEAVE},this.prevObserver.next(data)),this._isTrigger=!1)}catch(e){this.prevObserver.error(e)}},FilterWithStateObserver}(wdFrp.FilterObserver);wdFrp.FilterWithStateObserver=FilterWithStateObserver}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var BaseStream=function(_super){function BaseStream(){_super.apply(this,arguments)}return __extends(BaseStream,_super),BaseStream.prototype.subscribe=function(arg1,onError,onCompleted){var observer=null;if(!this.handleSubject(arg1))return observer=arg1 instanceof wdFrp.Observer?wdFrp.AutoDetachObserver.create(arg1):wdFrp.AutoDetachObserver.create(arg1,onError,onCompleted),observer.setDisposable(this.buildStream(observer)),observer},BaseStream.prototype.buildStream=function(observer){return _super.prototype.buildStream.call(this,observer),this.subscribeCore(observer)},BaseStream}(wdFrp.Stream);wdFrp.BaseStream=BaseStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var DoStream=function(_super){function DoStream(source,onNext,onError,onCompleted){_super.call(this,null),this._source=null,this._observer=null,this._source=source,this._observer=wdFrp.AnonymousObserver.create(onNext,onError,onCompleted),this.scheduler=this._source.scheduler}return __extends(DoStream,_super),DoStream.create=function(source,onNext,onError,onCompleted){var obj=new this(source,onNext,onError,onCompleted);return obj},DoStream.prototype.subscribeCore=function(observer){return this._source.buildStream(wdFrp.DoObserver.create(observer,this._observer))},DoStream}(wdFrp.BaseStream);wdFrp.DoStream=DoStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var MapStream=function(_super){function MapStream(source,selector){_super.call(this,null),this._source=null,this._selector=null,this._source=source,this.scheduler=this._source.scheduler,this._selector=selector}return __extends(MapStream,_super),MapStream.create=function(source,selector){var obj=new this(source,selector);return obj},MapStream.prototype.subscribeCore=function(observer){return this._source.buildStream(wdFrp.MapObserver.create(observer,this._selector))},MapStream}(wdFrp.BaseStream);wdFrp.MapStream=MapStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var FromArrayStream=function(_super){function FromArrayStream(array,scheduler){_super.call(this,null),this._array=null,this._array=array,this.scheduler=scheduler}return __extends(FromArrayStream,_super),FromArrayStream.create=function(array,scheduler){var obj=new this(array,scheduler);return obj},FromArrayStream.prototype.subscribeCore=function(observer){function loopRecursive(i){i<len?(observer.next(array[i]),arguments.callee(i+1)):observer.completed()}var array=this._array,len=array.length;return this.scheduler.publishRecursive(observer,0,loopRecursive),wdFrp.SingleDisposable.create()},FromArrayStream}(wdFrp.BaseStream);wdFrp.FromArrayStream=FromArrayStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var FromPromiseStream=function(_super){function FromPromiseStream(promise,scheduler){_super.call(this,null),this._promise=null,this._promise=promise,this.scheduler=scheduler}return __extends(FromPromiseStream,_super),FromPromiseStream.create=function(promise,scheduler){var obj=new this(promise,scheduler);return obj},FromPromiseStream.prototype.subscribeCore=function(observer){return this._promise.then(function(data){observer.next(data),observer.completed()},function(err){observer.error(err)},observer),wdFrp.SingleDisposable.create()},FromPromiseStream}(wdFrp.BaseStream);wdFrp.FromPromiseStream=FromPromiseStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var FromEventPatternStream=function(_super){function FromEventPatternStream(addHandler,removeHandler){_super.call(this,null),this._addHandler=null,this._removeHandler=null,this._addHandler=addHandler,this._removeHandler=removeHandler}return __extends(FromEventPatternStream,_super),FromEventPatternStream.create=function(addHandler,removeHandler){var obj=new this(addHandler,removeHandler);return obj},FromEventPatternStream.prototype.subscribeCore=function(observer){function innerHandler(event){observer.next(event)}var self=this;return this._addHandler(innerHandler),wdFrp.SingleDisposable.create(function(){self._removeHandler(innerHandler)})},FromEventPatternStream}(wdFrp.BaseStream);wdFrp.FromEventPatternStream=FromEventPatternStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var AnonymousStream=function(_super){function AnonymousStream(subscribeFunc){_super.call(this,subscribeFunc),this.scheduler=wdFrp.Scheduler.create()}return __extends(AnonymousStream,_super),AnonymousStream.create=function(subscribeFunc){var obj=new this(subscribeFunc);return obj},AnonymousStream.prototype.subscribe=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var observer=null;if(args[0]instanceof wdFrp.Subject){var subject=args[0];return void this.handleSubject(subject)}if(wdFrp.JudgeUtils.isIObserver(args[0]))observer=wdFrp.AutoDetachObserver.create(args[0]);else{var onNext=args[0],onError=args[1]||null,onCompleted=args[2]||null;observer=wdFrp.AutoDetachObserver.create(onNext,onError,onCompleted)}return observer.setDisposable(this.buildStream(observer)),observer},AnonymousStream}(wdFrp.Stream);wdFrp.AnonymousStream=AnonymousStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var IntervalStream=function(_super){function IntervalStream(interval,scheduler){_super.call(this,null),this._interval=null,this._interval=interval,this.scheduler=scheduler}return __extends(IntervalStream,_super),IntervalStream.create=function(interval,scheduler){var obj=new this(interval,scheduler);return obj.initWhenCreate(),obj},IntervalStream.prototype.initWhenCreate=function(){this._interval=this._interval<=0?1:this._interval},IntervalStream.prototype.subscribeCore=function(observer){var id=null;return id=this.scheduler.publishInterval(observer,0,this._interval,function(count){return observer.next(count),count+1}),wdFrp.SingleDisposable.create(function(){wdFrp.root.clearInterval(id)})},IntervalStream}(wdFrp.BaseStream);wdFrp.IntervalStream=IntervalStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var IntervalRequestStream=function(_super){function IntervalRequestStream(scheduler){_super.call(this,null),this._isEnd=!1,this.scheduler=scheduler}return __extends(IntervalRequestStream,_super),IntervalRequestStream.create=function(scheduler){var obj=new this(scheduler);return obj},IntervalRequestStream.prototype.subscribeCore=function(observer){var self=this;return this.scheduler.publishIntervalRequest(observer,function(time){return observer.next(time),self._isEnd}),wdFrp.SingleDisposable.create(function(){wdFrp.root.cancelNextRequestAnimationFrame(self.scheduler.requestLoopId),self._isEnd=!0})},IntervalRequestStream}(wdFrp.BaseStream);wdFrp.IntervalRequestStream=IntervalRequestStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},__decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},wdFrp;!function(wdFrp){var Log=wdCb.Log,TimeoutStream=function(_super){function TimeoutStream(time,scheduler){_super.call(this,null),this._time=null,this._time=time,this.scheduler=scheduler}return __extends(TimeoutStream,_super),TimeoutStream.create=function(time,scheduler){var obj=new this(time,scheduler);return obj},TimeoutStream.prototype.subscribeCore=function(observer){var id=null;return id=this.scheduler.publishTimeout(observer,this._time,function(time){observer.next(time)}),wdFrp.SingleDisposable.create(function(){wdFrp.root.clearTimeout(id)})},__decorate([wdFrp.require(function(time,scheduler){wdFrp.assert(time>0,Log.info.FUNC_SHOULD("time","> 0"))})],TimeoutStream,"create",null),TimeoutStream}(wdFrp.BaseStream);wdFrp.TimeoutStream=TimeoutStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var MergeAllStream=function(_super){function MergeAllStream(source){_super.call(this,null),this._source=null,this._observer=null,this._source=source,this.scheduler=this._source.scheduler}return __extends(MergeAllStream,_super),MergeAllStream.create=function(source){var obj=new this(source);return obj},MergeAllStream.prototype.subscribeCore=function(observer){var streamGroup=wdCb.Collection.create(),groupDisposable=wdFrp.GroupDisposable.create();return this._source.buildStream(wdFrp.MergeAllObserver.create(observer,streamGroup,groupDisposable)),groupDisposable},MergeAllStream}(wdFrp.BaseStream);wdFrp.MergeAllStream=MergeAllStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var MergeStream=function(_super){function MergeStream(source,maxConcurrent){_super.call(this,null),this._source=null,this._maxConcurrent=null,this._source=source,this._maxConcurrent=maxConcurrent,this.scheduler=this._source.scheduler}return __extends(MergeStream,_super),MergeStream.create=function(source,maxConcurrent){var obj=new this(source,maxConcurrent);return obj},MergeStream.prototype.subscribeCore=function(observer){var streamGroup=wdCb.Collection.create(),groupDisposable=wdFrp.GroupDisposable.create();return this._source.buildStream(wdFrp.MergeObserver.create(observer,this._maxConcurrent,streamGroup,groupDisposable)),groupDisposable},MergeStream}(wdFrp.BaseStream);wdFrp.MergeStream=MergeStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var TakeUntilStream=function(_super){function TakeUntilStream(source,otherStream){_super.call(this,null),this._source=null,this._otherStream=null,this._source=source,this._otherStream=wdFrp.JudgeUtils.isPromise(otherStream)?wdFrp.fromPromise(otherStream):otherStream,this.scheduler=this._source.scheduler}return __extends(TakeUntilStream,_super),TakeUntilStream.create=function(source,otherSteam){var obj=new this(source,otherSteam);return obj},TakeUntilStream.prototype.subscribeCore=function(observer){var group=wdFrp.GroupDisposable.create(),autoDetachObserver=wdFrp.AutoDetachObserver.create(observer),sourceDisposable=null;return sourceDisposable=this._source.buildStream(observer),group.add(sourceDisposable),autoDetachObserver.setDisposable(sourceDisposable),group.add(this._otherStream.buildStream(wdFrp.TakeUntilObserver.create(autoDetachObserver))),group},TakeUntilStream}(wdFrp.BaseStream);wdFrp.TakeUntilStream=TakeUntilStream}(wdFrp||(wdFrp={}));
var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var ConcatStream=function(_super){function ConcatStream(sources){_super.call(this,null),this._sources=wdCb.Collection.create();var self=this;this.scheduler=sources[0].scheduler,sources.forEach(function(source){wdFrp.JudgeUtils.isPromise(source)?self._sources.addChild(wdFrp.fromPromise(source)):self._sources.addChild(source)})}return __extends(ConcatStream,_super),ConcatStream.create=function(sources){var obj=new this(sources);return obj},ConcatStream.prototype.subscribeCore=function(observer){function loopRecursive(i){return i===count?void observer.completed():void d.add(self._sources.getChild(i).buildStream(wdFrp.ConcatObserver.create(observer,function(){loopRecursive(i+1)})))}var self=this,count=this._sources.getCount(),d=wdFrp.GroupDisposable.create();return this.scheduler.publishRecursive(observer,0,loopRecursive),wdFrp.GroupDisposable.create(d)},ConcatStream}(wdFrp.BaseStream);wdFrp.ConcatStream=ConcatStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var RepeatStream=function(_super){function RepeatStream(source,count){_super.call(this,null),this._source=null,this._count=null,this._source=source,this._count=count,this.scheduler=this._source.scheduler}return __extends(RepeatStream,_super),RepeatStream.create=function(source,count){var obj=new this(source,count);return obj},RepeatStream.prototype.subscribeCore=function(observer){function loopRecursive(count){return 0===count?void observer.completed():void d.add(self._source.buildStream(wdFrp.ConcatObserver.create(observer,function(){loopRecursive(count-1)})))}var self=this,d=wdFrp.GroupDisposable.create();return this.scheduler.publishRecursive(observer,this._count,loopRecursive),wdFrp.GroupDisposable.create(d)},RepeatStream}(wdFrp.BaseStream);wdFrp.RepeatStream=RepeatStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var IgnoreElementsStream=function(_super){function IgnoreElementsStream(source){_super.call(this,null),this._source=null,this._source=source,this.scheduler=this._source.scheduler}return __extends(IgnoreElementsStream,_super),IgnoreElementsStream.create=function(source){var obj=new this(source);return obj},IgnoreElementsStream.prototype.subscribeCore=function(observer){return this._source.buildStream(wdFrp.IgnoreElementsObserver.create(observer))},IgnoreElementsStream}(wdFrp.BaseStream);wdFrp.IgnoreElementsStream=IgnoreElementsStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var DeferStream=function(_super){function DeferStream(buildStreamFunc){_super.call(this,null),this._buildStreamFunc=null,this._buildStreamFunc=buildStreamFunc}return __extends(DeferStream,_super),DeferStream.create=function(buildStreamFunc){var obj=new this(buildStreamFunc);return obj},DeferStream.prototype.subscribeCore=function(observer){var group=wdFrp.GroupDisposable.create();return group.add(this._buildStreamFunc().buildStream(observer)),group},DeferStream}(wdFrp.BaseStream);wdFrp.DeferStream=DeferStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var FilterStream=function(_super){function FilterStream(source,predicate,thisArg){_super.call(this,null),this.predicate=null,this._source=null,this._source=source,this.predicate=wdCb.FunctionUtils.bind(thisArg,predicate)}return __extends(FilterStream,_super),FilterStream.create=function(source,predicate,thisArg){var obj=new this(source,predicate,thisArg);return obj},FilterStream.prototype.subscribeCore=function(observer){return this._source.subscribe(this.createObserver(observer))},FilterStream.prototype.internalFilter=function(predicate,thisArg){return this.createStreamForInternalFilter(this._source,this._innerPredicate(predicate,this),thisArg)},FilterStream.prototype.createObserver=function(observer){return wdFrp.FilterObserver.create(observer,this.predicate,this)},FilterStream.prototype.createStreamForInternalFilter=function(source,innerPredicate,thisArg){return FilterStream.create(source,innerPredicate,thisArg)},FilterStream.prototype._innerPredicate=function(predicate,self){var _this=this;return function(value,i,o){return self.predicate(value,i,o)&&predicate.call(_this,value,i,o)}},FilterStream}(wdFrp.BaseStream);wdFrp.FilterStream=FilterStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var FilterWithStateStream=function(_super){function FilterWithStateStream(){_super.apply(this,arguments)}return __extends(FilterWithStateStream,_super),FilterWithStateStream.create=function(source,predicate,thisArg){var obj=new this(source,predicate,thisArg);return obj},FilterWithStateStream.prototype.createObserver=function(observer){return wdFrp.FilterWithStateObserver.create(observer,this.predicate,this)},FilterWithStateStream.prototype.createStreamForInternalFilter=function(source,innerPredicate,thisArg){return FilterWithStateStream.create(source,innerPredicate,thisArg)},FilterWithStateStream}(wdFrp.FilterStream);wdFrp.FilterWithStateStream=FilterWithStateStream}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){wdFrp.createStream=function(subscribeFunc){return wdFrp.AnonymousStream.create(subscribeFunc)},wdFrp.fromArray=function(array,scheduler){return void 0===scheduler&&(scheduler=wdFrp.Scheduler.create()),wdFrp.FromArrayStream.create(array,scheduler)},wdFrp.fromPromise=function(promise,scheduler){return void 0===scheduler&&(scheduler=wdFrp.Scheduler.create()),wdFrp.FromPromiseStream.create(promise,scheduler)},wdFrp.fromEventPattern=function(addHandler,removeHandler){return wdFrp.FromEventPatternStream.create(addHandler,removeHandler)},wdFrp.interval=function(interval,scheduler){return void 0===scheduler&&(scheduler=wdFrp.Scheduler.create()),wdFrp.IntervalStream.create(interval,scheduler)},wdFrp.intervalRequest=function(scheduler){return void 0===scheduler&&(scheduler=wdFrp.Scheduler.create()),wdFrp.IntervalRequestStream.create(scheduler)},wdFrp.timeout=function(time,scheduler){return void 0===scheduler&&(scheduler=wdFrp.Scheduler.create()),wdFrp.TimeoutStream.create(time,scheduler)},wdFrp.empty=function(){return wdFrp.createStream(function(observer){observer.completed()})},wdFrp.callFunc=function(func,context){return void 0===context&&(context=wdFrp.root),wdFrp.createStream(function(observer){try{observer.next(func.call(context,null))}catch(e){observer.error(e)}observer.completed()})},wdFrp.judge=function(condition,thenSource,elseSource){return condition()?thenSource():elseSource()},wdFrp.defer=function(buildStreamFunc){return wdFrp.DeferStream.create(buildStreamFunc)},wdFrp.just=function(returnValue){return wdFrp.createStream(function(observer){observer.next(returnValue),observer.completed()})}}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){!function(FilterState){FilterState[FilterState.TRIGGER=0]="TRIGGER",FilterState[FilterState.ENTER=1]="ENTER",FilterState[FilterState.LEAVE=2]="LEAVE"}(wdFrp.FilterState||(wdFrp.FilterState={}));wdFrp.FilterState}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){var defaultIsEqual=function(a,b){return a===b},Record=function(){function Record(time,value,actionType,comparer){this._time=null,this._value=null,this._actionType=null,this._comparer=null,this._time=time,this._value=value,this._actionType=actionType,this._comparer=comparer||defaultIsEqual}return Record.create=function(time,value,actionType,comparer){var obj=new this(time,value,actionType,comparer);return obj},Object.defineProperty(Record.prototype,"time",{get:function(){return this._time},set:function(time){this._time=time},enumerable:!0,configurable:!0}),Object.defineProperty(Record.prototype,"value",{get:function(){return this._value},set:function(value){this._value=value},enumerable:!0,configurable:!0}),Object.defineProperty(Record.prototype,"actionType",{get:function(){return this._actionType},set:function(actionType){this._actionType=actionType},enumerable:!0,configurable:!0}),Record.prototype.equals=function(other){return this._time===other.time&&this._comparer(this._value,other.value)},Record}();wdFrp.Record=Record}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var MockObserver=function(_super){function MockObserver(scheduler){_super.call(this,null,null,null),this._messages=[],this._scheduler=null,this._scheduler=scheduler}return __extends(MockObserver,_super),MockObserver.create=function(scheduler){var obj=new this(scheduler);return obj},Object.defineProperty(MockObserver.prototype,"messages",{get:function(){return this._messages},set:function(messages){this._messages=messages},enumerable:!0,configurable:!0}),MockObserver.prototype.onNext=function(value){var record=null;record=wdFrp.JudgeUtils.isDirectObject(value)?wdFrp.Record.create(this._scheduler.clock,value,wdFrp.ActionType.NEXT,function(a,b){var result=!0;for(var i in a)if(a.hasOwnProperty(i)&&a[i]!==b[i]){result=!1;break}return result}):wdFrp.Record.create(this._scheduler.clock,value,wdFrp.ActionType.NEXT),this._messages.push(record)},MockObserver.prototype.onError=function(error){this._messages.push(wdFrp.Record.create(this._scheduler.clock,error,wdFrp.ActionType.ERROR))},MockObserver.prototype.onCompleted=function(){this._messages.push(wdFrp.Record.create(this._scheduler.clock,null,wdFrp.ActionType.COMPLETED))},MockObserver.prototype.dispose=function(){_super.prototype.dispose.call(this),this._scheduler.remove(this)},MockObserver.prototype.clone=function(){var result=MockObserver.create(this._scheduler);return result.messages=this._messages,result},MockObserver}(wdFrp.Observer);wdFrp.MockObserver=MockObserver}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){var MockPromise=function(){function MockPromise(scheduler,messages){this._messages=[],this._scheduler=null,this._scheduler=scheduler,this._messages=messages}return MockPromise.create=function(scheduler,messages){var obj=new this(scheduler,messages);return obj},MockPromise.prototype.then=function(successCb,errorCb,observer){this._scheduler.setStreamMap(observer,this._messages)},MockPromise}();wdFrp.MockPromise=MockPromise}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var SUBSCRIBE_TIME=200,DISPOSE_TIME=1e3,TestScheduler=function(_super){function TestScheduler(isReset){_super.call(this),this._clock=null,this._isReset=!1,this._isDisposed=!1,this._timerMap=wdCb.Hash.create(),this._streamMap=wdCb.Hash.create(),this._subscribedTime=null,this._disposedTime=null,this._observer=null,this._isReset=isReset}return __extends(TestScheduler,_super),TestScheduler.next=function(tick,value){return wdFrp.JudgeUtils.isDirectObject(value)?wdFrp.Record.create(tick,value,wdFrp.ActionType.NEXT,function(a,b){var result=!0;for(var i in a)if(a.hasOwnProperty(i)&&a[i]!==b[i]){result=!1;break}return result}):wdFrp.Record.create(tick,value,wdFrp.ActionType.NEXT)},TestScheduler.error=function(tick,error){return wdFrp.Record.create(tick,error,wdFrp.ActionType.ERROR)},TestScheduler.completed=function(tick){return wdFrp.Record.create(tick,null,wdFrp.ActionType.COMPLETED)},TestScheduler.create=function(isReset){void 0===isReset&&(isReset=!1);var obj=new this(isReset);return obj},Object.defineProperty(TestScheduler.prototype,"clock",{get:function(){return this._clock},set:function(clock){this._clock=clock},enumerable:!0,configurable:!0}),TestScheduler.prototype.setStreamMap=function(observer,messages){var self=this;messages.forEach(function(record){var func=null;switch(record.actionType){case wdFrp.ActionType.NEXT:func=function(){observer.next(record.value)};break;case wdFrp.ActionType.ERROR:func=function(){observer.error(record.value)};break;case wdFrp.ActionType.COMPLETED:func=function(){observer.completed()};break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("actionType"))}self._streamMap.addChild(String(record.time),func)})},TestScheduler.prototype.remove=function(observer){this._isDisposed=!0},TestScheduler.prototype.publishRecursive=function(observer,initial,recursiveFunc){var self=this,next=null,completed=null;this._setClock(),next=observer.next,completed=observer.completed,observer.next=function(value){next.call(observer,value),self._tick(1)},observer.completed=function(){completed.call(observer),self._tick(1)},recursiveFunc(initial)},TestScheduler.prototype.publishInterval=function(observer,initial,interval,action){var COUNT=10,messages=[];for(this._setClock();COUNT>0&&!this._isDisposed;)this._tick(interval),messages.push(TestScheduler.next(this._clock,initial)),initial++,COUNT--;return this.setStreamMap(observer,messages),NaN},TestScheduler.prototype.publishIntervalRequest=function(observer,action){var COUNT=10,messages=[],interval=100,num=0;for(this._setClock();COUNT>0&&!this._isDisposed;)this._tick(interval),messages.push(TestScheduler.next(this._clock,num)),num++,COUNT--;return this.setStreamMap(observer,messages),NaN},TestScheduler.prototype.publishTimeout=function(observer,time,action){var messages=[];return this._setClock(),this._tick(time),messages.push(TestScheduler.next(this._clock,time),TestScheduler.completed(this._clock+1)),this.setStreamMap(observer,messages),NaN},TestScheduler.prototype._setClock=function(){this._isReset&&(this._clock=this._subscribedTime)},TestScheduler.prototype.startWithTime=function(create,subscribedTime,disposedTime){var source,subscription,observer=this.createObserver(),self=this;return this._subscribedTime=subscribedTime,this._disposedTime=disposedTime,this._clock=subscribedTime,this._runAt(subscribedTime,function(){source=create(),subscription=source.subscribe(observer)}),this._runAt(disposedTime,function(){subscription.dispose(),self._isDisposed=!0}),this._observer=observer,this.start(),observer},TestScheduler.prototype.startWithSubscribe=function(create,subscribedTime){return void 0===subscribedTime&&(subscribedTime=SUBSCRIBE_TIME),this.startWithTime(create,subscribedTime,DISPOSE_TIME)},TestScheduler.prototype.startWithDispose=function(create,disposedTime){return void 0===disposedTime&&(disposedTime=DISPOSE_TIME),this.startWithTime(create,SUBSCRIBE_TIME,disposedTime)},TestScheduler.prototype.publicAbsolute=function(time,handler){this._runAt(time,function(){handler()})},TestScheduler.prototype.start=function(){for(var extremeNumArr=this._getMinAndMaxTime(),min=extremeNumArr[0],max=extremeNumArr[1],time=min;time<=max;)this._clock=time,this._exec(time,this._timerMap),this._clock=time,this._runStream(time),time++,max=this._getMinAndMaxTime()[1]},TestScheduler.prototype.createStream=function(args){return wdFrp.TestStream.create(Array.prototype.slice.call(arguments,0),this)},TestScheduler.prototype.createObserver=function(){return wdFrp.MockObserver.create(this)},TestScheduler.prototype.createResolvedPromise=function(time,value){return wdFrp.MockPromise.create(this,[TestScheduler.next(time,value),TestScheduler.completed(time+1)])},TestScheduler.prototype.createRejectPromise=function(time,error){return wdFrp.MockPromise.create(this,[TestScheduler.error(time,error)])},TestScheduler.prototype._getMinAndMaxTime=function(){var timeArr=this._timerMap.getKeys().addChildren(this._streamMap.getKeys());return timeArr=timeArr.map(function(key){return Number(key)}).toArray(),[Math.min.apply(Math,timeArr),Math.max.apply(Math,timeArr)]},TestScheduler.prototype._exec=function(time,map){var handler=map.getChild(String(time));handler&&handler()},TestScheduler.prototype._runStream=function(time){var handler=this._streamMap.getChild(String(time));handler&&handler()},TestScheduler.prototype._runAt=function(time,callback){this._timerMap.addChild(String(time),callback)},TestScheduler.prototype._tick=function(time){this._clock+=time},TestScheduler}(wdFrp.Scheduler);wdFrp.TestScheduler=TestScheduler}(wdFrp||(wdFrp={}));var wdFrp;!function(wdFrp){!function(ActionType){ActionType[ActionType.NEXT=0]="NEXT",ActionType[ActionType.ERROR=1]="ERROR",ActionType[ActionType.COMPLETED=2]="COMPLETED"}(wdFrp.ActionType||(wdFrp.ActionType={}));wdFrp.ActionType}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},wdFrp;!function(wdFrp){var TestStream=function(_super){function TestStream(messages,scheduler){_super.call(this,null),this.scheduler=null,this._messages=null,this._messages=messages,this.scheduler=scheduler}return __extends(TestStream,_super),TestStream.create=function(messages,scheduler){var obj=new this(messages,scheduler);return obj},TestStream.prototype.subscribeCore=function(observer){return this.scheduler.setStreamMap(observer,this._messages),wdFrp.SingleDisposable.create()},TestStream}(wdFrp.BaseStream);wdFrp.TestStream=TestStream}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(d,b){function __(){this.constructor=d}for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)},__decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},wd;!function(wd){wd.DebugConfig={isTest:!1,debugCollision:!1,showDebugPanel:!1}}(wd||(wd={}));var wd;!function(wd){var DebugStatistics=function(){function DebugStatistics(){}return DebugStatistics.clear=function(){this.count.renderGameObjects=0,this.count.drawCalls=0},DebugStatistics.init=function(){var self=this;this._startLoopSubscription=wd.EventManager.fromEvent(wd.EEngineEvent.STARTLOOP).subscribe(function(){wd.DebugConfig.showDebugPanel&&(console.log("totalGameObjects:"+self.count.totalGameObjects+", renderGameObjects:"+self.count.renderGameObjects+", drawCalls:"+self.count.drawCalls),console.log("fps:"+self.during.fps),self.clear())})},DebugStatistics.dispose=function(){this._startLoopSubscription.dispose()},DebugStatistics.count={get totalGameObjects(){var count=0;return wd.Director.getInstance().scene.getChildren().forEach(function(child){return child.hasComponent(wd.SpacePartition)?void(count+=child.getComponent(wd.SpacePartition).getChildren().getCount()):void count++}),count},renderGameObjects:0,drawCalls:0},DebugStatistics.during={get fps(){return wd.Director.getInstance().fps}},DebugStatistics._startLoopSubscription=null,DebugStatistics}();wd.DebugStatistics=DebugStatistics}(wd||(wd={}));var wdFrp;!function(wdFrp){wdFrp.fromCollection=function(collection,scheduler){void 0===scheduler&&(scheduler=wdFrp.Scheduler.create());var arr=collection.toArray();return 0===arr.length?wdFrp.empty():wdFrp.fromArray(arr,scheduler)}}(wdFrp||(wdFrp={}));var wd;!function(wd){wd.CompileConfig={isTest:!0}}(wd||(wd={}));var wd;!function(wd){function assert(cond,message){void 0===message&&(message="contract error"),wd.Log.error(!cond,message)}function describe(message,func,preCondition,context){if(void 0===preCondition&&(preCondition=function(){return!0}),void 0===context&&(context=this),preCondition.call(context,null)){_describeContext=context;try{func.call(context,null)}catch(e){assert(!1,message+"->"+e.message)}finally{_describeContext=null}}}function it(message,func,context){try{3===arguments.length?func.call(context,null):_describeContext?func.call(_describeContext,null):func()}catch(e){assert(!1,message+"->"+e.message)}}function require(inFunc){return function(target,name,descriptor){if(wd.CompileConfig.isTest){var value_1=descriptor.value;descriptor.value=function(args){return wd.Main.isTest&&inFunc.apply(this,arguments),value_1.apply(this,arguments)}}return descriptor}}function ensure(outFunc){return function(target,name,descriptor){if(wd.CompileConfig.isTest){var value_2=descriptor.value;descriptor.value=function(args){var result=value_2.apply(this,arguments);if(wd.Main.isTest){for(var params=[result],i=0,len=arguments.length;i<len;i++)params[i+1]=arguments[i];outFunc.apply(this,params)}return result}}return descriptor}}function requireGetterAndSetter(inGetterFunc,inSetterFunc){return function(target,name,descriptor){if(wd.CompileConfig.isTest){var getter_1=descriptor.get,setter_1=descriptor.set;descriptor.get=function(){return wd.Main.isTest&&inGetterFunc.call(this),getter_1.call(this)},descriptor.set=function(val){wd.Main.isTest&&inSetterFunc.call(this,val),setter_1.call(this,val)}}return descriptor}}function requireGetter(inFunc){return function(target,name,descriptor){if(wd.CompileConfig.isTest){var getter_2=descriptor.get;descriptor.get=function(){return wd.Main.isTest&&inFunc.call(this),getter_2.call(this)}}return descriptor}}function requireSetter(inFunc){return function(target,name,descriptor){if(wd.CompileConfig.isTest){var setter_2=descriptor.set;descriptor.set=function(val){wd.Main.isTest&&inFunc.call(this,val),setter_2.call(this,val)}}return descriptor}}function ensureGetterAndSetter(outGetterFunc,outSetterFunc){return function(target,name,descriptor){if(wd.CompileConfig.isTest){var getter_3=descriptor.get,setter_3=descriptor.set;descriptor.get=function(){var result=getter_3.call(this);return wd.Main.isTest&&outGetterFunc.call(this,result),result},descriptor.set=function(val){var result=setter_3.call(this,val);if(wd.Main.isTest){var params=[result,val];outSetterFunc.apply(this,params)}}}return descriptor}}function ensureGetter(outFunc){return function(target,name,descriptor){if(wd.CompileConfig.isTest){var getter_4=descriptor.get;descriptor.get=function(){var result=getter_4.call(this);return wd.Main.isTest&&outFunc.call(this,result),result}}return descriptor}}function ensureSetter(outFunc){return function(target,name,descriptor){if(wd.CompileConfig.isTest){var setter_4=descriptor.set;descriptor.set=function(val){var result=setter_4.call(this,val);if(wd.Main.isTest){var params=[result,val];outFunc.apply(this,params)}}}return descriptor}}function invariant(func){return function(target){wd.CompileConfig.isTest&&wd.Main.isTest&&func(target)}}var _describeContext=null;wd.assert=assert,wd.describe=describe,wd.it=it,wd.require=require,wd.ensure=ensure,wd.requireGetterAndSetter=requireGetterAndSetter,wd.requireGetter=requireGetter,wd.requireSetter=requireSetter,wd.ensureGetterAndSetter=ensureGetterAndSetter,wd.ensureGetter=ensureGetter,wd.ensureSetter=ensureSetter,wd.invariant=invariant}(wd||(wd={}));var wd;!function(wd){function singleton(isInitWhenCreate){return void 0===isInitWhenCreate&&(isInitWhenCreate=!1),function(target){target._instance=null,isInitWhenCreate?target.getInstance=function(){if(null===target._instance){var instance=new target;target._instance=instance,instance.initWhenCreate()}return target._instance}:target.getInstance=function(){return null===target._instance&&(target._instance=new target),target._instance}}}wd.singleton=singleton}(wd||(wd={}));var wd;!function(wd){function cacheGetter(judgeFunc,returnCacheValueFunc,setCacheFunc){return function(target,name,descriptor){var getter=descriptor.get;return descriptor.get=function(){var result=null;return judgeFunc.call(this)?returnCacheValueFunc.call(this):(result=getter.call(this),setCacheFunc.call(this,result),result)},descriptor}}function cache(judgeFunc,returnCacheValueFunc,setCacheFunc){return function(target,name,descriptor){var value=descriptor.value;return descriptor.value=function(args){var result=null,setArgs=null;if(judgeFunc.apply(this,arguments))return returnCacheValueFunc.apply(this,arguments);result=value.apply(this,arguments),setArgs=[result];for(var i=0,len=arguments.length;i<len;i++)setArgs[i+1]=arguments[i];return setCacheFunc.apply(this,setArgs),result},descriptor}}wd.cacheGetter=cacheGetter,wd.cache=cache}(wd||(wd={}));var wd;!function(wd){function virtual(target,name,descriptor){return descriptor}wd.virtual=virtual}(wd||(wd={}));var wd;!function(wd){function operateBodyDataGetterAndSetter(dataName){return function(target,name,descriptor){var setter=(descriptor.get,descriptor.set);return descriptor.get=function(){var data=this.getPhysicsEngineAdapter()["get"+dataName](this.entityObject);return null!==data?data:this["_"+lowerFirstChar(dataName)]},descriptor.set=function(val){setter.call(this,val),this.getPhysicsEngineAdapter()["set"+dataName](this.entityObject,val)},descriptor}}function operateWorldDataGetterAndSetter(dataName){return function(target,name,descriptor){var getter=descriptor.get,setter=descriptor.set;return descriptor.get=function(){var physicsEngineAdapter=wd.PhysicsEngine.getInstance().physicsEngineAdapter;if(isWorldDefined(physicsEngineAdapter)){var data=physicsEngineAdapter["get"+dataName]();return null!==data?data:this["_"+lowerFirstChar(dataName)]}return getter.call(this)},descriptor.set=function(val){var physicsEngineAdapter=wd.PhysicsEngine.getInstance().physicsEngineAdapter;setter.call(this,val),isWorldDefined(physicsEngineAdapter)&&physicsEngineAdapter["set"+dataName](val)},descriptor}}function isWorldDefined(physicsEngineAdapter){return physicsEngineAdapter&&physicsEngineAdapter.world}function lowerFirstChar(str){var firstChar=str.slice(0,1);return""+firstChar.toLowerCase()+str.slice(1)}wd.operateBodyDataGetterAndSetter=operateBodyDataGetterAndSetter,wd.operateWorldDataGetterAndSetter=operateWorldDataGetterAndSetter}(wd||(wd={}));var wd;!function(wd){function script(scriptName){return function(target){wd.Script.addScript(scriptName,target)}}wd.script=script}(wd||(wd={}));var wd;!function(wd){function execOnlyOnce(flagName){return function(target,name,descriptor){var value=descriptor.value;return descriptor.value=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(!this[flagName])return this[flagName]=!0,value.apply(this,args)},descriptor}}wd.execOnlyOnce=execOnlyOnce}(wd||(wd={}));var wd;!function(wd){wd.ABSTRACT_ATTRIBUTE=null,wd.expect=chai.expect}(wd||(wd={}));var wd;!function(wd){var JudgeUtils=function(_super){function JudgeUtils(){_super.apply(this,arguments)}return __extends(JudgeUtils,_super),JudgeUtils.isView=function(obj){return!!obj&&obj.offset&&obj.width&&obj.height&&this.isFunction(obj.getContext)},JudgeUtils.isEqual=function(target1,target2){return!(!target1&&target2||target1&&!target2)&&(target1.uid&&target2.uid?target1.uid===target2.uid:target1===target2)},JudgeUtils.isPowerOfTwo=function(value){return 0===(value&value-1)&&0!==value},JudgeUtils.isFloatArray=function(data){return"[object Float32Array]"===wd.EntityObject.prototype.toString.call(data)||"[object Float16Array]"===wd.EntityObject.prototype.toString.call(data)},JudgeUtils.isInterface=function(target,memberOfInterface){return!!target[memberOfInterface]},JudgeUtils.isSpacePartitionObject=function(entityObject){return entityObject.hasComponent(wd.SpacePartition)},JudgeUtils.isSelf=function(self,entityObject){return self.uid===entityObject.uid},JudgeUtils.isComponenet=function(component){return void 0!==component.entityObject},JudgeUtils.isDom=function(obj){return null!==Object.prototype.toString.call(obj).match(/\[object HTML\w+/)},JudgeUtils.isCollection=function(list){return list instanceof wdCb.Collection},JudgeUtils}(wdCb.JudgeUtils);wd.JudgeUtils=JudgeUtils}(wd||(wd={}));var wd;!function(wd){var ArrayUtils=function(_super){function ArrayUtils(){_super.apply(this,arguments)}return __extends(ArrayUtils,_super),ArrayUtils.hasRepeatItems=function(arr){for(var noRepeatArr=[],hasRepeat=!1,_i=0,arr_1=arr;_i<arr_1.length;_i++){var item=arr_1[_i];if(item){if(this.contain(noRepeatArr,item)){hasRepeat=!0;break}noRepeatArr.push(item)}}return hasRepeat},ArrayUtils.contain=function(arr,item){for(var c=null,i=0,len=arr.length;i<len;i++){if(c=arr[i],item.uid&&c.uid&&item.uid==c.uid)return!0;if(item===c)return!0}return!1},ArrayUtils}(wdCb.ArrayUtils);wd.ArrayUtils=ArrayUtils}(wd||(wd={}));var wd;!function(wd){var ClassUtils=function(){function ClassUtils(){}return ClassUtils.getClassName=function(objInstance){return objInstance.constructor.name},__decorate([wd.require(function(objInstance){wd.assert(wd.JudgeUtils.isFunction(objInstance.constructor),wd.Log.info.FUNC_MUST_BE("objInstance.constructor","Function"))}),wd.ensure(function(className){wd.assert(!!className,wd.Log.info.FUNC_CAN_NOT("get class name from objInstance.constructor.name"))})],ClassUtils,"getClassName",null),ClassUtils}();wd.ClassUtils=ClassUtils}(wd||(wd={}));var wd;!function(wd){var SortUtils=function(){function SortUtils(){}return SortUtils.insertSort=function(targetArr,compareFunc,isChangeSelf){void 0===isChangeSelf&&(isChangeSelf=!1);for(var resultArr=isChangeSelf?targetArr:wdCb.ExtendUtils.extend([],targetArr),i=1,len=resultArr.length;i<len;i++)for(var j=i;j>0&&compareFunc(resultArr[j],resultArr[j-1]);j--)this._swap(resultArr,j-1,j);return resultArr},SortUtils.quickSort=function(targetArr,compareFunc,isChangeSelf){void 0===isChangeSelf&&(isChangeSelf=!1);var resultArr=isChangeSelf?targetArr:wdCb.ExtendUtils.extend([],targetArr),sort=function(l,r){if(!(l>=r)){for(var i=l,j=r,x=resultArr[l];i<j;){for(;i<j&&compareFunc(x,resultArr[j]);)j--;for(i<j&&(resultArr[i++]=resultArr[j]);i<j&&compareFunc(resultArr[i],x);)i++;i<j&&(resultArr[j--]=resultArr[i])}resultArr[i]=x,sort(l,i-1),sort(i+1,r)}};return sort(0,resultArr.length-1),resultArr},SortUtils._swap=function(children,i,j){var t=null;t=children[i],children[i]=children[j],children[j]=t},SortUtils}();wd.SortUtils=SortUtils}(wd||(wd={}));var wd;!function(wd){var MathUtils=function(){function MathUtils(){}return MathUtils.clamp=function(num,below,up){return num<below?below:num>up?up:num},MathUtils.bigThan=function(num,below){return num<below?below:num},MathUtils.generateZeroToOne=function(){return Math.random()},MathUtils.generateInteger=function(min,max){var max=max+1;return Math.floor(Math.random()*(max-min)+min)},MathUtils.mod=function(a,b){var n=Math.floor(a/b);return a-=n*b,a<0&&(a+=b),a},MathUtils.maxFloorIntegralMultiple=function(a,b){return 0==b?a:a<b?0:Math.floor(a/b)*b},__decorate([wd.require(function(min,max){wd.assert(min<max,wd.Log.info.FUNC_SHOULD("min","< max"))})],MathUtils,"generateInteger",null),__decorate([wd.ensure(function(val){wd.assert(val>=0)})],MathUtils,"mod",null),__decorate([wd.require(function(a,b){wd.assert(a>=0&&b>=0,wd.Log.info.FUNC_SHOULD("param",">= 0"))}),wd.ensure(function(val){wd.assert(val>=0)})],MathUtils,"maxFloorIntegralMultiple",null),MathUtils}();wd.MathUtils=MathUtils}(wd||(wd={}));var wd;!function(wd){var CoordinateUtils=function(){function CoordinateUtils(){}return CoordinateUtils.convertWebGLPositionToCanvasPosition=function(position){var view=wd.DeviceManager.getInstance().view;
return wd.Vector2.create(view.width/2+position.x,view.height/2-position.y)},CoordinateUtils.convertCanvasPositionToWebGLPosition=function(position){var view=wd.DeviceManager.getInstance().view;return wd.Vector3.create(position.x-view.width/2,view.height/2-position.y,0)},CoordinateUtils.convertLeftCornerPositionToCenterPositionInWebGL=function(position,width,height){return wd.Vector2.create(this.convertLeftCornerPositionXToCenterPositionXInWebGL(position.x,width),this.convertLeftCornerPositionYToCenterPositionYInWebGL(position.y,height))},CoordinateUtils.convertLeftCornerPositionXToCenterPositionXInWebGL=function(positionX,width){return positionX-width/2},CoordinateUtils.convertLeftCornerPositionYToCenterPositionYInWebGL=function(positionY,height){return positionY-height/2},CoordinateUtils.convertLeftCornerPositionToCenterPositionInCanvas=function(position,width,height){return wd.Vector2.create(this.convertLeftCornerPositionXToCenterPositionXInCanvas(position.x,width),this.convertLeftCornerPositionYToCenterPositionYInCanvas(position.y,height))},CoordinateUtils.convertLeftCornerPositionXToCenterPositionXInCanvas=function(positionX,width){return positionX+width/2},CoordinateUtils.convertLeftCornerPositionYToCenterPositionYInCanvas=function(positionY,height){return positionY+height/2},__decorate([wd.require(function(){wd.assert(!!wd.DeviceManager.getInstance().view,wd.Log.info.FUNC_SHOULD("set view"))})],CoordinateUtils,"convertWebGLPositionToCanvasPosition",null),__decorate([wd.require(function(){wd.assert(!!wd.DeviceManager.getInstance().view,wd.Log.info.FUNC_SHOULD("set view"))})],CoordinateUtils,"convertCanvasPositionToWebGLPosition",null),CoordinateUtils}();wd.CoordinateUtils=CoordinateUtils}(wd||(wd={}));var wd;!function(wd){var RenderUtils=function(){function RenderUtils(){}return RenderUtils.getGameObjectRenderList=function(sourceList){return sourceList.filter(function(child,index){return child.isVisible&&!wd.InstanceUtils.isObjectInstance(child)})},RenderUtils.getGameObjectRenderListForOctree=function(sourceList){return sourceList.filter(function(child){return child.isVisible})},RenderUtils}();wd.RenderUtils=RenderUtils}(wd||(wd={}));var wd;!function(wd){var InstanceUtils=function(){function InstanceUtils(){}return InstanceUtils.isHardwareSupport=function(){return null!==wd.GPUDetector.getInstance().extensionInstancedArrays},InstanceUtils.isInstance=function(gameObject){return gameObject.hasComponent(wd.Instance)},InstanceUtils.isSourceInstance=function(gameObject){return gameObject.hasComponent(wd.SourceInstance)},InstanceUtils.isObjectInstance=function(gameObject){return gameObject.hasComponent(wd.ObjectInstance)},InstanceUtils.addModelMatrixShaderLib=function(shader,gameObject){if(gameObject)return InstanceUtils.isInstance(gameObject)?InstanceUtils.isHardwareSupport()?void shader.addLib(wd.ModelMatrixHardwareInstanceShaderLib.create()):void shader.addLib(wd.ModelMatrixBatchInstanceShaderLib.create()):void shader.addLib(wd.ModelMatrixNoInstanceShaderLib.create())},InstanceUtils.addNormalModelMatrixShaderLib=function(shader,gameObject){if(gameObject)return InstanceUtils.isInstance(gameObject)?InstanceUtils.isHardwareSupport()?void shader.addLib(wd.NormalMatrixHardwareInstanceShaderLib.create()):void shader.addLib(wd.NormalMatrixBatchInstanceShaderLib.create()):void shader.addLib(wd.NormalMatrixNoInstanceShaderLib.create())},InstanceUtils}();wd.InstanceUtils=InstanceUtils}(wd||(wd={}));var wd;!function(wd){var IterateUtils=function(){function IterateUtils(){}return IterateUtils.forEachAll=function(entityObject,handler){var func=function(entityObject){handler(entityObject),entityObject.forEach(function(child){func(child)})};func(entityObject)},IterateUtils}();wd.IterateUtils=IterateUtils}(wd||(wd={}));var wd;!function(wd){var Log=function(_super){function Log(){_super.apply(this,arguments)}return __extends(Log,_super),Log}(wdCb.Log);wd.Log=Log}(wd||(wd={}));var wd;!function(wd){var GlobalGeometryUtils=function(){function GlobalGeometryUtils(){}return GlobalGeometryUtils.hasAnimation=function(geometry){return geometry instanceof wd.ModelGeometry&&geometry.hasAnimation()},GlobalGeometryUtils}();wd.GlobalGeometryUtils=GlobalGeometryUtils}(wd||(wd={}));var wd;!function(wd){var GlobalScriptUtils=function(){function GlobalScriptUtils(){}return GlobalScriptUtils.handlerAfterLoadedScript=function(entityObject){wd.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(entityObject,"onEnter"),wd.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(entityObject,"init")},GlobalScriptUtils.addScriptToEntityObject=function(entityObject,data){wd.ScriptEngine.getInstance().addChild(entityObject,data.name,new data.class(entityObject))},GlobalScriptUtils}();wd.GlobalScriptUtils=GlobalScriptUtils}(wd||(wd={}));var wd;!function(wd){var TimeController=function(){function TimeController(){this.elapsed=null,this.pauseElapsed=0,this.pauseTime=null,this.startTime=null}return TimeController.prototype.start=function(){this.startTime=this.getNow(),this.pauseElapsed=null},TimeController.prototype.stop=function(){this.startTime=null},TimeController.prototype.pause=function(){this.pauseTime=this.getNow()},TimeController.prototype.resume=function(){this.pauseElapsed+=this.getNow()-this.pauseTime,this.pauseTime=null},TimeController.prototype.computeElapseTime=function(time){return this.pauseElapsed?this.elapsed=time-this.pauseElapsed-this.startTime:this.elapsed=time-this.startTime,this.elapsed<0&&(this.elapsed=0),this.elapsed},__decorate([wd.ensure(function(){wd.assert(this.elapsed>=0,wd.Log.info.FUNC_SHOULD("elapsed:"+this.elapsed,">= 0"))})],TimeController.prototype,"computeElapseTime",null),TimeController}();wd.TimeController=TimeController}(wd||(wd={}));var wd;!function(wd){var STARTING_FPS=60,GAMETIME_SCALE=1e3,DirectorTimeController=function(_super){function DirectorTimeController(){_super.apply(this,arguments),this.gameTime=null,this.fps=null,this.isTimeChange=!1,this.deltaTime=null,this._lastTime=null}return __extends(DirectorTimeController,_super),DirectorTimeController.create=function(){var obj=new this;return obj},DirectorTimeController.prototype.tick=function(time){this.deltaTime=null!==this._lastTime?time-this._lastTime:time,this._updateFps(this.deltaTime),this.gameTime=time/GAMETIME_SCALE,this._lastTime=time},DirectorTimeController.prototype.start=function(){_super.prototype.start.call(this),this.isTimeChange=!0,this.elapsed=0},DirectorTimeController.prototype.resume=function(){_super.prototype.resume.call(this),this.isTimeChange=!0},DirectorTimeController.prototype.getNow=function(){return wd.root.performance.now()},DirectorTimeController.prototype._updateFps=function(deltaTime){null===this._lastTime?this.fps=STARTING_FPS:this.fps=1e3/deltaTime},DirectorTimeController}(wd.TimeController);wd.DirectorTimeController=DirectorTimeController}(wd||(wd={}));var wd;!function(wd){var CommonTimeController=function(_super){function CommonTimeController(){_super.apply(this,arguments)}return __extends(CommonTimeController,_super),CommonTimeController.create=function(){var obj=new this;return obj},CommonTimeController.prototype.getNow=function(){return wd.Director.getInstance().isTimeChange?wd.Director.getInstance().elapsed:wd.root.performance.now()},CommonTimeController}(wd.TimeController);wd.CommonTimeController=CommonTimeController}(wd||(wd={}));var wd;!function(wd){function cloneAttributeAsBasicType(configData){return generateCloneableMember(CloneType.BASIC,wdCb.ExtendUtils.extend({order:0},configData))}function cloneAttributeAsCloneable(configData){return generateCloneableMember(CloneType.CLONEABLE,wdCb.ExtendUtils.extend({order:0,isInjectTarget:!1},configData))}function cloneAttributeAsCustomType(cloneFunc,configData){return generateCloneableMember(CloneType.CUSTOM,cloneFunc,wdCb.ExtendUtils.extend({order:0},configData))}var NOT_CLONE_TAG="not_clone",getCloneAttributeMembers=function(obj){return obj[buildMemberContainerAttributeName(obj)]},setCloneAttributeMembers=function(obj,members){obj[buildMemberContainerAttributeName(obj)]=members},searchCloneAttributeMembers=function(obj){var CLONE_MEMBER_PREFIX="__decorator_clone",result=null;for(var memberName in obj)if(obj.hasOwnProperty(memberName)&&memberName.indexOf(CLONE_MEMBER_PREFIX)>-1){result=obj[memberName];break}return result},getAllCloneAttributeMembers=function(obj){var IS_GATHERED_ATTRIBUTE_NAME="__decorator_clone_isGathered_"+wd.ClassUtils.getClassName(obj)+"_cloneAttributeMembers",result=wdCb.Collection.create(),gather=function(obj){if(obj){if(obj[IS_GATHERED_ATTRIBUTE_NAME]){var members_1=getCloneAttributeMembers(obj);return wd.assert(members_1,wd.Log.info.FUNC_NOT_EXIST(""+buildMemberContainerAttributeName(obj))),void result.addChildren(members_1)}gather(obj.__proto__);var members=searchCloneAttributeMembers(obj);members&&result.addChildren(members)}},setGatheredResult=function(){setCloneAttributeMembers(obj.__proto__,result),obj.__proto__[IS_GATHERED_ATTRIBUTE_NAME]=!0};return gather(obj.__proto__),setGatheredResult(),getCloneAttributeMembers(obj)},initCloneAttributeMembers=function(obj){setCloneAttributeMembers(obj,wdCb.Collection.create())},buildMemberContainerAttributeName=function(obj){return"__decorator_clone_"+wd.ClassUtils.getClassName(obj)+"_cloneAttributeMembers"},generateCloneableMember=function(cloneType){for(var cloneDataArr=[],_i=1;_i<arguments.length;_i++)cloneDataArr[_i-1]=arguments[_i];return function(target,memberName){getCloneAttributeMembers(target)||initCloneAttributeMembers(target),1===cloneDataArr.length?getCloneAttributeMembers(target).addChild({memberName:memberName,cloneType:cloneType,configData:cloneDataArr[0]}):2===cloneDataArr.length&&getCloneAttributeMembers(target).addChild({memberName:memberName,cloneType:cloneType,cloneFunc:cloneDataArr[0],configData:cloneDataArr[1]})}};wd.cloneAttributeAsBasicType=cloneAttributeAsBasicType,wd.cloneAttributeAsCloneable=cloneAttributeAsCloneable,wd.cloneAttributeAsCustomType=cloneAttributeAsCustomType;var CloneUtils=function(){function CloneUtils(){}return CloneUtils.clone=function(source,cloneData,createDataArr){void 0===cloneData&&(cloneData=null),void 0===createDataArr&&(createDataArr=null);var cloneAttributeMembers=getAllCloneAttributeMembers(source).sort(function(memberDataA,memberDataB){return memberDataA.configData.order-memberDataB.configData.order}),className=wd.ClassUtils.getClassName(source),target=null;return target=createDataArr?wd[className].create.apply(wd[className],createDataArr):wd[className].create(),cloneAttributeMembers?(cloneAttributeMembers.forEach(function(memberData){var cloneType=memberData.cloneType,memberName=memberData.memberName;switch(cloneType){case CloneType.CLONEABLE:var configData=memberData.configData;null!==source[memberName]&&void 0!==source[memberName]&&(configData.isInjectTarget===!0?target[memberName]=source[memberName].clone(target):target[memberName]=source[memberName].clone());break;case CloneType.BASIC:target[memberName]=source[memberName];break;case CloneType.CUSTOM:var cloneFunc=memberData.cloneFunc;cloneFunc.call(target,source,target,memberName,cloneData)}}),target):target},CloneUtils.cloneArray=function(arr){return[].concat(arr)},CloneUtils.markNotClone=function(entityObject){entityObject.hasTag(NOT_CLONE_TAG)||entityObject.addTag(NOT_CLONE_TAG)},CloneUtils.isNotClone=function(entityObject){return entityObject.hasTag(NOT_CLONE_TAG)},__decorate([wd.require(function(source,cloneData,createDataArr){void 0===cloneData&&(cloneData=null),void 0===createDataArr&&(createDataArr=null),createDataArr&&wd.assert(wd.JudgeUtils.isArrayExactly(createDataArr),wd.Log.info.FUNC_MUST_BE("param:createDataArr","be arr"))})],CloneUtils,"clone",null),CloneUtils}();wd.CloneUtils=CloneUtils,function(CloneType){CloneType[CloneType.CLONEABLE=0]="CLONEABLE",CloneType[CloneType.BASIC=1]="BASIC",CloneType[CloneType.CUSTOM=2]="CUSTOM"}(wd.CloneType||(wd.CloneType={}));var CloneType=wd.CloneType}(wd||(wd={}));var wd;!function(wd){wd.DEG_TO_RAD=Math.PI/180,wd.RAD_TO_DEG=180/Math.PI}(wd||(wd={}));var wd;!function(wd){var Vector2=function(){function Vector2(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];this.values=new Float32Array(2),args.length>0&&(this.values[0]=args[0],this.values[1]=args[1])}return Vector2.create=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var m=null;return m=0===args.length?new this:new this(args[0],args[1])},Object.defineProperty(Vector2.prototype,"x",{get:function(){return this.values[0]},set:function(x){this.values[0]=x},enumerable:!0,configurable:!0}),Object.defineProperty(Vector2.prototype,"y",{get:function(){return this.values[1]},set:function(y){this.values[1]=y},enumerable:!0,configurable:!0}),Vector2.prototype.set=function(x,y){this.x=x,this.y=y},Vector2.prototype.add=function(v){return this.values[0]=this.values[0]+v.values[0],this.values[1]=this.values[1]+v.values[1],this},Vector2.prototype.mul=function(v){return this.values[0]=this.values[0]*v.values[0],this.values[1]=this.values[1]*v.values[1],this},Vector2.prototype.isEqual=function(v){return this.x===v.x&&this.y===v.y},Vector2.prototype.clone=function(){return Vector2.create(this.x,this.y)},Vector2}();wd.Vector2=Vector2}(wd||(wd={}));var wd;!function(wd){var Vector3=function(){function Vector3(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];this.values=null,this.values=new Float32Array(3),args.length>0&&(this.values[0]=args[0],this.values[1]=args[1],this.values[2]=args[2])}return Vector3.create=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var m=null;return m=0===args.length?new this:new this(args[0],args[1],args[2])},Object.defineProperty(Vector3.prototype,"x",{get:function(){return this.values[0]},set:function(x){this.values[0]=x},enumerable:!0,configurable:!0}),Object.defineProperty(Vector3.prototype,"y",{get:function(){return this.values[1]},set:function(y){this.values[1]=y},enumerable:!0,configurable:!0}),Object.defineProperty(Vector3.prototype,"z",{get:function(){return this.values[2]},set:function(z){this.values[2]=z},enumerable:!0,configurable:!0}),Vector3.prototype.normalize=function(){var v=this.values,d=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]);return 0===d?(v[0]=0,v[1]=0,v[2]=0,this):(v[0]=v[0]/d,v[1]=v[1]/d,v[2]=v[2]/d,v[0]===-0&&(v[0]=0),v[1]===-0&&(v[1]=0),v[2]===-0&&(v[2]=0),this)},Vector3.prototype.isZero=function(){var v=this.values;return 0===v[0]&&0===v[1]&&0===v[2]},Vector3.prototype.scale=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var v=this.values;if(1===args.length){var scalar=args[0];v[0]*=scalar,v[1]*=scalar,v[2]*=scalar}else if(3===args.length){var x=args[0],y=args[1],z=args[2];v[0]*=x,v[1]*=y,v[2]*=z}return this},Vector3.prototype.set=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(3===args.length)this.x=args[0],this.y=args[1],this.z=args[2];else{var v=args[0];this.x=v.x,this.y=v.y,this.z=v.z}},Vector3.prototype.sub=function(v){return this.values[0]=this.values[0]-v.values[0],this.values[1]=this.values[1]-v.values[1],this.values[2]=this.values[2]-v.values[2],this},Vector3.prototype.sub2=function(v1,v2){return this.values[0]=v1.values[0]-v2.values[0],this.values[1]=v1.values[1]-v2.values[1],this.values[2]=v1.values[2]-v2.values[2],this},Vector3.prototype.add=function(v){return this.values[0]=this.values[0]+v.values[0],this.values[1]=this.values[1]+v.values[1],this.values[2]=this.values[2]+v.values[2],this},Vector3.prototype.add2=function(v1,v2){return this.values[0]=v1.values[0]+v2.values[0],this.values[1]=v1.values[1]+v2.values[1],this.values[2]=v1.values[2]+v2.values[2],this},Vector3.prototype.mul=function(v){return this.values[0]=this.values[0]*v.values[0],this.values[1]=this.values[1]*v.values[1],this.values[2]=this.values[2]*v.values[2],this},Vector3.prototype.mul2=function(v1,v2){return this.values[0]=v1.values[0]*v2.values[0],this.values[1]=v1.values[1]*v2.values[1],this.values[2]=v1.values[2]*v2.values[2],this},Vector3.prototype.reverse=function(){return this.values[0]=-this.values[0],this.values[1]=-this.values[1],this.values[2]=-this.values[2],this},Vector3.prototype.clone=function(){var result=Vector3.create(),i=0,len=this.values.length;for(i=0;i<len;i++)result.values[i]=this.values[i];return result},Vector3.prototype.toVector4=function(){return wd.Vector4.create(this.values[0],this.values[1],this.values[2],1)},Vector3.prototype.length=function(){var v=this.values;return Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2])},Vector3.prototype.cross=function(lhs,rhs){var a,b,r,ax,ay,az,bx,by,bz;return a=lhs.values,b=rhs.values,r=this.values,ax=a[0],ay=a[1],az=a[2],bx=b[0],by=b[1],bz=b[2],r[0]=ay*bz-by*az,r[1]=az*bx-bz*ax,r[2]=ax*by-bx*ay,this},Vector3.prototype.lerp=function(lhs,rhs,alpha){var a=lhs.values,b=rhs.values,r=this.values;return r[0]=a[0]+alpha*(b[0]-a[0]),r[1]=a[1]+alpha*(b[1]-a[1]),r[2]=a[2]+alpha*(b[2]-a[2]),this},Vector3.prototype.dot=function(rhs){var a=this.values,b=rhs.values;return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},Vector3.prototype.calAngleCos=function(v1){var l=this.length()*v1.length();return 0===l?NaN:this.dot(v1)/l},Vector3.prototype.min=function(v){return this.x>v.x&&(this.x=v.x),this.y>v.y&&(this.y=v.y),this.z>v.z&&(this.z=v.z),this},Vector3.prototype.max=function(v){return this.x<v.x&&(this.x=v.x),this.y<v.y&&(this.y=v.y),this.z<v.z&&(this.z=v.z),this},Vector3.prototype.isEqual=function(v){return this.x===v.x&&this.y===v.y&&this.z===v.z},Vector3.prototype.toArray=function(){return[this.x,this.y,this.z]},Vector3.prototype.applyMatrix3=function(m){var x=this.x,y=this.y,z=this.z,e=m.values;return this.x=e[0]*x+e[3]*y+e[6]*z,this.y=e[1]*x+e[4]*y+e[7]*z,this.z=e[2]*x+e[5]*y+e[8]*z,this},Vector3.prototype.applyMatrix4=function(m){var x=this.x,y=this.y,z=this.z,e=m.values;return this.x=e[0]*x+e[4]*y+e[8]*z+e[12],this.y=e[1]*x+e[5]*y+e[9]*z+e[13],this.z=e[2]*x+e[6]*y+e[10]*z+e[14],this},Vector3.prototype.distanceTo=function(v){return Math.sqrt(this.distanceToSquared(v))},Vector3.prototype.distanceToSquared=function(v){var dx=this.x-v.x,dy=this.y-v.y,dz=this.z-v.z;return Math.pow(dx,2)+Math.pow(dy,2)+Math.pow(dz,2)},Vector3.up=Vector3.create(0,1,0),Vector3.forward=Vector3.create(0,0,1),Vector3.right=Vector3.create(1,0,0),Vector3}();wd.Vector3=Vector3}(wd||(wd={}));var wd;!function(wd){var Vector4=function(){function Vector4(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];this.values=new Float32Array(4),args.length>0&&(this.values[0]=args[0],this.values[1]=args[1],this.values[2]=args[2],this.values[3]=args[3])}return Vector4.create=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var m=null;return m=0===args.length?new this:new this(args[0],args[1],args[2],args[3])},Object.defineProperty(Vector4.prototype,"x",{get:function(){return this.values[0]},set:function(x){this.values[0]=x},enumerable:!0,configurable:!0}),Object.defineProperty(Vector4.prototype,"y",{get:function(){return this.values[1]},set:function(y){this.values[1]=y},enumerable:!0,configurable:!0}),Object.defineProperty(Vector4.prototype,"z",{get:function(){return this.values[2]},set:function(z){this.values[2]=z},enumerable:!0,configurable:!0}),Object.defineProperty(Vector4.prototype,"w",{get:function(){return this.values[3]},set:function(w){this.values[3]=w},enumerable:!0,configurable:!0}),Vector4.prototype.normalize=function(){var v=this.values,d=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]+v[3]*v[3]);return 0===d?Vector4.create(0,0,0,0):(v[0]=v[0]/d,v[1]=v[1]/d,v[2]=v[2]/d,v[3]=v[3]/d,this)},Vector4.prototype.isEqual=function(v){return this.x===v.x&&this.y===v.y&&this.z===v.z&&this.w===v.w},Vector4.prototype.clone=function(){return this.copyHelper(Vector4.create())},Vector4.prototype.toVector3=function(){return wd.Vector3.create(this.values[0],this.values[1],this.values[2])},Vector4.prototype.multiplyScalar=function(scalar){return this.x*=scalar,this.y*=scalar,this.z*=scalar,this.w*=scalar,this},Vector4.prototype.dot=function(v){return this.x*v.x+this.y*v.y+this.z*v.z+this.w*v.w},Vector4.prototype.set=function(x,y,z,w){this.x=x,this.y=y,this.z=z,this.w=w},Vector4.prototype.copyHelper=function(vector4){var result=vector4,i=0,len=this.values.length;for(i=0;i<len;i++)result.values[i]=this.values[i];return result},Vector4}();wd.Vector4=Vector4}(wd||(wd={}));var wd;!function(wd){var Matrix4=function(){function Matrix4(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];this.values=null,this._matrixArr=null,1===args.length?this.values=args[0]:this.values=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._matrixArr=[]}return Matrix4.create=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var m=null;return m=0===args.length?new this:new this(args[0])},Matrix4.prototype.push=function(){this._matrixArr.push(this.values)},Matrix4.prototype.pop=function(){this.values=this._matrixArr.pop()},Matrix4.prototype.set=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var te=this.values,values=null;if(1===args.length){var matrix=args[0];values=matrix.values}else values=[args[0],args[1],args[2],args[3],args[4],args[5],args[6],args[7],args[8],args[9],args[10],args[11],args[12],args[13],args[14],args[15]];return te[0]=values[0],te[1]=values[1],te[2]=values[2],te[3]=values[3],te[4]=values[4],te[5]=values[5],te[6]=values[6],te[7]=values[7],te[8]=values[8],te[9]=values[9],te[10]=values[10],te[11]=values[11],te[12]=values[12],te[13]=values[13],te[14]=values[14],te[15]=values[15],this},Matrix4.prototype.setIdentity=function(){var e=this.values;return e[0]=1,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=1,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1,this},Matrix4.prototype.invert=function(){var a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,a30,a31,a32,a33,b00,b01,b02,b03,b04,b05,b06,b07,b08,b09,b10,b11,invDet,m;return m=this.values,a00=m[0],a01=m[1],a02=m[2],a03=m[3],a10=m[4],a11=m[5],a12=m[6],a13=m[7],a20=m[8],a21=m[9],a22=m[10],a23=m[11],a30=m[12],a31=m[13],a32=m[14],a33=m[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,invDet=1/(b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06),m[0]=(a11*b11-a12*b10+a13*b09)*invDet,m[1]=(-a01*b11+a02*b10-a03*b09)*invDet,m[2]=(a31*b05-a32*b04+a33*b03)*invDet,m[3]=(-a21*b05+a22*b04-a23*b03)*invDet,m[4]=(-a10*b11+a12*b08-a13*b07)*invDet,m[5]=(a00*b11-a02*b08+a03*b07)*invDet,m[6]=(-a30*b05+a32*b02-a33*b01)*invDet,m[7]=(a20*b05-a22*b02+a23*b01)*invDet,m[8]=(a10*b10-a11*b08+a13*b06)*invDet,m[9]=(-a00*b10+a01*b08-a03*b06)*invDet,m[10]=(a30*b04-a31*b02+a33*b00)*invDet,m[11]=(-a20*b04+a21*b02-a23*b00)*invDet,m[12]=(-a10*b09+a11*b07-a12*b06)*invDet,m[13]=(a00*b09-a01*b07+a02*b06)*invDet,m[14]=(-a30*b03+a31*b01-a32*b00)*invDet,m[15]=(a20*b03-a21*b01+a22*b00)*invDet,this},Matrix4.prototype.invertTo3x3=function(){var a11,a21,a31,a12,a22,a32,a13,a23,a33,m,r,det,idet,mat3=wd.Matrix3.create();return m=this.values,r=mat3.values,a11=m[10]*m[5]-m[6]*m[9],a21=-m[10]*m[1]+m[2]*m[9],a31=m[6]*m[1]-m[2]*m[5],a12=-m[10]*m[4]+m[6]*m[8],a22=m[10]*m[0]-m[2]*m[8],a32=-m[6]*m[0]+m[2]*m[4],a13=m[9]*m[4]-m[5]*m[8],a23=-m[9]*m[0]+m[1]*m[8],a33=m[5]*m[0]-m[1]*m[4],det=m[0]*a11+m[1]*a12+m[2]*a13,0===det?(wd.Log.warn("can't invert matrix, determinant is 0"),mat3):(idet=1/det,r[0]=idet*a11,r[1]=idet*a21,r[2]=idet*a31,r[3]=idet*a12,r[4]=idet*a22,r[5]=idet*a32,r[6]=idet*a13,r[7]=idet*a23,r[8]=idet*a33,mat3)},Matrix4.prototype.transpose=function(){var tmp,te=this.values;return tmp=te[1],te[1]=te[4],te[4]=tmp,tmp=te[2],te[2]=te[8],te[8]=tmp,tmp=te[6],te[6]=te[9],te[9]=tmp,tmp=te[3],te[3]=te[12],te[12]=tmp,tmp=te[7],te[7]=te[13],te[13]=tmp,tmp=te[11],te[11]=te[14],te[14]=tmp,this},Matrix4.prototype.setTranslate=function(x,y,z){var e=this.values;return e[0]=1,e[4]=0,e[8]=0,e[12]=x,e[1]=0,e[5]=1,e[9]=0,e[13]=y,e[2]=0,e[6]=0,e[10]=1,e[14]=z,e[3]=0,e[7]=0,e[11]=0,e[15]=1,this},Matrix4.prototype.translate=function(x,y,z){return this.applyMatrix(Matrix4.create().setTranslate(x,y,z)),this},Matrix4.prototype.setRotate=function(angle,x,y,z){var e,s,c,len,rlen,nc,xy,yz,zx,xs,ys,zs,angle=Math.PI*angle/180;return e=this.values,s=Math.sin(angle),c=Math.cos(angle),0!==x&&0===y&&0===z?(x<0&&(s=-s),e[0]=1,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=c,e[9]=-s,e[13]=0,e[2]=0,e[6]=s,e[10]=c,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1):0===x&&0!==y&&0===z?(y<0&&(s=-s),e[0]=c,e[4]=0,e[8]=s,e[12]=0,e[1]=0,e[5]=1,e[9]=0,e[13]=0,e[2]=-s,e[6]=0,e[10]=c,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1):0===x&&0===y&&0!==z?(z<0&&(s=-s),e[0]=c,e[4]=-s,e[8]=0,e[12]=0,e[1]=s,e[5]=c,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1):(len=Math.sqrt(x*x+y*y+z*z),1!==len&&(rlen=1/len,x*=rlen,y*=rlen,z*=rlen),nc=1-c,xy=x*y,yz=y*z,zx=z*x,xs=x*s,ys=y*s,zs=z*s,e[0]=x*x*nc+c,e[1]=xy*nc+zs,e[2]=zx*nc-ys,e[3]=0,e[4]=xy*nc-zs,e[5]=y*y*nc+c,e[6]=yz*nc+xs,e[7]=0,e[8]=zx*nc+ys,e[9]=yz*nc-xs,e[10]=z*z*nc+c,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1),this},Matrix4.prototype.rotate=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var angle=args[0];if(2===args.length){var vector3=args[1];this.applyMatrix(Matrix4.create().setRotate(angle,vector3.values[0],vector3.values[1],vector3.values[2]))}else if(4===args.length){var x=args[1],y=args[2],z=args[3];this.applyMatrix(Matrix4.create().setRotate(angle,x,y,z))}return this},Matrix4.prototype.setScale=function(x,y,z){var e=this.values;return e[0]=x,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=y,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=z,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1,this},Matrix4.prototype.scale=function(x,y,z){return this.applyMatrix(Matrix4.create().setScale(x,y,z)),this},Matrix4.prototype.setLookAt=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var x,y,z,eye,center,up;3===args.length?(eye=args[0],center=args[1],up=args[2]):9===args.length&&(eye=wd.Vector3.create(args[0],args[1],args[2]),center=wd.Vector3.create(args[3],args[4],args[5]),up=wd.Vector3.create(args[6],args[7],args[8])),x=wd.Vector3.create(),z=eye.clone().sub(center).normalize(),y=up.clone().normalize(),x.cross(y,z).normalize(),y.cross(z,x);var r=this.values;return r[0]=x.x,r[1]=x.y,r[2]=x.z,r[3]=0,r[4]=y.x,r[5]=y.y,r[6]=y.z,r[7]=0,r[8]=z.x,r[9]=z.y,r[10]=z.z,r[11]=0,r[12]=eye.x,r[13]=eye.y,r[14]=eye.z,r[15]=1,this},Matrix4.prototype.lookAt=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var matrix=Matrix4.create();return this.applyMatrix(matrix.setLookAt.apply(matrix,args)),this},Matrix4.prototype.setOrtho=function(left,right,bottom,top,near,far){var rw,rh,rd,e=this.values;return rw=1/(right-left),rh=1/(top-bottom),rd=1/(far-near),e[0]=2*rw,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*rh,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=-2*rd,e[11]=0,e[12]=-(right+left)*rw,e[13]=-(top+bottom)*rh,e[14]=-(far+near)*rd,e[15]=1,this},Matrix4.prototype.ortho=function(left,right,bottom,top,near,far){return this.applyMatrix(Matrix4.create().setOrtho(left,right,bottom,top,near,far)),this},Matrix4.prototype.setPerspective=function(fovy,aspect,near,far){var e=null,rd=null,s=null,ct=null,fovy=Math.PI*fovy/180/2;return s=Math.sin(fovy),wd.Log.error(0===s,wd.Log.info.FUNC_MUST_NOT_BE("frustum","null")),rd=1/(far-near),ct=Math.cos(fovy)/s,e=this.values,e[0]=ct/aspect,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=ct,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=-(far+near)*rd,e[11]=-1,e[12]=0,e[13]=0,e[14]=-2*near*far*rd,e[15]=0,this},Matrix4.prototype.perspective=function(fovy,aspect,near,far){return this.applyMatrix(Matrix4.create().setPerspective(fovy,aspect,near,far)),this},Matrix4.prototype.applyMatrix=function(other,notChangeSelf){void 0===notChangeSelf&&(notChangeSelf=!1);var a=this,b=other.clone();return notChangeSelf?b.multiply(a):(this.values=b.multiply(a).values,this)},Matrix4.prototype.multiply=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var mat1=null,mat2=null,result=null;result=this.values,1===args.length?(mat1=this.values,mat2=args[0].values):2===args.length&&(mat1=args[0].values,mat2=args[1].values);var a=mat1[0],b=mat1[1],c=mat1[2],d=mat1[3],e=mat1[4],f=mat1[5],g=mat1[6],h=mat1[7],i=mat1[8],j=mat1[9],k=mat1[10],l=mat1[11],m=mat1[12],n=mat1[13],o=mat1[14],p=mat1[15],A=mat2[0],B=mat2[1],C=mat2[2],D=mat2[3],E=mat2[4],F=mat2[5],G=mat2[6],H=mat2[7],I=mat2[8],J=mat2[9],K=mat2[10],L=mat2[11],M=mat2[12],N=mat2[13],O=mat2[14],P=mat2[15];return result[0]=A*a+B*e+C*i+D*m,result[1]=A*b+B*f+C*j+D*n,result[2]=A*c+B*g+C*k+D*o,result[3]=A*d+B*h+C*l+D*p,result[4]=E*a+F*e+G*i+H*m,result[5]=E*b+F*f+G*j+H*n,result[6]=E*c+F*g+G*k+H*o,result[7]=E*d+F*h+G*l+H*p,result[8]=I*a+J*e+K*i+L*m,result[9]=I*b+J*f+K*j+L*n,result[10]=I*c+J*g+K*k+L*o,result[11]=I*d+J*h+K*l+L*p,result[12]=M*a+N*e+O*i+P*m,result[13]=M*b+N*f+O*j+P*n,result[14]=M*c+N*g+O*k+P*o,result[15]=M*d+N*h+O*l+P*p,this},Matrix4.prototype.multiplyVector4=function(vector){var mat1=this.values,vec4=vector.values,result=[];return result[0]=vec4[0]*mat1[0]+vec4[1]*mat1[4]+vec4[2]*mat1[8]+vec4[3]*mat1[12],result[1]=vec4[0]*mat1[1]+vec4[1]*mat1[5]+vec4[2]*mat1[9]+vec4[3]*mat1[13],result[2]=vec4[0]*mat1[2]+vec4[1]*mat1[6]+vec4[2]*mat1[10]+vec4[3]*mat1[14],result[3]=vec4[0]*mat1[3]+vec4[1]*mat1[7]+vec4[2]*mat1[11]+vec4[3]*mat1[15],wd.Vector4.create(result[0],result[1],result[2],result[3])},Matrix4.prototype.multiplyVector3=function(vector){var mat1=this.values,vec3=vector.values,result=[];return result[0]=vec3[0]*mat1[0]+vec3[1]*mat1[4]+vec3[2]*mat1[8],result[1]=vec3[0]*mat1[1]+vec3[1]*mat1[5]+vec3[2]*mat1[9],result[2]=vec3[0]*mat1[2]+vec3[1]*mat1[6]+vec3[2]*mat1[10],wd.Vector3.create(result[0],result[1],result[2])},Matrix4.prototype.multiplyPoint=function(vector){var mat1=this.values,vec3=vector.values,result=[];return result[0]=vec3[0]*mat1[0]+vec3[1]*mat1[4]+vec3[2]*mat1[8]+mat1[12],result[1]=vec3[0]*mat1[1]+vec3[1]*mat1[5]+vec3[2]*mat1[9]+mat1[13],result[2]=vec3[0]*mat1[2]+vec3[1]*mat1[6]+vec3[2]*mat1[10]+mat1[14],wd.Vector3.create(result[0],result[1],result[2])},Matrix4.prototype.clone=function(){var result=Matrix4.create(),i=0,len=this.values.length;for(i=0;i<len;i++)result.values[i]=this.values[i];return result},Matrix4.prototype.cloneToArray=function(array,offset){void 0===offset&&(offset=0);for(var values=this.values,index=0;index<16;index++)array[offset+index]=values[index];return this},Matrix4.prototype.getX=function(){return wd.Vector3.create(this.values[0],this.values[1],this.values[2])},Matrix4.prototype.getY=function(){return wd.Vector3.create(this.values[4],this.values[5],this.values[6])},Matrix4.prototype.getZ=function(){return wd.Vector3.create(this.values[8],this.values[9],this.values[10])},Matrix4.prototype.getTranslation=function(){return wd.Vector3.create(this.values[12],this.values[13],this.values[14])},Matrix4.prototype.getScale=function(){return wd.Vector3.create(this.getX().length(),this.getY().length(),this.getZ().length())},Matrix4.prototype.getRotation=function(){return wd.Quaternion.create().setFromMatrix(this)},Matrix4.prototype.getEulerAngles=function(){var x,y,z,sx,sy,sz,m,halfPi,scale=this.getScale();return sx=scale.x,sy=scale.y,sz=scale.z,m=this.values,y=Math.asin(-m[2]/sx),halfPi=.5*Math.PI,y<halfPi?y>-halfPi?(x=Math.atan2(m[6]/sy,m[10]/sz),z=Math.atan2(m[1]/sx,m[0]/sx)):(z=0,x=-Math.atan2(m[4]/sy,m[5]/sy)):(z=0,x=Math.atan2(m[4]/sy,m[5]/sy)),wd.Vector3.create(x,y,z).scale(wd.RAD_TO_DEG)},Matrix4.prototype.setTRS=function(t,r,s){var tx,ty,tz,qx,qy,qz,qw,sx,sy,sz,x2,y2,z2,xx,xy,xz,yy,yz,zz,wx,wy,wz,m;return tx=t.x,ty=t.y,tz=t.z,qx=r.x,qy=r.y,qz=r.z,qw=r.w,sx=s.x,sy=s.y,sz=s.z,x2=qx+qx,y2=qy+qy,z2=qz+qz,xx=qx*x2,xy=qx*y2,xz=qx*z2,yy=qy*y2,yz=qy*z2,zz=qz*z2,wx=qw*x2,wy=qw*y2,wz=qw*z2,m=this.values,m[0]=(1-(yy+zz))*sx,m[1]=(xy+wz)*sx,m[2]=(xz-wy)*sx,m[3]=0,
m[4]=(xy-wz)*sy,m[5]=(1-(xx+zz))*sy,m[6]=(yz+wx)*sy,m[7]=0,m[8]=(xz+wy)*sz,m[9]=(yz-wx)*sz,m[10]=(1-(xx+yy))*sz,m[11]=0,m[12]=tx,m[13]=ty,m[14]=tz,m[15]=1,this},__decorate([wd.require(function(left,right,bottom,top,near,far){wd.assert(left!==right&&bottom!==top&&near!==far,wd.Log.info.FUNC_MUST_NOT_BE("frustum","null"))})],Matrix4.prototype,"setOrtho",null),__decorate([wd.require(function(fovy,aspect,near,far){wd.assert(near!==far&&0!==aspect,wd.Log.info.FUNC_MUST_NOT_BE("frustum","null")),wd.assert(near>0,wd.Log.info.FUNC_MUST("near","> 0")),wd.assert(far>0,wd.Log.info.FUNC_MUST("far","> 0"))})],Matrix4.prototype,"setPerspective",null),Matrix4}();wd.Matrix4=Matrix4}(wd||(wd={}));var wd;!function(wd){var Matrix3=function(){function Matrix3(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];this.values=null,1===args.length?this.values=args[0]:this.values=new Float32Array([1,0,0,0,1,0,0,0,1])}return Matrix3.create=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var m=null;return m=0===args.length?new this:new this(args[0])},Object.defineProperty(Matrix3.prototype,"a",{get:function(){return this.values[0]},set:function(a){this.values[0]=a},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"c",{get:function(){return this.values[1]},set:function(c){this.values[1]=c},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"b",{get:function(){return this.values[3]},set:function(b){this.values[3]=b},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"d",{get:function(){return this.values[4]},set:function(d){this.values[4]=d},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"tx",{get:function(){return this.values[6]},set:function(tx){this.values[6]=tx},enumerable:!0,configurable:!0}),Object.defineProperty(Matrix3.prototype,"ty",{get:function(){return this.values[7]},set:function(ty){this.values[7]=ty},enumerable:!0,configurable:!0}),Matrix3.prototype.setIdentity=function(){var e=this.values;return e[0]=1,e[3]=0,e[6]=0,e[1]=0,e[4]=1,e[7]=0,e[2]=0,e[5]=0,e[8]=1,this},Matrix3.prototype.invert=function(){var a1=this.values[0],b1=this.values[1],c1=this.values[3],d1=this.values[4],tx1=this.values[6],ty1=this.values[7],n=a1*d1-b1*c1;return this.values[0]=d1/n,this.values[1]=-b1/n,this.values[3]=-c1/n,this.values[4]=a1/n,this.values[6]=(c1*ty1-d1*tx1)/n,this.values[7]=-(a1*ty1-b1*tx1)/n,this},Matrix3.prototype.multiplyScalar=function(s){var te=this.values;return te[0]*=s,te[3]*=s,te[6]*=s,te[1]*=s,te[4]*=s,te[7]*=s,te[2]*=s,te[5]*=s,te[8]*=s,this},Matrix3.prototype.multiplyVector2=function(vector){var x=vector.x,y=vector.y,result=wd.Vector2.create(),e=this.values;return result.x=e[0]*x+e[3]*y,result.y=e[1]*x+e[4]*y,result},Matrix3.prototype.multiplyPoint=function(vector){var x=vector.x,y=vector.y,result=wd.Vector2.create(),e=this.values;return result.x=e[0]*x+e[3]*y+this.tx,result.y=e[1]*x+e[4]*y+this.ty,result},Matrix3.prototype.multiply=function(matrix){var m11=this.a*matrix.a+this.c*matrix.b,m12=this.b*matrix.a+this.d*matrix.b,m21=this.a*matrix.c+this.c*matrix.d,m22=this.b*matrix.c+this.d*matrix.d,dx=this.a*matrix.tx+this.c*matrix.ty+this.tx,dy=this.b*matrix.tx+this.d*matrix.ty+this.ty;return this.a=m11,this.b=m12,this.c=m21,this.d=m22,this.tx=dx,this.ty=dy,this},Matrix3.prototype.transpose=function(){var tmp,m=this.values;return tmp=m[1],m[1]=m[3],m[3]=tmp,tmp=m[2],m[2]=m[6],m[6]=tmp,tmp=m[5],m[5]=m[7],m[7]=tmp,this},Matrix3.prototype.clone=function(){return Matrix3.create().set(this)},Matrix3.prototype.cloneToArray=function(array,offset){void 0===offset&&(offset=0);for(var values=this.values,index=0;index<9;index++)array[offset+index]=values[index];return this},Matrix3.prototype.set=function(matrix){var te=this.values,values=matrix.values;return te[0]=values[0],te[3]=values[3],te[6]=values[6],te[1]=values[1],te[4]=values[4],te[7]=values[7],te[2]=values[2],te[5]=values[5],te[8]=values[8],this},Matrix3.prototype.setTS=function(t,s){this.setPosition(t.x,t.y),this.setScale(s.x,s.y)},Matrix3.prototype.rotate=function(angle){var rad=angle*wd.DEG_TO_RAD,c=Math.cos(rad),s=Math.sin(rad),m11=this.a*c+this.c*s,m12=this.b*c+this.d*s,m21=this.a*-s+this.c*c,m22=this.b*-s+this.d*c;return this.a=m11,this.b=m12,this.c=m21,this.d=m22,this},Matrix3.prototype.setRotation=function(angle){var rad=angle*wd.DEG_TO_RAD,cos_a=Math.cos(rad),sin_a=Math.sin(rad),values=this.values;return values[0]=cos_a,values[1]=-sin_a,values[3]=sin_a,values[4]=cos_a,this},Matrix3.prototype.translate=function(x,y){this.tx+=this.a*x+this.c*y,this.ty+=this.b*x+this.d*y},Matrix3.prototype.setPosition=function(x,y){this.tx=x,this.ty=y},Matrix3.prototype.scale=function(x,y){return this.a*=x,this.b*=x,this.c*=y,this.d*=y,this},Matrix3.prototype.setScale=function(x,y){var values=this.values;return values[0]=x,values[4]=y,this},Matrix3.prototype.getTranslation=function(){return wd.Vector2.create(this.tx,this.ty)},Matrix3.prototype.getScale=function(){return wd.Vector2.create(Math.sqrt(this.a*this.a+this.b*this.b),Math.sqrt(this.c*this.c+this.d*this.d))},Matrix3.prototype.getRotation=function(){return this._getSkewX()},Matrix3.prototype.getSkew=function(){return wd.Vector2.create(this._getSkewX(),this._getSkewY())},Matrix3.prototype._getDeltaTransformPoint=function(matrix,point){return{x:point.x*matrix.a+point.y*matrix.c+0,y:point.x*matrix.b+point.y*matrix.d+0}},Matrix3.prototype._getSkewX=function(){var px=this._getDeltaTransformPoint(this,{x:0,y:1});return 180/Math.PI*Math.atan2(px.y,px.x)-90},Matrix3.prototype._getSkewY=function(){var py=this._getDeltaTransformPoint(this,{x:1,y:0});return 180/Math.PI*Math.atan2(py.y,py.x)},Matrix3}();wd.Matrix3=Matrix3}(wd||(wd={}));var wd;!function(wd){var Quaternion=function(){function Quaternion(x,y,z,w){void 0===x&&(x=0),void 0===y&&(y=0),void 0===z&&(z=0),void 0===w&&(w=1),this.x=null,this.y=null,this.z=null,this.w=null,this.x=x,this.y=y,this.z=z,this.w=w}return Quaternion.create=function(x,y,z,w){var obj=new this(x,y,z,w);return obj},Quaternion.prototype.setFromEulerAngles=function(eulerAngles){var sx,cx,sy,cy,sz,cz,halfToRad,ex=eulerAngles.x,ey=eulerAngles.y,ez=eulerAngles.z;return halfToRad=.5*wd.DEG_TO_RAD,ex*=halfToRad,ey*=halfToRad,ez*=halfToRad,sx=Math.sin(ex),cx=Math.cos(ex),sy=Math.sin(ey),cy=Math.cos(ey),sz=Math.sin(ez),cz=Math.cos(ez),this.x=sx*cy*cz-cx*sy*sz,this.y=cx*sy*cz+sx*cy*sz,this.z=cx*cy*sz-sx*sy*cz,this.w=cx*cy*cz+sx*sy*sz,this},Quaternion.prototype.multiply=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var q1x,q1y,q1z,q1w,q2x,q2y,q2z,q2w,rhs1,rhs2,result=this;return 1===args.length?(rhs1=this,rhs2=args[0]):2===args.length&&(rhs1=args[0],rhs2=args[1]),q1x=rhs1.x,q1y=rhs1.y,q1z=rhs1.z,q1w=rhs1.w,q2x=rhs2.x,q2y=rhs2.y,q2z=rhs2.z,q2w=rhs2.w,result.x=q1w*q2x+q1x*q2w+q1y*q2z-q1z*q2y,result.y=q1w*q2y+q1y*q2w+q1z*q2x-q1x*q2z,result.z=q1w*q2z+q1z*q2w+q1x*q2y-q1y*q2x,result.w=q1w*q2w-q1x*q2x-q1y*q2y-q1z*q2z,result},Quaternion.prototype.setFromMatrix=function(matrix){var m00,m01,m02,m10,m11,m12,m20,m21,m22,tr,s,rs,lx,ly,lz,m;return m=matrix.values,m00=m[0],m01=m[1],m02=m[2],m10=m[4],m11=m[5],m12=m[6],m20=m[8],m21=m[9],m22=m[10],lx=1/Math.sqrt(m00*m00+m01*m01+m02*m02),ly=1/Math.sqrt(m10*m10+m11*m11+m12*m12),lz=1/Math.sqrt(m20*m20+m21*m21+m22*m22),m00*=lx,m01*=lx,m02*=lx,m10*=ly,m11*=ly,m12*=ly,m20*=lz,m21*=lz,m22*=lz,tr=m00+m11+m22,tr>=0?(s=Math.sqrt(tr+1),this.w=.5*s,s=.5/s,this.x=(m12-m21)*s,this.y=(m20-m02)*s,this.z=(m01-m10)*s):m00>m11?m00>m22?(rs=m00-(m11+m22)+1,rs=Math.sqrt(rs),this.x=.5*rs,rs=.5/rs,this.w=(m12-m21)*rs,this.y=(m01+m10)*rs,this.z=(m02+m20)*rs):(rs=m22-(m00+m11)+1,rs=Math.sqrt(rs),this.z=.5*rs,rs=.5/rs,this.w=(m01-m10)*rs,this.x=(m20+m02)*rs,this.y=(m21+m12)*rs):m11>m22?(rs=m11-(m22+m00)+1,rs=Math.sqrt(rs),this.y=.5*rs,rs=.5/rs,this.w=(m20-m02)*rs,this.z=(m12+m21)*rs,this.x=(m10+m01)*rs):(rs=m22-(m00+m11)+1,rs=Math.sqrt(rs),this.z=.5*rs,rs=.5/rs,this.w=(m01-m10)*rs,this.x=(m20+m02)*rs,this.y=(m21+m12)*rs),this},Quaternion.prototype.setFromAxisAngle=function(angle,axis){var sa,ca;return axis=axis.normalize(),angle*=.5*wd.DEG_TO_RAD,sa=Math.sin(angle),ca=Math.cos(angle),this.x=sa*axis.x,this.y=sa*axis.y,this.z=sa*axis.z,this.w=ca,this},Quaternion.prototype.invert=function(){return this.conjugate().normalize()},Quaternion.prototype.conjugate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},Quaternion.prototype.clone=function(){return Quaternion.create(this.x,this.y,this.z,this.w)},Quaternion.prototype.normalize=function(){var len=this.length();return 0===len?(this.x=this.y=this.z=0,this.w=1):(len=1/len,this.x*=len,this.y*=len,this.z*=len,this.w*=len),this},Quaternion.prototype.length=function(){var x,y,z,w;return x=this.x,y=this.y,z=this.z,w=this.w,Math.sqrt(x*x+y*y+z*z+w*w)},Quaternion.prototype.multiplyVector3=function(vector){var q=this,x=vector.x,y=vector.y,z=vector.z,qx=q.x,qy=q.y,qz=q.z,qw=q.w,ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;return wd.Vector3.create(ix*qw+iw*-qx+iy*-qz-iz*-qy,iy*qw+iw*-qy+iz*-qx-ix*-qz,iz*qw+iw*-qz+ix*-qy-iy*-qx)},Quaternion.prototype.set=function(x,y,z,w){this.x=x,this.y=y,this.z=z,this.w=w},Quaternion.prototype.sub=function(quat){var result=quat.clone().invert().multiply(this);return this.set(result.x,result.y,result.z,result.w),this},Quaternion.prototype.getEulerAngles=function(){var x,y,z,qx,qy,qz,qw,a2;return qx=this.x,qy=this.y,qz=this.z,qw=this.w,a2=2*(qw*qy-qx*qz),a2<=-.99999?(x=2*Math.atan2(qx,qw),y=-Math.PI/2,z=0):a2>=.99999?(x=2*Math.atan2(qx,qw),y=Math.PI/2,z=0):(x=Math.atan2(2*(qw*qx+qy*qz),1-2*(qx*qx+qy*qy)),y=Math.asin(a2),z=Math.atan2(2*(qw*qz+qx*qy),1-2*(qy*qy+qz*qz))),wd.Vector3.create(x,y,z).scale(wd.RAD_TO_DEG)},Quaternion.prototype.slerp=function(left,right,amount){var num2,num3,num=amount,num4=left.x*right.x+left.y*right.y+left.z*right.z+left.w*right.w,flag=!1;if(num4<0&&(flag=!0,num4=-num4),num4>.999999)num3=1-num,num2=flag?-num:num;else{var num5=Math.acos(num4),num6=1/Math.sin(num5);num3=Math.sin((1-num)*num5)*num6,num2=flag?-Math.sin(num*num5)*num6:Math.sin(num*num5)*num6}return Quaternion.create(num3*left.x+num2*right.x,num3*left.y+num2*right.y,num3*left.z+num2*right.z,num3*left.w+num2*right.w)},Quaternion}();wd.Quaternion=Quaternion}(wd||(wd={}));var wd;!function(wd){var Plane=function(){function Plane(a,b,c,d){this.normal=wd.Vector3.create(0,1,0),this.d=0,this.normal=wd.Vector3.create(a,b,c),this.d=d}return Plane.create=function(a,b,c,d){var obj=new this(a,b,c,d);return obj},Plane.prototype.getReflectionMatrix=function(){this.normalize();var x=this.normal.x,y=this.normal.y,z=this.normal.z,temp=-2*x,temp2=-2*y,temp3=-2*z,result=wd.Matrix4.create();return result.values[0]=temp*x+1,result.values[1]=temp2*x,result.values[2]=temp3*x,result.values[3]=0,result.values[4]=temp*y,result.values[5]=temp2*y+1,result.values[6]=temp3*y,result.values[7]=0,result.values[8]=temp*z,result.values[9]=temp2*z,result.values[10]=temp3*z+1,result.values[11]=0,result.values[12]=temp*this.d,result.values[13]=temp2*this.d,result.values[14]=temp3*this.d,result.values[15]=1,result},Plane.prototype.normalize=function(){var norm=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),magnitude=0;return 0!==norm&&(magnitude=1/norm),this.normal.x*=magnitude,this.normal.y*=magnitude,this.normal.z*=magnitude,this.d*=magnitude,this},Plane.prototype.clone=function(){return Plane.create(this.normal.x,this.normal.y,this.normal.z,this.d)},Plane.prototype.dotCoordinate=function(point){return this.normal.x*point.x+this.normal.y*point.y+this.normal.z*point.z+this.d},Plane}();wd.Plane=Plane}(wd||(wd={}));var wd;!function(wd){var Ray=function(){function Ray(origin,direction){this._origin=null,this._direction=null,this._origin=origin,this._direction=direction}return Ray.create=function(origin,direction){var obj=new this(origin,direction);return obj},Ray.prototype.isIntersectWithAABB=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var center=null,halfExtends=null,diff=wd.Vector3.create(),absDiff=null,absDir=null,cross=wd.Vector3.create(),prod=wd.Vector3.create(),rayOrigin=this._origin,rayDir=this._direction;if(1===args.length){var aabb=args[0];center=aabb.center,halfExtends=aabb.halfExtents}else if(2===args.length){var minPoint=args[0],maxPoint=args[1];center=wd.AABBShape.getCenter(minPoint,maxPoint),halfExtends=wd.AABBShape.getHalfExtents(minPoint,maxPoint)}return diff.sub2(rayOrigin,center),absDiff=wd.Vector3.create(Math.abs(diff.x),Math.abs(diff.y),Math.abs(diff.z)),prod.mul2(diff,rayDir),!(absDiff.x>halfExtends.x&&prod.x>=0)&&(!(absDiff.y>halfExtends.y&&prod.y>=0)&&(!(absDiff.z>halfExtends.z&&prod.z>=0)&&(absDir=wd.Vector3.create(Math.abs(rayDir.x),Math.abs(rayDir.y),Math.abs(rayDir.z)),cross.cross(rayDir,diff),cross.set(Math.abs(cross.x),Math.abs(cross.y),Math.abs(cross.z)),!(cross.x>halfExtends.y*absDir.z+halfExtends.z*absDir.y)&&(!(cross.y>halfExtends.x*absDir.z+halfExtends.z*absDir.x)&&!(cross.z>halfExtends.x*absDir.y+halfExtends.y*absDir.x)))))},Ray.prototype.isIntersectWithSphere=function(sphere){var center=sphere.center,radius=sphere.radius,diff=wd.Vector3.create(),a=0,b=0,c=0,discr=0,rayOrigin=this._origin,rayDir=this._direction;return diff.sub2(rayOrigin,center),diff.dot(diff)<radius*radius||(a=rayDir.dot(rayDir),b=2*rayDir.dot(diff),c=center.dot(center),c+=rayOrigin.dot(rayOrigin),c-=2*center.dot(rayOrigin),c-=radius*radius,discr=b*b-4*a*c,!(discr<0))},Ray}();wd.Ray=Ray}(wd||(wd={}));var wd;!function(wd){var Entity=function(){function Entity(){this.uid=null,this._tagList=wdCb.Collection.create(),this.uid=Entity._count,Entity._count+=1}return Entity.prototype.addTag=function(tag){this._tagList.addChild(tag)},Entity.prototype.removeTag=function(tag){this._tagList.removeChild(tag)},Entity.prototype.getTagList=function(){return this._tagList},Entity.prototype.hasTag=function(tag){return this._tagList.hasChild(tag)},Entity.prototype.containTag=function(tag){return this._tagList.hasChildWithFunc(function(t){return t.indexOf(tag)>-1})},Entity._count=1,Entity}();wd.Entity=Entity}(wd||(wd={}));var wd;!function(wd){var Component=function(_super){function Component(){_super.apply(this,arguments),this.entityObject=null}return __extends(Component,_super),Component.prototype.init=function(){},Component.prototype.dispose=function(){},Component.prototype.clone=function(){return wd.CloneUtils.clone(this)},Object.defineProperty(Component.prototype,"transform",{get:function(){return this.entityObject?this.entityObject.transform:null},enumerable:!0,configurable:!0}),Component.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1),isShareComponent||(this.entityObject&&this.entityObject.removeComponent(this),this.entityObject=entityObject)},Component.prototype.removeFromObject=function(entityObject){},__decorate([wd.virtual],Component.prototype,"init",null),__decorate([wd.virtual],Component.prototype,"dispose",null),__decorate([wd.virtual],Component.prototype,"clone",null),__decorate([wd.virtual],Component.prototype,"addToObject",null),__decorate([wd.virtual],Component.prototype,"removeFromObject",null),Component}(wd.Entity);wd.Component=Component}(wd||(wd={}));var wd;!function(wd){var Scheduler=function(){function Scheduler(){this._scheduleCount=0,this._schedules=wdCb.Hash.create()}return Scheduler.create=function(){var obj=new this;return obj},Scheduler.prototype.update=function(elapsed){var _this=this;this._schedules.forEach(function(scheduleItem,scheduleId){scheduleItem.isStop||scheduleItem.isPause||(scheduleItem.update(elapsed),scheduleItem.isFinish&&_this.remove(scheduleId))})},Scheduler.prototype.scheduleLoop=function(task,args){return void 0===args&&(args=[]),this._schedule(LoopScheduleItem,Array.prototype.slice.call(arguments,0))},Scheduler.prototype.scheduleFrame=function(task,frame,args){return void 0===frame&&(frame=1),this._schedule(FrameScheduleItem,Array.prototype.slice.call(arguments,0))},Scheduler.prototype.scheduleInterval=function(task,time,args){return void 0===time&&(time=0),this._schedule(IntervalScheduleItem,Array.prototype.slice.call(arguments,0))},Scheduler.prototype.scheduleTime=function(task,time,args){return void 0===time&&(time=0),this._schedule(TimeScheduleItem,Array.prototype.slice.call(arguments,0))},Scheduler.prototype.pause=function(scheduleId){if(0===arguments.length){var self_1=this;this._schedules.forEach(function(scheduleItem,scheduleId){self_1.pause(scheduleId)})}else if(1===arguments.length){var scheduleItem=this._schedules.getChild(arguments[0]);scheduleItem.pause()}},Scheduler.prototype.resume=function(scheduleId){if(0===arguments.length){var self_2=this;this._schedules.forEach(function(scheduleItem,scheduleId){self_2.resume(scheduleId)})}else if(1===arguments.length){var scheduleItem=this._schedules.getChild(arguments[0]);scheduleItem.resume()}},Scheduler.prototype.start=function(scheduleId){if(0===arguments.length){var self_3=this;this._schedules.forEach(function(scheduleItem,scheduleId){self_3.start(scheduleId)})}else if(1===arguments.length){var scheduleItem=this._schedules.getChild(arguments[0]);scheduleItem.start()}},Scheduler.prototype.stop=function(scheduleId){if(0===arguments.length){var self_4=this;this._schedules.forEach(function(scheduleItem,scheduleId){self_4.stop(scheduleId)})}else if(1===arguments.length){var scheduleItem=this._schedules.getChild(arguments[0]);scheduleItem.stop()}},Scheduler.prototype.has=function(scheduleId){return!!this._schedules.hasChild(scheduleId)},Scheduler.prototype.remove=function(scheduleId){this._schedules.removeChild(scheduleId)},Scheduler.prototype.removeAll=function(){this._schedules.removeAllChildren()},Scheduler.prototype._schedule=function(_class,args){var scheduleId=this._buildId();return this._schedules.setValue(scheduleId,_class.create.apply(_class,args)),scheduleId},Scheduler.prototype._buildId=function(){return"Schedule_"+this._scheduleCount++},Scheduler}();wd.Scheduler=Scheduler;var ScheduleItem=function(){function ScheduleItem(task,args){this.isPause=!1,this.isStop=!1,this.pauseTime=null,this.pauseElapsed=null,this.startTime=null,this.isFinish=!1,this.task=null,this.args=null,this.timeController=wd.CommonTimeController.create(),this.task=task,this.args=args}return ScheduleItem.prototype.pause=function(){this.isPause=!0,this.timeController.pause()},ScheduleItem.prototype.resume=function(){this.isPause=!1,this.timeController.resume()},ScheduleItem.prototype.start=function(){this.isStop=!1,this.timeController.start()},ScheduleItem.prototype.stop=function(){this.isStop=!0,this.timeController.stop()},ScheduleItem.prototype.finish=function(){this.isFinish=!0},ScheduleItem}(),TimeScheduleItem=function(_super){function TimeScheduleItem(task,time,args){void 0===time&&(time=0),void 0===args&&(args=[]),_super.call(this,task,args),this._time=null,this._time=time}return __extends(TimeScheduleItem,_super),TimeScheduleItem.create=function(task,time,args){void 0===time&&(time=0),void 0===args&&(args=[]);var obj=new this(task,time,args);return obj},TimeScheduleItem.prototype.update=function(elapsed){var elapsed=this.timeController.computeElapseTime(elapsed);elapsed>=this._time&&(this.task.apply(this,this.args),this.finish())},TimeScheduleItem}(ScheduleItem),IntervalScheduleItem=function(_super){function IntervalScheduleItem(task,time,args){void 0===time&&(time=0),void 0===args&&(args=[]),_super.call(this,task,args),this._intervalTime=null,this._elapsed=0,this._intervalTime=time}return __extends(IntervalScheduleItem,_super),IntervalScheduleItem.create=function(task,time,args){void 0===time&&(time=0),void 0===args&&(args=[]);var obj=new this(task,time,args);return obj},IntervalScheduleItem.prototype.update=function(elapsed){var elapsed=this.timeController.computeElapseTime(elapsed);elapsed-this._elapsed>=this._intervalTime&&(this.task.apply(this,this.args),this._elapsed=elapsed)},IntervalScheduleItem.prototype.start=function(){_super.prototype.start.call(this),this._elapsed=0},IntervalScheduleItem}(ScheduleItem),LoopScheduleItem=function(_super){function LoopScheduleItem(){_super.apply(this,arguments)}return __extends(LoopScheduleItem,_super),LoopScheduleItem.create=function(task,args){void 0===args&&(args=[]);var obj=new this(task,args);return obj},LoopScheduleItem.prototype.update=function(elapsed){this.task.apply(this,this.args)},LoopScheduleItem}(ScheduleItem),FrameScheduleItem=function(_super){function FrameScheduleItem(task,frame,args){void 0===frame&&(frame=1),void 0===args&&(args=[]),_super.call(this,task,args),this._frame=null,this._frame=frame}return __extends(FrameScheduleItem,_super),FrameScheduleItem.create=function(task,frame,args){void 0===frame&&(frame=1),void 0===args&&(args=[]);var obj=new this(task,frame,args);return obj},FrameScheduleItem.prototype.update=function(elapsed){this._frame--,this._frame<=0&&(this.task.apply(this,this.args),this.finish())},FrameScheduleItem}(ScheduleItem)}(wd||(wd={}));var wd;!function(wd){var EGameState;!function(EGameState){EGameState[EGameState.NORMAL=0]="NORMAL",EGameState[EGameState.STOP=1]="STOP",EGameState[EGameState.PAUSE=2]="PAUSE"}(EGameState||(EGameState={}));var Director=function(){function Director(){this.scene=null,this.scheduler=null,this.renderer=null,this.domEventManager=wd.DomEventManager.create(),this._gameLoop=null,this._eventSubscription=null,this._gameState=EGameState.NORMAL,this._timeController=wd.DirectorTimeController.create()}return Director.getInstance=function(){},Object.defineProperty(Director.prototype,"gameTime",{get:function(){return this._timeController.gameTime},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"fps",{get:function(){return this._timeController.fps},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"isNormal",{get:function(){return this._gameState===EGameState.NORMAL},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"isStop",{get:function(){return this._gameState===EGameState.STOP},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"isPause",{get:function(){return this._gameState===EGameState.PAUSE},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"isTimeChange",{get:function(){return this._timeController.isTimeChange},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"elapsed",{get:function(){return this._timeController.elapsed},enumerable:!0,configurable:!0}),Object.defineProperty(Director.prototype,"view",{get:function(){return wd.DeviceManager.getInstance().view},enumerable:!0,configurable:!0}),Director.prototype.initWhenCreate=function(){this.scene=wd.SceneDispatcher.create(),this.scheduler=wd.Scheduler.create(),this.renderer=wd.WebGLRenderer.create()},Director.prototype.start=function(){this._gameState=EGameState.NORMAL,this._startLoop()},Director.prototype.stop=function(){this._gameLoop&&this._gameLoop.dispose(),this._gameState=EGameState.STOP,this._timeController.stop(),this.scheduler.stop(),this._eventSubscription&&this._eventSubscription.dispose()},Director.prototype.pause=function(){this._gameState!==EGameState.PAUSE&&(this._gameState=EGameState.PAUSE,this._timeController.pause(),this.scheduler.pause())},Director.prototype.resume=function(){this._gameState=EGameState.NORMAL,this._timeController.resume(),this.scheduler.resume()},Director.prototype.getDeltaTime=function(){return this._timeController.deltaTime},Director.prototype.initUIObjectScene=function(){var uiObjectScene=this.scene.uiObjectScene;this._initDomEvent(),uiObjectScene.onEnter(),uiObjectScene.init()},Director.prototype.runUIObjectScene=function(elapsed){var uiObjectScene=this.scene.uiObjectScene;wd.EventManager.trigger(wd.CustomEvent.create(wd.EEngineEvent.STARTLOOP)),wd.ScriptEngine.getInstance().execScript("onStartLoop"),uiObjectScene.update(elapsed),uiObjectScene.render(),wd.ScriptEngine.getInstance().execScript("onEndLoop"),wd.EventManager.trigger(wd.CustomEvent.create(wd.EEngineEvent.ENDLOOP))},Director.prototype._startLoop=function(){var self=this;this._gameLoop=this._buildInitStream().ignoreElements().concat(this._buildLoopStream()).subscribe(function(time){self._loopBody(time)})},Director.prototype._buildInitStream=function(){var _this=this;return wdFrp.callFunc(function(){_this._init()},this)},Director.prototype._init=function(){this._initGameObjectScene(),this.initUIObjectScene(),wd.DebugStatistics.init()},Director.prototype._initGameObjectScene=function(){var gameObjectScene=this.scene.gameObjectScene;this._initDomEvent(),gameObjectScene.onEnter(),gameObjectScene.init(),this.renderer.init(),this._timeController.start(),this.scheduler.start()},Director.prototype._buildLoopStream=function(){return wdFrp.intervalRequest()},Director.prototype._loopBody=function(time){var elapsed=null;return this._gameState!==EGameState.PAUSE&&this._gameState!==EGameState.STOP&&(elapsed=this._timeController.computeElapseTime(time),this._run(elapsed),!0)},Director.prototype._run=function(elapsed){this._timeController.tick(elapsed),wd.EventManager.trigger(wd.CustomEvent.create(wd.EEngineEvent.STARTLOOP)),wd.ScriptEngine.getInstance().execScript("onStartLoop"),this._update(elapsed),this._render(),wd.ScriptEngine.getInstance().execScript("onEndLoop"),wd.EventManager.trigger(wd.CustomEvent.create(wd.EEngineEvent.ENDLOOP))},Director.prototype._update=function(elapsed){this.scheduler.update(elapsed),wd.ScriptEngine.getInstance().execScriptWithData("update",elapsed),wd.ActionEngine.getInstance().update(elapsed),this.scene.gameObjectScene.update(elapsed),this.scene.uiObjectScene.update(elapsed)},Director.prototype._render=function(){this.scene.gameObjectScene.render(this.renderer),this.renderer.clear(),this.renderer.hasCommand()&&(this.renderer.webglState=wd.BasicState.create(),this.renderer.render()),this.scene.uiObjectScene.render()},Director.prototype._initDomEvent=function(){this._eventSubscription=this.domEventManager.initDomEvent()},__decorate([wd.execOnlyOnce("_isInitUIScene")],Director.prototype,"initUIObjectScene",null),__decorate([wd.execOnlyOnce("_isInitDomEvent")],Director.prototype,"_initDomEvent",null),Director=__decorate([wd.singleton(!0)],Director)}();wd.Director=Director}(wd||(wd={}));var wd;!function(wd){var Main=function(){function Main(){}return Object.defineProperty(Main,"isTest",{get:function(){return this._isTest},set:function(isTest){this._isTest=isTest,wdFrp.Main.isTest=isTest},enumerable:!0,configurable:!0}),Main.setConfig=function(_a){var _b=_a.canvasId,canvasId=void 0===_b?null:_b,_c=_a.isTest,isTest=void 0===_c?wd.DebugConfig.isTest:_c,_d=_a.screenSize,screenSize=void 0===_d?wd.EScreenSize.FULL:_d,_e=_a.useDevicePixelRatio,useDevicePixelRatio=void 0!==_e&&_e,_f=_a.contextConfig,contextConfig=void 0===_f?{options:{alpha:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1}}:_f;return this.isTest=isTest,this.screenSize=screenSize,this._canvasId=canvasId,this._useDevicePixelRatio=useDevicePixelRatio,this._contextConfig={options:wdCb.ExtendUtils.extend({alpha:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1},contextConfig.options)},this},Main.init=function(){return wd.DeviceManager.getInstance().createGL(this._canvasId,this._contextConfig,this._useDevicePixelRatio),wd.DeviceManager.getInstance().setScreen(),wd.GPUDetector.getInstance().detect(),this},Main._isTest=!1,Main.screenSize=null,Main._canvasId=null,Main._contextConfig=null,Main._useDevicePixelRatio=null,Main}();wd.Main=Main}(wd||(wd={}));var wd;!function(wd){var DomEventManager=function(){function DomEventManager(){this.designatedTriggerList=null,this._lastTriggerList=null,this._isDragEventTriggering=!1,this._triggerListOfDragEvent=null}return DomEventManager.create=function(){var obj=new this;return obj},Object.defineProperty(DomEventManager.prototype,"scene",{get:function(){return wd.Director.getInstance().scene},enumerable:!0,configurable:!0}),DomEventManager.prototype.initDomEvent=function(){var self=this;return wdFrp.fromArray([wd.EventManager.fromEvent(wd.EEventName.CLICK),wd.EventManager.fromEvent(wd.EEventName.MOUSEDOWN),wd.EventManager.fromEvent(wd.EEventName.MOUSEUP),wd.EventManager.fromEvent(wd.EEventName.MOUSEWHEEL),this._buildMouseDragStream()]).mergeAll().filter(function(e){return!wd.Director.getInstance().isPause}).map(function(e){var triggerList=self._getMouseEventTriggerList(e);return self._isDragEventTriggering&&(self._triggerListOfDragEvent=triggerList),self._getMouseEventTriggerListData(e,triggerList)}).merge(this._buildMouseMoveStream()).subscribe(function(_a){var triggerList=_a[0],e=_a[1];triggerList.forEach(function(entityObject){self._trigger(e.clone(),entityObject)})})},DomEventManager.prototype._buildMouseDragStream=function(){var self=this;return wd.EventManager.fromEvent(document,wd.EEventName.MOUSEDOWN).flatMap(function(e){return wd.EventManager.fromEvent(document,wd.EEventName.MOUSEMOVE).takeUntil(wd.EventManager.fromEvent(document,wd.EEventName.MOUSEUP).do(function(e){self._isDragEventTriggering=!1}))}).map(function(e){return e.name=wd.EEventName.MOUSEDRAG,self._isDragEventTriggering=!0,e})},DomEventManager.prototype._buildMouseMoveStream=function(){var self=this;return wd.EventManager.fromEvent(wd.EEventName.MOUSEMOVE).filter(function(e){return!wd.Director.getInstance().isPause}).map(function(e){var triggerList=null;triggerList=self.designatedTriggerList?self.designatedTriggerList:self._isDragEventTriggering?self._triggerListOfDragEvent:self._getMouseEventTriggerList(e);var _a=self._getMouseOverAndMouseOutObject(triggerList,self._lastTriggerList),mouseoverObjects=_a.mouseoverObjects,mouseoutObjects=_a.mouseoutObjects;return self._setMouseOverTag(mouseoverObjects),self._setMouseOutTag(mouseoutObjects),self._lastTriggerList=triggerList.clone(),triggerList=mouseoutObjects.addChildren(triggerList),self._getMouseEventTriggerListData(e,triggerList)})},DomEventManager.prototype._getMouseOverAndMouseOutObject=function(currentTriggerList,lastTriggerList){var mouseoverObjects=wdCb.Collection.create(),mouseoutObjects=wdCb.Collection.create();return lastTriggerList?(lastTriggerList.forEach(function(lastObject){currentTriggerList.hasChildWithFunc(function(currentObject){return wd.JudgeUtils.isEqual(currentObject,lastObject)})||mouseoutObjects.addChild(lastObject)}),currentTriggerList.forEach(function(currentObject){lastTriggerList.hasChildWithFunc(function(lastObject){return wd.JudgeUtils.isEqual(currentObject,lastObject)})||mouseoverObjects.addChild(currentObject)})):mouseoverObjects=currentTriggerList,{mouseoverObjects:mouseoverObjects,mouseoutObjects:mouseoutObjects}},DomEventManager.prototype._setMouseOverTag=function(objects){objects.forEach(function(object){object.addTag(EEventTag.MOUSE_OVER)})},DomEventManager.prototype._setMouseOutTag=function(objects){objects.forEach(function(object){object.addTag(EEventTag.MOUSE_OUT)})},DomEventManager.prototype._setEventNameByEventTag=function(object,e){return object.hasTag(EEventTag.MOUSE_OVER)?e.name=wd.EEventName.MOUSEOVER:object.hasTag(EEventTag.MOUSE_OUT)&&(e.name=wd.EEventName.MOUSEOUT),e},DomEventManager.prototype._removeEventTag=function(object){object.removeTag(EEventTag.MOUSE_OVER),object.removeTag(EEventTag.MOUSE_OUT)},DomEventManager.prototype._trigger=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var e=args[0],entityObject=args[1],notSetTarget=!1,event=null,customEvent=null,handlerName=null;3===args.length&&args[2]?(notSetTarget=!0,event=e):(event=this._setEventNameByEventTag(entityObject,e),this._removeEventTag(entityObject)),handlerName=wd.EventTriggerTable.getScriptHandlerName(event.name),customEvent=wd.CustomEvent.create(wd.EEngineEvent[wd.EventTriggerTable.getScriptEngineEvent(event.name)]),customEvent.getDataFromDomEvent(event),wd.EventManager.trigger(entityObject,customEvent,event,notSetTarget),event.getDataFromCustomEvent(customEvent),
wd.ScriptEngine.getInstance().execEntityObjectEventScriptWithData(entityObject,handlerName,event),!event.isStopPropagation&&entityObject.bubbleParent&&this._trigger(event.clone(),entityObject.bubbleParent,!0)},DomEventManager.prototype._getMouseEventTriggerList=function(e){var topGameObject=null,topUIObject=null,triggerList=null;return this.designatedTriggerList?this.designatedTriggerList:(triggerList=wdCb.Collection.create(),topGameObject=this._findTopGameObject(e,this.scene.gameObjectScene),topUIObject=this._findTopUIObject(e,this.scene.uiObjectScene),topGameObject&&triggerList.addChild(topGameObject),topUIObject&&triggerList.addChild(topUIObject),this._isSceneAsTopOne(e,triggerList)&&triggerList.addChild(this.scene),triggerList)},DomEventManager.prototype._isSceneAsTopOne=function(e,triggerList){return this._isTriggerScene(e)&&0===triggerList.getCount()},DomEventManager.prototype._findTopGameObject=function(e,gameObjectScene){var self=this;return this._findTriggerGameObjectList(e,gameObjectScene).sort(function(a,b){return self._getDistanceToCamera(a)-self._getDistanceToCamera(b)}).getChild(0)},DomEventManager.prototype._getDistanceToCamera=function(obj){return obj.transform.position.clone().sub(wd.Director.getInstance().scene.currentCamera.transform.position).length()},DomEventManager.prototype._findTopUIObject=function(e,uiObjectScene){return this._findTriggerUIObjectList(e,uiObjectScene).sort(function(a,b){return b.transform.zIndex-a.transform.zIndex}).getChild(0)},DomEventManager.prototype._findTriggerGameObjectList=function(e,objectScene){var triggerObjectList=wdCb.Collection.create(),self=this,find=function(entityObject){entityObject.hasComponent(wd.SpacePartition)?entityObject.getSpacePartition().getIntersectListWithRay(e).forEach(function(entityObject){self._addTriggerObjectByQueryDetector(entityObject,e,triggerObjectList)}):(self._addTriggerObjectByQueryDetector(entityObject,e,triggerObjectList),entityObject.forEach(function(child){find(child)}))};return objectScene.forEach(function(child){find(child)}),triggerObjectList},DomEventManager.prototype._findTriggerUIObjectList=function(e,objectScene){var triggerObjectList=wdCb.Collection.create(),self=this,find=function(entityObject){self._addTriggerObjectByQueryDetector(entityObject,e,triggerObjectList),entityObject.forEach(function(child){find(child)})};return objectScene.forEach(function(child){find(child)}),triggerObjectList},DomEventManager.prototype._addTriggerObjectByQueryDetector=function(entityObject,e,triggerObjectList){if(entityObject.hasComponent(wd.EventTriggerDetector)){var detector=entityObject.getComponent(wd.EventTriggerDetector);detector.isTrigger(e)&&triggerObjectList.addChild(entityObject)}},DomEventManager.prototype._isTriggerScene=function(e){var detector=this.scene.getComponent(wd.EventTriggerDetector);return detector.isTrigger(e)},DomEventManager.prototype._getMouseEventTriggerListData=function(e,triggerList){return[triggerList,e]},DomEventManager}();wd.DomEventManager=DomEventManager;var EEventTag;!function(EEventTag){EEventTag[EEventTag.MOUSE_OVER="MOUSE_OVER"]="MOUSE_OVER",EEventTag[EEventTag.MOUSE_OUT="MOUSE_OUT"]="MOUSE_OUT"}(EEventTag||(EEventTag={}))}(wd||(wd={}));var wd;!function(wd){var EntityObject=function(_super){function EntityObject(){_super.apply(this,arguments),this._bubbleParent=null,this.name=null,this.parent=null,this.isVisible=!0,this.scriptManager=wd.ScriptManager.create(this),this._hasComponentCache=wdCb.Hash.create(),this._getComponentCache=wdCb.Hash.create(),this._componentChangeSubscription=null,this._componentManager=wd.ComponentManager.create(this),this._entityObjectManager=wd.EntityObjectManager.create(this)}return __extends(EntityObject,_super),Object.defineProperty(EntityObject.prototype,"bubbleParent",{get:function(){return this._bubbleParent?this._bubbleParent:this.parent},set:function(bubbleParent){this._bubbleParent=bubbleParent},enumerable:!0,configurable:!0}),Object.defineProperty(EntityObject.prototype,"componentDirty",{set:function(componentDirty){componentDirty===!0&&this.clearCache()},enumerable:!0,configurable:!0}),Object.defineProperty(EntityObject.prototype,"transform",{get:function(){return this._componentManager.transform},enumerable:!0,configurable:!0}),EntityObject.prototype.initWhenCreate=function(){this.addComponent(this.createTransform())},EntityObject.prototype.clone=function(config){void 0===config&&(config={});var result=null;return wd.CloneUtils.isNotClone(this)?null:(config=wdCb.ExtendUtils.extend({cloneChildren:!0,shareGeometry:!1,cloneGeometry:!0},config),result=wd.CloneUtils.clone(this),this.forEachComponent(function(component){if(config.cloneGeometry||!(component instanceof wd.Geometry))return config.shareGeometry&&component instanceof wd.Geometry?void result.addComponent(component,!0):void result.addComponent(component.clone())}),config.cloneChildren&&this._cloneChildren(result),result)},EntityObject.prototype.init=function(){var self=this;return this._componentChangeSubscription=wd.EventManager.fromEvent(this,wd.EEngineEvent.COMPONENT_CHANGE).subscribe(function(){self._onComponentChange()}),this._componentManager.init(),this._entityObjectManager.init(),this.afterInitChildren(),this},EntityObject.prototype.onEnter=function(){wd.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"onEnter"),wd.EventManager.trigger(this,wd.CustomEvent.create(wd.EEngineEvent.ENTER))},EntityObject.prototype.onExit=function(){wd.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"onExit"),wd.EventManager.trigger(this,wd.CustomEvent.create(wd.EEngineEvent.EXIT))},EntityObject.prototype.onDispose=function(){wd.ScriptEngine.getInstance().execEntityObjectScriptOnlyOnce(this,"onDispose")},EntityObject.prototype.dispose=function(){this.onDispose(),this.parent&&(this.parent.removeChild(this),this.parent=null),wd.EventManager.off(this),this._componentChangeSubscription&&this._componentChangeSubscription.dispose(),this._componentManager.dispose(),this._entityObjectManager.dispose()},EntityObject.prototype.hasChild=function(child){return this._entityObjectManager.hasChild(child)},EntityObject.prototype.addChild=function(child){return this._entityObjectManager.addChild(child),child.transform.parent=this.transform,this},EntityObject.prototype.addChildren=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return this._entityObjectManager.addChildren(args[0]),this},EntityObject.prototype.forEach=function(func){return this._entityObjectManager.forEach(func),this},EntityObject.prototype.filter=function(func){return this._entityObjectManager.filter(func)},EntityObject.prototype.sort=function(func,isSortSelf){return void 0===isSortSelf&&(isSortSelf=!1),this._entityObjectManager.sort(func,isSortSelf)},EntityObject.prototype.getChildren=function(){return this._entityObjectManager.getChildren()},EntityObject.prototype.getChild=function(index){return this._entityObjectManager.getChild(index)},EntityObject.prototype.findChildByUid=function(uid){return this._entityObjectManager.findChildByUid(uid)},EntityObject.prototype.findChildByTag=function(tag){return this._entityObjectManager.findChildByTag(tag)},EntityObject.prototype.findChildByName=function(name){return this._entityObjectManager.findChildByName(name)},EntityObject.prototype.findChildrenByName=function(name){return this._entityObjectManager.findChildrenByName(name)},EntityObject.prototype.removeChild=function(child){return this._entityObjectManager.removeChild(child),this},EntityObject.prototype.removeAllChildren=function(){this._entityObjectManager.removeAllChildren()},EntityObject.prototype.getComponent=function(_class){return this._componentManager.getComponent(_class)},EntityObject.prototype.getComponents=function(){return this._componentManager.getComponents()},EntityObject.prototype.findComponentByUid=function(uid){return this._componentManager.findComponentByUid(uid)},EntityObject.prototype.forEachComponent=function(func){return this._componentManager.forEachComponent(func),this},EntityObject.prototype.hasComponent=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var key=this._getHasComponentCacheKey(args[0]),result=this._hasComponentCache.getChild(key);return void 0!==result?result:(result=this._componentManager.hasComponent(args[0]),this._hasComponentCache.addChild(key,result),result)},EntityObject.prototype.addComponent=function(component,isShareComponent){return void 0===isShareComponent&&(isShareComponent=!1),this._componentManager.addComponent(component,isShareComponent),this.componentDirty=!0,this},EntityObject.prototype.removeComponent=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return this._componentManager.removeComponent(args[0]),this.componentDirty=!0,this},EntityObject.prototype.removeAllComponent=function(){return this.componentDirty=!0,this._componentManager.removeAllComponent()},EntityObject.prototype.render=function(renderer,camera){var geometry=null,rendererComponent=null;this.isVisible&&(geometry=this.getGeometry(),rendererComponent=this._componentManager.getRendererComponent(),rendererComponent&&geometry&&rendererComponent.render(renderer,geometry,camera),this.getRenderList().forEach(function(child){child.render(renderer,camera)}))},EntityObject.prototype.update=function(elapsed){this.forEach(function(child){child.update(elapsed)})},EntityObject.prototype.getComponentCount=function(_class){return this._componentManager.getComponentCount(_class)},EntityObject.prototype.afterInitChildren=function(){},EntityObject.prototype.getRenderList=function(){return this.isVisible?this._entityObjectManager.getChildren():null},EntityObject.prototype.getGeometry=function(){return this._componentManager.getGeometry()},EntityObject.prototype.getAllChildren=function(){return this._entityObjectManager.getAllChildren()},EntityObject.prototype.clearCache=function(){this._hasComponentCache.removeAllChildren(),this._getComponentCache.removeAllChildren()},EntityObject.prototype._getHasComponentCacheKey=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(wd.JudgeUtils.isComponenet(args[0])){var component=args[0];return String(component.uid)}var _class=args[0];return _class.name},EntityObject.prototype._onComponentChange=function(){this.clearCache()},EntityObject.prototype._cloneChildren=function(result){this.forEach(function(child){var resultChild=child.clone();null!==resultChild&&result.addChild(resultChild)})},__decorate([wd.cloneAttributeAsBasicType()],EntityObject.prototype,"bubbleParent",null),__decorate([wd.cloneAttributeAsBasicType()],EntityObject.prototype,"name",void 0),__decorate([wd.cloneAttributeAsBasicType()],EntityObject.prototype,"parent",void 0),__decorate([wd.cloneAttributeAsBasicType()],EntityObject.prototype,"isVisible",void 0),__decorate([wd.virtual],EntityObject.prototype,"initWhenCreate",null),__decorate([wd.cache(function(_class){return this._getComponentCache.hasChild(_class.name)},function(_class){return this._getComponentCache.getChild(_class.name)},function(result,_class){this._getComponentCache.addChild(_class.name,result)})],EntityObject.prototype,"getComponent",null),__decorate([wd.virtual],EntityObject.prototype,"afterInitChildren",null),__decorate([wd.virtual],EntityObject.prototype,"getRenderList",null),__decorate([wd.virtual],EntityObject.prototype,"getGeometry",null),__decorate([wd.ensure(function(key){wd.assert(wd.JudgeUtils.isString(key),wd.Log.info.FUNC_SHOULD("key:"+key,"be string"))})],EntityObject.prototype,"_getHasComponentCacheKey",null),EntityObject}(wd.Entity);wd.EntityObject=EntityObject}(wd||(wd={}));var wd;!function(wd){var ComponentManager=function(){function ComponentManager(entityObject){this.transform=null,this._entityObject=null,this._components=wdCb.Collection.create(),this._rendererComponent=null,this._collider=null,this._geometry=null,this._entityObject=entityObject}return ComponentManager.create=function(entityObject){var obj=new this(entityObject);return obj},ComponentManager.prototype.init=function(){for(var _i=0,_a=wd.SortUtils.insertSort(this._components.getChildren(),function(a,b){return wd.ComponentInitOrderTable.getOrder(a)<wd.ComponentInitOrderTable.getOrder(b)});_i<_a.length;_i++){var component=_a[_i];component.init()}},ComponentManager.prototype.dispose=function(){var components=this.removeAllComponent();components.forEach(function(component){component.dispose()}),this._components.removeAllChildren()},ComponentManager.prototype.removeAllComponent=function(){var _this=this,result=wdCb.Collection.create();return this._components.forEach(function(component){_this._removeComponentHandler(component),result.addChild(component)},this),result},ComponentManager.prototype.getComponent=function(_class){return this._components.findOne(function(component){return component instanceof _class})},ComponentManager.prototype.getComponents=function(){return this._components},ComponentManager.prototype.findComponentByUid=function(uid){return this._components.findOne(function(component){return component.uid===uid})},ComponentManager.prototype.forEachComponent=function(func){return this._components.forEach(func),this},ComponentManager.prototype.hasComponent=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var result=null;if(wd.JudgeUtils.isComponenet(args[0])){var component=args[0];result=this._components.hasChild(component)}else{var _class_1=args[0];result=this._components.hasChildWithFunc(function(component){return component instanceof _class_1})}return result},ComponentManager.prototype.addComponent=function(component,isShareComponent){if(void 0===isShareComponent&&(isShareComponent=!1),component)return component instanceof wd.RendererComponent?this._rendererComponent=component:component instanceof wd.Collider?this._collider=component:component instanceof wd.Geometry?this._geometry=component:component instanceof wd.Transform&&(this.transform&&this.removeComponent(this.transform),this.transform=component),component.addToObject(this._entityObject,isShareComponent),this._components.addChild(component),this},ComponentManager.prototype.removeComponent=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var component=null;return component=args[0]instanceof wd.Component?args[0]:this.getComponent(args[0]),component&&(this._components.removeChild(component),this._removeComponentHandler(component)),this},ComponentManager.prototype.getComponentCount=function(_class){return this._components.filter(function(component){return component instanceof _class}).getCount()},ComponentManager.prototype.getGeometry=function(){return this._geometry},ComponentManager.prototype.getRendererComponent=function(){return this._rendererComponent},ComponentManager.prototype.getCollider=function(){return this._collider},ComponentManager.prototype._removeComponentHandler=function(component){component.removeFromObject(this._entityObject)},__decorate([wd.require(function(component,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1),component&&wd.assert(!this.hasComponent(component),wd.Log.info.FUNC_EXIST("the component",", please judge whether it hasComponent(component) before addComponent(component)"))})],ComponentManager.prototype,"addComponent",null),__decorate([wd.require(function(){wd.assert(this.getComponentCount(wd.Geometry)<=1,wd.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 geometry component"))})],ComponentManager.prototype,"getGeometry",null),__decorate([wd.require(function(){wd.assert(this.getComponentCount(wd.RendererComponent)<=1,wd.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 rendererComponent"))})],ComponentManager.prototype,"getRendererComponent",null),__decorate([wd.require(function(){wd.assert(this.getComponentCount(wd.Collider)<=1,wd.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 collider component"))})],ComponentManager.prototype,"getCollider",null),ComponentManager}();wd.ComponentManager=ComponentManager}(wd||(wd={}));var wd;!function(wd){var EntityObjectManager=function(){function EntityObjectManager(entityObject){this._entityObject=null,this._children=wdCb.Collection.create(),this._entityObject=entityObject}return EntityObjectManager.create=function(entityObject){var obj=new this(entityObject);return obj},EntityObjectManager.prototype.init=function(){this.forEach(function(child){child.init()})},EntityObjectManager.prototype.dispose=function(){this.forEach(function(child){child.dispose()})},EntityObjectManager.prototype.hasChild=function(child){return this._children.hasChild(child)},EntityObjectManager.prototype.addChild=function(child){return child.parent&&child.parent.removeChild(child),child.parent=this._entityObject,this._children.addChild(child),child.onEnter(),this},EntityObjectManager.prototype.addChildren=function(){for(var _this=this,args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(wd.JudgeUtils.isArray(args[0]))for(var children=args[0],_a=0,children_1=children;_a<children_1.length;_a++){var child=children_1[_a];this.addChild(child)}else if(wd.JudgeUtils.isCollection(args[0])){var children=args[0];children.forEach(function(child){_this.addChild(child)})}else this.addChild(args[0]);return this},EntityObjectManager.prototype.forEach=function(func){return this._children.forEach(func),this},EntityObjectManager.prototype.filter=function(func){return this._children.filter(func)},EntityObjectManager.prototype.sort=function(func,isSortSelf){return void 0===isSortSelf&&(isSortSelf=!1),this._children.sort(func,isSortSelf)},EntityObjectManager.prototype.getChildren=function(){return this._children},EntityObjectManager.prototype.getAllChildren=function(){var result=wdCb.Collection.create(),getChildren=function(entityObject){result.addChildren(entityObject.getChildren()),entityObject.forEach(function(child){getChildren(child)})};return getChildren(this._entityObject),result},EntityObjectManager.prototype.getChild=function(index){return this._children.getChild(index)},EntityObjectManager.prototype.findChildByUid=function(uid){return this._children.findOne(function(child){return child.uid===uid})},EntityObjectManager.prototype.findChildByTag=function(tag){return this._children.findOne(function(child){return child.hasTag(tag)})},EntityObjectManager.prototype.findChildByName=function(name){return this._children.findOne(function(child){return child.name.search(name)>-1})},EntityObjectManager.prototype.findChildrenByName=function(name){return this._children.filter(function(child){return child.name.search(name)>-1})},EntityObjectManager.prototype.removeChild=function(child){return child.onExit(),this._children.removeChild(child),child.parent=null,this},EntityObjectManager.prototype.removeAllChildren=function(){var _this=this;this._children.forEach(function(child){_this.removeChild(child)},this)},EntityObjectManager}();wd.EntityObjectManager=EntityObjectManager}(wd||(wd={}));var wd;!function(wd){var ScriptManager=function(){function ScriptManager(entityObject){this._scriptList=wdCb.Hash.create(),this._entityObject=null,this._scriptExecuteHistory=wdCb.Hash.create(),this._entityObject=entityObject}return ScriptManager.create=function(entityObject){var obj=new this(entityObject);return obj},ScriptManager.prototype.addChild=function(scriptName,classInstance){this._scriptList.addChild(scriptName,classInstance)},ScriptManager.prototype.getChild=function(scriptName){return this._scriptList.getChild(scriptName)},ScriptManager.prototype.removeChild=function(targetClassInstance){return this._scriptList.removeChild(function(classInstance){return classInstance===targetClassInstance})},ScriptManager.prototype.hasChild=function(targetClassInstance){return this._scriptList.hasChildWithFunc(function(classInstance){return classInstance===targetClassInstance})},ScriptManager.prototype.execScriptOnlyOnce=function(method){var _this=this;this._scriptList.forEach(function(script,scriptName){_this._isScriptExecuted(scriptName,method)||(script&&script[method]&&script[method](),_this._addToScriptExecuteHistory(scriptName,method))},this)},ScriptManager.prototype.execScriptWithData=function(method,data){this._scriptList.forEach(function(script){script[method]&&script[method](data)})},ScriptManager.prototype.execScript=function(method){this._scriptList.forEach(function(script){script[method]&&script[method]()})},ScriptManager.prototype.execEventScriptWithData=function(method,data){this._scriptList.forEach(function(script){script&&script[method]&&script[method](data)})},ScriptManager.prototype._addToScriptExecuteHistory=function(scriptName,method){this._scriptExecuteHistory.addChild(this._buildScriptHistoryKey(scriptName,method),!0)},ScriptManager.prototype._isScriptExecuted=function(scriptName,method){return this._scriptExecuteHistory.getChild(this._buildScriptHistoryKey(scriptName,method))},ScriptManager.prototype._buildScriptHistoryKey=function(scriptName,method){return scriptName+"_"+method},ScriptManager}();wd.ScriptManager=ScriptManager}(wd||(wd={}));var wd;!function(wd){var ComponentContainer=function(){function ComponentContainer(){this.list=wdCb.Collection.create()}return ComponentContainer.prototype.addChild=function(component){this.list.addChild(component)},ComponentContainer.prototype.removeChild=function(component){this.list.removeChild(component)},ComponentContainer.prototype.removeAllChildren=function(){this.list.removeAllChildren()},ComponentContainer.prototype.hasChild=function(component){return this.list.hasChild(component)},ComponentContainer}();wd.ComponentContainer=ComponentContainer}(wd||(wd={}));var wd;!function(wd){var UIObject=function(_super){function UIObject(){_super.apply(this,arguments)}return __extends(UIObject,_super),UIObject.create=function(){var obj=new this;return obj.initWhenCreate(),obj},UIObject.prototype.createTransform=function(){return wd.RectTransform.create()},UIObject.prototype.initWhenCreate=function(){_super.prototype.initWhenCreate.call(this),this.name="uiObject"+String(this.uid)},UIObject.prototype.addComponent=function(component){return _super.prototype.addComponent.call(this,component),this},UIObject.prototype.addChild=function(child){return _super.prototype.addChild.call(this,child),this},__decorate([wd.require(function(component){component instanceof wd.TwoDUI&&wd.assert(!this.getComponent(wd.TwoDUI),wd.Log.info.FUNC_SHOULD("only has one TwoDUI component"))})],UIObject.prototype,"addComponent",null),__decorate([wd.require(function(child){wd.assert(this.getComponent(wd.UIRenderer)===child.getComponent(wd.UIRenderer),wd.Log.info.FUNC_MUST_BE("the UIRenderer of UIObject and its children","the same one"))})],UIObject.prototype,"addChild",null),UIObject}(wd.EntityObject);wd.UIObject=UIObject}(wd||(wd={}));var wd;!function(wd){var GameObject=function(_super){function GameObject(){_super.apply(this,arguments),this.renderGroup=0,this.renderPriority=0}return __extends(GameObject,_super),GameObject.create=function(){var obj=new this;return obj.initWhenCreate(),obj},GameObject.merge=function(gameObjectArr){var source=gameObjectArr[0],resultObject=source.clone({cloneChildren:!1,cloneGeometry:!1}),mergedGeometry=wd.ModelGeometry.create();resultObject.removeAllChildren();for(var _i=0,gameObjectArr_1=gameObjectArr;_i<gameObjectArr_1.length;_i++){var gameObject=gameObjectArr_1[_i];mergedGeometry.merge(gameObject.getComponent(wd.Geometry),gameObject.transform)}return mergedGeometry.material=source.getComponent(wd.Geometry).material.clone(),resultObject.addComponent(mergedGeometry),resultObject},GameObject.prototype.initWhenCreate=function(){_super.prototype.initWhenCreate.call(this),this.name="gameObject"+String(this.uid)},GameObject.prototype.getSpacePartition=function(){return this.getComponent(wd.SpacePartition)},GameObject.prototype.getGeometry=function(){var lod=this.getComponent(wd.LOD);return lod&&lod.activeGeometry?lod.activeGeometry:_super.prototype.getGeometry.call(this)},GameObject.prototype.createTransform=function(){return wd.ThreeDTransform.create()},GameObject.prototype.getRenderList=function(){return this.hasComponent(wd.Octree)?this.getSpacePartition().getRenderList():wd.RenderUtils.getGameObjectRenderList(this.getChildren())},GameObject.prototype.afterInitChildren=function(){if(this.hasComponent(wd.Octree))return this.getSpacePartition().build()},__decorate([wd.require(function(gameObjectArr){var checkShouldContainGeometry=function(gameObject){wd.assert(gameObject.hasComponent(wd.Geometry),wd.Log.info.FUNC_SHOULD("contain geometry component"))},checkShouldHasTheSameMaterialClass=function(){var sourceObject=gameObjectArr[0],materialClassName=null;checkShouldContainGeometry(sourceObject),materialClassName=wd.ClassUtils.getClassName(sourceObject.getComponent(wd.Geometry).material);for(var i=1,len=gameObjectArr.length;i<len;i++){var gameObject=gameObjectArr[i];checkShouldContainGeometry(gameObject),wd.assert(wd.ClassUtils.getClassName(gameObject.getComponent(wd.Geometry).material)===materialClassName,wd.Log.info.FUNC_SHOULD("gameObjectArr","has the same material class"))}};wd.assert(gameObjectArr.length>1,wd.Log.info.FUNC_SHOULD("object count","> 1")),checkShouldHasTheSameMaterialClass()}),wd.ensure(function(mergedObject){wd.assert(0===mergedObject.getChildren().getCount(),wd.Log.info.FUNC_SHOULD("merged object","has no children"))})],GameObject,"merge",null),GameObject}(wd.EntityObject);wd.GameObject=GameObject}(wd||(wd={}));var wd;!function(wd){var SceneDispatcher=function(_super){function SceneDispatcher(){_super.apply(this,arguments),this.name="scene"+String(this.uid),this.uiObjectScene=wd.UIObjectScene.create(),this.gameObjectScene=wd.GameObjectScene.create()}return __extends(SceneDispatcher,_super),SceneDispatcher.create=function(){var obj=new this;return obj.initWhenCreate(),obj},Object.defineProperty(SceneDispatcher.prototype,"scriptManager",{get:function(){return this.gameObjectScene.scriptManager},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"ambientLight",{get:function(){return this.gameObjectScene.ambientLight},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"directionLights",{get:function(){return this.gameObjectScene.directionLights},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"pointLights",{get:function(){return this.gameObjectScene.pointLights},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"side",{get:function(){return this.gameObjectScene.side},set:function(side){this.gameObjectScene.side=side},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"shadowMap",{get:function(){return this.gameObjectScene.shadowMap},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"currentCamera",{get:function(){return this.gameObjectScene.currentCamera},set:function(arg){this.gameObjectScene.currentCamera=arg},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"physics",{get:function(){return this.gameObjectScene.physics},set:function(physics){this.gameObjectScene.physics=physics},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"glslData",{get:function(){return this.gameObjectScene.glslData},set:function(glslData){this.gameObjectScene.glslData=glslData},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"isUseShader",{get:function(){return this.gameObjectScene.isUseShader},enumerable:!0,configurable:!0}),Object.defineProperty(SceneDispatcher.prototype,"currentShaderType",{get:function(){return this.gameObjectScene.currentShaderType},enumerable:!0,configurable:!0}),SceneDispatcher.prototype.initWhenCreate=function(){_super.prototype.initWhenCreate.call(this),this.addComponent(wd.SceneEventTriggerDetector.create())},SceneDispatcher.prototype.useShaderType=function(type){this.gameObjectScene.useShaderType(type)},SceneDispatcher.prototype.unUseShader=function(){this.gameObjectScene.unUseShader()},SceneDispatcher.prototype.addChild=function(child){return child instanceof wd.GameObject?this.gameObjectScene.addChild(child):child instanceof wd.UIObject&&this.uiObjectScene.addChild(child),child.parent=this,this},SceneDispatcher.prototype.addCommonRenderTargetRenderer=function(renderTargetRenderer){return this.gameObjectScene.renderTargetRendererManager.addCommonRenderTargetRenderer(renderTargetRenderer)},SceneDispatcher.prototype.addProceduralRenderTargetRenderer=function(renderTargetRenderer){return this.gameObjectScene.renderTargetRendererManager.addProceduralRenderTargetRenderer(renderTargetRenderer)},SceneDispatcher.prototype.dispose=function(){this.gameObjectScene.dispose(),this.uiObjectScene.dispose()},SceneDispatcher.prototype.hasChild=function(child){return child instanceof wd.GameObject?this.gameObjectScene.hasChild(child):child instanceof wd.UIObject?this.uiObjectScene.hasChild(child):void 0},SceneDispatcher.prototype.addChildren=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(args[0]instanceof wd.EntityObject){var child=args[0];this.addChild(child)}if(args[0]instanceof wdCb.Collection){var children=args[0],self_5=this;children.forEach(function(child){self_5.addChild(child)})}else if(wd.JudgeUtils.isArrayExactly(args[0]))for(var children=args[0],_a=0,children_2=children;_a<children_2.length;_a++){var child=children_2[_a];this.addChild(child)}return this},SceneDispatcher.prototype.getChildren=function(){return this.gameObjectScene.getChildren().addChildren(this.uiObjectScene.getChildren())},SceneDispatcher.prototype.findChildByUid=function(uid){var result=this.gameObjectScene.findChildByUid(uid);return result||(result=this.uiObjectScene.findChildByUid(uid)),result},SceneDispatcher.prototype.findChildByTag=function(tag){var result=this.gameObjectScene.findChildByTag(tag);return result||(result=this.uiObjectScene.findChildByTag(tag)),result},SceneDispatcher.prototype.findChildByName=function(name){var result=this.gameObjectScene.findChildByName(name);return result||(result=this.uiObjectScene.findChildByName(name)),result},SceneDispatcher.prototype.findChildrenByName=function(name){return this.gameObjectScene.findChildrenByName(name).addChildren(this.uiObjectScene.findChildrenByName(name))},SceneDispatcher.prototype.removeChild=function(child){return child instanceof wd.GameObject?this.gameObjectScene.removeChild(child):child instanceof wd.UIObject?this.uiObjectScene.removeChild(child):void 0},SceneDispatcher.prototype.onEnter=function(){this.gameObjectScene.onEnter(),this.uiObjectScene.onEnter()},SceneDispatcher.prototype.onExit=function(){this.gameObjectScene.onExit(),this.uiObjectScene.onExit()},SceneDispatcher.prototype.onDispose=function(){this.gameObjectScene.onDispose(),this.uiObjectScene.onDispose()},SceneDispatcher.prototype.createTransform=function(){return null},__decorate([wd.ensureGetter(function(directionLights){directionLights&&wd.assert(directionLights.getCount()<=4,wd.Log.info.FUNC_SHOULD("direction lights' count","<= 4"))})],SceneDispatcher.prototype,"directionLights",null),__decorate([wd.ensureGetter(function(pointLights){pointLights&&wd.assert(pointLights.getCount()<=4,wd.Log.info.FUNC_SHOULD("point lights' count","<= 4"))})],SceneDispatcher.prototype,"pointLights",null),SceneDispatcher}(wd.EntityObject);wd.SceneDispatcher=SceneDispatcher}(wd||(wd={}));var wd;!function(wd){var Scene=function(_super){function Scene(){_super.apply(this,arguments)}return __extends(Scene,_super),Scene}(wd.EntityObject);wd.Scene=Scene}(wd||(wd={}));var wd;!function(wd){var UIObjectScene=function(_super){function UIObjectScene(){_super.apply(this,arguments),this._startLoopSubscription=null,this._endLoopSubscription=null}return __extends(UIObjectScene,_super),UIObjectScene.create=function(){var obj=new this;return obj.initWhenCreate(),obj},UIObjectScene.prototype.init=function(){var self=this;
return _super.prototype.init.call(this),this._startLoopSubscription=wd.EventManager.fromEvent(wd.EEngineEvent.STARTLOOP).subscribe(function(){self._sortSiblingChildren()}),this._endLoopSubscription=wd.EventManager.fromEvent(wd.EEngineEvent.ENDLOOP).subscribe(function(){self._resetAllRendererClearCanvasFlag()}),this},UIObjectScene.prototype.update=function(elapsed){_super.prototype.update.call(this,elapsed),wd.TwoDUIEngine.getInstance().update(elapsed)},UIObjectScene.prototype.onDispose=function(){_super.prototype.onDispose.call(this),this._startLoopSubscription.dispose(),this._endLoopSubscription.dispose()},UIObjectScene.prototype.render=function(){var self=this;this._resetAllRendererState(),this.forEach(function(child){var renderer=self._getUIRenderer(child);renderer.dirty?(renderer.isClearCanvas||renderer.clearCanvas(),renderer.state=wd.EUIRendererState.DIRTY,renderer.resetDirty()):renderer.state!==wd.EUIRendererState.DIRTY&&(renderer.state=wd.EUIRendererState.NOT_DIRTY)}),wd.TwoDUIEngine.getInstance().render()},UIObjectScene.prototype.createTransform=function(){return null},UIObjectScene.prototype._getUIRenderer=function(uiObject){return uiObject.getComponent(wd.UIRenderer)},UIObjectScene.prototype._resetAllRendererClearCanvasFlag=function(){var self=this;this.forEach(function(child){var renderer=self._getUIRenderer(child);renderer.isClearCanvas=!1})},UIObjectScene.prototype._resetAllRendererState=function(){var self=this;this.forEach(function(child){var renderer=self._getUIRenderer(child);renderer.state=wd.EUIRendererState.NORMAL})},UIObjectScene.prototype._sortSiblingChildren=function(){var sort=function(uiObject){uiObject.sort(function(a,b){return a.transform.zIndex-b.transform.zIndex},!0),uiObject.forEach(function(child){sort(child)})};sort(this)},__decorate([wd.require(function(){this.forEach(function(child){wd.assert(child instanceof wd.UIObject,wd.Log.info.FUNC_MUST_BE("child","UIObject")),wd.assert(child.hasComponent(wd.TwoDUI),wd.Log.info.FUNC_SHOULD("UIObject","contain ui component"))})})],UIObjectScene.prototype,"render",null),__decorate([wd.require(function(uiObject){wd.assert(uiObject.getComponentCount(wd.UIRenderer)<=1,wd.Log.info.FUNC_SHOULD_NOT("uiObject","contain more than 1 uiRenderer component"))})],UIObjectScene.prototype,"_getUIRenderer",null),__decorate([wd.ensure(function(){var self=this;this.getAllChildren().forEach(function(child){var renderer=self._getUIRenderer(child);wd.assert(!renderer.isClearCanvas,wd.Log.info.FUNC_SHOULD("reset all UIRenderers->isClearCanvas"))})})],UIObjectScene.prototype,"_resetAllRendererClearCanvasFlag",null),__decorate([wd.ensure(function(){var self=this;this.getAllChildren().forEach(function(child){var renderer=self._getUIRenderer(child);wd.assert(renderer.state===wd.EUIRendererState.NORMAL,wd.Log.info.FUNC_SHOULD("reset all UIRenderers->state"))})})],UIObjectScene.prototype,"_resetAllRendererState",null),UIObjectScene}(wd.Scene);wd.UIObjectScene=UIObjectScene}(wd||(wd={}));var wd;!function(wd){var BufferTable=function(){function BufferTable(){}return BufferTable.bindIndexBuffer=function(indexBuffer){var gl=null;this.lastBindedElementBuffer!==indexBuffer&&(this.lastBindedElementBuffer=indexBuffer,gl=wd.DeviceManager.getInstance().gl,gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,indexBuffer.buffer))},BufferTable.hasBuffer=function(key){return this._table.hasChild(key)},BufferTable.addBuffer=function(key,buffer){this._table.addChild(key,buffer)},BufferTable.getBuffer=function(key){return this._table.getChild(key)},BufferTable.dispose=function(){this._table.forEach(function(buffer){buffer.dispose()}),this.lastBindedArrayBufferListUidStr=null,this.lastBindedElementBuffer=null},BufferTable.clearAll=function(){this._table.removeAllChildren(),this.lastBindedArrayBufferListUidStr=null,this.lastBindedElementBuffer=null},BufferTable.resetBindedArrayBuffer=function(){var gl=wd.DeviceManager.getInstance().gl;gl.bindBuffer(gl.ARRAY_BUFFER,null),this.lastBindedArrayBufferListUidStr=null},BufferTable.resetBindedElementBuffer=function(){var gl=wd.DeviceManager.getInstance().gl;gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null),this.lastBindedElementBuffer=null},BufferTable.lastBindedArrayBufferListUidStr=null,BufferTable.lastBindedElementBuffer=null,BufferTable._table=wdCb.Hash.create(),BufferTable}();wd.BufferTable=BufferTable,function(BufferTableKey){BufferTableKey[BufferTableKey.PROCEDURAL_VERTEX="PROCEDURAL_VERTEX"]="PROCEDURAL_VERTEX",BufferTableKey[BufferTableKey.PROCEDURAL_INDEX="PROCEDURAL_INDEX"]="PROCEDURAL_INDEX"}(wd.BufferTableKey||(wd.BufferTableKey={}));wd.BufferTableKey}(wd||(wd={}));var wd;!function(wd){var ProgramTable=function(){function ProgramTable(){}return ProgramTable.hasProgram=function(key){return this._table.hasChild(key)},ProgramTable.addProgram=function(key,program){this._table.addChild(key,program)},ProgramTable.getProgram=function(key){return this._table.getChild(key)},ProgramTable.dispose=function(){this._table.forEach(function(program){program.dispose()}),this.lastUsedProgram=null},ProgramTable.clearAll=function(){this._table.removeAllChildren(),this.lastUsedProgram=null},ProgramTable.lastUsedProgram=null,ProgramTable._table=wdCb.Hash.create(),ProgramTable}();wd.ProgramTable=ProgramTable}(wd||(wd={}));var wd;!function(wd){var TextureCache=function(){function TextureCache(){}return TextureCache.isCached=function(unit,texture){return wd.JudgeUtils.isEqual(this.getActiveTexture(unit),texture)},TextureCache.addActiveTexture=function(unit,texture){this._bindTextureUnitCache[unit]=texture},TextureCache.getActiveTexture=function(unit){return this._bindTextureUnitCache[unit]},TextureCache.clearAll=function(){this._bindTextureUnitCache=[]},TextureCache.clearAllBindTextureUnitCache=function(){this._bindTextureUnitCache=[]},TextureCache.clearBindTextureUnitCache=function(unit){this._bindTextureUnitCache[unit]=null},TextureCache._checkUnit=function(unit){var maxTextureUnit=wd.GPUDetector.getInstance().maxTextureUnit;wd.assert(unit>=0,wd.Log.info.FUNC_SHOULD("texture unit",">= 0, but actual is "+unit)),wd.assert(unit<maxTextureUnit,"trying to cache "+unit+" texture units, but GPU only supports "+maxTextureUnit+" units")},TextureCache._bindTextureUnitCache=[],__decorate([wd.require(function(unit,texture){this._checkUnit(unit)})],TextureCache,"addActiveTexture",null),__decorate([wd.require(function(unit,texture){this._checkUnit(unit)})],TextureCache,"getActiveTexture",null),TextureCache}();wd.TextureCache=TextureCache}(wd||(wd={}));var wd;!function(wd){var GameObjectScene=function(_super){function GameObjectScene(){_super.apply(this,arguments),this._currentCamera=null,this.side=null,this.shadowMap=ShadowMapModel.create(this),this.physics=PhysicsConfig.create(),this.glslData=wdCb.Hash.create(),this.currentShaderType=null,this.renderTargetRendererManager=wd.RenderTargetRendererManager.create(),this.shadowManager=wd.ShadowManager.create(this),this._lightManager=wd.LightManager.create(),this._cameraList=wdCb.Collection.create()}return __extends(GameObjectScene,_super),GameObjectScene.create=function(){var obj=new this;return obj.initWhenCreate(),obj},Object.defineProperty(GameObjectScene.prototype,"ambientLight",{get:function(){return this._lightManager.ambientLight},enumerable:!0,configurable:!0}),Object.defineProperty(GameObjectScene.prototype,"directionLights",{get:function(){return this._lightManager.directionLights},enumerable:!0,configurable:!0}),Object.defineProperty(GameObjectScene.prototype,"pointLights",{get:function(){return this._lightManager.pointLights},enumerable:!0,configurable:!0}),Object.defineProperty(GameObjectScene.prototype,"currentCamera",{get:function(){return this._currentCamera||this._cameraList.getChild(0)},set:function(arg){if(wd.JudgeUtils.isNumber(arg)){var index=arg;this._currentCamera=this._cameraList.getChild(index)}else if(arg instanceof wd.GameObject){var currentCamera=arg;this._currentCamera=currentCamera}},enumerable:!0,configurable:!0}),Object.defineProperty(GameObjectScene.prototype,"isUseShader",{get:function(){return null!==this.currentShaderType},enumerable:!0,configurable:!0}),GameObjectScene.prototype.init=function(){return wd.PhysicsEngine.getInstance().initPhysicsEngineAdapter(),this.shadowManager.init(),_super.prototype.init.call(this),this.renderTargetRendererManager.init(),wd.PhysicsEngine.getInstance().initBody(),wd.PhysicsEngine.getInstance().initConstraint(),this},GameObjectScene.prototype.dispose=function(){_super.prototype.dispose.call(this),this.shadowManager.dispose(),this.renderTargetRendererManager.dispose()},GameObjectScene.prototype.addChild=function(child){var cameraList=this._getCameras(child),lightList=this._getLights(child);return cameraList.getCount()>0&&this._cameraList.addChildren(cameraList),lightList.getCount()>0&&this._lightManager.addChildren(lightList),_super.prototype.addChild.call(this,child)},GameObjectScene.prototype.update=function(elapsed){var currentCamera=this._getCurrentCameraComponent(),shadowManager=this.shadowManager;wd.PhysicsEngine.getInstance().update(elapsed),currentCamera&&currentCamera.update(elapsed),shadowManager.update(elapsed),wd.LODEngine.getInstance().update(elapsed),wd.SpacePartitionEngine.getInstance().update(elapsed),wd.AnimationEngine.getInstance().update(elapsed),wd.CollisionEngine.getInstance().update(elapsed),wd.ThreeDUIEngine.getInstance().update(elapsed),_super.prototype.update.call(this,elapsed),wd.CollisionEngine.getInstance().detect(elapsed),wd.BillboardEngine.getInstance().update(elapsed)},GameObjectScene.prototype.render=function(renderer){this.shadowManager.setShadowRenderListForCurrentLoop(),this.renderTargetRendererManager.render(renderer,this.currentCamera),_super.prototype.render.call(this,renderer,this.currentCamera)},GameObjectScene.prototype.useShaderType=function(type){this.currentShaderType=type},GameObjectScene.prototype.unUseShader=function(){this.currentShaderType=null},GameObjectScene.prototype.getRenderList=function(){return wd.RenderUtils.getGameObjectRenderList(this.getChildren())},GameObjectScene.prototype.createTransform=function(){return null},GameObjectScene.prototype._getCameras=function(gameObject){return this._find(gameObject,this._isCamera)},GameObjectScene.prototype._getLights=function(gameObject){return this._find(gameObject,this._isLight)},GameObjectScene.prototype._find=function(gameObject,judgeFunc){var self=this,resultArr=wdCb.Collection.create(),find=function(gameObject){judgeFunc.call(self,gameObject)&&resultArr.addChild(gameObject),gameObject.forEach(function(child){find(child)})};return find(gameObject),resultArr},GameObjectScene.prototype._isCamera=function(child){return child.hasComponent(wd.CameraController)},GameObjectScene.prototype._isLight=function(child){return child.hasComponent(wd.Light)},GameObjectScene.prototype._getCurrentCameraComponent=function(){return this.currentCamera?this.currentCamera.getComponent(wd.CameraController):null},__decorate([wd.requireSetter(function(arg){if(wd.JudgeUtils.isNumber(arg)){var index=arg;wd.assert(!!this._cameraList.getChild(index),wd.Log.info.FUNC_NOT_EXIST("current camera in cameraList"))}})],GameObjectScene.prototype,"currentCamera",null),GameObjectScene}(wd.Scene);wd.GameObjectScene=GameObjectScene;var PhysicsConfig=function(){function PhysicsConfig(){this._gravity=wd.Vector3.create(0,-9.8,0),this.enable=!1,this.engine=wd.EPhysicsEngineType.CANNON,this.iterations=10}return PhysicsConfig.create=function(){var obj=new this;return obj},Object.defineProperty(PhysicsConfig.prototype,"gravity",{get:function(){return this._gravity},set:function(gravity){this._gravity=gravity},enumerable:!0,configurable:!0}),__decorate([wd.operateWorldDataGetterAndSetter("Gravity")],PhysicsConfig.prototype,"gravity",null),PhysicsConfig}();wd.PhysicsConfig=PhysicsConfig;var ShadowMapModel=function(){function ShadowMapModel(scene){this._scene=null,this._enable=!0,this._softType=wd.EShadowMapSoftType.NONE,this.shadowLayerList=wd.ShadowLayerList.create(),this._scene=scene}return ShadowMapModel.create=function(scene){var obj=new this(scene);return obj},Object.defineProperty(ShadowMapModel.prototype,"enable",{get:function(){return this._enable},set:function(enable){this._enable=enable},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowMapModel.prototype,"softType",{get:function(){return this._softType},set:function(softType){softType!==this._softType&&(wd.EventManager.broadcast(this._scene,wd.CustomEvent.create(wd.EEngineEvent.SHADOWMAP_SOFTTYPE_CHANGE)),this._softType=softType)},enumerable:!0,configurable:!0}),ShadowMapModel.prototype.getTwoDShadowMapDataMap=function(layer){return this._scene.shadowManager.getTwoDShadowMapDataMap(layer)},ShadowMapModel.prototype.getCubemapShadowMapDataMap=function(layer){return this._scene.shadowManager.getCubemapShadowMapDataMap(layer)},ShadowMapModel}();wd.ShadowMapModel=ShadowMapModel}(wd||(wd={}));var wd;!function(wd){var CollisionDetector=function(){function CollisionDetector(){this._collisionTable=wdCb.Hash.create(),this._lastCollisionTable=wdCb.Hash.create()}return CollisionDetector.create=function(){var obj=new this;return obj},CollisionDetector.prototype.update=function(elapsed){var scene=wd.Director.getInstance().scene.gameObjectScene,checkTargetList=scene.filter(function(gameObjectScene){return gameObjectScene.hasComponent(wd.Collider)||wd.JudgeUtils.isSpacePartitionObject(gameObjectScene)&&gameObjectScene.getSpacePartition().isCollideEnable}),self=this;0!==checkTargetList.getCount()&&(this._clearCollisionTable(),checkTargetList.forEach(function(gameObjectScene){gameObjectScene.hasComponent(wd.RigidBody)||self._recordCollideObjects(gameObjectScene,checkTargetList)}),this._triggerCollisionEvent())},CollisionDetector.prototype._recordCollideObjects=function(sourceObject,checkTargetList){var self=this;if(wd.JudgeUtils.isSpacePartitionObject(sourceObject)){var sourceSpacePartition_1=sourceObject.getSpacePartition();return void checkTargetList.forEach(function(targetObject){wd.JudgeUtils.isSelf(sourceObject,targetObject)||(wd.JudgeUtils.isSpacePartitionObject(targetObject)?self._handleCollisionBetweenSpacePartitionAndSpacePartition(targetObject.getSpacePartition(),sourceSpacePartition_1):self._handleCollisionBetweenGameObjectAndSpacePartition(targetObject.getComponent(wd.Collider),sourceSpacePartition_1))})}var sourceObjectCollider=sourceObject.getComponent(wd.Collider);sourceObjectCollider.enable&&checkTargetList.forEach(function(targetObject){wd.JudgeUtils.isSelf(sourceObject,targetObject)||(wd.JudgeUtils.isSpacePartitionObject(targetObject)?self._handleCollisionBetweenGameObjectAndSpacePartition(sourceObjectCollider,targetObject.getSpacePartition()):self._handleCollisionBetweenGameObjectAndGameObject(sourceObjectCollider,targetObject))})},CollisionDetector.prototype._isGameObjectCollideWithGameObject=function(sourceObject,sourceCollider,targetObject){return!(this._isNotTransform(sourceObject)&&this._isNotTransform(targetObject)&&!sourceObject.hasTag(ECollisionTag.COLLIDED))&&sourceCollider.isCollide(targetObject)},CollisionDetector.prototype._clearCollisionTable=function(){this._collisionTable.removeAllChildren()},CollisionDetector.prototype._isCollidedInTable=function(sourceObject,targetObject){var table=this._collisionTable,sourceKey=String(sourceObject.uid),targetKey=String(targetObject.uid);return table.hasChild(sourceKey)&&table.getChild(sourceKey).targetObjectMap.hasChild(targetKey)},CollisionDetector.prototype._recordToTable=function(sourceObject,targetObject){var table=this._collisionTable,sourceKey=String(sourceObject.uid),targetKey=String(targetObject.uid);if(!table.hasChild(sourceKey)){var targetObjectMap=wdCb.Hash.create();return targetObjectMap.addChild(targetKey,targetObject),void table.addChild(sourceKey,{sourceObject:sourceObject,targetObjectMap:targetObjectMap})}table.getChild(sourceKey).targetObjectMap.addChild(targetKey,targetObject)},CollisionDetector.prototype._handleCollisionBetweenGameObjectAndSpacePartition=function(targetObjectCollider,spacePartition){var targetObject=targetObjectCollider.entityObject,self=this;targetObjectCollider.enable&&spacePartition.getCollideObjects(targetObjectCollider.shape).forEach(function(sourceObject){var sourceCollider=sourceObject.getComponent(wd.Collider);sourceCollider.enable&&!self._isCollidedInTable(sourceObject,targetObject)&&self._isGameObjectCollideWithGameObject(sourceObject,sourceCollider,targetObject)&&(self._recordToTable(sourceObject,targetObject),self._recordToTable(targetObject,sourceObject))})},CollisionDetector.prototype._handleCollisionBetweenSpacePartitionAndSpacePartition=function(sourceSpacePartition,targetSpacePartition){var _this=this;sourceSpacePartition.getChildren().forEach(function(sourceObject){var sourceCollider=sourceObject.getComponent(wd.Collider);sourceCollider.enable&&_this._handleCollisionBetweenGameObjectAndSpacePartition(sourceCollider,targetSpacePartition)},this)},CollisionDetector.prototype._handleCollisionBetweenGameObjectAndGameObject=function(sourceObjectCollider,targetObject){var sourceObject=sourceObjectCollider.entityObject;targetObject.getComponent(wd.Collider).enable&&!this._isCollidedInTable(sourceObject,targetObject)&&this._isGameObjectCollideWithGameObject(sourceObject,sourceObjectCollider,targetObject)&&(this._recordToTable(sourceObject,targetObject),this._recordToTable(targetObject,sourceObject))},CollisionDetector.prototype._isCollisionStart=function(gameObjectScene){return!gameObjectScene.hasTag(ECollisionTag.COLLIDED)},CollisionDetector.prototype._triggerCollisionEventOfCollideObjectWhichHasRigidBody=function(collideObjects,currentGameObject,eventList){currentGameObject.hasComponent(wd.RigidBody)&&collideObjects.filter(function(gameObjectScene){return gameObjectScene.hasComponent(wd.RigidBody)}).forEach(function(collideObject){for(var _i=0,eventList_1=eventList;_i<eventList_1.length;_i++){var eventName=eventList_1[_i];wd.ScriptEngine.getInstance().execEntityObjectScriptWithData(collideObject,eventName,wdCb.Collection.create([currentGameObject]))}})},CollisionDetector.prototype._triggerCollisionEvent=function(){var _this=this;this._collisionTable.forEach(function(_a){var sourceObject=_a.sourceObject,targetObjectMap=_a.targetObjectMap,targetObjects=targetObjectMap.toCollection();_this._isCollisionStart(sourceObject)?(wd.ScriptEngine.getInstance().execEntityObjectScriptWithData(sourceObject,"onCollisionStart",targetObjects),wd.ScriptEngine.getInstance().execEntityObjectScriptWithData(sourceObject,"onContact",targetObjects),_this._triggerCollisionEventOfCollideObjectWhichHasRigidBody(targetObjects,sourceObject,["onCollisionStart","onContact"])):(wd.ScriptEngine.getInstance().execEntityObjectScriptWithData(sourceObject,"onContact",targetObjects),_this._triggerCollisionEventOfCollideObjectWhichHasRigidBody(targetObjects,sourceObject,["onContact"])),sourceObject.hasTag(ECollisionTag.COLLIDED)||sourceObject.addTag(ECollisionTag.COLLIDED)},this),this._triggerCollisionEndEvent(),this._lastCollisionTable=this._collisionTable.clone()},CollisionDetector.prototype._triggerCollisionEndEvent=function(){var _this=this,table=this._collisionTable;this._lastCollisionTable.forEach(function(_a){var sourceObject=_a.sourceObject,targetObjectMap=_a.targetObjectMap;table.hasChild(String(sourceObject.uid))||(wd.ScriptEngine.getInstance().execEntityObjectScript(sourceObject,"onCollisionEnd"),_this._triggerCollisionEventOfCollideObjectWhichHasRigidBody(targetObjectMap.toCollection(),sourceObject,["onCollisionEnd"]),sourceObject.removeTag(ECollisionTag.COLLIDED))})},CollisionDetector.prototype._isNotTransform=function(gameObjectScene){return!gameObjectScene.transform.isTransform},__decorate([wd.require(function(sourceObject,checkTargetList){checkTargetList.forEach(function(targetObject){wd.assert(targetObject instanceof wd.GameObject,wd.Log.info.FUNC_SHOULD("targetObject","be GameObject"))})})],CollisionDetector.prototype,"_recordCollideObjects",null),__decorate([wd.require(function(sourceObject,sourceCollider,targetObject){wd.assert(sourceObject instanceof wd.GameObject&&targetObject instanceof wd.GameObject,wd.Log.info.FUNC_SHOULD("sourceObject and targetObject","be GameObject"))})],CollisionDetector.prototype,"_isGameObjectCollideWithGameObject",null),CollisionDetector}();wd.CollisionDetector=CollisionDetector;var ECollisionTag;!function(ECollisionTag){ECollisionTag[ECollisionTag.COLLIDED="COLLIDED"]="COLLIDED"}(ECollisionTag||(ECollisionTag={}))}(wd||(wd={}));var wd;!function(wd){var ShadowManager=function(){function ShadowManager(gameObjectScene){this.gameObjectScene=null,this._shadowRenderList=null,this._endLoopSubscription=null,this._shadowMapManager=wd.ShadowMapManager.create(this),this._shadowMapLayerChangeSubscription=null,this.gameObjectScene=gameObjectScene}return ShadowManager.create=function(gameObjectScene){var obj=new this(gameObjectScene);return obj},Object.defineProperty(ShadowManager.prototype,"twoDShadowMapDataMap",{get:function(){return this._shadowMapManager.twoDShadowMapDataMap},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowManager.prototype,"twoDShadowMapCountForGLSL",{get:function(){return this._shadowMapManager.twoDShadowMapCountForGLSL},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowManager.prototype,"cubemapShadowMapDataMap",{get:function(){return this._shadowMapManager.cubemapShadowMapDataMap},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowManager.prototype,"cubemapShadowMapCountForGLSL",{get:function(){return this._shadowMapManager.cubemapShadowMapCountForGLSL},enumerable:!0,configurable:!0}),ShadowManager.prototype.update=function(elapsed){this._isShadowMapEnable()&&this.gameObjectScene.shadowMap.shadowLayerList.update()},ShadowManager.prototype.dispose=function(){this._endLoopSubscription&&this._endLoopSubscription.dispose(),this._shadowMapLayerChangeSubscription&&this._shadowMapLayerChangeSubscription.dispose(),this._shadowMapManager.dispose()},ShadowManager.prototype.getTwoDShadowMapDataMap=function(layer){return this._shadowMapManager.twoDShadowMapDataMap.getChild(layer)},ShadowManager.prototype.getCubemapShadowMapDataMap=function(layer){return this._shadowMapManager.cubemapShadowMapDataMap.getChild(layer)},ShadowManager.prototype.setShadowRenderListForCurrentLoop=function(){this._isShadowMapEnable()&&(this._shadowRenderList=this._getShadowRenderList())},ShadowManager.prototype.getShadowRenderListByLayer=function(layer){return this._shadowRenderList.filter(function(gameObject){return gameObject.getComponent(wd.Shadow).layer===layer})},ShadowManager.prototype.getShadowLayerList=function(){var shadowLayerList=null,sceneShadowLayerList=this.gameObjectScene.shadowMap.shadowLayerList,self=this;return sceneShadowLayerList.dirty?sceneShadowLayerList.removeRepeatItems():(shadowLayerList=wd.ShadowLayerList.create(),wd.RenderUtils.getGameObjectRenderList(this.gameObjectScene.getChildren()).forEach(function(child){return wd.JudgeUtils.isSpacePartitionObject(child)?void child.forEach(function(c){self._isCastShadow(c)&&shadowLayerList.addChild(c.getComponent(wd.Shadow).layer)}):void(self._isCastShadow(child)&&shadowLayerList.addChild(child.getComponent(wd.Shadow).layer))}),shadowLayerList.dirty=!1,shadowLayerList.removeRepeatItems())},ShadowManager.prototype.init=function(){var self=this,scene=this.gameObjectScene,sceneShadowLayerList=null;this._isShadowMapEnable()&&this._hasShadow()&&(this.gameObjectScene.shadowMap.shadowLayerList=this.getShadowLayerList(),sceneShadowLayerList=this.gameObjectScene.shadowMap.shadowLayerList,sceneShadowLayerList.init(),this._shadowMapManager.initShadowMapData(sceneShadowLayerList),this._shadowMapManager.twoDShadowMapDataMap.forEach(function(twoDShadowMapDataList,layer){twoDShadowMapDataList.forEach(function(_a){var shadowMap=_a.shadowMap,light=_a.light,renderer=wd.TwoDShadowMapRenderTargetRenderer.create(shadowMap,light,layer);scene.renderTargetRendererManager.addCommonRenderTargetRenderer(renderer)})}),this._shadowMapManager.cubemapShadowMapDataMap.forEach(function(cubemapShadowMapDataList,layer){cubemapShadowMapDataList.forEach(function(_a){var shadowMap=_a.shadowMap,light=_a.light,renderer=wd.CubemapShadowMapRenderTargetRenderer.create(shadowMap,light,layer);scene.renderTargetRendererManager.addCommonRenderTargetRenderer(renderer)})}),this._initShadowList(),this._shadowMapLayerChangeSubscription=wd.EventManager.fromEvent(wd.EEngineEvent.SHADOWMAP_LAYER_CHANGE).subscribe(function(){self._updateWhenShadowLayerChange()}))},ShadowManager.prototype._getShadowRenderList=function(){var list=wdCb.Collection.create(),self=this;return wd.RenderUtils.getGameObjectRenderList(this.gameObjectScene.getChildren()).forEach(function(child){return wd.JudgeUtils.isSpacePartitionObject(child)?void list.addChildren(child.getSpacePartition().getRenderList().filter(function(c){return self._isCastShadow(c)})):void(self._isCastShadow(child)&&list.addChild(child))}),list},ShadowManager.prototype._updateWhenShadowLayerChange=function(){var scene=this.gameObjectScene;if(this._hasShadow()){this._shadowMapManager.updateWhenShadowLayerChange(scene.shadowMap.shadowLayerList.getDiffData());var _a=this._shadowMapManager.getAllDiffShadowMapDataWhenShadowLayerChange(),addTwoDShadowMapData=_a.addTwoDShadowMapData,removeTwoDShadowMapData=_a.removeTwoDShadowMapData,addCubemapShadowMapData=_a.addCubemapShadowMapData,removeCubemapShadowMapData=_a.removeCubemapShadowMapData;this._refreshRenderTargerRendererList(addTwoDShadowMapData,removeTwoDShadowMapData,addCubemapShadowMapData,removeCubemapShadowMapData)}},ShadowManager.prototype._refreshRenderTargerRendererList=function(addTwoDShadowMapData,removeTwoDShadowMapData,addCubemapShadowMapData,removeCubemapShadowMapData){var scene=this.gameObjectScene;scene.renderTargetRendererManager.removeCommonRenderTargetRenderer(function(renderTargetRenderer){var texture=renderTargetRenderer.texture;return removeTwoDShadowMapData.hasChildWithFunc(function(data){return wd.JudgeUtils.isEqual(data.shadowMap,texture)})||removeCubemapShadowMapData.hasChildWithFunc(function(data){return wd.JudgeUtils.isEqual(data.shadowMap,texture)})}).forEach(function(renderTargetRenderer){renderTargetRenderer.dispose()}),addTwoDShadowMapData.forEach(function(twoDShadowMapDataList,layer){twoDShadowMapDataList.forEach(function(_a){var shadowMap=_a.shadowMap,light=_a.light,renderer=wd.TwoDShadowMapRenderTargetRenderer.create(shadowMap,light,layer);renderer.init(),scene.renderTargetRendererManager.addCommonRenderTargetRenderer(renderer)})}),addCubemapShadowMapData.forEach(function(cubemapShadowMapDataList,layer){cubemapShadowMapDataList.forEach(function(_a){var shadowMap=_a.shadowMap,light=_a.light,renderer=wd.CubemapShadowMapRenderTargetRenderer.create(shadowMap,light,layer);renderer.init(),scene.renderTargetRendererManager.addCommonRenderTargetRenderer(renderer)})})},ShadowManager.prototype._initShadowList=function(){var self=this;this._endLoopSubscription=wd.EventManager.fromEvent(wd.EEngineEvent.ENDLOOP).subscribe(function(){self._removeShadowMapGLSLData()})},ShadowManager.prototype._isCastShadow=function(gameObject){var shadow=gameObject.getComponent(wd.Shadow);return!!shadow&&shadow.cast},ShadowManager.prototype._removeShadowMapGLSLData=function(){wd.Director.getInstance().scene.glslData.removeChild(wd.EShaderGLSLData.TWOD_SHADOWMAP),wd.Director.getInstance().scene.glslData.removeChild(wd.EShaderGLSLData.CUBEMAP_SHADOWMAP),wd.Director.getInstance().scene.glslData.removeChild(wd.EShaderGLSLData.BUILD_CUBEMAP_SHADOWMAP)},ShadowManager.prototype._hasShadow=function(){var scene=this.gameObjectScene;return!!scene.directionLights||!!scene.pointLights},ShadowManager.prototype._isShadowMapEnable=function(){return this.gameObjectScene.shadowMap.enable},__decorate([wd.require(function(){var self=this,checkFirstLevelOfGameObjectScene=function(){self.gameObjectScene.getChildren().filter(function(firstLevelChild){return!wd.JudgeUtils.isSpacePartitionObject(firstLevelChild)}).forEach(function(firstLevelChild){var checkChild=function(child){wd.assert(!child.hasComponent(wd.Shadow),wd.Log.info.FUNC_CAN_NOT("if the first level object of gameObjectScene don't contain Shadow component, its children","contain Shadow component")),child.forEach(function(c){checkChild(c)})};firstLevelChild.hasComponent(wd.Shadow)||firstLevelChild.forEach(function(child){checkChild(child)})})},checkFirstLevelOfSpacePartitionObject=function(){self.gameObjectScene.getChildren().filter(function(firstLevelChild){return wd.JudgeUtils.isSpacePartitionObject(firstLevelChild)}).forEach(function(spacePartitionObject){spacePartitionObject.forEach(function(firstLevelChildOfSpacePartitionObject){var checkChild=function(child){wd.assert(!child.hasComponent(wd.Shadow),wd.Log.info.FUNC_CAN_NOT("if the first level object of space partition objject don't contain Shadow component, its children","contain Shadow component")),child.forEach(function(c){checkChild(c)})};firstLevelChildOfSpacePartitionObject.hasComponent(wd.Shadow)||firstLevelChildOfSpacePartitionObject.forEach(function(child){checkChild(child)})})})};checkFirstLevelOfGameObjectScene(),checkFirstLevelOfSpacePartitionObject()})],ShadowManager.prototype,"_getShadowRenderList",null),__decorate([wd.require(function(){var shadowLayerList=this.gameObjectScene.shadowMap.shadowLayerList;wd.assert(shadowLayerList.dirty,wd.Log.info.FUNC_SHOULD("shadowLayerList","dirty")),this._getShadowRenderList().forEach(function(gameObject){wd.assert(shadowLayerList.hasChild(gameObject.getComponent(wd.Shadow).layer),wd.Log.info.FUNC_SHOULD("the shadow layer of shadow gameObject","exist in scene->shadowLayerList"))})})],ShadowManager.prototype,"_updateWhenShadowLayerChange",null),__decorate([wd.ensure(function(){wd.assert(!this.gameObjectScene.renderTargetRendererManager.getCommonRenderTargetRendererList().hasRepeatItems(),wd.Log.info.FUNC_SHOULD_NOT("scene->commonRenderTargetRendererList","has repeat items"))})],ShadowManager.prototype,"_refreshRenderTargerRendererList",null),ShadowManager}();wd.ShadowManager=ShadowManager}(wd||(wd={}));var wd;!function(wd){var ShadowMapManager=function(){function ShadowMapManager(shadowManager){this.twoDShadowMapDataMap=wdCb.Hash.create(),this.cubemapShadowMapDataMap=wdCb.Hash.create(),this._shadowManager=null,this._lastTwoDShadowMapDataMap=wdCb.Hash.create(),this._lastCubemapShadowMapDataMap=wdCb.Hash.create(),this._shadowManager=shadowManager}return ShadowMapManager.create=function(shadowManager){var obj=new this(shadowManager);return obj},Object.defineProperty(ShadowMapManager.prototype,"twoDShadowMapCountForGLSL",{get:function(){var count=0;return this.twoDShadowMapDataMap.forEach(function(dataList){count+=dataList.getCount()}),count},enumerable:!0,configurable:!0}),Object.defineProperty(ShadowMapManager.prototype,"cubemapShadowMapCountForGLSL",{get:function(){var count=0;return this.cubemapShadowMapDataMap.forEach(function(dataList){count+=dataList.getCount()}),count},enumerable:!0,configurable:!0}),ShadowMapManager.prototype.initShadowMapData=function(shadowLayerList){var _this=this,scene=this._shadowManager.gameObjectScene;scene.directionLights&&scene.directionLights.getCount()>0&&scene.directionLights.forEach(function(lightObject){var light=lightObject.getComponent(wd.DirectionLight);light.castShadow&&_this._addTwoDShadowMapDataWithLayer(shadowLayerList,light)},this),scene.pointLights&&scene.pointLights.getCount()>0&&scene.pointLights.forEach(function(lightObject){var light=lightObject.getComponent(wd.PointLight);light.castShadow&&_this._addCubemapShadowMapDataWithLayer(shadowLayerList,light)},this)},ShadowMapManager.prototype.updateWhenShadowLayerChange=function(_a){var _this=this,addLayerList=_a.addLayerList,removeLayerList=_a.removeLayerList,scene=null;if(scene=this._shadowManager.gameObjectScene,scene.directionLights&&scene.directionLights.getCount()>0){var twoDShadowMapDataMap_1=this.twoDShadowMapDataMap;this._lastTwoDShadowMapDataMap=twoDShadowMapDataMap_1.clone(),
removeLayerList.forEach(function(layer){twoDShadowMapDataMap_1.removeChild(layer)}),scene.directionLights.forEach(function(lightObject){var light=lightObject.getComponent(wd.DirectionLight);light.castShadow&&_this._addTwoDShadowMapDataWithLayer(addLayerList,light)},this)}if(scene.pointLights&&scene.pointLights.getCount()>0){var cubemapShadowMapDataMap_1=this.cubemapShadowMapDataMap;this._lastCubemapShadowMapDataMap=cubemapShadowMapDataMap_1.clone(),removeLayerList.forEach(function(layer){cubemapShadowMapDataMap_1.removeChild(layer)}),scene.pointLights.forEach(function(lightObject){var light=lightObject.getComponent(wd.PointLight);light.castShadow&&_this._addCubemapShadowMapDataWithLayer(addLayerList,light)},this)}},ShadowMapManager.prototype.getAllDiffShadowMapDataWhenShadowLayerChange=function(){var twoDDiff=this._getDiffShadowMapDataWhenShadowLayerChange(this._lastTwoDShadowMapDataMap,this.twoDShadowMapDataMap),cubemapDiff=this._getDiffShadowMapDataWhenShadowLayerChange(this._lastCubemapShadowMapDataMap,this.cubemapShadowMapDataMap);return{addTwoDShadowMapData:twoDDiff.addShadowMapData,removeTwoDShadowMapData:twoDDiff.removeShadowMapData,addCubemapShadowMapData:cubemapDiff.addShadowMapData,removeCubemapShadowMapData:cubemapDiff.removeShadowMapData}},ShadowMapManager.prototype._getDiffShadowMapDataWhenShadowLayerChange=function(lastShadowMapDataMap,currentShadowMapDataMap){var addShadowMapData=wdCb.Hash.create(),removeShadowMapData=wdCb.Collection.create();return removeShadowMapData=lastShadowMapDataMap.filter(function(shadowMapDataList,layer){return!currentShadowMapDataMap.hasChild(layer)}).toCollection(),addShadowMapData=currentShadowMapDataMap.filter(function(shadowMapDataList,layer){return!lastShadowMapDataMap.hasChild(layer)}),{addShadowMapData:addShadowMapData,removeShadowMapData:removeShadowMapData}},ShadowMapManager.prototype._addTwoDShadowMapDataWithLayer=function(layerList,light){var twoDShadowMapDataMap=this.twoDShadowMapDataMap;layerList.forEach(function(layer){twoDShadowMapDataMap.appendChild(layer,{shadowMap:wd.TwoDShadowMapTexture.create(),light:light})})},ShadowMapManager.prototype._addCubemapShadowMapDataWithLayer=function(layerList,light){var cubemapShadowMapDataMap=this.cubemapShadowMapDataMap;layerList.forEach(function(layer){cubemapShadowMapDataMap.appendChild(layer,{shadowMap:wd.CubemapShadowMapTexture.create(),light:light})})},ShadowMapManager.prototype.dispose=function(){},__decorate([wd.require(function(layerList,light){wd.assert(!layerList.hasRepeatItems(),wd.Log.info.FUNC_SHOULD_NOT("has repeat shadow layer"))})],ShadowMapManager.prototype,"_addTwoDShadowMapDataWithLayer",null),__decorate([wd.require(function(layerList,light){wd.assert(!layerList.hasRepeatItems(),wd.Log.info.FUNC_SHOULD_NOT("has repeat shadow layer"))})],ShadowMapManager.prototype,"_addCubemapShadowMapDataWithLayer",null),ShadowMapManager}();wd.ShadowMapManager=ShadowMapManager}(wd||(wd={}));var wd;!function(wd){var LightManager=function(){function LightManager(){this._lights=wdCb.Hash.create()}return LightManager.create=function(){var obj=new this;return obj},Object.defineProperty(LightManager.prototype,"ambientLight",{get:function(){return this._lights.getChild(wd.AmbientLight.type)},enumerable:!0,configurable:!0}),Object.defineProperty(LightManager.prototype,"directionLights",{get:function(){return this._getLights(wd.DirectionLight.type)},enumerable:!0,configurable:!0}),Object.defineProperty(LightManager.prototype,"pointLights",{get:function(){return this._getLights(wd.PointLight.type)},enumerable:!0,configurable:!0}),LightManager.prototype.addChild=function(light){light.hasComponent(wd.AmbientLight)?this._lights.addChild(wd.AmbientLight.type,light):light.hasComponent(wd.DirectionLight)?this._lights.appendChild(wd.DirectionLight.type,light):light.hasComponent(wd.PointLight)?this._lights.appendChild(wd.PointLight.type,light):wd.Log.error(!0,wd.Log.info.FUNC_INVALID("light"))},LightManager.prototype.addChildren=function(lightList){var self=this;lightList.forEach(function(light){self.addChild(light)})},LightManager.prototype._getLights=function(type){return this._lights.getChild(type)},LightManager}();wd.LightManager=LightManager}(wd||(wd={}));var wd;!function(wd){var RenderTargetRendererManager=function(){function RenderTargetRendererManager(){this._commonRenderTargetRendererList=wdCb.Collection.create(),this._proceduralRendererList=wdCb.Collection.create()}return RenderTargetRendererManager.create=function(){var obj=new this;return obj},RenderTargetRendererManager.prototype.init=function(){this._commonRenderTargetRendererList.forEach(function(renderTargetRenderer){return renderTargetRenderer.init()}),this._proceduralRendererList.forEach(function(renderTargetRenderer){return renderTargetRenderer.init()})},RenderTargetRendererManager.prototype.dispose=function(){this._commonRenderTargetRendererList.forEach(function(renderTargetRenderer){return renderTargetRenderer.dispose()}),this._proceduralRendererList.forEach(function(renderTargetRenderer){return renderTargetRenderer.dispose()})},RenderTargetRendererManager.prototype.addCommonRenderTargetRenderer=function(renderTargetRenderer){this._commonRenderTargetRendererList.addChild(renderTargetRenderer)},RenderTargetRendererManager.prototype.getCommonRenderTargetRendererList=function(){return this._commonRenderTargetRendererList},RenderTargetRendererManager.prototype.removeCommonRenderTargetRenderer=function(func){return this._commonRenderTargetRendererList.removeChild(func)},RenderTargetRendererManager.prototype.addProceduralRenderTargetRenderer=function(renderTargetRenderer){this._proceduralRendererList.addChild(renderTargetRenderer)},RenderTargetRendererManager.prototype.render=function(renderer,camera){this._proceduralRendererList.filter(function(target){return target.needRender()}).forEach(function(target){target.render(renderer)}),this._commonRenderTargetRendererList.filter(function(target){return target.needRender()}).forEach(function(target){target.render(renderer,camera)})},RenderTargetRendererManager}();wd.RenderTargetRendererManager=RenderTargetRendererManager}(wd||(wd={}));var wd;!function(wd){var ShadowLayerList=function(){function ShadowLayerList(){this.dirty=!1,this._list=wdCb.Collection.create(),this._lastList=null}return ShadowLayerList.create=function(){var obj=new this;return obj},ShadowLayerList.prototype.init=function(){this._lastList=this._list.clone()},ShadowLayerList.prototype.update=function(){this.dirty&&(wd.EventManager.trigger(wd.CustomEvent.create(wd.EEngineEvent.SHADOWMAP_LAYER_CHANGE)),this.dirty=!1),this._lastList=this._list.clone()},ShadowLayerList.prototype.getDiffData=function(){var lastList=this._lastList,currentList=this._list,addLayerList=null,removeLayerList=null;return null===lastList?{addLayerList:this._list.clone(),removeLayerList:wdCb.Collection.create()}:(addLayerList=wdCb.Collection.create(),removeLayerList=wdCb.Collection.create(),removeLayerList=lastList.filter(function(layer){return!currentList.hasChild(layer)}),addLayerList=currentList.filter(function(layer){return!lastList.hasChild(layer)}),{addLayerList:addLayerList,removeLayerList:removeLayerList})},ShadowLayerList.prototype.getCount=function(){return this._list.getCount()},ShadowLayerList.prototype.addChild=function(layer){this._list.addChild(layer),this.dirty=!0},ShadowLayerList.prototype.addChildren=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];this._list.addChildren.apply(this._list,args),this.dirty=!0},ShadowLayerList.prototype.removeChild=function(layer){return this.dirty=!0,this._convertCollectionToThis(this._list.removeChild(layer))},ShadowLayerList.prototype.removeAllChildren=function(){this.dirty=!0,this._list.removeAllChildren()},ShadowLayerList.prototype.removeRepeatItems=function(){var result=this._convertCollectionToThis(this._list.removeRepeatItems());return result.dirty=this.dirty,result},ShadowLayerList.prototype.hasRepeatItems=function(){return this._list.hasRepeatItems()},ShadowLayerList.prototype.forEach=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];this._list.forEach.apply(this._list,args)},ShadowLayerList.prototype.getChildren=function(){return this._list.getChildren()},ShadowLayerList.prototype.hasChild=function(layer){return this._list.hasChild(layer)},ShadowLayerList.prototype._convertCollectionToThis=function(list){var result=ShadowLayerList.create();return result.addChildren(list.getChildren()),result},ShadowLayerList}();wd.ShadowLayerList=ShadowLayerList}(wd||(wd={}));var wd;!function(wd){var EventListenerMap=function(){function EventListenerMap(){this.listenerMap=wdCb.Hash.create()}return EventListenerMap.prototype.hasChild=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var target=args[0],eventName=args[1],list=this.listenerMap.getChild(this.buildKey(target,eventName));return list&&list.getCount()>0},EventListenerMap.prototype.hasChildWithFunc=function(func){return this.listenerMap.hasChildWithFunc(func)},EventListenerMap.prototype.appendChild=function(target,eventName,data){this.listenerMap.appendChild(this.buildKey(target,eventName),data)},EventListenerMap.prototype.filter=function(func){return this.listenerMap.filter(func)},EventListenerMap.prototype.forEach=function(func){return this.listenerMap.forEach(func)},EventListenerMap.prototype.getEventNameFromKey=function(key){var separator=this.getEventSeparator();return key.indexOf(separator)>-1?key.split(separator)[1]:key},EventListenerMap.prototype.isEventName=function(key,eventName){return key.indexOf(""+this.getEventSeparator()+eventName)>-1||key===eventName},EventListenerMap}();wd.EventListenerMap=EventListenerMap}(wd||(wd={}));var wd;!function(wd){var CustomEventListenerMap=function(_super){function CustomEventListenerMap(){_super.apply(this,arguments)}return __extends(CustomEventListenerMap,_super),CustomEventListenerMap.create=function(){var obj=new this;return obj},CustomEventListenerMap.prototype.getChild=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var self=this;if(1===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0];return this.listenerMap.getChild(eventName)}if(1===args.length&&args[0]instanceof wd.EntityObject){var target_1=args[0];return this.listenerMap.filter(function(list,key){return self.isTarget(key,target_1,list)})}if(2===args.length){var target=args[0],eventName=args[1];return this.listenerMap.getChild(this.buildKey(target,eventName))}},CustomEventListenerMap.prototype.removeChild=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var self=this;if(1===args.length&&wd.JudgeUtils.isString(args[0])){var eventName_1=args[0];this.listenerMap.removeChild(function(list,key){return self.isEventName(key,eventName_1)})}else if(1===args.length&&args[0]instanceof wd.EntityObject){var target_2=args[0];this.listenerMap.removeChild(function(list,key){return self.isTarget(key,target_2,list)})}else if(2===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0],handler_1=args[1],list=null;this.listenerMap.hasChild(eventName)&&(list=this.listenerMap.getChild(eventName),wdCb.Collection.create().addChild(list.removeChild(function(val){return val.originHandler===handler_1})),0===list.getCount()&&this.listenerMap.removeChild(eventName))}else if(2===args.length&&wd.JudgeUtils.isNumber(args[0])){var uid=args[0],eventName=args[1];this.listenerMap.removeChild(this.buildKey(uid,eventName))}else if(2===args.length&&args[0]instanceof wd.EntityObject){var target=args[0],eventName=args[1];this.listenerMap.removeChild(this.buildKey(target,eventName))}else if(3===args.length&&args[0]instanceof wd.EntityObject){var eventName=args[1],handler_2=args[2];this.listenerMap.forEach(function(list,key){if(list.removeChild(function(val){return val.originHandler===handler_2}),0===list.getCount())return wdCb.$REMOVE})}},CustomEventListenerMap.prototype.getUidFromKey=function(key){var separator=""+CustomEventListenerMap.eventSeparator;return key.indexOf(separator)>-1?Number(key.split(separator)[0]):null},CustomEventListenerMap.prototype.isTarget=function(key,target,list){return key.indexOf(this._buildKeyPrefix(target.uid))>-1&&void 0!==list},CustomEventListenerMap.prototype.getEventSeparator=function(){return""+CustomEventListenerMap.eventSeparator},CustomEventListenerMap.prototype.buildKey=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(wd.JudgeUtils.isNumber(args[0])){var uid=args[0],eventName=args[1];return this._buildKeyWithUid(uid,eventName)}if(args[0]instanceof wd.EntityObject){var target=args[0],eventName=args[1];return this._buildKeyWithUid(target.uid,eventName)}if(null===args[0]){var eventName=args[1];return eventName}},CustomEventListenerMap.prototype._buildKeyWithUid=function(uid,eventName){return""+this._buildKeyPrefix(uid)+CustomEventListenerMap.eventSeparator+eventName},CustomEventListenerMap.prototype._buildKeyPrefix=function(uid){return""+String(uid)},CustomEventListenerMap.eventSeparator="@",CustomEventListenerMap}(wd.EventListenerMap);wd.CustomEventListenerMap=CustomEventListenerMap}(wd||(wd={}));var wd;!function(wd){var DomEventListenerMap=function(_super){function DomEventListenerMap(){_super.apply(this,arguments)}return __extends(DomEventListenerMap,_super),DomEventListenerMap.create=function(){var obj=new this;return obj},DomEventListenerMap.prototype.getChild=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(1===args.length){var eventName=args[0];return this.listenerMap.getChild(eventName)}if(2===args.length){var dom=args[0],eventName=args[1];return this.listenerMap.getChild(this.buildKey(dom,eventName))}},DomEventListenerMap.prototype.removeChild=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var self=this,result=null;if(1===args.length&&wd.JudgeUtils.isString(args[0])){var eventName_2=args[0];result=this._getEventDataOffDataList(eventName_2,this.listenerMap.removeChild(function(list,key){return self.isEventName(key,eventName_2)}))}else if(2===args.length&&wd.JudgeUtils.isString(args[0])){var eventName_3=args[0],handler_3=args[1],resultList_1=wdCb.Collection.create();this.listenerMap.forEach(function(list,key){if(self.isEventName(key,eventName_3)){var result_1=list.removeChild(function(val){return val.originHandler===handler_3});if(result_1.getCount()>0&&resultList_1.addChild(result_1),0===list.getCount())return wdCb.$REMOVE}}),result=this._getEventDataOffDataList(eventName_3,resultList_1)}else if(2===args.length&&wd.JudgeUtils.isDom(args[0])){var dom=args[0],eventName=args[1];result=this._getEventDataOffDataList(eventName,this.listenerMap.removeChild(this.buildKey(dom,eventName)))}else if(3===args.length&&wd.JudgeUtils.isDom(args[0])){var eventName=args[1],resultList_2=wdCb.Collection.create(),handler_4=args[2];this.listenerMap.forEach(function(list,key){var result=list.removeChild(function(val){return val.originHandler===handler_4});if(result.getCount()>0&&resultList_2.addChild(result),0===list.getCount())return wdCb.$REMOVE}),result=this._getEventDataOffDataList(eventName,resultList_2)}return result},DomEventListenerMap.prototype.isDom=function(key,dom,list){return key.indexOf(this._buildKeyPrefix(dom))>-1&&void 0!==list},DomEventListenerMap.prototype.getEventSeparator=function(){return""+DomEventListenerMap.eventSeparator},DomEventListenerMap.prototype.buildKey=function(dom,eventName){return""+this._buildKeyPrefix(dom)+DomEventListenerMap.eventSeparator+eventName},DomEventListenerMap.prototype._buildKeyPrefix=function(dom){return dom.id?""+dom.tagName+dom.id:""+dom.tagName},DomEventListenerMap.prototype._getEventDataOffDataList=function(eventName,result){return result.map(function(list){return list.map(function(data){return{dom:data.dom,eventName:eventName,domHandler:data.domHandler}})})},DomEventListenerMap.eventSeparator="@",DomEventListenerMap}(wd.EventListenerMap);wd.DomEventListenerMap=DomEventListenerMap}(wd||(wd={}));var wd;!function(wd){!function(EEventType){EEventType[EEventType.MOUSE=0]="MOUSE",EEventType[EEventType.KEYBOARD=1]="KEYBOARD",EEventType[EEventType.CUSTOM=2]="CUSTOM"}(wd.EEventType||(wd.EEventType={}));wd.EEventType}(wd||(wd={}));var wd;!function(wd){var EBrowserIdentifier;!function(EBrowserIdentifier){EBrowserIdentifier[EBrowserIdentifier.FALLBACK="fallback"]="FALLBACK",EBrowserIdentifier[EBrowserIdentifier.FIREFOX="firefox"]="FIREFOX",EBrowserIdentifier[EBrowserIdentifier.CHROME="chrome"]="CHROME"}(EBrowserIdentifier||(EBrowserIdentifier={})),function(EEventName){EEventName[EEventName.CLICK="click"]="CLICK",EEventName[EEventName.MOUSEOVER="mouseover"]="MOUSEOVER",EEventName[EEventName.MOUSEUP="mouseup"]="MOUSEUP",EEventName[EEventName.MOUSEOUT="mouseout"]="MOUSEOUT",EEventName[EEventName.MOUSEMOVE="mousemove"]="MOUSEMOVE",EEventName[EEventName.MOUSEDOWN="mousedown"]="MOUSEDOWN",EEventName[EEventName.MOUSEWHEEL="mousewheel|DOMMouseScroll*"+EBrowserIdentifier.FIREFOX]="MOUSEWHEEL",EEventName[EEventName.MOUSEDRAG="mousedrag"]="MOUSEDRAG",EEventName[EEventName.KEYDOWN="keydown"]="KEYDOWN",EEventName[EEventName.KEYUP="keyup"]="KEYUP",EEventName[EEventName.KEYPRESS="keypress"]="KEYPRESS"}(wd.EEventName||(wd.EEventName={}));var EVENTNAME_SPLITTER=(wd.EEventName,"|"),BROWSER_IDENTIFIER="*",EventNameHandler=function(){function EventNameHandler(){}return EventNameHandler.handleEventName=function(domEventName){for(var eventName=domEventName,fallbackEventName=null,specifyBrowserEventNameArr=[],result=null,_i=0,_a=eventName.split(EVENTNAME_SPLITTER);_i<_a.length;_i++){var name_1=_a[_i];this._isFallbackEventName(name_1)?fallbackEventName=name_1:specifyBrowserEventNameArr.push(name_1)}return result=this._getSpecifyBrowserEventName(specifyBrowserEventNameArr),null!==result?result:fallbackEventName},EventNameHandler._isFallbackEventName=function(eventName){return 1===eventName.split(BROWSER_IDENTIFIER).length},EventNameHandler._getSpecifyBrowserEventName=function(specifyBrowserEventNameArr){for(var result=null,_i=0,specifyBrowserEventNameArr_1=specifyBrowserEventNameArr;_i<specifyBrowserEventNameArr_1.length;_i++){var eventName=specifyBrowserEventNameArr_1[_i],_a=eventName.split(BROWSER_IDENTIFIER),domEventName=_a[0],browserIdentifier=_a[1];switch(browserIdentifier){case EBrowserIdentifier.CHROME:bowser.chrome&&(result=domEventName);break;case EBrowserIdentifier.FIREFOX:bowser.firefox&&(result=domEventName)}if(result)break}return result},EventNameHandler}();wd.EventNameHandler=EventNameHandler}(wd||(wd={}));var wd;!function(wd){!function(EEventPhase){EEventPhase[EEventPhase.BROADCAST=0]="BROADCAST",EEventPhase[EEventPhase.EMIT=1]="EMIT"}(wd.EEventPhase||(wd.EEventPhase={}));wd.EEventPhase}(wd||(wd={}));var wd;!function(wd){var _table=wdCb.Hash.create();_table.addChild(wd.EEventName.CLICK,wd.EEventType.MOUSE),_table.addChild(wd.EEventName.MOUSEOVER,wd.EEventType.MOUSE),_table.addChild(wd.EEventName.MOUSEOUT,wd.EEventType.MOUSE),_table.addChild(wd.EEventName.MOUSEMOVE,wd.EEventType.MOUSE),_table.addChild(wd.EEventName.MOUSEDOWN,wd.EEventType.MOUSE),_table.addChild(wd.EEventName.MOUSEUP,wd.EEventType.MOUSE),_table.addChild(wd.EEventName.MOUSEWHEEL,wd.EEventType.MOUSE),_table.addChild(wd.EEventName.MOUSEDRAG,wd.EEventType.MOUSE),_table.addChild(wd.EEventName.KEYDOWN,wd.EEventType.KEYBOARD),_table.addChild(wd.EEventName.KEYPRESS,wd.EEventType.KEYBOARD),_table.addChild(wd.EEventName.KEYUP,wd.EEventType.KEYBOARD);var EventTable=function(){function EventTable(){}return EventTable.getEventType=function(eventName){var result=_table.getChild(eventName);return void 0===result&&(result=wd.EEventType.CUSTOM),result},EventTable}();wd.EventTable=EventTable}(wd||(wd={}));var wd;!function(wd){var Event=function(){function Event(eventName){this.p_type=null,this.name=null,this.currentTarget=null,this.isStopPropagation=!1,this.phase=null,this.name=eventName}return Object.defineProperty(Event.prototype,"type",{get:function(){return wd.Log.error(null===this.p_type,wd.Log.info.ABSTRACT_ATTRIBUTE),this.p_type},enumerable:!0,configurable:!0}),Event.prototype.stopPropagation=function(){this.isStopPropagation=!0},Event.prototype.copyMember=function(destination,source,memberArr){return memberArr.forEach(function(member){destination[member]=source[member]}),destination},Event}();wd.Event=Event}(wd||(wd={}));var wd;!function(wd){var DomEvent=function(_super){function DomEvent(event,eventName){_super.call(this,eventName),this._event=null,this.event=event}return __extends(DomEvent,_super),Object.defineProperty(DomEvent.prototype,"event",{get:function(){return this._event},set:function(event){this._event=event||wd.root.event},enumerable:!0,configurable:!0}),DomEvent.prototype.preventDefault=function(){var e=this._event;bowser.msie&&Number(bowser.version)<=8?e.returnValue=!1:e.preventDefault()},DomEvent.prototype.getDataFromCustomEvent=function(event){this.target=event.target,this.currentTarget=event.currentTarget,this.isStopPropagation=event.isStopPropagation},DomEvent}(wd.Event);wd.DomEvent=DomEvent}(wd||(wd={}));var wd;!function(wd_1){var MouseEvent=function(_super){function MouseEvent(){_super.apply(this,arguments),this._location=null,this._locationInView=null,this._button=null,this.lastX=null,this.lastY=null,this.p_type=wd_1.EEventType.MOUSE}return __extends(MouseEvent,_super),MouseEvent.create=function(event,eventName){var obj=new this(event,eventName);return obj},Object.defineProperty(MouseEvent.prototype,"location",{get:function(){var point=null,e=this.event;return this._location?this._location:(point=wd_1.Point.create(),bowser.msie?(point.x=e.clientX+document.body.scrollLeft||document.documentElement.scrollLeft,point.y=e.clientY+document.body.scrollTop||document.documentElement.scrollTop):(point.x=e.pageX,point.y=e.pageY),point)},set:function(point){this._location=point},enumerable:!0,configurable:!0}),Object.defineProperty(MouseEvent.prototype,"locationInView",{get:function(){var point=null,viewOffset=null;return this._locationInView?this._locationInView:(point=this.location,viewOffset=wd_1.DeviceManager.getInstance().view.offset,wd_1.Point.create(point.x-viewOffset.x,point.y-viewOffset.y))},set:function(locationInView){this._locationInView=locationInView},enumerable:!0,configurable:!0}),Object.defineProperty(MouseEvent.prototype,"button",{get:function(){var e=this.event,mouseButton=null;if(this._button)return this._button;if(bowser.msie)switch(e.button){case 1:mouseButton=wd_1.EMouseButton.LEFT;break;case 4:mouseButton=wd_1.EMouseButton.RIGHT;break;case 2:mouseButton=wd_1.EMouseButton.CENTER;break;default:wd_1.Log.error(!0,wd_1.Log.info.FUNC_NOT_SUPPORT("multi mouse button"))}else switch(e.button){case 0:mouseButton=wd_1.EMouseButton.LEFT;break;case 1:mouseButton=wd_1.EMouseButton.RIGHT;break;case 2:mouseButton=wd_1.EMouseButton.CENTER;break;default:wd_1.Log.error(!0,wd_1.Log.info.FUNC_NOT_SUPPORT("multi mouse button"))}return mouseButton},set:function(button){this._button=button},enumerable:!0,configurable:!0}),Object.defineProperty(MouseEvent.prototype,"wheel",{get:function(){var e=this.event;return e.detail?-1*e.detail:e.wheelDelta?e.wheelDelta/120:0},enumerable:!0,configurable:!0}),Object.defineProperty(MouseEvent.prototype,"movementDelta",{get:function(){var e=this.event,dx=null,wd=null;if(this._isPointerLocked())dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,wd=e.movementY||e.webkitMovementY||e.mozMovementY||0;else{var location_1=this.location,lastX=this.lastX,lastY=this.lastY;null===lastX&&null===lastY?(dx=0,wd=0):(dx=location_1.x-lastX,wd=location_1.y-lastY)}return{x:dx,y:wd}},enumerable:!0,configurable:!0}),MouseEvent.prototype.clone=function(){var eventObj=MouseEvent.create(this.event,this.name);return this.copyMember(eventObj,this,["target","currentTarget","isStopPropagation","phase","lastX","lastY"])},MouseEvent.prototype._isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)},MouseEvent}(wd_1.DomEvent);wd_1.MouseEvent=MouseEvent}(wd||(wd={}));var wd;!function(wd){var SPECIAL_KEY_MAP={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},SHIFT_KEY_MAP={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},KeyboardEvent=function(_super){function KeyboardEvent(){_super.apply(this,arguments),this.p_type=wd.EEventType.KEYBOARD,this.keyState=null}return __extends(KeyboardEvent,_super),KeyboardEvent.create=function(event,eventName){var obj=new this(event,eventName);return obj},Object.defineProperty(KeyboardEvent.prototype,"ctrlKey",{get:function(){return this.event.ctrlKey},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"altKey",{get:function(){return this.event.altKey},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"shiftKey",{get:function(){return this.event.shiftKey},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"metaKey",{get:function(){return this.event.metaKey},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"keyCode",{get:function(){return this.event.keyCode},enumerable:!0,configurable:!0}),Object.defineProperty(KeyboardEvent.prototype,"key",{get:function(){var key=SPECIAL_KEY_MAP[this.keyCode],char=null;return key?key:(char=String.fromCharCode(this.keyCode).toLowerCase(),this.shiftKey?SHIFT_KEY_MAP[char]:char)},enumerable:!0,configurable:!0}),KeyboardEvent.prototype.clone=function(){var eventObj=KeyboardEvent.create(this.event,this.name);return this.copyMember(eventObj,this,["target","currentTarget","isStopPropagation","phase","altKey","shiftKey","ctrlKey","metaKey","keyCode","key"])},KeyboardEvent}(wd.DomEvent);wd.KeyboardEvent=KeyboardEvent}(wd||(wd={}));var wd;!function(wd){var CustomEvent=function(_super){function CustomEvent(){_super.apply(this,arguments),this.userData=null,this.p_type=wd.EEventType.CUSTOM}return __extends(CustomEvent,_super),CustomEvent.create=function(eventName){var obj=new this(eventName);return obj},CustomEvent.prototype.copyPublicAttri=function(destination,source){return wdCb.ExtendUtils.extend(destination,function(item,property){return"_"!==property.slice(0,1)&&!wd.JudgeUtils.isFunction(item)}),destination},CustomEvent.prototype.clone=function(){var eventObj=CustomEvent.create(this.name);return this.copyMember(eventObj,this,["target","currentTarget","isStopPropagation","phase"])},CustomEvent.prototype.getDataFromDomEvent=function(event){this.target=event.target,this.currentTarget=event.currentTarget,this.isStopPropagation=event.isStopPropagation},CustomEvent}(wd.Event);wd.CustomEvent=CustomEvent}(wd||(wd={}));var wd;!function(wd){!function(EMouseButton){EMouseButton[EMouseButton.LEFT=0]="LEFT",EMouseButton[EMouseButton.RIGHT=1]="RIGHT",EMouseButton[EMouseButton.CENTER=2]="CENTER"}(wd.EMouseButton||(wd.EMouseButton={}));wd.EMouseButton}(wd||(wd={}));var wd;!function(wd){var EventListener=function(){function EventListener(option){this.eventType=null,this.priority=null,this.handlerDataList=wdCb.Collection.create(),this.eventType=option.eventType,this.priority=option.priority||1}return EventListener.create=function(option){var obj=new this(option);return obj.initWhenCreate(option),obj},EventListener.prototype.initWhenCreate=function(option){this._setHandlerDataList(option)},EventListener.prototype._setHandlerDataList=function(option){var i=null,REGEX_HANDER=/on\w+/;for(i in option)option.hasOwnProperty(i)&&REGEX_HANDER.test(i)&&this.handlerDataList.addChild({eventName:this._parseEventName(i),handler:option[i]})},EventListener.prototype._parseEventName=function(handlerName){return handlerName.slice(2).toLowerCase()},EventListener}();wd.EventListener=EventListener}(wd||(wd={}));var wd;!function(wd){var EventHandler=function(){function EventHandler(){}return EventHandler}();wd.EventHandler=EventHandler}(wd||(wd={}));var wd;!function(wd){var DomEventHandler=function(_super){function DomEventHandler(){_super.apply(this,arguments)}return __extends(DomEventHandler,_super),DomEventHandler.prototype.off=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var self=this,eventRegister=wd.DomEventRegister.getInstance(),eventOffDataList=null;eventOffDataList=eventRegister.remove.apply(eventRegister,args),eventOffDataList&&eventOffDataList.forEach(function(list){list.forEach(function(eventOffData){self._unBind(eventOffData.dom,eventOffData.eventName,eventOffData.domHandler)})})},DomEventHandler.prototype.trigger=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var dom=null,event=null,eventName=null,registerDataList=null;1===args.length?(event=args[0],dom=this.getDefaultDom()):(dom=args[0],event=args[1]),eventName=event.name,registerDataList=wd.DomEventRegister.getInstance().getEventRegisterDataList(dom,eventName),null!==registerDataList&&0!==registerDataList.getCount()&&registerDataList.forEach(function(registerData){var eventCopy=event.clone();registerData.handler(eventCopy,registerData.eventData)})},DomEventHandler.prototype.clearHandler=function(){},DomEventHandler.prototype.buildDomHandler=function(dom,eventName){var self=this,context=wd.root;return wdCb.EventUtils.bindEvent(context,function(event){self.triggerDomEvent(dom,event,eventName)})},DomEventHandler.prototype.handler=function(dom,eventName,handler,priority){var domHandler=null,originHandler=handler;handler=this.addEngineHandler(eventName,handler),domHandler=wd.DomEventRegister.getInstance().isBinded(dom,eventName)?wd.DomEventRegister.getInstance().getDomHandler(dom,eventName):this._bind(dom,eventName),wd.DomEventRegister.getInstance().register(dom,eventName,this.createEventData(),handler,originHandler,domHandler,priority)},DomEventHandler.prototype._bind=function(dom,eventName){var domHandler=null;return domHandler=this.buildDomHandler(dom,eventName),wdCb.EventUtils.addEvent(dom,wd.EventNameHandler.handleEventName(eventName),domHandler),domHandler},DomEventHandler.prototype._unBind=function(dom,eventName,handler){wdCb.EventUtils.removeEvent(dom,wd.EventNameHandler.handleEventName(eventName),handler)},__decorate([wd.virtual],DomEventHandler.prototype,"clearHandler",null),DomEventHandler}(wd.EventHandler);wd.DomEventHandler=DomEventHandler}(wd||(wd={}));var wd;!function(wd){var MouseEventHandler=function(_super){function MouseEventHandler(){_super.apply(this,arguments)}return __extends(MouseEventHandler,_super),MouseEventHandler.getInstance=function(){},MouseEventHandler.prototype.on=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var dom=null,eventName=null,handler=null,priority=null;3===args.length?(dom=this.getDefaultDom(),eventName=args[0],handler=args[1],priority=args[2]):(dom=args[0],eventName=args[1],handler=args[2],priority=args[3]),this.handler(dom,eventName,handler,priority)},MouseEventHandler.prototype.getDefaultDom=function(){return document.body},MouseEventHandler.prototype.triggerDomEvent=function(dom,event,eventName){var eventObj=this._createEventObject(dom,event,eventName);wd.EventManager.trigger(dom,eventObj)},MouseEventHandler.prototype.addEngineHandler=function(eventName,handler){var resultHandler=null;
switch(eventName){case wd.EEventName.MOUSEMOVE:resultHandler=this._handleMove(handler);break;default:resultHandler=handler}return resultHandler},MouseEventHandler.prototype.createEventData=function(){var eventData=wdCb.Hash.create();return eventData.addChild("lastX",null),eventData.addChild("lastY",null),eventData},MouseEventHandler.prototype._handleMove=function(handler){var self=this;return function(event,eventData){self._copyEventDataToEventObject(event,eventData),handler(event),self._saveLocation(event,eventData)}},MouseEventHandler.prototype._createEventObject=function(dom,event,eventName){var obj=wd.MouseEvent.create(event?event:wd.root.event,eventName);return obj.target=dom,obj},MouseEventHandler.prototype._copyEventDataToEventObject=function(event,eventData){event.lastX=eventData.getChild("lastX"),event.lastY=eventData.getChild("lastY")},MouseEventHandler.prototype._saveLocation=function(event,eventData){var location=event.location;eventData.addChild("lastX",location.x),eventData.addChild("lastY",location.y)},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(4===args.length){var dom=args[0];wd.assert(wd.JudgeUtils.isDom(dom),wd.Log.info.FUNC_MUST_BE("first param","HTMLElement"))}})],MouseEventHandler.prototype,"on",null),MouseEventHandler=__decorate([wd.singleton()],MouseEventHandler)}(wd.DomEventHandler);wd.MouseEventHandler=MouseEventHandler}(wd||(wd={}));var wd;!function(wd){var KeyboardEventHandler=function(_super){function KeyboardEventHandler(){_super.apply(this,arguments)}return __extends(KeyboardEventHandler,_super),KeyboardEventHandler.getInstance=function(){},KeyboardEventHandler.prototype.on=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var eventName=null,handler=null,priority=null;3===args.length?(eventName=args[0],handler=args[1],priority=args[2]):(wd.Log.warn("keyboard event can only bind on document.body"),eventName=args[1],handler=args[2],priority=args[3]),this.handler(this.getDefaultDom(),eventName,handler,priority)},KeyboardEventHandler.prototype.triggerDomEvent=function(dom,event,eventName){var eventObj=this._createEventObject(dom,event,eventName);wd.EventManager.trigger(dom,eventObj)},KeyboardEventHandler.prototype.getDefaultDom=function(){return document.body},KeyboardEventHandler.prototype.addEngineHandler=function(eventName,handler){var resultHandler=null;switch(eventName){case wd.EEventName.KEYDOWN:resultHandler=this._handleKeyDown(handler);break;case wd.EEventName.KEYUP:resultHandler=this._handleKeyUp(handler);break;default:resultHandler=handler}return resultHandler},KeyboardEventHandler.prototype.createEventData=function(){var eventData=wdCb.Hash.create();return eventData.addChild("keyState",{}),eventData},KeyboardEventHandler.prototype._handleKeyDown=function(handler){var self=this;return function(event,eventData){var keyState=eventData.getChild("keyState");self._setKeyStateAllFalse(keyState),keyState[event.key]=!0,self._copyEventDataToEventObject(event,eventData),handler(event)}},KeyboardEventHandler.prototype._handleKeyUp=function(handler){var self=this;return function(event,eventData){self._setKeyStateAllFalse(eventData.getChild("keyState")),self._copyEventDataToEventObject(event,eventData),handler(event)}},KeyboardEventHandler.prototype._copyEventDataToEventObject=function(event,eventData){event.keyState=eventData.getChild("keyState")},KeyboardEventHandler.prototype._setKeyStateAllFalse=function(keyState){for(var i in keyState)keyState.hasOwnProperty(i)&&(keyState[i]=!1)},KeyboardEventHandler.prototype._createEventObject=function(dom,event,eventName){var obj=wd.KeyboardEvent.create(event?event:wd.root.event,eventName);return obj.target=dom,obj},KeyboardEventHandler=__decorate([wd.singleton()],KeyboardEventHandler)}(wd.DomEventHandler);wd.KeyboardEventHandler=KeyboardEventHandler}(wd||(wd={}));var wd;!function(wd){var CustomEventHandler=function(_super){function CustomEventHandler(){_super.apply(this,arguments)}return __extends(CustomEventHandler,_super),CustomEventHandler.getInstance=function(){},CustomEventHandler.prototype.on=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(3===args.length){var eventName=args[0],handler=args[1],originHandler=handler,priority=args[2];wd.CustomEventRegister.getInstance().register(null,eventName,handler,originHandler,null,priority)}else if(4===args.length){var target=args[0],eventName=args[1],handler=args[2],originHandler=handler,priority=args[3];wd.CustomEventRegister.getInstance().register(target,eventName,handler,originHandler,null,priority)}},CustomEventHandler.prototype.off=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var eventRegister=wd.CustomEventRegister.getInstance();eventRegister.remove.apply(eventRegister,args)},CustomEventHandler.prototype.trigger=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var event=null;if(1===args.length||2===args.length){var userData=null;return 1===args.length?event=args[0]:(event=args[0],userData=args[1]),this._triggerEventHandler(event,userData)}if(3===args.length||4===args.length){var target=null,userData=null,notSetTarget=null;return 3===args.length?(target=args[0],event=args[1],notSetTarget=args[2]):(target=args[0],event=args[1],userData=args[2],notSetTarget=args[3]),this._triggerTargetAndEventHandler(target,event,userData,notSetTarget)}},CustomEventHandler.prototype._triggerEventHandler=function(event,userData){var registerDataList=null,self=this;return registerDataList=wd.CustomEventRegister.getInstance().getEventRegisterDataList(event.name),null!==registerDataList&&0!==registerDataList.getCount()&&(registerDataList.forEach(function(registerData){event.currentTarget=registerData.target,event.target=registerData.target,self._setUserData(event,userData),registerData.handler(event)}),!0)},CustomEventHandler.prototype._triggerTargetAndEventHandler=function(target,event,userData,notSetTarget){var registerDataList=null,isStopPropagation=!1,self=this;return notSetTarget||(event.target=target),registerDataList=wd.CustomEventRegister.getInstance().getEventRegisterDataList(target,event.name),null!==registerDataList&&0!==registerDataList.getCount()&&(registerDataList.forEach(function(registerData){event.currentTarget=registerData.target,self._setUserData(event,userData),registerData.handler(event),event.isStopPropagation&&(isStopPropagation=!0)}),isStopPropagation)},CustomEventHandler.prototype._setUserData=function(event,userData){userData&&(event.userData=userData)},CustomEventHandler=__decorate([wd.singleton()],CustomEventHandler)}(wd.EventHandler);wd.CustomEventHandler=CustomEventHandler}(wd||(wd={}));var wd;!function(wd){var EventDispatcher=function(){function EventDispatcher(){}return EventDispatcher}();wd.EventDispatcher=EventDispatcher}(wd||(wd={}));var wd;!function(wd){var CustomEventDispatcher=function(_super){function CustomEventDispatcher(){_super.apply(this,arguments)}return __extends(CustomEventDispatcher,_super),CustomEventDispatcher.getInstance=function(){},CustomEventDispatcher.prototype.trigger=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var length=args.length;if(1===length){var event_1=args[0],eventType=event_1.type;return wd.EventHandlerFactory.createEventHandler(eventType).trigger(event_1)}if(2===length&&wd.EventUtils.isEvent(args[0])){var event_2=args[0],userData=args[1],eventType=event_2.type;return wd.EventHandlerFactory.createEventHandler(eventType).trigger(event_2,userData)}if(2===length&&wd.EventUtils.isEntityObject(args[0])||3===length&&wd.JudgeUtils.isBoolean(args[2])){var target=args[0],event_3=args[1],notSetTarget=void 0!==args[2]&&args[2],eventType=event_3.type;return wd.EventHandlerFactory.createEventHandler(eventType).trigger(target,event_3,notSetTarget)}if(3===length||4===length){var target=args[0],event_4=args[1],userData=args[2],notSetTarget=void 0!==args[3]&&args[3],eventType=event_4.type;return wd.EventHandlerFactory.createEventHandler(eventType).trigger(target,event_4,userData,notSetTarget)}},CustomEventDispatcher.prototype.emit=function(target,eventObject,userData){var isStopPropagation=!1;if(target){eventObject.phase=wd.EEventPhase.EMIT,eventObject.target=target;do{if(isStopPropagation=this._triggerWithUserData(target,eventObject,userData,!0))break;target=target.bubbleParent}while(target)}},CustomEventDispatcher.prototype.broadcast=function(target,eventObject,userData){var self=this,iterator=function(obj){var children=obj.getChildren();0!==children.getCount()&&children.forEach(function(child){self._triggerWithUserData(child,eventObject,userData,!0),iterator(child)})};target&&(eventObject.phase=wd.EEventPhase.BROADCAST,eventObject.target=target,this._triggerWithUserData(target,eventObject,userData,!0),iterator(target))},CustomEventDispatcher.prototype._triggerWithUserData=function(target,event,userData,notSetTarget){return userData?this.trigger(target,event,userData,notSetTarget):this.trigger(target,event,notSetTarget)},CustomEventDispatcher=__decorate([wd.singleton()],CustomEventDispatcher)}(wd.EventDispatcher);wd.CustomEventDispatcher=CustomEventDispatcher}(wd||(wd={}));var wd;!function(wd){var DomEventDispatcher=function(_super){function DomEventDispatcher(){_super.apply(this,arguments)}return __extends(DomEventDispatcher,_super),DomEventDispatcher.getInstance=function(){},DomEventDispatcher.prototype.trigger=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(1===args.length){var event_5=args[0],eventType=event_5.type;wd.EventHandlerFactory.createEventHandler(eventType).trigger(event_5)}else if(2===args.length){var dom=args[0],event_6=args[1],eventType=event_6.type;wd.EventHandlerFactory.createEventHandler(eventType).trigger(dom,event_6)}},DomEventDispatcher=__decorate([wd.singleton()],DomEventDispatcher)}(wd.EventDispatcher);wd.DomEventDispatcher=DomEventDispatcher}(wd||(wd={}));var wd;!function(wd){var EventRegister=function(){function EventRegister(){this.listenerMap=wd.ABSTRACT_ATTRIBUTE}return EventRegister.prototype.getEventRegisterDataList=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var result=this.listenerMap.getChild.apply(this.listenerMap,args);return result?result.sort(function(dataA,dataB){return dataB.priority-dataA.priority}):null},EventRegister.prototype.filter=function(func){return this.listenerMap.filter(func)},EventRegister.prototype.forEach=function(func){return this.listenerMap.forEach(func)},EventRegister.prototype.getChild=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return this.listenerMap.getChild.apply(this.listenerMap,Array.prototype.slice.call(arguments,0))},EventRegister.prototype.getEventNameFromKey=function(key){return this.listenerMap.getEventNameFromKey(key)},EventRegister}();wd.EventRegister=EventRegister}(wd||(wd={}));var wd;!function(wd){var CustomEventRegister=function(_super){function CustomEventRegister(){_super.apply(this,arguments),this.listenerMap=wd.CustomEventListenerMap.create()}return __extends(CustomEventRegister,_super),CustomEventRegister.getInstance=function(){},CustomEventRegister.prototype.register=function(target,eventName,handler,originHandler,domHandler,priority){this.listenerMap.appendChild(target,eventName,{target:target,eventName:eventName,handler:handler,originHandler:originHandler,domHandler:domHandler,priority:priority})},CustomEventRegister.prototype.remove=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var target=args[0];if(1===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0];this.listenerMap.removeChild(eventName)}else if(1===args.length&&args[0]instanceof wd.EntityObject)this.listenerMap.removeChild(target),this._handleAfterAllEventHandlerRemoved(target);else if(2===args.length&&wd.JudgeUtils.isFunction(args[1])){var eventName=args[0],handler=args[1];this.listenerMap.removeChild(eventName,handler)}else if(2===args.length&&wd.JudgeUtils.isNumber(args[0])){var uid=args[0],eventName=args[1];this.listenerMap.removeChild(uid,eventName)}else(2===args.length&&args[0]instanceof wd.EntityObject||3===args.length)&&(this.listenerMap.removeChild.apply(this.listenerMap,args),this._isAllEventHandlerRemoved(target)&&this._handleAfterAllEventHandlerRemoved(target))},CustomEventRegister.prototype.setBubbleParent=function(target,parent){target.bubbleParent=parent},CustomEventRegister.prototype.getUidFromKey=function(key){return this.listenerMap.getUidFromKey(key)},CustomEventRegister.prototype.isTarget=function(key,target,list){return this.listenerMap.isTarget(key,target,list)},CustomEventRegister.prototype._isAllEventHandlerRemoved=function(target){return!this.listenerMap.hasChildWithFunc(function(list,key){return key.indexOf(String(target.uid))>-1&&list&&list.getCount()>0})},CustomEventRegister.prototype._handleAfterAllEventHandlerRemoved=function(target){this.setBubbleParent(target,null)},CustomEventRegister=__decorate([wd.singleton()],CustomEventRegister)}(wd.EventRegister);wd.CustomEventRegister=CustomEventRegister}(wd||(wd={}));var wd;!function(wd){var DomEventRegister=function(_super){function DomEventRegister(){_super.apply(this,arguments),this.listenerMap=wd.DomEventListenerMap.create()}return __extends(DomEventRegister,_super),DomEventRegister.getInstance=function(){},DomEventRegister.prototype.register=function(dom,eventName,eventData,handler,originHandler,domHandler,priority){this.listenerMap.appendChild(dom,eventName,{dom:dom,eventName:eventName,eventData:eventData,handler:handler,originHandler:originHandler,domHandler:domHandler,priority:priority})},DomEventRegister.prototype.remove=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var result=null;if(1===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0];result=this.listenerMap.removeChild(eventName)}else if(2===args.length&&wd.JudgeUtils.isFunction(args[1])){var eventName=args[0],handler=args[1];result=this.listenerMap.removeChild(eventName,handler)}else(2===args.length&&wd.JudgeUtils.isDom(args[0])||3===args.length)&&(result=this.listenerMap.removeChild.apply(this.listenerMap,args));return result},DomEventRegister.prototype.isBinded=function(dom,eventName){return this.listenerMap.hasChild(dom,eventName)},DomEventRegister.prototype.isDom=function(key,dom,list){return this.listenerMap.isDom(key,dom,list)},DomEventRegister.prototype.getDomHandler=function(dom,eventName){var list=this.getChild(dom,eventName);if(list&&list.getCount()>0)return list.getChild(0).domHandler},DomEventRegister=__decorate([wd.singleton()],DomEventRegister)}(wd.EventRegister);wd.DomEventRegister=DomEventRegister}(wd||(wd={}));var wd;!function(wd){var EventBinder=function(){function EventBinder(){}return EventBinder}();wd.EventBinder=EventBinder}(wd||(wd={}));var wd;!function(wd){var CustomEventBinder=function(_super){function CustomEventBinder(){_super.apply(this,arguments)}return __extends(CustomEventBinder,_super),CustomEventBinder.getInstance=function(){},CustomEventBinder.prototype.on=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(2===args.length){var eventName=args[0],handler=args[1];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).on(eventName,handler)}else if(3===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0],handler=args[1],priority=args[2];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).on(eventName,handler,priority)}else if(3===args.length&&args[0]instanceof wd.EntityObject){var target=args[0],eventName=args[1],handler=args[2];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).on(target,eventName,handler)}else if(4===args.length){var target=args[0],eventName=args[1],handler=args[2],priority=args[3];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).on(target,eventName,handler,priority)}},CustomEventBinder.prototype.off=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var eventRegister=wd.CustomEventRegister.getInstance();if(0===args.length)eventRegister.forEach(function(list,key){var eventName=eventRegister.getEventNameFromKey(key),targetUid=eventRegister.getUidFromKey(key);targetUid?wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).off(targetUid,eventName):wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).off(eventName)});else if(1===args.length&&wd.JudgeUtils.isString(args[0])){var eventName_4=args[0];eventRegister.forEach(function(list,key){var registeredEventName=eventRegister.getEventNameFromKey(key);registeredEventName===eventName_4&&wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName_4)).off(eventName_4)})}else if(1===args.length&&args[0]instanceof wd.EntityObject){var target_3=args[0];eventRegister.forEach(function(list,key){var eventName=eventRegister.getEventNameFromKey(key);eventRegister.isTarget(key,target_3,list)&&wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).off(target_3,eventName)})}else if(2===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0],handler=args[1];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).off(eventName,handler)}else if(2===args.length&&args[0]instanceof wd.EntityObject){var target=args[0],eventName=args[1];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).off(target,eventName)}else if(3===args.length&&args[0]instanceof wd.EntityObject){var target=args[0],eventName=args[1],handler=args[2];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).off(target,eventName,handler)}},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var checkEventSeparator=function(eventName){wd.assert(eventName.indexOf(wd.CustomEventListenerMap.eventSeparator)===-1,wd.Log.info.FUNC_SHOULD_NOT("eventName","contain "+wd.CustomEventListenerMap.eventSeparator))};if(1===args.length);else if(2===args.length){var eventName=args[0];checkEventSeparator(eventName)}else if(3===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0];checkEventSeparator(eventName)}else if(3===args.length&&args[0]instanceof wd.EntityObject){var eventName=args[1];checkEventSeparator(eventName)}else if(4===args.length){var eventName=args[1];checkEventSeparator(eventName)}})],CustomEventBinder.prototype,"on",null),CustomEventBinder=__decorate([wd.singleton()],CustomEventBinder)}(wd.EventBinder);wd.CustomEventBinder=CustomEventBinder}(wd||(wd={}));var wd;!function(wd){var DomEventBinder=function(_super){function DomEventBinder(){_super.apply(this,arguments)}return __extends(DomEventBinder,_super),DomEventBinder.getInstance=function(){},DomEventBinder.prototype.on=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(1===args.length){var listener_1=args[0]instanceof wd.EventListener?args[0]:wd.EventListener.create(args[0]);listener_1.handlerDataList.forEach(function(handlerData){wd.EventHandlerFactory.createEventHandler(listener_1.eventType).on(handlerData.eventName,handlerData.handler,listener_1.priority)})}else if(2===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0],handler=args[1];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).on(eventName,handler)}else if(2===args.length&&wd.JudgeUtils.isDom(args[0])){var dom_1=args[0],listener_2=args[0]instanceof wd.EventListener?args[0]:wd.EventListener.create(args[0]);listener_2.handlerDataList.forEach(function(handlerData){wd.EventHandlerFactory.createEventHandler(listener_2.eventType).on(dom_1,handlerData.eventName,handlerData.handler,listener_2.priority)})}else if(3===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0],handler=args[1],priority=args[2];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).on(eventName,handler,priority)}else if(3===args.length&&wd.JudgeUtils.isDom(args[0])){var dom=args[0],eventName=args[1],handler=args[2];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).on(dom,eventName,handler)}else if(4===args.length){var dom=args[0],eventName=args[1],handler=args[2],priority=args[3];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).on(dom,eventName,handler,priority)}},DomEventBinder.prototype.off=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var eventRegister=wd.DomEventRegister.getInstance();if(0===args.length)eventRegister.forEach(function(list,key){var eventName=eventRegister.getEventNameFromKey(key);wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).off(eventName)});else if(1===args.length&&wd.JudgeUtils.isString(args[0])){var eventName_5=args[0];eventRegister.forEach(function(list,key){var registeredEventName=eventRegister.getEventNameFromKey(key);registeredEventName===eventName_5&&wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName_5)).off(eventName_5)})}else if(1===args.length&&wd.JudgeUtils.isDom(args[0])){var dom_2=args[0];eventRegister.forEach(function(list,key){var eventName=eventRegister.getEventNameFromKey(key);eventRegister.isDom(key,dom_2,list)&&wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).off(dom_2,eventName)})}else if(2===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0],handler=args[1];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).off(eventName,handler)}else if(2===args.length&&wd.JudgeUtils.isDom(args[0])){var dom=args[0],eventName=args[1];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).off(dom,eventName)}else if(3===args.length){var dom=args[0],eventName=args[1],handler=args[2];wd.EventHandlerFactory.createEventHandler(wd.EventTable.getEventType(eventName)).off(dom,eventName,handler)}},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var checkEventSeparator=function(eventName){wd.assert(eventName.indexOf(wd.DomEventListenerMap.eventSeparator)===-1,wd.Log.info.FUNC_SHOULD_NOT("eventName","contain "+wd.DomEventListenerMap.eventSeparator))};if(1===args.length);else if(2===args.length);else if(3===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0];checkEventSeparator(eventName)}else if(3===args.length&&wd.JudgeUtils.isDom(args[0])){var eventName=args[1];checkEventSeparator(eventName)}else if(4===args.length){var eventName=args[1];checkEventSeparator(eventName)}})],DomEventBinder.prototype,"on",null),DomEventBinder=__decorate([wd.singleton()],DomEventBinder)}(wd.EventBinder);wd.DomEventBinder=DomEventBinder}(wd||(wd={}));var wd;!function(wd){var EventHandlerFactory=function(){function EventHandlerFactory(){}return EventHandlerFactory.createEventHandler=function(eventType){var handler=null;switch(eventType){case wd.EEventType.MOUSE:handler=wd.MouseEventHandler.getInstance();break;case wd.EEventType.KEYBOARD:handler=wd.KeyboardEventHandler.getInstance();break;case wd.EEventType.CUSTOM:handler=wd.CustomEventHandler.getInstance();break;default:wd.Log.error(!0,wd.Log.info.FUNC_INVALID("eventType"))}return handler},EventHandlerFactory}();wd.EventHandlerFactory=EventHandlerFactory}(wd||(wd={}));var wd;!function(wd){var EventBinderFactory=function(){function EventBinderFactory(){}return EventBinderFactory.createEventBinder=function(eventName){var binder=null,eventType=wd.EventTable.getEventType(eventName);switch(eventType){case wd.EEventType.MOUSE:case wd.EEventType.KEYBOARD:binder=wd.DomEventBinder.getInstance();break;case wd.EEventType.CUSTOM:binder=wd.CustomEventBinder.getInstance();break;default:wd.Log.error(!0,wd.Log.info.FUNC_INVALID("eventName:"+eventName))}return binder},EventBinderFactory}();wd.EventBinderFactory=EventBinderFactory}(wd||(wd={}));var wd;!function(wd){var EventDispatcherFactory=function(){function EventDispatcherFactory(){}return EventDispatcherFactory.createEventDispatcher=function(event){var dispatcher=null,eventType=event.type;switch(eventType){case wd.EEventType.MOUSE:case wd.EEventType.KEYBOARD:dispatcher=wd.DomEventDispatcher.getInstance();break;case wd.EEventType.CUSTOM:dispatcher=wd.CustomEventDispatcher.getInstance();break;default:wd.Log.error(!0,wd.Log.info.FUNC_INVALID("event:"+event))}return dispatcher},EventDispatcherFactory}();wd.EventDispatcherFactory=EventDispatcherFactory}(wd||(wd={}));var wd;!function(wd){var EventUtils=function(){function EventUtils(){}return EventUtils.isEvent=function(arg){return arg&&void 0!==arg.currentTarget},EventUtils.isEntityObject=function(arg){return arg&&void 0!==arg.bubbleParent},__decorate([wd.ensure(function(isEntityObject,arg){isEntityObject&&wd.assert(arg instanceof wd.EntityObject,wd.Log.info.FUNC_MUST_BE("EntityObject, but actual is "+arg))})],EventUtils,"isEntityObject",null),EventUtils}();wd.EventUtils=EventUtils}(wd||(wd={}));var wd;!function(wd){var EventManager=function(){function EventManager(){}return EventManager.on=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(1===args.length){var listener=args[0],eventBinder=wd.DomEventBinder.getInstance();eventBinder.on(listener)}else if(2===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0],handler=args[1],priority=1,eventBinder=wd.EventBinderFactory.createEventBinder(eventName);eventBinder.on(eventName,handler,priority)}else if(2===args.length&&wd.JudgeUtils.isDom(args[0])){var dom=args[0],listener=args[1],eventBinder=wd.DomEventBinder.getInstance();eventBinder.on(dom,listener)}else if(3===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0],handler=args[1],priority=args[2],eventBinder=wd.EventBinderFactory.createEventBinder(eventName);eventBinder.on(eventName,handler,priority)}else if(3===args.length&&args[0]instanceof wd.EntityObject){var target=args[0],eventName=args[1],handler=args[2],priority=1,eventBinder=wd.CustomEventBinder.getInstance();eventBinder.on(target,eventName,handler,priority)}else if(3===args.length&&wd.JudgeUtils.isDom(args[0])){var dom=args[0],eventName=args[1],handler=args[2],priority=1,eventBinder=wd.DomEventBinder.getInstance();eventBinder.on(dom,eventName,handler,priority)}else if(4===args.length&&args[0]instanceof wd.EntityObject){var target=args[0],eventName=args[1],handler=args[2],priority=args[3],eventBinder=wd.CustomEventBinder.getInstance();eventBinder.on(target,eventName,handler,priority)}else if(4===args.length&&wd.JudgeUtils.isDom(args[0])){var dom=args[0],eventName=args[1],handler=args[2],priority=args[3],eventBinder=wd.DomEventBinder.getInstance();eventBinder.on(dom,eventName,handler,priority)}},EventManager.off=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(0===args.length){var customEventBinder=wd.CustomEventBinder.getInstance(),domEventBinder=wd.DomEventBinder.getInstance();customEventBinder.off(),domEventBinder.off()}else if(1===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0],eventBinder=wd.EventBinderFactory.createEventBinder(eventName);eventBinder.off(eventName)}else if(1===args.length&&args[0]instanceof wd.EntityObject){var eventName=args[0],eventBinder=wd.CustomEventBinder.getInstance();eventBinder.off(eventName)}else if(1===args.length&&wd.JudgeUtils.isDom(args[0])){var eventName=args[0],eventBinder=wd.DomEventBinder.getInstance();eventBinder.off(eventName)}else if(2===args.length&&wd.JudgeUtils.isString(args[0])){var eventName=args[0],handler=args[1],eventBinder=wd.EventBinderFactory.createEventBinder(eventName);eventBinder.off(eventName,handler)}else if(2===args.length&&args[0]instanceof wd.EntityObject){var target=args[0],eventName=args[1],eventBinder=wd.CustomEventBinder.getInstance();eventBinder.off(target,eventName)}else if(2===args.length&&wd.JudgeUtils.isDom(args[0])){var dom=args[0],eventName=args[1],eventBinder=wd.DomEventBinder.getInstance();eventBinder.off(dom,eventName)}else if(3===args.length&&args[0]instanceof wd.EntityObject){var target=args[0],eventName=args[1],handler=args[2],eventBinder=wd.CustomEventBinder.getInstance();eventBinder.off(target,eventName,handler)}else if(3===args.length&&wd.JudgeUtils.isDom(args[0])){var dom=args[0],eventName=args[1],handler=args[2],eventBinder=wd.DomEventBinder.getInstance();eventBinder.off(dom,eventName,handler)}},EventManager.trigger=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var length=args.length;if(1===length){var event_7=args[0],eventDispatcher=wd.EventDispatcherFactory.createEventDispatcher(event_7);eventDispatcher.trigger(event_7)}else if(2===length&&wd.EventUtils.isEvent(args[0])){var event_8=args[0],userData=args[1],eventDispatcher=wd.CustomEventDispatcher.getInstance();eventDispatcher.trigger(event_8,userData)}else if(2===length&&wd.EventUtils.isEntityObject(args[0])){var target=args[0],event_9=args[1],eventDispatcher=wd.CustomEventDispatcher.getInstance();if(!target)return;eventDispatcher.trigger(target,event_9)}else if(2===length){var dom=args[0],event_10=args[1],eventDispatcher=wd.DomEventDispatcher.getInstance();if(!dom)return;eventDispatcher.trigger(dom,event_10)}else if(3===length){var target=args[0],event_11=args[1],userData=args[2],eventDispatcher=wd.CustomEventDispatcher.getInstance();if(!target)return;eventDispatcher.trigger(target,event_11,userData)}else if(4===length){var target=args[0],event_12=args[1],userData=args[2],notSetTarget=args[3],eventDispatcher=wd.CustomEventDispatcher.getInstance();if(!target)return;eventDispatcher.trigger(target,event_12,userData,notSetTarget)}},EventManager.broadcast=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var eventDispatcher=wd.CustomEventDispatcher.getInstance();eventDispatcher.broadcast.apply(eventDispatcher,args)},EventManager.emit=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var eventDispatcher=wd.CustomEventDispatcher.getInstance();eventDispatcher.emit.apply(eventDispatcher,args)},EventManager.fromEvent=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var addHandler=null,removeHandler=null;if(1===args.length){var eventName_6=args[0];addHandler=function(handler){EventManager.on(eventName_6,handler)},removeHandler=function(handler){EventManager.off(eventName_6,handler)}}else if(2===args.length&&wd.JudgeUtils.isNumber(args[1])){var eventName_7=args[0],priority_1=args[1];addHandler=function(handler){EventManager.on(eventName_7,handler,priority_1)},removeHandler=function(handler){EventManager.off(eventName_7,handler)}}else if(2===args.length){var eventName_8=args[1];addHandler=function(handler){EventManager.on(args[0],eventName_8,handler)},removeHandler=function(handler){EventManager.off(args[0],eventName_8,handler)}}else if(3===args.length){var eventName_9=args[1],priority_2=args[2];addHandler=function(handler){EventManager.on(args[0],eventName_9,handler,priority_2)},removeHandler=function(handler){EventManager.off(args[0],eventName_9,handler)}}return wdFrp.fromEventPattern(addHandler,removeHandler)},EventManager.setBubbleParent=function(target,parent){wd.CustomEventRegister.getInstance().setBubbleParent(target,parent)},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(args[0]instanceof wd.EntityObject){var eventName=args[1];wd.assert(wd.EventTable.getEventType(eventName)===wd.EEventType.CUSTOM,wd.Log.info.FUNC_MUST_BE("event","custom event"))}else if(wd.JudgeUtils.isDom(args[0])){var eventName=args[1],eventType=wd.EventTable.getEventType(eventName);wd.assert(eventType===wd.EEventType.MOUSE||eventType===wd.EEventType.KEYBOARD,wd.Log.info.FUNC_MUST_BE("event","dom event"))}})],EventManager,"on",null),
__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(args.length>2&&args[0]instanceof wd.EntityObject){var eventName=args[1];wd.assert(wd.EventTable.getEventType(eventName)===wd.EEventType.CUSTOM,wd.Log.info.FUNC_MUST_BE("event","custom event"))}else if(args.length>2&&wd.JudgeUtils.isDom(args[0])){var eventName=args[1],eventType=wd.EventTable.getEventType(eventName);wd.assert(eventType===wd.EEventType.MOUSE||eventType===wd.EEventType.KEYBOARD,wd.Log.info.FUNC_MUST_BE("event","dom event"))}})],EventManager,"off",null),__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(2===args.length&&args[0]instanceof wd.Event){var event_13=args[0];wd.assert(event_13 instanceof wd.CustomEvent,wd.Log.info.FUNC_MUST_BE("event type","CUSTOM"))}else if(2===args.length&&args[0]instanceof wd.EntityObject);else if(2===args.length)args[0]&&wd.assert(wd.JudgeUtils.isDom(args[0]),wd.Log.info.FUNC_MUST_BE("the first param","dom"));else if(args[0]instanceof wd.EntityObject){var event_14=args[1];wd.assert(event_14 instanceof wd.CustomEvent,wd.Log.info.FUNC_MUST_BE("event type","CUSTOM"))}})],EventManager,"trigger",null),__decorate([wd.require(function(target,eventObject,userData){wd.assert(eventObject instanceof wd.CustomEvent,wd.Log.info.FUNC_MUST_BE("eventObject","CustomEvent"))})],EventManager,"broadcast",null),__decorate([wd.require(function(target,eventObject,userData){wd.assert(eventObject instanceof wd.CustomEvent,wd.Log.info.FUNC_MUST_BE("eventObject","CustomEvent"))})],EventManager,"emit",null),__decorate([wd.require(function(target,parent){wd.assert(target instanceof wd.EntityObject,"only EntityObject can setBubleParent")})],EventManager,"setBubbleParent",null),EventManager}();wd.EventManager=EventManager}(wd||(wd={}));var wd;!function(wd){!function(EEngineEvent){EEngineEvent[EEngineEvent.STARTLOOP="wd_startLoop"]="STARTLOOP",EEngineEvent[EEngineEvent.ENDLOOP="wd_endLoop"]="ENDLOOP",EEngineEvent[EEngineEvent.MOUSE_CLICK="wd_mouseclick"]="MOUSE_CLICK",EEngineEvent[EEngineEvent.MOUSE_DOWN="wd_mousedown"]="MOUSE_DOWN",EEngineEvent[EEngineEvent.MOUSE_UP="wd_mouseup"]="MOUSE_UP",EEngineEvent[EEngineEvent.MOUSE_MOVE="wd_mousemove"]="MOUSE_MOVE",EEngineEvent[EEngineEvent.MOUSE_OVER="wd_mouseover"]="MOUSE_OVER",EEngineEvent[EEngineEvent.MOUSE_OUT="wd_mouseout"]="MOUSE_OUT",EEngineEvent[EEngineEvent.MOUSE_WHEEL="wd_mousewheel"]="MOUSE_WHEEL",EEngineEvent[EEngineEvent.MOUSE_DRAG="wd_mousedrag"]="MOUSE_DRAG",EEngineEvent[EEngineEvent.MATERIAL_CHANGE="wd_material_change"]="MATERIAL_CHANGE",EEngineEvent[EEngineEvent.MATERIAL_COLOR_CHANGE="wd_material_color_change"]="MATERIAL_COLOR_CHANGE",EEngineEvent[EEngineEvent.UI_WIDTH_CHANGE="wd_ui_width_change"]="UI_WIDTH_CHANGE",EEngineEvent[EEngineEvent.UI_HEIGHT_CHANGE="wd_ui_height_change"]="UI_HEIGHT_CHANGE",EEngineEvent[EEngineEvent.TRANSFORM_TRANSLATE="wd_transform_translate"]="TRANSFORM_TRANSLATE",EEngineEvent[EEngineEvent.TRANSFORM_ROTATE="wd_transform_rotate"]="TRANSFORM_ROTATE",EEngineEvent[EEngineEvent.TRANSFORM_SCALE="wd_transform_scale"]="TRANSFORM_SCALE",EEngineEvent[EEngineEvent.SHADOWMAP_SOFTTYPE_CHANGE="wd_shadowMap_softType_change"]="SHADOWMAP_SOFTTYPE_CHANGE",EEngineEvent[EEngineEvent.SHADOWMAP_LAYER_CHANGE="wd_shadowMap_layer_change"]="SHADOWMAP_LAYER_CHANGE",EEngineEvent[EEngineEvent.COMPONENT_CHANGE="wd_component_change"]="COMPONENT_CHANGE",EEngineEvent[EEngineEvent.EXIT="wd_exit"]="EXIT",EEngineEvent[EEngineEvent.ENTER="wd_enter"]="ENTER"}(wd.EEngineEvent||(wd.EEngineEvent={}));wd.EEngineEvent}(wd||(wd={}));var wd;!function(wd){var ComponentInitOrderTable=function(){function ComponentInitOrderTable(){}return ComponentInitOrderTable.getOrder=function(component){return component instanceof wd.SourceInstance?1:component instanceof wd.Shadow?2:component instanceof wd.ThreeDBitmapFont?3:component instanceof wd.Geometry?4:5},ComponentInitOrderTable}();wd.ComponentInitOrderTable=ComponentInitOrderTable}(wd||(wd={}));var wd;!function(wd){var Billboard=function(_super){function Billboard(){_super.apply(this,arguments),this.mode=wd.EBillboardMode.ALL}return __extends(Billboard,_super),Billboard.create=function(){var obj=new this;return obj},Billboard.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1);var engine=wd.BillboardEngine.getInstance();_super.prototype.addToObject.call(this,entityObject,isShareComponent),engine.hasChild(this)||engine.addChild(this)},Billboard.prototype.removeFromObject=function(entityObject){_super.prototype.removeFromObject.call(this,entityObject),wd.BillboardEngine.getInstance().removeChild(this)},Billboard.prototype.update=function(elapsed){var camera=wd.Director.getInstance().scene.currentCamera;if(this.mode!==wd.EBillboardMode.NONE&&camera){var objToCamProj=wd.Vector3.create(),objTransform=this.entityObject.transform,objPos=objTransform.position,cameraPos=camera.transform.position,isRotateAroundYAxis=null;isRotateAroundYAxis=this._rotateByYAxis(camera,objToCamProj,cameraPos,objPos,objTransform),this.mode===wd.EBillboardMode.ALL&&isRotateAroundYAxis&&this._rotateLocalByXAxis(camera,objToCamProj,cameraPos,objPos,objTransform)}},Billboard.prototype._rotateByYAxis=function(camera,objToCamProj,cameraPos,objPos,objTransform){var lookAt=wd.Vector3.create(),upAux=wd.Vector3.create(),angleCosine=null,isRotateAroundYAxis=!1;return objToCamProj.x=cameraPos.x-objPos.x,objToCamProj.y=0,objToCamProj.z=cameraPos.z-objPos.z,lookAt.x=0,lookAt.y=0,lookAt.z=1,objToCamProj.normalize(),upAux.cross(lookAt,objToCamProj),angleCosine=lookAt.dot(objToCamProj),angleCosine<.9999&&angleCosine>-.9999&&(isRotateAroundYAxis=!0,objTransform.rotation=wd.Quaternion.create().setFromAxisAngle(180*Math.acos(angleCosine)/Math.PI,upAux)),isRotateAroundYAxis},Billboard.prototype._rotateLocalByXAxis=function(camera,objToCamProj,cameraPos,objPos,objTransform){var objToCam=wd.Vector3.create(),angleCosine=null;objToCam.x=cameraPos.x-objPos.x,objToCam.y=cameraPos.y-objPos.y,objToCam.z=cameraPos.z-objPos.z,objToCam.normalize(),angleCosine=objToCamProj.dot(objToCam),angleCosine<.9999&&angleCosine>-.9999&&(objToCam.y<0?objTransform.rotateLocal(180*Math.acos(angleCosine)/Math.PI,0,0):objTransform.rotateLocal(180*-Math.acos(angleCosine)/Math.PI,0,0))},__decorate([wd.cloneAttributeAsBasicType()],Billboard.prototype,"mode",void 0),Billboard}(wd.Component);wd.Billboard=Billboard}(wd||(wd={}));var wd;!function(wd){!function(EBillboardMode){EBillboardMode[EBillboardMode.NONE=0]="NONE",EBillboardMode[EBillboardMode.Y=1]="Y",EBillboardMode[EBillboardMode.ALL=2]="ALL"}(wd.EBillboardMode||(wd.EBillboardMode={}));wd.EBillboardMode}(wd||(wd={}));var wd;!function(wd){var LOD=function(_super){function LOD(){_super.apply(this,arguments),this.activeGeometry=null,this.levelList=wdCb.Collection.create(),this._originGeometry=null}return __extends(LOD,_super),LOD.create=function(){var obj=new this;return obj},LOD.prototype.init=function(){var entityObject=this.entityObject;this.activeGeometry=entityObject.getComponent(wd.Geometry),this._originGeometry=this.activeGeometry,this.levelList.filter(function(_a){var geometry=_a.geometry;_a.distanceBetweenCameraAndObject;return!!geometry}).forEach(function(_a){var geometry=_a.geometry;_a.distanceBetweenCameraAndObject;geometry.entityObject=entityObject,geometry.init(),geometry.createBuffersFromGeometryData()}),_super.prototype.init.call(this)},LOD.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1);var engine=wd.LODEngine.getInstance();_super.prototype.addToObject.call(this,entityObject,isShareComponent),engine.hasChild(this)||engine.addChild(this)},LOD.prototype.removeFromObject=function(entityObject){_super.prototype.removeFromObject.call(this,entityObject),wd.LODEngine.getInstance().removeChild(this)},LOD.prototype.addGeometryLevel=function(distanceBetweenCameraAndObject,levelGeometry){this.levelList.addChild({distanceBetweenCameraAndObject:distanceBetweenCameraAndObject,geometry:levelGeometry}),this.levelList.sort(function(levelData1,levelData2){return levelData2.distanceBetweenCameraAndObject-levelData1.distanceBetweenCameraAndObject},!0)},LOD.prototype.update=function(elapsed){var currentDistanceBetweenCameraAndObject=wd.Vector3.create().sub2(wd.Director.getInstance().scene.currentCamera.transform.position,this.entityObject.transform.position).length(),useOriginGeometry=!0,activeGeometry=null;return this.levelList.forEach(function(_a){var geometry=_a.geometry,distanceBetweenCameraAndObject=_a.distanceBetweenCameraAndObject;if(currentDistanceBetweenCameraAndObject>=distanceBetweenCameraAndObject)return activeGeometry=geometry,useOriginGeometry=!1,wdCb.$BREAK}),activeGeometry===wd.ELODGeometryState.INVISIBLE?(this.activeGeometry=null,void(this.entityObject.isVisible=!1)):(this.entityObject.isVisible=!0,void(activeGeometry&&!wd.JudgeUtils.isEqual(activeGeometry,this.activeGeometry)?(this.activeGeometry=activeGeometry,wd.EventManager.trigger(this.entityObject,wd.CustomEvent.create(wd.EEngineEvent.COMPONENT_CHANGE))):useOriginGeometry&&(this.activeGeometry=this._originGeometry)))},__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName,isShareGeometry){source.levelList.forEach(function(levelData){var levelDataGeometry=null;levelDataGeometry=levelData.geometry===wd.ELODGeometryState.INVISIBLE?wd.ELODGeometryState.INVISIBLE:isShareGeometry?levelData.geometry:levelData.geometry.clone(),target.addGeometryLevel(levelData.distanceBetweenCameraAndObject,levelDataGeometry)})})],LOD.prototype,"levelList",void 0),__decorate([wd.require(function(){wd.InstanceUtils.isHardwareSupport()&&wd.assert(!wd.InstanceUtils.isObjectInstance(this.entityObject),wd.Log.info.FUNC_SHOULD_NOT("if hardware support instance, object instance","add lod component"))})],LOD.prototype,"update",null),LOD}(wd.Component);wd.LOD=LOD}(wd||(wd={}));var wd;!function(wd){!function(ELODGeometryState){ELODGeometryState[ELODGeometryState.INVISIBLE=0]="INVISIBLE"}(wd.ELODGeometryState||(wd.ELODGeometryState={}));wd.ELODGeometryState}(wd||(wd={}));var wd;!function(wd){var Instance=function(_super){function Instance(){_super.apply(this,arguments)}return __extends(Instance,_super),Instance.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1),_super.prototype.addToObject.call(this,entityObject,isShareComponent)},Instance.prototype.clone=function(){return wd.CloneUtils.clone(this)},__decorate([wd.require(function(entityObject){wd.assert(entityObject instanceof wd.GameObject,wd.Log.info.FUNC_SHOULD("Instance component","add to GameObject"))})],Instance.prototype,"addToObject",null),Instance}(wd.Component);wd.Instance=Instance}(wd||(wd={}));var wd;!function(wd){var SourceInstance=function(_super){function SourceInstance(){_super.apply(this,arguments),this._instanceBuffer=null,this.instanceList=wdCb.Collection.create(),this._toRenderInstanceList=wdCb.Collection.create(),this._endLoopSubscription=null,this._isAddSourceInstanceToChildren=!1,this._enterSubscription=null,this._exitSubscription=null}return __extends(SourceInstance,_super),SourceInstance.create=function(){var obj=new this;return obj},Object.defineProperty(SourceInstance.prototype,"toRenderInstanceListForDraw",{get:function(){return this.hasToRenderInstance()||(this._toRenderInstanceList=this.defaultToRenderInstanceList),this._toRenderInstanceList},enumerable:!0,configurable:!0}),Object.defineProperty(SourceInstance.prototype,"defaultToRenderInstanceList",{get:function(){return wdCb.Collection.create().addChild(this.entityObject).addChildren(this.instanceList)},enumerable:!0,configurable:!0}),Object.defineProperty(SourceInstance.prototype,"instanceBuffer",{get:function(){return null===this._instanceBuffer&&(this._instanceBuffer=wd.InstanceBuffer.create()),this._instanceBuffer},enumerable:!0,configurable:!0}),SourceInstance.prototype.init=function(){var self=this;this._isAddSourceInstanceToChildren||this._addSourceInstanceToChildren(),this._endLoopSubscription=wd.EventManager.fromEvent(wd.EEngineEvent.ENDLOOP).subscribe(function(){self._toRenderInstanceList.removeAllChildren()}),this._enterSubscription=wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.ENTER).subscribe(function(){self._addAllInstances()}),this._exitSubscription=wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.EXIT).subscribe(function(){self._removeAllInstances()})},SourceInstance.prototype.dispose=function(){this._endLoopSubscription.dispose(),this._enterSubscription.dispose(),this._exitSubscription.dispose(),this.instanceList.forEach(function(instance){instance.dispose()})},SourceInstance.prototype.cloneInstance=function(name){var _this=this,self=this,clone=function(name,entityObject){var instance=wd.GameObject.create(),objectInstanceComponent=wd.ObjectInstance.create(),sourceInstanceList=null;return sourceInstanceList=entityObject.getComponent(SourceInstance).instanceList,instance.name=name,_this._addComponentsFromSourceToObject(entityObject,instance),objectInstanceComponent.sourceObject=entityObject,instance.addComponent(objectInstanceComponent),instance.bubbleParent=entityObject.bubbleParent,instance.parent=entityObject.parent,instance.isVisible=entityObject.isVisible,entityObject.getTagList().forEach(function(tag){instance.addTag(tag)}),sourceInstanceList.addChild(instance),entityObject.forEach(function(child){instance.addChild(clone(self._buildInstanceChildName(name,child.name),child))}),instance};return this._addSourceInstanceToChildren(),this._isAddSourceInstanceToChildren=!0,clone(name,this.entityObject)},SourceInstance.prototype.hasToRenderInstance=function(){return this._toRenderInstanceList&&this._toRenderInstanceList.getCount()>0},SourceInstance.prototype.addToRenderIntance=function(instanceObj){this._toRenderInstanceList.addChild(instanceObj)},SourceInstance.prototype.forEachToRenderInstanceList=function(func){this._toRenderInstanceList.forEach(func)},SourceInstance.prototype._addComponentsFromSourceToObject=function(source,instance){instance.removeComponent(wd.Transform),source.forEachComponent(function(component){component instanceof SourceInstance||component instanceof wd.LOD||(component instanceof wd.Geometry||component instanceof wd.Script?instance.addComponent(component,!0):instance.addComponent(component.clone()))})},SourceInstance.prototype._addSourceInstanceToChildren=function(){var add=function(child){if(!wd.InstanceUtils.isSourceInstance(child)){var sourceInstanceComponent=SourceInstance.create();child.hasComponent(SourceInstance)||child.addComponent(sourceInstanceComponent),child.forEach(function(c){add(c)})}};this.entityObject.forEach(function(child){add(child)})},SourceInstance.prototype._addAllInstances=function(){var parent=this.entityObject.parent,tag=wd.EInstanceTag.isAddSourceInstance;this.instanceList.forEach(function(instance){instance.addTag(tag),parent.addChild(instance),instance.removeTag(tag)})},SourceInstance.prototype._removeAllInstances=function(){var tag=wd.EInstanceTag.isRemoveSourceInstance;this.instanceList.forEach(function(instance){instance.addTag(tag),instance.parent.removeChild(instance),instance.removeTag(tag)})},SourceInstance.prototype._buildInstanceChildName=function(parentName,childName){return parentName+"_"+childName},__decorate([wd.ensureGetter(function(toRenderInstanceListForDraw){var self=this;wd.assert(toRenderInstanceListForDraw.getCount()>0,wd.Log.info.FUNC_SHOULD("contain one at least")),toRenderInstanceListForDraw.forEach(function(instance){wd.assert(wd.JudgeUtils.isEqual(instance,self.entityObject)||self.instanceList.hasChild(instance),wd.Log.info.FUNC_SHOULD("render self entityObject or the entityObject in instanceList"))}),wd.assert(!toRenderInstanceListForDraw.hasRepeatItems(),wd.Log.info.FUNC_SHOULD_NOT("has repeat instance which is to render"))})],SourceInstance.prototype,"toRenderInstanceListForDraw",null),__decorate([wd.cloneAttributeAsCloneable()],SourceInstance.prototype,"instanceList",void 0),__decorate([wd.ensure(function(){this.entityObject.forEach(function(child){wd.IterateUtils.forEachAll(child,function(child){wd.assert(wd.InstanceUtils.isSourceInstance(child),wd.Log.info.FUNC_SHOULD("children","contain SourceInstance component"))})})})],SourceInstance.prototype,"init",null),__decorate([wd.require(function(){var self=this,checkInstanceIsNotOnlyInInstanceListButAlsoInLoop=function(){var scene=null,children=null,isInLoop=!0;0!==self.instanceList.getCount()&&(scene=wd.Director.getInstance().scene,children=wdCb.Collection.create(),wd.IterateUtils.forEachAll(scene.gameObjectScene,function(gameObject){children.addChild(gameObject)}),self.instanceList.forEach(function(instance){if(!children.hasChild(instance))return isInLoop=!1,wdCb.$BREAK}),wd.assert(isInLoop,wd.Log.info.FUNC_SHOULD("instance","not only in instanceList, but also in the main loop")))};checkInstanceIsNotOnlyInInstanceListButAlsoInLoop()})],SourceInstance.prototype,"dispose",null),__decorate([wd.require(function(){var entityObject=this.entityObject;wd.assert(!entityObject.getSpacePartition(),wd.Log.info.FUNC_NOT_SUPPORT("space partition","instance"))}),wd.ensure(function(instance){wd.assert(wd.InstanceUtils.isObjectInstance(instance))})],SourceInstance.prototype,"cloneInstance",null),__decorate([wd.ensure(function(returnValue,source,instance){wd.assert(instance.hasComponent(wd.ThreeDTransform),wd.Log.info.FUNC_SHOULD("instance","contain ThreeDTransform component"))})],SourceInstance.prototype,"_addComponentsFromSourceToObject",null),__decorate([wd.ensure(function(){wd.IterateUtils.forEachAll(this.entityObject,function(gameObject){wd.assert(1===gameObject.getComponents().filter(function(component){return component instanceof SourceInstance}).getCount(),wd.Log.info.FUNC_SHOULD("children","contain only one SourceInstance component"))})})],SourceInstance.prototype,"_addSourceInstanceToChildren",null),__decorate([wd.ensure(function(){this.instanceList.forEach(function(instance){wd.assert(!instance.hasTag(wd.EInstanceTag.isAddSourceInstance),wd.Log.info.FUNC_SHOULD_NOT("instance","add EInstanceTag.isAddSourceInstance tag here"))})})],SourceInstance.prototype,"_addAllInstances",null),__decorate([wd.ensure(function(){this.instanceList.forEach(function(instance){wd.assert(!instance.hasTag(wd.EInstanceTag.isRemoveSourceInstance),wd.Log.info.FUNC_SHOULD_NOT("instance","add EInstanceTag.isRemoveSourceInstance tag here"))})})],SourceInstance.prototype,"_removeAllInstances",null),SourceInstance}(wd.Instance);wd.SourceInstance=SourceInstance}(wd||(wd={}));var wd;!function(wd){var ObjectInstance=function(_super){function ObjectInstance(){_super.apply(this,arguments),this.sourceObject=null,this._enterSubscription=null,this._exitSubscription=null}return __extends(ObjectInstance,_super),ObjectInstance.create=function(){var obj=new this;return obj},ObjectInstance.prototype.init=function(){var self=this,entityObject=this.entityObject;this._enterSubscription=wd.EventManager.fromEvent(entityObject,wd.EEngineEvent.ENTER).subscribe(function(){entityObject.hasTag(wd.EInstanceTag.isAddSourceInstance)||self._addToSourceAndItsChildren()}),this._exitSubscription=wd.EventManager.fromEvent(entityObject,wd.EEngineEvent.EXIT).subscribe(function(){entityObject.hasTag(wd.EInstanceTag.isRemoveSourceInstance)||self._removeFromSourceAndItsChildren()})},ObjectInstance.prototype.dispose=function(){this._enterSubscription.dispose(),this._exitSubscription.dispose(),this._removeFromSourceAndItsChildren()},ObjectInstance.prototype._addToSourceAndItsChildren=function(){var add=function(sourceInstanceObject,objectInstanceObject){sourceInstanceObject.getComponent(wd.SourceInstance).instanceList.addChild(objectInstanceObject),objectInstanceObject.forEach(function(child,index){add(sourceInstanceObject.getChild(index),child)})};add(this.sourceObject,this.entityObject)},ObjectInstance.prototype._removeFromSourceAndItsChildren=function(){var remove=function(sourceInstanceObject,objectInstanceObject){sourceInstanceObject.getComponent(wd.SourceInstance).instanceList.removeChild(objectInstanceObject),objectInstanceObject.forEach(function(child,index){remove(sourceInstanceObject.getChild(index),child)})};remove(this.sourceObject,this.entityObject)},__decorate([wd.cloneAttributeAsBasicType()],ObjectInstance.prototype,"sourceObject",void 0),ObjectInstance}(wd.Instance);wd.ObjectInstance=ObjectInstance}(wd||(wd={}));var wd;!function(wd){!function(EInstanceTag){EInstanceTag[EInstanceTag.isRemoveSourceInstance="isRemoveSourceInstance"]="isRemoveSourceInstance",EInstanceTag[EInstanceTag.isAddSourceInstance="isAddSourceInstance"]="isAddSourceInstance"}(wd.EInstanceTag||(wd.EInstanceTag={}));wd.EInstanceTag}(wd||(wd={}));var wd;!function(wd){var EventTriggerDetector=function(_super){function EventTriggerDetector(){_super.apply(this,arguments)}return __extends(EventTriggerDetector,_super),EventTriggerDetector.prototype.clone=function(){return wd.CloneUtils.clone(this)},EventTriggerDetector}(wd.Component);wd.EventTriggerDetector=EventTriggerDetector}(wd||(wd={}));var wd;!function(wd){var UIEventTriggerDetector=function(_super){function UIEventTriggerDetector(){_super.apply(this,arguments)}return __extends(UIEventTriggerDetector,_super),UIEventTriggerDetector.create=function(){var obj=new this;return obj},UIEventTriggerDetector.prototype.isTrigger=function(e){var transform=this.entityObject.transform,width=transform.width,height=transform.height,position=transform.position,locationInView=e.locationInView,leftUpCornerPosition=null;return leftUpCornerPosition=wd.Vector2.create(position.x-width/2,position.y-height/2),wd.EventTriggerDetectorUtils.isInRect(locationInView,leftUpCornerPosition,width,height)},UIEventTriggerDetector}(wd.EventTriggerDetector);wd.UIEventTriggerDetector=UIEventTriggerDetector}(wd||(wd={}));var wd;!function(wd){var RayCasterEventTriggerDetector=function(_super){function RayCasterEventTriggerDetector(){_super.apply(this,arguments)}return __extends(RayCasterEventTriggerDetector,_super),RayCasterEventTriggerDetector.create=function(){var obj=new this;return obj},RayCasterEventTriggerDetector.prototype.isTrigger=function(e){var scene=wd.Director.getInstance().scene,cameraController=scene.currentCamera.getComponent(wd.CameraController),locationInView=e.locationInView;return cameraController.isIntersectWithRay(this.entityObject,locationInView.x,locationInView.y)},RayCasterEventTriggerDetector}(wd.EventTriggerDetector);wd.RayCasterEventTriggerDetector=RayCasterEventTriggerDetector}(wd||(wd={}));var wd;!function(wd){var SceneEventTriggerDetector=function(_super){function SceneEventTriggerDetector(){_super.apply(this,arguments)}return __extends(SceneEventTriggerDetector,_super),SceneEventTriggerDetector.create=function(){var obj=new this;return obj},SceneEventTriggerDetector.prototype.isTrigger=function(e){var view=wd.DeviceManager.getInstance().view,width=view.width,height=view.height,locationInView=e.locationInView,leftUpCornerPosition=wd.Vector2.create(0,0);return wd.EventTriggerDetectorUtils.isInRect(locationInView,leftUpCornerPosition,width,height)},SceneEventTriggerDetector}(wd.EventTriggerDetector);wd.SceneEventTriggerDetector=SceneEventTriggerDetector}(wd||(wd={}));var wd;!function(wd){var EventTriggerDetectorUtils=function(){function EventTriggerDetectorUtils(){}return EventTriggerDetectorUtils.isInRect=function(locationInView,leftUpCornerPosition,width,height){return locationInView.x>=leftUpCornerPosition.x&&locationInView.x<=leftUpCornerPosition.x+width&&locationInView.y>=leftUpCornerPosition.y&&locationInView.y<=leftUpCornerPosition.y+height},EventTriggerDetectorUtils}();wd.EventTriggerDetectorUtils=EventTriggerDetectorUtils}(wd||(wd={}));var wd;!function(wd){var _scriptHandlerNameTable=wdCb.Hash.create(),_scriptEngineEventTable=wdCb.Hash.create();_scriptHandlerNameTable.addChild(wd.EEventName.CLICK,"onMouseClick"),_scriptHandlerNameTable.addChild(wd.EEventName.MOUSEOVER,"onMouseOver"),_scriptHandlerNameTable.addChild(wd.EEventName.MOUSEOUT,"onMouseOut"),_scriptHandlerNameTable.addChild(wd.EEventName.MOUSEMOVE,"onMouseMove"),_scriptHandlerNameTable.addChild(wd.EEventName.MOUSEDOWN,"onMouseDown"),_scriptHandlerNameTable.addChild(wd.EEventName.MOUSEUP,"onMouseUp"),_scriptHandlerNameTable.addChild(wd.EEventName.MOUSEWHEEL,"onMouseWheel"),_scriptHandlerNameTable.addChild(wd.EEventName.MOUSEDRAG,"onMouseDrag"),_scriptEngineEventTable.addChild(wd.EEventName.CLICK,"MOUSE_CLICK"),_scriptEngineEventTable.addChild(wd.EEventName.MOUSEDOWN,"MOUSE_DOWN"),_scriptEngineEventTable.addChild(wd.EEventName.MOUSEUP,"MOUSE_UP"),_scriptEngineEventTable.addChild(wd.EEventName.MOUSEMOVE,"MOUSE_MOVE"),_scriptEngineEventTable.addChild(wd.EEventName.MOUSEOVER,"MOUSE_OVER"),_scriptEngineEventTable.addChild(wd.EEventName.MOUSEOUT,"MOUSE_OUT"),_scriptEngineEventTable.addChild(wd.EEventName.MOUSEWHEEL,"MOUSE_WHEEL"),_scriptEngineEventTable.addChild(wd.EEventName.MOUSEDRAG,"MOUSE_DRAG");var EventTriggerTable=function(){function EventTriggerTable(){}return EventTriggerTable.getScriptHandlerName=function(eventName){var result=_scriptHandlerNameTable.getChild(eventName);return result},EventTriggerTable.getScriptEngineEvent=function(eventName){var result=_scriptEngineEventTable.getChild(eventName);return result},EventTriggerTable}();wd.EventTriggerTable=EventTriggerTable}(wd||(wd={}));var wd;!function(wd){var Script=function(_super){function Script(url){void 0===url&&(url=null),_super.call(this),this.url=null,this._subscription=null,this.url=url}return __extends(Script,_super),Script.create=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(0===args.length)return new this;if(1===args.length){var url=args[0];return new this(url)}},Script.addScript=function(scriptName,_class){this.scriptList.push({name:scriptName,class:_class})},Script.prototype.dispose=function(){this._subscription.dispose()},Script.prototype.createLoadJsStream=function(){return wd.Log.error(!this.url,wd.Log.info.FUNC_MUST_DEFINE("url")),wd.LoaderManager.getInstance().load(this.url).map(function(){return Script.scriptList.pop()})},Script.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1),_super.prototype.addToObject.call(this,entityObject,isShareComponent),this._subscription=this.createLoadJsStream().subscribe(function(data){wd.GlobalScriptUtils.addScriptToEntityObject(entityObject,data),wd.GlobalScriptUtils.handlerAfterLoadedScript(entityObject)})},Script.scriptList=wdCb.Stack.create(),__decorate([wd.cloneAttributeAsBasicType()],Script.prototype,"url",void 0),Script}(wd.Component);wd.Script=Script}(wd||(wd={}));var wd;!function(wd){var Transform=function(_super){function Transform(){_super.apply(this,arguments),this.p_parent=null,this._isTranslate=!1,this._isRotate=!1,this._isScale=!1,this.dirtyLocal=!0,this.children=wdCb.Collection.create(),this._endLoopSubscription=null}return __extends(Transform,_super),Object.defineProperty(Transform.prototype,"parent",{get:function(){return this.p_parent},set:function(parent){this.setParent(parent)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isTransform",{get:function(){return this.isTranslate||this.isRotate||this.isScale},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isTranslate",{get:function(){return this._isTranslate},set:function(isTranslate){this._setGlobalTransformState(wd.ETransformState.ISTRANSLATE,isTranslate)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isRotate",{get:function(){return this._isRotate},set:function(isRotate){this._setGlobalTransformState(wd.ETransformState.ISROTATE,isRotate)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isScale",{get:function(){return this._isScale},set:function(isScale){this._setGlobalTransformState(wd.ETransformState.ISSCALE,isScale)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isLocalTranslate",{set:function(isTranslate){this._setLocalTransformState(wd.ETransformState.ISLOCALTRANSLATE,isTranslate)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isLocalRotate",{set:function(isRotate){this._setLocalTransformState(wd.ETransformState.ISLOCALROTATE,isRotate)},enumerable:!0,configurable:!0}),Object.defineProperty(Transform.prototype,"isLocalScale",{set:function(isScale){this._setLocalTransformState(wd.ETransformState.ISLOCALSCALE,isScale)},enumerable:!0,configurable:!0}),Transform.prototype.init=function(){var self=this;this._endLoopSubscription=wd.EventManager.fromEvent(wd.EEngineEvent.ENDLOOP).subscribe(function(){self._resetTransformFlag()})},Transform.prototype.dispose=function(){_super.prototype.dispose.call(this),this._endLoopSubscription&&this._endLoopSubscription.dispose()},Transform.prototype.addChild=function(child){this.children.addChild(child)},Transform.prototype.removeChild=function(child){this.children.removeChild(child)},Transform.prototype.setChildrenTransformState=function(transformState,state){state&&this.children.forEach(function(child){child[transformState]=!0})},Transform.prototype.handleWhenSetTransformState=function(transformState){},Transform.prototype.setParent=function(parent){return this.p_parent&&this.p_parent.removeChild(this),parent?(this.p_parent=parent,void this.p_parent.addChild(this)):void(this.p_parent=null)},Transform.prototype.getMatrix=function(syncMethod,matrixAttriName){var syncList=wdCb.Collection.create(),current=this.p_parent;for(syncList.addChild(this);null!==current;)syncList.addChild(current),current=current.parent;return syncList.reverse().forEach(function(transform){transform[syncMethod]()}),this[matrixAttriName]},Transform.prototype._setGlobalTransformState=function(transformState,state){this["_"+transformState]=state,state&&(this.dirtyLocal=!0,this.clearCache(),this.handleWhenSetTransformState(transformState)),state&&this.setChildrenTransformState(transformState,state)},Transform.prototype._setLocalTransformState=function(transformState,state){state&&(this.dirtyLocal=!0,this.clearCache()),state&&this.setChildrenTransformState(transformState,state)},Transform.prototype._resetTransformFlag=function(){this.isTranslate=!1,this.isScale=!1,this.isRotate=!1},__decorate([wd.cloneAttributeAsBasicType()],Transform.prototype,"parent",null),__decorate([wd.virtual],Transform.prototype,"handleWhenSetTransformState",null),Transform}(wd.Component);wd.Transform=Transform}(wd||(wd={}));var wd;!function(wd){var ThreeDTransform=function(_super){function ThreeDTransform(){_super.apply(this,arguments),this._localToWorldMatrix=null,this._position=wd.Vector3.create(),this._rotation=wd.Quaternion.create(0,0,0,1),this._scale=wd.Vector3.create(1,1,1),this._eulerAngles=null,this._localPosition=wd.Vector3.create(0,0,0),this._localRotation=wd.Quaternion.create(0,0,0,1),this._localEulerAngles=null,this._localScale=wd.Vector3.create(1,1,1),this.dirtyWorld=null,this._localToParentMatrix=wd.Matrix4.create(),this._localToWorldMatrixCache=null,this._positionCache=null,this._rotationCache=null,this._scaleCache=null,this._eulerAnglesCache=null,this._localEulerAnglesCache=null,this._normalMatrixCache=null}return __extends(ThreeDTransform,_super),ThreeDTransform.create=function(){var obj=new this;return obj},Object.defineProperty(ThreeDTransform.prototype,"localToWorldMatrix",{get:function(){return this.getMatrix("sync","_localToWorldMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"normalMatrix",{get:function(){return this.localToWorldMatrix.invertTo3x3().transpose()},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"position",{get:function(){return this._position=this.localToWorldMatrix.getTranslation(),this._position},set:function(position){null===this.p_parent?this._localPosition=position:this._localPosition=this.p_parent.localToWorldMatrix.clone().invert().multiplyPoint(position),
this.isTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"rotation",{get:function(){return this._rotation.setFromMatrix(this.localToWorldMatrix),this._rotation},set:function(rotation){null===this.p_parent?this._localRotation=rotation:this._localRotation=this.p_parent.rotation.clone().invert().multiply(rotation),this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"scale",{get:function(){return this._scale=this.localToWorldMatrix.getScale(),this._scale},set:function(scale){null===this.p_parent?this._localScale=scale:this._localScale=this.p_parent.localToWorldMatrix.clone().invert().multiplyVector3(scale),this.isScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"eulerAngles",{get:function(){return this._eulerAngles=this.localToWorldMatrix.getEulerAngles(),this._eulerAngles},set:function(eulerAngles){this._localRotation.setFromEulerAngles(eulerAngles),null!==this.p_parent&&(this._localRotation=this.p_parent.rotation.clone().invert().multiply(this._localRotation)),this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"localPosition",{get:function(){return this._localPosition},set:function(position){this._localPosition=position,this.isLocalTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"localRotation",{get:function(){return this._localRotation},set:function(rotation){this._localRotation=rotation,this.isLocalRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"localEulerAngles",{get:function(){return this._localEulerAngles=this._localRotation.getEulerAngles(),this._localEulerAngles},set:function(localEulerAngles){this._localRotation.setFromEulerAngles(localEulerAngles),this.isLocalRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"localScale",{get:function(){return this._localScale},set:function(scale){this._localScale=scale,this.isLocalScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"up",{get:function(){return this.localToWorldMatrix.getY().normalize()},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"right",{get:function(){return this.localToWorldMatrix.getX().normalize()},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDTransform.prototype,"forward",{get:function(){return this.localToWorldMatrix.getZ().normalize().scale(-1)},enumerable:!0,configurable:!0}),ThreeDTransform.prototype.sync=function(){this.dirtyLocal&&(this._localToParentMatrix.setTRS(this._localPosition,this._localRotation,this._localScale),this.dirtyLocal=!1,this.dirtyWorld=!0),this.dirtyWorld&&(null===this.p_parent?this._localToWorldMatrix=this._localToParentMatrix.clone():this._localToWorldMatrix=this.p_parent.localToWorldMatrix.clone().multiply(this._localToParentMatrix),this.dirtyWorld=!1,this.children.forEach(function(child){child.dirtyWorld=!0}))},ThreeDTransform.prototype.translateLocal=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var translation=null;return translation=3===args.length?wd.Vector3.create(args[0],args[1],args[2]):args[0],this._localPosition=this._localPosition.add(this._localRotation.multiplyVector3(translation)),this.isTranslate=!0,this},ThreeDTransform.prototype.translate=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var translation=null;return translation=3===args.length?wd.Vector3.create(args[0],args[1],args[2]):args[0],this.position=translation.add(this.position),this},ThreeDTransform.prototype.rotate=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var eulerAngles=null,quaternion=wd.Quaternion.create();return eulerAngles=3===args.length?wd.Vector3.create(args[0],args[1],args[2]):args[0],quaternion.setFromEulerAngles(eulerAngles),null===this.p_parent?this._localRotation=quaternion.multiply(this._localRotation):(quaternion=this.p_parent.rotation.clone().invert().multiply(quaternion),this._localRotation=quaternion.multiply(this.rotation)),this.isRotate=!0,this},ThreeDTransform.prototype.rotateLocal=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var eulerAngles=null,quaternion=wd.Quaternion.create();return eulerAngles=3===args.length?wd.Vector3.create(args[0],args[1],args[2]):args[0],quaternion.setFromEulerAngles(eulerAngles),this._localRotation.multiply(quaternion),this.isRotate=!0,this},ThreeDTransform.prototype.rotateAround=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var angle=null,center=null,axis=null,rot=null,dir=null;return 3===args.length?(angle=args[0],center=args[1],axis=args[2]):(angle=args[0],center=wd.Vector3.create(args[1],args[2],args[3]),axis=wd.Vector3.create(args[4],args[5],args[6])),rot=wd.Quaternion.create().setFromAxisAngle(angle,axis),dir=this.position.clone().sub(center),dir=rot.multiplyVector3(dir),this.position=center.add(dir),this.rotation=rot.multiply(this.rotation),this},ThreeDTransform.prototype.lookAt=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var target=null,up=null;return 1===args.length?(target=args[0],up=wd.Vector3.up):2===args.length?(target=args[0],up=args[1]):3===args.length?(target=wd.Vector3.create(args[0],args[1],args[2]),up=wd.Vector3.up):(target=wd.Vector3.create(args[0],args[1],args[2]),up=wd.Vector3.create(args[3],args[4],args[5])),this.rotation=wd.Quaternion.create().setFromMatrix(wd.Matrix4.create().setLookAt(this.position,target,up)),this},ThreeDTransform.prototype.clearCache=function(){this._localToWorldMatrixCache=null,this._normalMatrixCache=null,this._positionCache=null,this._rotationCache=null,this._scaleCache=null,this._eulerAnglesCache=null,this._localEulerAnglesCache=null},ThreeDTransform.prototype.handleWhenSetTransformState=function(transformState){var eventName=null;switch(transformState){case wd.ETransformState.ISTRANSLATE:eventName=wd.EEngineEvent.TRANSFORM_TRANSLATE;break;case wd.ETransformState.ISROTATE:eventName=wd.EEngineEvent.TRANSFORM_ROTATE;break;case wd.ETransformState.ISSCALE:eventName=wd.EEngineEvent.TRANSFORM_SCALE;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNKNOW("transformState:"+transformState))}wd.EventManager.trigger(this.entityObject,wd.CustomEvent.create(eventName))},__decorate([wd.cacheGetter(function(){return null!==this._localToWorldMatrixCache},function(){return this._localToWorldMatrixCache},function(result){this._localToWorldMatrixCache=result})],ThreeDTransform.prototype,"localToWorldMatrix",null),__decorate([wd.cacheGetter(function(){return null!==this._normalMatrixCache},function(){return this._normalMatrixCache},function(result){this._normalMatrixCache=result})],ThreeDTransform.prototype,"normalMatrix",null),__decorate([wd.cloneAttributeAsCloneable(),wd.cacheGetter(function(){return null!==this._positionCache},function(){return this._positionCache},function(result){this._positionCache=result})],ThreeDTransform.prototype,"position",null),__decorate([wd.cloneAttributeAsCloneable(),wd.cacheGetter(function(){return null!==this._rotationCache},function(){return this._rotationCache},function(result){this._rotationCache=result})],ThreeDTransform.prototype,"rotation",null),__decorate([wd.cloneAttributeAsCloneable(),wd.cacheGetter(function(){return null!==this._scaleCache},function(){return this._scaleCache},function(result){this._scaleCache=result})],ThreeDTransform.prototype,"scale",null),__decorate([wd.cacheGetter(function(){return null!==this._eulerAnglesCache},function(){return this._eulerAnglesCache},function(result){this._eulerAnglesCache=result})],ThreeDTransform.prototype,"eulerAngles",null),__decorate([wd.cloneAttributeAsCloneable()],ThreeDTransform.prototype,"localPosition",null),__decorate([wd.cloneAttributeAsCloneable()],ThreeDTransform.prototype,"localRotation",null),__decorate([wd.cacheGetter(function(){return null!==this._localEulerAnglesCache},function(){return this._localEulerAnglesCache},function(result){this._localEulerAnglesCache=result})],ThreeDTransform.prototype,"localEulerAngles",null),__decorate([wd.cloneAttributeAsCloneable()],ThreeDTransform.prototype,"localScale",null),ThreeDTransform}(wd.Transform);wd.ThreeDTransform=ThreeDTransform}(wd||(wd={}));var wd;!function(wd){var RectTransform=function(_super){function RectTransform(){_super.apply(this,arguments),this._rotationMatrix=null,this._localPositionAndScaleMatrix=wd.Matrix3.create(),this._position=wd.Vector2.create(),this._rotation=0,this._scale=wd.Vector2.create(1,1),this._localPosition=wd.Vector2.create(0,0),this._localScale=wd.Vector2.create(1,1),this._anchorX=wd.Vector2.create(.5,.5),this._anchorY=wd.Vector2.create(.5,.5),this._width=null,this._height=null,this.dirtyRotation=!0,this.dirtyPositionAndScale=!0,this.pivot=wd.Vector2.create(0,0),this.zIndex=1,this._localRotationMatrix=wd.Matrix3.create(),this._localToParentMatrix=wd.Matrix3.create(),this._rotationMatrixCache=null,this._localPositionAndScaleMatrixCache=null}return __extends(RectTransform,_super),RectTransform.create=function(){var obj=new this;return obj},Object.defineProperty(RectTransform.prototype,"rotationMatrix",{get:function(){return this.getMatrix("syncRotation","_rotationMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"localPositionAndScaleMatrix",{get:function(){return this.getMatrix("syncPositionAndScale","_localPositionAndScaleMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"position",{get:function(){return this._position=this.localPositionAndScaleMatrix.getTranslation(),this._position},set:function(position){null===this.p_parent?this._localPosition=position:this._localPosition=this.p_parent.localPositionAndScaleMatrix.clone().invert().multiplyPoint(position),this.isTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"rotation",{get:function(){return this._rotation=this.rotationMatrix.getRotation(),this._rotation},set:function(angle){this.resetRotation(),this.rotate(angle),this.dirtyRotation=!0,this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"scale",{get:function(){return this._scale=this.localPositionAndScaleMatrix.getScale(),this._scale},set:function(scale){null===this.p_parent?this._localScale=scale:this._localScale=this.p_parent.localPositionAndScaleMatrix.clone().invert().multiplyVector2(scale),this.isScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"localPosition",{get:function(){return this._localPosition},set:function(position){this._localPosition=position,this.isLocalTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"localScale",{get:function(){return this._localScale},set:function(scale){this._localScale=scale,this.isLocalScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"anchorX",{get:function(){return this._anchorX},set:function(anchorX){var parentWidth=null;if(!this._anchorX.isEqual(anchorX)){if(this._anchorX=anchorX,anchorX.x===anchorX.y){var widthFromAnchorToPosition=(anchorX.x-.5)*this._getParentWidth();return void(this.position=wd.Vector2.create(this._getParentPosition().x+widthFromAnchorToPosition,this.position.y))}parentWidth=this._getParentWidth(),this.position=wd.Vector2.create(this._getParentPosition().x+(anchorX.x+anchorX.y-1)/2*parentWidth,this.position.y),this.width=parentWidth/this._getParentScale().x*(anchorX.y-anchorX.x)*this.scale.x}},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"anchorY",{get:function(){return this._anchorY},set:function(anchorY){var parentHeight=null;if(!this._anchorY.isEqual(anchorY)){if(this._anchorY=anchorY,anchorY.x===anchorY.y){var heightFromAnchorToPosition=(anchorY.x-.5)*this._getParentHeight();return void(this.position=wd.Vector2.create(this.position.x,this._getParentPosition().y+heightFromAnchorToPosition))}parentHeight=this._getParentHeight(),this.position=wd.Vector2.create(this.position.x,this._getParentPosition().y+(anchorY.x+anchorY.y-1)/2*parentHeight),this.height=parentHeight/this._getParentScale().y*(anchorY.y-anchorY.x)*this.scale.y}},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"width",{get:function(){return this._width*this.scale.x},set:function(width){this._width!==width&&(this._width=width,this.entityObject&&wd.EventManager.trigger(this.entityObject,wd.CustomEvent.create(wd.EEngineEvent.UI_WIDTH_CHANGE)))},enumerable:!0,configurable:!0}),Object.defineProperty(RectTransform.prototype,"height",{get:function(){return this._height*this.scale.y},set:function(height){this._height!==height&&(this._height=height,this.entityObject&&wd.EventManager.trigger(this.entityObject,wd.CustomEvent.create(wd.EEngineEvent.UI_HEIGHT_CHANGE)))},enumerable:!0,configurable:!0}),RectTransform.prototype.syncRotation=function(){this.dirtyRotation&&(null===this.p_parent?this._rotationMatrix=this._localRotationMatrix.clone():this._rotationMatrix=this.p_parent.rotationMatrix.clone().multiply(this._localRotationMatrix),this.children.forEach(function(child){child.dirtyRotation=!0}))},RectTransform.prototype.syncPositionAndScale=function(){this.dirtyLocal&&(this._localToParentMatrix.setTS(this._localPosition,this._localScale),this.dirtyLocal=!1,this.dirtyPositionAndScale=!0),this.dirtyPositionAndScale&&(null===this.p_parent?this._localPositionAndScaleMatrix=this._localToParentMatrix.clone():this._localPositionAndScaleMatrix=this.p_parent.localPositionAndScaleMatrix.clone().multiply(this._localToParentMatrix),this.dirtyLocal=!1,this.children.forEach(function(child){child.dirtyPositionAndScale=!0}))},RectTransform.prototype.translate=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var translation=null;return translation=2===args.length?wd.Vector2.create(args[0],args[1]):args[0],this.position=translation.add(this.position),this},RectTransform.prototype.rotate=function(angle){var position=this.position;return this.rotateAround(angle,position.x+this.pivot.x,position.y-this.pivot.y),this.dirtyRotation=!0,this.isRotate=!0,this},RectTransform.prototype.rotateAround=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var angle=null,center=null,x=null,y=null;return 2===args.length?(angle=args[0],center=args[1]):(angle=args[0],center=wd.Vector2.create(args[1],args[2])),x=center.x,y=center.y,this._translateInRotationMatrix(x,y),this._rotateAroundCanvasOriginPoint(angle),this._translateInRotationMatrix(-x,-y),this},RectTransform.prototype._translateInRotationMatrix=function(x,y){return this._localRotationMatrix.translate(x,y),this},RectTransform.prototype.resetPosition=function(){this.position=wd.Vector2.create(0,0)},RectTransform.prototype.resetScale=function(){this.scale=wd.Vector2.create(1,1)},RectTransform.prototype.resetRotation=function(){this._localRotationMatrix.setIdentity()},RectTransform.prototype.handleWhenSetTransformState=function(transformState){var eventName=null;switch(transformState){case wd.ETransformState.ISTRANSLATE:eventName=wd.EEngineEvent.TRANSFORM_TRANSLATE;break;case wd.ETransformState.ISROTATE:eventName=wd.EEngineEvent.TRANSFORM_ROTATE;break;case wd.ETransformState.ISSCALE:eventName=wd.EEngineEvent.TRANSFORM_SCALE;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNKNOW("transformState:"+transformState))}wd.EventManager.trigger(this.entityObject,wd.CustomEvent.create(eventName))},RectTransform.prototype.clearCache=function(){this._rotationMatrixCache=null,this._localPositionAndScaleMatrixCache=null},RectTransform.prototype._rotateAroundCanvasOriginPoint=function(angle){return this._localRotationMatrix.rotate(angle),this.dirtyRotation=!0,this},RectTransform.prototype._getParentWidth=function(){return null===this.p_parent?wd.DeviceManager.getInstance().view.width:this.p_parent.width},RectTransform.prototype._getParentHeight=function(){return null===this.p_parent?wd.DeviceManager.getInstance().view.height:this.p_parent.height},RectTransform.prototype._getParentPosition=function(){if(null===this.p_parent){var view=wd.DeviceManager.getInstance().view;return wd.Vector2.create(view.width/2,view.height/2)}return this.p_parent.position},RectTransform.prototype._getParentScale=function(){return null===this.p_parent?wd.Vector2.create(1,1):this.p_parent.scale},__decorate([wd.cacheGetter(function(){return null!==this._rotationMatrixCache},function(){return this._rotationMatrixCache},function(result){this._rotationMatrixCache=result})],RectTransform.prototype,"rotationMatrix",null),__decorate([wd.cacheGetter(function(){return null!==this._localPositionAndScaleMatrixCache},function(){return this._localPositionAndScaleMatrixCache},function(result){this._localPositionAndScaleMatrixCache=result})],RectTransform.prototype,"localPositionAndScaleMatrix",null),__decorate([wd.cloneAttributeAsCloneable()],RectTransform.prototype,"position",null),__decorate([wd.cloneAttributeAsBasicType()],RectTransform.prototype,"rotation",null),__decorate([wd.cloneAttributeAsCloneable()],RectTransform.prototype,"scale",null),__decorate([wd.cloneAttributeAsCloneable()],RectTransform.prototype,"localPosition",null),__decorate([wd.cloneAttributeAsCloneable()],RectTransform.prototype,"localScale",null),__decorate([wd.requireSetter(function(anchorX){wd.assert(anchorX.x<=anchorX.y,wd.Log.info.FUNC_SHOULD("minX","<= maxY")),wd.assert(anchorX.x>=0&&anchorX.x<=1,wd.Log.info.FUNC_SHOULD("minX",">= 0 && <= 1")),wd.assert(anchorX.y>=0&&anchorX.y<=1,wd.Log.info.FUNC_SHOULD("maxX",">= 0 && <= 1"))}),wd.cloneAttributeAsCloneable()],RectTransform.prototype,"anchorX",null),__decorate([wd.requireSetter(function(anchorY){wd.assert(anchorY.x<=anchorY.y,wd.Log.info.FUNC_SHOULD("minY","<= maxY")),wd.assert(anchorY.x>=0&&anchorY.x<=1,wd.Log.info.FUNC_SHOULD("minY",">= 0 && <= 1")),wd.assert(anchorY.y>=0&&anchorY.y<=1,wd.Log.info.FUNC_SHOULD("maxY",">= 0 && <= 1"))}),wd.cloneAttributeAsCloneable()],RectTransform.prototype,"anchorY",null),__decorate([wd.cloneAttributeAsBasicType()],RectTransform.prototype,"width",null),__decorate([wd.cloneAttributeAsBasicType()],RectTransform.prototype,"height",null),__decorate([wd.cloneAttributeAsCloneable()],RectTransform.prototype,"pivot",void 0),__decorate([wd.cloneAttributeAsBasicType()],RectTransform.prototype,"zIndex",void 0),RectTransform}(wd.Transform);wd.RectTransform=RectTransform}(wd||(wd={}));var wd;!function(wd){!function(ETransformState){ETransformState[ETransformState.ISTRANSLATE="isTranslate"]="ISTRANSLATE",ETransformState[ETransformState.ISROTATE="isRotate"]="ISROTATE",ETransformState[ETransformState.ISSCALE="isScale"]="ISSCALE",ETransformState[ETransformState.ISLOCALTRANSLATE="isLocalTranslate"]="ISLOCALTRANSLATE",ETransformState[ETransformState.ISLOCALROTATE="isLocalRotate"]="ISLOCALROTATE",ETransformState[ETransformState.ISLOCALSCALE="isLocalScale"]="ISLOCALSCALE"}(wd.ETransformState||(wd.ETransformState={}));wd.ETransformState}(wd||(wd={}));var wd;!function(wd){var Shadow=function(_super){function Shadow(){_super.apply(this,arguments),this._receive=!0,this._cast=!0,this._layer=wd.EShadowLayer.DEFAULT,this._shadowMapLayerChangeSubscription=null,this._isInit=!1}return __extends(Shadow,_super),Shadow.create=function(){var obj=new this;return obj},Object.defineProperty(Shadow.prototype,"receive",{get:function(){return this._receive},set:function(receive){if(this._isInit&&this._receive!==receive){if(wd.InstanceUtils.isObjectInstance(this.entityObject))return void(this._receive=receive);receive?(this._addShadowMapsToObjectAndChildren(),this._switchToShadowMapShaderLib(this.entityObject)):(this._removeShadowMapsOfObjectAndChildren(),this._switchToNoShadowMapShaderLib(this.entityObject))}this._receive=receive},enumerable:!0,configurable:!0}),Object.defineProperty(Shadow.prototype,"cast",{get:function(){return this._cast},set:function(cast){this._cast=cast},enumerable:!0,configurable:!0}),Object.defineProperty(Shadow.prototype,"layer",{get:function(){return wd.InstanceUtils.isObjectInstance(this.entityObject)&&!wd.InstanceUtils.isHardwareSupport()&&(this._layer=this.entityObject.getComponent(wd.ObjectInstance).sourceObject.getComponent(Shadow).layer),this._layer},set:function(layer){layer&&this._layer!==layer&&(this._layer=layer)},enumerable:!0,configurable:!0}),Shadow.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1),_super.prototype.addToObject.call(this,entityObject,isShareComponent)},Shadow.prototype.init=function(){var self=this;if(this._isInit=!0,!wd.InstanceUtils.isObjectInstance(this.entityObject)&&this._isFirstLevelObjectOfSceneOrSpacePartition())if(this._shadowMapLayerChangeSubscription=wd.EventManager.fromEvent(wd.EEngineEvent.SHADOWMAP_LAYER_CHANGE).subscribe(function(){self.receive&&self._addShadowMapsToObjectAndChildren()}),this.cast&&this.receive)this._addBuildShadowMapShaderAndShadowMapsToObjectAndChildren();else{if(this.cast)return void this._addBuildShadowMapShaderToObjectAndChildren();this.receive&&this._addShadowMapsToObjectAndChildren()}},Shadow.prototype.dispose=function(){this._shadowMapLayerChangeSubscription&&this._shadowMapLayerChangeSubscription.dispose()},Shadow.prototype._addAllShadowMaps=function(twoDShadowMapDataMap,cubemapShadowMapDataMap,mapManager){twoDShadowMapDataMap.forEach(function(twoDShadowMapDataList){twoDShadowMapDataList.forEach(function(_a){var shadowMap=_a.shadowMap;mapManager.addTwoDShadowMap(shadowMap)})}),cubemapShadowMapDataMap.forEach(function(cubemapShadowMapDataList){cubemapShadowMapDataList.forEach(function(_a){var shadowMap=_a.shadowMap;mapManager.addCubemapShadowMap(shadowMap)})})},Shadow.prototype._isFirstLevelObjectOfSceneOrSpacePartition=function(){var parent=this.entityObject.parent;return!!parent&&(wd.JudgeUtils.isEqual(parent,wd.Director.getInstance().scene)||wd.JudgeUtils.isSpacePartitionObject(parent))},Shadow.prototype._addBuildShadowMapShaderAndShadowMapsToObjectAndChildren=function(){var _this=this,self=this,twoDShadowMapDataMap=wd.Director.getInstance().scene.gameObjectScene.shadowManager.twoDShadowMapDataMap,cubemapShadowMapDataMap=wd.Director.getInstance().scene.gameObjectScene.shadowManager.cubemapShadowMapDataMap,handle=function(gameObject){if(gameObject.hasComponent(wd.Geometry)){var geometry=gameObject.getComponent(wd.Geometry),material=geometry.material,mapManager=material.mapManager;self._addBuildTwoDShadowMapShader(material,_this._createBuildTwoDShadowMapShader(gameObject,geometry)),self._addBuildCubemapShadowMapShader(material,_this._createBuildCubemapShadowMapShader(gameObject,geometry)),material.shader.libDirty=!0,mapManager.removeAllShdaowMaps(),self._addAllShadowMaps(twoDShadowMapDataMap,cubemapShadowMapDataMap,mapManager)}gameObject.forEach(function(child){handle(child)})};handle(this.entityObject)},Shadow.prototype._addBuildShadowMapShaderToObjectAndChildren=function(){var _this=this,self=this,handle=function(gameObject){if(gameObject.hasComponent(wd.Geometry)){var geometry=gameObject.getComponent(wd.Geometry),material=geometry.material;self._addBuildTwoDShadowMapShader(material,_this._createBuildTwoDShadowMapShader(gameObject,geometry)),self._addBuildCubemapShadowMapShader(material,_this._createBuildCubemapShadowMapShader(gameObject,geometry))}gameObject.forEach(function(child){handle(child)})};handle(this.entityObject)},Shadow.prototype._addBuildTwoDShadowMapShader=function(material,shader){material.addShader(wd.EShaderTypeOfScene.BUILD_TWOD_SHADOWMAP,shader)},Shadow.prototype._addBuildCubemapShadowMapShader=function(material,shader){material.addShader(wd.EShaderTypeOfScene.BUILD_CUBEMAP_SHADOWMAP,shader)},Shadow.prototype._createBuildTwoDShadowMapShader=function(gameObject,geometry){var shader=this._createBuildShadowMapShader(gameObject,geometry);return shader.addLib(wd.BuildTwoDShadowMapShaderLib.create()),shader},Shadow.prototype._createBuildCubemapShadowMapShader=function(gameObject,geometry){var shader=this._createBuildShadowMapShader(gameObject,geometry);return shader.addLib(wd.BuildCubemapShadowMapShaderLib.create()),shader},Shadow.prototype._createBuildShadowMapShader=function(gameObject,geometry){var shader=wd.CommonShader.create();return shader.addLib(wd.CommonShaderLib.create()),wd.GlobalGeometryUtils.hasAnimation(geometry)?(shader.addLib(wd.CommonMorphShaderLib.create()),shader.addLib(wd.VerticeMorphShaderLib.create())):shader.addLib(wd.VerticeCommonShaderLib.create()),wd.InstanceUtils.addModelMatrixShaderLib(shader,gameObject),shader.addLib(wd.EndShaderLib.create()),shader},Shadow.prototype._addShadowMapsToObjectAndChildren=function(){var self=this,twoDShadowMapDataMap=wd.Director.getInstance().scene.gameObjectScene.shadowManager.twoDShadowMapDataMap,cubemapShadowMapDataMap=wd.Director.getInstance().scene.gameObjectScene.shadowManager.cubemapShadowMapDataMap,handle=function(gameObject){if(gameObject.hasComponent(wd.Geometry)){var material=gameObject.getComponent(wd.Geometry).material,mapManager=material.mapManager;material.shader.libDirty=!0,mapManager.removeAllShdaowMaps(),self._addAllShadowMaps(twoDShadowMapDataMap,cubemapShadowMapDataMap,mapManager)}gameObject.forEach(function(child){handle(child)})};handle(this.entityObject)},Shadow.prototype._removeShadowMapsOfObjectAndChildren=function(){var handle=function(gameObject){if(gameObject.hasComponent(wd.Geometry)){var material=gameObject.getComponent(wd.Geometry).material,mapManager=material.mapManager;material.shader.libDirty=!0,mapManager.removeAllShdaowMaps()}gameObject.forEach(function(child){handle(child)})};handle(this.entityObject)},Shadow.prototype._switchToShadowMapShaderLib=function(gameObject){var material=gameObject.getComponent(wd.Geometry).material,shader=material.shader,mapManager=material.mapManager;shader.removeLib(function(lib){return lib instanceof wd.NoShadowMapShaderLib}),this._isTwoDShadowMap(mapManager)&&shader.addLib(wd.TwoDShadowMapShaderLib.create()),this._isCubemapShadowMap(mapManager)&&shader.addLib(wd.CubemapShadowMapShaderLib.create()),shader.addLib(wd.TotalShadowMapShaderLib.create())},Shadow.prototype._switchToNoShadowMapShaderLib=function(gameObject){var material=gameObject.getComponent(wd.Geometry).material,shader=material.shader;shader.removeLib(function(lib){return lib instanceof wd.TwoDShadowMapShaderLib||lib instanceof wd.CubemapShadowMapShaderLib||lib instanceof wd.TotalShadowMapShaderLib}),shader.hasLib(wd.NoShadowMapShaderLib)||shader.addLib(wd.NoShadowMapShaderLib.create())},Shadow.prototype._isTwoDShadowMap=function(mapManager){return mapManager.getTwoDShadowMapList().getCount()>0},Shadow.prototype._isCubemapShadowMap=function(mapManager){return mapManager.getCubemapShadowMapList().getCount()>0},__decorate([wd.cloneAttributeAsBasicType()],Shadow.prototype,"receive",null),__decorate([wd.cloneAttributeAsBasicType()],Shadow.prototype,"cast",null),__decorate([wd.cloneAttributeAsBasicType()],Shadow.prototype,"layer",null),__decorate([wd.require(function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1),wd.assert(entityObject instanceof wd.GameObject,wd.Log.info.FUNC_SHOULD("add to GameObject"))})],Shadow.prototype,"addToObject",null),__decorate([wd.require(function(material,shader){wd.assert(!material.hasShader(wd.EShaderTypeOfScene.BUILD_TWOD_SHADOWMAP),wd.Log.info.FUNC_SHOULD_NOT("material","exist build twoD shadow map shader"))})],Shadow.prototype,"_addBuildTwoDShadowMapShader",null),__decorate([wd.require(function(material,shader){wd.assert(!material.hasShader(wd.EShaderTypeOfScene.BUILD_CUBEMAP_SHADOWMAP),wd.Log.info.FUNC_SHOULD_NOT("material","exist build cubemap shadow map shader"))})],Shadow.prototype,"_addBuildCubemapShadowMapShader",null),__decorate([wd.ensure(function(returnVal,gameObject){var material=gameObject.getComponent(wd.Geometry).material,shader=material.shader;wd.assert(!shader.hasLib(wd.NoShadowMapShaderLib),wd.Log.info.FUNC_SHOULD_NOT("contain NoShadowMapShaderLib")),wd.assert(shader.getLibs().filter(function(lib){return lib instanceof wd.TwoDShadowMapShaderLib}).getCount()<=1,wd.Log.info.FUNC_SHOULD_NOT("has duplicate TwoDShadowMapShaderLib")),wd.assert(shader.getLibs().filter(function(lib){return lib instanceof wd.CubemapShadowMapShaderLib}).getCount()<=1,wd.Log.info.FUNC_SHOULD_NOT("has duplicate CubemapShadowMapShaderLib"))})],Shadow.prototype,"_switchToShadowMapShaderLib",null),__decorate([wd.ensure(function(returnVal,gameObject){var material=gameObject.getComponent(wd.Geometry).material,shader=material.shader;wd.assert(!shader.hasLib(wd.TwoDShadowMapShaderLib),wd.Log.info.FUNC_SHOULD_NOT("contain TwoDShadowMapShaderLib")),wd.assert(!shader.hasLib(wd.CubemapShadowMapShaderLib),wd.Log.info.FUNC_SHOULD_NOT("contain CubemapShadowMapShaderLib")),wd.assert(shader.getLibs().filter(function(lib){return lib instanceof wd.NoShadowMapShaderLib}).getCount()<=1,wd.Log.info.FUNC_SHOULD_NOT("has duplicate NoShadowMapShaderLib"))})],Shadow.prototype,"_switchToNoShadowMapShaderLib",null),Shadow}(wd.Component);wd.Shadow=Shadow}(wd||(wd={}));var wd;!function(wd){var ShadowUtils=function(){function ShadowUtils(){}return ShadowUtils.isReceive=function(gameObject){var shadow=null,parent=gameObject,result=!1;do{if(shadow=parent.getComponent(wd.Shadow),shadow&&shadow.receive){result=!0;break}parent=parent.parent}while(parent);return result},ShadowUtils}();wd.ShadowUtils=ShadowUtils}(wd||(wd={}));var wd;!function(wd){!function(EShadowLayer){EShadowLayer[EShadowLayer.DEFAULT="default"]="DEFAULT"}(wd.EShadowLayer||(wd.EShadowLayer={}));wd.EShadowLayer}(wd||(wd={}));var wd;!function(wd){!function(EShadowMapSoftType){EShadowMapSoftType[EShadowMapSoftType.NONE=0]="NONE",EShadowMapSoftType[EShadowMapSoftType.PCF=1]="PCF"}(wd.EShadowMapSoftType||(wd.EShadowMapSoftType={}));wd.EShadowMapSoftType}(wd||(wd={}));var wd;!function(wd){var Animation=function(_super){function Animation(){_super.apply(this,arguments),this.isFrameChange=!1,this.state=EAnimationState.DEFAULT,this.pauseTime=null,this.resumeTime=null,this.pauseDuration=null,this.frameCount=null,this._isResume=!1}return __extends(Animation,_super),Object.defineProperty(Animation.prototype,"isStart",{get:function(){return this.state===EAnimationState.RUN},enumerable:!0,configurable:!0}),Object.defineProperty(Animation.prototype,"isStop",{get:function(){return this.state===EAnimationState.STOP},enumerable:!0,configurable:!0}),Object.defineProperty(Animation.prototype,"isPause",{get:function(){return this.state===EAnimationState.PAUSE},enumerable:!0,configurable:!0}),Animation.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1);var engine=wd.AnimationEngine.getInstance();_super.prototype.addToObject.call(this,entityObject,isShareComponent),engine.hasChild(this)||engine.addChild(this)},Animation.prototype.removeFromObject=function(entityObject){_super.prototype.removeFromObject.call(this,entityObject),wd.AnimationEngine.getInstance().removeChild(this)},Animation.prototype.clone=function(){return wd.CloneUtils.clone(this)},Animation.prototype.pause=function(){this.state=EAnimationState.PAUSE,this.pauseTime=this.getPauseTime()},Animation.prototype.resume=function(){this.state=EAnimationState.RUN,this._isResume=!0,this.resumeTime=this.getResumeTime()},Animation.prototype.stop=function(){this.state=EAnimationState.STOP},Animation.prototype.update=function(elapsed){if(this.state!==EAnimationState.DEFAULT&&!this.isStop){if(this.isPause)return void this.handleWhenPause(elapsed);this._isResume&&(this._isResume=!1,this.continueFromPausePoint(elapsed)),this.handleBeforeJudgeWhetherCurrentFrameFinish(elapsed),this.isCurrentFrameFinish(elapsed)?this.handleWhenCurrentFrameFinish(elapsed):this.isFrameChange=!1,this.handleAfterJudgeWhetherCurrentFrameFinish(elapsed)}
},Animation.prototype.getPauseTime=function(){return this.getCurrentTime()},Animation.prototype.getResumeTime=function(){return this.getCurrentTime()},Animation.prototype.getCurrentTime=function(){return wd.Director.getInstance().elapsed},Animation.prototype.continueFromPausePoint=function(elapsed){this.pauseDuration+=this.resumeTime-this.pauseTime},Animation}(wd.Component);wd.Animation=Animation,function(EAnimationState){EAnimationState[EAnimationState.DEFAULT=0]="DEFAULT",EAnimationState[EAnimationState.RUN=1]="RUN",EAnimationState[EAnimationState.STOP=2]="STOP",EAnimationState[EAnimationState.PAUSE=3]="PAUSE"}(wd.EAnimationState||(wd.EAnimationState={}));var EAnimationState=wd.EAnimationState}(wd||(wd={}));var wd;!function(wd){var MorphAnimation=function(_super){function MorphAnimation(){_super.apply(this,arguments),this.interpolation=0,this.currentFrame=0,this.duration=null,this.fps=null,this.currentAnimName=null,this._prevFrameEndTime=null}return __extends(MorphAnimation,_super),MorphAnimation.create=function(){var obj=new this;return obj},Object.defineProperty(MorphAnimation.prototype,"nextFrame",{get:function(){var nextFrame=this.currentFrame+1;return nextFrame>=this.frameCount&&(nextFrame=0),nextFrame},enumerable:!0,configurable:!0}),MorphAnimation.prototype.init=function(){},MorphAnimation.prototype.dispose=function(){},MorphAnimation.prototype.play=function(animName,fps){var geometry=this.entityObject.getComponent(wd.ModelGeometry);this.currentAnimName=animName,this.fps=fps,this.duration=1/fps*1e3,this.frameCount=geometry.morphTargets.getChild(animName).getCount(),this.resetAnim(),this.state=wd.EAnimationState.RUN},MorphAnimation.prototype.handleWhenPause=function(elapsed){},MorphAnimation.prototype.handleWhenCurrentFrameFinish=function(elapsed){this.isFrameChange=!0,this._prevFrameEndTime=wd.MathUtils.maxFloorIntegralMultiple(elapsed-this.pauseDuration,this.duration),this.currentFrame++,this._isFinishAllFrames()&&(this.currentFrame=0)},MorphAnimation.prototype.handleBeforeJudgeWhetherCurrentFrameFinish=function(elapsed){null===this._prevFrameEndTime&&(this._prevFrameEndTime=this.getCurrentTime())},MorphAnimation.prototype.isCurrentFrameFinish=function(elapsed){return elapsed-this._prevFrameEndTime-this.pauseDuration>this.duration},MorphAnimation.prototype.handleAfterJudgeWhetherCurrentFrameFinish=function(elapsed){this._computeInterpolation(elapsed)},MorphAnimation.prototype.resetAnim=function(){this._prevFrameEndTime=null,this.currentFrame=0,this.pauseDuration=0},MorphAnimation.prototype._computeInterpolation=function(elapsed){this.interpolation=this.fps*(elapsed-this._prevFrameEndTime-this.pauseDuration)/1e3},MorphAnimation.prototype._isFinishAllFrames=function(){return this.currentFrame>=this.frameCount},__decorate([wd.cloneAttributeAsBasicType()],MorphAnimation.prototype,"interpolation",void 0),__decorate([wd.cloneAttributeAsBasicType()],MorphAnimation.prototype,"currentFrame",void 0),__decorate([wd.cloneAttributeAsBasicType()],MorphAnimation.prototype,"duration",void 0),__decorate([wd.cloneAttributeAsBasicType()],MorphAnimation.prototype,"fps",void 0),__decorate([wd.cloneAttributeAsBasicType()],MorphAnimation.prototype,"currentAnimName",void 0),__decorate([wd.require(function(animName,fps){var geometry=this.entityObject.getComponent(wd.ModelGeometry);wd.assert(geometry,wd.Log.info.FUNC_SHOULD("this entityObject","add ModelGeometry component")),wd.assert(geometry.morphTargets.getChild(animName)&&geometry.morphTargets.getChild(animName).getCount()>0,wd.Log.info.FUNC_NOT_EXIST('"'+animName+'" animation'))}),wd.ensure(function(){wd.assert(this.frameCount>1,wd.Log.info.FUNC_SHOULD("frames.count","> 1"))})],MorphAnimation.prototype,"play",null),__decorate([wd.require(function(elapsed){wd.assert(elapsed-this._prevFrameEndTime-this.pauseDuration>=0,wd.Log.info.FUNC_SHOULD("elapsed of current frame:"+(elapsed-this._prevFrameEndTime-this.pauseDuration),">= 0"))})],MorphAnimation.prototype,"isCurrentFrameFinish",null),__decorate([wd.ensure(function(){var interpolation=this.interpolation;wd.assert(interpolation>=0&&interpolation<=1,wd.Log.info.FUNC_SHOULD("interpolation("+interpolation,">= 0 && <= 1"))})],MorphAnimation.prototype,"_computeInterpolation",null),MorphAnimation}(wd.Animation);wd.MorphAnimation=MorphAnimation}(wd||(wd={}));var wd;!function(wd){var ArticulatedAnimation=function(_super){function ArticulatedAnimation(){_super.apply(this,arguments),this.data=null,this._currentFrame=null,this._currentAnimName=null,this._beginElapsedTimeOfFirstFrame=null,this._prevFrameTime=null,this._currentAnimData=null,this._currentFrameData=null,this._prevFrameData=null,this._startFrameDataMap=wdCb.Hash.create()}return __extends(ArticulatedAnimation,_super),ArticulatedAnimation.create=function(){var obj=new this;return obj},ArticulatedAnimation.prototype.init=function(){},ArticulatedAnimation.prototype.dispose=function(){},ArticulatedAnimation.prototype.play=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(wd.JudgeUtils.isNumber(args[0])){var animIndex_1=args[0],i_1=0,self_6=this;this.data.forEach(function(data,animName){return animIndex_1===i_1?(self_6._currentAnimName=animName,self_6._currentAnimData=data,wdCb.$BREAK):void i_1++})}else if(wd.JudgeUtils.isString(args[0])){var animName=args[0];this._currentAnimName=animName,this._currentAnimData=this.data.getChild(animName)}this.resetAnim(),this._saveStartFrameData(this.entityObject.transform),this.frameCount=this._currentAnimData.getCount(),this.state=wd.EAnimationState.RUN},ArticulatedAnimation.prototype.handleWhenPause=function(elapsed){},ArticulatedAnimation.prototype.handleWhenCurrentFrameFinish=function(elapsed){this.isFrameChange=!0,this._updateFrame(elapsed),this._saveStartFrameData(this._prevFrameData)},ArticulatedAnimation.prototype.handleBeforeJudgeWhetherCurrentFrameFinish=function(elapsed){null===this._beginElapsedTimeOfFirstFrame&&(this._beginElapsedTimeOfFirstFrame=this.getCurrentTime())},ArticulatedAnimation.prototype.isCurrentFrameFinish=function(elapsed){return elapsed-this._beginElapsedTimeOfFirstFrame-this.pauseDuration>this._currentFrameData.time},ArticulatedAnimation.prototype.handleAfterJudgeWhetherCurrentFrameFinish=function(elapsed){this._updateTargets(elapsed)},ArticulatedAnimation.prototype.resetAnim=function(){this._beginElapsedTimeOfFirstFrame=null,this._prevFrameTime=0,this.pauseDuration=0,this._currentFrame=0,this._prevFrameData=null,this._updateCurrentFrameData(),this._startFrameDataMap.removeAllChildren()},ArticulatedAnimation.prototype._updateTargets=function(elapsed){var self=this,transform=this.entityObject.transform,startFrameDataMap=this._startFrameDataMap;this._currentFrameData.targets.forEach(function(target){var endFrameData=target.data,startFrameData=startFrameDataMap.getChild(target.target),interpolation=self._computeInterpolation(elapsed,target.interpolationMethod);switch(target.target){case wd.EArticulatedAnimationTarget.TRANSLATION:transform.localPosition=wd.Vector3.create().lerp(startFrameData,endFrameData,interpolation);break;case wd.EArticulatedAnimationTarget.ROTATION:transform.localRotation=wd.Quaternion.create().slerp(startFrameData,endFrameData,interpolation);break;case wd.EArticulatedAnimationTarget.SCALE:transform.localScale=wd.Vector3.create().lerp(startFrameData,endFrameData,interpolation);break;default:wd.Log.error(!0,wd.Log.info.FUNC_NOT_SUPPORT("EArticulatedAnimationTarget:"+target.target))}})},ArticulatedAnimation.prototype._computeInterpolation=function(elapsed,interpolationMethod){var interpolation=null;switch(interpolationMethod){case wd.EKeyFrameInterpolation.LINEAR:interpolation=this._currentFrameData.time-this._prevFrameTime===0?1:(elapsed-this._beginElapsedTimeOfFirstFrame-this.pauseDuration-this._prevFrameTime)/(this._currentFrameData.time-this._prevFrameTime);break;default:wd.Log.error(!0,wd.Log.info.FUNC_NOT_SUPPORT("interpolationMethod:"+interpolationMethod))}return interpolation},ArticulatedAnimation.prototype._saveStartFrameData=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var startFrameDataMap=this._startFrameDataMap;if(this._isFrameData(args[0])){var frameData=args[0];frameData.targets.forEach(function(target){startFrameDataMap.addChild(target.target,target.data)})}else{var transform=args[0];startFrameDataMap.addChild(wd.EArticulatedAnimationTarget.TRANSLATION,transform.localPosition),startFrameDataMap.addChild(wd.EArticulatedAnimationTarget.ROTATION,transform.localRotation),startFrameDataMap.addChild(wd.EArticulatedAnimationTarget.SCALE,transform.localScale)}},ArticulatedAnimation.prototype._updateCurrentFrameData=function(){this._currentFrameData=this._currentAnimData.getChild(this._currentFrame)},ArticulatedAnimation.prototype._updateFrame=function(elapsed){this._updateCurrentFrameIndex(elapsed),this._isFinishAllFrames()?(this._currentFrame=0,this._beginElapsedTimeOfFirstFrame=this._getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames(elapsed),this._prevFrameTime=0,this._prevFrameData=this._currentAnimData.getChild(this.frameCount-1),this._updateCurrentFrameData()):this._prevFrameTime=this._currentAnimData.getChild(this._currentFrame-1).time},ArticulatedAnimation.prototype._getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames=function(elapsed){return wd.MathUtils.maxFloorIntegralMultiple(elapsed,this._currentAnimData.getChild(this.frameCount-1).time)},ArticulatedAnimation.prototype._isFinishAllFrames=function(){return this._currentFrame>=this.frameCount},ArticulatedAnimation.prototype._updateCurrentFrameIndex=function(elapsed){do this._currentFrame++,this._prevFrameData=this._currentFrameData,this._updateCurrentFrameData();while(!this._isFinishAllFrames()&&this.isCurrentFrameFinish(elapsed))},ArticulatedAnimation.prototype._isFrameData=function(data){return void 0!==data.time&&void 0!==data.targets},__decorate([wd.cloneAttributeAsCloneable()],ArticulatedAnimation.prototype,"data",void 0),__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(wd.JudgeUtils.isNumber(args[0])){var animIndex=args[0];wd.assert(this.data.getCount()>=animIndex+1,wd.Log.info.FUNC_NOT_EXIST("animation index:"+animIndex))}else if(wd.JudgeUtils.isString(args[0])){var animName=args[0];wd.assert(this.data.hasChild(animName),wd.Log.info.FUNC_NOT_EXIST("animation name:"+animName))}}),wd.ensure(function(){wd.assert(!!this._currentAnimData,wd.Log.info.FUNC_NOT_EXIST("animation name:"+this._currentAnimName)),this._currentAnimData.forEach(function(data){wd.assert(data.time>=0,wd.Log.info.FUNC_SHOULD("time",">= 0")),wd.assert(data.targets.getCount()>0,wd.Log.info.FUNC_SHOULD("ArticulatedAnimationFrameData->targets.getCount()","> 0")),data.targets.forEach(function(target){var data=target.data;switch(target.target){case wd.EArticulatedAnimationTarget.TRANSLATION:wd.assert(data instanceof wd.Vector3,wd.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget === TRANSLATION, its data","Vector3"));break;case wd.EArticulatedAnimationTarget.ROTATION:wd.assert(data instanceof wd.Quaternion,wd.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget ===ROTATION, its data","Quaternion"));break;case wd.EArticulatedAnimationTarget.SCALE:wd.assert(data instanceof wd.Vector3,wd.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget === SCALE, its data","Vector3"));break;default:wd.Log.error(!0,wd.Log.info.FUNC_NOT_SUPPORT("EArticulatedAnimationTarget:"+target.target))}})})})],ArticulatedAnimation.prototype,"play",null),__decorate([wd.require(function(elapsed){wd.assert(elapsed-this._beginElapsedTimeOfFirstFrame-this.pauseDuration>=0,wd.Log.info.FUNC_SHOULD("elapsed of current frame:"+(elapsed-this._beginElapsedTimeOfFirstFrame-this.pauseDuration),">= 0"))})],ArticulatedAnimation.prototype,"isCurrentFrameFinish",null),__decorate([wd.ensure(function(interpolation,elapsed,interpolationMethod){wd.assert(interpolation>=0&&interpolation<=1,wd.Log.info.FUNC_SHOULD("interpolation:"+interpolation,">= 0 && <= 1"))})],ArticulatedAnimation.prototype,"_computeInterpolation",null),__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(this._isFrameData(args[0])){var frameData_1=args[0];wd.assert(null!==this._currentFrameData,wd.Log.info.FUNC_SHOULD("set currentFrameData")),this._currentFrameData.targets.forEach(function(currentTarget,index){wd.assert(frameData_1.targets.getChild(index).target===currentTarget.target,wd.Log.info.FUNC_SHOULD("the current frame and the start frame","modify the same targets"))})}})],ArticulatedAnimation.prototype,"_saveStartFrameData",null),__decorate([wd.require(function(elapsed){var lastEndFrameTime=this._currentAnimData.getChild(this.frameCount-1).time;wd.assert(elapsed>=lastEndFrameTime,wd.Log.info.FUNC_SHOULD("elapsed:"+elapsed,">= lastEndFrameTime:"+lastEndFrameTime))})],ArticulatedAnimation.prototype,"_getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames",null),ArticulatedAnimation}(wd.Animation);wd.ArticulatedAnimation=ArticulatedAnimation}(wd||(wd={}));var wd;!function(wd){!function(EKeyFrameInterpolation){EKeyFrameInterpolation[EKeyFrameInterpolation.LINEAR=0]="LINEAR"}(wd.EKeyFrameInterpolation||(wd.EKeyFrameInterpolation={}));wd.EKeyFrameInterpolation}(wd||(wd={}));var wd;!function(wd){!function(EArticulatedAnimationTarget){EArticulatedAnimationTarget[EArticulatedAnimationTarget.TRANSLATION="position"]="TRANSLATION",EArticulatedAnimationTarget[EArticulatedAnimationTarget.ROTATION="rotation"]="ROTATION",EArticulatedAnimationTarget[EArticulatedAnimationTarget.SCALE="scale"]="SCALE"}(wd.EArticulatedAnimationTarget||(wd.EArticulatedAnimationTarget={}));wd.EArticulatedAnimationTarget}(wd||(wd={}));var wd;!function(wd){var Geometry=function(_super){function Geometry(){_super.apply(this,arguments),this._material=null,this.buffers=null,this.vaoManager=wd.GPUDetector.getInstance().extensionVAO?wd.VAOManager.create():null,this.drawMode=wd.EDrawMode.TRIANGLES}return __extends(Geometry,_super),Object.defineProperty(Geometry.prototype,"material",{get:function(){return this._material},set:function(material){wd.JudgeUtils.isEqual(material,this._material)||(this._material=material,this._material.geometry=this,this.entityObject&&wd.EventManager.trigger(this.entityObject,wd.CustomEvent.create(wd.EEngineEvent.MATERIAL_CHANGE)))},enumerable:!0,configurable:!0}),Object.defineProperty(Geometry.prototype,"geometryData",{get:function(){return null===this.buffers?null:this.buffers.geometryData},enumerable:!0,configurable:!0}),Geometry.prototype.init=function(){var geometryData=null,_a=this.computeData(),vertices=_a.vertices,_b=_a.faces,faces=void 0===_b?[]:_b,texCoords=_a.texCoords,colors=_a.colors,morphTargets=_a.morphTargets;this.buffers=this.createBufferContainer(),geometryData=this.createGeometryData(vertices,faces,texCoords,colors,morphTargets),this.buffers.geometryData=geometryData,this.buffers.init(),this._material.init(),this.computeNormals(),this.vaoManager&&this.vaoManager.init()},Geometry.prototype.hasFaceNormals=function(){return this.buffers.geometryData.hasFaceNormals()},Geometry.prototype.hasVertexNormals=function(){return this.buffers.geometryData.hasVertexNormals()},Geometry.prototype.isSmoothShading=function(){return this._material.shading===wd.EShading.SMOOTH},Geometry.prototype.dispose=function(){this.buffers.dispose(),this._material.dispose(),this.vaoManager&&this.vaoManager.dispose()},Geometry.prototype.computeFaceNormals=function(){this.buffers.geometryData.computeFaceNormals()},Geometry.prototype.computeVertexNormals=function(){this.buffers.geometryData.computeVertexNormals()},Geometry.prototype.createBuffersFromGeometryData=function(){this.buffers.createBuffersFromGeometryData()},Geometry.prototype.computeNormals=function(){this.isSmoothShading()?this.hasVertexNormals()||this.computeVertexNormals():this.hasFaceNormals()||this.computeFaceNormals()},Geometry.prototype.createBufferContainer=function(){return wd.BasicBufferContainer.create(this.entityObject)},Geometry.prototype.createGeometryData=function(vertices,faces,texCoords,colors,morphTargets){return this.createBasicGeometryData(vertices,faces,texCoords,colors)},Geometry.prototype.createBasicGeometryData=function(vertices,faces,texCoords,colors){var geometryData=wd.BasicGeometryData.create(this);return geometryData.vertices=vertices,geometryData.faces=faces,geometryData.texCoords=texCoords,geometryData.colors=colors,geometryData},__decorate([wd.cloneAttributeAsCloneable()],Geometry.prototype,"material",null),__decorate([wd.cloneAttributeAsBasicType()],Geometry.prototype,"drawMode",void 0),__decorate([wd.ensure(function(){var geometryData=this.buffers.geometryData;wd.assert(geometryData.vertices.length>0,wd.Log.info.FUNC_MUST("vertices.count","> 0")),wd.assert(3*geometryData.faces.length===geometryData.indices.length,wd.Log.info.FUNC_SHOULD("faces.count","be "+geometryData.indices.length/3+", but actual is "+geometryData.faces.length))}),wd.execOnlyOnce("_isInit")],Geometry.prototype,"init",null),__decorate([wd.require(function(){wd.assert(this.buffers&&this.buffers.geometryData,wd.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],Geometry.prototype,"hasFaceNormals",null),__decorate([wd.require(function(){wd.assert(this.buffers&&this.buffers.geometryData,wd.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],Geometry.prototype,"hasVertexNormals",null),__decorate([wd.require(function(){wd.assert(this.buffers&&this.buffers.geometryData,wd.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],Geometry.prototype,"computeFaceNormals",null),__decorate([wd.require(function(){wd.assert(!!this.buffers,wd.Log.info.FUNC_NOT_EXIST("buffers"))})],Geometry.prototype,"createBuffersFromGeometryData",null),__decorate([wd.virtual],Geometry.prototype,"computeNormals",null),__decorate([wd.virtual],Geometry.prototype,"createBufferContainer",null),__decorate([wd.virtual],Geometry.prototype,"createGeometryData",null),Geometry}(wd.Component);wd.Geometry=Geometry}(wd||(wd={}));var wd;!function(wd){var VAOManager=function(){function VAOManager(){this._vaoMap=wdCb.Hash.create(),this._extension=null}return VAOManager.create=function(){var obj=new this;return obj},VAOManager.prototype.init=function(){this._extension=wd.GPUDetector.getInstance().extensionVAO},VAOManager.prototype.dispose=function(){this._vaoMap.removeAllChildren()},VAOManager.prototype.getVAOData=function(toSendBuffersUidStr){var isSetted=!1,vao=this._vaoMap.getChild(toSendBuffersUidStr);return vao?isSetted=!0:(vao=this._extension.createVertexArrayOES(),this._vaoMap.addChild(toSendBuffersUidStr,vao),isSetted=!1),{vao:vao,isSetted:isSetted}},VAOManager.prototype.sendAllBufferData=function(toSendBuffersUidStr,toSendBufferArr){var _a=this.getVAOData(toSendBuffersUidStr),vao=_a.vao,isSetted=_a.isSetted;if(wd.BufferTable.lastBindedElementBuffer=null,this._extension.bindVertexArrayOES(vao),!isSetted)for(var pos=0,len=toSendBufferArr.length;pos<len;pos++){var buffer=toSendBufferArr[pos];if(buffer){var gl=wd.DeviceManager.getInstance().gl;gl.bindBuffer(gl.ARRAY_BUFFER,buffer.buffer),gl.vertexAttribPointer(pos,buffer.size,gl[buffer.type],!1,0,0),gl.enableVertexAttribArray(pos)}}},__decorate([wd.require(function(){wd.assert(!!wd.GPUDetector.getInstance().extensionVAO,wd.Log.info.FUNC_SHOULD("hardware","support vao extension"))})],VAOManager.prototype,"init",null),VAOManager}();wd.VAOManager=VAOManager}(wd||(wd={}));var wd;!function(wd){var BitmapFontGeometry=function(_super){function BitmapFontGeometry(){_super.apply(this,arguments),this._pages=null}return __extends(BitmapFontGeometry,_super),BitmapFontGeometry.create=function(){var geom=new this;return geom},BitmapFontGeometry.prototype.computeData=function(){var bitmapFont=this.entityObject.getComponent(wd.ThreeDBitmapFont),layoutDataList=bitmapFont.layoutDataList,vertices=null,texCoords=null,indices=null,fntData=wd.LoaderManager.getInstance().get(bitmapFont.fntId);return layoutDataList?(vertices=this._generateVertices(layoutDataList,bitmapFont.width,bitmapFont.height),texCoords=this._generateTexCoords(layoutDataList,fntData.scaleW,fntData.scaleH,this.material.isMapFlipY()),indices=this._generateIndices(layoutDataList),fntData.isMultiPages&&(this._pages=this._generatePages(layoutDataList))):(vertices=[],texCoords=[],indices=[],this._pages=[]),{vertices:vertices,faces:wd.GeometryUtils.convertToFaces(indices,null),texCoords:texCoords}},BitmapFontGeometry.prototype.updateBuffers=function(){if(null!==this.buffers){var _a=this.computeData(),vertices=_a.vertices,faces=_a.faces,texCoords=_a.texCoords;this.buffers.geometryData.vertices=vertices,this.buffers.geometryData.faces=faces,this.buffers.geometryData.texCoords=texCoords,this.hasMultiPages()&&(this.buffers.geometryData.pages=this._pages)}},BitmapFontGeometry.prototype.hasMultiPages=function(){return null!==this._pages&&this._pages.length>0},BitmapFontGeometry.prototype.createBufferContainer=function(){return this.hasMultiPages()?wd.BitmapFontBufferContainer.create(this.entityObject):wd.BasicBufferContainer.create(this.entityObject)},BitmapFontGeometry.prototype.createGeometryData=function(vertices,faces,texCoords,colors,morphTargets){if(this.hasMultiPages()){var geometryData=wd.BitmapFontGeometryData.create(this);return geometryData.vertices=vertices,geometryData.faces=faces,geometryData.texCoords=texCoords,geometryData.colors=colors,geometryData.pages=this._pages,geometryData}return this.createBasicGeometryData(vertices,faces,texCoords,colors)},BitmapFontGeometry.prototype._generatePages=function(layoutDataList){var pages=[],i=0;return layoutDataList.forEach(function(layoutCharData){var page=layoutCharData.data.page||0;pages[i++]=page,pages[i++]=page,pages[i++]=page,pages[i++]=page}),pages},BitmapFontGeometry.prototype._generateVertices=function(layoutDataList,bitmapFontWidth,bitmapFontHeight){var vertices=[],i=0;return layoutDataList.forEach(function(layoutCharData){var rect=layoutCharData.data.rect,z=0,w=rect.width,h=rect.height,position=wd.CoordinateUtils.convertLeftCornerPositionToCenterPositionInWebGL(wd.Vector2.create(layoutCharData.position[0],layoutCharData.position[1]),bitmapFontWidth,bitmapFontHeight),x=position.x,y=position.y;vertices[i++]=x,vertices[i++]=-y,vertices[i++]=z,vertices[i++]=x,vertices[i++]=-(y+h),vertices[i++]=z,vertices[i++]=x+w,vertices[i++]=-(y+h),vertices[i++]=z,vertices[i++]=x+w,vertices[i++]=-y,vertices[i++]=z}),vertices},BitmapFontGeometry.prototype._generateTexCoords=function(layoutDataList,textureWidth,textureHeight,flipY){var texCoords=[],i=0;return layoutDataList.forEach(function(layoutDataList){var rect=layoutDataList.data.rect,bw=rect.x+rect.width,bh=rect.y+rect.height,u0=rect.x/textureWidth,v0=rect.y/textureHeight,u1=bw/textureWidth,v1=bh/textureHeight;flipY&&(v0=(textureHeight-rect.y)/textureHeight,v1=(textureHeight-bh)/textureHeight),texCoords[i++]=u0,texCoords[i++]=v0,texCoords[i++]=u0,texCoords[i++]=v1,texCoords[i++]=u1,texCoords[i++]=v1,texCoords[i++]=u1,texCoords[i++]=v0}),texCoords},BitmapFontGeometry.prototype._generateIndices=function(layoutDataList){for(var numIndices=6*layoutDataList.getCount(),indices=[],i=0,j=0;i<numIndices;i+=6,j+=4)indices[i]=j,indices[i+1]=j+1,indices[i+2]=j+2,indices[i+3]=j,indices[i+4]=j+2,indices[i+5]=j+3;return indices},BitmapFontGeometry}(wd.Geometry);wd.BitmapFontGeometry=BitmapFontGeometry}(wd||(wd={}));var wd;!function(wd){var LineGeometry=function(_super){function LineGeometry(){_super.apply(this,arguments),this._customGeometry=wd.CustomGeometry.create()}return __extends(LineGeometry,_super),Object.defineProperty(LineGeometry.prototype,"vertices",{get:function(){return this._customGeometry.vertices},set:function(vertices){this._customGeometry.vertices=vertices},enumerable:!0,configurable:!0}),LineGeometry.prototype.computeData=function(){return{vertices:this.computeVertices()}},__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],LineGeometry.prototype,"vertices",null),LineGeometry}(wd.Geometry);wd.LineGeometry=LineGeometry}(wd||(wd={}));var wd;!function(wd){var SolidLineGeometry=function(_super){function SolidLineGeometry(){_super.apply(this,arguments)}return __extends(SolidLineGeometry,_super),SolidLineGeometry.create=function(){var geo=new this;return geo.initWhenCreate(),geo},SolidLineGeometry.prototype.initWhenCreate=function(){this.drawMode=wd.EDrawMode.LINE_STRIP},SolidLineGeometry.prototype.computeVertices=function(){return this.vertices},SolidLineGeometry}(wd.LineGeometry);wd.SolidLineGeometry=SolidLineGeometry}(wd||(wd={}));var wd;!function(wd){var DashLineGeometry=function(_super){function DashLineGeometry(){_super.apply(this,arguments),this.dashSize=3,this.gapSize=1,this.dashCount=200}return __extends(DashLineGeometry,_super),DashLineGeometry.create=function(){var geo=new this;return geo.initWhenCreate(),geo},DashLineGeometry.prototype.initWhenCreate=function(){this.drawMode=wd.EDrawMode.LINES},DashLineGeometry.prototype.computeVertices=function(){for(var dashSize=this.dashSize,gapSize=this.gapSize,dashCount=this.dashCount,points=this.vertices.slice(0),curvect=wd.Vector3.create(),lg=0,count=0,shft=0,dashshft=0,curshft=0,vertices=[],i=0,len=points.length-3;i<len;i+=3)curvect.x=points[i+3]-points[i],curvect.y=points[i+4]-points[i+1],curvect.z=points[i+5]-points[i+2],lg+=curvect.length();shft=lg/dashCount,dashshft=dashSize*shft/(dashSize+gapSize);for(var i=0,len=points.length-3;i<len;i+=3){curvect.x=points[i+3]-points[i],curvect.y=points[i+4]-points[i+1],curvect.z=points[i+5]-points[i+2],count=Math.floor(curvect.length()/shft),curvect.normalize();for(var j=0;j<count;j++)curshft=shft*j,vertices.push(points[i]+curshft*curvect.x,points[i+1]+curshft*curvect.y,points[i+2]+curshft*curvect.z),vertices.push(points[i]+(curshft+dashshft)*curvect.x,points[i+1]+(curshft+dashshft)*curvect.y,points[i+2]+(curshft+dashshft)*curvect.z)}return vertices},__decorate([wd.cloneAttributeAsBasicType()],DashLineGeometry.prototype,"dashSize",void 0),__decorate([wd.cloneAttributeAsBasicType()],DashLineGeometry.prototype,"gapSize",void 0),__decorate([wd.cloneAttributeAsBasicType()],DashLineGeometry.prototype,"dashCount",void 0),DashLineGeometry}(wd.LineGeometry);wd.DashLineGeometry=DashLineGeometry}(wd||(wd={}));var wd;!function(wd){var ConvexPolygonGeometry=function(_super){function ConvexPolygonGeometry(){_super.apply(this,arguments),this._customGeometry=wd.CustomGeometry.create()}return __extends(ConvexPolygonGeometry,_super),ConvexPolygonGeometry.create=function(){var geom=new this;return geom},Object.defineProperty(ConvexPolygonGeometry.prototype,"vertices",{get:function(){return this._customGeometry.vertices},set:function(vertices){this._customGeometry.vertices=vertices},enumerable:!0,configurable:!0}),Object.defineProperty(ConvexPolygonGeometry.prototype,"texCoords",{get:function(){return this._customGeometry.texCoords},set:function(texCoords){this._customGeometry.texCoords=texCoords},enumerable:!0,configurable:!0}),Object.defineProperty(ConvexPolygonGeometry.prototype,"colors",{get:function(){return this._customGeometry.colors},set:function(colors){this._customGeometry.colors=colors},enumerable:!0,configurable:!0}),Object.defineProperty(ConvexPolygonGeometry.prototype,"indices",{get:function(){return this._customGeometry.indices},set:function(indices){this._customGeometry.indices=indices},enumerable:!0,configurable:!0}),Object.defineProperty(ConvexPolygonGeometry.prototype,"normals",{get:function(){return this._customGeometry.normals},set:function(normals){this._customGeometry.normals=normals},enumerable:!0,configurable:!0}),ConvexPolygonGeometry.prototype.computeData=function(){for(var indices=[],i=1,len=this.vertices.length/3-1;i<len;i++)indices.push(0,i+1,i);return this.indices=indices,{vertices:this.vertices,faces:wd.GeometryUtils.convertToFaces(this.indices,this.normals),texCoords:this.texCoords,colors:this.colors}},__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],ConvexPolygonGeometry.prototype,"vertices",null),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],ConvexPolygonGeometry.prototype,"texCoords",null),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],ConvexPolygonGeometry.prototype,"colors",null),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],ConvexPolygonGeometry.prototype,"indices",null),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],ConvexPolygonGeometry.prototype,"normals",null),ConvexPolygonGeometry}(wd.Geometry);wd.ConvexPolygonGeometry=ConvexPolygonGeometry}(wd||(wd={}));var wd;!function(wd){var GeometryUtils=function(){function GeometryUtils(){}return GeometryUtils.convertToFaces=function(indices,normals){for(var hasNormals=this.hasData(normals),faces=[],i=0,len=indices.length;i<len;i+=3){var a=indices[i],b=indices[i+1],c=indices[i+2],face=wd.Face3.create(a,b,c);hasNormals&&(face.vertexNormals.addChildren([this.getThreeComponent(normals,a),this.getThreeComponent(normals,b),this.getThreeComponent(normals,c)]),face.faceNormal=face.vertexNormals.getChild(0).clone()),faces.push(face)}return faces},GeometryUtils.hasData=function(data){return data&&(data.length&&data.length>0||data.getCount&&data.getCount()>0)},GeometryUtils.getThreeComponent=function(sourceData,index){var startIndex=3*index;return wd.Vector3.create(sourceData[startIndex],sourceData[startIndex+1],sourceData[startIndex+2])},GeometryUtils.iterateThreeComponent=function(dataArr,iterator){for(var i=0,len=dataArr.length;i<len;i+=3)iterator(wd.Vector3.create(dataArr[i],dataArr[i+1],dataArr[i+2]))},GeometryUtils.setThreeComponent=function(targetData,sourceData,index){sourceData instanceof wd.Vector3?(targetData[3*index]=sourceData.x,targetData[3*index+1]=sourceData.y,targetData[3*index+2]=sourceData.z):(targetData[3*index]=sourceData[0],targetData[3*index+1]=sourceData[1],targetData[3*index+2]=sourceData[2])},__decorate([wd.require(function(data){data&&wd.assert(data instanceof wdCb.Collection||data instanceof wdCb.Hash||wd.JudgeUtils.isArrayExactly(data),wd.Log.info.FUNC_SHOULD("data","be Array or Collection or Hash"))})],GeometryUtils,"hasData",null),__decorate([wd.require(function(dataArr,iterator){wd.assert(dataArr.length%3===0,wd.Log.info.FUNC_SHOULD("dataArr.length","times of three"))})],GeometryUtils,"iterateThreeComponent",null),GeometryUtils}();wd.GeometryUtils=GeometryUtils}(wd||(wd={}));var wd;!function(wd){var CustomGeometry=function(_super){function CustomGeometry(){_super.apply(this,arguments),this._vertices=[],this._texCoords=[],this._colors=[],this._indices=[],this._normals=[]}return __extends(CustomGeometry,_super),CustomGeometry.create=function(){var geom=new this;return geom},Object.defineProperty(CustomGeometry.prototype,"vertices",{get:function(){return this._vertices},set:function(vertices){this._vertices=vertices,this.buffers&&(this.buffers.geometryData.vertices=vertices)},enumerable:!0,configurable:!0}),Object.defineProperty(CustomGeometry.prototype,"texCoords",{get:function(){return this._texCoords},set:function(texCoords){this._texCoords=texCoords,this.buffers&&(this.buffers.geometryData.texCoords=texCoords)},enumerable:!0,configurable:!0}),Object.defineProperty(CustomGeometry.prototype,"colors",{get:function(){return this._colors},set:function(colors){this._colors=colors,this.buffers&&(this.buffers.geometryData.colors=colors)},enumerable:!0,configurable:!0}),Object.defineProperty(CustomGeometry.prototype,"indices",{get:function(){return this._indices},set:function(indices){this._indices=indices,
this.buffers&&(this.buffers.geometryData.faces=wd.GeometryUtils.convertToFaces(indices,this.normals))},enumerable:!0,configurable:!0}),Object.defineProperty(CustomGeometry.prototype,"normals",{get:function(){return this._normals},set:function(normals){this._normals=normals,this.buffers&&(this.buffers.geometryData.faces=wd.GeometryUtils.convertToFaces(this.indices,normals))},enumerable:!0,configurable:!0}),CustomGeometry.prototype.computeData=function(){return{vertices:this.vertices,faces:wd.GeometryUtils.convertToFaces(this.indices,this.normals),texCoords:this.texCoords,colors:this.colors}},__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],CustomGeometry.prototype,"vertices",null),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],CustomGeometry.prototype,"texCoords",null),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],CustomGeometry.prototype,"colors",null),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],CustomGeometry.prototype,"indices",null),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],CustomGeometry.prototype,"normals",null),CustomGeometry}(wd.Geometry);wd.CustomGeometry=CustomGeometry}(wd||(wd={}));var wd;!function(wd){var ModelGeometry=function(_super){function ModelGeometry(){_super.apply(this,arguments),this.vertices=null,this.colors=null,this.texCoords=null,this.faces=null,this.morphTargets=null,this.morphFaceNormals=wdCb.Hash.create(),this.morphVertexNormals=wdCb.Hash.create()}return __extends(ModelGeometry,_super),ModelGeometry.create=function(){var geom=new this;return geom},ModelGeometry.prototype.hasAnimation=function(){return this._hasMorphTargets()&&this.entityObject&&this.entityObject.hasComponent(wd.MorphAnimation)},ModelGeometry.prototype.hasMorphFaceNormals=function(){return this.buffers.geometryData.hasMorphFaceNormals()},ModelGeometry.prototype.hasMorphVertexNormals=function(){return this.buffers.geometryData.hasMorphVertexNormals()},ModelGeometry.prototype.computeMorphNormals=function(){this.buffers.geometryData.computeMorphNormals()},ModelGeometry.prototype.merge=function(geometry,transform){var sourceGeometryData=this._getSourceGeometryData(),targetGeometryData=this._getTargetGeometryData(geometry);sourceGeometryData=this._initGeometryData(sourceGeometryData),this.faces=this._mergeTransformedFace(sourceGeometryData.faces,targetGeometryData.faces,transform,sourceGeometryData.vertices.length/3),this.vertices=this._mergeData(sourceGeometryData.vertices,this._transformVertices(targetGeometryData.vertices,transform)),this.texCoords=this._mergeData(sourceGeometryData.texCoords,targetGeometryData.texCoords),this.colors=this._mergeData(sourceGeometryData.colors,targetGeometryData.colors)},ModelGeometry.prototype._getSourceGeometryData=function(){return null!==this.geometryData?this.geometryData:{vertices:this.vertices,texCoords:this.texCoords,colors:this.colors,faces:this.faces}},ModelGeometry.prototype._initGeometryData=function(geometryData){return{vertices:geometryData.vertices||[],texCoords:geometryData.texCoords||[],colors:geometryData.colors||[],faces:geometryData.faces||[]}},ModelGeometry.prototype._getTargetGeometryData=function(targetGeometry){return null!==targetGeometry.geometryData?targetGeometry.geometryData:targetGeometry instanceof ModelGeometry?{vertices:targetGeometry.vertices,texCoords:targetGeometry.texCoords,colors:targetGeometry.colors,faces:targetGeometry.faces}:targetGeometry.computeData()},ModelGeometry.prototype._transformVertices=function(vertices,targetTransform){for(var modelMatrix=targetTransform.localToWorldMatrix,resultVertices=[],i=0,len=vertices.length;i<len;i+=3){var transformedVec3=wd.Vector3.create(vertices[i],vertices[i+1],vertices[i+2]).applyMatrix4(modelMatrix);resultVertices.push(transformedVec3.x,transformedVec3.y,transformedVec3.z)}return resultVertices},ModelGeometry.prototype._mergeTransformedFace=function(sourceFaces,targetFaces,targetTransform,sourceVertexOffset){var normalMatrix=null;if(!targetFaces)return sourceFaces;normalMatrix=targetTransform.normalMatrix;for(var _loop_1=function(face){var clonedFace=wd.Face3.create(face.aIndex+sourceVertexOffset,face.bIndex+sourceVertexOffset,face.cIndex+sourceVertexOffset);if(face.hasFaceNormal()&&(clonedFace.faceNormal=face.faceNormal.clone().applyMatrix3(normalMatrix)),face.vertexNormals){var clonedVertexNormals_1=wdCb.Collection.create();face.vertexNormals.forEach(function(normal){clonedVertexNormals_1.addChild(normal.clone().applyMatrix3(normalMatrix))}),clonedFace.vertexNormals=clonedVertexNormals_1}sourceFaces.push(clonedFace)},_i=0,targetFaces_1=targetFaces;_i<targetFaces_1.length;_i++){var face=targetFaces_1[_i];_loop_1(face)}return sourceFaces},ModelGeometry.prototype._mergeData=function(source,target){return target?source.concat(target):source},ModelGeometry.prototype._mergeFace=function(source,target){if(!target)return source;for(var _i=0,target_4=target;_i<target_4.length;_i++){var face=target_4[_i];source.push(face.clone())}return source},ModelGeometry.prototype.computeNormals=function(){_super.prototype.computeNormals.call(this),this._hasMorphTargets()&&(this.isSmoothShading()?this.hasMorphVertexNormals()||this.computeMorphNormals():this.hasMorphFaceNormals()||this.computeMorphNormals())},ModelGeometry.prototype.computeData=function(){return{vertices:this.vertices,faces:this.faces,texCoords:this.texCoords,colors:this.colors,morphTargets:this.morphTargets}},ModelGeometry.prototype.createBufferContainer=function(){return this.hasAnimation()?wd.MorphBufferContainer.create(this.entityObject,this.entityObject.getComponent(wd.MorphAnimation)):wd.BasicBufferContainer.create(this.entityObject)},ModelGeometry.prototype.createGeometryData=function(vertices,faces,texCoords,colors,morphTargets){if(this.hasAnimation()){var geometryData=wd.MorphGeometryData.create(this);return geometryData.vertices=vertices,geometryData.faces=faces,geometryData.texCoords=texCoords,geometryData.colors=colors,geometryData.morphTargets=morphTargets,geometryData}return this.createBasicGeometryData(vertices,faces,texCoords,colors)},ModelGeometry.prototype._hasMorphTargets=function(){return this.morphTargets&&this.morphTargets.getCount()>0},ModelGeometry.prototype._getDeepCloneMorphData=function(source){var result=wdCb.Hash.create();return source&&source.forEach(function(data,key){result.addChild(key,data.clone(!0))}),result},__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],ModelGeometry.prototype,"vertices",void 0),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],ModelGeometry.prototype,"colors",void 0),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=wd.CloneUtils.cloneArray(source[memberName])})],ModelGeometry.prototype,"texCoords",void 0),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=this._mergeFace([],source[memberName])})],ModelGeometry.prototype,"faces",void 0),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=this._getDeepCloneMorphData(source[memberName])})],ModelGeometry.prototype,"morphTargets",void 0),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=this._getDeepCloneMorphData(source[memberName])})],ModelGeometry.prototype,"morphFaceNormals",void 0),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=this._getDeepCloneMorphData(source[memberName])})],ModelGeometry.prototype,"morphVertexNormals",void 0),__decorate([wd.require(function(){wd.assert(this.buffers&&this.buffers.geometryData,wd.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],ModelGeometry.prototype,"hasMorphFaceNormals",null),__decorate([wd.require(function(){wd.assert(this.buffers&&this.buffers.geometryData,wd.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],ModelGeometry.prototype,"hasMorphVertexNormals",null),__decorate([wd.require(function(){wd.assert(this.buffers&&this.buffers.geometryData,wd.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],ModelGeometry.prototype,"computeMorphNormals",null),__decorate([wd.require(function(vertices,targetTransform){wd.assert(vertices&&vertices.length>0,wd.Log.info.FUNC_MUST("vertices.count","> 0"))})],ModelGeometry.prototype,"_transformVertices",null),__decorate([wd.require(function(){this.hasAnimation()&&wd.assert(this.entityObject.getComponent(wd.MorphAnimation),wd.Log.info.FUNC_SHOULD("entityObject with ModelGeometry","add MorphAnimation component"))})],ModelGeometry.prototype,"createBufferContainer",null),ModelGeometry}(wd.Geometry);wd.ModelGeometry=ModelGeometry}(wd||(wd={}));var wd;!function(wd){var BoxGeometry=function(_super){function BoxGeometry(){_super.apply(this,arguments),this.width=null,this.height=null,this.depth=null,this.widthSegments=1,this.heightSegments=1,this.depthSegments=1}return __extends(BoxGeometry,_super),BoxGeometry.create=function(){var geom=new this;return geom},BoxGeometry.prototype.computeData=function(){function generateFace(side,uSegments,vSegments){var u,v,i,j,offset=vertices.length/3;for(i=0;i<=uSegments;i++)for(j=0;j<=vSegments;j++){var temp1=wd.Vector3.create(),temp2=wd.Vector3.create(),temp3=wd.Vector3.create(),r=wd.Vector3.create();temp1.lerp(corners[faceAxes[side][0]],corners[faceAxes[side][1]],i/uSegments),temp2.lerp(corners[faceAxes[side][0]],corners[faceAxes[side][2]],j/vSegments),temp3.sub2(temp2,corners[faceAxes[side][0]]),r.add2(temp1,temp3),u=i/uSegments,v=j/vSegments,vertices.push(r.x,r.y,r.z),normals.push(faceNormals[side][0],faceNormals[side][1],faceNormals[side][2]),texCoords.push(u,v),i<uSegments&&j<vSegments&&(indices.push(offset+j+i*(uSegments+1),offset+j+(i+1)*(uSegments+1),offset+j+i*(uSegments+1)+1),indices.push(offset+j+(i+1)*(uSegments+1),offset+j+(i+1)*(uSegments+1)+1,offset+j+i*(uSegments+1)+1))}}var width=this.width,height=this.height,depth=this.depth,widthSegments=this.widthSegments,heightSegments=this.heightSegments,depthSegments=this.depthSegments,sides={FRONT:0,BACK:1,TOP:2,BOTTOM:3,RIGHT:4,LEFT:5},faceAxes=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],faceNormals=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],corners=[wd.Vector3.create(-width,-height,depth),wd.Vector3.create(width,-height,depth),wd.Vector3.create(width,height,depth),wd.Vector3.create(-width,height,depth),wd.Vector3.create(width,-height,-depth),wd.Vector3.create(-width,-height,-depth),wd.Vector3.create(-width,height,-depth),wd.Vector3.create(width,height,-depth)],vertices=[],normals=[],texCoords=[],indices=[];return generateFace(sides.FRONT,widthSegments,heightSegments),generateFace(sides.BACK,widthSegments,heightSegments),generateFace(sides.TOP,widthSegments,depthSegments),generateFace(sides.BOTTOM,widthSegments,depthSegments),generateFace(sides.RIGHT,depthSegments,heightSegments),generateFace(sides.LEFT,depthSegments,heightSegments),{vertices:vertices,faces:wd.GeometryUtils.convertToFaces(indices,normals),texCoords:texCoords}},__decorate([wd.cloneAttributeAsBasicType()],BoxGeometry.prototype,"width",void 0),__decorate([wd.cloneAttributeAsBasicType()],BoxGeometry.prototype,"height",void 0),__decorate([wd.cloneAttributeAsBasicType()],BoxGeometry.prototype,"depth",void 0),__decorate([wd.cloneAttributeAsBasicType()],BoxGeometry.prototype,"widthSegments",void 0),__decorate([wd.cloneAttributeAsBasicType()],BoxGeometry.prototype,"heightSegments",void 0),__decorate([wd.cloneAttributeAsBasicType()],BoxGeometry.prototype,"depthSegments",void 0),BoxGeometry}(wd.Geometry);wd.BoxGeometry=BoxGeometry}(wd||(wd={}));var wd;!function(wd){var RectGeometry=function(_super){function RectGeometry(){_super.apply(this,arguments),this.width=null,this.height=null}return __extends(RectGeometry,_super),RectGeometry.create=function(){var geom=new this;return geom},RectGeometry.prototype.computeData=function(){var width=this.width,height=this.height,left=-width/2,right=width/2,up=height/2,down=-height/2,vertices=[],texCoords=[],indices=[],normals=[];return vertices=[right,up,0,left,up,0,left,down,0,right,down,0],indices=[0,1,2,0,2,3],texCoords=[1,1,0,1,0,0,1,0],normals=[0,0,1,0,0,1,0,0,1,0,0,1],{vertices:vertices,faces:wd.GeometryUtils.convertToFaces(indices,normals),texCoords:texCoords}},__decorate([wd.cloneAttributeAsBasicType()],RectGeometry.prototype,"width",void 0),__decorate([wd.cloneAttributeAsBasicType()],RectGeometry.prototype,"height",void 0),RectGeometry}(wd.Geometry);wd.RectGeometry=RectGeometry}(wd||(wd={}));var wd;!function(wd){var PlaneGeometry=function(_super){function PlaneGeometry(){_super.apply(this,arguments),this.width=null,this.height=null,this.widthSegments=1,this.heightSegments=1}return __extends(PlaneGeometry,_super),PlaneGeometry.create=function(){var geom=new this;return geom},PlaneGeometry.prototype.computeData=function(){var width=this.width,height=this.height,widthSegments=this.widthSegments,heightSegments=this.heightSegments,x=null,y=null,z=null,u=null,v=null,i=null,j=null,vertices=[],texCoords=[],normals=[],indices=[];for(i=0;i<=widthSegments;i++)for(j=0;j<=heightSegments;j++)x=-width+2*width*i/widthSegments,y=0,z=-(-height+2*height*j/heightSegments),u=i/widthSegments,v=j/heightSegments,vertices.push(x,y,z),normals.push(0,1,0),texCoords.push(u,v),i<widthSegments&&j<heightSegments&&(indices.push(j+i*(widthSegments+1),j+(i+1)*(widthSegments+1),j+i*(widthSegments+1)+1),indices.push(j+(i+1)*(widthSegments+1),j+(i+1)*(widthSegments+1)+1,j+i*(widthSegments+1)+1));return{vertices:vertices,faces:wd.GeometryUtils.convertToFaces(indices,normals),texCoords:texCoords}},__decorate([wd.cloneAttributeAsBasicType()],PlaneGeometry.prototype,"width",void 0),__decorate([wd.cloneAttributeAsBasicType()],PlaneGeometry.prototype,"height",void 0),__decorate([wd.cloneAttributeAsBasicType()],PlaneGeometry.prototype,"widthSegments",void 0),__decorate([wd.cloneAttributeAsBasicType()],PlaneGeometry.prototype,"heightSegments",void 0),PlaneGeometry}(wd.Geometry);wd.PlaneGeometry=PlaneGeometry}(wd||(wd={}));var wd;!function(wd){!function(ESphereDrawMode){ESphereDrawMode[ESphereDrawMode.LATITUDELONGTITUDE=0]="LATITUDELONGTITUDE"}(wd.ESphereDrawMode||(wd.ESphereDrawMode={}));wd.ESphereDrawMode}(wd||(wd={}));var wd;!function(wd){var SphereGeometry=function(_super){function SphereGeometry(){_super.apply(this,arguments),this.radius=1,this.sphereDrawMode=wd.ESphereDrawMode.LATITUDELONGTITUDE,this.segments=20}return __extends(SphereGeometry,_super),SphereGeometry.create=function(){var geom=new this;return geom},SphereGeometry.prototype.computeData=function(){var radius=this.radius,segments=(this.sphereDrawMode,this.segments),_a=GetDataByLatitudeLongtitude.create(radius,segments).getData(),vertices=_a.vertices,indices=_a.indices,normals=_a.normals,texCoords=_a.texCoords;return{vertices:vertices,faces:wd.GeometryUtils.convertToFaces(indices,normals),texCoords:texCoords}},__decorate([wd.cloneAttributeAsBasicType()],SphereGeometry.prototype,"radius",void 0),__decorate([wd.cloneAttributeAsBasicType()],SphereGeometry.prototype,"sphereDrawMode",void 0),__decorate([wd.cloneAttributeAsBasicType()],SphereGeometry.prototype,"segments",void 0),__decorate([wd.require(function(){wd.assert(this.sphereDrawMode===wd.ESphereDrawMode.LATITUDELONGTITUDE,wd.Log.info.FUNC_MUST_BE("sphereDrawMode","ESphereDrawMode.LATITUDELONGTITUDE"))})],SphereGeometry.prototype,"computeData",null),SphereGeometry}(wd.Geometry);wd.SphereGeometry=SphereGeometry;var GetDataByLatitudeLongtitude=function(){function GetDataByLatitudeLongtitude(radius,bands){this._radius=null,this._latitudeBands=null,this._longitudeBands=null,this._radius=radius,this._latitudeBands=bands,this._longitudeBands=bands}return GetDataByLatitudeLongtitude.create=function(radius,bands){var geom=new this(radius,bands);return geom},GetDataByLatitudeLongtitude.prototype.getData=function(){for(var vertices=[],normals=[],texCoords=[],indices=[],latNumber=0;latNumber<=this._latitudeBands;latNumber++)for(var theta=latNumber*Math.PI/this._latitudeBands,sinTheta=Math.sin(theta),cosTheta=Math.cos(theta),longNumber=0;longNumber<=this._longitudeBands;longNumber++){var phi=2*longNumber*Math.PI/this._longitudeBands,sinPhi=Math.sin(phi),cosPhi=Math.cos(phi),x=this._radius*cosPhi*sinTheta,y=this._radius*cosTheta,z=this._radius*sinPhi*sinTheta,u=1-longNumber/this._longitudeBands,v=1-latNumber/this._latitudeBands;normals.push(x),normals.push(y),normals.push(z),texCoords.push(u),texCoords.push(v),vertices.push(x),vertices.push(y),vertices.push(z)}for(var latNumber=0;latNumber<this._latitudeBands;latNumber++)for(var longNumber=0;longNumber<this._longitudeBands;longNumber++){var first=latNumber*(this._longitudeBands+1)+longNumber,second=first+this._longitudeBands+1;indices.push(first+1),indices.push(second),indices.push(first),indices.push(first+1),indices.push(second+1),indices.push(second)}return{vertices:vertices,indices:indices,normals:normals,texCoords:texCoords}},GetDataByLatitudeLongtitude}()}(wd||(wd={}));var wd;!function(wd){var TriangleGeometry=function(_super){function TriangleGeometry(){_super.apply(this,arguments),this.width=null,this.height=null}return __extends(TriangleGeometry,_super),TriangleGeometry.create=function(){var geom=new this;return geom},TriangleGeometry.prototype.computeData=function(){var width=this.width,height=this.height,left=-width/2,right=width/2,up=height/2,down=-height/2,vertices=null,texCoords=null,indices=null,normals=null;return vertices=[0,up,0,left,down,0,right,down,0],indices=[0,1,2],texCoords=[.5,1,0,0,1,0],normals=[0,0,1,0,0,1,0,0,1],{vertices:vertices,faces:wd.GeometryUtils.convertToFaces(indices,normals),texCoords:texCoords}},__decorate([wd.cloneAttributeAsBasicType()],TriangleGeometry.prototype,"width",void 0),__decorate([wd.cloneAttributeAsBasicType()],TriangleGeometry.prototype,"height",void 0),TriangleGeometry}(wd.Geometry);wd.TriangleGeometry=TriangleGeometry}(wd||(wd={}));var wd;!function(wd){var TerrainGeometry=function(_super){function TerrainGeometry(){_super.apply(this,arguments),this.subdivisions=1,this.range={width:10,height:10},this.minHeight=0,this.maxHeight=10,this.heightMapAsset=null}return __extends(TerrainGeometry,_super),TerrainGeometry.create=function(){var obj=new this;return obj},TerrainGeometry.prototype.computeData=function(){var image=this.heightMapAsset.source,bufferWidth=image.width,bufferHeight=image.height;return this._createGroundFromHeightMap(this._readHeightMapData(image,bufferWidth,bufferHeight),bufferWidth,bufferHeight)},TerrainGeometry.prototype._readHeightMapData=function(image,bufferWidth,bufferHeight){var canvas=document.createElement("canvas"),context=canvas.getContext("2d");return canvas.width=bufferWidth,canvas.height=bufferHeight,context.drawImage(image,0,0),context.getImageData(0,0,bufferWidth,bufferHeight).data},TerrainGeometry.prototype._createGroundFromHeightMap=function(buffer,bufferWidth,bufferHeight){for(var vertices=[],normals=[],texCoords=[],subdivisions=this.subdivisions,width=this.range.width,height=this.range.height,row=0;row<=subdivisions;row++)for(var col=0;col<=subdivisions;col++){var x=col*width/subdivisions-width/2,z=(subdivisions-row)*height/subdivisions-height/2;vertices.push(x,this._getHeight(x,z,buffer,bufferWidth,bufferHeight),z),texCoords.push(col/subdivisions,1-row/subdivisions)}return{vertices:vertices,faces:wd.GeometryUtils.convertToFaces(this._getIndices(),normals),texCoords:texCoords}},TerrainGeometry.prototype._getHeight=function(x,z,buffer,bufferWidth,bufferHeight){var width=this.range.width,height=this.range.height,heightMapX=(x+width/2)/width*(bufferWidth-1)|0,heightMapY=(1-(z+height/2)/height)*(bufferHeight-1)|0,pos=4*(heightMapX+heightMapY*bufferWidth),r=buffer[pos]/255,g=buffer[pos+1]/255,b=buffer[pos+2]/255,gradient=.3*r+.59*g+.11*b,minHeight=this.minHeight,maxHeight=this.maxHeight;return minHeight+(maxHeight-minHeight)*gradient},TerrainGeometry.prototype._getIndices=function(){for(var indices=[],subdivisions=this.subdivisions,row=0;row<subdivisions;row++)for(var col=0;col<subdivisions;col++)indices.push(col+row*(subdivisions+1)),indices.push(col+1+row*(subdivisions+1)),indices.push(col+1+(row+1)*(subdivisions+1)),indices.push(col+row*(subdivisions+1)),indices.push(col+1+(row+1)*(subdivisions+1)),indices.push(col+(row+1)*(subdivisions+1));return indices},__decorate([wd.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"subdivisions",void 0),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName].width=source[memberName].width,target[memberName].height=source[memberName].height})],TerrainGeometry.prototype,"range",void 0),__decorate([wd.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"minHeight",void 0),__decorate([wd.cloneAttributeAsBasicType()],TerrainGeometry.prototype,"maxHeight",void 0),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){source[memberName]&&(target[memberName]=wd.ImageTextureAsset.create(source[memberName].source))})],TerrainGeometry.prototype,"heightMapAsset",void 0),TerrainGeometry}(wd.Geometry);wd.TerrainGeometry=TerrainGeometry}(wd||(wd={}));var wd;!function(wd){var GeometryData=function(){function GeometryData(geometry){this._vertices=null,this._faces=null,this._texCoords=null,this._colors=null,this._tangents=null,this.tangentDirty=!0,this.colorDirty=!0,this.geometry=null,this._normalCache=null,this._normalFromFaceCache=null,this._normalFromVertexCache=null,this._indiceCache=null,this._colorCache=null,this._normalDirty=!0,this._indiceDirty=!0,this._materialColorChangeSubscription=null,this.geometry=geometry}return Object.defineProperty(GeometryData.prototype,"vertices",{get:function(){return this._vertices},set:function(vertices){this._vertices=vertices,this.tangentDirty=!0,this.geometry.buffers.removeCache(wd.EBufferDataType.VERTICE)},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"normals",{get:function(){var geometry=this.geometry;return geometry.isSmoothShading()?(this.hasVertexNormals()||this.computeVertexNormals(),this.normalsFromVertexNormals):(this.hasFaceNormals()||this.computeFaceNormals(),this.normalsFromFaceNormal)},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"normalsFromFaceNormal",{get:function(){var normals=null;return this.hasFaceNormals()?(normals=[],this._faces.forEach(function(face){var normal=face.faceNormal;wd.GeometryUtils.setThreeComponent(normals,normal,face.aIndex),wd.GeometryUtils.setThreeComponent(normals,normal,face.bIndex),wd.GeometryUtils.setThreeComponent(normals,normal,face.cIndex)}),this._fillEmptyData(normals),normals):[]},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"normalsFromVertexNormals",{get:function(){var normals=null;return this.hasVertexNormals()?(normals=[],this._faces.forEach(function(face){wd.GeometryUtils.setThreeComponent(normals,face.vertexNormals.getChild(0),face.aIndex),wd.GeometryUtils.setThreeComponent(normals,face.vertexNormals.getChild(1),face.bIndex),wd.GeometryUtils.setThreeComponent(normals,face.vertexNormals.getChild(2),face.cIndex)}),this._fillEmptyData(normals),normals):[]},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"indices",{get:function(){for(var indices=[],_i=0,_a=this._faces;_i<_a.length;_i++){var face=_a[_i];indices.push(face.aIndex,face.bIndex,face.cIndex)}return indices},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"faces",{get:function(){return this._faces},set:function(faces){this._faces=faces,this.geometry.buffers.removeCache(wd.EBufferDataType.NORMAL),this.geometry.buffers.removeCache(wd.EBufferDataType.INDICE),this.onChangeFace()},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"texCoords",{get:function(){return this._texCoords},set:function(texCoords){this._texCoords=texCoords,this.tangentDirty=!0,this.geometry.buffers.removeCache(wd.EBufferDataType.TEXCOORD)},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"colors",{get:function(){return this._needGetColorsFromMaterial()?this._getColorsFromMaterial(this._vertices):this._colors},set:function(colors){this._colors=colors,this.colorDirty=!0,this.geometry.buffers.removeCache(wd.EBufferDataType.COLOR)},enumerable:!0,configurable:!0}),Object.defineProperty(GeometryData.prototype,"tangents",{get:function(){return this.tangentDirty&&(this.tangentDirty=!1,wd.GeometryUtils.hasData(this.normals)&&wd.GeometryUtils.hasData(this.texCoords)&&wd.GeometryUtils.hasData(this.indices)&&(this._tangents=this._calculateTangents(this._vertices,this.normals,this.texCoords,this.indices))),this._tangents},enumerable:!0,configurable:!0}),GeometryData.prototype.init=function(){var self=this;this._materialColorChangeSubscription=wdFrp.fromArray([wd.EventManager.fromEvent(this.geometry.entityObject,wd.EEngineEvent.MATERIAL_COLOR_CHANGE),wd.EventManager.fromEvent(this.geometry.entityObject,wd.EEngineEvent.MATERIAL_CHANGE)]).subscribe(function(){self._needGetColorsFromMaterial()&&(self.colorDirty=!0)})},GeometryData.prototype.dispose=function(){this._materialColorChangeSubscription&&this._materialColorChangeSubscription.dispose()},GeometryData.prototype.computeFaceNormals=function(){for(var vertices=this._vertices,_i=0,_a=this._faces;_i<_a.length;_i++){var face=_a[_i];face.faceNormal=this.computeFaceNormalsHelper(vertices,face.aIndex,face.bIndex,face.cIndex)}},GeometryData.prototype.computeVertexNormals=function(){var normals=null;this.hasFaceNormals()||this.computeFaceNormals(),normals=this.computeVertexNormalsHelper(this._vertices);for(var _i=0,_a=this._faces;_i<_a.length;_i++){var face=_a[_i];face.vertexNormals=wdCb.Collection.create([normals[face.aIndex],normals[face.bIndex],normals[face.cIndex]])}},GeometryData.prototype.hasFaceNormals=function(){for(var _i=0,_a=this._faces;_i<_a.length;_i++){var face=_a[_i];if(!face.hasFaceNormal())return!1}return!0},GeometryData.prototype.hasVertexNormals=function(){for(var _i=0,_a=this._faces;_i<_a.length;_i++){var face=_a[_i];if(!face.hasVertexNormal())return!1}return!0},GeometryData.prototype.onChangeFace=function(){this.tangentDirty=!0,this._normalDirty=!0,this._indiceDirty=!0},GeometryData.prototype.computeFaceNormalsHelper=function(vertices,aIndex,bIndex,cIndex){var p0=wd.GeometryUtils.getThreeComponent(vertices,aIndex),p1=wd.GeometryUtils.getThreeComponent(vertices,bIndex),p2=wd.GeometryUtils.getThreeComponent(vertices,cIndex),v0=wd.Vector3.create().sub2(p2,p1),v1=wd.Vector3.create().sub2(p0,p1);return wd.Vector3.create().cross(v0,v1).normalize()},GeometryData.prototype.computeVertexNormalsHelper=function(vertices){var vl=vertices.length/3,normals=null;normals=new Array(vl);for(var v=0;v<vl;v++)normals[v]=wd.Vector3.create();for(var _i=0,_a=this._faces;_i<_a.length;_i++){var face=_a[_i],faceNormal=null;faceNormal=face.faceNormal,normals[face.aIndex].add(faceNormal),normals[face.bIndex].add(faceNormal),normals[face.cIndex].add(faceNormal)}for(var v=0;v<vl;v++)normals[v].normalize();return normals},GeometryData.prototype._getColorsFromMaterial=function(vertices){var arr=[],i=0,color=this.geometry.material.color,r=color.r,g=color.g,b=color.b,len=null;for(len=vertices.length/3,i=0;i<len;i++)arr.push(r,g,b);return arr},GeometryData.prototype._fillEmptyData=function(data){for(var i=0,len=data.length;i<len;i++)isNaN(data[i])&&(data[i]=0)},GeometryData.prototype._calculateTangents=function(vertices,normals,texCoords,indices){var i1,i2,i3,x1,x2,y1,y2,z1,z2,s1,s2,t1,t2,r,i,triangleCount=indices.length/3,vertexCount=vertices.length/3,sdir=wd.Vector3.create(),tdir=wd.Vector3.create(),v1=wd.Vector3.create(),v2=wd.Vector3.create(),v3=wd.Vector3.create(),w1=wd.Vector2.create(),w2=wd.Vector2.create(),w3=wd.Vector2.create(),tan1=new Float32Array(3*vertexCount),tan2=new Float32Array(3*vertexCount),n=wd.Vector3.create(),temp=wd.Vector3.create(),tangents=[];for(i=0;i<triangleCount;i++)i1=indices[3*i],i2=indices[3*i+1],i3=indices[3*i+2],v1.set(vertices[3*i1],vertices[3*i1+1],vertices[3*i1+2]),v2.set(vertices[3*i2],vertices[3*i2+1],vertices[3*i2+2]),v3.set(vertices[3*i3],vertices[3*i3+1],vertices[3*i3+2]),w1.set(texCoords[2*i1],texCoords[2*i1+1]),w2.set(texCoords[2*i2],texCoords[2*i2+1]),w3.set(texCoords[2*i3],texCoords[2*i3+1]),x1=v2.x-v1.x,x2=v3.x-v1.x,y1=v2.y-v1.y,y2=v3.y-v1.y,z1=v2.z-v1.z,z2=v3.z-v1.z,s1=w2.x-w1.x,s2=w3.x-w1.x,t1=w2.y-w1.y,t2=w3.y-w1.y,r=1/(s1*t2-s2*t1),sdir.set((t2*x1-t1*x2)*r,(t2*y1-t1*y2)*r,(t2*z1-t1*z2)*r),tdir.set((s1*x2-s2*x1)*r,(s1*y2-s2*y1)*r,(s1*z2-s2*z1)*r),tan1[3*i1+0]+=sdir.x,tan1[3*i1+1]+=sdir.y,tan1[3*i1+2]+=sdir.z,tan1[3*i2+0]+=sdir.x,tan1[3*i2+1]+=sdir.y,tan1[3*i2+2]+=sdir.z,tan1[3*i3+0]+=sdir.x,tan1[3*i3+1]+=sdir.y,tan1[3*i3+2]+=sdir.z,tan2[3*i1+0]+=tdir.x,tan2[3*i1+1]+=tdir.y,tan2[3*i1+2]+=tdir.z,tan2[3*i2+0]+=tdir.x,tan2[3*i2+1]+=tdir.y,tan2[3*i2+2]+=tdir.z,tan2[3*i3+0]+=tdir.x,tan2[3*i3+1]+=tdir.y,tan2[3*i3+2]+=tdir.z;for(t1=wd.Vector3.create(),t2=wd.Vector3.create(),i=0;i<vertexCount;i++){var ndott=null;n.set(normals[3*i],normals[3*i+1],normals[3*i+2]),t1.set(tan1[3*i],tan1[3*i+1],tan1[3*i+2]),t2.set(tan2[3*i],tan2[3*i+1],tan2[3*i+2]),ndott=n.dot(t1),temp=n.clone().scale(ndott),temp.sub2(t1,temp).normalize(),tangents[4*i]=temp.x,tangents[4*i+1]=temp.y,tangents[4*i+2]=temp.z,temp.cross(n,t1),tangents[4*i+3]=temp.dot(t2)<0?-1:1}return tangents},GeometryData.prototype._needGetColorsFromMaterial=function(){var colors=this._colors;return!colors||0===colors.length},__decorate([wd.requireGetter(function(){wd.assert(this._faces.length>0,wd.Log.info.FUNC_SHOULD("faces.count","> 0"));for(var _i=0,_a=this._faces;_i<_a.length;_i++){var face=_a[_i];this.geometry.isSmoothShading()&&wd.assert(face.vertexNormals&&3===face.vertexNormals.getCount(),wd.Log.info.FUNC_SHOULD("faces->vertexNormals.count","=== 3"))}}),wd.cacheGetter(function(){return!this._normalDirty&&this._normalCache},function(){return this._normalCache},function(result){this._normalCache=result,this._normalDirty=!1})],GeometryData.prototype,"normals",null),__decorate([wd.requireGetter(function(){wd.assert(this._faces.length>0,wd.Log.info.FUNC_SHOULD("geometry","has faces"))}),wd.ensureGetter(function(normals){for(var _i=0,normals_1=normals;_i<normals_1.length;_i++){var data=normals_1[_i];wd.assert(wd.JudgeUtils.isNumber(data),wd.Log.info.FUNC_SHOULD("normals data","be number"))}}),wd.cacheGetter(function(){return!this._normalDirty&&this._normalFromFaceCache},function(){return this._normalFromFaceCache},function(result){this._normalFromFaceCache=result,this._normalDirty=!1})],GeometryData.prototype,"normalsFromFaceNormal",null),__decorate([wd.requireGetter(function(){wd.assert(this._faces.length>0,wd.Log.info.FUNC_SHOULD("geometry","has faces"))}),wd.ensureGetter(function(normals){for(var _i=0,normals_2=normals;_i<normals_2.length;_i++){var data=normals_2[_i];wd.assert(wd.JudgeUtils.isNumber(data),wd.Log.info.FUNC_SHOULD("normals data","be number"))}}),wd.cacheGetter(function(){return!this._normalDirty&&this._normalFromVertexCache},function(){return this._normalFromVertexCache},function(result){this._normalFromVertexCache=result,this._normalDirty=!1})],GeometryData.prototype,"normalsFromVertexNormals",null),__decorate([wd.cacheGetter(function(){return!this._indiceDirty&&this._indiceCache},function(){return this._indiceCache},function(result){this._indiceCache=result,this._indiceDirty=!1})],GeometryData.prototype,"indices",null),
__decorate([wd.ensureGetter(function(colors){wd.assert(colors.length===this._vertices.length,wd.Log.info.FUNC_SHOULD("colors.length:"+colors.length,"=== vertices.length:"+this._vertices.length))}),wd.cacheGetter(function(){return!this.colorDirty&&this._colorCache},function(){return this._colorCache},function(result){this._colorCache=result,this.colorDirty=!1})],GeometryData.prototype,"colors",null),__decorate([wd.require(function(){wd.assert(wd.GeometryUtils.hasData(this.vertices),wd.Log.info.FUNC_MUST("contain vertices"))}),wd.ensure(function(){for(var _i=0,_a=this._faces;_i<_a.length;_i++){var face=_a[_i];wd.assert(face.faceNormal instanceof wd.Vector3,wd.Log.info.FUNC_SHOULD_NOT("faceNormal","be null"))}})],GeometryData.prototype,"computeFaceNormals",null),__decorate([wd.virtual],GeometryData.prototype,"onChangeFace",null),GeometryData}();wd.GeometryData=GeometryData}(wd||(wd={}));var wd;!function(wd){var BasicGeometryData=function(_super){function BasicGeometryData(){_super.apply(this,arguments)}return __extends(BasicGeometryData,_super),BasicGeometryData.create=function(geometry){var obj=new this(geometry);return obj},BasicGeometryData}(wd.GeometryData);wd.BasicGeometryData=BasicGeometryData}(wd||(wd={}));var wd;!function(wd){var MorphGeometryData=function(_super){function MorphGeometryData(){_super.apply(this,arguments),this._morphTargets=null,this._morphNormalCache=null,this._morphNormalDirty=!0}return __extends(MorphGeometryData,_super),MorphGeometryData.create=function(geometry){var obj=new this(geometry);return obj},Object.defineProperty(MorphGeometryData.prototype,"morphNormals",{get:function(){var geometry=this.geometry;return this._morphNormalDirty=!1,geometry.isSmoothShading()?(this.hasMorphVertexNormals()||this.computeMorphNormals(),geometry.morphVertexNormals):(this.hasMorphFaceNormals()||this.computeMorphNormals(),geometry.morphFaceNormals)},enumerable:!0,configurable:!0}),Object.defineProperty(MorphGeometryData.prototype,"morphTargets",{get:function(){return this._morphTargets},set:function(morphTargets){this._morphTargets=morphTargets,this._morphNormalDirty=!0},enumerable:!0,configurable:!0}),MorphGeometryData.prototype.computeMorphNormals=function(){var geometry=this.geometry,self=this;this._morphTargets.forEach(function(frames,animName){var faceNormalList=wdCb.Collection.create(),vertexNormalList=wdCb.Collection.create();frames.forEach(function(vertices){var tempGeometryData=MorphGeometryData.create(geometry),faceNormalsOfEachFrame=null,vertexNormalsOfEachFrame=null;tempGeometryData.vertices=vertices,tempGeometryData.faces=self._copyFaces(geometry.faces),tempGeometryData.computeFaceNormals(),tempGeometryData.computeVertexNormals(),_a=self._getMorphNormals(tempGeometryData),faceNormalsOfEachFrame=_a[0],vertexNormalsOfEachFrame=_a[1],faceNormalList.addChild(faceNormalsOfEachFrame),vertexNormalList.addChild(vertexNormalsOfEachFrame);var _a}),geometry.morphFaceNormals.addChild(animName,faceNormalList),geometry.morphVertexNormals.addChild(animName,vertexNormalList)})},MorphGeometryData.prototype.hasMorphFaceNormals=function(){return this.geometry.morphFaceNormals.getCount()>0},MorphGeometryData.prototype.hasMorphVertexNormals=function(){return this.geometry.morphVertexNormals.getCount()>0},MorphGeometryData.prototype.onChangeFace=function(){this._morphNormalDirty=!0},MorphGeometryData.prototype._copyFaces=function(faces){for(var copyFaces=[],_i=0,faces_1=faces;_i<faces_1.length;_i++){var face=faces_1[_i];copyFaces.push(face.clone())}return copyFaces},MorphGeometryData.prototype._getMorphNormals=function(geometryData){return[geometryData.normalsFromFaceNormal,geometryData.normalsFromVertexNormals]},__decorate([wd.cacheGetter(function(){return!this._morphNormalDirty&&this._morphNormalCache},function(){return this._morphNormalCache},function(result){this._morphNormalCache=result})],MorphGeometryData.prototype,"morphNormals",null),MorphGeometryData}(wd.GeometryData);wd.MorphGeometryData=MorphGeometryData}(wd||(wd={}));var wd;!function(wd){var BitmapFontGeometryData=function(_super){function BitmapFontGeometryData(){_super.apply(this,arguments),this._pages=null}return __extends(BitmapFontGeometryData,_super),BitmapFontGeometryData.create=function(geometry){var obj=new this(geometry);return obj},Object.defineProperty(BitmapFontGeometryData.prototype,"pages",{get:function(){return this._pages},set:function(pages){this._pages=pages,this.geometry.buffers.removeCache("pages")},enumerable:!0,configurable:!0}),BitmapFontGeometryData}(wd.GeometryData);wd.BitmapFontGeometryData=BitmapFontGeometryData}(wd||(wd={}));var wd;!function(wd){var BufferContainer=function(){function BufferContainer(entityObject){this.geometryData=null,this.entityObject=null,this.container=wdCb.Hash.create(),this._colorBuffer=null,this._texCoordBuffer=null,this._tangentBuffer=null,this._indiceBuffer=null,this._materialChangeSubscription=null,this.entityObject=entityObject}return BufferContainer.prototype.createBuffersFromGeometryData=function(){this.getChild(wd.EBufferDataType.VERTICE),this.getChild(wd.EBufferDataType.NORMAL),this.getChild(wd.EBufferDataType.TANGENT),this.getChild(wd.EBufferDataType.COLOR),this.getChild(wd.EBufferDataType.INDICE),this.getChild(wd.EBufferDataType.TEXCOORD)},BufferContainer.prototype.init=function(){var self=this;this._materialChangeSubscription=wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.MATERIAL_CHANGE).subscribe(function(){self.removeCache(wd.EBufferDataType.COLOR),self.geometryData.colorDirty=!0}),this.geometryData.init()},BufferContainer.prototype.removeCache=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];this.container.removeChild(args[0])},BufferContainer.prototype.getChild=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var type=args[0],result=null;switch(type){case wd.EBufferDataType.VERTICE:result=this.getVertice(type);break;case wd.EBufferDataType.NORMAL:result=this.getNormal(type);break;case wd.EBufferDataType.TANGENT:result=this._getTangent(type);break;case wd.EBufferDataType.COLOR:result=this._getColor(type);break;case wd.EBufferDataType.INDICE:result=this._getIndice(type);break;case wd.EBufferDataType.TEXCOORD:result=this._getTexCoord(type);break;case wd.EBufferDataType.CUSTOM:result=this.getCustomData(args[1]);break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("EBufferDataType: "+type))}return result},BufferContainer.prototype.dispose=function(){this.container.forEach(function(buffer){buffer.dispose()}),this.geometryData.dispose(),this._materialChangeSubscription&&this._materialChangeSubscription.dispose()},BufferContainer.prototype.getCustomData=function(dataName){return null},BufferContainer.prototype.createOnlyOnceAndUpdateArrayBuffer=function(bufferAttriName,data,size,type,offset,usage){void 0===type&&(type=wd.EBufferType.FLOAT),void 0===offset&&(offset=0),void 0===usage&&(usage=wd.EBufferUsage.STATIC_DRAW);var buffer=this[bufferAttriName];return buffer?void buffer.resetData(data,size,type,offset):void(this[bufferAttriName]=wd.ArrayBuffer.create(data,size,type,usage))},BufferContainer.prototype.createOnlyOnceAndUpdateElememntBuffer=function(bufferAttriName,data,type,offset,usage){void 0===type&&(type=null),void 0===offset&&(offset=0),void 0===usage&&(usage=wd.EBufferUsage.STATIC_DRAW);var buffer=this[bufferAttriName];return buffer?void buffer.resetData(data,type,offset):void(this[bufferAttriName]=wd.ElementBuffer.create(data,type,usage))},BufferContainer.prototype.hasData=function(data){return data&&data.length>0},BufferContainer.prototype._getTangent=function(type){var geometryData=null;return geometryData=this.geometryData[wd.BufferDataTable.getGeometryDataName(type)],this.hasData(geometryData)?(this.createOnlyOnceAndUpdateArrayBuffer("_tangentBuffer",geometryData,3),this._tangentBuffer):null},BufferContainer.prototype._getColor=function(type){var geometryData=null;return geometryData=this.geometryData[wd.BufferDataTable.getGeometryDataName(type)],this.hasData(geometryData)?(this.createOnlyOnceAndUpdateArrayBuffer("_colorBuffer",geometryData,3),this._colorBuffer):null},BufferContainer.prototype._getIndice=function(type){var geometryData=null;return geometryData=this.geometryData[wd.BufferDataTable.getGeometryDataName(type)],this.hasData(geometryData)?(this.createOnlyOnceAndUpdateElememntBuffer("_indiceBuffer",geometryData),this._indiceBuffer):null},BufferContainer.prototype._getTexCoord=function(type){var geometryData=null;return geometryData=this.geometryData[wd.BufferDataTable.getGeometryDataName(type)],this.hasData(geometryData)?(this.createOnlyOnceAndUpdateArrayBuffer("_texCoordBuffer",geometryData,2),this._texCoordBuffer):null},BufferContainer.prototype._needReCalcuteTangent=function(type){return this.geometryData.tangentDirty&&type===wd.EBufferDataType.TANGENT},__decorate([wd.virtual],BufferContainer.prototype,"createBuffersFromGeometryData",null),__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.it("test arguments",function(){if(2===args.length){var dataName=args[1];wd.expect(dataName).exist,wd.expect(dataName).be.a("string")}})})],BufferContainer.prototype,"getChild",null),__decorate([wd.virtual],BufferContainer.prototype,"getCustomData",null),__decorate([wd.cache(function(type){return this.container.hasChild(type)&&!this._needReCalcuteTangent(type)},function(type){return this.container.getChild(type)},function(result,type){this.container.addChild(type,result)})],BufferContainer.prototype,"_getTangent",null),__decorate([wd.cache(function(type){return this.container.hasChild(type)},function(type){return this.container.getChild(type)},function(result,type){this.container.addChild(type,result)})],BufferContainer.prototype,"_getColor",null),__decorate([wd.cache(function(type){return this.container.hasChild(type)},function(type){return this.container.getChild(type)},function(result,type){this.container.addChild(type,result)})],BufferContainer.prototype,"_getIndice",null),__decorate([wd.cache(function(type){return this.container.hasChild(type)},function(type){return this.container.getChild(type)},function(result,type){this.container.addChild(type,result)})],BufferContainer.prototype,"_getTexCoord",null),BufferContainer}();wd.BufferContainer=BufferContainer}(wd||(wd={}));var wd;!function(wd){var CommonBufferContainer=function(_super){function CommonBufferContainer(){_super.apply(this,arguments),this._verticeBuffer=null,this._normalBuffer=null}return __extends(CommonBufferContainer,_super),CommonBufferContainer.prototype.getBufferForRenderSort=function(){var buffer=this.getChild(wd.EBufferDataType.VERTICE);return buffer?buffer:null},CommonBufferContainer.prototype.getVertice=function(type){var geometryData=this.geometryData[wd.BufferDataTable.getGeometryDataName(type)];return this.hasData(geometryData)?(this.createOnlyOnceAndUpdateArrayBuffer("_verticeBuffer",geometryData,3),this._verticeBuffer):null},CommonBufferContainer.prototype.getNormal=function(type){var geometryData=this.geometryData[wd.BufferDataTable.getGeometryDataName(type)];return this.hasData(geometryData)?(this.createOnlyOnceAndUpdateArrayBuffer("_normalBuffer",geometryData,3),this._normalBuffer):null},__decorate([wd.cache(function(type){return this.container.hasChild(type)},function(type){return this.container.getChild(type)},function(result,type){this.container.addChild(type,result)})],CommonBufferContainer.prototype,"getVertice",null),__decorate([wd.cache(function(type){return this.container.hasChild(type)},function(type){return this.container.getChild(type)},function(result,type){this.container.addChild(type,result)})],CommonBufferContainer.prototype,"getNormal",null),CommonBufferContainer}(wd.BufferContainer);wd.CommonBufferContainer=CommonBufferContainer}(wd||(wd={}));var wd;!function(wd){var BasicBufferContainer=function(_super){function BasicBufferContainer(){_super.apply(this,arguments)}return __extends(BasicBufferContainer,_super),BasicBufferContainer.create=function(entityObject){var obj=new this(entityObject);return obj},BasicBufferContainer}(wd.CommonBufferContainer);wd.BasicBufferContainer=BasicBufferContainer}(wd||(wd={}));var wd;!function(wd){var MorphBufferContainer=function(_super){function MorphBufferContainer(entityObject,animation){_super.call(this,entityObject),this._animation=null,this._isCacheChangeFlag={},this._isCacheChangeInLastLoop={},this._currentVerticeBuffer=null,this._nextVerticeBuffer=null,this._currentNormalBuffer=null,this._nextNormalBuffer=null,this._animation=animation}return __extends(MorphBufferContainer,_super),MorphBufferContainer.create=function(entityObject,animation){var obj=new this(entityObject,animation);return obj},MorphBufferContainer.prototype.getBufferForRenderSort=function(){return null},MorphBufferContainer.prototype.getVertice=function(type){return this._getMorphData(type,this.geometryData.morphTargets)},MorphBufferContainer.prototype.getNormal=function(type){return this._getMorphData(type,this.geometryData.morphNormals)},MorphBufferContainer.prototype._getMorphData=function(type,morphDataTargets){var cacheData=null,frames=null,result=null;if(this._isNotPlayAnimation())return this._getStaticData(type);if(0===morphDataTargets.getCount())return null;if(frames=this._getFrames(morphDataTargets),cacheData=this.container.getChild(type))if(this._animation.isFrameChange&&(this._isCacheChangeInLastLoop[type]||this._isCacheNotChange(type))){var currentBuffer=cacheData[0],nextBuffer=cacheData[1],newCurrentBuffer=null,newNextBuffer=null;newCurrentBuffer=nextBuffer,newNextBuffer=currentBuffer.resetData(frames.getChild(this._animation.nextFrame)),result=[newCurrentBuffer,newNextBuffer],this.container.addChild(type,result),this._isCacheChangeFlag[type]=!0,this._isCacheChangeInLastLoop[type]=!0}else this._isCacheChangeFlag[type]=!1,this._isCacheChangeInLastLoop[type]=!1,result=cacheData;else{var currentBuffer=this._getCurrentBufferWhichIsCreatedOnlyOnce(type,frames.getChild(this._animation.currentFrame),3),nextBuffer=this._getNextBufferWhichIsCreatedOnlyOnce(type,frames.getChild(this._animation.nextFrame),3);result=[currentBuffer,nextBuffer],this.container.addChild(type,result),this._isCacheChangeInLastLoop[type]=!1}return result},MorphBufferContainer.prototype._getFrames=function(morphDataTargets){return morphDataTargets.getChild(this._animation.currentAnimName)},MorphBufferContainer.prototype._getCurrentBufferWhichIsCreatedOnlyOnce=function(type,data,size){return type===wd.EBufferDataType.VERTICE?(this.createOnlyOnceAndUpdateArrayBuffer("_currentVerticeBuffer",data,size,wd.EBufferType.FLOAT,0,wd.EBufferUsage.DYNAMIC_DRAW),this._currentVerticeBuffer):(this.createOnlyOnceAndUpdateArrayBuffer("_currentNormalBuffer",data,size,wd.EBufferType.FLOAT,0,wd.EBufferUsage.DYNAMIC_DRAW),this._currentNormalBuffer)},MorphBufferContainer.prototype._getNextBufferWhichIsCreatedOnlyOnce=function(type,data,size){return type===wd.EBufferDataType.VERTICE?(this.createOnlyOnceAndUpdateArrayBuffer("_nextVerticeBuffer",data,size,wd.EBufferType.FLOAT,0,wd.EBufferUsage.DYNAMIC_DRAW),this._nextVerticeBuffer):(this.createOnlyOnceAndUpdateArrayBuffer("_nextNormalBuffer",data,size,wd.EBufferType.FLOAT,0,wd.EBufferUsage.DYNAMIC_DRAW),this._nextNormalBuffer)},MorphBufferContainer.prototype._isCacheNotChange=function(type){return!this._isCacheChangeFlag[type]},MorphBufferContainer.prototype._isNotPlayAnimation=function(){return null===this._animation.currentAnimName},MorphBufferContainer.prototype._getStaticData=function(type){var data=null,result=null;switch(type){case wd.EBufferDataType.VERTICE:data=this.geometryData.vertices;break;case wd.EBufferDataType.NORMAL:data=this.geometryData.normals;break;default:wd.Log.error(!0,wd.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))}return this.hasData(data)?(this._animation.interpolation=0,result=[this._getCurrentBufferWhichIsCreatedOnlyOnce(type,data,3),this._getNextBufferWhichIsCreatedOnlyOnce(type,data,3)]):null},MorphBufferContainer.prototype._getStaticDataCacheData=function(type){return"static_"+type},__decorate([wd.require(function(type){wd.assert(this.geometryData.morphTargets&&this.geometryData.morphTargets.getCount()>0,wd.Log.info.FUNC_SHOULD("set morphTargets"))})],MorphBufferContainer.prototype,"getVertice",null),__decorate([wd.require(function(type){wd.assert(this.geometryData.morphTargets&&this.geometryData.morphTargets.getCount()>0,wd.Log.info.FUNC_SHOULD("set morphTargets"))})],MorphBufferContainer.prototype,"getNormal",null),__decorate([wd.ensure(function(frames){wdCb.Log.error(!frames,wdCb.Log.info.FUNC_SHOULD('"'+this._animation.currentAnimName+'" animation',"contain frame data"))})],MorphBufferContainer.prototype,"_getFrames",null),__decorate([wd.require(function(type,data,size){wd.assert(type===wd.EBufferDataType.VERTICE||type===wd.EBufferDataType.NORMAL,wd.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))})],MorphBufferContainer.prototype,"_getCurrentBufferWhichIsCreatedOnlyOnce",null),__decorate([wd.require(function(type,data,size){wd.assert(type===wd.EBufferDataType.VERTICE||type===wd.EBufferDataType.NORMAL,wd.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))})],MorphBufferContainer.prototype,"_getNextBufferWhichIsCreatedOnlyOnce",null),__decorate([wd.cache(function(type){return this.container.hasChild(this._getStaticDataCacheData(type))},function(type){return this.container.getChild(this._getStaticDataCacheData(type))},function(result,type){this.container.addChild(this._getStaticDataCacheData(type),result)})],MorphBufferContainer.prototype,"_getStaticData",null),MorphBufferContainer}(wd.BufferContainer);wd.MorphBufferContainer=MorphBufferContainer}(wd||(wd={}));var wd;!function(wd){var BitmapFontBufferContainer=function(_super){function BitmapFontBufferContainer(){_super.apply(this,arguments),this._pageBuffer=null}return __extends(BitmapFontBufferContainer,_super),BitmapFontBufferContainer.create=function(entityObject){var obj=new this(entityObject);return obj},BitmapFontBufferContainer.prototype.createBuffersFromGeometryData=function(){_super.prototype.createBuffersFromGeometryData.call(this),this.getChild(wd.EBufferDataType.CUSTOM,"page")},BitmapFontBufferContainer.prototype.getBufferForRenderSort=function(){var buffer=this.getChild(wd.EBufferDataType.VERTICE);return buffer?buffer:null},BitmapFontBufferContainer.prototype.getCustomData=function(dataName){var geometryData=this.geometryData[dataName];return this.hasData(geometryData)?(this.createOnlyOnceAndUpdateArrayBuffer("_pageBuffer",geometryData,1),this._pageBuffer):null},__decorate([wd.cache(function(dataName){return this.container.hasChild(dataName)},function(dataName){return this.container.getChild(dataName)},function(result,dataName){this.container.addChild(dataName,result)})],BitmapFontBufferContainer.prototype,"getCustomData",null),BitmapFontBufferContainer}(wd.CommonBufferContainer);wd.BitmapFontBufferContainer=BitmapFontBufferContainer}(wd||(wd={}));var wd;!function(wd){var Camera=function(){function Camera(){this._worldToCameraMatrix=null,this._near=null,this._far=null,this.pMatrix=wd.Matrix4.create(),this.entityObject=null,this.dirty=!1}return Object.defineProperty(Camera.prototype,"cameraToWorldMatrix",{get:function(){return this.entityObject.transform.localToWorldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(Camera.prototype,"worldToCameraMatrix",{get:function(){return this._worldToCameraMatrix?this._worldToCameraMatrix:this.cameraToWorldMatrix.clone().invert()},set:function(matrix){this._worldToCameraMatrix=matrix},enumerable:!0,configurable:!0}),Object.defineProperty(Camera.prototype,"near",{get:function(){return this._near},set:function(near){this._near=near,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(Camera.prototype,"far",{get:function(){return this._far},set:function(far){this._far=far,this.dirty=!0},enumerable:!0,configurable:!0}),Camera.prototype.init=function(){this.dirty&&(this.updateProjectionMatrix(),this.dirty=!1)},Camera.prototype.dispose=function(){},Camera.prototype.clone=function(){return wd.CloneUtils.clone(this)},Camera.prototype.update=function(elapsed){this.dirty&&(this.updateProjectionMatrix(),this.dirty=!1)},Camera.prototype.getInvViewProjMat=function(){return this.pMatrix.clone().multiply(this.worldToCameraMatrix).invert()},__decorate([wd.requireGetter(function(){wd.assert(this.entityObject,wd.Log.info.FUNC_MUST_DEFINE("entityObject"))})],Camera.prototype,"cameraToWorldMatrix",null),__decorate([wd.cloneAttributeAsBasicType()],Camera.prototype,"near",null),__decorate([wd.cloneAttributeAsBasicType()],Camera.prototype,"far",null),__decorate([wd.cloneAttributeAsCloneable()],Camera.prototype,"pMatrix",void 0),__decorate([wd.virtual],Camera.prototype,"init",null),__decorate([wd.virtual],Camera.prototype,"dispose",null),Camera}();wd.Camera=Camera}(wd||(wd={}));var wd;!function(wd){var OrthographicCamera=function(_super){function OrthographicCamera(){_super.apply(this,arguments),this._left=null,this._right=null,this._bottom=null,this._top=null}return __extends(OrthographicCamera,_super),OrthographicCamera.create=function(){var obj=new this;return obj},Object.defineProperty(OrthographicCamera.prototype,"left",{get:function(){return this._left},set:function(left){this._left=left,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(OrthographicCamera.prototype,"right",{get:function(){return this._right},set:function(right){this._right=right,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(OrthographicCamera.prototype,"bottom",{get:function(){return this._bottom},set:function(bottom){this._bottom=bottom,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(OrthographicCamera.prototype,"top",{get:function(){return this._top},set:function(top){this._top=top,this.dirty=!0},enumerable:!0,configurable:!0}),OrthographicCamera.prototype.convertScreenToWorld=function(screenX,screenY,distanceFromCamera){var device=wd.DeviceManager.getInstance(),width=device.view.width,height=device.view.height,normalizedDeviceCoordinate=wd.Vector3.create(2*screenX/width-1,(height-screenY)/height*2-1,(distanceFromCamera-this.far)/(this.far-this.near)*2+1);return this.getInvViewProjMat().multiplyPoint(normalizedDeviceCoordinate)},OrthographicCamera.prototype.updateProjectionMatrix=function(){this.pMatrix.setOrtho(this._left,this._right,this._bottom,this._top,this.near,this.far)},__decorate([wd.cloneAttributeAsBasicType()],OrthographicCamera.prototype,"left",null),__decorate([wd.cloneAttributeAsBasicType()],OrthographicCamera.prototype,"right",null),__decorate([wd.cloneAttributeAsBasicType()],OrthographicCamera.prototype,"bottom",null),__decorate([wd.cloneAttributeAsBasicType()],OrthographicCamera.prototype,"top",null),OrthographicCamera}(wd.Camera);wd.OrthographicCamera=OrthographicCamera}(wd||(wd={}));var wd;!function(wd){var PerspectiveCamera=function(_super){function PerspectiveCamera(){_super.apply(this,arguments),this._fovy=null,this._aspect=null}return __extends(PerspectiveCamera,_super),PerspectiveCamera.create=function(){var obj=new this;return obj},Object.defineProperty(PerspectiveCamera.prototype,"fovy",{get:function(){return this._fovy},set:function(fovy){this._fovy=fovy,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(PerspectiveCamera.prototype,"aspect",{get:function(){return this._aspect},set:function(aspect){this._aspect=aspect,this.dirty=!0},enumerable:!0,configurable:!0}),PerspectiveCamera.prototype.zoomIn=function(speed,min){void 0===min&&(min=1),this.fovy=Math.max(this.fovy-speed,min)},PerspectiveCamera.prototype.zoomOut=function(speed,max){void 0===max&&(max=179),this.fovy=Math.min(this.fovy+speed,max)},PerspectiveCamera.prototype.convertScreenToWorld=function(screenX,screenY,distanceFromCamera){var device=wd.DeviceManager.getInstance(),width=device.view.width,height=device.view.height,normalizedDeviceCoordinate=wd.Vector3.create(2*screenX/width-1,1-2*screenY/height,1),invViewProjMat=this.getInvViewProjMat(),point=null,w=null;return point=invViewProjMat.multiplyPoint(normalizedDeviceCoordinate),w=normalizedDeviceCoordinate.x*invViewProjMat.values[3]+normalizedDeviceCoordinate.y*invViewProjMat.values[7]+normalizedDeviceCoordinate.z*invViewProjMat.values[11]+invViewProjMat.values[15],point.scale(1/w),wd.Vector3.create().lerp(this.entityObject.transform.position,point,distanceFromCamera/this.far)},PerspectiveCamera.prototype.updateProjectionMatrix=function(){this.pMatrix.setPerspective(this._fovy,this._aspect,this.near,this.far)},__decorate([wd.cloneAttributeAsBasicType()],PerspectiveCamera.prototype,"fovy",null),__decorate([wd.cloneAttributeAsBasicType()],PerspectiveCamera.prototype,"aspect",null),PerspectiveCamera}(wd.Camera);wd.PerspectiveCamera=PerspectiveCamera}(wd||(wd={}));var wd;!function(wd){var CameraController=function(_super){function CameraController(cameraComponent){_super.call(this),this.camera=null,this._worldToCameraMatrixCache=null,this._clearCacheSubscription=null,this.camera=cameraComponent}return __extends(CameraController,_super),Object.defineProperty(CameraController.prototype,"cameraToWorldMatrix",{get:function(){return this.camera.cameraToWorldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(CameraController.prototype,"worldToCameraMatrix",{get:function(){return this._getWorldToCameraMatrix()},set:function(matrix){this.camera.worldToCameraMatrix=matrix},enumerable:!0,configurable:!0}),Object.defineProperty(CameraController.prototype,"pMatrix",{get:function(){return this.camera.pMatrix},set:function(pMatrix){this.camera.pMatrix=pMatrix},enumerable:!0,configurable:!0}),CameraController.prototype.init=function(){this.camera.entityObject=this.entityObject,this.camera.init(),this.bindClearCacheEvent()},CameraController.prototype.update=function(elapsed){this.camera.update(elapsed)},CameraController.prototype.dispose=function(){this.camera.dispose(),this.disposeClearCacheEvent()},CameraController.prototype.clone=function(){return wd.CloneUtils.clone(this)},CameraController.prototype.isIntersectWithRay=function(entityObject,screenX,screenY){var shape=null;return!!entityObject.hasComponent(wd.Collider)&&(shape=entityObject.getComponent(wd.Collider).shape,shape.isIntersectWithRay(this.createRay(screenX,screenY)))},CameraController.prototype.createRay=function(screenX,screenY){var from=this.convertScreenToWorld(screenX,screenY,this.camera.near),to=this.convertScreenToWorld(screenX,screenY,this.camera.far);return wd.Ray.create(from,to.sub(from))},CameraController.prototype.convertScreenToWorld=function(screenX,screenY,distanceFromCamera){return this.camera.convertScreenToWorld(screenX,screenY,distanceFromCamera)},CameraController.prototype.getPlanes=function(){for(var frustumPlanes=[],transform=this.worldToCameraMatrix.applyMatrix(this.pMatrix,!0),index=0;index<6;index++)frustumPlanes.push(wd.Plane.create(0,0,0,0));return this._setPlanes(transform,frustumPlanes),frustumPlanes},CameraController.prototype.bindClearCacheEvent=function(){var self=this;this._clearCacheSubscription=wdFrp.fromArray([wd.EventManager.fromEvent(wd.EEngineEvent.ENDLOOP),wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.TRANSFORM_TRANSLATE),wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.TRANSFORM_ROTATE),wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.TRANSFORM_SCALE)]).mergeAll().subscribe(function(){self._clearCache()})},CameraController.prototype.disposeClearCacheEvent=function(){this._clearCacheSubscription&&this._clearCacheSubscription.dispose()},CameraController.prototype._setPlanes=function(transform,frustumPlanes){frustumPlanes[0].normal.x=transform.values[3]+transform.values[2],frustumPlanes[0].normal.y=transform.values[7]+transform.values[6],frustumPlanes[0].normal.z=transform.values[11]+transform.values[10],frustumPlanes[0].d=transform.values[15]+transform.values[14],frustumPlanes[0].normalize(),frustumPlanes[1].normal.x=transform.values[3]-transform.values[2],frustumPlanes[1].normal.y=transform.values[7]-transform.values[6],frustumPlanes[1].normal.z=transform.values[11]-transform.values[10],frustumPlanes[1].d=transform.values[15]-transform.values[14],frustumPlanes[1].normalize(),frustumPlanes[2].normal.x=transform.values[3]+transform.values[0],frustumPlanes[2].normal.y=transform.values[7]+transform.values[4],frustumPlanes[2].normal.z=transform.values[11]+transform.values[8],frustumPlanes[2].d=transform.values[15]+transform.values[12],frustumPlanes[2].normalize(),frustumPlanes[3].normal.x=transform.values[3]-transform.values[0],frustumPlanes[3].normal.y=transform.values[7]-transform.values[4],frustumPlanes[3].normal.z=transform.values[11]-transform.values[8],frustumPlanes[3].d=transform.values[15]-transform.values[12],frustumPlanes[3].normalize(),frustumPlanes[4].normal.x=transform.values[3]-transform.values[1],frustumPlanes[4].normal.y=transform.values[7]-transform.values[5],frustumPlanes[4].normal.z=transform.values[11]-transform.values[9],frustumPlanes[4].d=transform.values[15]-transform.values[13],frustumPlanes[4].normalize(),frustumPlanes[5].normal.x=transform.values[3]+transform.values[1],frustumPlanes[5].normal.y=transform.values[7]+transform.values[5],frustumPlanes[5].normal.z=transform.values[11]+transform.values[9],frustumPlanes[5].d=transform.values[15]+transform.values[13],frustumPlanes[5].normalize()},CameraController.prototype._clearCache=function(){this._worldToCameraMatrixCache=null},CameraController.prototype._getWorldToCameraMatrix=function(){return this.camera.worldToCameraMatrix},__decorate([wd.cacheGetter(function(){return null!==this._worldToCameraMatrixCache},function(){return this._worldToCameraMatrixCache},function(result){this._worldToCameraMatrixCache=result})],CameraController.prototype,"worldToCameraMatrix",null),__decorate([wd.cloneAttributeAsCloneable()],CameraController.prototype,"camera",void 0),__decorate([wd.virtual],CameraController.prototype,"bindClearCacheEvent",null),__decorate([wd.virtual],CameraController.prototype,"disposeClearCacheEvent",null),CameraController}(wd.Component);wd.CameraController=CameraController}(wd||(wd={}));var wd;!function(wd){var RenderTargetRendererCameraController=function(_super){function RenderTargetRendererCameraController(){_super.apply(this,arguments)}return __extends(RenderTargetRendererCameraController,_super),RenderTargetRendererCameraController.create=function(cameraComponent){var obj=new this(cameraComponent);return obj},RenderTargetRendererCameraController.prototype.bindClearCacheEvent=function(){},RenderTargetRendererCameraController.prototype.disposeClearCacheEvent=function(){},RenderTargetRendererCameraController}(wd.CameraController);wd.RenderTargetRendererCameraController=RenderTargetRendererCameraController}(wd||(wd={}));var wd;!function(wd){var BasicCameraController=function(_super){function BasicCameraController(){_super.apply(this,arguments)}return __extends(BasicCameraController,_super),BasicCameraController.create=function(cameraComponent){var obj=new this(cameraComponent);return obj},BasicCameraController}(wd.CameraController);wd.BasicCameraController=BasicCameraController}(wd||(wd={}));var wd;!function(wd){var FlyCameraController=function(_super){function FlyCameraController(cameraComponent){_super.call(this,cameraComponent),this._control=null,cameraComponent instanceof wd.PerspectiveCamera?this._control=wd.FlyPerspectiveCameraControl.create(cameraComponent):this._control=wd.FlyOrthographicCameraControl.create(cameraComponent)}return __extends(FlyCameraController,_super),FlyCameraController.create=function(cameraComponent){var obj=new this(cameraComponent);return obj},Object.defineProperty(FlyCameraController.prototype,"moveSpeed",{get:function(){return this._control.moveSpeed},set:function(speed){this._control.moveSpeed=speed},enumerable:!0,configurable:!0
}),Object.defineProperty(FlyCameraController.prototype,"rotateSpeed",{get:function(){return this._control.rotateSpeed},set:function(speed){this._control.rotateSpeed=speed},enumerable:!0,configurable:!0}),Object.defineProperty(FlyCameraController.prototype,"zoomSpeed",{get:function(){return this._control.zoomSpeed},set:function(speed){this._control.zoomSpeed=speed},enumerable:!0,configurable:!0}),FlyCameraController.prototype.init=function(){_super.prototype.init.call(this),this._control.init(this.entityObject)},FlyCameraController.prototype.update=function(elapsed){_super.prototype.update.call(this,elapsed),this._control.update(elapsed)},FlyCameraController.prototype.dispose=function(){_super.prototype.dispose.call(this),this._control.dispose()},__decorate([wd.cloneAttributeAsBasicType()],FlyCameraController.prototype,"moveSpeed",null),__decorate([wd.cloneAttributeAsBasicType()],FlyCameraController.prototype,"rotateSpeed",null),__decorate([wd.requireGetterAndSetter(function(){wd.assert(this._control instanceof wd.FlyPerspectiveCameraControl,wd.Log.info.FUNC_MUST_BE("FlyPerspectiveCameraControl"))},function(){wd.assert(this._control instanceof wd.FlyPerspectiveCameraControl,wd.Log.info.FUNC_MUST_BE("FlyPerspectiveCameraControl"))}),wd.cloneAttributeAsBasicType()],FlyCameraController.prototype,"zoomSpeed",null),FlyCameraController}(wd.CameraController);wd.FlyCameraController=FlyCameraController}(wd||(wd={}));var wd;!function(wd){var FlyCameraControl=function(){function FlyCameraControl(cameraComponent){this.moveSpeed=1.2,this.rotateSpeed=100,this.cameraComponent=null,this._rotateX=0,this._rotateY=0,this._isRotate=!1,this._mouseDragSubscription=null,this._keydownSubscription=null,this._gameObject=null,this.cameraComponent=cameraComponent}return FlyCameraControl.prototype.init=function(entityObject){var eulerAngles=entityObject.transform.eulerAngles;this._rotateX=eulerAngles.x,this._rotateY=eulerAngles.y,this._gameObject=entityObject,this._bindCanvasEvent()},FlyCameraControl.prototype.update=function(elapsed){this._isRotate&&(this._isRotate=!1,this._gameObject.transform.eulerAngles=wd.Vector3.create(this._rotateX,this._rotateY,0))},FlyCameraControl.prototype.dispose=function(){this._removeEvent()},FlyCameraControl.prototype._move=function(event){var speed=this.moveSpeed,entityObject=this._gameObject,keyState=event.keyState;keyState.a||keyState.left?entityObject.transform.translateLocal(wd.Vector3.create(-speed,0,0)):keyState.d||keyState.right?entityObject.transform.translateLocal(wd.Vector3.create(speed,0,0)):keyState.w||keyState.up?entityObject.transform.translateLocal(wd.Vector3.create(0,0,-speed)):(keyState.s||keyState.down)&&entityObject.transform.translateLocal(wd.Vector3.create(0,0,speed))},FlyCameraControl.prototype._bindCanvasEvent=function(){var self=this,rotateSpeed=this.rotateSpeed,mousedrag=wd.EventManager.fromEvent(wd.Director.getInstance().scene,wd.EEngineEvent.MOUSE_DRAG),keydown=wd.EventManager.fromEvent(wd.EEventName.KEYDOWN),canvas=wd.Director.getInstance().view;this._mouseDragSubscription=mousedrag.map(function(e){var movementDelta=e.userData.movementDelta,dx=null,dy=null,factor=rotateSpeed/canvas.height;return dx=factor*movementDelta.x,dy=factor*movementDelta.y,self._isRotate=!0,{dx:dx,dy:dy}}).subscribe(function(pos){self._rotateY-=pos.dx,self._rotateX-=pos.dy}),this._keydownSubscription=keydown.subscribe(function(e){self._move(e),self.zoom(e)})},FlyCameraControl.prototype._removeEvent=function(){this._mouseDragSubscription.dispose(),this._keydownSubscription.dispose()},FlyCameraControl}();wd.FlyCameraControl=FlyCameraControl}(wd||(wd={}));var wd;!function(wd){var FlyPerspectiveCameraControl=function(_super){function FlyPerspectiveCameraControl(){_super.apply(this,arguments),this.zoomSpeed=10}return __extends(FlyPerspectiveCameraControl,_super),FlyPerspectiveCameraControl.create=function(cameraComponent){var obj=new this(cameraComponent);return obj},FlyPerspectiveCameraControl.prototype.zoom=function(event){var speed=this.zoomSpeed,keyState=event.keyState;keyState.g?this.cameraComponent.zoomIn(speed):keyState.h&&this.cameraComponent.zoomOut(speed)},FlyPerspectiveCameraControl}(wd.FlyCameraControl);wd.FlyPerspectiveCameraControl=FlyPerspectiveCameraControl}(wd||(wd={}));var wd;!function(wd){var FlyOrthographicCameraControl=function(_super){function FlyOrthographicCameraControl(){_super.apply(this,arguments)}return __extends(FlyOrthographicCameraControl,_super),FlyOrthographicCameraControl.create=function(cameraComponent){var obj=new this(cameraComponent);return obj},FlyOrthographicCameraControl.prototype.zoom=function(event){},FlyOrthographicCameraControl}(wd.FlyCameraControl);wd.FlyOrthographicCameraControl=FlyOrthographicCameraControl}(wd||(wd={}));var wd;!function(wd){var ArcballCameraController=function(_super){function ArcballCameraController(){_super.apply(this,arguments),this._distance=10,this._minDistance=.05,this._phi=Math.PI/2,this._theta=Math.PI/2,this._thetaMargin=.05,this._target=wd.Vector3.create(0,0,0),this.moveSpeedX=1,this.moveSpeedY=1,this.rotateSpeed=1,this.wheelSpeed=1,this._isChange=!0,this._mouseDragSubscription=null,this._mouseWheelSubscription=null,this._keydownSubscription=null}return __extends(ArcballCameraController,_super),ArcballCameraController.create=function(cameraComponent){var obj=new this(cameraComponent);return obj},Object.defineProperty(ArcballCameraController.prototype,"distance",{get:function(){return this._distance},set:function(distance){this._distance!==distance&&this._changeDistance(distance)},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"minDistance",{get:function(){return this._minDistance},set:function(minDistance){this._minDistance=minDistance,minDistance>this._distance&&this._changeDistance(minDistance)},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"phi",{get:function(){return this._phi},set:function(phi){this._phi!==phi&&this._changePhi(phi)},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"theta",{get:function(){return this._theta},set:function(theta){this._theta!==theta&&this._changeTheta(theta)},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"thetaMargin",{get:function(){return this._thetaMargin},set:function(thetaMargin){this._thetaMargin!==thetaMargin&&(this._thetaMargin=thetaMargin,this._constrainTheta())},enumerable:!0,configurable:!0}),Object.defineProperty(ArcballCameraController.prototype,"target",{get:function(){return this._target},set:function(target){this._target.isEqual(target)||this._changeTarget(target)},enumerable:!0,configurable:!0}),ArcballCameraController.prototype.init=function(){_super.prototype.init.call(this),this._bindCanvasEvent()},ArcballCameraController.prototype.update=function(elapsed){var x=null,y=null,z=null;_super.prototype.update.call(this,elapsed),this._isChange&&(this._isChange=!1,x=this.distance*Math.cos(this.phi)*Math.sin(this.theta)+this.target.x,z=this.distance*Math.sin(this.phi)*Math.sin(this.theta)+this.target.z,y=this.distance*Math.cos(this.theta)+this.target.y,this.entityObject.transform.position=wd.Vector3.create(x,y,z),this.entityObject.transform.lookAt(this.target))},ArcballCameraController.prototype.dispose=function(){_super.prototype.dispose.call(this),this._removeEvent()},ArcballCameraController.prototype._bindCanvasEvent=function(){var self=this,scene=wd.Director.getInstance().scene,mousewheel=wd.EventManager.fromEvent(scene,wd.EEngineEvent.MOUSE_WHEEL),mousedrag=wd.EventManager.fromEvent(scene,wd.EEngineEvent.MOUSE_DRAG),keydown=wd.EventManager.fromEvent(wd.EEventName.KEYDOWN);this._mouseDragSubscription=mousedrag.subscribe(function(e){self._changeOrbit(e.userData)}),this._mouseWheelSubscription=mousewheel.subscribe(function(e){var mouseEvent=e.userData;mouseEvent.preventDefault(),self._changeDistance(mouseEvent)}),this._keydownSubscription=keydown.subscribe(function(e){self._changeTarget(e)})},ArcballCameraController.prototype._changeOrbit=function(e){var movementDelta=e.movementDelta;this._isChange=!0,this._changePhi(this._phi+movementDelta.x/(100/this.rotateSpeed)),this._changeTheta(this._theta-movementDelta.y/(100/this.rotateSpeed))},ArcballCameraController.prototype._changePhi=function(phi){this._isChange=!0,this._phi=phi},ArcballCameraController.prototype._changeTheta=function(theta){this._isChange=!0,this._theta=theta,this._constrainTheta()},ArcballCameraController.prototype._changeTarget=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(this._isChange=!0,args[0]instanceof wd.Vector3)this._target=args[0];else{var e=args[0],moveSpeedX=this.moveSpeedX,moveSpeedY=this.moveSpeedY,dx=null,dy=null,keyState=e.keyState,transform=this.entityObject.transform;keyState.a||keyState.left?dx=-moveSpeedX:keyState.d||keyState.right?dx=moveSpeedX:keyState.w||keyState.up?dy=moveSpeedY:(keyState.s||keyState.down)&&(dy=-moveSpeedY),this._target.add(wd.Vector3.create(transform.right.x*dx,0,transform.right.z*dx)),this._target.add(wd.Vector3.create(transform.up.x*dy,transform.up.y*dy,0))}},ArcballCameraController.prototype._changeDistance=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(this._isChange=!0,wd.JudgeUtils.isNumber(args[0]))this._distance=args[0];else{var e=args[0];this._distance-=this.wheelSpeed*e.wheel}this._constrainDistance()},ArcballCameraController.prototype._constrainDistance=function(){this.distance=wd.MathUtils.bigThan(this.distance,this.minDistance)},ArcballCameraController.prototype._constrainTheta=function(){this._theta=wd.MathUtils.clamp(this._theta,this._thetaMargin,Math.PI-this._thetaMargin)},ArcballCameraController.prototype._removeEvent=function(){this._mouseDragSubscription.dispose(),this._mouseWheelSubscription.dispose(),this._keydownSubscription.dispose()},__decorate([wd.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"distance",null),__decorate([wd.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"minDistance",null),__decorate([wd.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"phi",null),__decorate([wd.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"theta",null),__decorate([wd.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"thetaMargin",null),__decorate([wd.cloneAttributeAsCloneable()],ArcballCameraController.prototype,"target",null),__decorate([wd.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"moveSpeedX",void 0),__decorate([wd.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"moveSpeedY",void 0),__decorate([wd.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"rotateSpeed",void 0),__decorate([wd.cloneAttributeAsBasicType()],ArcballCameraController.prototype,"wheelSpeed",void 0),__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.expect(args[0]instanceof wd.KeyboardEvent||args[0]instanceof wd.Vector3).true})],ArcballCameraController.prototype,"_changeTarget",null),__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.expect(wd.JudgeUtils.isNumber(args[0])||args[0]instanceof wd.MouseEvent).true})],ArcballCameraController.prototype,"_changeDistance",null),ArcballCameraController}(wd.CameraController);wd.ArcballCameraController=ArcballCameraController}(wd||(wd={}));var wd;!function(wd){var Action=function(_super){function Action(){_super.apply(this,arguments),this.p_target=null,this.isFinish=!1}return __extends(Action,_super),Object.defineProperty(Action.prototype,"isStart",{get:function(){return!this.isStop},enumerable:!0,configurable:!0}),Object.defineProperty(Action.prototype,"isStop",{get:function(){return wd.Log.error(!0,wd.Log.info.ABSTRACT_ATTRIBUTE)},enumerable:!0,configurable:!0}),Object.defineProperty(Action.prototype,"isPause",{get:function(){return wd.Log.error(!0,wd.Log.info.ABSTRACT_ATTRIBUTE)},enumerable:!0,configurable:!0}),Object.defineProperty(Action.prototype,"target",{get:function(){return this.p_target},set:function(target){this.p_target=target},enumerable:!0,configurable:!0}),Action.prototype.clone=function(){return wd.CloneUtils.clone(this)},Action.prototype.reset=function(){this.isFinish=!1},Action.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1);var engine=wd.ActionEngine.getInstance();_super.prototype.addToObject.call(this,entityObject,isShareComponent),this.target=entityObject,engine.hasChild(this)||engine.addChild(this)},Action.prototype.removeFromObject=function(entityObject){_super.prototype.removeFromObject.call(this,entityObject),wd.ActionEngine.getInstance().removeChild(this)},Action.prototype.init=function(){this.start()},Action.prototype.finish=function(){this.isFinish=!0,this.stop()},Action}(wd.Component);wd.Action=Action}(wd||(wd={}));var wd;!function(wd){var ActionInstant=function(_super){function ActionInstant(){_super.apply(this,arguments)}return __extends(ActionInstant,_super),Object.defineProperty(ActionInstant.prototype,"isStop",{get:function(){return!1},enumerable:!0,configurable:!0}),Object.defineProperty(ActionInstant.prototype,"isPause",{get:function(){return!1},enumerable:!0,configurable:!0}),ActionInstant.prototype.start=function(){},ActionInstant.prototype.stop=function(){},ActionInstant.prototype.pause=function(){},ActionInstant.prototype.resume=function(){},ActionInstant}(wd.Action);wd.ActionInstant=ActionInstant}(wd||(wd={}));var wd;!function(wd){var CallFunc=function(_super){function CallFunc(func,context,dataArr){_super.call(this),this._context=null,this._callFunc=null,this._dataArr=null,this._context=context||wd.root,this._callFunc=func,this._dataArr=wdCb.Collection.create(dataArr)}return __extends(CallFunc,_super),CallFunc.create=function(func,context){for(var data=[],_i=2;_i<arguments.length;_i++)data[_i-2]=arguments[_i];var dataArr=Array.prototype.slice.call(arguments,2),action=new this(func,context,dataArr);return action},CallFunc.prototype.clone=function(){return wd.CloneUtils.clone(this,null,[this._callFunc,this._context,this._dataArr.clone(!0).toArray()])},CallFunc.prototype.reverse=function(){return this},CallFunc.prototype.update=function(elapsed){this._callFunc&&this._callFunc.call(this._context,this.p_target,this._dataArr),this.finish()},CallFunc}(wd.ActionInstant);wd.CallFunc=CallFunc}(wd||(wd={}));var wd;!function(wd){var ActionInterval=function(_super){function ActionInterval(){_super.apply(this,arguments),this.elapsed=null,this.duration=null,this._isStop=!0,this._isPause=!1,this._timeController=wd.CommonTimeController.create()}return __extends(ActionInterval,_super),Object.defineProperty(ActionInterval.prototype,"isStop",{get:function(){return this._isStop},enumerable:!0,configurable:!0}),Object.defineProperty(ActionInterval.prototype,"isPause",{get:function(){return this._isPause},enumerable:!0,configurable:!0}),ActionInterval.prototype.update=function(elapsed){elapsed<this._timeController.startTime||(this.elapsed=this._convertToRatio(this._timeController.computeElapseTime(elapsed)),this.updateBody(elapsed),1===this.elapsed&&this.finish())},ActionInterval.prototype.start=function(){this._isStop=!1,this._timeController.start()},ActionInterval.prototype.stop=function(){this._isStop=!0,this._timeController.stop()},ActionInterval.prototype.reset=function(){_super.prototype.reset.call(this),this._isStop=!0},ActionInterval.prototype.pause=function(){this._isPause=!0,this._timeController.pause()},ActionInterval.prototype.resume=function(){this._isPause=!1,this._timeController.resume()},ActionInterval.prototype.updateBody=function(time){},ActionInterval.prototype._convertToRatio=function(elapsed){var ratio=elapsed/this.duration;return ratio>1?1:ratio},__decorate([wd.virtual],ActionInterval.prototype,"updateBody",null),ActionInterval}(wd.Action);wd.ActionInterval=ActionInterval}(wd||(wd={}));var wd;!function(wd){var Control=function(_super){function Control(){_super.apply(this,arguments)}return __extends(Control,_super),Object.defineProperty(Control.prototype,"target",{set:function(target){this.p_target=target,this.getInnerActions().forEach(function(action){action.target=target})},enumerable:!0,configurable:!0}),Control.prototype.init=function(){_super.prototype.init.call(this),this.iterate("init")},Control.prototype.reverse=function(){return this.iterate("reverse"),this},Control.prototype.reset=function(){return _super.prototype.reset.call(this),this.iterate("reset"),this},Control.prototype.iterate=function(method,argArr){this.getInnerActions().forEach(function(action){action[method].apply(action,argArr)})},Control}(wd.ActionInterval);wd.Control=Control}(wd||(wd={}));var wd;!function(wd){var Sequence=function(_super){function Sequence(actionArr){_super.call(this),this._actions=wdCb.Collection.create(),this._currentAction=null,this._actionIndex=0,this._actions.addChildren(actionArr)}return __extends(Sequence,_super),Sequence.create=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var sequence=new this(args);return sequence.initWhenCreate(),sequence},Sequence.prototype.initWhenCreate=function(){this._currentAction=this._actions.getChild(0)},Sequence.prototype.clone=function(){return wd.CloneUtils.clone(this,null,this._actions.clone(!0).toArray())},Sequence.prototype.update=function(elapsed){return this._actionIndex===this._actions.getCount()?void this.finish():(this._currentAction=this._actions.getChild(this._actionIndex),this._currentAction.isFinish?void this._startNextActionAndJudgeFinish():(this._currentAction.update(elapsed),this._currentAction.isFinish&&this._startNextActionAndJudgeFinish(),null))},Sequence.prototype.reset=function(){return _super.prototype.reset.call(this),this._actionIndex=0,this._currentAction=this._actions.getChild(this._actionIndex),this},Sequence.prototype.start=function(){return _super.prototype.start.call(this),this._currentAction.start(),this},Sequence.prototype.stop=function(){return _super.prototype.stop.call(this),this._currentAction.stop(),this},Sequence.prototype.pause=function(){return _super.prototype.pause.call(this),this._currentAction.pause(),this},Sequence.prototype.resume=function(){return _super.prototype.resume.call(this),this._currentAction.resume(),this},Sequence.prototype.reverse=function(){return this._actions=this._actions.reverse(),_super.prototype.reverse.call(this),this},Sequence.prototype.getInnerActions=function(){return this._actions},Sequence.prototype._startNextActionAndJudgeFinish=function(){return this._actionIndex++,this._actionIndex===this._actions.getCount()?void this.finish():void this._actions.getChild(this._actionIndex).start()},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.it("action's count should > 1",function(){wd.expect(args.length).to.greaterThan(1)})})],Sequence,"create",null),Sequence}(wd.Control);wd.Sequence=Sequence}(wd||(wd={}));var wd;!function(wd){var Spawn=function(_super){function Spawn(actionArr){_super.call(this),this._actions=wdCb.Collection.create(),this._actions.addChildren(actionArr)}return __extends(Spawn,_super),Spawn.create=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var spawn=null;return spawn=new this(args)},Spawn.prototype.clone=function(){return wd.CloneUtils.clone(this,null,this._actions.clone(!0).toArray())},Spawn.prototype.update=function(elapsed){return this._isFinish()?void this.finish():(this.iterate("update",[elapsed]),void(this._isFinish()&&this.finish()))},Spawn.prototype.start=function(){return _super.prototype.start.call(this),this.iterate("start"),this},Spawn.prototype.stop=function(){return _super.prototype.stop.call(this),this.iterate("stop"),this},Spawn.prototype.pause=function(){return _super.prototype.pause.call(this),this.iterate("pause"),this},Spawn.prototype.resume=function(){return _super.prototype.resume.call(this),this.iterate("resume"),this},Spawn.prototype.reset=function(){return _super.prototype.reset.call(this),this.iterate("reset"),this},Spawn.prototype.reverse=function(){return this._actions=this._actions.reverse(),_super.prototype.reverse.call(this),this},Spawn.prototype.getInnerActions=function(){return this._actions},Spawn.prototype.iterate=function(method,argArr){this._actions.forEach(function(action){action[method].apply(action,argArr)})},Spawn.prototype._isFinish=function(){var isFinish=!0;return this._actions.forEach(function(action){if(!action.isFinish)return isFinish=!1,wdCb.$BREAK}),isFinish},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.it("action's count should > 1",function(){wd.expect(args.length).to.greaterThan(1)})})],Spawn,"create",null),Spawn}(wd.Control);wd.Spawn=Spawn}(wd||(wd={}));var wd;!function(wd){var DelayTime=function(_super){function DelayTime(delayTime){_super.call(this),this.duration=delayTime}return __extends(DelayTime,_super),DelayTime.create=function(delayTime){var action=new this(delayTime);return action},DelayTime.prototype.clone=function(){return wd.CloneUtils.clone(this,null,[this.duration])},DelayTime.prototype.reverse=function(){return this},DelayTime}(wd.ActionInterval);wd.DelayTime=DelayTime}(wd||(wd={}));var wd;!function(wd){var Repeat=function(_super){function Repeat(action,times){_super.call(this),this._innerAction=null,this._originTimes=null,this._times=null,this._innerAction=action,this._times=times}return __extends(Repeat,_super),Repeat.create=function(action,times){var repeat=new this(action,times);return repeat.initWhenCreate(),repeat},Repeat.prototype.clone=function(){return wd.CloneUtils.clone(this,null,[this._innerAction.clone(),this._times])},Repeat.prototype.initWhenCreate=function(){this._originTimes=this._times},Repeat.prototype.update=function(elapsed){if(0===this._times)return void this.finish();if(this._innerAction.update(elapsed),this._innerAction.isFinish){if(this._times-=1,0!==this._times)return this._innerAction.reset(),void this._innerAction.start();this.finish()}},Repeat.prototype.reset=function(){return _super.prototype.reset.call(this),this._times=this._originTimes,this},Repeat.prototype.start=function(){_super.prototype.start.call(this),this._innerAction.start()},Repeat.prototype.stop=function(){_super.prototype.stop.call(this),this._innerAction.stop()},Repeat.prototype.pause=function(){_super.prototype.pause.call(this),this._innerAction.pause()},Repeat.prototype.resume=function(){_super.prototype.resume.call(this),this._innerAction.resume()},Repeat.prototype.getInnerActions=function(){return wdCb.Collection.create([this._innerAction])},Repeat}(wd.Control);wd.Repeat=Repeat}(wd||(wd={}));var wd;!function(wd){var RepeatForever=function(_super){function RepeatForever(action){_super.call(this),this._innerAction=null,this._innerAction=action}return __extends(RepeatForever,_super),RepeatForever.create=function(action){var repeat=new this(action);return repeat},RepeatForever.prototype.clone=function(){return wd.CloneUtils.clone(this,null,[this._innerAction.clone()])},RepeatForever.prototype.update=function(elapsed){this._innerAction.update(elapsed),this._innerAction.isFinish&&(this._innerAction.reset(),this._innerAction.start())},RepeatForever.prototype.start=function(){_super.prototype.start.call(this),this._innerAction.start()},RepeatForever.prototype.stop=function(){_super.prototype.stop.call(this),this._innerAction.stop()},RepeatForever.prototype.pause=function(){_super.prototype.pause.call(this),this._innerAction.pause()},RepeatForever.prototype.resume=function(){_super.prototype.resume.call(this),this._innerAction.resume()},RepeatForever.prototype.getInnerActions=function(){return wdCb.Collection.create([this._innerAction])},RepeatForever}(wd.Control);wd.RepeatForever=RepeatForever}(wd||(wd={}));var wd;!function(wd){var Tween=function(_super){function Tween(){_super.apply(this,arguments),this._object=null,this._valuesStart=wdCb.Hash.create(),this._valuesEnd=wdCb.Hash.create(),this._easingFunction=Tween.Easing.Linear.None,this._interpolationFunction=Tween.Interpolation.Linear,this._onStartCallback=null,this._onStartCallbackFired=!1,this._onUpdateCallback=null,this._onFinishCallback=null,this._onStopCallback=null}return __extends(Tween,_super),Tween.create=function(){var obj=new this;return obj},Tween.prototype.updateBody=function(time){var self=this,easeValue=null;return this._onStartCallbackFired===!1&&(null!==this._onStartCallback&&this._onStartCallback.call(this._object.getChildren()),this._onStartCallbackFired=!0),easeValue=this._easingFunction(this.elapsed),this._valuesEnd.forEach(function(value,key){var start=self._valuesStart.getChild(key),end=value;end instanceof Array?self._object.setValue(key,self._interpolationFunction(end,easeValue)):(wd.JudgeUtils.isString(end)&&(end=start+wd.root.parseFloat(end,10)),wd.JudgeUtils.isNumber(end)&&self._object.setValue(key,start+(end-start)*easeValue))}),null!==this._onUpdateCallback&&this._onUpdateCallback.call(this._object.getChildren(),easeValue),!0},Tween.prototype.from=function(object){var self=this;return this._object=wdCb.Hash.create(object),this._object.forEach(function(value,key){self._valuesStart.addChild(key,wd.root.parseFloat(value,10))}),this},Tween.prototype.to=function(properties,duration){return void 0===duration&&(duration=1e3),this.duration=duration,this._valuesEnd=wdCb.Hash.create(properties),this},Tween.prototype.init=function(){var self=this;_super.prototype.init.call(this),this._valuesEnd.forEach(function(value,key){if(value instanceof Array){if(0===value.length)return;self._valuesEnd.setValue(key,[self._object.getChild(key)].concat(self._valuesEnd.getChild(key)))}self._valuesStart.setValue(key,self._object.getChild(key)),self._valuesStart.getChild(key)instanceof Array==!1&&self._valuesStart.setValue(key,1*self._valuesStart.getChild(key))})},Tween.prototype.start=function(){return _super.prototype.start.call(this),this._onStartCallbackFired=!1,this},Tween.prototype.stop=function(){return _super.prototype.stop.call(this),null!==this._onStopCallback&&this._onStopCallback.call(this._object.getChildren()),this},Tween.prototype.reverse=function(){var tmp=this._valuesStart;this._valuesStart=this._valuesEnd,this._valuesEnd=tmp},Tween.prototype.easing=function(easing){return this._easingFunction=easing,this},Tween.prototype.interpolation=function(interpolation){return this._interpolationFunction=interpolation,this},Tween.prototype.onUpdate=function(callback){return this._onUpdateCallback=callback,this},Tween.prototype.onFinish=function(callback){return this._onFinishCallback=callback,this},Tween.prototype.onStart=function(callback){return this._onStartCallback=callback,this},Tween.prototype.onStop=function(callback){return this._onStopCallback=callback,this},Tween.prototype.finish=function(){_super.prototype.finish.call(this),null!==this._onFinishCallback&&this._onFinishCallback.call(this._object.getChildren())},Tween.Easing={Linear:{None:function(k){return k}},Quadratic:{In:function(k){return k*k},Out:function(k){return k*(2-k)},InOut:function(k){return(k*=2)<1?.5*k*k:-.5*(--k*(k-2)-1)}},Cubic:{In:function(k){return k*k*k},Out:function(k){return--k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k:.5*((k-=2)*k*k+2)}},Quartic:{In:function(k){return k*k*k*k},Out:function(k){return 1- --k*k*k*k},InOut:function(k){return(k*=2)<1?.5*k*k*k*k:-.5*((k-=2)*k*k*k-2)}},Quintic:{In:function(k){return k*k*k*k*k},Out:function(k){return--k*k*k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k*k*k:.5*((k-=2)*k*k*k*k+2)}},Sinusoidal:{In:function(k){return 1-Math.cos(k*Math.PI/2)},Out:function(k){return Math.sin(k*Math.PI/2)},InOut:function(k){return.5*(1-Math.cos(Math.PI*k))}},Exponential:{In:function(k){return 0===k?0:Math.pow(1024,k-1)},Out:function(k){return 1===k?1:1-Math.pow(2,-10*k)},InOut:function(k){return 0===k?0:1===k?1:(k*=2)<1?.5*Math.pow(1024,k-1):.5*(-Math.pow(2,-10*(k-1))+2)}},Circular:{In:function(k){return 1-Math.sqrt(1-k*k)},Out:function(k){return Math.sqrt(1- --k*k)},InOut:function(k){return(k*=2)<1?-.5*(Math.sqrt(1-k*k)-1):.5*(Math.sqrt(1-(k-=2)*k)+1)}},Elastic:{In:function(k){var s,a=.1,p=.4;return 0===k?0:1===k?1:(!a||a<1?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),-(a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p)))},Out:function(k){var s,a=.1,p=.4;return 0===k?0:1===k?1:(!a||a<1?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),a*Math.pow(2,-10*k)*Math.sin((k-s)*(2*Math.PI)/p)+1)},InOut:function(k){var s,a=.1,p=.4;return 0===k?0:1===k?1:(!a||a<1?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),(k*=2)<1?-.5*(a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p)):a*Math.pow(2,-10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p)*.5+1)}},Back:{In:function(k){var s=1.70158;return k*k*((s+1)*k-s)},Out:function(k){var s=1.70158;return--k*k*((s+1)*k+s)+1},InOut:function(k){var s=2.5949095;return(k*=2)<1?.5*(k*k*((s+1)*k-s)):.5*((k-=2)*k*((s+1)*k+s)+2)}},Bounce:{In:function(k){return 1-Tween.Easing.Bounce.Out(1-k)},Out:function(k){return k<1/2.75?7.5625*k*k:k<2/2.75?7.5625*(k-=1.5/2.75)*k+.75:k<2.5/2.75?7.5625*(k-=2.25/2.75)*k+.9375:7.5625*(k-=2.625/2.75)*k+.984375},InOut:function(k){return k<.5?.5*Tween.Easing.Bounce.In(2*k):.5*Tween.Easing.Bounce.Out(2*k-1)+.5}}},Tween.Interpolation={Linear:function(v,k){var m=v.length-1,f=m*k,i=Math.floor(f),fn=Tween.Interpolation.Utils.Linear;return k<0?fn(v[0],v[1],f):k>1?fn(v[m],v[m-1],m-f):fn(v[i],v[i+1>m?m:i+1],f-i)},Bezier:function(v,k){var i,b=0,n=v.length-1,bn=Tween.Interpolation.Utils.Bernstein;for(i=0;i<=n;i++)b+=Math.pow(1-k,n-i)*Math.pow(k,i)*v[i]*bn(n,i);return b},CatmullRom:function(v,k){var m=v.length-1,f=m*k,i=Math.floor(f),fn=Tween.Interpolation.Utils.CatmullRom;return v[0]===v[m]?(k<0&&(i=Math.floor(f=m*(1+k))),fn(v[(i-1+m)%m],v[i],v[(i+1)%m],v[(i+2)%m],f-i)):k<0?v[0]-(fn(v[0],v[0],v[1],v[1],-f)-v[0]):k>1?v[m]-(fn(v[m],v[m],v[m-1],v[m-1],f-m)-v[m]):fn(v[i?i-1:0],v[i],v[m<i+1?m:i+1],v[m<i+2?m:i+2],f-i)},Utils:{Linear:function(p0,p1,t){return(p1-p0)*t+p0},Bernstein:function(n,i){var fc=Tween.Interpolation.Utils.Factorial;return fc(n)/fc(i)/fc(n-i)},Factorial:function(){var a=[1];return function(n){var i,s=1;if(a[n])return a[n];for(i=n;i>1;i--)s*=i;return a[n]=s}}(),CatmullRom:function(p0,p1,p2,p3,t){var v0=.5*(p2-p0),v1=.5*(p3-p1),t2=t*t,t3=t*t2;return(2*p1-2*p2+v0+v1)*t3+(-3*p1+3*p2-2*v0-v1)*t2+v0*t+p1}}},__decorate([wd.cloneAttributeAsBasicType()],Tween.prototype,"duration",void 0),__decorate([wd.cloneAttributeAsCloneable()],Tween.prototype,"_valuesStart",void 0),__decorate([wd.cloneAttributeAsCloneable()],Tween.prototype,"_valuesEnd",void 0),__decorate([wd.cloneAttributeAsBasicType()],Tween.prototype,"_easingFunction",void 0),__decorate([wd.cloneAttributeAsBasicType()],Tween.prototype,"_interpolationFunction",void 0),__decorate([wd.cloneAttributeAsBasicType()],Tween.prototype,"_onStartCallback",void 0),__decorate([wd.cloneAttributeAsBasicType()],Tween.prototype,"_onStartCallbackFired",void 0),__decorate([wd.cloneAttributeAsBasicType()],Tween.prototype,"_onUpdateCallback",void 0),__decorate([wd.cloneAttributeAsBasicType()],Tween.prototype,"_onFinishCallback",void 0),__decorate([wd.cloneAttributeAsBasicType()],Tween.prototype,"_onStopCallback",void 0),Tween}(wd.ActionInterval);wd.Tween=Tween}(wd||(wd={}));var wd;!function(wd){var RendererComponent=function(_super){function RendererComponent(){_super.apply(this,arguments)}return __extends(RendererComponent,_super),RendererComponent}(wd.Component);wd.RendererComponent=RendererComponent}(wd||(wd={}));var wd;!function(wd){var MeshRenderer=function(_super){function MeshRenderer(){_super.apply(this,arguments)}return __extends(MeshRenderer,_super),MeshRenderer.create=function(){var obj=new this;return obj},MeshRenderer.prototype.render=function(renderer,geometry,camera){renderer.addCommand(this.createDrawCommand(geometry,camera))},MeshRenderer.prototype.createDrawCommand=function(geometry,camera){
var cmd=null,cameraComponent=camera.getComponent(wd.CameraController),material=geometry.material,position=this.entityObject.transform.position,target=geometry.entityObject;return cmd=this._createCommand(target,material),cmd.target=target,cmd.buffers=geometry.buffers,cmd.vaoManager=geometry.vaoManager,cmd.drawMode=geometry.drawMode,cmd.vMatrix=cameraComponent.worldToCameraMatrix,cmd.pMatrix=cameraComponent.pMatrix,cmd.material=material,cmd.z=position.z,cmd.blend=material.blend,cmd},MeshRenderer.prototype._createCommand=function(target,material){var cmd=null,glslData=null,_a=material.shader.getInstanceState(),isModelMatrixInstance=_a.isModelMatrixInstance,isNormalMatrixInstance=_a.isNormalMatrixInstance,isHardwareInstance=_a.isHardwareInstance,isBatchInstance=_a.isBatchInstance;return glslData=this._getInstanceGLSLData(isModelMatrixInstance,isNormalMatrixInstance),isHardwareInstance?cmd=this._createHardwareInstanceCommand(target,material,glslData):isBatchInstance?cmd=this._createBatchInstanceCommand(target,material,glslData):(cmd=wd.SingleDrawCommand.create(),cmd.mMatrix=this.entityObject.transform.localToWorldMatrix,cmd.normalMatrix=this.entityObject.transform.normalMatrix),cmd},MeshRenderer.prototype._getInstanceGLSLData=function(isModelMatrixInstance,isNormalMatrixInstance){return isNormalMatrixInstance?wd.EInstanceGLSLData.NORMALMATRIX_MODELMATRIX:wd.EInstanceGLSLData.MODELMATRIX},MeshRenderer.prototype._createHardwareInstanceCommand=function(target,material,glslData){var instanceComponent=target.getComponent(wd.SourceInstance),cmd=wd.HardwareInstanceCommand.create();return cmd.instanceList=instanceComponent.toRenderInstanceListForDraw,cmd.instanceBuffer=instanceComponent.instanceBuffer,cmd.glslData=glslData,cmd},MeshRenderer.prototype._createBatchInstanceCommand=function(target,material,glslData){var instanceComponent=target.getComponent(wd.SourceInstance),cmd=wd.BatchInstanceCommand.create();return cmd.instanceList=instanceComponent.toRenderInstanceListForDraw,cmd.glslData=glslData,cmd},__decorate([wd.require(function(geometry,camera){var controller=camera.getComponent(wd.CameraController);wd.assert(!!controller&&!!controller.camera,wd.Log.info.FUNC_MUST("camera","add Camera Component")),wd.assert(!!geometry,wd.Log.info.FUNC_MUST("Mesh","add geometry component"))})],MeshRenderer.prototype,"createDrawCommand",null),__decorate([wd.require(function(target){wd.InstanceUtils.isInstance(target)&&wd.assert(wd.InstanceUtils.isSourceInstance(target),wd.Log.info.FUNC_SHOULD("if use instance to batch draw, target","be SourceInstance"))}),wd.ensure(function(cmd,target){cmd instanceof wd.HardwareInstanceCommand?wd.assert(wd.InstanceUtils.isHardwareSupport(),wd.Log.info.FUNC_SHOULD("hardware","support instance")):cmd instanceof wd.BatchInstanceCommand&&wd.assert(!wd.InstanceUtils.isHardwareSupport(),wd.Log.info.FUNC_SHOULD_NOT("hardware","support instance"))})],MeshRenderer.prototype,"_createCommand",null),MeshRenderer}(wd.RendererComponent);wd.MeshRenderer=MeshRenderer}(wd||(wd={}));var wd;!function(wd){var SkyboxRenderer=function(_super){function SkyboxRenderer(){_super.apply(this,arguments)}return __extends(SkyboxRenderer,_super),SkyboxRenderer.create=function(){var obj=new this;return obj},SkyboxRenderer.prototype.render=function(renderer,geometry,camera){renderer.skyboxCommand=this.createDrawCommand(geometry,camera)},SkyboxRenderer}(wd.MeshRenderer);wd.SkyboxRenderer=SkyboxRenderer}(wd||(wd={}));var wd;!function(wd){var UIRenderer=function(_super){function UIRenderer(){_super.apply(this,arguments),this._zIndex=1,this._dirty=!0,this.isClearCanvas=!1,this.state=wd.EUIRendererState.NORMAL,this.context=null,this.canvas=null,this._referenceList=wdCb.Collection.create()}return __extends(UIRenderer,_super),UIRenderer.create=function(){var obj=new this;return obj.initWhenCreate(),obj},Object.defineProperty(UIRenderer.prototype,"zIndex",{get:function(){return this._zIndex},set:function(zIndex){zIndex!==this._zIndex&&(this._zIndex=zIndex,this.canvas&&wdCb.DomQuery.create(this.canvas).css("zIndex",zIndex))},enumerable:!0,configurable:!0}),Object.defineProperty(UIRenderer.prototype,"dirty",{get:function(){return this._dirty},set:function(dirty){dirty?this._dirty=!0:this.resetDirty()},enumerable:!0,configurable:!0}),UIRenderer.prototype.resetDirty=function(){this._dirty=!1},UIRenderer.prototype.addToObject=function(object){this._referenceList.addChild(object),this.entityObject=object},UIRenderer.prototype.removeFromObject=function(object){this._referenceList.removeChild(object),this._referenceList.getCount()>0||_super.prototype.removeFromObject.call(this,object)},UIRenderer.prototype.init=function(){},UIRenderer.prototype.initWhenCreate=function(){this._createOverlayCanvas()},UIRenderer.prototype.dispose=function(){this._referenceList.getCount()>0||wdCb.DomQuery.create(this.canvas).remove()},UIRenderer.prototype.render=function(renderer,geometry,camera){},UIRenderer.prototype.clearCanvas=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.isClearCanvas=!0},UIRenderer.prototype._createOverlayCanvas=function(){var canvas=null,view=null;this.canvas||(canvas=wdCb.DomQuery.create("<canvas></canvas>").prependTo("body"),view=wd.DeviceManager.getInstance().view,canvas.css("position","absolute"),canvas.css("left",view.x+"px"),canvas.css("top",view.y+"px"),canvas.css("zIndex",this.zIndex),canvas.attr("width",view.width),canvas.attr("height",view.height),this.canvas=canvas.get(0),this.context=this.canvas.getContext("2d"))},__decorate([wd.cloneAttributeAsBasicType()],UIRenderer.prototype,"zIndex",null),__decorate([wd.execOnlyOnce("_isInit")],UIRenderer.prototype,"init",null),UIRenderer}(wd.RendererComponent);wd.UIRenderer=UIRenderer}(wd||(wd={}));var wd;!function(wd){!function(EUIRendererState){EUIRendererState[EUIRendererState.NORMAL=0]="NORMAL",EUIRendererState[EUIRendererState.DIRTY=1]="DIRTY",EUIRendererState[EUIRendererState.NOT_DIRTY=2]="NOT_DIRTY"}(wd.EUIRendererState||(wd.EUIRendererState={}));wd.EUIRendererState}(wd||(wd={}));var wd;!function(wd){var SpacePartition=function(_super){function SpacePartition(){_super.apply(this,arguments),this.isCollideEnable=!0}return __extends(SpacePartition,_super),__decorate([wd.cloneAttributeAsBasicType()],SpacePartition.prototype,"isCollideEnable",void 0),SpacePartition}(wd.Component);wd.SpacePartition=SpacePartition}(wd||(wd={}));var wd;!function(wd){var Octree=function(_super){function Octree(){_super.apply(this,arguments),this.maxDepth=2,this.maxNodeCapacity=64,this._root=null,this._selectionList=wdCb.Collection.create(),this._renderListCache=null}return __extends(Octree,_super),Octree.create=function(){var obj=new this;return obj},Octree.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1);var engine=wd.SpacePartitionEngine.getInstance();_super.prototype.addToObject.call(this,entityObject,isShareComponent),engine.hasChild(this)||engine.addChild(this)},Octree.prototype.removeFromObject=function(entityObject){_super.prototype.removeFromObject.call(this,entityObject),wd.SpacePartitionEngine.getInstance().removeChild(this)},Octree.prototype.init=function(){_super.prototype.init.call(this)},Octree.prototype.update=function(elapsed){this._renderListCache=this._getRenderListForCurrentLoop()},Octree.prototype.getRenderList=function(){return this._renderListCache},Octree.prototype.build=function(){var gameObjectList=this.getChildren(),currentDepth=0,maxNodeCapacity=this.maxNodeCapacity,maxDepth=this.maxDepth,buildTree=function(worldMin,worldMax,currentDepth,gameObjectList,parentNode){for(var halfExtends=new wd.Vector3((worldMax.x-worldMin.x)/2,(worldMax.y-worldMin.y)/2,(worldMax.z-worldMin.z)/2),x=0;x<2;x++)for(var y=0;y<2;y++)for(var z=0;z<2;z++){var localMin=worldMin.clone().add(halfExtends.clone().scale(x,y,z)),localMax=worldMin.clone().add(halfExtends.clone().scale(x+1,y+1,z+1)),node=wd.OctreeNode.create(localMin,localMax,maxNodeCapacity,currentDepth+1,maxDepth);node.addGameObjects(gameObjectList),node.gameObjectCount>maxNodeCapacity&&currentDepth<maxDepth&&buildTree(localMin,localMax,currentDepth+1,gameObjectList,node),parentNode.addNode(node)}};this._updateColliderForFirstCheck(gameObjectList);var _a=this._getWorldExtends(gameObjectList),worldMin=_a.worldMin,worldMax=_a.worldMax;this._root=wd.OctreeNode.create(worldMin,worldMax,maxNodeCapacity,currentDepth+1,maxDepth),buildTree(worldMin,worldMax,currentDepth,gameObjectList,this._root)},Octree.prototype.getRenderListByFrustumCull=function(){var currentCamera=wd.Director.getInstance().scene.currentCamera;return currentCamera?this._visitRoot("findAndAddToRenderList",[currentCamera.getComponent(wd.CameraController).getPlanes(),this._selectionList]):wdCb.Collection.create()},Octree.prototype.getIntersectListWithRay=function(e){var locationInView=e.locationInView;return this._visitRoot("findAndAddToIntersectList",[wd.Director.getInstance().scene.currentCamera.getComponent(wd.CameraController).createRay(locationInView.x,locationInView.y),this._selectionList])},Octree.prototype.getCollideObjects=function(shape){return this._visitRoot("findAndAddToCollideList",[shape,this._selectionList])},Octree.prototype.getChildren=function(){return this.entityObject.getChildren()},Octree.prototype._visitRoot=function(method,args){return this._selectionList.removeAllChildren(),this._root.nodeList.forEach(function(topNode){topNode[method].apply(topNode,args)}),this._selectionList=this._selectionList.removeRepeatItems(),this._selectionList},Octree.prototype._updateColliderForFirstCheck=function(gameObjectList){var collider=null,self=this;gameObjectList.forEach(function(gameObject){gameObject.hasComponent(wd.ColliderForFirstCheck)?collider=gameObject.getComponent(wd.BoxColliderForFirstCheck):(collider=self._createCollider(),gameObject.addComponent(collider),collider.init()),collider.update(null)})},Octree.prototype._getWorldExtends=function(gameObjectList){var worldMin=wd.Vector3.create(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),worldMax=wd.Vector3.create(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),self=this;return gameObjectList.forEach(function(gameObject){var min=null,max=null,collider=null,shape=null;collider=gameObject.getComponent(wd.BoxColliderForFirstCheck),shape=collider.shape,min=shape.getMin(),max=shape.getMax(),self._checkExtends(min,worldMin,worldMax),self._checkExtends(max,worldMin,worldMax)}),{worldMin:worldMin,worldMax:worldMax}},Octree.prototype._createCollider=function(){return wd.BoxColliderForFirstCheck.create()},Octree.prototype._checkExtends=function(v,min,max){v.x<min.x&&(min.x=v.x),v.y<min.y&&(min.y=v.y),v.z<min.z&&(min.z=v.z),v.x>max.x&&(max.x=v.x),v.y>max.y&&(max.y=v.y),v.z>max.z&&(max.z=v.z)},Octree.prototype._setToRenderInstanceListOfChildren=function(sourceObject,sourceInstanceComponent){var set=function(sourceObject,sourceInstanceComponent){sourceObject.forEach(function(childSource,index){var childSourceInstance=childSource.getComponent(wd.SourceInstance);sourceInstanceComponent.forEachToRenderInstanceList(function(toRenderInstance){childSourceInstance.addToRenderIntance(toRenderInstance.getChild(index))}),set(childSource,childSourceInstance)})};set(sourceObject,sourceInstanceComponent)},Octree.prototype._addSelfToToRenderInstanceList=function(self,instanceComponent){instanceComponent.addToRenderIntance(self)},Octree.prototype._getRenderListForCurrentLoop=function(){var _this=this,renderListByFrustumCull=this.getRenderListByFrustumCull(),resultRenderList=wdCb.Collection.create(),instanceSourceMap=wdCb.Hash.create();return renderListByFrustumCull.forEach(function(gameObject){if(!wd.InstanceUtils.isInstance(gameObject))return void resultRenderList.addChild(gameObject);if(wd.InstanceUtils.isSourceInstance(gameObject)){var instanceComponent=gameObject.getComponent(wd.SourceInstance);return _this._addSelfToToRenderInstanceList(gameObject,instanceComponent),void instanceSourceMap.addChild(String(gameObject.uid),gameObject)}var sourceObject=gameObject.getComponent(wd.ObjectInstance).sourceObject,sourceInstanceComponent=sourceObject.getComponent(wd.SourceInstance);_this._addSelfToToRenderInstanceList(gameObject,sourceInstanceComponent),instanceSourceMap.addChild(String(sourceObject.uid),sourceObject)},this),instanceSourceMap.forEach(function(sourceObject,uid){var sourceInstanceComponent=sourceObject.getComponent(wd.SourceInstance);_this._setToRenderInstanceListOfChildren(sourceObject,sourceInstanceComponent),resultRenderList.addChild(sourceObject)},this),resultRenderList},__decorate([wd.cloneAttributeAsBasicType()],Octree.prototype,"maxDepth",void 0),__decorate([wd.cloneAttributeAsBasicType()],Octree.prototype,"maxNodeCapacity",void 0),__decorate([wd.require(function(entityObject){wd.assert(entityObject instanceof wd.GameObject,wd.Log.info.FUNC_SHOULD("Octree component","add to GameObject"))})],Octree.prototype,"addToObject",null),__decorate([wd.require(function(){wd.assert(wd.JudgeUtils.isEqual(this.entityObject.parent,wd.Director.getInstance().scene)&&wd.Director.getInstance().scene.gameObjectScene.hasChild(this.entityObject),wd.Log.info.FUNC_SHOULD("be added to the one which is the firstLevel child of gameObjectScene"))})],Octree.prototype,"init",null),__decorate([wd.ensure(function(renderList){wd.assert(!!renderList&&renderList instanceof wdCb.Collection,wd.Log.info.FUNC_NOT_EXIST("renderList"))})],Octree.prototype,"getRenderList",null),__decorate([wd.require(function(){wd.assert(!!wd.Director.getInstance().scene.currentCamera.getComponent(wd.CameraController),wd.Log.info.FUNC_SHOULD("contain CameraController component"))})],Octree.prototype,"getRenderListByFrustumCull",null),__decorate([wd.require(function(){wd.assert(!!wd.Director.getInstance().scene.currentCamera.getComponent(wd.CameraController),wd.Log.info.FUNC_SHOULD("contain CameraController component"))})],Octree.prototype,"getIntersectListWithRay",null),__decorate([wd.require(function(sourceObject,sourceInstanceComponent){wd.assert(sourceInstanceComponent.hasToRenderInstance(),wd.Log.info.FUNC_SHOULD("top SourceInstance","has to render instance"))})],Octree.prototype,"_setToRenderInstanceListOfChildren",null),__decorate([wd.require(function(self,instanceComponent){wd.assert(instanceComponent instanceof wd.SourceInstance,wd.Log.info.FUNC_ONLY("SourceInstance has toRenderList")),instanceComponent.forEachToRenderInstanceList(function(instance){wd.assert(!wd.JudgeUtils.isEqual(instance,self),wd.Log.info.FUNC_SHOULD_NOT("toRenderInstanceList","contain self"))})})],Octree.prototype,"_addSelfToToRenderInstanceList",null),Octree}(wd.SpacePartition);wd.Octree=Octree}(wd||(wd={}));var wd;!function(wd){var OctreeNode=function(){function OctreeNode(minPoint,maxPoint,capacity,depth,maxDepth){this.gameObjectList=wdCb.Collection.create(),this.nodeList=wdCb.Collection.create(),this._depth=null,this._maxDepth=null,this._capacity=null,this._minPoint=null,this._maxPoint=null,this._boundingVectors=null,this._capacity=capacity,this._depth=depth,this._maxDepth=maxDepth,this._minPoint=minPoint,this._maxPoint=maxPoint}return OctreeNode.create=function(minPoint,maxPoint,capacity,depth,maxDepth){var obj=new this(minPoint,maxPoint,capacity,depth,maxDepth);return obj.initWhenCreate(),obj},Object.defineProperty(OctreeNode.prototype,"gameObjectCount",{get:function(){return this.gameObjectList.getCount()},enumerable:!0,configurable:!0}),OctreeNode.prototype.initWhenCreate=function(){this._boundingVectors=wd.BoundingRegionUtils.buildBoundingVectors(this._minPoint,this._maxPoint)},OctreeNode.prototype.addGameObjects=function(gameObjectList){var self=this,localMin=this._minPoint,localMax=this._maxPoint;gameObjectList.forEach(function(gameObject){gameObject.getComponent(wd.BoxColliderForFirstCheck).shape.isIntersectWithBox(localMin,localMax)&&self.gameObjectList.addChild(gameObject)})},OctreeNode.prototype.addNode=function(node){this.nodeList.addChild(node)},OctreeNode.prototype.findAndAddToRenderList=function(frustumPlanes,selectionList){if(wd.BoundingRegionUtils.isAABBIntersectFrustum(this._boundingVectors,frustumPlanes)){if(this._hasNode())return void this.nodeList.forEach(function(node){node.findAndAddToRenderList(frustumPlanes,selectionList)});selectionList.addChildren(wd.RenderUtils.getGameObjectRenderListForOctree(this.gameObjectList))}},OctreeNode.prototype.findAndAddToIntersectList=function(ray,selectionList){if(ray.isIntersectWithAABB(this._minPoint,this._maxPoint)){if(this._hasNode())return void this.nodeList.forEach(function(node){node.findAndAddToIntersectList(ray,selectionList)});selectionList.addChildren(this.gameObjectList)}},OctreeNode.prototype.findAndAddToCollideList=function(shape,selectionList){if(shape.isIntersectWithBox(this._minPoint,this._maxPoint)){if(this._hasNode())return void this.nodeList.forEach(function(node){node.findAndAddToCollideList(shape,selectionList)});selectionList.addChildren(this.gameObjectList)}},OctreeNode.prototype._hasNode=function(){return this.nodeList.getCount()>0},__decorate([wd.require(function(gameObjectList){gameObjectList.forEach(function(gameObject){wd.assert(gameObject instanceof wd.GameObject,wd.Log.info.FUNC_SHOULD("add gameObjects"))})})],OctreeNode.prototype,"addGameObjects",null),OctreeNode}();wd.OctreeNode=OctreeNode}(wd||(wd={}));var wd;!function(wd){var ColliderForFirstCheck=function(_super){function ColliderForFirstCheck(){_super.apply(this,arguments)}return __extends(ColliderForFirstCheck,_super),ColliderForFirstCheck.prototype.clone=function(){return wd.CloneUtils.clone(this)},ColliderForFirstCheck}(wd.Component);wd.ColliderForFirstCheck=ColliderForFirstCheck}(wd||(wd={}));var wd;!function(wd){var BoxColliderForFirstCheck=function(_super){function BoxColliderForFirstCheck(){_super.apply(this,arguments),this._collider=wd.BoxCollider.create()}return __extends(BoxColliderForFirstCheck,_super),BoxColliderForFirstCheck.create=function(){var obj=new this;return obj},Object.defineProperty(BoxColliderForFirstCheck.prototype,"shape",{get:function(){return this._collider.shape},enumerable:!0,configurable:!0}),BoxColliderForFirstCheck.prototype.init=function(){this._collider.entityObject=this.entityObject,this._collider.init()},BoxColliderForFirstCheck.prototype.update=function(elapsed){this._collider.update(elapsed)},__decorate([wd.cloneAttributeAsCloneable()],BoxColliderForFirstCheck.prototype,"_collider",void 0),BoxColliderForFirstCheck}(wd.ColliderForFirstCheck);wd.BoxColliderForFirstCheck=BoxColliderForFirstCheck}(wd||(wd={}));var wd;!function(wd){var Collider=function(_super){function Collider(){_super.apply(this,arguments),this.enable=!0,this.boundingRegion=null,this.type=wd.ABSTRACT_ATTRIBUTE}return __extends(Collider,_super),Object.defineProperty(Collider.prototype,"shape",{get:function(){return this.boundingRegion.shape},enumerable:!0,configurable:!0}),Collider.prototype.init=function(){this.boundingRegion=this.createBoundingRegion(),this.boundingRegion.init(),this.buildBoundingRegion()},Collider.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1);var engine=wd.CollisionEngine.getInstance();_super.prototype.addToObject.call(this,entityObject,isShareComponent),engine.hasChild(this)||engine.addChild(this)},Collider.prototype.removeFromObject=function(entityObject){_super.prototype.removeFromObject.call(this,entityObject),wd.CollisionEngine.getInstance().removeChild(this)},Collider.prototype.clone=function(){return wd.CloneUtils.clone(this)},Collider.prototype.update=function(elapsed){this.boundingRegion.update()},Collider.prototype.updateShape=function(){this.boundingRegion.updateShape()},Collider.prototype.isIntersectWith=function(collider){return collider instanceof wd.BoxCollider?this.boundingRegion.isIntersectWithBox(collider.boundingRegion):collider instanceof wd.SphereCollider?this.boundingRegion.isIntersectWithSphere(collider.boundingRegion):void wd.Log.warn(wd.Log.info.FUNC_NOT_SUPPORT(this.type+" collider","intersect with "+collider.type+" collider"))},Collider.prototype.isCollide=function(targetObject){var collider=null;return collider=targetObject.getComponent(Collider),targetObject.hasComponent(wd.RigidBody)&&collider.updateShape(),this.isIntersectWith(collider)},Collider.prototype._isSelf=function(entityObject){return wd.JudgeUtils.isSelf(this.entityObject,entityObject)},__decorate([wd.cloneAttributeAsBasicType()],Collider.prototype,"enable",void 0),__decorate([wd.cloneAttributeAsCloneable()],Collider.prototype,"boundingRegion",void 0),__decorate([wd.require(function(collider){wd.assert(collider instanceof Collider,wd.Log.info.FUNC_SHOULD("target","be collider"))})],Collider.prototype,"isIntersectWith",null),__decorate([wd.require(function(targetObject){wd.assert(!this._isSelf(targetObject),wd.Log.info.FUNC_SHOULD_NOT("targetObject","be self")),wd.assert(targetObject.hasComponent(Collider),wd.Log.info.FUNC_SHOULD("targetObject","contain Collider component"))})],Collider.prototype,"isCollide",null),Collider}(wd.Component);wd.Collider=Collider}(wd||(wd={}));var wd;!function(wd){var BoxCollider=function(_super){function BoxCollider(){_super.apply(this,arguments),this.center=wd.Vector3.create(0,0,0),this.halfExtents=null,this.type=wd.EColliderType.BOX}return __extends(BoxCollider,_super),BoxCollider.create=function(){var obj=new this;return obj},BoxCollider.prototype.createBoundingRegion=function(){return wd.BoxBoundingRegion.create(this.entityObject)},BoxCollider.prototype.buildBoundingRegion=function(){this.boundingRegion.build(this.center,this.halfExtents)},__decorate([wd.cloneAttributeAsCloneable()],BoxCollider.prototype,"center",void 0),__decorate([wd.cloneAttributeAsCloneable()],BoxCollider.prototype,"halfExtents",void 0),BoxCollider}(wd.Collider);wd.BoxCollider=BoxCollider}(wd||(wd={}));var wd;!function(wd){var SphereCollider=function(_super){function SphereCollider(){_super.apply(this,arguments),this.center=wd.Vector3.create(0,0,0),this.radius=null,this.type=wd.EColliderType.SPHERE}return __extends(SphereCollider,_super),SphereCollider.create=function(){var obj=new this;return obj},SphereCollider.prototype.createBoundingRegion=function(){return wd.SphereBoundingRegion.create(this.entityObject)},SphereCollider.prototype.buildBoundingRegion=function(){this.boundingRegion.build(this.center,this.radius)},__decorate([wd.cloneAttributeAsCloneable()],SphereCollider.prototype,"center",void 0),__decorate([wd.cloneAttributeAsBasicType()],SphereCollider.prototype,"radius",void 0),SphereCollider}(wd.Collider);wd.SphereCollider=SphereCollider}(wd||(wd={}));var wd;!function(wd){var BoundingRegion=function(){function BoundingRegion(entityObject){this.shape=null,this.entityObject=null,this.isUserSpecifyTheRegion=!1,this.originShape=null,this.debugObject=null,this.entityObject=entityObject}return BoundingRegion.prototype.init=function(){this.shape=this.createShape()},BoundingRegion.prototype.clone=function(){return wd.CloneUtils.clone(this)},BoundingRegion.prototype.build=function(center){for(var args=[],_i=1;_i<arguments.length;_i++)args[_i-1]=arguments[_i];var params=Array.prototype.slice.call(arguments,0);this.isBuildUserSpecifyBoundingRegion.apply(this,params)?(this.isUserSpecifyTheRegion=!0,this.shape.setFromShapeParam.apply(this.shape,params)):this.shape.setFromPoints(wd.ColliderUtils.getVertices(this.entityObject)),this.originShape=this.shape.clone(),wd.DebugConfig.debugCollision&&(this.debugObject=this.buildDebugObjectFromShape(this.shape),wd.Director.getInstance().scene.addChild(this.debugObject))},BoundingRegion.prototype.update=function(){this.isNotTransformed()||(wd.DebugConfig.debugCollision?(this.updateShape(),this.updateDebugObjectFromShape(this.shape)):this.entityObject.hasComponent(wd.RigidBody)||this.updateShape())},BoundingRegion.prototype.isIntersectWithSphere=function(boundingRegion){return this.shape.isIntersectWithSphere(boundingRegion.shape)},BoundingRegion.prototype.isIntersectWithBox=function(boundingRegion){return this.shape.isIntersectWithBox(boundingRegion.shape)},BoundingRegion.prototype.buildDebugObjectFromShape=function(shape){var material=null,geometry=null,renderer=null,entityObject=null;return material=wd.BasicMaterial.create(),material.color=wd.Color.create("rgb(255,0,0)"),geometry=wd.CustomGeometry.create(),geometry.material=material,geometry.drawMode=wd.EDrawMode.LINES,this.setDebugObjectGeometry(geometry,shape),renderer=wd.MeshRenderer.create(),entityObject=wd.GameObject.create(),entityObject.addComponent(geometry),entityObject.addComponent(renderer),entityObject.transform.translate(shape.center),entityObject.name="debugBoundingRegion"+this.entityObject.uid,entityObject.init(),entityObject},__decorate([wd.cloneAttributeAsCloneable()],BoundingRegion.prototype,"shape",void 0),__decorate([wd.ensure(function(returnValue,center){for(var args=[],_i=2;_i<arguments.length;_i++)args[_i-2]=arguments[_i];this.isBuildUserSpecifyBoundingRegion.apply(this,Array.prototype.slice.call(arguments,1))&&wd.assert(this.shape.center.isEqual(center),wd.Log.info.FUNC_SHOULD_NOT("transform shape when build"))})],BoundingRegion.prototype,"build",null),BoundingRegion}();wd.BoundingRegion=BoundingRegion}(wd||(wd={}));var wd;!function(wd){var BoxBoundingRegion=function(_super){function BoxBoundingRegion(){_super.apply(this,arguments)}return __extends(BoxBoundingRegion,_super),BoxBoundingRegion.create=function(entityObject){var obj=new this(entityObject);return obj},BoxBoundingRegion.prototype.updateShape=function(){var transform=this.entityObject.transform;this.isUserSpecifyTheRegion?this.shape.setFromTranslationAndScale(this.originShape,transform.localToWorldMatrix):transform.isRotate?this.shape.setFromObject(this.entityObject):this.shape.setFromTranslationAndScale(this.originShape,transform.localToWorldMatrix)},BoxBoundingRegion.prototype.createShape=function(){return wd.AABBShape.create()},BoxBoundingRegion.prototype.updateDebugObjectFromShape=function(shape){var geometry=this.debugObject.getComponent(wd.CustomGeometry);this.setDebugObjectGeometry(geometry,shape),this.debugObject.transform.position=shape.center},BoxBoundingRegion.prototype.setDebugObjectGeometry=function(geometry,shape){var halfExtents=shape.halfExtents,x=halfExtents.x,y=halfExtents.y,z=halfExtents.z;geometry.vertices=[-x,-y,-z,-x,-y,z,x,-y,z,x,-y,-z,-x,y,-z,-x,y,z,x,y,z,x,y,-z],geometry.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]},BoxBoundingRegion.prototype.isBuildUserSpecifyBoundingRegion=function(center,halfExtents){return!!center&&!!halfExtents},BoxBoundingRegion.prototype.isNotTransformed=function(){var transform=this.entityObject.transform;return!transform.isRotate&&!transform.isTranslate&&!transform.isScale},__decorate([wd.require(function(shape){wd.assert(this.debugObject,wd.Log.info.FUNC_SHOULD("build debugObject"))})],BoxBoundingRegion.prototype,"updateDebugObjectFromShape",null),__decorate([wd.require(function(geometry,shape){wd.assert(shape.halfExtents&&!shape.halfExtents.isZero(),wd.Log.info.FUNC_SHOULD_NOT("halfExtents","be zero"))})],BoxBoundingRegion.prototype,"setDebugObjectGeometry",null),BoxBoundingRegion}(wd.BoundingRegion);wd.BoxBoundingRegion=BoxBoundingRegion}(wd||(wd={}));var wd;!function(wd){var SphereBoundingRegion=function(_super){function SphereBoundingRegion(){_super.apply(this,arguments)}return __extends(SphereBoundingRegion,_super),SphereBoundingRegion.create=function(entityObject){var obj=new this(entityObject);return obj},SphereBoundingRegion.prototype.updateShape=function(){var transform=this.entityObject.transform;this.shape.setFromTranslationAndScale(this.originShape,transform.localToWorldMatrix)},SphereBoundingRegion.prototype.createShape=function(){return wd.SphereShape.create()},SphereBoundingRegion.prototype.updateDebugObjectFromShape=function(shape){this.debugObject.transform.position=shape.center;var scaleTimes=shape.radius/this.originShape.radius;this.debugObject.transform.scale=wd.Vector3.create(scaleTimes,scaleTimes,scaleTimes)},SphereBoundingRegion.prototype.isNotTransformed=function(){var transform=this.entityObject.transform;return!transform.isTranslate&&!transform.isScale},SphereBoundingRegion.prototype.isBuildUserSpecifyBoundingRegion=function(center,radius){return!!center&&!!radius},SphereBoundingRegion.prototype.setDebugObjectGeometry=function(geometry,shape){for(var SEGMENTS=40,RINGCOUNT=3,radius=shape.radius,vertices=[],x=0,ring=0;ring<RINGCOUNT;ring++){var xo=0,yo=1,zo=2,theta=null;1===ring?(xo=1,yo=0,zo=2):2===ring&&(xo=0,yo=2,zo=1);for(var i=0;i<SEGMENTS;i++)theta=2*Math.PI*(i/SEGMENTS),vertices[x+xo]=radius*Math.cos(theta),vertices[x+yo]=0,vertices[x+zo]=radius*Math.sin(theta),x+=3,theta=2*Math.PI*((i+1)/SEGMENTS),vertices[x+xo]=radius*Math.cos(theta),vertices[x+yo]=0,vertices[x+zo]=radius*Math.sin(theta),x+=3}geometry.vertices=vertices},__decorate([wd.require(function(shape){wd.assert(this.debugObject,wd.Log.info.FUNC_SHOULD("build debugObject"))})],SphereBoundingRegion.prototype,"updateDebugObjectFromShape",null),__decorate([wd.require(function(geometry,shape){wd.assert(shape.radius>0,wd.Log.info.FUNC_SHOULD("radius","> 0"))})],SphereBoundingRegion.prototype,"setDebugObjectGeometry",null),SphereBoundingRegion}(wd.BoundingRegion);wd.SphereBoundingRegion=SphereBoundingRegion}(wd||(wd={}));var wd;!function(wd){var BoundingRegionUtils=function(){function BoundingRegionUtils(){}return BoundingRegionUtils.isAABBInFrustum=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var boundingVectors=null,frustumPlanes=null;if(2===args.length)boundingVectors=args[0],frustumPlanes=args[1];else if(3===args.length){var minPoint=args[0],maxPoint=args[1];boundingVectors=this.buildBoundingVectors(minPoint,maxPoint),frustumPlanes=args[2]}for(var p=0;p<6;p++)for(var i=0;i<8;i++)if(frustumPlanes[p].dotCoordinate(boundingVectors[i])<0)return!1;return!0},BoundingRegionUtils.isAABBIntersectFrustum=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var boundingVectors=null,frustumPlanes=null;if(2===args.length)boundingVectors=args[0],frustumPlanes=args[1];else if(3===args.length){var minPoint=args[0],maxPoint=args[1];boundingVectors=this.buildBoundingVectors(minPoint,maxPoint),frustumPlanes=args[2]}for(var p=0;p<6;p++){for(var inCount=8,i=0;i<8&&frustumPlanes[p].dotCoordinate(boundingVectors[i])<0;i++)inCount--;if(0===inCount)return!1}return!0},BoundingRegionUtils.buildBoundingVectors=function(minPoint,maxPoint){var boundingVectors=[];return boundingVectors.push(minPoint.clone()),boundingVectors.push(maxPoint.clone()),boundingVectors.push(minPoint.clone()),boundingVectors[2].x=maxPoint.x,boundingVectors.push(minPoint.clone()),boundingVectors[3].y=maxPoint.y,boundingVectors.push(minPoint.clone()),boundingVectors[4].z=maxPoint.z,boundingVectors.push(maxPoint.clone()),boundingVectors[5].z=minPoint.z,boundingVectors.push(maxPoint.clone()),boundingVectors[6].x=minPoint.x,boundingVectors.push(maxPoint.clone()),boundingVectors[7].y=minPoint.y,boundingVectors},BoundingRegionUtils}();wd.BoundingRegionUtils=BoundingRegionUtils}(wd||(wd={}));var wd;!function(wd){var Shape=function(){function Shape(){this.center=wd.Vector3.create(0,0,0)}return Shape.prototype.clone=function(){return wd.CloneUtils.clone(this)},Shape.prototype.isBoxAndSphereIntersected=function(box,sphere){var sphereCenter=sphere.center,sphereRadius=sphere.radius;return sphereCenter.distanceToSquared(box.closestPointTo(sphereCenter))<Math.pow(sphereRadius,2)},__decorate([wd.cloneAttributeAsCloneable()],Shape.prototype,"center",void 0),Shape}();wd.Shape=Shape}(wd||(wd={}));var wd;!function(wd){var AABBShape=function(_super){function AABBShape(){_super.apply(this,arguments),this.halfExtents=wd.Vector3.create(.5,.5,.5)}return __extends(AABBShape,_super),AABBShape.create=function(){var obj=new this;return obj},AABBShape.getCenter=function(min,max){return wd.Vector3.create().add2(max,min).scale(.5)},AABBShape.getHalfExtents=function(min,max){
return wd.Vector3.create().sub2(max,min).scale(.5)},AABBShape.prototype.setMinMax=function(min,max){this.center=AABBShape.getCenter(min,max),this.halfExtents=AABBShape.getHalfExtents(min,max)},AABBShape.prototype.getMin=function(){return this.center.clone().sub(this.halfExtents)},AABBShape.prototype.getMax=function(){return this.center.clone().add(this.halfExtents)},AABBShape.prototype.setFromShapeParam=function(center,halfExtents){this.center=center,this.halfExtents=halfExtents},AABBShape.prototype.setFromPoints=function(points){var self=this,min=this._getEmptyMin(),max=this._getEmptyMax();return wd.GeometryUtils.iterateThreeComponent(points,function(point){self._expandByPoint(point,min,max)}),this.setMinMax(min,max),this},AABBShape.prototype.setFromTransformedAABB=function(aabb,matrix){var bc=this.center,br=this.halfExtents,ac=aabb.center.values,ar=aabb.halfExtents.values,m=matrix.values,mx0=m[0],mx1=m[4],mx2=m[8],my0=m[1],my1=m[5],my2=m[9],mz0=m[2],mz1=m[6],mz2=m[10],mx0a=Math.abs(mx0),mx1a=Math.abs(mx1),mx2a=Math.abs(mx2),my0a=Math.abs(my0),my1a=Math.abs(my1),my2a=Math.abs(my2),mz0a=Math.abs(mz0),mz1a=Math.abs(mz1),mz2a=Math.abs(mz2);bc.set(m[12]+mx0*ac[0]+mx1*ac[1]+mx2*ac[2],m[13]+my0*ac[0]+my1*ac[1]+my2*ac[2],m[14]+mz0*ac[0]+mz1*ac[1]+mz2*ac[2]),br.set(mx0a*ar[0]+mx1a*ar[1]+mx2a*ar[2],my0a*ar[0]+my1a*ar[1]+my2a*ar[2],mz0a*ar[0]+mz1a*ar[1]+mz2a*ar[2])},AABBShape.prototype.setFromTranslationAndScale=function(aabb,matrix){var translation=matrix.getTranslation(),scale=matrix.getScale();this.center=aabb.center.clone().add(translation),this.halfExtents=aabb.halfExtents.clone().mul(scale)},AABBShape.prototype.setFromObject=function(entityObject){var modelMatrix=entityObject.transform.localToWorldMatrix,vertices=wd.ColliderUtils.getVertices(entityObject),self=this,min=this._getEmptyMin(),max=this._getEmptyMax();wd.GeometryUtils.iterateThreeComponent(vertices,function(point){point.applyMatrix4(modelMatrix),self._expandByPoint(point,min,max)}),this.setMinMax(min,max)},AABBShape.prototype.isIntersectWithBox=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var aMax=this.getMax(),aMin=this.getMin(),bMax=null,bMin=null;if(1===args.length){var shape=args[0];bMin=shape.getMin(),bMax=shape.getMax()}else 2===args.length&&(bMin=args[0],bMax=args[1]);return aMin.x<=bMax.x&&aMax.x>=bMin.x&&aMin.y<=bMax.y&&aMax.y>=bMin.y&&aMin.z<=bMax.z&&aMax.z>=bMin.z},AABBShape.prototype.isIntersectWithSphere=function(shape){return this.isBoxAndSphereIntersected(this,shape)},AABBShape.prototype.isIntersectWithRay=function(ray){return ray.isIntersectWithAABB(this)},AABBShape.prototype.closestPointTo=function(point){var min=this.getMin(),max=this.getMax(),resultPoint=wd.Vector3.create();return point.x<min.x?resultPoint.x=min.x:point.x>max.x?resultPoint.x=max.x:resultPoint.x=point.x,point.y<min.y?resultPoint.y=min.y:point.y>max.y?resultPoint.y=max.y:resultPoint.y=point.y,point.z<min.z?resultPoint.z=min.z:point.z>max.z?resultPoint.z=max.z:resultPoint.z=point.z,resultPoint},AABBShape.prototype.containPoint=function(point){for(var min=this.getMin(),max=this.getMax(),i=0;i<3;++i)if(point.values[i]<min.values[i]||point.values[i]>max.values[i])return!1;return!0},AABBShape.prototype._getEmptyMin=function(){return wd.Vector3.create(1/0,1/0,1/0)},AABBShape.prototype._getEmptyMax=function(){return wd.Vector3.create(-(1/0),-(1/0),-(1/0))},AABBShape.prototype._expandByPoint=function(point,min,max){min.min(point),max.max(point)},__decorate([wd.cloneAttributeAsCloneable()],AABBShape.prototype,"halfExtents",void 0),__decorate([wd.require(function(entityObject){var vertices=wd.ColliderUtils.getVertices(entityObject);wd.assert(vertices&&vertices.length>0,wd.Log.info.FUNC_MUST_DEFINE("vertices"))})],AABBShape.prototype,"setFromObject",null),AABBShape}(wd.Shape);wd.AABBShape=AABBShape}(wd||(wd={}));var wd;!function(wd){var SphereShape=function(_super){function SphereShape(){_super.apply(this,arguments),this.radius=1}return __extends(SphereShape,_super),SphereShape.create=function(){var obj=new this;return obj},SphereShape.prototype.setFromShapeParam=function(center,radius){this.center=center,this.radius=radius},SphereShape.prototype.setFromPoints=function(points){var aabb=wd.AABBShape.create();this.center=aabb.setFromPoints(points).center,this.radius=this._findMaxDistanceOfPointsToCenter(points)},SphereShape.prototype.setFromTranslationAndScale=function(sphere,matrix){var translation=matrix.getTranslation(),scale=matrix.getScale();this.center=sphere.center.clone().add(translation),this.radius=sphere.radius*Math.max(scale.x,scale.y,scale.z)},SphereShape.prototype.isIntersectWithSphere=function(shape){var radiusSum=this.radius+shape.radius;return shape.center.distanceToSquared(this.center)<=Math.pow(radiusSum,2)},SphereShape.prototype.isIntersectWithBox=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var shape=null;if(1===args.length)shape=args[0];else if(2===args.length){var min=args[0],max=args[1];shape=wd.AABBShape.create(),shape.setMinMax(min,max)}return this.isBoxAndSphereIntersected(shape,this)},SphereShape.prototype.isIntersectWithRay=function(ray){return ray.isIntersectWithSphere(this)},SphereShape.prototype.containPoint=function(point){return point.distanceToSquared(this.center)<=Math.pow(this.radius,2)},SphereShape.prototype._findMaxDistanceOfPointsToCenter=function(points){var maxRadiusSq=0,center=this.center;return wd.GeometryUtils.iterateThreeComponent(points,function(point){maxRadiusSq=Math.max(maxRadiusSq,center.distanceToSquared(point))}),Math.sqrt(maxRadiusSq)},__decorate([wd.cloneAttributeAsBasicType()],SphereShape.prototype,"radius",void 0),SphereShape}(wd.Shape);wd.SphereShape=SphereShape}(wd||(wd={}));var wd;!function(wd){!function(EColliderType){EColliderType[EColliderType.BOX="box"]="BOX",EColliderType[EColliderType.SPHERE="sphere"]="SPHERE"}(wd.EColliderType||(wd.EColliderType={}));wd.EColliderType}(wd||(wd={}));var wd;!function(wd){var ColliderUtils=function(){function ColliderUtils(){}return ColliderUtils.getVertices=function(entityObject){return entityObject.hasComponent(wd.Geometry)?entityObject.getComponent(wd.Geometry).geometryData.vertices:entityObject.hasTag(wd.EWDTag.CONTAINER)?entityObject.getChild(0).getComponent(wd.Geometry).vertices:null},__decorate([wd.require(function(entityObject){if(!entityObject.hasComponent(wd.Geometry)&&entityObject.hasTag(wd.EWDTag.CONTAINER)){var firstChildVertices=entityObject.getChild(0).getComponent(wd.Geometry).vertices,secondChildVertices=entityObject.getChild(1).getComponent(wd.Geometry).vertices;wd.assert(!!firstChildVertices&&firstChildVertices.length===secondChildVertices.length,wd.Log.info.FUNC_SHOULD("if entityObject is EWDTag.CONTAINER, then its children should has its vertices"))}})],ColliderUtils,"getVertices",null),ColliderUtils}();wd.ColliderUtils=ColliderUtils}(wd||(wd={}));var wd;!function(wd){var RigidBody=function(_super){function RigidBody(){_super.apply(this,arguments),this._friction=0,this._restitution=0,this._children=wdCb.Collection.create(),this.lockConstraint=wd.LockConstraint.create(this),this.distanceConstraint=wd.DistanceConstraint.create(this),this.hingeConstraint=wd.HingeConstraint.create(this),this.pointToPointConstraintList=wd.PointToPointConstraintList.create(this)}return __extends(RigidBody,_super),Object.defineProperty(RigidBody.prototype,"friction",{get:function(){return this._friction},set:function(friction){this._friction=friction},enumerable:!0,configurable:!0}),Object.defineProperty(RigidBody.prototype,"restitution",{get:function(){return this._restitution},set:function(restitution){this._restitution=restitution},enumerable:!0,configurable:!0}),Object.defineProperty(RigidBody.prototype,"children",{get:function(){return this._children},set:function(children){if(wd.JudgeUtils.isArrayExactly(children)){var arr=children;this._children=wdCb.Collection.create(arr)}else{var list=children;this._children=list}this._children.forEach(function(child){child.addTag("isRigidbodyChild")})},enumerable:!0,configurable:!0}),RigidBody.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1);var engine=wd.PhysicsEngine.getInstance();_super.prototype.addToObject.call(this,entityObject,isShareComponent),engine.hasChild(this)||engine.addChild(this)},RigidBody.prototype.addConstraint=function(){var _this=this,engineAdapter=this.getPhysicsEngineAdapter();this.lockConstraint&&this.lockConstraint.connectedBody&&engineAdapter.addLockConstraint(this.entityObject,this.lockConstraint),this.distanceConstraint&&this.distanceConstraint.connectedBody&&engineAdapter.addDistanceConstraint(this.entityObject,this.distanceConstraint),this.hingeConstraint&&this.hingeConstraint.connectedBody&&engineAdapter.addHingeConstraint(this.entityObject,this.hingeConstraint),this.pointToPointConstraintList&&this.pointToPointConstraintList.getCount()>0&&this.pointToPointConstraintList.forEach(function(constraint){engineAdapter.addPointToPointConstraint(_this.entityObject,constraint)},this)},RigidBody.prototype.removeFromObject=function(entityObject){_super.prototype.removeFromObject.call(this,entityObject),wd.PhysicsEngine.getInstance().removeChild(this)},RigidBody.prototype.dispose=function(){this._children.forEach(function(child){child.removeTag("isRigidbodyChild")},this)},RigidBody.prototype.getPhysicsEngineAdapter=function(){return wd.PhysicsEngine.getInstance().physicsEngineAdapter},RigidBody.prototype.initBody=function(){this.addBody()},RigidBody.prototype.initConstraint=function(){this.addConstraint()},RigidBody.prototype.addBodyToPhysicsEngine=function(method,data){void 0===data&&(data={});var engineAdapter=this.getPhysicsEngineAdapter(),position=this.entityObject.transform.position,rotation=this.entityObject.transform.rotation;engineAdapter[method](this.entityObject,wdCb.ExtendUtils.extend({position:position,rotation:rotation,children:this._children,lockConstraint:this.lockConstraint,onContact:wdCb.FunctionUtils.bind(this,this._onContact),onCollisionStart:wdCb.FunctionUtils.bind(this,this._onCollisionStart),onCollisionEnd:wdCb.FunctionUtils.bind(this,this._onCollisionEnd),friction:this.friction,restitution:this.restitution},data))},RigidBody.prototype._onContact=function(collideObject){wd.ScriptEngine.getInstance().execEntityObjectScriptWithData(this.entityObject,"onContact",wdCb.Collection.create([collideObject]))},RigidBody.prototype._onCollisionStart=function(collideObject){wd.ScriptEngine.getInstance().execEntityObjectScriptWithData(this.entityObject,"onCollisionStart",wdCb.Collection.create([collideObject]))},RigidBody.prototype._onCollisionEnd=function(){wd.ScriptEngine.getInstance().execEntityObjectScript(this.entityObject,"onCollisionEnd")},RigidBody.prototype._isContainer=function(entityObject){var rigidBody=entityObject.getComponent(RigidBody);return rigidBody.children.getCount()>0},__decorate([wd.operateBodyDataGetterAndSetter("Friction"),wd.cloneAttributeAsBasicType()],RigidBody.prototype,"friction",null),__decorate([wd.operateBodyDataGetterAndSetter("Restitution"),wd.cloneAttributeAsBasicType()],RigidBody.prototype,"restitution",null),__decorate([wd.cloneAttributeAsCloneable()],RigidBody.prototype,"children",null),__decorate([wd.cloneAttributeAsCloneable({isInjectTarget:!0})],RigidBody.prototype,"lockConstraint",void 0),__decorate([wd.cloneAttributeAsCloneable({isInjectTarget:!0})],RigidBody.prototype,"distanceConstraint",void 0),__decorate([wd.cloneAttributeAsCloneable({isInjectTarget:!0})],RigidBody.prototype,"hingeConstraint",void 0),__decorate([wd.cloneAttributeAsCloneable({isInjectTarget:!0})],RigidBody.prototype,"pointToPointConstraintList",void 0),__decorate([wd.execOnlyOnce("_initBody")],RigidBody.prototype,"initBody",null),__decorate([wd.execOnlyOnce("_initConstraint")],RigidBody.prototype,"initConstraint",null),__decorate([wd.require(function(){this._isContainer(this.entityObject)?wd.assert(!this.entityObject.getComponent(wd.Collider),wd.Log.info.FUNC_SHOULD_NOT("container","add collider component in the case of compound")):(wd.assert(!!this.entityObject.getComponent(wd.Collider),wd.Log.info.FUNC_MUST_DEFINE("collider component when add rigid body component")),wd.assert(!!this.entityObject.getComponent(wd.Collider).shape,wd.Log.info.FUNC_SHOULD("create collider.shape before adding rigid body component")))})],RigidBody.prototype,"addBodyToPhysicsEngine",null),RigidBody}(wd.Component);wd.RigidBody=RigidBody}(wd||(wd={}));var wd;!function(wd){var DynamicRigidBody=function(_super){function DynamicRigidBody(){_super.apply(this,arguments),this._linearDamping=0,this._angularDamping=0,this._velocity=wd.Vector3.create(0,0,0),this._angularVelocity=wd.Vector3.create(0,0,0),this._mass=1,this.impulse=null,this.force=null,this.hitPoint=null}return __extends(DynamicRigidBody,_super),DynamicRigidBody.create=function(){var obj=new this;return obj},Object.defineProperty(DynamicRigidBody.prototype,"linearDamping",{get:function(){return this._linearDamping},set:function(linearDamping){this._linearDamping=linearDamping},enumerable:!0,configurable:!0}),Object.defineProperty(DynamicRigidBody.prototype,"angularDamping",{get:function(){return this._angularDamping},set:function(angularDamping){this._angularDamping=angularDamping},enumerable:!0,configurable:!0}),Object.defineProperty(DynamicRigidBody.prototype,"velocity",{get:function(){return this._velocity},set:function(velocity){this._velocity=velocity},enumerable:!0,configurable:!0}),Object.defineProperty(DynamicRigidBody.prototype,"angularVelocity",{get:function(){return this._angularVelocity},set:function(angularVelocity){this._angularVelocity=angularVelocity},enumerable:!0,configurable:!0}),Object.defineProperty(DynamicRigidBody.prototype,"mass",{get:function(){return this._mass},set:function(mass){this._mass=mass},enumerable:!0,configurable:!0}),DynamicRigidBody.prototype.addBody=function(){this.addBodyToPhysicsEngine("addDynamicBody",{mass:this.mass,linearDamping:this.linearDamping,angularDamping:this.angularDamping,velocity:this.velocity,angularVelocity:this.angularVelocity,impulse:this.impulse,force:this.force,hitPoint:this.hitPoint})},__decorate([wd.operateBodyDataGetterAndSetter("LinearDamping"),wd.cloneAttributeAsBasicType()],DynamicRigidBody.prototype,"linearDamping",null),__decorate([wd.operateBodyDataGetterAndSetter("AngularDamping"),wd.cloneAttributeAsBasicType()],DynamicRigidBody.prototype,"angularDamping",null),__decorate([wd.operateBodyDataGetterAndSetter("Velocity"),wd.cloneAttributeAsCloneable()],DynamicRigidBody.prototype,"velocity",null),__decorate([wd.operateBodyDataGetterAndSetter("AngularVelocity"),wd.cloneAttributeAsCloneable()],DynamicRigidBody.prototype,"angularVelocity",null),__decorate([wd.operateBodyDataGetterAndSetter("Mass"),wd.cloneAttributeAsBasicType()],DynamicRigidBody.prototype,"mass",null),__decorate([wd.cloneAttributeAsCloneable()],DynamicRigidBody.prototype,"impulse",void 0),__decorate([wd.cloneAttributeAsCloneable()],DynamicRigidBody.prototype,"force",void 0),__decorate([wd.cloneAttributeAsCloneable()],DynamicRigidBody.prototype,"hitPoint",void 0),DynamicRigidBody}(wd.RigidBody);wd.DynamicRigidBody=DynamicRigidBody}(wd||(wd={}));var wd;!function(wd){var KinematicRigidBody=function(_super){function KinematicRigidBody(){_super.apply(this,arguments),this._velocity=wd.Vector3.create(0,0,0),this._angularVelocity=wd.Vector3.create(0,0,0),this._mass=1}return __extends(KinematicRigidBody,_super),KinematicRigidBody.create=function(){var obj=new this;return obj},Object.defineProperty(KinematicRigidBody.prototype,"velocity",{get:function(){return this._velocity},set:function(velocity){this._velocity=velocity},enumerable:!0,configurable:!0}),Object.defineProperty(KinematicRigidBody.prototype,"angularVelocity",{get:function(){return this._angularVelocity},set:function(angularVelocity){this._angularVelocity=angularVelocity},enumerable:!0,configurable:!0}),Object.defineProperty(KinematicRigidBody.prototype,"mass",{get:function(){return this._mass},set:function(mass){this._mass=mass},enumerable:!0,configurable:!0}),KinematicRigidBody.prototype.addBody=function(){this.addBodyToPhysicsEngine("addKinematicBody",{mass:this.mass,velocity:this.velocity,angularVelocity:this.angularVelocity})},__decorate([wd.operateBodyDataGetterAndSetter("Velocity"),wd.cloneAttributeAsCloneable()],KinematicRigidBody.prototype,"velocity",null),__decorate([wd.operateBodyDataGetterAndSetter("AngularVelocity"),wd.cloneAttributeAsCloneable()],KinematicRigidBody.prototype,"angularVelocity",null),__decorate([wd.operateBodyDataGetterAndSetter("Mass"),wd.cloneAttributeAsBasicType()],KinematicRigidBody.prototype,"mass",null),KinematicRigidBody}(wd.RigidBody);wd.KinematicRigidBody=KinematicRigidBody}(wd||(wd={}));var wd;!function(wd){var StaticRigidBody=function(_super){function StaticRigidBody(){_super.apply(this,arguments)}return __extends(StaticRigidBody,_super),StaticRigidBody.create=function(){var obj=new this;return obj},StaticRigidBody.prototype.addBody=function(){this.addBodyToPhysicsEngine("addStaticBody")},StaticRigidBody}(wd.RigidBody);wd.StaticRigidBody=StaticRigidBody}(wd||(wd={}));var wd;!function(wd){var PhysicsConstraint=function(){function PhysicsConstraint(rigidBody){this.maxForce=null,this.rigidBody=null,this.rigidBody=rigidBody}return PhysicsConstraint.prototype.clone=function(rigidBody){return wd.CloneUtils.clone(this,null,[rigidBody])},__decorate([wd.cloneAttributeAsBasicType()],PhysicsConstraint.prototype,"maxForce",void 0),PhysicsConstraint}();wd.PhysicsConstraint=PhysicsConstraint;var LockConstraint=function(_super){function LockConstraint(){_super.apply(this,arguments),this._connectedBody=null}return __extends(LockConstraint,_super),LockConstraint.create=function(rigidBody){var obj=new this(rigidBody);return obj},Object.defineProperty(LockConstraint.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(connectedBody){var engineAdapter=null;this._connectedBody=connectedBody,engineAdapter=this.rigidBody.getPhysicsEngineAdapter(),engineAdapter.removeLockConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint()},enumerable:!0,configurable:!0}),__decorate([wd.cloneAttributeAsBasicType()],LockConstraint.prototype,"connectedBody",null),LockConstraint}(PhysicsConstraint);wd.LockConstraint=LockConstraint;var DistanceConstraint=function(_super){function DistanceConstraint(){_super.apply(this,arguments),this._connectedBody=null,this.distance=null}return __extends(DistanceConstraint,_super),DistanceConstraint.create=function(rigidBody){var obj=new this(rigidBody);return obj},Object.defineProperty(DistanceConstraint.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(connectedBody){var engineAdapter=null;this._connectedBody=connectedBody,engineAdapter=this.rigidBody.getPhysicsEngineAdapter(),engineAdapter.removeDistanceConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint()},enumerable:!0,configurable:!0}),__decorate([wd.cloneAttributeAsBasicType()],DistanceConstraint.prototype,"connectedBody",null),__decorate([wd.cloneAttributeAsBasicType()],DistanceConstraint.prototype,"distance",void 0),DistanceConstraint}(PhysicsConstraint);wd.DistanceConstraint=DistanceConstraint;var HingeConstraint=function(_super){function HingeConstraint(){_super.apply(this,arguments),this._connectedBody=null,this.pivotA=null,this.pivotB=null,this.axisA=null,this.axisB=null}return __extends(HingeConstraint,_super),HingeConstraint.create=function(rigidBody){var obj=new this(rigidBody);return obj},Object.defineProperty(HingeConstraint.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(connectedBody){var engineAdapter=null;this._connectedBody=connectedBody,engineAdapter=this.rigidBody.getPhysicsEngineAdapter(),engineAdapter.removeHingeConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint()},enumerable:!0,configurable:!0}),__decorate([wd.cloneAttributeAsBasicType()],HingeConstraint.prototype,"connectedBody",null),__decorate([wd.cloneAttributeAsCloneable()],HingeConstraint.prototype,"pivotA",void 0),__decorate([wd.cloneAttributeAsCloneable()],HingeConstraint.prototype,"pivotB",void 0),__decorate([wd.cloneAttributeAsCloneable()],HingeConstraint.prototype,"axisA",void 0),__decorate([wd.cloneAttributeAsCloneable()],HingeConstraint.prototype,"axisB",void 0),HingeConstraint}(PhysicsConstraint);wd.HingeConstraint=HingeConstraint;var PointToPointConstraint=function(_super){function PointToPointConstraint(){_super.apply(this,arguments),this.connectedBody=null,this.pivotA=null,this.pivotB=null}return __extends(PointToPointConstraint,_super),PointToPointConstraint.create=function(){var obj=new this(null);return obj},__decorate([wd.cloneAttributeAsBasicType()],PointToPointConstraint.prototype,"connectedBody",void 0),__decorate([wd.cloneAttributeAsCloneable()],PointToPointConstraint.prototype,"pivotA",void 0),__decorate([wd.cloneAttributeAsCloneable()],PointToPointConstraint.prototype,"pivotB",void 0),PointToPointConstraint}(PhysicsConstraint);wd.PointToPointConstraint=PointToPointConstraint;var PointToPointConstraintList=function(){function PointToPointConstraintList(rigidBody){this._rigidBody=null,this._list=wdCb.Collection.create(),this._rigidBody=rigidBody}return PointToPointConstraintList.create=function(rigidBody){var obj=new this(rigidBody);return obj},PointToPointConstraintList.prototype.clone=function(rigidBody){return wd.CloneUtils.clone(this,null,[rigidBody])},PointToPointConstraintList.prototype.forEach=function(func,context){void 0===context&&(context=wd.root),this._list.forEach(func,context)},PointToPointConstraintList.prototype.getCount=function(){return this._list.getCount()},PointToPointConstraintList.prototype.getChildren=function(){return this._list},PointToPointConstraintList.prototype.getChild=function(index){return this._list.getChild(index)},PointToPointConstraintList.prototype.addChild=function(constraint){var engineAdapter=null;this._list.addChild(constraint),engineAdapter=this._rigidBody.getPhysicsEngineAdapter(),engineAdapter.addPointToPointConstraint(this._rigidBody.entityObject,constraint)},PointToPointConstraintList.prototype.addChildren=function(arg){var _this=this;if(wd.JudgeUtils.isArrayExactly(arg))for(var _i=0,_a=arg;_i<_a.length;_i++){var constraint=_a[_i];this.addChild(constraint)}else{var constraintList=arg;constraintList.forEach(function(constraint){_this.addChild(constraint)},this)}},PointToPointConstraintList.prototype.removeChild=function(constraint){var engineAdapter=null;this._list.removeChild(constraint),engineAdapter=this._rigidBody.getPhysicsEngineAdapter(),engineAdapter.removePointToPointConstraint(constraint)},__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=source[memberName].clone(!0)})],PointToPointConstraintList.prototype,"_list",void 0),PointToPointConstraintList}();wd.PointToPointConstraintList=PointToPointConstraintList}(wd||(wd={}));var wd;!function(wd){var PhysicsEngineFactory=function(){function PhysicsEngineFactory(){}return PhysicsEngineFactory.createNullAdapter=function(){return wd.NullPhysicsEngineAdapter.create()},PhysicsEngineFactory.create=function(enable,type){var result=null;if(!enable)return wd.NullPhysicsEngineAdapter.create();switch(type){case wd.EPhysicsEngineType.CANNON:result=wd.CannonAdapter.create();break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNEXPECT("physics engine type"))}return result},PhysicsEngineFactory}();wd.PhysicsEngineFactory=PhysicsEngineFactory}(wd||(wd={}));var wd;!function(wd){!function(EPhysicsEngineType){EPhysicsEngineType[EPhysicsEngineType.CANNON=0]="CANNON"}(wd.EPhysicsEngineType||(wd.EPhysicsEngineType={}));wd.EPhysicsEngineType}(wd||(wd={}));var wd;!function(wd){var NullPhysicsEngineAdapter=function(){function NullPhysicsEngineAdapter(){this.world=null}return NullPhysicsEngineAdapter.create=function(){var obj=new this;return obj},NullPhysicsEngineAdapter.prototype.getGravity=function(gravity){return null},NullPhysicsEngineAdapter.prototype.setGravity=function(gravity){},NullPhysicsEngineAdapter.prototype.getFriction=function(obj,friction){return null},NullPhysicsEngineAdapter.prototype.setFriction=function(obj,friction){},NullPhysicsEngineAdapter.prototype.getRestitution=function(obj,restitution){return null},NullPhysicsEngineAdapter.prototype.setRestitution=function(obj,restitution){},NullPhysicsEngineAdapter.prototype.getLinearDamping=function(obj){return null},NullPhysicsEngineAdapter.prototype.setLinearDamping=function(obj,linearDamping){},NullPhysicsEngineAdapter.prototype.getAngularDamping=function(obj){return null},NullPhysicsEngineAdapter.prototype.setAngularDamping=function(obj,angularDamping){},NullPhysicsEngineAdapter.prototype.getMass=function(obj){return null},NullPhysicsEngineAdapter.prototype.setMass=function(obj,mass){},NullPhysicsEngineAdapter.prototype.getVelocity=function(obj){return null},NullPhysicsEngineAdapter.prototype.setVelocity=function(obj,velocity){},NullPhysicsEngineAdapter.prototype.getAngularVelocity=function(obj){return null},NullPhysicsEngineAdapter.prototype.setAngularVelocity=function(obj,angularVelocity){},NullPhysicsEngineAdapter.prototype.init=function(){},NullPhysicsEngineAdapter.prototype.addDynamicBody=function(entityObject,data){},NullPhysicsEngineAdapter.prototype.addKinematicBody=function(entityObject,data){},NullPhysicsEngineAdapter.prototype.addStaticBody=function(entityObject,data){},NullPhysicsEngineAdapter.prototype.addLockConstraint=function(entityObject,lockConstraint){},NullPhysicsEngineAdapter.prototype.removeLockConstraint=function(entityObject){},NullPhysicsEngineAdapter.prototype.addDistanceConstraint=function(entityObject,distanceConstraint){},NullPhysicsEngineAdapter.prototype.removeDistanceConstraint=function(entityObject){},NullPhysicsEngineAdapter.prototype.addHingeConstraint=function(entityObject,hingeConstraint){},NullPhysicsEngineAdapter.prototype.removeHingeConstraint=function(entityObject){},NullPhysicsEngineAdapter.prototype.addPointToPointConstraint=function(entityObject,pointToPointConstraint){},NullPhysicsEngineAdapter.prototype.removePointToPointConstraint=function(pointToPointConstraint){},NullPhysicsEngineAdapter.prototype.removeGameObject=function(obj){},NullPhysicsEngineAdapter.prototype.removeConstraints=function(obj){},NullPhysicsEngineAdapter.prototype.update=function(elapsed){},NullPhysicsEngineAdapter}();wd.NullPhysicsEngineAdapter=NullPhysicsEngineAdapter}(wd||(wd={}));var wd;!function(wd){var CannonDataList=function(){function CannonDataList(){this.dataList=wdCb.Collection.create()}return CannonDataList.prototype.getCount=function(){return this.dataList.getCount()},CannonDataList.prototype.removeByGameObject=function(obj){this.dataList.removeChild(function(_a){var entityObject=_a.entityObject;_a.body;return wd.JudgeUtils.isEqual(entityObject,obj)})},CannonDataList}();wd.CannonDataList=CannonDataList}(wd||(wd={}));var wd;!function(wd){var CannonGameObjectDataList=function(_super){function CannonGameObjectDataList(){_super.apply(this,arguments)}return __extends(CannonGameObjectDataList,_super),CannonGameObjectDataList.create=function(){var obj=new this;return obj},CannonGameObjectDataList.prototype.remove=function(obj){this.removeByGameObject(obj)},CannonGameObjectDataList.prototype.updateBodyTransformData=function(){this.dataList.forEach(function(_a){var entityObject=_a.entityObject,body=_a.body,transform=entityObject.transform;(transform.isTranslate||transform.isRotate)&&(body.position=wd.CannonUtils.convertToCannonVector3(entityObject.transform.position),body.quaternion=wd.CannonUtils.convertToCannonQuaternion(entityObject.transform.rotation))})},CannonGameObjectDataList.prototype.updateGameObjectTransformData=function(){this.dataList.forEach(function(_a){var entityObject=_a.entityObject,body=_a.body;entityObject.hasTag("isRigidbodyChild")||(entityObject.transform.position=wd.CannonUtils.convertToWonderVector3(body.position),entityObject.transform.rotation=wd.CannonUtils.convertToWonderQuaternion(body.quaternion))})},CannonGameObjectDataList.prototype.add=function(obj,body){this.dataList.addChild({entityObject:obj,body:body})},CannonGameObjectDataList.prototype.findGameObjectByBody=function(b){var result=this.dataList.findOne(function(_a){var body=(_a.entityObject,_a.body);return body===b});return null!==result?result.entityObject:null},CannonGameObjectDataList.prototype.findBodyByGameObject=function(obj){var result=this.dataList.findOne(function(_a){var entityObject=_a.entityObject;_a.body;return wd.JudgeUtils.isEqual(entityObject,obj)});return null!==result?result.body:null},CannonGameObjectDataList}(wd.CannonDataList);wd.CannonGameObjectDataList=CannonGameObjectDataList}(wd||(wd={}));var wd;!function(wd){var CannonMaterialList=function(_super){function CannonMaterialList(){_super.apply(this,arguments)}return __extends(CannonMaterialList,_super),CannonMaterialList.create=function(){var obj=new this;return obj},CannonMaterialList.prototype.remove=function(obj){this.removeByGameObject(obj)},CannonMaterialList.prototype.findMaterialByGameObject=function(obj){var result=this.dataList.findOne(function(_a){var entityObject=_a.entityObject;_a.material;return wd.JudgeUtils.isEqual(entityObject,obj)});return null!==result?result.material:null},CannonMaterialList.prototype.add=function(obj,material){this.dataList.addChild({entityObject:obj,material:material})},CannonMaterialList.prototype.addContactMaterial=function(world,currentMaterial,friction,restitution){this.dataList.forEach(function(_a){var material=(_a.entityObject,_a.material);world.addContactMaterial(new CANNON.ContactMaterial(material,currentMaterial,{friction:friction,restitution:restitution}))})},CannonMaterialList.prototype.getContactMaterialData=function(world,currentMaterial,dataName){var result=null;return this.dataList.forEach(function(_a){var material=(_a.entityObject,_a.material),contactMaterial=world.getContactMaterial(material,currentMaterial);if(contactMaterial)return result=contactMaterial[dataName],wdCb.$BREAK}),result},CannonMaterialList.prototype.getContactMaterials=function(world,currentMaterial){var resultArr=[];return this.dataList.forEach(function(_a){var material=(_a.entityObject,_a.material),contactMaterial=world.getContactMaterial(material,currentMaterial);contactMaterial&&resultArr.push(contactMaterial)}),resultArr},CannonMaterialList.prototype.setContactMaterialData=function(world,currentMaterial,dataName,data){this.dataList.forEach(function(_a){var material=(_a.entityObject,_a.material),contactMaterial=world.getContactMaterial(material,currentMaterial);contactMaterial&&(contactMaterial[dataName]=data)})},CannonMaterialList}(wd.CannonDataList);wd.CannonMaterialList=CannonMaterialList}(wd||(wd={}));var wd;!function(wd){var CannonConstraintDataList=function(_super){function CannonConstraintDataList(){_super.apply(this,arguments)}return __extends(CannonConstraintDataList,_super),CannonConstraintDataList}(wd.CannonDataList);wd.CannonConstraintDataList=CannonConstraintDataList}(wd||(wd={}));var wd;!function(wd){var CannonSingleConstraintDataList=function(_super){function CannonSingleConstraintDataList(){_super.apply(this,arguments)}return __extends(CannonSingleConstraintDataList,_super),CannonSingleConstraintDataList.prototype.add=function(obj,constraint){this.dataList.addChild({entityObject:obj,constraint:constraint})},CannonSingleConstraintDataList.prototype.remove=function(obj){this.removeByGameObject(obj)},CannonSingleConstraintDataList.prototype.findConstraintByGameObject=function(obj){var result=this.dataList.findOne(function(_a){var entityObject=_a.entityObject;return wd.JudgeUtils.isEqual(entityObject,obj)});return null!==result?result.constraint:null},CannonSingleConstraintDataList}(wd.CannonConstraintDataList);wd.CannonSingleConstraintDataList=CannonSingleConstraintDataList}(wd||(wd={}));var wd;!function(wd){
var CannonLockConstraintDataList=function(_super){function CannonLockConstraintDataList(){_super.apply(this,arguments)}return __extends(CannonLockConstraintDataList,_super),CannonLockConstraintDataList.create=function(){var obj=new this;return obj},CannonLockConstraintDataList}(wd.CannonSingleConstraintDataList);wd.CannonLockConstraintDataList=CannonLockConstraintDataList}(wd||(wd={}));var wd;!function(wd){var CannonPointToPointConstraintDataList=function(_super){function CannonPointToPointConstraintDataList(){_super.apply(this,arguments)}return __extends(CannonPointToPointConstraintDataList,_super),CannonPointToPointConstraintDataList.create=function(){var obj=new this;return obj},CannonPointToPointConstraintDataList.prototype.filter=function(func){return this.dataList.filter(func)},CannonPointToPointConstraintDataList.prototype.forEach=function(func){this.dataList.forEach(func)},CannonPointToPointConstraintDataList.prototype.add=function(entityObject,pointToPointConstraint,constraint){this.dataList.addChild({entityObject:entityObject,pointToPointConstraint:pointToPointConstraint,cannonConstraint:constraint})},CannonPointToPointConstraintDataList.prototype.remove=function(constraint){this.dataList.removeChild(function(_a){var pointToPointConstraint=_a.pointToPointConstraint;return wd.JudgeUtils.isEqual(pointToPointConstraint,constraint)})},CannonPointToPointConstraintDataList.prototype.findCannonConstraintByPointToPointConstraint=function(constraint){var result=this.dataList.findOne(function(_a){var pointToPointConstraint=_a.pointToPointConstraint;return wd.JudgeUtils.isEqual(pointToPointConstraint,constraint)});return null!==result?result.cannonConstraint:null},CannonPointToPointConstraintDataList}(wd.CannonConstraintDataList);wd.CannonPointToPointConstraintDataList=CannonPointToPointConstraintDataList}(wd||(wd={}));var wd;!function(wd){var CannonDistanceConstraintDataList=function(_super){function CannonDistanceConstraintDataList(){_super.apply(this,arguments)}return __extends(CannonDistanceConstraintDataList,_super),CannonDistanceConstraintDataList.create=function(){var obj=new this;return obj},CannonDistanceConstraintDataList}(wd.CannonSingleConstraintDataList);wd.CannonDistanceConstraintDataList=CannonDistanceConstraintDataList}(wd||(wd={}));var wd;!function(wd){var CannonHingeConstraintDataList=function(_super){function CannonHingeConstraintDataList(){_super.apply(this,arguments)}return __extends(CannonHingeConstraintDataList,_super),CannonHingeConstraintDataList.create=function(){var obj=new this;return obj},CannonHingeConstraintDataList}(wd.CannonSingleConstraintDataList);wd.CannonHingeConstraintDataList=CannonHingeConstraintDataList}(wd||(wd={}));var wd;!function(wd){var CannonUtils=function(){function CannonUtils(){}return CannonUtils.convertToCannonVector3=function(v){return new CANNON.Vec3(v.x,v.y,v.z)},CannonUtils.convertToCannonQuaternion=function(rotation){return new CANNON.Quaternion(rotation.x,rotation.y,rotation.z,rotation.w)},CannonUtils.convertToWonderVector3=function(v){return wd.Vector3.create(v.x,v.y,v.z)},CannonUtils.convertToWonderQuaternion=function(r){return wd.Quaternion.create(r.x,r.y,r.z,r.w)},CannonUtils}();wd.CannonUtils=CannonUtils}(wd||(wd={}));var wd;!function(wd){var CannonAdapter=function(){function CannonAdapter(){this.world=null,this._materialList=wd.CannonMaterialList.create(),this._gameObjectDataList=wd.CannonGameObjectDataList.create(),this._lockConstraintDataList=wd.CannonLockConstraintDataList.create(),this._distanceConstraintDataList=wd.CannonDistanceConstraintDataList.create(),this._hingeConstraintDataList=wd.CannonHingeConstraintDataList.create(),this._pointToPointConstraintDataList=wd.CannonPointToPointConstraintDataList.create(),this._dynamicBody=null,this._kinematicBody=null,this._staticBody=null,this._lockConstraint=null,this._distanceConstraint=null,this._hingeConstraint=null,this._pointToPointConstraint=null}return CannonAdapter.create=function(){var obj=new this;return obj},CannonAdapter.prototype.getGravity=function(gravity){return wd.CannonUtils.convertToWonderVector3(this.world.gravity)},CannonAdapter.prototype.setGravity=function(gravity){this.world.gravity=wd.CannonUtils.convertToCannonVector3(gravity)},CannonAdapter.prototype.getFriction=function(obj,friction){return this._getMaterialData(obj,"friction")},CannonAdapter.prototype.setFriction=function(obj,friction){this._setMaterialData(obj,"friction",friction)},CannonAdapter.prototype.getRestitution=function(obj,restitution){return this._getMaterialData(obj,"restitution")},CannonAdapter.prototype.setRestitution=function(obj,restitution){this._setMaterialData(obj,"restitution",restitution)},CannonAdapter.prototype.getLinearDamping=function(obj){return this._getNumberData(obj,"linearDamping")},CannonAdapter.prototype.setLinearDamping=function(obj,linearDamping){return this._setNumberData(obj,"linearDamping",linearDamping)},CannonAdapter.prototype.getAngularDamping=function(obj){return this._getNumberData(obj,"angularDamping")},CannonAdapter.prototype.setAngularDamping=function(obj,angularDamping){return this._setNumberData(obj,"angularDamping",angularDamping)},CannonAdapter.prototype.getMass=function(obj){return this._getNumberData(obj,"mass")},CannonAdapter.prototype.setMass=function(obj,mass){return this._setNumberData(obj,"mass",mass)},CannonAdapter.prototype.getVelocity=function(obj){return this._getVec3Data(obj,"velocity")},CannonAdapter.prototype.setVelocity=function(obj,velocity){this._setVec3Data(obj,"velocity",velocity)},CannonAdapter.prototype.getAngularVelocity=function(obj){return this._getVec3Data(obj,"angularVelocity")},CannonAdapter.prototype.setAngularVelocity=function(obj,angularVelocity){this._setVec3Data(obj,"angularVelocity",angularVelocity)},CannonAdapter.prototype.init=function(){var _a=wd.Director.getInstance().scene.physics,gravity=_a.gravity,iterations=_a.iterations;this.world=new CANNON.World,this.world.broadphase=new CANNON.NaiveBroadphase,this.world.solver.iterations=iterations,this.world.gravity.set(gravity.x,gravity.y,gravity.z),this._dynamicBody=wd.CannonDynamicBody.create(this.world,this._gameObjectDataList,this._materialList),this._kinematicBody=wd.CannonKinematicBody.create(this.world,this._gameObjectDataList,this._materialList),this._staticBody=wd.CannonStaticBody.create(this.world,this._gameObjectDataList,this._materialList),this._lockConstraint=wd.CannonLockConstraint.create(this.world,this._gameObjectDataList,this._lockConstraintDataList),this._distanceConstraint=wd.CannonDistanceConstraint.create(this.world,this._gameObjectDataList,this._distanceConstraintDataList),this._hingeConstraint=wd.CannonHingeConstraint.create(this.world,this._gameObjectDataList,this._hingeConstraintDataList),this._pointToPointConstraint=wd.CannonPointToPointConstraint.create(this.world,this._gameObjectDataList,this._pointToPointConstraintDataList)},CannonAdapter.prototype.addDynamicBody=function(entityObject,data){this._dynamicBody.addBody(entityObject,data)},CannonAdapter.prototype.addKinematicBody=function(entityObject,data){this._kinematicBody.addBody(entityObject,data)},CannonAdapter.prototype.addStaticBody=function(entityObject,data){this._staticBody.addBody(entityObject,data)},CannonAdapter.prototype.addLockConstraint=function(entityObject,lockConstraint){this._lockConstraint.addConstraint(entityObject,lockConstraint)},CannonAdapter.prototype.removeLockConstraint=function(entityObject){this._lockConstraint.removeConstraint(entityObject)},CannonAdapter.prototype.addDistanceConstraint=function(entityObject,distanceConstraint){this._distanceConstraint.addConstraint(entityObject,distanceConstraint)},CannonAdapter.prototype.removeDistanceConstraint=function(entityObject){this._distanceConstraint.removeConstraint(entityObject)},CannonAdapter.prototype.addHingeConstraint=function(entityObject,hingeConstraint){this._hingeConstraint.addConstraint(entityObject,hingeConstraint)},CannonAdapter.prototype.removeHingeConstraint=function(entityObject){this._hingeConstraint.removeConstraint(entityObject)},CannonAdapter.prototype.addPointToPointConstraint=function(entityObject,pointToPointConstraint){this._pointToPointConstraint.addConstraint(entityObject,pointToPointConstraint)},CannonAdapter.prototype.removePointToPointConstraint=function(pointToPointConstraint){this._pointToPointConstraint.removeConstraint(pointToPointConstraint)},CannonAdapter.prototype.removeGameObject=function(obj){var body=(this._getMaterial(obj),this._gameObjectDataList.findBodyByGameObject(obj));body&&this.world.remove(body),this._gameObjectDataList.remove(obj),this._materialList.remove(obj)},CannonAdapter.prototype.removeConstraints=function(obj){var self=this;this._lockConstraint.removeConstraint(obj),this._distanceConstraint.removeConstraint(obj),this._hingeConstraint.removeConstraint(obj),this._pointToPointConstraintDataList.filter(function(_a){var entityObject=_a.entityObject;return wd.JudgeUtils.isEqual(entityObject,obj)}).forEach(function(_a){var pointToPointConstraint=_a.pointToPointConstraint;self._pointToPointConstraint.removeConstraint(pointToPointConstraint)})},CannonAdapter.prototype.update=function(elapsed){this._gameObjectDataList.updateBodyTransformData(),this.world.step(wd.Director.getInstance().getDeltaTime()/1e3),this._gameObjectDataList.updateGameObjectTransformData()},CannonAdapter.prototype._getMaterial=function(obj){return this._materialList.findMaterialByGameObject(obj)},CannonAdapter.prototype._getNumberData=function(obj,dataName){var body=this._gameObjectDataList.findBodyByGameObject(obj);return body?body[dataName]:null},CannonAdapter.prototype._setNumberData=function(obj,dataName,data){var body=this._gameObjectDataList.findBodyByGameObject(obj);return body?void(body[dataName]=data):null},CannonAdapter.prototype._getVec3Data=function(obj,dataName){var body=this._gameObjectDataList.findBodyByGameObject(obj);return body?wd.CannonUtils.convertToWonderVector3(body[dataName]):null},CannonAdapter.prototype._setVec3Data=function(obj,dataName,data){var body=this._gameObjectDataList.findBodyByGameObject(obj);return body?void(body[dataName]=wd.CannonUtils.convertToCannonVector3(data)):null},CannonAdapter.prototype._getMaterialData=function(obj,dataName){var currentMaterial=this._getMaterial(obj);return currentMaterial?this._materialList.getContactMaterialData(this.world,currentMaterial,dataName):null},CannonAdapter.prototype._setMaterialData=function(obj,dataName,data){var currentMaterial=(this.world,this._getMaterial(obj));return currentMaterial?void this._materialList.setContactMaterialData(this.world,currentMaterial,dataName,data):void wd.Log.warn("no material find, please add material first")},__decorate([wd.require(function(obj,dataName){var resultArr=[],firstData=null,currentMaterial=this._getMaterial(obj);if(!currentMaterial)return null;resultArr=this._materialList.getContactMaterials(this.world,currentMaterial),firstData=resultArr[0];for(var _i=0,resultArr_1=resultArr;_i<resultArr_1.length;_i++){var data=resultArr_1[_i];wd.assert(data===firstData,wd.Log.info.FUNC_SHOULD("the data of contact material which contains the same material","be the same"))}})],CannonAdapter.prototype,"_getMaterialData",null),CannonAdapter}();wd.CannonAdapter=CannonAdapter}(wd||(wd={}));var wd;!function(wd){var CannonBody=function(){function CannonBody(world,gameObjectDataList,materialList){this.world=null,this.materialList=null,this.gameObjectList=null,this.world=world,this.gameObjectList=gameObjectDataList,this.materialList=materialList}return CannonBody.prototype.addBody=function(entityObject,data){var body=this.createBody(data);return data.children.getCount()>0?this._addCompounds(entityObject,data.children,body):body.addShape(this._createShape(entityObject.getComponent(wd.Collider).shape)),this.afterAddShape(body,data),body.material=this._createMaterial(entityObject,data.friction,data.restitution),body.position=wd.CannonUtils.convertToCannonVector3(data.position),body.quaternion=wd.CannonUtils.convertToCannonQuaternion(data.rotation),this.world.addBody(body),this.gameObjectList.add(entityObject,body),this._bindCollideEvent(body,data.onCollisionStart,data.onContact,data.onCollisionEnd),body},CannonBody.prototype.afterAddShape=function(body,data){},CannonBody.prototype._createShape=function(shape){var cannonShape=null;return shape instanceof wd.AABBShape?cannonShape=new CANNON.Box(wd.CannonUtils.convertToCannonVector3(shape.halfExtents)):shape instanceof wd.SphereShape&&(cannonShape=new CANNON.Sphere(shape.radius)),cannonShape},CannonBody.prototype._bindCollideEvent=function(targetBody,onCollisionStart,onContact,onCollisionEnd){var self=this;targetBody.addEventListener("collide",function(e){var entityObject=self.gameObjectList.findGameObjectByBody(e.body),collideObject=null;entityObject&&(collideObject=entityObject,onCollisionStart(collideObject),onContact(collideObject),onCollisionEnd(collideObject))})},CannonBody.prototype._createMaterial=function(entityObject,friction,restitution){var material=null,currentMaterial=null;return(material=this._getMaterial(entityObject))?material:(currentMaterial=new CANNON.Material("material"),this._addMaterial(entityObject,currentMaterial,friction,restitution),currentMaterial)},CannonBody.prototype._getMaterial=function(obj){return this.materialList.findMaterialByGameObject(obj)},CannonBody.prototype._addMaterial=function(entityObject,currentMaterial,friction,restitution){this.materialList.add(entityObject,currentMaterial),this.materialList.addContactMaterial(this.world,currentMaterial,friction,restitution)},CannonBody.prototype._addCompounds=function(entityObject,children,body){var _this=this,position=entityObject.transform.position,rotation=entityObject.transform.rotation;children.forEach(function(child){body.addShape(_this._createShape(child.getComponent(wd.Collider).shape),wd.CannonUtils.convertToCannonVector3(child.transform.position.clone().sub(position)),wd.CannonUtils.convertToCannonQuaternion(child.transform.rotation.clone().sub(rotation)))},this)},__decorate([wd.virtual],CannonBody.prototype,"afterAddShape",null),__decorate([wd.require(function(entityObject,children,body){children.forEach(function(child){wd.assert(!!child.getComponent(wd.Collider),wd.Log.info.FUNC_MUST_DEFINE("collider component")),wd.assert(!!child.getComponent(wd.Collider).shape,wd.Log.info.FUNC_SHOULD("create collider.shape"))})})],CannonBody.prototype,"_addCompounds",null),CannonBody}();wd.CannonBody=CannonBody}(wd||(wd={}));var wd;!function(wd){var CannonDynamicBody=function(_super){function CannonDynamicBody(){_super.apply(this,arguments)}return __extends(CannonDynamicBody,_super),CannonDynamicBody.create=function(world,gameObjectDataList,materialList){var obj=new this(world,gameObjectDataList,materialList);return obj},CannonDynamicBody.prototype.createBody=function(_a){var mass=_a.mass,linearDamping=_a.linearDamping,angularDamping=_a.angularDamping,velocity=_a.velocity,angularVelocity=_a.angularVelocity;return new CANNON.Body({mass:mass,linearDamping:linearDamping,angularDamping:angularDamping,velocity:wd.CannonUtils.convertToCannonVector3(velocity),angularVelocity:wd.CannonUtils.convertToCannonVector3(angularVelocity)})},CannonDynamicBody.prototype.afterAddShape=function(body,_a){var impulse=_a.impulse,force=_a.force,hitPoint=_a.hitPoint;impulse&&hitPoint&&body.applyImpulse(wd.CannonUtils.convertToCannonVector3(impulse),wd.CannonUtils.convertToCannonVector3(hitPoint)),force&&hitPoint&&body.applyForce(wd.CannonUtils.convertToCannonVector3(force),wd.CannonUtils.convertToCannonVector3(hitPoint))},CannonDynamicBody}(wd.CannonBody);wd.CannonDynamicBody=CannonDynamicBody}(wd||(wd={}));var wd;!function(wd){var CannonKinematicBody=function(_super){function CannonKinematicBody(){_super.apply(this,arguments)}return __extends(CannonKinematicBody,_super),CannonKinematicBody.create=function(world,gameObjectDataList,materialList){var obj=new this(world,gameObjectDataList,materialList);return obj},CannonKinematicBody.prototype.createBody=function(_a){var mass=_a.mass,velocity=_a.velocity,angularVelocity=_a.angularVelocity;return new CANNON.Body({type:CANNON.Body.KINEMATIC,mass:mass,velocity:wd.CannonUtils.convertToCannonVector3(velocity),angularVelocity:wd.CannonUtils.convertToCannonVector3(angularVelocity)})},CannonKinematicBody}(wd.CannonBody);wd.CannonKinematicBody=CannonKinematicBody}(wd||(wd={}));var wd;!function(wd){var CannonStaticBody=function(_super){function CannonStaticBody(){_super.apply(this,arguments)}return __extends(CannonStaticBody,_super),CannonStaticBody.create=function(world,gameObjectDataList,materialList){var obj=new this(world,gameObjectDataList,materialList);return obj},CannonStaticBody.prototype.createBody=function(_a){return new CANNON.Body({mass:0})},CannonStaticBody}(wd.CannonBody);wd.CannonStaticBody=CannonStaticBody}(wd||(wd={}));var wd;!function(wd){var CannonConstraint=function(){function CannonConstraint(world,gameObjectDataList,constraintDataList){this.world=null,this.gameObjectList=null,this.constraintDataList=null,this.world=world,this.gameObjectList=gameObjectDataList,this.constraintDataList=constraintDataList}return CannonConstraint.prototype.addConstraint=function(entityObject,wonderConstraint){var constraint=null,body=this.gameObjectList.findBodyByGameObject(entityObject);constraint=this.createCannonConstraint(body,wonderConstraint),this.world.addConstraint(constraint),this.addToConstraintDataList(entityObject,wonderConstraint,constraint)},CannonConstraint.prototype.findBody=function(rigidBody){return this.gameObjectList.findBodyByGameObject(rigidBody.entityObject)},__decorate([wd.require(function(entityObject,pointToPointConstraint){wd.assert(null!==this.gameObjectList.findBodyByGameObject(entityObject),wd.Log.info.FUNC_SHOULD("add rigid body")),wd.assert(this.findBody(pointToPointConstraint.connectedBody),wd.Log.info.FUNC_SHOULD("add connectedBody"))})],CannonConstraint.prototype,"addConstraint",null),CannonConstraint}();wd.CannonConstraint=CannonConstraint}(wd||(wd={}));var wd;!function(wd){var CannonSingleConstraint=function(_super){function CannonSingleConstraint(){_super.apply(this,arguments)}return __extends(CannonSingleConstraint,_super),CannonSingleConstraint.prototype.removeConstraint=function(entityObject){var constraint=this.constraintDataList.findConstraintByGameObject(entityObject);constraint&&this.world.removeConstraint(constraint),this.constraintDataList.remove(entityObject)},CannonSingleConstraint.prototype.addToConstraintDataList=function(entityObject,wonderConstraint,cannonConstraint){this.constraintDataList.add(entityObject,cannonConstraint)},CannonSingleConstraint}(wd.CannonConstraint);wd.CannonSingleConstraint=CannonSingleConstraint}(wd||(wd={}));var wd;!function(wd){var CannonLockConstraint=function(_super){function CannonLockConstraint(){_super.apply(this,arguments)}return __extends(CannonLockConstraint,_super),CannonLockConstraint.create=function(world,gameObjectDataList,constraintDataList){var obj=new this(world,gameObjectDataList,constraintDataList);return obj},CannonLockConstraint.prototype.createCannonConstraint=function(body,lockConstraint){var constraint=null,connectedBody=this.findBody(lockConstraint.connectedBody);return constraint=lockConstraint.maxForce?new CANNON.LockConstraint(body,connectedBody,lockConstraint.maxForce):new CANNON.LockConstraint(body,connectedBody)},CannonLockConstraint}(wd.CannonSingleConstraint);wd.CannonLockConstraint=CannonLockConstraint}(wd||(wd={}));var wd;!function(wd){var CannonPointToPointConstraint=function(_super){function CannonPointToPointConstraint(){_super.apply(this,arguments)}return __extends(CannonPointToPointConstraint,_super),CannonPointToPointConstraint.create=function(world,gameObjectDataList,constraintDataList){var obj=new this(world,gameObjectDataList,constraintDataList);return obj},CannonPointToPointConstraint.prototype.removeConstraint=function(pointToPointConstraint){var constraint=this.constraintDataList.findCannonConstraintByPointToPointConstraint(pointToPointConstraint);constraint&&this.world.removeConstraint(constraint),this.constraintDataList.remove(pointToPointConstraint)},CannonPointToPointConstraint.prototype.createCannonConstraint=function(body,pointToPointConstraint){var constraint=null,connectedBody=this.findBody(pointToPointConstraint.connectedBody),pivotA=wd.CannonUtils.convertToCannonVector3(pointToPointConstraint.pivotA),pivotB=wd.CannonUtils.convertToCannonVector3(pointToPointConstraint.pivotB);return constraint=pointToPointConstraint.maxForce?new CANNON.PointToPointConstraint(body,pivotA,connectedBody,pivotB,pointToPointConstraint.maxForce):new CANNON.PointToPointConstraint(body,pivotA,connectedBody,pivotB)},CannonPointToPointConstraint.prototype.addToConstraintDataList=function(entityObject,wonderConstraint,cannonConstraint){this.constraintDataList.add(entityObject,wonderConstraint,cannonConstraint)},CannonPointToPointConstraint}(wd.CannonConstraint);wd.CannonPointToPointConstraint=CannonPointToPointConstraint}(wd||(wd={}));var wd;!function(wd){var CannonDistanceConstraint=function(_super){function CannonDistanceConstraint(){_super.apply(this,arguments)}return __extends(CannonDistanceConstraint,_super),CannonDistanceConstraint.create=function(world,gameObjectDataList,constraintDataList){var obj=new this(world,gameObjectDataList,constraintDataList);return obj},CannonDistanceConstraint.prototype.createCannonConstraint=function(body,distanceConstraint){var constraint=null,connectedBody=this.findBody(distanceConstraint.connectedBody);return constraint=new CANNON.DistanceConstraint(body,connectedBody,null!==distanceConstraint.distance?distanceConstraint.distance:void 0,null!==distanceConstraint.maxForce?distanceConstraint.maxForce:void 0)},CannonDistanceConstraint}(wd.CannonSingleConstraint);wd.CannonDistanceConstraint=CannonDistanceConstraint}(wd||(wd={}));var wd;!function(wd){var CannonHingeConstraint=function(_super){function CannonHingeConstraint(){_super.apply(this,arguments)}return __extends(CannonHingeConstraint,_super),CannonHingeConstraint.create=function(world,gameObjectDataList,constraintDataList){var obj=new this(world,gameObjectDataList,constraintDataList);return obj},CannonHingeConstraint.prototype.createCannonConstraint=function(body,hingeConstraint){var constraint=null,connectedBody=this.findBody(hingeConstraint.connectedBody),pivotA=wd.CannonUtils.convertToCannonVector3(hingeConstraint.pivotA),axisA=wd.CannonUtils.convertToCannonVector3(hingeConstraint.axisA),pivotB=wd.CannonUtils.convertToCannonVector3(hingeConstraint.pivotB),axisB=wd.CannonUtils.convertToCannonVector3(hingeConstraint.axisB),options={};return hingeConstraint.pivotA&&(options.pivotA=pivotA),hingeConstraint.axisA&&(options.axisA=axisA),hingeConstraint.pivotB&&(options.pivotB=pivotB),hingeConstraint.axisB&&(options.axisB=axisB),hingeConstraint.maxForce&&(options.maxForce=hingeConstraint.maxForce),constraint=new CANNON.HingeConstraint(body,connectedBody,options)},CannonHingeConstraint}(wd.CannonSingleConstraint);wd.CannonHingeConstraint=CannonHingeConstraint}(wd||(wd={}));var wd;!function(wd){var Light=function(_super){function Light(){_super.apply(this,arguments),this._shadowMapWidth=null,this._shadowMapHeight=null,this.color=wd.Color.create("#ffffff"),this.castShadow=!1,this.shadowCameraNear=.1,this.shadowCameraFar=5e3,this.shadowBias=wd.ShaderChunk.NULL,this.shadowDarkness=0}return __extends(Light,_super),Object.defineProperty(Light.prototype,"position",{get:function(){return this.entityObject.transform.position},enumerable:!0,configurable:!0}),Object.defineProperty(Light.prototype,"shadowMapWidth",{get:function(){var maxCubemapTextureSize=wd.GPUDetector.getInstance().maxCubemapTextureSize;return!this._shadowMapWidth||this._shadowMapWidth>maxCubemapTextureSize?maxCubemapTextureSize:this._shadowMapWidth},set:function(shadowMapWidth){this._shadowMapWidth=shadowMapWidth},enumerable:!0,configurable:!0}),Object.defineProperty(Light.prototype,"shadowMapHeight",{get:function(){var maxCubemapTextureSize=wd.GPUDetector.getInstance().maxCubemapTextureSize;return!this._shadowMapHeight||this._shadowMapHeight>maxCubemapTextureSize?maxCubemapTextureSize:this._shadowMapHeight},set:function(shadowMapHeight){this._shadowMapHeight=shadowMapHeight},enumerable:!0,configurable:!0}),__decorate([wd.cloneAttributeAsBasicType()],Light.prototype,"shadowMapWidth",null),__decorate([wd.cloneAttributeAsBasicType()],Light.prototype,"shadowMapHeight",null),__decorate([wd.cloneAttributeAsCloneable()],Light.prototype,"color",void 0),__decorate([wd.cloneAttributeAsBasicType()],Light.prototype,"castShadow",void 0),__decorate([wd.cloneAttributeAsBasicType()],Light.prototype,"shadowCameraNear",void 0),__decorate([wd.cloneAttributeAsBasicType()],Light.prototype,"shadowCameraFar",void 0),__decorate([wd.cloneAttributeAsBasicType()],Light.prototype,"shadowBias",void 0),__decorate([wd.cloneAttributeAsBasicType()],Light.prototype,"shadowDarkness",void 0),Light}(wd.Component);wd.Light=Light}(wd||(wd={}));var wd;!function(wd){var AmbientLight=function(_super){function AmbientLight(){_super.apply(this,arguments)}return __extends(AmbientLight,_super),AmbientLight.create=function(){var obj=new this;return obj},AmbientLight.type="ambientLight",AmbientLight}(wd.Light);wd.AmbientLight=AmbientLight}(wd||(wd={}));var wd;!function(wd){var SourceLight=function(_super){function SourceLight(){_super.apply(this,arguments),this.intensity=1}return __extends(SourceLight,_super),__decorate([wd.cloneAttributeAsBasicType()],SourceLight.prototype,"intensity",void 0),SourceLight}(wd.Light);wd.SourceLight=SourceLight}(wd||(wd={}));var wd;!function(wd){var DirectionLight=function(_super){function DirectionLight(){_super.apply(this,arguments),this.shadowCameraLeft=-1e3,this.shadowCameraRight=1e3,this.shadowCameraTop=1e3,this.shadowCameraBottom=-1e3}return __extends(DirectionLight,_super),DirectionLight.create=function(){var obj=new this;return obj},DirectionLight.type="directionLight",DirectionLight.defaultPosition=wd.Vector3.create(0,0,1),__decorate([wd.cloneAttributeAsBasicType()],DirectionLight.prototype,"shadowCameraLeft",void 0),__decorate([wd.cloneAttributeAsBasicType()],DirectionLight.prototype,"shadowCameraRight",void 0),__decorate([wd.cloneAttributeAsBasicType()],DirectionLight.prototype,"shadowCameraTop",void 0),__decorate([wd.cloneAttributeAsBasicType()],DirectionLight.prototype,"shadowCameraBottom",void 0),DirectionLight}(wd.SourceLight);wd.DirectionLight=DirectionLight}(wd||(wd={}));var wd;!function(wd){var PointLight=function(_super){function PointLight(){_super.apply(this,arguments),this._rangeLevel=null,this._attenuation=wd.Attenuation.create()}return __extends(PointLight,_super),PointLight.create=function(){var obj=new this;return obj},Object.defineProperty(PointLight.prototype,"rangeLevel",{get:function(){return this._rangeLevel},set:function(rangeLevel){this._rangeLevel=rangeLevel,this._attenuation.rangeLevel=this._rangeLevel},enumerable:!0,configurable:!0}),Object.defineProperty(PointLight.prototype,"range",{get:function(){return this._attenuation.range},set:function(range){this._attenuation.range=range},enumerable:!0,configurable:!0}),Object.defineProperty(PointLight.prototype,"constant",{get:function(){return this._attenuation.constant},set:function(constant){this._attenuation.constant=constant},enumerable:!0,configurable:!0}),Object.defineProperty(PointLight.prototype,"linear",{get:function(){return this._attenuation.linear},set:function(linear){this._attenuation.linear=linear},enumerable:!0,configurable:!0}),Object.defineProperty(PointLight.prototype,"quadratic",{get:function(){return this._attenuation.quadratic},set:function(quadratic){this._attenuation.quadratic=quadratic},enumerable:!0,configurable:!0}),PointLight.type="pointLight",__decorate([wd.cloneAttributeAsBasicType()],PointLight.prototype,"rangeLevel",null),__decorate([wd.cloneAttributeAsBasicType()],PointLight.prototype,"range",null),__decorate([wd.cloneAttributeAsBasicType()],PointLight.prototype,"constant",null),__decorate([wd.cloneAttributeAsBasicType()],PointLight.prototype,"linear",null),__decorate([wd.cloneAttributeAsBasicType()],PointLight.prototype,"quadratic",null),PointLight}(wd.SourceLight);wd.PointLight=PointLight}(wd||(wd={}));var wd;!function(wd){var Attenuation=function(){function Attenuation(){this._constant=1,this._range=null,this._linear=0,this._quadratic=0,this._rangeLevel=0}return Attenuation.create=function(){var obj=new this;return obj},Object.defineProperty(Attenuation.prototype,"constant",{get:function(){return this._constant},set:function(constant){this._constant=constant},enumerable:!0,configurable:!0}),Object.defineProperty(Attenuation.prototype,"range",{get:function(){return this._range},set:function(range){this._range=range},enumerable:!0,configurable:!0}),Object.defineProperty(Attenuation.prototype,"linear",{get:function(){return this._linear},set:function(linear){this._linear=linear},enumerable:!0,configurable:!0}),Object.defineProperty(Attenuation.prototype,"quadratic",{get:function(){return this._quadratic},set:function(quadratic){this._quadratic=quadratic},enumerable:!0,configurable:!0}),Object.defineProperty(Attenuation.prototype,"rangeLevel",{get:function(){return this._rangeLevel},set:function(rangeLevel){rangeLevel&&(this._rangeLevel=rangeLevel,this.setByRangeLevel())},enumerable:!0,configurable:!0}),Attenuation.prototype.setByRangeLevel=function(){switch(this._rangeLevel){case 0:this._range=7,this._linear=.7,this._quadratic=1.8;break;case 1:this._range=13,this._linear=.35,this._quadratic=.44;break;case 2:this._range=20,this._linear=.22,this._quadratic=.2;break;case 3:this._range=32,this._linear=.14,this._quadratic=.07;break;case 4:this._range=50,this._linear=.09,this._quadratic=.032;break;case 5:this._range=65,this._linear=.07,this._quadratic=.017;break;case 6:this._range=100,this._linear=.045,this._quadratic=.0075;break;case 7:this._range=160,this._linear=.027,this._quadratic=.0028;break;case 8:this._range=200,this._linear=.022,this._quadratic=.0019;break;case 9:this._range=325,this._linear=.014,this._quadratic=7e-4;break;case 10:this._range=600,this._linear=.007,this._quadratic=2e-4;break;case 11:this._range=3250,this._linear=.0014,this._quadratic=7e-6;break;default:wd.Log.error(!0,"over light range")}},Attenuation}();wd.Attenuation=Attenuation}(wd||(wd={}));var wd;!function(wd){!function(ELightModel){ELightModel[ELightModel.PHONG="PHONG"]="PHONG",ELightModel[ELightModel.BLINN="BLINN"]="BLINN",ELightModel[ELightModel.LAMBERT="LAMBERT"]="LAMBERT",ELightModel[ELightModel.CONSTANT="CONSTANT"]="CONSTANT"}(wd.ELightModel||(wd.ELightModel={}));wd.ELightModel}(wd||(wd={}));var wd;!function(wd){var BitmapFontLayout=function(){function BitmapFontLayout(){this._layoutList=wdCb.Collection.create(),this._searchGlyph=wd.BitmapFontSearchGlyph.create()}return BitmapFontLayout.create=function(){var obj=new this;return obj},BitmapFontLayout.prototype.getLayoutData=function(text,fntId,_a){var _b=_a.width,width=void 0===_b?0:_b,_c=_a.tabSize,tabSize=void 0===_c?4:_c,_d=_a.letterSpacing,letterSpacing=void 0===_d?0:_d,_e=_a.align,align=void 0===_e?wd.EFontXAlignment.LEFT:_e,fntData=this._getFntObj(fntId);if(!fntData)return void wd.Log.log("impossible to create font: not find fnt file");this._searchGlyph.setupSpaceGlyphs(fntData,tabSize);var lines=wd.BitmapFontWordWrapper.getLines(fntData,text,this._searchGlyph,{width:width,letterSpacing:letterSpacing}),minWidth=width,maxLineWidth=null,x=0,y=0,lineHeight=fntData.commonHeight;fntData.commonBase;this._layoutList.removeAllChildren(),maxLineWidth=lines.reduce(function(prev,line){return Math.max(prev,line.width,minWidth)},0);for(var lineIndex=0,len=lines.length;lineIndex<len;lineIndex++){for(var line=lines[lineIndex],start=line.start,end=line.end,lineWidth=line.width,lastGlyph=null,i=start;i<end;i++){var id=text.charCodeAt(i),glyph=this._searchGlyph.getGlyph(fntData,id),tx=null;glyph&&(lastGlyph&&(x+=wd.BitmapFontParser.getKerning(fntData,lastGlyph.id,glyph.id)),
tx=x,align===wd.EFontXAlignment.CENTER?tx+=(maxLineWidth-lineWidth)/2:align===wd.EFontXAlignment.RIGHT&&(tx+=maxLineWidth-lineWidth),this._layoutList.addChild({position:[tx+glyph.xOffset,y+glyph.yOffset],data:glyph,index:i,line:lineIndex}),x+=glyph.xAdvance+letterSpacing,lastGlyph=glyph)}y+=lineHeight,x=0}return this._layoutList},BitmapFontLayout.prototype._getFntObj=function(fntId){return wd.LoaderManager.getInstance().get(fntId)},BitmapFontLayout}();wd.BitmapFontLayout=BitmapFontLayout}(wd||(wd={}));var wd;!function(wd){var BitmapFontParser=function(){function BitmapFontParser(){}return BitmapFontParser.getKerning=function(fntObj,left,right){if(!fntObj.kerningArray||0===fntObj.kerningArray.length)return 0;for(var table=fntObj.kerningArray,i=0;i<table.length;i++){var kern=table[i];if(kern.first===left&&kern.second===right)return kern.amount}return 0},BitmapFontParser}();wd.BitmapFontParser=BitmapFontParser}(wd||(wd={}));var wd;!function(wd){var M_WIDTHS=["m","w"],TAB_ID="\t".charCodeAt(0),SPACE_ID=" ".charCodeAt(0),BitmapFontSearchGlyph=function(){function BitmapFontSearchGlyph(){this._fallbackSpaceGlyph=null,this._fallbackTabGlyph=null}return BitmapFontSearchGlyph.create=function(){var obj=new this;return obj},BitmapFontSearchGlyph.prototype.getGlyph=function(fntObj,id){var glyph=this.getGlyphById(fntObj,id);return glyph?glyph:id===TAB_ID?this._fallbackTabGlyph:id===SPACE_ID?this._fallbackSpaceGlyph:null},BitmapFontSearchGlyph.prototype.getGlyphById=function(fntObj,id){var dict=this._getFontDefDictionary(fntObj);return dict?dict[String(id)]:null},BitmapFontSearchGlyph.prototype.setupSpaceGlyphs=function(fntObj,tabSize){if(this._getFontDefDictionary(fntObj)){var space=this.getGlyphById(fntObj,SPACE_ID)||this._getMGlyph(fntObj)||this._getFirstGlyph(fntObj),tabWidth=tabSize*space.xAdvance;this._fallbackSpaceGlyph=space,this._fallbackTabGlyph={id:String(TAB_ID),page:0,rect:{x:0,y:0,width:0,height:0},xOffset:0,yOffset:0,xAdvance:tabWidth}}},BitmapFontSearchGlyph.prototype._getMGlyph=function(fntObj){for(var glyph=null,i=0;i<M_WIDTHS.length;i++){var id=M_WIDTHS[i].charCodeAt(0),glyph_1=this.getGlyphById(fntObj,id);if(glyph_1)break}return glyph},BitmapFontSearchGlyph.prototype._getFirstGlyph=function(fntObj){var fontDefDictionary=this._getFontDefDictionary(fntObj),result=null;for(var charData in fontDefDictionary){result=fontDefDictionary[charData];break}return result},BitmapFontSearchGlyph.prototype._getFontDefDictionary=function(fntObj){return fntObj.fontDefDictionary},BitmapFontSearchGlyph}();wd.BitmapFontSearchGlyph=BitmapFontSearchGlyph}(wd||(wd={}));var wd;!function(wd){var NEWLINE_CHAR="\n",WHITESPACE=/\s/,BitmapFontWordWrapper=function(){function BitmapFontWordWrapper(){}return BitmapFontWordWrapper.getLines=function(fntObj,text,searchGlyph,_a){var letterSpacing=_a.letterSpacing,_b=_a.width,width=void 0===_b?Number.MAX_VALUE:_b,_c=_a.start,start=void 0===_c?0:_c,_d=_a.end,end=void 0===_d?text.length:_d;return this._greedy(fntObj,text,letterSpacing,searchGlyph,start,end,width)},BitmapFontWordWrapper._greedy=function(fntObj,text,letterSpacing,searchGlyph,start,end,width){for(var lines=[],testWidth=width;start<end&&start<text.length;){for(var newLine=this._findNewLineIndex(text,NEWLINE_CHAR,start,end);start<newLine&&this._isWhitespace(text.charAt(start));)start++;var measured=this._computeMetrics(fntObj,text,letterSpacing,searchGlyph,start,newLine,testWidth),lineEnd=start+(measured.end-measured.start),nextStart=lineEnd+NEWLINE_CHAR.length;if(lineEnd<newLine){for(;lineEnd>start&&!this._isWhitespace(text.charAt(lineEnd));)lineEnd--;if(lineEnd===start)nextStart>start+NEWLINE_CHAR.length&&nextStart--,lineEnd=nextStart;else for(nextStart=lineEnd;lineEnd>start&&this._isWhitespace(text.charAt(lineEnd-NEWLINE_CHAR.length));)lineEnd--}lineEnd>=start&&lines.push(this._computeMetrics(fntObj,text,letterSpacing,searchGlyph,start,lineEnd,testWidth)),start=nextStart}return lines},BitmapFontWordWrapper._computeMetrics=function(fntObj,text,letterSpacing,searchGlyph,start,end,width){var curPen=0,curWidth=0,count=0,lastGlyph=null;if(!fntObj.fontDefDictionary)return{start:start,end:start,width:0};end=Math.min(text.length,end);for(var i=start;i<end;i++){var id=text.charCodeAt(i),glyph=searchGlyph.getGlyph(fntObj,id);if(glyph){var kern=lastGlyph?wd.BitmapFontParser.getKerning(fntObj,lastGlyph.id,glyph.id):0,nextPen=null,nextWidth=null;if(curPen+=kern,nextPen=curPen+glyph.xAdvance+letterSpacing,nextWidth=curPen+glyph.rect.width,nextWidth>width||nextPen>width){0===count&&(count=1,curWidth=nextWidth);break}curPen=nextPen,curWidth=nextWidth,lastGlyph=glyph}count++}return lastGlyph&&(curWidth+=lastGlyph.xOffset),{start:start,end:start+count,width:curWidth}},BitmapFontWordWrapper._findNewLineIndex=function(text,chr,start,end){var idx=text.indexOf(chr,start);return idx===-1||idx>end?end:idx},BitmapFontWordWrapper._isWhitespace=function(chr){return WHITESPACE.test(chr)},BitmapFontWordWrapper}();wd.BitmapFontWordWrapper=BitmapFontWordWrapper}(wd||(wd={}));var wd;!function(wd){var ThreeDUI=function(_super){function ThreeDUI(){_super.apply(this,arguments)}return __extends(ThreeDUI,_super),ThreeDUI.prototype.update=function(elapsed){},ThreeDUI.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1);var engine=wd.ThreeDUIEngine.getInstance();_super.prototype.addToObject.call(this,entityObject,isShareComponent),engine.hasChild(this)||engine.addChild(this)},ThreeDUI.prototype.removeFromObject=function(entityObject){_super.prototype.removeFromObject.call(this,entityObject),wd.ThreeDUIEngine.getInstance().removeChild(this)},__decorate([wd.virtual],ThreeDUI.prototype,"update",null),__decorate([wd.require(function(entityObject){wd.expect(entityObject).instanceOf(wd.GameObject)})],ThreeDUI.prototype,"addToObject",null),ThreeDUI}(wd.Component);wd.ThreeDUI=ThreeDUI}(wd||(wd={}));var wd;!function(wd){var Line=function(_super){function Line(){_super.apply(this,arguments)}return __extends(Line,_super),Line}(wd.ThreeDUI);wd.Line=Line}(wd||(wd={}));var wd;!function(wd){var SolidLine=function(_super){function SolidLine(){_super.apply(this,arguments)}return __extends(SolidLine,_super),SolidLine.create=function(){var obj=new this;return obj},SolidLine}(wd.Line);wd.SolidLine=SolidLine}(wd||(wd={}));var wd;!function(wd){var DashLine=function(_super){function DashLine(){_super.apply(this,arguments)}return __extends(DashLine,_super),DashLine.create=function(){var obj=new this;return obj},DashLine}(wd.Line);wd.DashLine=DashLine}(wd||(wd={}));var wd;!function(wd){var Arrow=function(_super){function Arrow(){_super.apply(this,arguments)}return __extends(Arrow,_super),Arrow.create=function(){var obj=new this;return obj},Arrow}(wd.ThreeDUI);wd.Arrow=Arrow}(wd||(wd={}));var wd;!function(wd){var ThreeDFont=function(_super){function ThreeDFont(){_super.apply(this,arguments),this.needFormat=!1,this._isFirstUpdate=!0}return __extends(ThreeDFont,_super),ThreeDFont.prototype.update=function(elapsed){this._isFirstUpdate?this._isFirstUpdate=!1:this.needFormat&&this.reFormat(),this.needFormat=!1},ThreeDFont.prototype.reFormat=function(){},__decorate([wd.virtual],ThreeDFont.prototype,"reFormat",null),ThreeDFont}(wd.ThreeDUI);wd.ThreeDFont=ThreeDFont}(wd||(wd={}));var wd;!function(wd){var ThreeDBitmapFont=function(_super){function ThreeDBitmapFont(){_super.apply(this,arguments),this._text="",this._xAlignment=wd.EFontXAlignment.LEFT,this.fntId=null,this._width=null,this.height=0,this.layoutDataList=null,this._layout=wd.BitmapFontLayout.create()}return __extends(ThreeDBitmapFont,_super),ThreeDBitmapFont.create=function(){var obj=new this;return obj},Object.defineProperty(ThreeDBitmapFont.prototype,"text",{get:function(){return this._text},set:function(text){this._text!==text&&(this._text=text,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDBitmapFont.prototype,"xAlignment",{get:function(){return this._xAlignment},set:function(xAlignment){this._xAlignment!==xAlignment&&(this._xAlignment=xAlignment,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(ThreeDBitmapFont.prototype,"width",{get:function(){return this._width},set:function(width){this._width!==width&&(this._width=width,this.needFormat=!0)},enumerable:!0,configurable:!0}),ThreeDBitmapFont.prototype.init=function(){_super.prototype.init.call(this),this.layoutDataList=this._layout.getLayoutData(this.text,this.fntId,{width:this.width,align:this.xAlignment})},ThreeDBitmapFont.prototype.reFormat=function(){this.layoutDataList=this._layout.getLayoutData(this.text,this.fntId,{width:this.width,align:this.xAlignment}),this.entityObject.getComponent(wd.BitmapFontGeometry).updateBuffers()},__decorate([wd.cloneAttributeAsBasicType()],ThreeDBitmapFont.prototype,"text",null),__decorate([wd.cloneAttributeAsBasicType()],ThreeDBitmapFont.prototype,"xAlignment",null),__decorate([wd.cloneAttributeAsBasicType()],ThreeDBitmapFont.prototype,"fntId",void 0),__decorate([wd.cloneAttributeAsBasicType()],ThreeDBitmapFont.prototype,"_width",void 0),__decorate([wd.cloneAttributeAsBasicType()],ThreeDBitmapFont.prototype,"height",void 0),ThreeDBitmapFont}(wd.ThreeDFont);wd.ThreeDBitmapFont=ThreeDBitmapFont}(wd||(wd={}));var wd;!function(wd){var TwoDUI=function(_super){function TwoDUI(){_super.apply(this,arguments),this.context=null}return __extends(TwoDUI,_super),Object.defineProperty(TwoDUI.prototype,"dirty",{get:function(){var renderer=this.getUIRenderer();return!renderer||renderer.dirty},set:function(dirty){if(dirty){var renderer=this.getUIRenderer();if(!renderer)return;renderer.dirty=dirty}},enumerable:!0,configurable:!0}),Object.defineProperty(TwoDUI.prototype,"width",{get:function(){return this.entityObject?this.entityObject.transform.width:null},enumerable:!0,configurable:!0}),Object.defineProperty(TwoDUI.prototype,"height",{get:function(){return this.entityObject?this.entityObject.transform.height:null},enumerable:!0,configurable:!0}),TwoDUI.prototype.update=function(elapsed){},TwoDUI.prototype.init=function(){this.context=this.getContext()},TwoDUI.prototype.addToObject=function(entityObject,isShareComponent){void 0===isShareComponent&&(isShareComponent=!1);var engine=wd.TwoDUIEngine.getInstance();_super.prototype.addToObject.call(this,entityObject,isShareComponent),engine.hasChild(this)||engine.addChild(this)},TwoDUI.prototype.removeFromObject=function(entityObject){_super.prototype.removeFromObject.call(this,entityObject),wd.TwoDUIEngine.getInstance().removeChild(this)},TwoDUI.prototype.render=function(){var context=this.context;this.shouldNotRender()||(context.save(),this._setCanvasTransformForRotation(),this.draw(),context.restore())},TwoDUI.prototype.draw=function(){},TwoDUI.prototype.shouldNotRender=function(){return!1},TwoDUI.prototype.getContext=function(){return this.getUIRenderer().context},TwoDUI.prototype.getCanvas=function(){return this.getUIRenderer().canvas},TwoDUI.prototype.getUIRenderer=function(){return this.entityObject?this.entityObject.getComponent(wd.UIRenderer):null},TwoDUI.prototype.drawInCenterPoint=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var context=args[0],source=args[1];if(5===args.length){var position=args[2],width=args[3],height=args[4];context.drawImage(source,position.x-width/2,position.y-height/2,width,height)}else if(9===args.length){var sx=args[2],sy=args[3],sw=args[4],sh=args[5],position=args[6],width=args[7],height=args[8];context.drawImage(source,sx,sy,sw,sh,position.x-width/2,position.y-height/2,width,height)}},TwoDUI.prototype._setCanvasTransformForRotation=function(){var matrix=this.entityObject.transform.rotationMatrix;this.context.setTransform(matrix.a,matrix.b,matrix.c,matrix.d,matrix.tx,matrix.ty)},__decorate([wd.virtual],TwoDUI.prototype,"dirty",null),__decorate([wd.virtual],TwoDUI.prototype,"update",null),__decorate([wd.require(function(entityObject){wd.expect(entityObject).instanceOf(wd.UIObject)})],TwoDUI.prototype,"addToObject",null),__decorate([wd.require(function(){wd.assert(null!==this.context,wd.Log.info.FUNC_SHOULD("set context"))})],TwoDUI.prototype,"render",null),__decorate([wd.virtual],TwoDUI.prototype,"draw",null),__decorate([wd.virtual],TwoDUI.prototype,"shouldNotRender",null),TwoDUI}(wd.Component);wd.TwoDUI=TwoDUI}(wd||(wd={}));var wd;!function(wd){!function(EFontXAlignment){EFontXAlignment[EFontXAlignment.LEFT=0]="LEFT",EFontXAlignment[EFontXAlignment.CENTER=1]="CENTER",EFontXAlignment[EFontXAlignment.RIGHT=2]="RIGHT"}(wd.EFontXAlignment||(wd.EFontXAlignment={}));wd.EFontXAlignment}(wd||(wd={}));var wd;!function(wd){!function(EFontYAlignment){EFontYAlignment[EFontYAlignment.TOP=0]="TOP",EFontYAlignment[EFontYAlignment.MIDDLE=1]="MIDDLE",EFontYAlignment[EFontYAlignment.BOTTOM=2]="BOTTOM"}(wd.EFontYAlignment||(wd.EFontYAlignment={}));wd.EFontYAlignment}(wd||(wd={}));var wd;!function(wd){!function(EFontDimension){EFontDimension[EFontDimension.AUTO="auto"]="AUTO"}(wd.EFontDimension||(wd.EFontDimension={}));wd.EFontDimension}(wd||(wd={}));var wd;!function(wd){var TwoDFont=function(_super){function TwoDFont(){_super.apply(this,arguments),this.needFormat=!1,this._isFirstUpdate=!0,this._sizeChangeEventSubscription=null}return __extends(TwoDFont,_super),TwoDFont.prototype.init=function(){var self=this;_super.prototype.init.call(this),this._sizeChangeEventSubscription=wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.UI_WIDTH_CHANGE).merge(wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.UI_HEIGHT_CHANGE)).subscribe(function(){self.dirty=!0,self.needFormat=!0})},TwoDFont.prototype.dispose=function(){this._sizeChangeEventSubscription&&this._sizeChangeEventSubscription.dispose()},TwoDFont.prototype.update=function(elapsed){this._isFirstUpdate?this._isFirstUpdate=!1:this.needFormat&&this.reFormat(),this.needFormat=!1},TwoDFont.prototype.reFormat=function(){},TwoDFont.prototype.getLeftCornerPosition=function(){var transform=this.entityObject.transform,position=transform.position;return wd.Vector2.create(position.x-transform.width/2,position.y-transform.height/2)},__decorate([wd.virtual],TwoDFont.prototype,"reFormat",null),TwoDFont}(wd.TwoDUI);wd.TwoDFont=TwoDFont}(wd||(wd={}));var wd;!function(wd){var WORD_REX=/([a-zA-Z0-9]+|\S)/,FIRST_ENGLISH_OR_NUM=/^[a-zA-Z0-9]/,LAST_ENGLISH_OR_NUM=/[a-zA-Z0-9]+$/,LAST_INVALID_CHAR=/\s+$/,PlainFont=function(_super){function PlainFont(){_super.apply(this,arguments),this._text="",this._fontSize=10,this._fontFamily="sans-serif",this._xAlignment=wd.EFontXAlignment.LEFT,this._yAlignment=wd.EFontYAlignment.TOP,this._fillEnabled=!0,this._fillStyle="rgba(0, 0, 0, 1)",this._strokeEnabled=!1,this._strokeStyle=null,this._strokeSize=null,this._fontClientHeightCache=wdCb.Hash.create(),this._lineHeight=null,this._strArr=[]}return __extends(PlainFont,_super),PlainFont.create=function(){var obj=new this;return obj},Object.defineProperty(PlainFont.prototype,"text",{get:function(){return this._text},set:function(text){this._text!==text&&(this._text=text,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(PlainFont.prototype,"fontSize",{get:function(){return this._fontSize},set:function(fontSize){this._fontSize!==fontSize&&(this._fontSize=fontSize,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(PlainFont.prototype,"fontFamily",{get:function(){return this._fontFamily},set:function(fontFamily){this._fontFamily!==fontFamily&&(this._fontFamily=fontFamily,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(PlainFont.prototype,"xAlignment",{get:function(){return this._xAlignment},set:function(xAlignment){this._xAlignment!==xAlignment&&(this._xAlignment=xAlignment,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(PlainFont.prototype,"yAlignment",{get:function(){return this._yAlignment},set:function(yAlignment){this._yAlignment!==yAlignment&&(this._yAlignment=yAlignment,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),PlainFont.prototype.init=function(){_super.prototype.init.call(this),this._formatText(),this._lineHeight||(this._lineHeight=this._getDefaultLineHeight())},PlainFont.prototype.setFillStyle=function(fillStyle){this._fillStyle=fillStyle},PlainFont.prototype.enableStroke=function(strokeStyle,strokeSize){this._strokeEnabled=!0,this._fillEnabled=!1,this._strokeStyle=strokeStyle,this._strokeSize=strokeSize},PlainFont.prototype.enableFill=function(fillStyle){this._fillEnabled=!0,this._strokeEnabled=!1,this._fillStyle=fillStyle},PlainFont.prototype.setLineHeight=function(lineHeight){this._lineHeight=lineHeight},PlainFont.prototype.reFormat=function(){this._formatText(),this._lineHeight=this._getDefaultLineHeight()},PlainFont.prototype.draw=function(){var context=this.context;context.font=this.fontSize+"px '"+this.fontFamily+"'",context.textBaseline="top",context.textAlign="start",this._strArr.length>1?this._drawMultiLine():this._drawSingleLine()},PlainFont.prototype._formatText=function(){var maxWidth=this.width;if(this._trimStr(),0!==maxWidth){this._strArr=this._text.split("\n");for(var i=0;i<this._strArr.length;i++){var text=this._strArr[i],allWidth=this._measure(text);allWidth>maxWidth&&text.length>1&&this._formatMultiLine(i,text,allWidth,maxWidth)}}},PlainFont.prototype._trimStr=function(){this._text=this._text.replace(LAST_INVALID_CHAR,"")},PlainFont.prototype._formatMultiLine=function(i,text,allWidth,maxWidth){var _this=this,LOOP_MAX_NUM=100,self=this,preText=null,truncationPointIndex=text.length*(maxWidth/allWidth)|0,nextText=text.substr(truncationPointIndex),loopIndex=0,width=allWidth-this._measure(nextText),pushNum=0,truncate=function(){for(;width>maxWidth&&loopIndex<LOOP_MAX_NUM;)truncationPointIndex*=maxWidth/width,truncationPointIndex=Math.floor(truncationPointIndex),nextText=text.substr(truncationPointIndex),width=allWidth-_this._measure(nextText),loopIndex+=1;loopIndex=0},findTruncationPoint=function(){for(;width<maxWidth&&loopIndex<LOOP_MAX_NUM;){if(nextText){var exec=WORD_REX.exec(nextText);pushNum=exec?exec[0].length:1}truncationPointIndex+=pushNum,nextText=text.substr(truncationPointIndex),width=allWidth-_this._measure(nextText),loopIndex+=1}},handleTruncationPointIndex=function(){if(FIRST_ENGLISH_OR_NUM.test(nextText)){var preText_1=text.substr(0,truncationPointIndex),pExec=LAST_ENGLISH_OR_NUM.exec(preText_1);pExec&&(truncationPointIndex-=pExec[0].length)}else truncationPointIndex-=pushNum;0===truncationPointIndex&&(truncationPointIndex=1)},setString=function(){nextText=text.substr(truncationPointIndex),preText=text.substr(0,truncationPointIndex),self._strArr[i]=nextText,self._strArr.splice(i,0,preText)};truncate(),findTruncationPoint(),handleTruncationPointIndex(),setString()},PlainFont.prototype._measure=function(text){var context=this.context;return context.font=this.fontSize+"px '"+this.fontFamily+"'",context.measureText(text).width},PlainFont.prototype._getDefaultLineHeight=function(){return this._computeLineHeight("normal")},PlainFont.prototype._computeLineHeight=function(lineHeight){var div=wdCb.DomQuery.create("<div></div>"),dom=div.get(0),resultLineHeight=null;return dom.style.cssText="\n             font-family: "+this.fontFamily+";\n             font-size: "+this.fontSize+"px;\n             position: absolute;\n             left: -100px;\n             top: -100px;\n             line-height: "+lineHeight+";\n             ",div.prependTo("body"),dom.innerHTML="abc!",resultLineHeight=dom.clientHeight,div.remove(),resultLineHeight},PlainFont.prototype._getFontClientHeight=function(){var fontSize=this.fontSize,fontName=this.fontFamily,key=fontSize+"."+fontName,cacheHeight=this._fontClientHeightCache.getChild(key),height=null;return cacheHeight?cacheHeight:(height=this._computeLineHeight(1),this._fontClientHeightCache.addChild(key,height),height)},PlainFont.prototype._drawMultiLine=function(){var context=this.context,position=this.getLeftCornerPosition(),x=position.x,y=position.y,lineHeight=this._lineHeight,fontClientHeight=this._getFontClientHeight(),self=this,lineCount=this._strArr.length,lineTotalHeight=(lineCount-1)*lineHeight+fontClientHeight;self.yAlignment===wd.EFontYAlignment.BOTTOM?y=y+self.height-lineTotalHeight:self.yAlignment===wd.EFontYAlignment.MIDDLE&&(y+=(self.height-lineTotalHeight)/2);for(var _i=0,_a=this._strArr;_i<_a.length;_i++){var str=_a[_i];self.xAlignment===wd.EFontXAlignment.RIGHT?x=x+self.width-self._measure(str):self.xAlignment==wd.EFontXAlignment.CENTER&&(x+=(self.width-self._measure(str))/2),self._fillEnabled?(context.fillStyle=self._fillStyle,context.fillText(str,x,y)):self._strokeEnabled&&(context.strokeStyle=self._strokeStyle,context.lineWidth=self._strokeSize,context.strokeText(str,x,y)),x=position.x,y+=lineHeight}},PlainFont.prototype._drawSingleLine=function(){var context=this.context,position=this.getLeftCornerPosition(),x=position.x,y=position.y,fontClientHeight=this._getFontClientHeight(),self=this,lineTotalHeight=fontClientHeight,str=this._strArr[0];self.yAlignment===wd.EFontYAlignment.BOTTOM?y=y+self.height-lineTotalHeight:self.yAlignment===wd.EFontYAlignment.MIDDLE&&(y+=(self.height-lineTotalHeight)/2),self.xAlignment===wd.EFontXAlignment.RIGHT?x=x+self.width-self._measure(str):self.xAlignment==wd.EFontXAlignment.CENTER&&(x+=(self.width-self._measure(str))/2),self._fillEnabled?(context.fillStyle=self._fillStyle,context.fillText(str,x,y)):self._strokeEnabled&&(context.strokeStyle=self._strokeStyle,context.lineWidth=self._strokeSize,context.strokeText(str,x,y))},__decorate([wd.cloneAttributeAsBasicType()],PlainFont.prototype,"text",null),__decorate([wd.cloneAttributeAsBasicType()],PlainFont.prototype,"fontSize",null),__decorate([wd.cloneAttributeAsBasicType()],PlainFont.prototype,"fontFamily",null),__decorate([wd.cloneAttributeAsBasicType()],PlainFont.prototype,"xAlignment",null),__decorate([wd.cloneAttributeAsBasicType()],PlainFont.prototype,"yAlignment",null),__decorate([wd.cloneAttributeAsBasicType()],PlainFont.prototype,"_fillEnabled",void 0),__decorate([wd.cloneAttributeAsBasicType()],PlainFont.prototype,"_fillStyle",void 0),__decorate([wd.cloneAttributeAsBasicType()],PlainFont.prototype,"_strokeEnabled",void 0),__decorate([wd.cloneAttributeAsBasicType()],PlainFont.prototype,"_strokeStyle",void 0),__decorate([wd.cloneAttributeAsBasicType()],PlainFont.prototype,"_strokeSize",void 0),__decorate([wd.cloneAttributeAsBasicType()],PlainFont.prototype,"_lineHeight",void 0),PlainFont}(wd.TwoDFont);wd.PlainFont=PlainFont}(wd||(wd={}));var wd;!function(wd){var TwoDBitmapFont=function(_super){function TwoDBitmapFont(){_super.apply(this,arguments),this._text="",this._xAlignment=wd.EFontXAlignment.LEFT,this.fntId=null,this.bitmapId=null,this._charFontList=wdCb.Collection.create(),this._layout=wd.BitmapFontLayout.create()}return __extends(TwoDBitmapFont,_super),TwoDBitmapFont.create=function(){var obj=new this;return obj},Object.defineProperty(TwoDBitmapFont.prototype,"text",{get:function(){return this._text},set:function(text){this._text!==text&&(this._text=text,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(TwoDBitmapFont.prototype,"xAlignment",{get:function(){return this._xAlignment},set:function(xAlignment){this._xAlignment!==xAlignment&&(this._xAlignment=xAlignment,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),TwoDBitmapFont.prototype.init=function(){var imageAsset=this._getImageAsset();if(!imageAsset)return wd.Log.log("impossible to create font: not find bitmap file"),!1;_super.prototype.init.call(this);var layoutDataList=this._layout.getLayoutData(this.text,this.fntId,{width:this.width,align:this.xAlignment});layoutDataList&&this._createAndAddFontCharUIObjects(layoutDataList,imageAsset)},TwoDBitmapFont.prototype.dispose=function(){_super.prototype.dispose.call(this),this._removeAllCharFont()},TwoDBitmapFont.prototype.reFormat=function(){var imageAsset=this._getImageAsset();if(this._removeAllCharFont(),!imageAsset)return wd.Log.log("impossible to create font: not find bitmap file"),!1;var layoutDataList=this._layout.getLayoutData(this.text,this.fntId,{width:this.width,align:this.xAlignment});layoutDataList&&this._createAndAddFontCharUIObjects(layoutDataList,imageAsset)},TwoDBitmapFont.prototype._getImageAsset=function(){return wd.LoaderManager.getInstance().get(this.bitmapId)},TwoDBitmapFont.prototype._createAndAddFontCharUIObjects=function(layoutDataList,imageAsset){var _this=this,image=imageAsset.source,uiRenderer=this.getUIRenderer(),text=this.text,position=this.getLeftCornerPosition();layoutDataList.forEach(function(layoutData){var glyphData=layoutData.data,rect=wd.RectRegion.create(glyphData.rect.x,glyphData.rect.y,glyphData.rect.width,glyphData.rect.height),_a=_this._createCharFont(layoutData.index,uiRenderer),charFontUIObject=_a.charFontUIObject,charFont=_a.charFont,transform=null;transform=charFontUIObject.transform,charFont.image=image,charFont.rectRegion=rect,transform.width=rect.width,transform.height=rect.height,charFont.char=text[layoutData.index],_this._addCharFontUIObject(charFontUIObject),_this._setCharFontUIObjectPosition(charFontUIObject,position.x+layoutData.position[0],position.y+layoutData.position[1])})},TwoDBitmapFont.prototype._createCharFont=function(index,uiRenderer){var charFontUIObject=wd.UIObject.create(),charFont=wd.CharFont.create();return charFontUIObject.addComponent(charFont),charFontUIObject.addComponent(uiRenderer),charFontUIObject.addTag(String(index)),charFontUIObject.init(),{charFontUIObject:charFontUIObject,charFont:charFont}},TwoDBitmapFont.prototype._addCharFontUIObject=function(charFontUIObject){this._charFontList.addChild(charFontUIObject),this.entityObject.addChild(charFontUIObject)},TwoDBitmapFont.prototype._setCharFontUIObjectPosition=function(charFontUIObject,x,y){var transform=charFontUIObject.transform;charFontUIObject.transform.position=wd.CoordinateUtils.convertLeftCornerPositionToCenterPositionInCanvas(wd.Vector2.create(x,y),transform.width,transform.height)},TwoDBitmapFont.prototype._removeAllCharFont=function(){this._charFontList.forEach(function(charFont){charFont.dispose()}),this._charFontList.removeAllChildren()},__decorate([wd.cloneAttributeAsBasicType()],TwoDBitmapFont.prototype,"text",null),__decorate([wd.cloneAttributeAsBasicType()],TwoDBitmapFont.prototype,"xAlignment",null),__decorate([wd.cloneAttributeAsBasicType()],TwoDBitmapFont.prototype,"fntId",void 0),__decorate([wd.cloneAttributeAsBasicType()],TwoDBitmapFont.prototype,"bitmapId",void 0),TwoDBitmapFont}(wd.TwoDFont);wd.TwoDBitmapFont=TwoDBitmapFont}(wd||(wd={}));var wd;!function(wd){var CharFont=function(_super){function CharFont(){_super.apply(this,arguments),this._char=null,this.startPosX=null,this.xAdvance=null,this.image=null,this.rectRegion=null,this._subscription=null}return __extends(CharFont,_super),CharFont.create=function(){var obj=new this;return obj},Object.defineProperty(CharFont.prototype,"x",{get:function(){return this.entityObject.transform.position.x},set:function(x){var position=this.entityObject.transform.position;this.entityObject.transform.position=wd.Vector2.create(x,position.y)},enumerable:!0,configurable:!0}),Object.defineProperty(CharFont.prototype,"y",{get:function(){return this.entityObject.transform.position.y},enumerable:!0,configurable:!0}),Object.defineProperty(CharFont.prototype,"char",{get:function(){return this._char},set:function(char){return null!==this._char?void wd.Log.log(wd.Log.info.FUNC_NOT_SUPPORT("change char")):void(this._char=char)},enumerable:!0,configurable:!0}),CharFont.prototype.clone=function(){return wd.Log.error(!0,wd.Log.info.FUNC_NOT_SUPPORT("clone")),null},CharFont.prototype.init=function(){var self=this;_super.prototype.init.call(this),this._subscription=wdFrp.fromArray([wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.TRANSFORM_TRANSLATE),wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.TRANSFORM_ROTATE),wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.TRANSFORM_SCALE)]).mergeAll().subscribe(function(){self.dirty=!0})},CharFont.prototype.dispose=function(){_super.prototype.dispose.call(this),this._subscription.dispose()},CharFont.prototype.shouldNotRender=function(){return null===this.rectRegion||0===this.width&&0===this.height},CharFont.prototype.draw=function(){var transform=null,position=null,dw=null,dh=null;transform=this.entityObject.transform,position=transform.position,dw=this.width,dh=this.height,this.drawInCenterPoint(this.context,this.image,this.rectRegion.x,this.rectRegion.y,this.rectRegion.width,this.rectRegion.height,position,dw,dh)},__decorate([wd.execOnlyOnce("_isInit")],CharFont.prototype,"init",null),CharFont}(wd.TwoDFont);wd.CharFont=CharFont}(wd||(wd={}));var wd;!function(wd){var ProgressBar=function(_super){function ProgressBar(){_super.apply(this,arguments),this._percent=0,this.borderStyle="rgba(0, 0, 0, 1)",this.fillStyle="rgba(255, 0, 0, 1)",this.radius=5,this._offScreenCanvas=null,this._offScreenContext=null}return __extends(ProgressBar,_super),ProgressBar.create=function(){var obj=new this;return obj},Object.defineProperty(ProgressBar.prototype,"percent",{get:function(){return this._percent},set:function(percent){this._percent!==percent&&(this._percent=percent,this.dirty=!0)},enumerable:!0,configurable:!0}),ProgressBar.prototype.init=function(){_super.prototype.init.call(this),this._createOffScreenCanvas(),this._drawProgressBar()},ProgressBar.prototype.shouldNotRender=function(){return this.percent<=0},ProgressBar.prototype.draw=function(){var position=this.entityObject.transform.position;this._drawFromLeft(position),this._drawBorder(position)},ProgressBar.prototype._drawFromLeft=function(position){var offscreenCanvas=this._offScreenCanvas,loadedWidth=this.width*this.percent;this.drawInCenterPoint(this.context,offscreenCanvas,0,0,loadedWidth,this.height,wd.Vector2.create(position.x-this.width/2+loadedWidth/2,position.y),loadedWidth,this.height)},ProgressBar.prototype._drawBorder=function(position){wd.RoundedRectUtils.drawRoundedRect(this.context,this.borderStyle,null,position.x-this.width/2,position.y-this.height/2,this.width,this.height,this.radius)},ProgressBar.prototype._createOffScreenCanvas=function(){var canvas=wdCb.DomQuery.create("<canvas></canvas>");canvas.attr("width",this.context.canvas.width),canvas.attr("height",this.context.canvas.height),this._offScreenCanvas=canvas.get(0),this._offScreenContext=this._offScreenCanvas.getContext("2d")},ProgressBar.prototype._drawProgressBar=function(){this._offScreenContext.clearRect(0,0,this._offScreenCanvas.width,this._offScreenCanvas.height),wd.RoundedRectUtils.drawRoundedRect(this._offScreenContext,this.borderStyle,this.fillStyle,0,0,this.width,this.height,this.radius)},__decorate([wd.cloneAttributeAsBasicType()],ProgressBar.prototype,"percent",null),__decorate([wd.cloneAttributeAsBasicType()],ProgressBar.prototype,"borderStyle",void 0),__decorate([wd.cloneAttributeAsBasicType()],ProgressBar.prototype,"fillStyle",void 0),__decorate([wd.cloneAttributeAsBasicType()],ProgressBar.prototype,"radius",void 0),__decorate([wd.require(function(){wd.assert(this.percent>=0&&this.percent<=1,wd.Log.info.FUNC_SHOULD("percent"," >= 0 and <= 1"))})],ProgressBar.prototype,"draw",null),ProgressBar}(wd.TwoDUI);wd.ProgressBar=ProgressBar}(wd||(wd={}));var wd;!function(wd){function _canUseNewCanvasBlendModes(){var canvas=null,context=null;return"undefined"!=typeof document&&(canvas=document.createElement("canvas"),canvas.width=1,canvas.height=1,context=canvas.getContext("2d"),context.fillStyle="#000",context.fillRect(0,0,1,1),context.globalCompositeOperation="multiply",context.fillStyle="#fff",context.fillRect(0,0,1,1),0===context.getImageData(0,0,1,1).data[0])}var Image=function(_super){function Image(){_super.apply(this,arguments),this._source=null,this.color=null,this.targetSource=null,this.targetColor=null}return __extends(Image,_super),
Image.create=function(){var obj=new this;return obj},Object.defineProperty(Image.prototype,"source",{get:function(){return this._source},set:function(source){source!==this._source&&(this._source=source,this.dirty=!0)},enumerable:!0,configurable:!0}),Image.prototype.shouldNotRender=function(){return null===this._getDrawSource()&&null===this._getDrawColor()},Image.prototype.draw=function(){var drawColor=this._getDrawColor(),drawSource=this._getDrawSource();if(null!==drawColor){var position=this.entityObject.transform.position;this._setFillStyle(drawColor.toString()),drawColor.a<1&&this._setGlobalAlpha(this.context,drawColor.a),this.context.fillRect(position.x-this.width/2,position.y-this.height/2,this.width,this.height),drawSource&&this._blendColorWithSource()}else this.drawInCenterPoint(this.context,drawSource.source,this.entityObject.transform.position,this.width,this.height)},Image.prototype._setFillStyle=function(style){this.context.fillStyle=style},Image.prototype._getDrawSource=function(){return this.targetSource?this.targetSource:this.source},Image.prototype._getDrawColor=function(){return this.targetColor?this.targetColor:this.color},Image.prototype._blendByMultiply=function(){this._setGlobalCompositeOperation(this.context,"multiply"),this.drawInCenterPoint(this.context,this._getDrawSource().source,this.entityObject.transform.position,this.width,this.height)},Image.prototype._blendByPerPixel=function(){var context=this.context,canvas=this.getCanvas(),r=this.color.r,g=this.color.g,b=this.color.b,pixelData=null,pixels=null;context.globalCompositeOperation="clone",this.drawInCenterPoint(this.context,this._getDrawSource().source,this.entityObject.transform.position,this.width,this.height),pixelData=context.getImageData(0,0,canvas.width,canvas.height),pixels=pixelData.data;for(var i=0,len=pixels.length;i<len;i+=4)pixels[i]*=r,pixels[i+1]*=g,pixels[i+2]*=b;context.putImageData(pixelData,0,0)},Image.prototype._setGlobalCompositeOperation=function(context,mode){context.globalCompositeOperation=mode},Image.prototype._setGlobalAlpha=function(context,alpha){context.globalAlpha=alpha},Image.constructorForBlend=function(obj){return obj._blendColorWithSource=_canUseNewCanvasBlendModes()?obj._blendByMultiply:obj._blendByPerPixel,!0},Image.constructorInitForBlend=Image.constructorForBlend(Image.prototype),__decorate([wd.cloneAttributeAsCloneable()],Image.prototype,"source",null),__decorate([wd.cloneAttributeAsCloneable()],Image.prototype,"color",void 0),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){source[memberName]&&(target[memberName]=wd.ImageTextureAsset.create(source[memberName].source))})],Image.prototype,"targetSource",void 0),__decorate([wd.cloneAttributeAsCloneable()],Image.prototype,"targetColor",void 0),__decorate([wd.require(function(){wd.assert(!!this._getDrawSource(),wd.Log.info.FUNC_SHOULD("source","exist"))})],Image.prototype,"_blendByMultiply",null),__decorate([wd.require(function(){wd.assert(!!this._getDrawSource(),wd.Log.info.FUNC_SHOULD("source","exist"))})],Image.prototype,"_blendByPerPixel",null),Image}(wd.TwoDUI);wd.Image=Image}(wd||(wd={}));var wd;!function(wd){var InteractionUI=function(_super){function InteractionUI(){_super.apply(this,arguments),this.p_transitionMode=null,this.transitionManager=wd.TransitionManager.create(this)}return __extends(InteractionUI,_super),Object.defineProperty(InteractionUI.prototype,"transitionMode",{get:function(){return this.p_transitionMode},set:function(transitionMode){this.p_transitionMode=transitionMode},enumerable:!0,configurable:!0}),__decorate([wd.cloneAttributeAsBasicType()],InteractionUI.prototype,"transitionMode",null),__decorate([wd.cloneAttributeAsCloneable({isInjectTarget:!0})],InteractionUI.prototype,"transitionManager",void 0),InteractionUI}(wd.TwoDUI);wd.InteractionUI=InteractionUI}(wd||(wd={}));var wd;!function(wd){var Button=function(_super){function Button(){_super.apply(this,arguments),this._text=null,this._mousedownSubscription=null,this._mouseupSubscription=null,this._mouseoverSubscription=null,this._mouseoutSubscription=null,this._stateMachine=wd.UIStateMachine.create(this)}return __extends(Button,_super),Button.create=function(){var obj=new this;return obj.initWhenCreate(),obj},Object.defineProperty(Button.prototype,"text",{get:function(){var fontObject=null;return null===this.entityObject?this._text:(fontObject=this.getObject(wd.EButtonObjectName.TEXT),fontObject?fontObject.getComponent(wd.PlainFont).text:null)},set:function(text){var fontObject=null;this._text=text,null!==this.entityObject&&this.getUIRenderer()&&(fontObject=this.getObject(wd.EButtonObjectName.TEXT),fontObject?fontObject.getComponent(wd.PlainFont).text=text:this.entityObject.addChild(this._createFontObject()))},enumerable:!0,configurable:!0}),Object.defineProperty(Button.prototype,"isDisabled",{get:function(){return this._stateMachine.currentState===wd.EUIState.DISABLED},enumerable:!0,configurable:!0}),Object.defineProperty(Button.prototype,"currentState",{get:function(){return this._stateMachine.currentState},enumerable:!0,configurable:!0}),Button.prototype.initWhenCreate=function(){this.transitionMode=wd.ETransitionMode.SPRITE,this.text="button"},Button.prototype.init=function(){_super.prototype.init.call(this),this.entityObject.addChild(this._createBackgroundObject()),this._hasFontObject()||this.entityObject.addChild(this._createFontObject()),this._bindEvent()},Button.prototype.dispose=function(){_super.prototype.dispose.call(this),this._mousedownSubscription.dispose(),this._mouseupSubscription.dispose(),this._mouseoverSubscription.dispose(),this._mouseoutSubscription.dispose()},Button.prototype.getObject=function(objectName){return this.entityObject.findChildByName(objectName)},Button.prototype.getObjectTransition=function(objectName){return this.transitionManager.getObjectTransition(objectName)},Button.prototype.enable=function(){this._stateMachine.changeState(wd.EUIState.NORMAL)},Button.prototype.disable=function(){this._stateMachine.changeState(wd.EUIState.DISABLED)},Button.prototype.update=function(elapsed){var target=this.transitionManager.getObjectTarget(wd.EButtonObjectName.BACKGROUND);if(target)switch(this.p_transitionMode){case wd.ETransitionMode.SPRITE:this.getObject(wd.EButtonObjectName.BACKGROUND).getComponent(wd.Image).targetSource=target;break;case wd.ETransitionMode.COLOR:this.getObject(wd.EButtonObjectName.BACKGROUND).getComponent(wd.Image).targetColor=target;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("transitionMode"))}else{var image=this.getObject(wd.EButtonObjectName.BACKGROUND).getComponent(wd.Image);switch(this.p_transitionMode){case wd.ETransitionMode.SPRITE:image.targetSource=null;break;case wd.ETransitionMode.COLOR:image.targetColor=null;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("transitionMode"))}}},Button.prototype.render=function(){},Button.prototype._createBackgroundObject=function(){var object=wd.UIObject.create(),image=wd.Image.create(),transform=this.entityObject.transform;return object.addComponent(image),object.addComponent(this.getUIRenderer()),object.transform.width=transform.width,object.transform.height=transform.height,object.transform.zIndex=1,object.name=wd.EButtonObjectName.BACKGROUND,wd.CloneUtils.markNotClone(object),object},Button.prototype._createFontObject=function(){var fontObject=wd.UIObject.create(),font=wd.PlainFont.create(),transform=this.entityObject.transform;return font.text=this._text,font.enableFill("#000000"),font.xAlignment=wd.EFontXAlignment.CENTER,font.yAlignment=wd.EFontYAlignment.MIDDLE,fontObject.addComponent(font),fontObject.addComponent(this.getUIRenderer()),fontObject.transform.width=transform.width,fontObject.transform.height=transform.height,fontObject.transform.zIndex=2,fontObject.name=wd.EButtonObjectName.TEXT,wd.CloneUtils.markNotClone(fontObject),fontObject},Button.prototype._hasFontObject=function(){return!!this.getObject(wd.EButtonObjectName.TEXT)},Button.prototype._bindEvent=function(){var self=this;this._mousedownSubscription=wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.MOUSE_DOWN).filter(function(e){return!self.isDisabled}).subscribe(function(e){self._stateMachine.changeState(wd.EUIState.PRESSED)}),this._mouseupSubscription=wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.MOUSE_UP).filter(function(e){return!self.isDisabled}).subscribe(function(e){self._stateMachine.backState()}),this._mouseoverSubscription=wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.MOUSE_OVER).filter(function(e){return!self.isDisabled}).subscribe(function(e){self._stateMachine.changeState(wd.EUIState.HIGHLIGHT)}),this._mouseoutSubscription=wd.EventManager.fromEvent(this.entityObject,wd.EEngineEvent.MOUSE_OUT).filter(function(e){return!self.isDisabled}).subscribe(function(e){self._stateMachine.backState()})},__decorate([wd.cloneAttributeAsBasicType()],Button.prototype,"_text",void 0),__decorate([wd.cloneAttributeAsCloneable({isInjectTarget:!0})],Button.prototype,"_stateMachine",void 0),__decorate([wd.require(function(){wd.assert(this.getObject(wd.EButtonObjectName.BACKGROUND).hasComponent(wd.Image),wd.Log.info.FUNC_SHOULD("Button UIObject","contain Image component"))})],Button.prototype,"update",null),Button}(wd.InteractionUI);wd.Button=Button}(wd||(wd={}));var wd;!function(wd){!function(EButtonObjectName){EButtonObjectName[EButtonObjectName.BACKGROUND="background"]="BACKGROUND",EButtonObjectName[EButtonObjectName.TEXT="text"]="TEXT"}(wd.EButtonObjectName||(wd.EButtonObjectName={}));wd.EButtonObjectName}(wd||(wd={}));var wd;!function(wd){!function(EUIState){EUIState[EUIState.NORMAL=0]="NORMAL",EUIState[EUIState.HIGHLIGHT=1]="HIGHLIGHT",EUIState[EUIState.PRESSED=2]="PRESSED",EUIState[EUIState.DISABLED=3]="DISABLED"}(wd.EUIState||(wd.EUIState={}));wd.EUIState}(wd||(wd={}));var wd;!function(wd){var UIStateMachine=function(){function UIStateMachine(ui){this._ui=null,this._stateHistory=wdCb.Stack.create(),this._ui=ui}return UIStateMachine.create=function(ui){var obj=new this(ui);return obj},Object.defineProperty(UIStateMachine.prototype,"transitionManager",{get:function(){return this._ui.transitionManager},enumerable:!0,configurable:!0}),Object.defineProperty(UIStateMachine.prototype,"currentState",{get:function(){return this._stateHistory.top||wd.EUIState.NORMAL},enumerable:!0,configurable:!0}),UIStateMachine.prototype.clone=function(ui){return wd.CloneUtils.clone(this,null,[ui])},UIStateMachine.prototype.changeState=function(state){this._stateHistory.push(state),this.transitionManager.changeState(state),this._ui.dirty=!0},UIStateMachine.prototype.backState=function(){var lastState=null;this._stateHistory.pop(),lastState=this._stateHistory.top,lastState||(lastState=wd.EUIState.NORMAL),this.transitionManager.changeState(lastState),this._ui.dirty=!0},__decorate([wd.cloneAttributeAsCloneable()],UIStateMachine.prototype,"_stateHistory",void 0),UIStateMachine}();wd.UIStateMachine=UIStateMachine}(wd||(wd={}));var wd;!function(wd){var Transition=function(){function Transition(){this._target=null}return Object.defineProperty(Transition.prototype,"target",{get:function(){return null===this._target&&this.changeState(wd.EUIState.NORMAL),this._target},set:function(target){this._target=target},enumerable:!0,configurable:!0}),Transition.prototype.clone=function(){return wd.CloneUtils.clone(this)},Transition}();wd.Transition=Transition}(wd||(wd={}));var wd;!function(wd){var SpriteTransition=function(_super){function SpriteTransition(){_super.apply(this,arguments),this.normalSprite=null,this.highlightSprite=null,this.pressedSprite=null,this.disabledSprite=null}return __extends(SpriteTransition,_super),SpriteTransition.create=function(){var obj=new this;return obj},SpriteTransition.prototype.changeState=function(state){switch(state){case wd.EUIState.NORMAL:this.target=this.normalSprite;break;case wd.EUIState.HIGHLIGHT:this.target=this.highlightSprite;break;case wd.EUIState.PRESSED:this.target=this.pressedSprite;break;case wd.EUIState.DISABLED:this.target=this.disabledSprite;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("state"))}},__decorate([wd.cloneAttributeAsCloneable()],SpriteTransition.prototype,"normalSprite",void 0),__decorate([wd.cloneAttributeAsCloneable()],SpriteTransition.prototype,"highlightSprite",void 0),__decorate([wd.cloneAttributeAsCloneable()],SpriteTransition.prototype,"pressedSprite",void 0),__decorate([wd.cloneAttributeAsCloneable()],SpriteTransition.prototype,"disabledSprite",void 0),SpriteTransition}(wd.Transition);wd.SpriteTransition=SpriteTransition}(wd||(wd={}));var wd;!function(wd){var ColorTransition=function(_super){function ColorTransition(){_super.apply(this,arguments),this.normalColor=null,this.highlightColor=null,this.pressedColor=null,this.disabledColor=null}return __extends(ColorTransition,_super),ColorTransition.create=function(){var obj=new this;return obj},ColorTransition.prototype.changeState=function(state){switch(state){case wd.EUIState.NORMAL:this.target=this.normalColor;break;case wd.EUIState.HIGHLIGHT:this.target=this.highlightColor;break;case wd.EUIState.PRESSED:this.target=this.pressedColor;break;case wd.EUIState.DISABLED:this.target=this.disabledColor;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("state"))}},__decorate([wd.cloneAttributeAsCloneable()],ColorTransition.prototype,"normalColor",void 0),__decorate([wd.cloneAttributeAsCloneable()],ColorTransition.prototype,"highlightColor",void 0),__decorate([wd.cloneAttributeAsCloneable()],ColorTransition.prototype,"pressedColor",void 0),__decorate([wd.cloneAttributeAsCloneable()],ColorTransition.prototype,"disabledColor",void 0),ColorTransition}(wd.Transition);wd.ColorTransition=ColorTransition}(wd||(wd={}));var wd;!function(wd){!function(ETransitionMode){ETransitionMode[ETransitionMode.SPRITE=0]="SPRITE",ETransitionMode[ETransitionMode.COLOR=1]="COLOR"}(wd.ETransitionMode||(wd.ETransitionMode={}));wd.ETransitionMode}(wd||(wd={}));var wd;!function(wd){var TransitionManager=function(){function TransitionManager(ui){this._ui=null,this._spriteTransitionMap=wdCb.Hash.create(),this._colorTransitionMap=wdCb.Hash.create(),this._ui=ui}return TransitionManager.create=function(ui){var obj=new this(ui);return obj},TransitionManager.prototype.clone=function(interactionUI){return wd.CloneUtils.clone(this,null,[interactionUI])},TransitionManager.prototype.getObjectTransition=function(objectName){var result=this._getTransitionMap().getChild(objectName);return result||(result=this._createTransitionInstance(),this._getTransitionMap().addChild(objectName,result)),result},TransitionManager.prototype.getObjectTarget=function(objectName){return this.getObjectTransition(objectName).target},TransitionManager.prototype.changeState=function(state){wdFrp.fromArray([this._spriteTransitionMap,this._colorTransitionMap]).subscribe(function(map){map.forEach(function(transition){transition.changeState(state)})})},TransitionManager.prototype._getTransitionMap=function(){var map=null;switch(this._ui.transitionMode){case wd.ETransitionMode.SPRITE:map=this._spriteTransitionMap;break;case wd.ETransitionMode.COLOR:map=this._colorTransitionMap;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("transitionMode"))}return map},TransitionManager.prototype._createTransitionInstance=function(){var transition=null;switch(this._ui.transitionMode){case wd.ETransitionMode.SPRITE:transition=wd.SpriteTransition.create();break;case wd.ETransitionMode.COLOR:transition=wd.ColorTransition.create();break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("transitionMode"))}return transition},__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=source[memberName].clone(!0)})],TransitionManager.prototype,"_spriteTransitionMap",void 0),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=source[memberName].clone(!0)})],TransitionManager.prototype,"_colorTransitionMap",void 0),TransitionManager}();wd.TransitionManager=TransitionManager}(wd||(wd={}));var wd;!function(wd){var RoundedRectUtils=function(){function RoundedRectUtils(){}return RoundedRectUtils.drawRoundedRect=function(context,strokeStyle,fillStyle,cornerX,cornerY,width,height,cornerRadius){context.save(),context.beginPath(),width>0?context.moveTo(cornerX+cornerRadius,cornerY):context.moveTo(cornerX-cornerRadius,cornerY),context.arcTo(cornerX+width,cornerY,cornerX+width,cornerY+height,cornerRadius),context.arcTo(cornerX+width,cornerY+height,cornerX,cornerY+height,cornerRadius),context.arcTo(cornerX,cornerY+height,cornerX,cornerY,cornerRadius),width>0?context.arcTo(cornerX,cornerY,cornerX+cornerRadius,cornerY,cornerRadius):context.arcTo(cornerX,cornerY,cornerX-cornerRadius,cornerY,cornerRadius),context.closePath(),context.strokeStyle=strokeStyle,context.fillStyle=fillStyle,strokeStyle&&context.stroke(),fillStyle&&context.fill(),context.restore()},RoundedRectUtils}();wd.RoundedRectUtils=RoundedRectUtils}(wd||(wd={}));var wd;!function(wd){var RenderTargetRenderer=function(){function RenderTargetRenderer(renderTargetTexture){this.texture=null,this.frameBufferOperator=null,this._isRenderListEmpty=!1,this._renderCount=0,this.texture=renderTargetTexture}return RenderTargetRenderer.prototype.initWhenCreate=function(){this.frameBufferOperator=wd.FrameBuffer.create(this.texture.width,this.texture.height)},RenderTargetRenderer.prototype.init=function(){this.texture.createEmptyTexture(),this.initFrameBuffer()},RenderTargetRenderer.prototype.needRender=function(){var renderRate=this.texture.renderRate,needRender=!1;return needRender=0===renderRate?this._shouldRenderOnce():this._shouldRenderAtRate(renderRate),this._renderCount++,needRender},RenderTargetRenderer.prototype.render=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var renderer=args[0],renderList=this.getRenderList();if(this._isRenderListEmpty=this.isRenderListEmpty(renderList),this.beforeRender(),1===args.length)this.renderFrameBufferTexture(renderList,renderer);else{var camera=args[1];this.renderFrameBufferTexture(renderList,renderer,camera)}this.afterRender()},RenderTargetRenderer.prototype.dispose=function(){this.frameBufferOperator.dispose(),this.disposeFrameBuffer(),this.texture.dispose()},RenderTargetRenderer.prototype.beforeRender=function(){},RenderTargetRenderer.prototype.afterRender=function(){},RenderTargetRenderer.prototype.isRenderListEmptyWhenRender=function(){return this._isRenderListEmpty},RenderTargetRenderer.prototype._shouldRenderOnce=function(){return 0===this._renderCount},RenderTargetRenderer.prototype._shouldRenderAtRate=function(renderRate){var renderCount=this._renderCount;return 0===renderCount||renderCount===renderRate&&(this._renderCount=0,!0)},__decorate([wd.require(function(){wd.assert(this.texture.renderRate>=0,wd.Log.info.FUNC_SHOULD("renderTargetTexture->renderRate",">= 0, but actual is "+this.texture.renderRate))}),wd.virtual],RenderTargetRenderer.prototype,"needRender",null),__decorate([wd.virtual],RenderTargetRenderer.prototype,"beforeRender",null),__decorate([wd.virtual],RenderTargetRenderer.prototype,"afterRender",null),__decorate([wd.ensure(function(isRenderListEmpty){isRenderListEmpty&&wd.assert(this.isRenderListEmpty(this.getRenderList()),wd.Log.info.FUNC_SHOULD("renderList","be empty"))})],RenderTargetRenderer.prototype,"isRenderListEmptyWhenRender",null),RenderTargetRenderer}();wd.RenderTargetRenderer=RenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var CommonRenderTargetRenderer=function(_super){function CommonRenderTargetRenderer(){_super.apply(this,arguments)}return __extends(CommonRenderTargetRenderer,_super),CommonRenderTargetRenderer}(wd.RenderTargetRenderer);wd.CommonRenderTargetRenderer=CommonRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var TwoDRenderTargetRenderer=function(_super){function TwoDRenderTargetRenderer(){_super.apply(this,arguments),this.frameBuffer=null,this._renderBuffer=null,this._lastCamera=null}return __extends(TwoDRenderTargetRenderer,_super),TwoDRenderTargetRenderer.prototype.isNeedCreateCamera=function(){return!0},TwoDRenderTargetRenderer.prototype.createCamera=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return null},TwoDRenderTargetRenderer.prototype.setFrameBufferTexture=function(){var frameBuffer=this.frameBufferOperator,gl=wd.DeviceManager.getInstance().gl;frameBuffer.attachTexture(gl.TEXTURE_2D,this.texture.glTexture,wd.EFrameBufferAttachType.COLOR_ATTACHMENT0)},TwoDRenderTargetRenderer.prototype.createAndAttachDepthBuffer=function(){var frameBuffer=this.frameBufferOperator;wd.DeviceManager.getInstance().gl;this._renderBuffer=frameBuffer.createRenderBuffer(),frameBuffer.attachRenderBuffer("DEPTH_ATTACHMENT",this._renderBuffer)},TwoDRenderTargetRenderer.prototype.deleteRenderBuffer=function(){var gl=wd.DeviceManager.getInstance().gl;gl.deleteRenderbuffer(this._renderBuffer)},TwoDRenderTargetRenderer.prototype.isRenderListEmpty=function(renderList){return 0===renderList.getCount()},TwoDRenderTargetRenderer.prototype.initFrameBuffer=function(){var frameBuffer=this.frameBufferOperator;this.frameBuffer=frameBuffer.createFrameBuffer(),frameBuffer.bindFrameBuffer(this.frameBuffer),this.setFrameBufferTexture(),this.createAndAttachDepthBuffer(),frameBuffer.check(),frameBuffer.unBindAll()},TwoDRenderTargetRenderer.prototype.renderFrameBufferTexture=function(renderList,renderer,camera){var renderCamera=null;this.isRenderListEmptyWhenRender()||(this.texture.bindToUnit(0),this.isNeedCreateCamera()?(renderCamera=this.createCamera(camera),this._lastCamera&&this._lastCamera.dispose(),this._lastCamera=renderCamera):renderCamera=camera,this.beforeRenderFrameBufferTexture(renderCamera),this.frameBufferOperator.bindFrameBuffer(this.frameBuffer),this.frameBufferOperator.setViewport(),renderList.forEach(function(child){child.render(renderer,renderCamera)}),renderer.clear(),this.renderRenderer(renderer),this.frameBufferOperator.unBindFrameBuffer(),this.frameBufferOperator.restoreViewport())},TwoDRenderTargetRenderer.prototype.disposeFrameBuffer=function(){var gl=wd.DeviceManager.getInstance().gl;gl.deleteFramebuffer(this.frameBuffer),this.deleteRenderBuffer()},__decorate([wd.virtual],TwoDRenderTargetRenderer.prototype,"isNeedCreateCamera",null),__decorate([wd.virtual],TwoDRenderTargetRenderer.prototype,"createCamera",null),__decorate([wd.virtual],TwoDRenderTargetRenderer.prototype,"setFrameBufferTexture",null),__decorate([wd.virtual],TwoDRenderTargetRenderer.prototype,"createAndAttachDepthBuffer",null),__decorate([wd.virtual],TwoDRenderTargetRenderer.prototype,"deleteRenderBuffer",null),__decorate([wd.require(function(renderList,renderer,camera){wd.assert(!!camera,wd.Log.info.FUNC_SHOULD("pass param->camera"))})],TwoDRenderTargetRenderer.prototype,"renderFrameBufferTexture",null),TwoDRenderTargetRenderer}(wd.CommonRenderTargetRenderer);wd.TwoDRenderTargetRenderer=TwoDRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var MirrorRenderTargetRenderer=function(_super){function MirrorRenderTargetRenderer(){_super.apply(this,arguments)}return __extends(MirrorRenderTargetRenderer,_super),MirrorRenderTargetRenderer.create=function(mirrorTexture){var obj=new this(mirrorTexture);return obj.initWhenCreate(),obj},MirrorRenderTargetRenderer.prototype.beforeRenderFrameBufferTexture=function(renderCamera){},MirrorRenderTargetRenderer.prototype.getRenderList=function(){return this.texture.renderList},MirrorRenderTargetRenderer.prototype.renderRenderer=function(renderer){this._setSceneSide(wd.ESide.FRONT),renderer.webglState=wd.BasicState.create(),renderer.render(),this._setSceneSide(null)},MirrorRenderTargetRenderer.prototype.beforeRender=function(){this.isRenderListEmptyWhenRender()?wd.Director.getInstance().scene.glslData.addChild(wd.EShaderGLSLData.MIRROR,{isRenderListEmpty:!0}):wd.Director.getInstance().scene.glslData.addChild(wd.EShaderGLSLData.MIRROR,{isRenderListEmpty:!1})},MirrorRenderTargetRenderer.prototype.createCamera=function(camera){var mirrorCameraComponent=null,plane=null,cameraComponent=camera.getComponent(wd.CameraController),mirrorCameraViewMatrix=null,projectionMatrix=null;return plane=this.texture.getPlane(),mirrorCameraViewMatrix=plane.getReflectionMatrix().applyMatrix(cameraComponent.worldToCameraMatrix),projectionMatrix=this._setClipPlane(mirrorCameraViewMatrix,cameraComponent.pMatrix,plane),mirrorCameraComponent=wd.PerspectiveCamera.create(),mirrorCameraComponent.worldToCameraMatrix=mirrorCameraViewMatrix.clone(),mirrorCameraComponent.pMatrix=projectionMatrix,wd.GameObject.create().addComponent(wd.RenderTargetRendererCameraController.create(mirrorCameraComponent)).init()},MirrorRenderTargetRenderer.prototype._setSceneSide=function(side){var scene=wd.Director.getInstance().scene;scene.side=side},MirrorRenderTargetRenderer.prototype._setClipPlane=function(vMatrix,pMatrix,plane){var projectionMatrix=pMatrix.clone(),q=wd.Vector4.create(),clipPlane=this._getClipPlaneInCameraSpace(vMatrix,plane),c=wd.Vector4.create();return q.x=(Math.sign(clipPlane.x)+projectionMatrix.values[8])/projectionMatrix.values[0],q.y=(Math.sign(clipPlane.y)+projectionMatrix.values[9])/projectionMatrix.values[5],q.z=-1,q.w=(1+projectionMatrix.values[10])/projectionMatrix.values[14],c=clipPlane.multiplyScalar(2/clipPlane.dot(q)),projectionMatrix.values[2]=c.x,projectionMatrix.values[6]=c.y,projectionMatrix.values[10]=c.z+1,projectionMatrix.values[14]=c.w,projectionMatrix},MirrorRenderTargetRenderer.prototype._getClipPlaneInCameraSpace=function(vMatrix,plane){var clipPlane=wd.Vector4.create(),p=vMatrix.multiplyPoint(this.texture.getPosition()),n=vMatrix.clone().invert().transpose().multiplyPoint(plane.normal).normalize();return clipPlane.set(n.x,n.y,n.z,-p.dot(n)),clipPlane},MirrorRenderTargetRenderer}(wd.TwoDRenderTargetRenderer);wd.MirrorRenderTargetRenderer=MirrorRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var RefractionRenderTargetRenderer=function(_super){function RefractionRenderTargetRenderer(){_super.apply(this,arguments)}return __extends(RefractionRenderTargetRenderer,_super),RefractionRenderTargetRenderer.create=function(refractionTexture){var obj=new this(refractionTexture);return obj.initWhenCreate(),obj},RefractionRenderTargetRenderer.prototype.beforeRenderFrameBufferTexture=function(renderCamera){},RefractionRenderTargetRenderer.prototype.getRenderList=function(){return this.texture.renderList},RefractionRenderTargetRenderer.prototype.renderRenderer=function(renderer){renderer.webglState=wd.BasicState.create(),renderer.render()},RefractionRenderTargetRenderer.prototype.beforeRender=function(){this.isRenderListEmptyWhenRender()?wd.Director.getInstance().scene.glslData.addChild(wd.EShaderGLSLData.REFRACTION,{isRenderListEmpty:!0}):wd.Director.getInstance().scene.glslData.addChild(wd.EShaderGLSLData.REFRACTION,{isRenderListEmpty:!1})},RefractionRenderTargetRenderer.prototype.isNeedCreateCamera=function(){return!1},RefractionRenderTargetRenderer}(wd.TwoDRenderTargetRenderer);wd.RefractionRenderTargetRenderer=RefractionRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var TwoDShadowMapRenderTargetRenderer=function(_super){function TwoDShadowMapRenderTargetRenderer(shadowMap,light,layer){_super.call(this,shadowMap),this._light=null,this._layer=null,this._shadowMapRendererUtils=null,this._light=light,this._layer=layer}return __extends(TwoDShadowMapRenderTargetRenderer,_super),TwoDShadowMapRenderTargetRenderer.create=function(shadowMap,light,layer){var obj=new this(shadowMap,light,layer);return obj.initWhenCreate(),obj},TwoDShadowMapRenderTargetRenderer.prototype.initWhenCreate=function(){this._shadowMapRendererUtils=wd.TwoDShadowMapRenderTargetRendererUtils.create(this._light,this.texture),_super.prototype.initWhenCreate.call(this)},TwoDShadowMapRenderTargetRenderer.prototype.beforeRenderFrameBufferTexture=function(renderCamera){wd.Director.getInstance().scene.glslData.appendChild(wd.EShaderGLSLData.TWOD_SHADOWMAP,{camera:renderCamera.getComponent(wd.CameraController),light:this._light,isRenderListEmpty:!1})},TwoDShadowMapRenderTargetRenderer.prototype.getRenderList=function(){return wd.Director.getInstance().scene.gameObjectScene.shadowManager.getShadowRenderListByLayer(this._layer)},TwoDShadowMapRenderTargetRenderer.prototype.renderRenderer=function(renderer){this._shadowMapRendererUtils.renderRenderer(renderer)},TwoDShadowMapRenderTargetRenderer.prototype.beforeRender=function(){return this.isRenderListEmptyWhenRender()?void wd.Director.getInstance().scene.glslData.appendChild(wd.EShaderGLSLData.TWOD_SHADOWMAP,{isRenderListEmpty:!0}):void this._shadowMapRendererUtils.beforeRender(wd.EShaderTypeOfScene.BUILD_TWOD_SHADOWMAP)},TwoDShadowMapRenderTargetRenderer.prototype.afterRender=function(){this.isRenderListEmptyWhenRender()||this._shadowMapRendererUtils.afterRender()},TwoDShadowMapRenderTargetRenderer.prototype.createCamera=function(){var orthoCameraComponent=wd.OrthographicCamera.create(),light=this._light,camera=wd.GameObject.create();return orthoCameraComponent.left=light.shadowCameraLeft,orthoCameraComponent.right=light.shadowCameraRight,orthoCameraComponent.top=light.shadowCameraTop,orthoCameraComponent.bottom=light.shadowCameraBottom,orthoCameraComponent.near=light.shadowCameraNear,orthoCameraComponent.far=light.shadowCameraFar,camera.addComponent(wd.RenderTargetRendererCameraController.create(orthoCameraComponent)),camera.transform.translate(light.position),camera.transform.lookAt(0,0,0),camera.init(),camera},TwoDShadowMapRenderTargetRenderer.prototype.setFrameBufferTexture=function(){if(wd.GPUDetector.getInstance().extensionDepthTexture){var frameBuffer=this.frameBufferOperator,gl=wd.DeviceManager.getInstance().gl;return frameBuffer.attachTexture(gl.TEXTURE_2D,this._createEmptyColorTexture(),wd.EFrameBufferAttachType.COLOR_ATTACHMENT0),void frameBuffer.attachTexture(gl.TEXTURE_2D,this.texture.glTexture,wd.EFrameBufferAttachType.DEPTH_ATTACHMENT)}_super.prototype.setFrameBufferTexture.call(this)},TwoDShadowMapRenderTargetRenderer.prototype.createAndAttachDepthBuffer=function(){wd.GPUDetector.getInstance().extensionDepthTexture||_super.prototype.createAndAttachDepthBuffer.call(this)},TwoDShadowMapRenderTargetRenderer.prototype.deleteRenderBuffer=function(){wd.GPUDetector.getInstance().extensionDepthTexture||_super.prototype.deleteRenderBuffer.call(this)},TwoDShadowMapRenderTargetRenderer.prototype._createEmptyColorTexture=function(){var gl=wd.DeviceManager.getInstance().gl,colorTexture=gl.createTexture();return gl.bindTexture(gl.TEXTURE_2D,colorTexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.texture.width,this.texture.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null),colorTexture},TwoDShadowMapRenderTargetRenderer}(wd.TwoDRenderTargetRenderer);wd.TwoDShadowMapRenderTargetRenderer=TwoDShadowMapRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var CubemapRenderTargetRenderer=function(_super){function CubemapRenderTargetRenderer(){_super.apply(this,arguments),this._frameBufferList=wdCb.Collection.create(),this._renderBufferList=wdCb.Collection.create(),this._lastCameraList=null,this._lastPosition=null}return __extends(CubemapRenderTargetRenderer,_super),CubemapRenderTargetRenderer.prototype.renderRenderer=function(renderer){renderer.webglState=wd.BasicState.create(),renderer.render()},CubemapRenderTargetRenderer.prototype.beforeRenderFrameBufferTexture=function(renderCamera){},CubemapRenderTargetRenderer.prototype.initFrameBuffer=function(){for(var frameBufferOperator=this.frameBufferOperator,gl=wd.DeviceManager.getInstance().gl,i=0;i<6;i++){var frameBuffer=frameBufferOperator.createFrameBuffer(),renderBuffer=frameBufferOperator.createRenderBuffer();this._frameBufferList.addChild(frameBuffer),this._renderBufferList.addChild(renderBuffer),frameBufferOperator.bindFrameBuffer(frameBuffer),frameBufferOperator.attachTexture(gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,this.texture.glTexture),frameBufferOperator.attachRenderBuffer("DEPTH_ATTACHMENT",renderBuffer),
frameBufferOperator.check()}frameBufferOperator.unBindAll()},CubemapRenderTargetRenderer.prototype.renderFrameBufferTexture=function(renderList,renderer,camera){var renderCamera=null,faceRenderList=null,newCameraList=null,position=null,isNeedCreateCamera=null;if(!this.isRenderListEmptyWhenRender()){this.texture.bindToUnit(0),position=this.getPosition(),isNeedCreateCamera=this._isNeedCreateCamera(position),isNeedCreateCamera&&(newCameraList=wdCb.Collection.create());for(var i=0;i<6;i++)faceRenderList=renderList.getChild(this._convertIndexToFaceKey(i)),this._isEmpty(faceRenderList)||(isNeedCreateCamera?(renderCamera=this.createCamera(i),newCameraList.addChild(renderCamera)):renderCamera=this._lastCameraList.getChild(i),this.beforeRenderFrameBufferTexture(renderCamera),this.frameBufferOperator.bindFrameBuffer(this._frameBufferList.getChild(i)),this.frameBufferOperator.setViewport(),faceRenderList.forEach(function(child){child.render(renderer,renderCamera)}),renderer.clear(),this.renderRenderer(renderer));isNeedCreateCamera&&(this._lastCameraList&&this._lastCameraList.forEach(function(camera){camera.dispose()}),this._lastCameraList=newCameraList,this._lastPosition=position),this.frameBufferOperator.unBindFrameBuffer(),this.frameBufferOperator.restoreViewport()}},CubemapRenderTargetRenderer.prototype.disposeFrameBuffer=function(){var gl=wd.DeviceManager.getInstance().gl;this._frameBufferList.forEach(function(buffer){return gl.deleteFramebuffer(buffer)}),this._renderBufferList.forEach(function(buffer){return gl.deleteRenderbuffer(buffer)})},CubemapRenderTargetRenderer.prototype.createCamera=function(index){var cubeCameraComponent=wd.PerspectiveCamera.create(),camera=wd.GameObject.create(),pos=this.getPosition();return cubeCameraComponent.fovy=90,this.setCamera(cubeCameraComponent),camera.addComponent(wd.RenderTargetRendererCameraController.create(cubeCameraComponent)),camera.transform.translate(pos),this._lookAtFace(camera,pos,index),camera.init(),camera},CubemapRenderTargetRenderer.prototype.isRenderListEmpty=function(renderList){var _this=this,isEmpty=!0;return renderList.forEach(function(faceRenderList){if(!_this._isEmpty(faceRenderList))return isEmpty=!1,wdCb.$BREAK},this),isEmpty},CubemapRenderTargetRenderer.prototype._isEmpty=function(faceRenderList){return void 0===faceRenderList||0===faceRenderList.getCount()},CubemapRenderTargetRenderer.prototype._convertIndexToFaceKey=function(index){var face=null;switch(index){case 0:face="px";break;case 1:face="nx";break;case 2:face="py";break;case 3:face="ny";break;case 4:face="pz";break;case 5:face="nz"}return face},CubemapRenderTargetRenderer.prototype._lookAtFace=function(camera,position,index){switch(index){case 0:camera.transform.lookAt(position.x+1,position.y,position.z,0,-1,0);break;case 1:camera.transform.lookAt(position.x-1,position.y,position.z,0,-1,0);break;case 2:camera.transform.lookAt(position.x,position.y+1,position.z,0,0,1);break;case 3:camera.transform.lookAt(position.x,position.y-1,position.z,0,0,-1);break;case 4:camera.transform.lookAt(position.x,position.y,position.z+1,0,-1,0);break;case 5:camera.transform.lookAt(position.x,position.y,position.z-1,0,-1,0)}},CubemapRenderTargetRenderer.prototype._isNeedCreateCamera=function(position){return null===this._lastPosition||null===this._lastCameraList||0===this._lastCameraList.getCount()||!position.isEqual(this._lastPosition)},__decorate([wd.virtual],CubemapRenderTargetRenderer.prototype,"renderRenderer",null),__decorate([wd.virtual],CubemapRenderTargetRenderer.prototype,"beforeRenderFrameBufferTexture",null),__decorate([wd.require(function(renderList,renderer,camera){wd.assert(!!camera,wd.Log.info.FUNC_SHOULD("pass param->camera"))})],CubemapRenderTargetRenderer.prototype,"renderFrameBufferTexture",null),CubemapRenderTargetRenderer}(wd.CommonRenderTargetRenderer);wd.CubemapRenderTargetRenderer=CubemapRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var CubemapShadowMapRenderTargetRenderer=function(_super){function CubemapShadowMapRenderTargetRenderer(shadowMap,light,layer){_super.call(this,shadowMap),this._light=null,this._layer=null,this._shadowMapRendererUtils=null,this._light=light,this._layer=layer}return __extends(CubemapShadowMapRenderTargetRenderer,_super),CubemapShadowMapRenderTargetRenderer.create=function(shadowMap,light,layer){var obj=new this(shadowMap,light,layer);return obj.initWhenCreate(),obj},CubemapShadowMapRenderTargetRenderer.prototype.initWhenCreate=function(){this._shadowMapRendererUtils=wd.CubemapShadowMapRenderTargetRendererUtils.create(this._light,this.texture),_super.prototype.initWhenCreate.call(this)},CubemapShadowMapRenderTargetRenderer.prototype.getRenderList=function(){var renderList=wd.Director.getInstance().scene.gameObjectScene.shadowManager.getShadowRenderListByLayer(this._layer);return wdCb.Hash.create({px:renderList,nx:renderList,py:renderList,ny:renderList,pz:renderList,nz:renderList})},CubemapShadowMapRenderTargetRenderer.prototype.renderRenderer=function(renderer){this._shadowMapRendererUtils.renderRenderer(renderer)},CubemapShadowMapRenderTargetRenderer.prototype.beforeRender=function(){var scene=null;return this.isRenderListEmptyWhenRender()?void wd.Director.getInstance().scene.glslData.appendChild(wd.EShaderGLSLData.CUBEMAP_SHADOWMAP,{light:this._light,isRenderListEmpty:!0}):(wd.Director.getInstance().scene.glslData.appendChild(wd.EShaderGLSLData.CUBEMAP_SHADOWMAP,{light:this._light,isRenderListEmpty:!1}),scene=wd.Director.getInstance().scene,scene.glslData.appendChild(wd.EShaderGLSLData.BUILD_CUBEMAP_SHADOWMAP,{light:this._light}),void this._shadowMapRendererUtils.beforeRender(wd.EShaderTypeOfScene.BUILD_CUBEMAP_SHADOWMAP))},CubemapShadowMapRenderTargetRenderer.prototype.afterRender=function(){this.isRenderListEmptyWhenRender()||this._shadowMapRendererUtils.afterRender()},CubemapShadowMapRenderTargetRenderer.prototype.setCamera=function(camera){var light=this._light;camera.aspect=light.shadowMapWidth/light.shadowMapHeight,camera.near=light.shadowCameraNear,camera.far=light.shadowCameraFar},CubemapShadowMapRenderTargetRenderer.prototype.getPosition=function(){return this._light.position},CubemapShadowMapRenderTargetRenderer}(wd.CubemapRenderTargetRenderer);wd.CubemapShadowMapRenderTargetRenderer=CubemapShadowMapRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var DynamicCubemapRenderTargetRenderer=function(_super){function DynamicCubemapRenderTargetRenderer(){_super.apply(this,arguments)}return __extends(DynamicCubemapRenderTargetRenderer,_super),DynamicCubemapRenderTargetRenderer.create=function(texture){var obj=new this(texture);return obj.initWhenCreate(),obj},DynamicCubemapRenderTargetRenderer.prototype.getRenderList=function(){return this.texture.renderList},DynamicCubemapRenderTargetRenderer.prototype.setCamera=function(camera){camera.aspect=1,camera.near=this.texture.near,camera.far=this.texture.far},DynamicCubemapRenderTargetRenderer.prototype.getPosition=function(){return this.texture.getPosition()},DynamicCubemapRenderTargetRenderer.prototype.beforeRender=function(){this.isRenderListEmptyWhenRender()?wd.Director.getInstance().scene.glslData.addChild(wd.EShaderGLSLData.DYNAMIC_CUBEMAP,{isRenderListEmpty:!0}):wd.Director.getInstance().scene.glslData.addChild(wd.EShaderGLSLData.DYNAMIC_CUBEMAP,{isRenderListEmpty:!1})},DynamicCubemapRenderTargetRenderer}(wd.CubemapRenderTargetRenderer);wd.DynamicCubemapRenderTargetRenderer=DynamicCubemapRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var ShadowMapRenderTargetRendererUtils=function(){function ShadowMapRenderTargetRendererUtils(_light,_texture){this._texture=null,this._light=null,this._light=_light,this._texture=_texture}return ShadowMapRenderTargetRendererUtils.prototype.initWhenCreate=function(){this._texture.width=this._light.shadowMapWidth,this._texture.height=this._light.shadowMapHeight},ShadowMapRenderTargetRendererUtils.prototype.beforeRender=function(shaderType){wd.Director.getInstance().scene.useShaderType(shaderType)},ShadowMapRenderTargetRendererUtils.prototype.afterRender=function(){wd.Director.getInstance().scene.unUseShader()},ShadowMapRenderTargetRendererUtils.prototype.renderRenderer=function(renderer){this.setWebglState(renderer),renderer.render()},ShadowMapRenderTargetRendererUtils}();wd.ShadowMapRenderTargetRendererUtils=ShadowMapRenderTargetRendererUtils}(wd||(wd={}));var wd;!function(wd){var CubemapShadowMapRenderTargetRendererUtils=function(_super){function CubemapShadowMapRenderTargetRendererUtils(){_super.apply(this,arguments)}return __extends(CubemapShadowMapRenderTargetRendererUtils,_super),CubemapShadowMapRenderTargetRendererUtils.create=function(light,texture){var obj=new this(light,texture);return obj.initWhenCreate(),obj},CubemapShadowMapRenderTargetRendererUtils.prototype.setWebglState=function(renderer){renderer.webglState=wd.BuildCubemapShadowMapState.create()},CubemapShadowMapRenderTargetRendererUtils}(wd.ShadowMapRenderTargetRendererUtils);wd.CubemapShadowMapRenderTargetRendererUtils=CubemapShadowMapRenderTargetRendererUtils}(wd||(wd={}));var wd;!function(wd){var TwoDShadowMapRenderTargetRendererUtils=function(_super){function TwoDShadowMapRenderTargetRendererUtils(){_super.apply(this,arguments)}return __extends(TwoDShadowMapRenderTargetRendererUtils,_super),TwoDShadowMapRenderTargetRendererUtils.create=function(light,texture){var obj=new this(light,texture);return obj.initWhenCreate(),obj},TwoDShadowMapRenderTargetRendererUtils.prototype.setWebglState=function(renderer){renderer.webglState=wd.BuildTwoDShadowMapState.create()},TwoDShadowMapRenderTargetRendererUtils}(wd.ShadowMapRenderTargetRendererUtils);wd.TwoDShadowMapRenderTargetRendererUtils=TwoDShadowMapRenderTargetRendererUtils}(wd||(wd={}));var wd;!function(wd){var Renderer=function(){function Renderer(){this._webglState=null,this.skyboxCommand=null}return Object.defineProperty(Renderer.prototype,"webglState",{get:function(){return this._webglState?this._webglState:wd.BasicState.create()},set:function(webglState){this._webglState=webglState},enumerable:!0,configurable:!0}),Renderer.prototype.init=function(){},__decorate([wd.virtual],Renderer.prototype,"init",null),Renderer}();wd.Renderer=Renderer}(wd||(wd={}));var wd;!function(wd){var RENDER_GROUP_MAX=31,RENDER_PRIORITY_MAX=31,SHADER_ID_MAX=1024,TEXTURE_ID_MAX=1024,BUFFER_ID_MAX=1024,TOTAL_BIT=30,RENDER_GROUP_MOVE_LEFT_BIT=TOTAL_BIT-5,RENDER_PRIORITY_MOVE_LEFT_BIT=TOTAL_BIT-5-5,SHADER_ID_MOVE_LEFT_BIT=TOTAL_BIT-5-5-10,WebGLRenderer=function(_super){function WebGLRenderer(){_super.apply(this,arguments),this._commandQueue=wdCb.Collection.create(),this._clearOptions={color:wd.Color.create("#000000")}}return __extends(WebGLRenderer,_super),WebGLRenderer.create=function(){var obj=new this;return obj},WebGLRenderer.prototype.addCommand=function(command){this._commandQueue.addChild(command),command.init()},WebGLRenderer.prototype.hasCommand=function(){return this._commandQueue.getCount()>0||!!this.skyboxCommand},WebGLRenderer.prototype.clear=function(){wd.DeviceManager.getInstance().clear(this._clearOptions)},WebGLRenderer.prototype.render=function(){var _this=this,deviceManager=wd.DeviceManager.getInstance(),webglState=this.webglState,transparentCommandArr=[],opaqueQuadCommandArr=[];if(this._commandQueue.forEach(function(command){command.webglState=webglState,command.blend?transparentCommandArr.push(command):command instanceof wd.QuadCommand?(_this._buildOpaqueCommandSortId(command),opaqueQuadCommandArr.push(command)):command.execute()},this),opaqueQuadCommandArr.length>0){this._sortOpaqueQuadCommand(opaqueQuadCommandArr);for(var _i=0,opaqueQuadCommandArr_1=opaqueQuadCommandArr;_i<opaqueQuadCommandArr_1.length;_i++){var command=opaqueQuadCommandArr_1[_i];command.execute()}}transparentCommandArr.length>0&&(deviceManager.depthWrite=!1,this._renderSortedTransparentCommands(transparentCommandArr),deviceManager.depthWrite=!0),this.skyboxCommand&&(deviceManager.depthFunc=wd.EDepthFunction.LEQUAL,this.skyboxCommand.webglState=webglState,this.skyboxCommand.execute(),deviceManager.depthFunc=wd.EDepthFunction.LESS),this._clearCommand(),this.webglState=null},WebGLRenderer.prototype.init=function(){var deviceManager=wd.DeviceManager.getInstance();deviceManager.depthTest=!0,deviceManager.blend=!1,deviceManager.setColorWrite(!0,!0,!0,!0),deviceManager.side=wd.ESide.FRONT,deviceManager.depthWrite=!0},WebGLRenderer.prototype.setClearColor=function(color){this._setClearOptions({color:color})},WebGLRenderer.prototype._renderSortedTransparentCommands=function(transparentCommandArr){for(var self=this,cameraPositionZ=wd.Director.getInstance().scene.currentCamera.transform.position.z,_i=0,_a=wd.SortUtils.insertSort(transparentCommandArr,function(a,b){return self._getObjectToCameraZDistance(cameraPositionZ,b)<self._getObjectToCameraZDistance(cameraPositionZ,a)});_i<_a.length;_i++){var command=_a[_i];command.execute()}},WebGLRenderer.prototype._getObjectToCameraZDistance=function(cameraPositionZ,cmd){return cameraPositionZ-cmd.z},WebGLRenderer.prototype._clearCommand=function(){this._commandQueue.forEach(function(command){command.dispose()}),this._commandQueue.removeAllChildren(),this.skyboxCommand&&(this.skyboxCommand.dispose(),this.skyboxCommand=null)},WebGLRenderer.prototype._setClearOptions=function(clearOptions){wdCb.ExtendUtils.extend(this._clearOptions,clearOptions)},WebGLRenderer.prototype._buildOpaqueCommandSortId=function(opaqueCommand){var target=opaqueCommand.target,targetMaterial=opaqueCommand.material;opaqueCommand.sortId=(target.renderGroup<<RENDER_GROUP_MOVE_LEFT_BIT|target.renderPriority<<RENDER_PRIORITY_MOVE_LEFT_BIT|this._buildShaderSortId(targetMaterial.shader)<<SHADER_ID_MOVE_LEFT_BIT|this._mapEntityIdToRenderId(this._getTargetTexture(targetMaterial),TEXTURE_ID_MAX))*BUFFER_ID_MAX+this._mapEntityIdToRenderId(this._getTargetBuffer(targetMaterial),BUFFER_ID_MAX)},WebGLRenderer.prototype._buildShaderSortId=function(shader){return this._mapEntityIdToRenderId(shader.program,SHADER_ID_MAX)},WebGLRenderer.prototype._getTargetTexture=function(material){return material.getTextureForRenderSort()},WebGLRenderer.prototype._getTargetBuffer=function(material){return material.geometry.buffers.getBufferForRenderSort()},WebGLRenderer.prototype._mapEntityIdToRenderId=function(entity,maxId){return entity?entity.uid%maxId:1},WebGLRenderer.prototype._sortOpaqueQuadCommand=function(opaqueCommandArr){wd.SortUtils.quickSort(opaqueCommandArr,function(commandA,commandB){return commandA.sortId<commandB.sortId},!0)},__decorate([wd.ensure(function(){wd.assert(!this._commandQueue.hasRepeatItems(),wd.Log.info.FUNC_SHOULD_NOT("has duplicate render command"))})],WebGLRenderer.prototype,"addCommand",null),__decorate([wd.require(function(){wd.assert(!!this.webglState,wd.Log.info.FUNC_MUST_DEFINE("webglState"))})],WebGLRenderer.prototype,"render",null),__decorate([wd.require(function(transparentCommandArr){wd.assert(!!wd.Director.getInstance().scene.currentCamera,wd.Log.info.FUNC_NOT_EXIST("current camera"));for(var _i=0,transparentCommandArr_1=transparentCommandArr;_i<transparentCommandArr_1.length;_i++){var command=transparentCommandArr_1[_i];wd.assert(command instanceof wd.QuadCommand,wd.Log.info.FUNC_MUST_BE("transparent command","QuadCommand"))}})],WebGLRenderer.prototype,"_renderSortedTransparentCommands",null),__decorate([wd.require(function(opaqueCommand){var target=opaqueCommand.target;wd.assert(target.renderGroup<=RENDER_GROUP_MAX&&target.renderGroup>=0,wd.Log.info.FUNC_SHOULD("renderGroup:"+target.renderGroup,"in range:[0, "+RENDER_GROUP_MAX+"]")),wd.assert(target.renderPriority<=RENDER_PRIORITY_MAX&&target.renderPriority>=0,wd.Log.info.FUNC_SHOULD("renderPriority:"+target.renderPriority,"in range:[0, "+RENDER_PRIORITY_MAX+"]"))})],WebGLRenderer.prototype,"_buildOpaqueCommandSortId",null),__decorate([wd.ensure(function(mappedId,entityId,maxId){wd.assert(mappedId>=0&&mappedId<=maxId,wd.Log.info.FUNC_SHOULD("mappedId:"+mappedId,"in range:[0, "+maxId+"]"))})],WebGLRenderer.prototype,"_mapEntityIdToRenderId",null),__decorate([wd.require(function(opaqueCommandArr){for(var _i=0,opaqueCommandArr_1=opaqueCommandArr;_i<opaqueCommandArr_1.length;_i++){var command=opaqueCommandArr_1[_i];wd.assert(command instanceof wd.QuadCommand,wd.Log.info.FUNC_MUST_BE("command","QuadCommand")),wd.assert(command.blend===!1,wd.Log.info.FUNC_MUST_BE("command","opaque command"))}})],WebGLRenderer.prototype,"_sortOpaqueQuadCommand",null),WebGLRenderer}(wd.Renderer);wd.WebGLRenderer=WebGLRenderer}(wd||(wd={}));var wd;!function(wd){var WebGLState=function(){function WebGLState(){}return WebGLState.prototype.getSide=function(material){var scene=wd.Director.getInstance().scene;return scene.side?scene.side:material.side},WebGLState}();wd.WebGLState=WebGLState}(wd||(wd={}));var wd;!function(wd){var BasicState=function(_super){function BasicState(){_super.apply(this,arguments)}return __extends(BasicState,_super),BasicState.create=function(){var obj=new this;return obj},BasicState.prototype.setState=function(material){var deviceManager=wd.DeviceManager.getInstance();deviceManager.setColorWrite(material.redWrite,material.greenWrite,material.blueWrite,material.alphaWrite),deviceManager.polygonOffsetMode=material.polygonOffsetMode,deviceManager.side=this.getSide(material),deviceManager.blend=material.blend,material.blendFuncSeparate&&material.blendEquationSeparate?(deviceManager.setBlendFuncSeparate(material.blendFuncSeparate),deviceManager.setBlendEquationSeparate(material.blendEquationSeparate)):(deviceManager.setBlendFunc(material.blendSrc,material.blendDst),deviceManager.setBlendEquation(material.blendEquation))},__decorate([wd.require(function(material){material.blendFuncSeparate&&material.blendEquationSeparate||wd.assert(!!material.blendSrc&&!!material.blendDst&&!!material.blendEquation,wdCb.Log.info.FUNC_MUST("material.blendSrc && material.blendDst && material.blendEquation","be set"))})],BasicState.prototype,"setState",null),BasicState}(wd.WebGLState);wd.BasicState=BasicState}(wd||(wd={}));var wd;!function(wd){var BuildShadowMapState=function(_super){function BuildShadowMapState(){_super.apply(this,arguments)}return __extends(BuildShadowMapState,_super),BuildShadowMapState.prototype.setState=function(material){var deviceManager=wd.DeviceManager.getInstance();deviceManager.side=this.getSide(material),deviceManager.blend=!1},BuildShadowMapState}(wd.WebGLState);wd.BuildShadowMapState=BuildShadowMapState}(wd||(wd={}));var wd;!function(wd){var BuildTwoDShadowMapState=function(_super){function BuildTwoDShadowMapState(){_super.apply(this,arguments)}return __extends(BuildTwoDShadowMapState,_super),BuildTwoDShadowMapState.create=function(){var obj=new this;return obj},BuildTwoDShadowMapState.prototype.setState=function(material){var deviceManager=wd.DeviceManager.getInstance();_super.prototype.setState.call(this,material),wd.GPUDetector.getInstance().extensionDepthTexture&&deviceManager.setColorWrite(!1,!1,!1,!1)},BuildTwoDShadowMapState}(wd.BuildShadowMapState);wd.BuildTwoDShadowMapState=BuildTwoDShadowMapState}(wd||(wd={}));var wd;!function(wd){var BuildCubemapShadowMapState=function(_super){function BuildCubemapShadowMapState(){_super.apply(this,arguments)}return __extends(BuildCubemapShadowMapState,_super),BuildCubemapShadowMapState.create=function(){var obj=new this;return obj},BuildCubemapShadowMapState}(wd.BuildShadowMapState);wd.BuildCubemapShadowMapState=BuildCubemapShadowMapState}(wd||(wd={}));var wd;!function(wd){!function(EDrawMode){EDrawMode[EDrawMode.POINTS="POINTS"]="POINTS",EDrawMode[EDrawMode.LINES="LINES"]="LINES",EDrawMode[EDrawMode.LINE_LOOP="LINE_LOOP"]="LINE_LOOP",EDrawMode[EDrawMode.LINE_STRIP="LINE_STRIP"]="LINE_STRIP",EDrawMode[EDrawMode.TRIANGLES="TRIANGLES"]="TRIANGLES",EDrawMode[EDrawMode.TRIANGLE_STRIP="TRIANGLE_STRIP"]="TRIANGLE_STRIP",EDrawMode[EDrawMode.TRANGLE_FAN="TRIANGLE_FAN"]="TRANGLE_FAN"}(wd.EDrawMode||(wd.EDrawMode={}));wd.EDrawMode}(wd||(wd={}));var wd;!function(wd){!function(EBufferType){EBufferType[EBufferType.BYTE="BYTE"]="BYTE",EBufferType[EBufferType.UNSIGNED_BYTE="UNSIGNED_BYTE"]="UNSIGNED_BYTE",EBufferType[EBufferType.SHORT="SHORT"]="SHORT",EBufferType[EBufferType.UNSIGNED_SHORT="UNSIGNED_SHORT"]="UNSIGNED_SHORT",EBufferType[EBufferType.INT="INT"]="INT",EBufferType[EBufferType.UNSIGNED_INT="UNSIGNED_INT"]="UNSIGNED_INT",EBufferType[EBufferType.FLOAT="FLOAT"]="FLOAT"}(wd.EBufferType||(wd.EBufferType={}));wd.EBufferType}(wd||(wd={}));var wd;!function(wd){!function(EBufferDataType){EBufferDataType[EBufferDataType.VERTICE="VERTICE"]="VERTICE",EBufferDataType[EBufferDataType.INDICE="INDICE"]="INDICE",EBufferDataType[EBufferDataType.NORMAL="NORMAL"]="NORMAL",EBufferDataType[EBufferDataType.TEXCOORD="TEXCOORD"]="TEXCOORD",EBufferDataType[EBufferDataType.TANGENT="TANGENT"]="TANGENT",EBufferDataType[EBufferDataType.COLOR="COLOR"]="COLOR",EBufferDataType[EBufferDataType.CUSTOM="CUSTOM"]="CUSTOM"}(wd.EBufferDataType||(wd.EBufferDataType={}));wd.EBufferDataType}(wd||(wd={}));var wd;!function(wd){!function(EBufferUsage){EBufferUsage[EBufferUsage.STREAM_DRAW="STREAM_DRAW"]="STREAM_DRAW",EBufferUsage[EBufferUsage.STATIC_DRAW="STATIC_DRAW"]="STATIC_DRAW",EBufferUsage[EBufferUsage.DYNAMIC_DRAW="DYNAMIC_DRAW"]="DYNAMIC_DRAW"}(wd.EBufferUsage||(wd.EBufferUsage={}));wd.EBufferUsage}(wd||(wd={}));var wd;!function(wd){var Buffer=function(_super){function Buffer(){_super.apply(this,arguments),this.buffer=null}return __extends(Buffer,_super),Buffer.prototype.dispose=function(){wd.DeviceManager.getInstance().gl.deleteBuffer(this.buffer),delete this.buffer},Buffer}(wd.Entity);wd.Buffer=Buffer}(wd||(wd={}));var wd;!function(wd){var InstanceBuffer=function(_super){function InstanceBuffer(){_super.apply(this,arguments),this._capacity=2048}return __extends(InstanceBuffer,_super),InstanceBuffer.create=function(){var obj=new this;return obj.initWhenCreate(),obj},Object.defineProperty(InstanceBuffer.prototype,"float32InstanceArraySize",{get:function(){return this._capacity/4},enumerable:!0,configurable:!0}),InstanceBuffer.prototype.initWhenCreate=function(){this.buffer=this._createBuffer()},InstanceBuffer.prototype.setCapacity=function(bufferCapacity){for(var capacity=this._capacity;capacity<bufferCapacity;)capacity*=2;this._capacity<capacity&&(this._capacity=capacity,this.buffer&&wd.DeviceManager.getInstance().gl.deleteBuffer(this.buffer),this.buffer=this._createBuffer())},InstanceBuffer.prototype.resetData=function(data,offsetLocations){var gl=wd.DeviceManager.getInstance().gl;gl.bindBuffer(gl.ARRAY_BUFFER,this.buffer),gl.bufferSubData(gl.ARRAY_BUFFER,0,data)},InstanceBuffer.prototype._createBuffer=function(){var gl=wd.DeviceManager.getInstance().gl,buffer=gl.createBuffer();return gl.bindBuffer(gl.ARRAY_BUFFER,buffer),gl.bufferData(gl.ARRAY_BUFFER,this._capacity,gl.DYNAMIC_DRAW),wd.BufferTable.resetBindedArrayBuffer(),buffer},InstanceBuffer}(wd.Buffer);wd.InstanceBuffer=InstanceBuffer}(wd||(wd={}));var wd;!function(wd){var CommonBuffer=function(_super){function CommonBuffer(){_super.apply(this,arguments),this.type=null,this.count=null,this.usage=null}return __extends(CommonBuffer,_super),CommonBuffer.prototype.resetBufferData=function(glBufferTargetStr,typedData,offset){void 0===offset&&(offset=0);var gl=wd.DeviceManager.getInstance().gl;return this.usage===wd.EBufferUsage.STATIC_DRAW&&0===offset?void gl.bufferData(gl[glBufferTargetStr],typedData,gl.DYNAMIC_DRAW):void gl.bufferSubData(gl[glBufferTargetStr],offset,typedData)},CommonBuffer}(wd.Buffer);wd.CommonBuffer=CommonBuffer}(wd||(wd={}));var wd;!function(wd){var ElementBuffer=function(_super){function ElementBuffer(){_super.apply(this,arguments),this.data=null}return __extends(ElementBuffer,_super),ElementBuffer.create=function(data,type,usage){void 0===type&&(type=null),void 0===usage&&(usage=wd.EBufferUsage.STATIC_DRAW);var obj=new this;return obj.initWhenCreate(data,type,usage),obj},Object.defineProperty(ElementBuffer.prototype,"typeSize",{get:function(){return this.data.BYTES_PER_ELEMENT},enumerable:!0,configurable:!0}),ElementBuffer.prototype.initWhenCreate=function(data,type,usage){var gl=wd.DeviceManager.getInstance().gl,isNeed32Bits=null,typedData=null;return this.buffer=gl.createBuffer(),this.buffer?data?(isNeed32Bits=this._checkIsNeed32Bits(data,type),typedData=this._convertToTypedArray(isNeed32Bits,data),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.buffer),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,typedData,gl[usage]),wd.BufferTable.resetBindedElementBuffer(),this._saveData(typedData,this._getType(isNeed32Bits,type),usage),this.buffer):null:(wd.Log.warn("Failed to create the this.buffer object"),null)},ElementBuffer.prototype.resetData=function(data,type,offset){void 0===type&&(type=null),void 0===offset&&(offset=0);var gl=wd.DeviceManager.getInstance().gl,isNeed32Bits=this._checkIsNeed32Bits(data,type),typedData=this._convertToTypedArray(isNeed32Bits,data);return gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.buffer),this.resetBufferData("ELEMENT_ARRAY_BUFFER",typedData,offset),this._saveData(typedData,this._getType(isNeed32Bits,type),wd.EBufferUsage.DYNAMIC_DRAW),this},ElementBuffer.prototype._convertToTypedArray=function(isNeed32Bits,data){return isNeed32Bits?new Uint32Array(data):new Uint16Array(data)},ElementBuffer.prototype._checkIsNeed32Bits=function(indices,type){var isNeed32Bits=!1;if(null!==type)return type===wd.EBufferType.UNSIGNED_INT;if(wd.GPUDetector.getInstance().extensionUintIndices)for(var _i=0,indices_1=indices;_i<indices_1.length;_i++){var indice=indices_1[_i];if(indice>65535){isNeed32Bits=!0;break}}else isNeed32Bits=!1;return isNeed32Bits},ElementBuffer.prototype._getType=function(isNeed32Bits,type){return null===type?isNeed32Bits?wd.EBufferType.UNSIGNED_INT:wd.EBufferType.UNSIGNED_SHORT:type},ElementBuffer.prototype._saveData=function(data,type,usage){this.type=type,this.count=data.length,this.data=data,this.usage=usage},__decorate([wd.ensureGetter(function(typeSize){wd.assert(typeSize>0,wd.Log.info.FUNC_SHOULD("typeSize","> 0, but actual is "+typeSize))})],ElementBuffer.prototype,"typeSize",null),__decorate([wd.require(function(data,type,offset){void 0===type&&(type=null),void 0===offset&&(offset=0),wd.assert(this.buffer,wd.Log.info.FUNC_MUST("create gl buffer"))})],ElementBuffer.prototype,"resetData",null),__decorate([wd.require(function(isNeed32Bits,type){null!==type&&(isNeed32Bits?wd.assert(type===wd.EBufferType.UNSIGNED_INT,wd.Log.info.FUNC_MUST_BE("type","UNSIGNED_SHORT, but actual is "+type)):wd.assert(type===wd.EBufferType.UNSIGNED_SHORT||type===wd.EBufferType.UNSIGNED_INT,wd.Log.info.FUNC_MUST_BE("type","UNSIGNED_SHORT or UNSIGNED_INT, but actual is "+type)))})],ElementBuffer.prototype,"_getType",null),ElementBuffer}(wd.CommonBuffer);wd.ElementBuffer=ElementBuffer}(wd||(wd={}));var wd;!function(wd){var ArrayBuffer=function(_super){function ArrayBuffer(){_super.apply(this,arguments),this.size=null,this.data=null}return __extends(ArrayBuffer,_super),ArrayBuffer.create=function(data,size,type,usage){void 0===type&&(type=wd.EBufferType.FLOAT),void 0===usage&&(usage=wd.EBufferUsage.STATIC_DRAW);var obj=new this;return obj.initWhenCreate(data,size,type,usage),obj},ArrayBuffer.prototype.initWhenCreate=function(data,size,type,usage){var gl=wd.DeviceManager.getInstance().gl,typedData=null;return this.buffer=gl.createBuffer(),this.buffer?data?(typedData=this._convertToTypedArray(data,type),gl.bindBuffer(gl.ARRAY_BUFFER,this.buffer),gl.bufferData(gl.ARRAY_BUFFER,typedData,gl[usage]),wd.BufferTable.resetBindedArrayBuffer(),this._saveData(typedData,size,type,usage),this.buffer):null:(wd.Log.warn("Failed to create the this.buffer object"),null)},ArrayBuffer.prototype.resetData=function(data,size,type,offset){void 0===size&&(size=this.size),void 0===type&&(type=this.type),void 0===offset&&(offset=0);var gl=wd.DeviceManager.getInstance().gl,typedData=this._convertToTypedArray(data,type);return gl.bindBuffer(gl.ARRAY_BUFFER,this.buffer),this.resetBufferData("ARRAY_BUFFER",typedData,offset),this._saveData(typedData,size,type,wd.EBufferUsage.DYNAMIC_DRAW),this},ArrayBuffer.prototype._convertToTypedArray=function(data,type){return new Float32Array(data)},ArrayBuffer.prototype._saveData=function(data,size,type,usage){this.size=size,this.type=type,this.count=data.length/size,this.usage=usage,this.data=data},__decorate([wd.require(function(data,size,type,offset){void 0===size&&(size=this.size),void 0===type&&(type=this.type),void 0===offset&&(offset=0),wd.assert(this.buffer,wd.Log.info.FUNC_MUST("create gl buffer"))})],ArrayBuffer.prototype,"resetData",null),ArrayBuffer}(wd.CommonBuffer);wd.ArrayBuffer=ArrayBuffer}(wd||(wd={}));var wd;!function(wd){var _table=wdCb.Hash.create();_table.addChild(wd.EBufferDataType.VERTICE,"vertices"),_table.addChild(wd.EBufferDataType.INDICE,"indices"),_table.addChild(wd.EBufferDataType.NORMAL,"normals"),_table.addChild(wd.EBufferDataType.TEXCOORD,"texCoords"),_table.addChild(wd.EBufferDataType.COLOR,"colors"),_table.addChild(wd.EBufferDataType.TANGENT,"tangents");var BufferDataTable=function(){function BufferDataTable(){}return BufferDataTable.getGeometryDataName=function(type){var result=_table.getChild(type);return result},__decorate([wd.ensure(function(result,type){wd.Log.error(void 0===result,wd.Log.info.FUNC_NOT_EXIST(type,"in BufferDataTable"))})],BufferDataTable,"getGeometryDataName",null),BufferDataTable}();wd.BufferDataTable=BufferDataTable}(wd||(wd={}));var wd;!function(wd){var Program=function(_super){function Program(){_super.apply(this,arguments),this.glProgram=null,this._getAttribLocationCache=wdCb.Hash.create(),this._sender=wd.GLSLDataSender.create(this)}return __extends(Program,_super),Program.create=function(){var obj=new this;return obj},Program.prototype.use=function(){wd.JudgeUtils.isEqual(this,wd.ProgramTable.lastUsedProgram)||(wd.ProgramTable.lastUsedProgram=this,wd.DeviceManager.getInstance().gl.useProgram(this.glProgram),this._sender.disableVertexAttribArray(),wd.BufferTable.lastBindedArrayBufferListUidStr=null)},Program.prototype.getAttribLocation=function(name){var pos=null,gl=wd.DeviceManager.getInstance().gl;return pos=this._getAttribLocationCache.getChild(name),void 0!==pos?pos:(pos=gl.getAttribLocation(this.glProgram,name),this._getAttribLocationCache.addChild(name,pos),pos)},Program.prototype.getUniformLocation=function(name){return this._sender.getUniformLocation(name)},Program.prototype.sendUniformData=function(name,type,data){if(null!==data)switch(type){case wd.EVariableType.FLOAT_1:this._sender.sendFloat1(name,data);break;case wd.EVariableType.FLOAT_2:this._sender.sendFloat2(name,data);break;case wd.EVariableType.FLOAT_3:this._sender.sendFloat3(name,data);break;case wd.EVariableType.FLOAT_4:this._sender.sendFloat4(name,data);break;case wd.EVariableType.VECTOR_2:this._sender.sendVector2(name,data);break;case wd.EVariableType.VECTOR_3:this._sender.sendVector3(name,data);break;case wd.EVariableType.VECTOR_4:this._sender.sendVector4(name,data);break;case wd.EVariableType.FLOAT_MAT3:this._sender.sendMatrix3(name,data);break;case wd.EVariableType.FLOAT_MAT4:this._sender.sendMatrix4(name,data);break;case wd.EVariableType.NUMBER_1:case wd.EVariableType.SAMPLER_CUBE:case wd.EVariableType.SAMPLER_2D:this._sender.sendNum1(name,data);break;case wd.EVariableType.SAMPLER_ARRAY:this._sender.sendSampleArray(name,data);break;default:wd.Log.error(!0,wd.Log.info.FUNC_INVALID("EVariableType:",type))}},Program.prototype.sendAttributeBuffer=function(name,type,buffer){var pos=null;pos=this.getAttribLocation(name),pos!==-1&&this._sender.addBufferToToSendList(pos,buffer)},Program.prototype.sendStructureData=function(name,type,data){this.sendUniformData(name,type,data)},Program.prototype.sendFloat1=function(name,data){this._sender.sendFloat1(name,data)},Program.prototype.sendFloat2=function(name,data){this._sender.sendFloat2(name,data)},Program.prototype.sendFloat3=function(name,data){this._sender.sendFloat3(name,data)},Program.prototype.sendFloat4=function(name,data){this._sender.sendFloat4(name,data);
},Program.prototype.sendVector2=function(name,data){this._sender.sendVector2(name,data)},Program.prototype.sendVector3=function(name,data){this._sender.sendVector3(name,data)},Program.prototype.sendVector4=function(name,data){this._sender.sendVector4(name,data)},Program.prototype.sendColor4=function(name,data){this._sender.sendColor4(name,data)},Program.prototype.sendNum1=function(name,data){this._sender.sendNum1(name,data)},Program.prototype.sendMatrix3=function(name,data){this._sender.sendMatrix3(name,data)},Program.prototype.sendMatrix4=function(name,data){this._sender.sendMatrix4(name,data)},Program.prototype.sendSampleArray=function(name,data){this._sender.sendSampleArray(name,data)},Program.prototype.sendAllBufferData=function(vaoManager){this._sender.sendAllBufferData(vaoManager),this._sender.clearBufferList()},Program.prototype.initWithShader=function(shader){var gl=wd.DeviceManager.getInstance().gl,vs=null,fs=null;return this.glProgram&&this.dispose(),this.glProgram=wd.DeviceManager.getInstance().gl.createProgram(),vs=shader.createVsShader(),fs=shader.createFsShader(),gl.attachShader(this.glProgram,vs),gl.attachShader(this.glProgram,fs),gl.bindAttribLocation(this.glProgram,0,"a_position"),gl.linkProgram(this.glProgram),wd.Log.error(gl.getProgramParameter(this.glProgram,gl.LINK_STATUS)===!1,gl.getProgramInfoLog(this.glProgram)),gl.deleteShader(vs),gl.deleteShader(fs),this},Program.prototype.dispose=function(){var gl=wd.DeviceManager.getInstance().gl;gl.deleteProgram(this.glProgram),this.glProgram=null,this._sender.dispose(),this._clearAllCache()},Program.prototype._clearAllCache=function(){this._getAttribLocationCache.removeAllChildren(),this._sender.clearAllCache()},__decorate([wd.require(function(name,type,buffer){wd.assert(buffer instanceof wd.ArrayBuffer,wd.Log.info.FUNC_MUST_BE("ArrayBuffer")),wd.assert(type===wd.EVariableType.BUFFER,wd.Log.info.FUNC_SHOULD("type","be EVariableType.BUFFER, but actual is "+type))})],Program.prototype,"sendAttributeBuffer",null),Program}(wd.Entity);wd.Program=Program}(wd||(wd={}));var wd;!function(wd){var GLSLDataSender=function(){function GLSLDataSender(program){this._program=null,this._uniformCache={},this._vertexAttribHistory=[],this._getUniformLocationCache={},this._toSendBufferArr=[],this._toSendBuffersUidStr="",this._program=program}return GLSLDataSender.create=function(program){var obj=new this(program);return obj},GLSLDataSender.prototype.sendFloat1=function(name,data){var gl=null,pos=null;this._uniformCache[name]!=data&&(this._recordUniformData(name,data),gl=wd.DeviceManager.getInstance().gl,pos=this.getUniformLocation(name),this._isUniformDataNotExistByLocation(pos)||gl.uniform1f(pos,Number(data)))},GLSLDataSender.prototype.sendFloat2=function(name,data){var gl=null,pos=null,recordedData=this._uniformCache[name];recordedData&&recordedData[0]===data[0]&&recordedData[1]===data[1]||(this._recordUniformData(name,data),gl=wd.DeviceManager.getInstance().gl,pos=this.getUniformLocation(name),this._isUniformDataNotExistByLocation(pos)||gl.uniform2f(pos,data[0],data[1]))},GLSLDataSender.prototype.sendFloat3=function(name,data){var gl=null,pos=null,recordedData=this._uniformCache[name];recordedData&&recordedData[0]===data[0]&&recordedData[1]===data[1]&&recordedData[2]===data[2]||(this._recordUniformData(name,data),gl=wd.DeviceManager.getInstance().gl,pos=this.getUniformLocation(name),this._isUniformDataNotExistByLocation(pos)||gl.uniform3f(pos,data[0],data[1],data[2]))},GLSLDataSender.prototype.sendFloat4=function(name,data){var gl=null,pos=null,recordedData=this._uniformCache[name];recordedData&&recordedData[0]===data[0]&&recordedData[1]===data[1]&&recordedData[2]===data[2]&&recordedData[3]===data[3]||(this._recordUniformData(name,data),gl=wd.DeviceManager.getInstance().gl,pos=this.getUniformLocation(name),this._isUniformDataNotExistByLocation(pos)||gl.uniform4f(pos,data[0],data[1],data[2],data[3]))},GLSLDataSender.prototype.sendVector2=function(name,data){var gl=null,pos=null,recordedData=this._uniformCache[name];if(!recordedData||recordedData[0]!=data.x||recordedData[1]!=data.y){var x=data.x,y=data.y;this._recordUniformData(name,[x,y]),gl=wd.DeviceManager.getInstance().gl,pos=this.getUniformLocation(name),this._isUniformDataNotExistByLocation(pos)||gl.uniform2f(pos,x,y)}},GLSLDataSender.prototype.sendVector3=function(name,data){var gl=null,pos=null,recordedData=this._uniformCache[name];if(!recordedData||recordedData[0]!=data.x||recordedData[1]!=data.y||recordedData[2]!=data.z){var x=data.x,y=data.y,z=data.z;this._recordUniformData(name,[x,y,z]),gl=wd.DeviceManager.getInstance().gl,pos=this.getUniformLocation(name),this._isUniformDataNotExistByLocation(pos)||gl.uniform3f(pos,x,y,z)}},GLSLDataSender.prototype.sendVector4=function(name,data){var gl=null,pos=null,recordedData=this._uniformCache[name];if(!recordedData||recordedData[0]!=data.x||recordedData[1]!=data.y||recordedData[2]!=data.z||recordedData[3]!=data.w){var x=data.x,y=data.y,z=data.z,w=data.w;this._recordUniformData(name,[x,y,z,w]),gl=wd.DeviceManager.getInstance().gl,pos=this.getUniformLocation(name),this._isUniformDataNotExistByLocation(pos)||gl.uniform4f(pos,x,y,z,w)}},GLSLDataSender.prototype.sendColor4=function(name,data){var gl=null,pos=null,recordedData=this._uniformCache[name];if(!recordedData||recordedData[0]!=data.r||recordedData[1]!=data.g||recordedData[2]!=data.b||recordedData[3]!=data.a){var r=data.r,g=data.g,b=data.b,a=data.a;this._recordUniformData(name,[r,g,b,a]),gl=wd.DeviceManager.getInstance().gl,pos=this.getUniformLocation(name),this._isUniformDataNotExistByLocation(pos)||gl.uniform4f(pos,r,g,b,a)}},GLSLDataSender.prototype.sendNum1=function(name,data){var gl=null,pos=null;this._uniformCache[name]!==data&&(this._recordUniformData(name,data),gl=wd.DeviceManager.getInstance().gl,pos=this.getUniformLocation(name),this._isUniformDataNotExistByLocation(pos)||gl.uniform1i(pos,data))},GLSLDataSender.prototype.sendMatrix3=function(name,data){var gl=wd.DeviceManager.getInstance().gl,pos=this.getUniformLocation(name);this._isUniformDataNotExistByLocation(pos)||gl.uniformMatrix3fv(pos,!1,data.values)},GLSLDataSender.prototype.sendMatrix4=function(name,data){var gl=wd.DeviceManager.getInstance().gl,pos=this.getUniformLocation(name);this._isUniformDataNotExistByLocation(pos)||gl.uniformMatrix4fv(pos,!1,data.values)},GLSLDataSender.prototype.sendSampleArray=function(name,data){var gl=null,pos=null,recordedData=this._uniformCache[name],isEqual=!0;if(recordedData){for(var i=0,len=data.length;i<len;i++)if(recordedData[i]!==data[i]){isEqual=!1;break}if(isEqual)return}this._recordUniformData(name,data),gl=wd.DeviceManager.getInstance().gl,pos=this.getUniformLocation(name),this._isUniformDataNotExistByLocation(pos)||gl.uniform1iv(pos,data)},GLSLDataSender.prototype.getUniformLocation=function(name){var pos=null,gl=wd.DeviceManager.getInstance().gl;return pos=this._getUniformLocationCache[name],void 0!==pos?pos:(pos=gl.getUniformLocation(this._program.glProgram,name),this._getUniformLocationCache[name]=pos,pos)},GLSLDataSender.prototype.addBufferToToSendList=function(pos,buffer){this._toSendBufferArr[pos]=buffer,this._toSendBuffersUidStr+=String(buffer.uid)},GLSLDataSender.prototype.sendAllBufferData=function(vaoManager){var toSendBufferArr=this._toSendBufferArr;if(vaoManager)return void vaoManager.sendAllBufferData(this._toSendBuffersUidStr,toSendBufferArr);for(var pos=0,len=toSendBufferArr.length;pos<len;pos++){var buffer=toSendBufferArr[pos];buffer&&this.sendBuffer(pos,buffer)}},GLSLDataSender.prototype.clearBufferList=function(){this._toSendBufferArr=[],this._toSendBuffersUidStr=""},GLSLDataSender.prototype.sendBuffer=function(pos,buffer){var gl=wd.DeviceManager.getInstance().gl;gl.bindBuffer(gl.ARRAY_BUFFER,buffer.buffer),gl.vertexAttribPointer(pos,buffer.size,gl[buffer.type],!1,0,0),this._vertexAttribHistory[pos]!==!0&&(gl.enableVertexAttribArray(pos),this._vertexAttribHistory[pos]=!0)},GLSLDataSender.prototype.disableVertexAttribArray=function(){var gl=wd.DeviceManager.getInstance().gl;for(var i in this._vertexAttribHistory){var iAsNumber=+i;iAsNumber>gl.VERTEX_ATTRIB_ARRAY_ENABLED||!this._vertexAttribHistory[iAsNumber]||(this._vertexAttribHistory[iAsNumber]=!1,gl.disableVertexAttribArray(iAsNumber))}this._vertexAttribHistory=[]},GLSLDataSender.prototype.clearAllCache=function(){this._getUniformLocationCache={},this._uniformCache={}},GLSLDataSender.prototype.dispose=function(){this.disableVertexAttribArray()},GLSLDataSender.prototype._recordUniformData=function(name,data){this._uniformCache[name]=data},GLSLDataSender.prototype._isUniformDataNotExistByLocation=function(pos){return null===pos},__decorate([wd.require(function(name,data){wd.assert(wd.JudgeUtils.isNumber(data),wd.Log.info.FUNC_MUST_BE("data","be number"))})],GLSLDataSender.prototype,"sendNum1",null),__decorate([wd.require(function(name,data){wd.assert(wd.JudgeUtils.isArrayExactly(data),wd.Log.info.FUNC_SHOULD("data","be array, but actual is "+data));for(var _i=0,data_1=data;_i<data_1.length;_i++){var unit=data_1[_i];wd.assert(wd.JudgeUtils.isNumber(unit),wd.Log.info.FUNC_SHOULD("data","be Array<number>, but actual is "+data))}})],GLSLDataSender.prototype,"sendSampleArray",null),__decorate([wd.require(function(){wd.assert(!wd.ArrayUtils.hasRepeatItems(this._toSendBufferArr),wd.Log.info.FUNC_SHOULD_NOT("_toSendBufferArr","has repeat buffer"))}),wd.cache(function(){return wd.BufferTable.lastBindedArrayBufferListUidStr===this._toSendBuffersUidStr},function(){},function(){wd.BufferTable.lastBindedArrayBufferListUidStr=this._toSendBuffersUidStr})],GLSLDataSender.prototype,"sendAllBufferData",null),GLSLDataSender}();wd.GLSLDataSender=GLSLDataSender}(wd||(wd={}));var wd;!function(wd){var RenderCommand=function(){function RenderCommand(){this._webglState=null,this.drawMode=wd.EDrawMode.TRIANGLES,this.blend=!1,this.vaoManager=null}return Object.defineProperty(RenderCommand.prototype,"webglState",{get:function(){return this._webglState?this._webglState:wd.BasicState.create()},set:function(webglState){this._webglState=webglState},enumerable:!0,configurable:!0}),RenderCommand.prototype.init=function(){},RenderCommand.prototype.dispose=function(){},RenderCommand.prototype.drawElements=function(indexBuffer){var startOffset=0,gl=wd.DeviceManager.getInstance().gl;wd.BufferTable.bindIndexBuffer(indexBuffer),wd.GlUtils.drawElements(gl[this.drawMode],indexBuffer.count,gl[indexBuffer.type],indexBuffer.typeSize*startOffset)},RenderCommand.prototype.drawArray=function(vertexBuffer){var startOffset=0,gl=wd.DeviceManager.getInstance().gl;wd.GlUtils.drawArrays(gl[this.drawMode],startOffset,vertexBuffer.count)},__decorate([wd.virtual],RenderCommand.prototype,"init",null),__decorate([wd.virtual],RenderCommand.prototype,"dispose",null),RenderCommand}();wd.RenderCommand=RenderCommand}(wd||(wd={}));var wd;!function(wd){var QuadCommand=function(_super){function QuadCommand(){_super.apply(this,arguments),this.vMatrix=null,this.pMatrix=null,this.buffers=null,this.material=null,this.z=null,this.target=null,this.sortId=null}return __extends(QuadCommand,_super),Object.defineProperty(QuadCommand.prototype,"program",{get:function(){return this.material.program},enumerable:!0,configurable:!0}),QuadCommand.prototype.execute=function(){var material=this.material;material.updateShader(this),this.draw(material)},QuadCommand}(wd.RenderCommand);wd.QuadCommand=QuadCommand}(wd||(wd={}));var wd;!function(wd){var SingleDrawCommand=function(_super){function SingleDrawCommand(){_super.apply(this,arguments),this._mMatrix=null,this.normalMatrix=null}return __extends(SingleDrawCommand,_super),SingleDrawCommand.create=function(){var obj=new this;return obj},Object.defineProperty(SingleDrawCommand.prototype,"mvpMatrix",{get:function(){return this.mMatrix.applyMatrix(this.vMatrix,!0).applyMatrix(this.pMatrix,!1)},enumerable:!0,configurable:!0}),Object.defineProperty(SingleDrawCommand.prototype,"mMatrix",{get:function(){return this._mMatrix},set:function(mMatrix){this._mMatrix=mMatrix},enumerable:!0,configurable:!0}),SingleDrawCommand.prototype.draw=function(material){var vertexBuffer=null,indexBuffer=this.buffers.getChild(wd.EBufferDataType.INDICE);this.webglState.setState(material),indexBuffer?this.drawElements(indexBuffer):(vertexBuffer=this.buffers.getChild(wd.EBufferDataType.VERTICE),this.drawArray(vertexBuffer))},__decorate([wd.requireGetter(function(){wd.assert(!!this.mMatrix&&!!this.vMatrix&&!!this.pMatrix,wd.Log.info.FUNC_NOT_EXIST("mMatrix or vMatrix or pMatrix"))})],SingleDrawCommand.prototype,"mvpMatrix",null),SingleDrawCommand}(wd.QuadCommand);wd.SingleDrawCommand=SingleDrawCommand}(wd||(wd={}));var wd;!function(wd){!function(EInstanceGLSLData){EInstanceGLSLData[EInstanceGLSLData.MODELMATRIX=0]="MODELMATRIX",EInstanceGLSLData[EInstanceGLSLData.NORMALMATRIX_MODELMATRIX=1]="NORMALMATRIX_MODELMATRIX"}(wd.EInstanceGLSLData||(wd.EInstanceGLSLData={}));wd.EInstanceGLSLData}(wd||(wd={}));var wd;!function(wd){var InstanceCommand=function(_super){function InstanceCommand(){_super.apply(this,arguments)}return __extends(InstanceCommand,_super),InstanceCommand}(wd.QuadCommand);wd.InstanceCommand=InstanceCommand}(wd||(wd={}));var wd;!function(wd){var HardwareInstanceCommand=function(_super){function HardwareInstanceCommand(){_super.apply(this,arguments),this.instanceList=null,this.instanceBuffer=null,this.glslData=wd.EInstanceGLSLData.MODELMATRIX}return __extends(HardwareInstanceCommand,_super),HardwareInstanceCommand.create=function(){var obj=new this;return obj},HardwareInstanceCommand.prototype.draw=function(material){var drawer=null;if(this._hasInstance()){switch(this.webglState.setState(material),this.glslData){case wd.EInstanceGLSLData.MODELMATRIX:drawer=wd.ModelMatrixHardwareInstanceDrawer.getInstance();break;case wd.EInstanceGLSLData.NORMALMATRIX_MODELMATRIX:drawer=wd.NormalMatrixModelMatrixHardwareInstanceDrawer.getInstance()}drawer.draw(this.instanceList,this.instanceBuffer,this.program,this.buffers,this.drawMode)}},HardwareInstanceCommand.prototype._hasInstance=function(){return!!this.instanceList&&this.instanceList.getCount()>0},__decorate([wd.ensure(function(hasInstance){wd.assert(wd.JudgeUtils.isBoolean(hasInstance),wd.Log.info.FUNC_SHOULD("return boolean value")),hasInstance&&(wd.assert(wd.InstanceUtils.isHardwareSupport(),wd.Log.info.FUNC_SHOULD("hardware","support instance")),wd.assert(!!this.instanceBuffer,wd.Log.info.FUNC_MUST_DEFINE("instanceBuffer")))})],HardwareInstanceCommand.prototype,"_hasInstance",null),HardwareInstanceCommand}(wd.InstanceCommand);wd.HardwareInstanceCommand=HardwareInstanceCommand}(wd||(wd={}));var wd;!function(wd){var ProceduralCommand=function(_super){function ProceduralCommand(){_super.apply(this,arguments),this.shader=null,this.indexBuffer=null,this.vertexBuffer=null}return __extends(ProceduralCommand,_super),ProceduralCommand.create=function(){var obj=new this;return obj},ProceduralCommand.prototype.init=function(){this.blend=!1,this.drawMode=wd.EDrawMode.TRIANGLES},ProceduralCommand.prototype.execute=function(){this.shader.update(this),this.drawElements(this.indexBuffer)},ProceduralCommand}(wd.RenderCommand);wd.ProceduralCommand=ProceduralCommand}(wd||(wd={}));var wd;!function(wd){var InstanceDrawer=function(){function InstanceDrawer(){}return InstanceDrawer}();wd.InstanceDrawer=InstanceDrawer}(wd||(wd={}));var wd;!function(wd){var HardwareInstanceDrawer=function(_super){function HardwareInstanceDrawer(){_super.apply(this,arguments)}return __extends(HardwareInstanceDrawer,_super),HardwareInstanceDrawer.prototype.draw=function(instanceList,instanceBuffer,program,buffers,drawMode){var indexBuffer=null,offsetLocationArr=this.getOffsetLocationArray(program);if(this.setCapacity(instanceList,instanceBuffer),this.sendGLSLData(instanceList,instanceBuffer,offsetLocationArr),indexBuffer=buffers.getChild(wd.EBufferDataType.INDICE))this._drawElementsInstancedANGLE(indexBuffer,instanceList.getCount(),drawMode);else{var vertexBuffer=buffers.getChild(wd.EBufferDataType.VERTICE);this._drawArraysInstancedANGLE(vertexBuffer,instanceList.getCount(),drawMode)}this._unBind(instanceBuffer,offsetLocationArr)},HardwareInstanceDrawer.prototype._unBind=function(instanceBuffer,offsetLocationArr){var gl=wd.DeviceManager.getInstance().gl,extension=wd.GPUDetector.getInstance().extensionInstancedArrays;gl.bindBuffer(gl.ARRAY_BUFFER,instanceBuffer.buffer);for(var _i=0,offsetLocationArr_1=offsetLocationArr;_i<offsetLocationArr_1.length;_i++){var offsetLocation=offsetLocationArr_1[_i];gl.disableVertexAttribArray(offsetLocation),extension.vertexAttribDivisorANGLE(offsetLocation,0)}},HardwareInstanceDrawer.prototype._drawElementsInstancedANGLE=function(indexBuffer,instancesCount,drawMode){var startOffset=0,gl=wd.DeviceManager.getInstance().gl;wd.BufferTable.bindIndexBuffer(indexBuffer),wd.GlUtils.drawElementsInstancedANGLE(gl[drawMode],indexBuffer.count,gl[indexBuffer.type],indexBuffer.typeSize*startOffset,instancesCount)},HardwareInstanceDrawer.prototype._drawArraysInstancedANGLE=function(vertexBuffer,instancesCount,drawMode){var startOffset=0,gl=wd.DeviceManager.getInstance().gl;wd.GlUtils.drawArraysInstancedANGLE(gl[drawMode],startOffset,vertexBuffer.count,instancesCount)},__decorate([wd.require(function(){wd.assert(wd.InstanceUtils.isHardwareSupport(),wd.Log.info.FUNC_SHOULD("hardware","support instance"))})],HardwareInstanceDrawer.prototype,"draw",null),HardwareInstanceDrawer}(wd.InstanceDrawer);wd.HardwareInstanceDrawer=HardwareInstanceDrawer}(wd||(wd={}));var wd;!function(wd){var ModelMatrixHardwareInstanceDrawer=function(_super){function ModelMatrixHardwareInstanceDrawer(){_super.apply(this,arguments)}return __extends(ModelMatrixHardwareInstanceDrawer,_super),ModelMatrixHardwareInstanceDrawer.getInstance=function(){},ModelMatrixHardwareInstanceDrawer.prototype.getOffsetLocationArray=function(program){return[program.getAttribLocation("a_mVec4_0"),program.getAttribLocation("a_mVec4_1"),program.getAttribLocation("a_mVec4_2"),program.getAttribLocation("a_mVec4_3")]},ModelMatrixHardwareInstanceDrawer.prototype.setCapacity=function(instanceList,instanceBuffer){instanceBuffer.setCapacity(64*instanceList.getCount())},ModelMatrixHardwareInstanceDrawer.prototype.sendGLSLData=function(instanceList,instanceBuffer,offsetLocationArr){var matricesArrayForInstance=new Float32Array(instanceBuffer.float32InstanceArraySize),offset=0,gl=wd.DeviceManager.getInstance().gl,extension=wd.GPUDetector.getInstance().extensionInstancedArrays;instanceList.forEach(function(instance){var mMatrix=instance.transform.localToWorldMatrix;mMatrix.cloneToArray(matricesArrayForInstance,offset),offset+=16}),instanceBuffer.resetData(matricesArrayForInstance,offsetLocationArr);for(var index=0;index<4;index++){var offsetLocation=offsetLocationArr[index];gl.enableVertexAttribArray(offsetLocation),gl.vertexAttribPointer(offsetLocation,4,gl.FLOAT,!1,64,16*index),extension.vertexAttribDivisorANGLE(offsetLocation,1)}},ModelMatrixHardwareInstanceDrawer=__decorate([wd.singleton()],ModelMatrixHardwareInstanceDrawer)}(wd.HardwareInstanceDrawer);wd.ModelMatrixHardwareInstanceDrawer=ModelMatrixHardwareInstanceDrawer}(wd||(wd={}));var wd;!function(wd){var NormalMatrixModelMatrixHardwareInstanceDrawer=function(_super){function NormalMatrixModelMatrixHardwareInstanceDrawer(){_super.apply(this,arguments)}return __extends(NormalMatrixModelMatrixHardwareInstanceDrawer,_super),NormalMatrixModelMatrixHardwareInstanceDrawer.getInstance=function(){},NormalMatrixModelMatrixHardwareInstanceDrawer.prototype.getOffsetLocationArray=function(program){return[program.getAttribLocation("a_mVec4_0"),program.getAttribLocation("a_mVec4_1"),program.getAttribLocation("a_mVec4_2"),program.getAttribLocation("a_mVec4_3"),program.getAttribLocation("a_normalVec4_0"),program.getAttribLocation("a_normalVec4_1"),program.getAttribLocation("a_normalVec4_2")]},NormalMatrixModelMatrixHardwareInstanceDrawer.prototype.setCapacity=function(instanceList,instanceBuffer){instanceBuffer.setCapacity(112*instanceList.getCount())},NormalMatrixModelMatrixHardwareInstanceDrawer.prototype.sendGLSLData=function(instanceList,instanceBuffer,offsetLocationArr){var matricesArrayForInstance=new Float32Array(instanceBuffer.float32InstanceArraySize),offset=0,gl=wd.DeviceManager.getInstance().gl,extension=wd.GPUDetector.getInstance().extensionInstancedArrays;instanceList.forEach(function(instance){var mMatrix=instance.transform.localToWorldMatrix,normalMatrix=instance.transform.normalMatrix;mMatrix.cloneToArray(matricesArrayForInstance,offset),offset+=16,normalMatrix.cloneToArray(matricesArrayForInstance,offset),offset+=9}),instanceBuffer.resetData(matricesArrayForInstance,offsetLocationArr);for(var index=0;index<4;index++){var offsetLocation=offsetLocationArr[index];gl.enableVertexAttribArray(offsetLocation),gl.vertexAttribPointer(offsetLocation,4,gl.FLOAT,!1,100,16*index),extension.vertexAttribDivisorANGLE(offsetLocation,1)}for(var index=4;index<7;index++){var offsetLocation=offsetLocationArr[index];gl.enableVertexAttribArray(offsetLocation),gl.vertexAttribPointer(offsetLocation,3,gl.FLOAT,!1,100,12*(index-4)+64),extension.vertexAttribDivisorANGLE(offsetLocation,1)}},NormalMatrixModelMatrixHardwareInstanceDrawer=__decorate([wd.singleton()],NormalMatrixModelMatrixHardwareInstanceDrawer)}(wd.HardwareInstanceDrawer);wd.NormalMatrixModelMatrixHardwareInstanceDrawer=NormalMatrixModelMatrixHardwareInstanceDrawer}(wd||(wd={}));var wd;!function(wd){var BatchInstanceCommand=function(_super){function BatchInstanceCommand(){_super.apply(this,arguments),this.instanceList=null,this.glslData=wd.EInstanceGLSLData.MODELMATRIX}return __extends(BatchInstanceCommand,_super),BatchInstanceCommand.create=function(){var obj=new this;return obj},BatchInstanceCommand.prototype.draw=function(material){var drawer=null;if(this._hasInstance()){switch(this.webglState.setState(material),this.glslData){case wd.EInstanceGLSLData.MODELMATRIX:drawer=wd.ModelMatrixBatchInstanceDrawer.getInstance();break;case wd.EInstanceGLSLData.NORMALMATRIX_MODELMATRIX:drawer=wd.NormalMatrixModelMatrixBatchInstanceDrawer.getInstance()}drawer.draw(this.instanceList,this.program,this.buffers,this.drawMode)}},BatchInstanceCommand.prototype._hasInstance=function(){return!!this.instanceList&&this.instanceList.getCount()>0},__decorate([wd.ensure(function(hasInstance){wd.assert(wd.JudgeUtils.isBoolean(hasInstance),wd.Log.info.FUNC_SHOULD("return boolean value")),hasInstance&&wd.assert(!wd.InstanceUtils.isHardwareSupport(),wd.Log.info.FUNC_SHOULD_NOT("hardware","support instance"))})],BatchInstanceCommand.prototype,"_hasInstance",null),BatchInstanceCommand}(wd.InstanceCommand);wd.BatchInstanceCommand=BatchInstanceCommand}(wd||(wd={}));var wd;!function(wd){var BatchInstanceDrawer=function(_super){function BatchInstanceDrawer(){_super.apply(this,arguments)}return __extends(BatchInstanceDrawer,_super),BatchInstanceDrawer.prototype.draw=function(instanceList,program,buffers,drawMode){var _this=this,indexBuffer=null,uniformDataNameArr=null,gl=wd.DeviceManager.getInstance().gl;if(uniformDataNameArr=this.getUniformDataNameArray(program),indexBuffer=buffers.getChild(wd.EBufferDataType.INDICE))wd.BufferTable.bindIndexBuffer(indexBuffer),instanceList.forEach(function(instance){var startOffset=0;_this.sendGLSLData(program,instance,uniformDataNameArr),wd.GlUtils.drawElements(gl[drawMode],indexBuffer.count,gl[indexBuffer.type],indexBuffer.typeSize*startOffset)},this);else{var vertexBuffer_1=buffers.getChild(wd.EBufferDataType.VERTICE);instanceList.forEach(function(instance){var startOffset=0;_this.sendGLSLData(program,instance,uniformDataNameArr),wd.GlUtils.drawArrays(gl[drawMode],startOffset,vertexBuffer_1.count)},this)}},__decorate([wd.require(function(){wd.assert(!wd.InstanceUtils.isHardwareSupport(),wd.Log.info.FUNC_SHOULD("hardware","not support instance"))})],BatchInstanceDrawer.prototype,"draw",null),BatchInstanceDrawer}(wd.InstanceDrawer);wd.BatchInstanceDrawer=BatchInstanceDrawer}(wd||(wd={}));var wd;!function(wd){var ModelMatrixBatchInstanceDrawer=function(_super){function ModelMatrixBatchInstanceDrawer(){_super.apply(this,arguments)}return __extends(ModelMatrixBatchInstanceDrawer,_super),ModelMatrixBatchInstanceDrawer.getInstance=function(){},ModelMatrixBatchInstanceDrawer.prototype.getUniformDataNameArray=function(program){return["u_mMatrix"]},ModelMatrixBatchInstanceDrawer.prototype.sendGLSLData=function(program,instance,_a){var modelMatrixUniformDataName=_a[0];program.sendUniformData(modelMatrixUniformDataName,wd.EVariableType.FLOAT_MAT4,instance.transform.localToWorldMatrix)},ModelMatrixBatchInstanceDrawer=__decorate([wd.singleton()],ModelMatrixBatchInstanceDrawer)}(wd.BatchInstanceDrawer);wd.ModelMatrixBatchInstanceDrawer=ModelMatrixBatchInstanceDrawer}(wd||(wd={}));var wd;!function(wd){var NormalMatrixModelMatrixBatchInstanceDrawer=function(_super){function NormalMatrixModelMatrixBatchInstanceDrawer(){_super.apply(this,arguments)}return __extends(NormalMatrixModelMatrixBatchInstanceDrawer,_super),NormalMatrixModelMatrixBatchInstanceDrawer.getInstance=function(){},NormalMatrixModelMatrixBatchInstanceDrawer.prototype.getUniformDataNameArray=function(program){return["u_mMatrix","u_normalMatrix"]},NormalMatrixModelMatrixBatchInstanceDrawer.prototype.sendGLSLData=function(program,instance,_a){var modelMatrixUniformDataName=_a[0],normalMatrixUniformDataName=_a[1];program.sendUniformData(modelMatrixUniformDataName,wd.EVariableType.FLOAT_MAT4,instance.transform.localToWorldMatrix),program.sendUniformData(normalMatrixUniformDataName,wd.EVariableType.FLOAT_MAT3,instance.transform.normalMatrix)},NormalMatrixModelMatrixBatchInstanceDrawer=__decorate([wd.singleton()],NormalMatrixModelMatrixBatchInstanceDrawer)}(wd.BatchInstanceDrawer);wd.NormalMatrixModelMatrixBatchInstanceDrawer=NormalMatrixModelMatrixBatchInstanceDrawer}(wd||(wd={}));var wd;!function(wd){var GlUtils=function(){function GlUtils(){}return GlUtils.drawElements=function(mode,count,type,offset){wd.DebugStatistics.count.drawCalls++,wd.DebugStatistics.count.renderGameObjects++,this._getGl().drawElements(mode,count,type,offset)},GlUtils.drawArrays=function(mode,first,count){wd.DebugStatistics.count.drawCalls++,wd.DebugStatistics.count.renderGameObjects++,this._getGl().drawArrays(mode,first,count)},GlUtils.drawElementsInstancedANGLE=function(mode,count,type,offset,instancesCount){var extension=wd.GPUDetector.getInstance().extensionInstancedArrays;wd.DebugStatistics.count.drawCalls++,wd.DebugStatistics.count.renderGameObjects+=instancesCount,extension.drawElementsInstancedANGLE(mode,count,type,offset,instancesCount)},GlUtils.drawArraysInstancedANGLE=function(mode,startOffset,count,instancesCount){var extension=wd.GPUDetector.getInstance().extensionInstancedArrays;wd.DebugStatistics.count.drawCalls++,wd.DebugStatistics.count.renderGameObjects+=instancesCount,extension.drawArraysInstancedANGLE(mode,startOffset,count,instancesCount)},GlUtils._getGl=function(){return wd.DeviceManager.getInstance().gl},GlUtils}();wd.GlUtils=GlUtils}(wd||(wd={}));var wd;!function(wd){var FrameBuffer=function(){function FrameBuffer(width,height){this.width=null,this.height=null,this._originScissorTest=null,this._glTarget=null,this.width=width,this.height=height}return FrameBuffer.create=function(width,height){var obj=new this(width,height);return obj},Object.defineProperty(FrameBuffer.prototype,"gl",{get:function(){return wd.DeviceManager.getInstance().gl},enumerable:!0,configurable:!0}),FrameBuffer.prototype.createFrameBuffer=function(){return this.gl.createFramebuffer()},FrameBuffer.prototype.bindFrameBuffer=function(buffer){var gl=this.gl;gl.bindFramebuffer(gl.FRAMEBUFFER,buffer)},FrameBuffer.prototype.setViewport=function(){var deviceManager=wd.DeviceManager.getInstance();deviceManager.setViewport(0,0,this.width,this.height),this._originScissorTest=deviceManager.scissorTest,deviceManager.scissorTest=!1},FrameBuffer.prototype.restoreViewport=function(){var deviceManager=wd.DeviceManager.getInstance(),view=deviceManager.view;deviceManager.setViewport(0,0,view.width,view.height),deviceManager.scissorTest=this._originScissorTest},FrameBuffer.prototype.dispose=function(){this.unBindAll()},FrameBuffer.prototype.unBindAll=function(){var gl=this.gl;gl.bindFramebuffer(gl.FRAMEBUFFER,null),gl.bindRenderbuffer(gl.RENDERBUFFER,null)},FrameBuffer.prototype.unBindFrameBuffer=function(){var gl=this.gl;gl.bindFramebuffer(gl.FRAMEBUFFER,null)},FrameBuffer.prototype.createRenderBuffer=function(){var gl=this.gl,renderBuffer=gl.createRenderbuffer();return renderBuffer},FrameBuffer.prototype.attachTexture=function(glTarget,texture,attachType){void 0===attachType&&(attachType=wd.EFrameBufferAttachType.COLOR_ATTACHMENT0);var gl=this.gl;gl.framebufferTexture2D(gl.FRAMEBUFFER,gl[attachType],glTarget,texture,0),this._glTarget=glTarget},FrameBuffer.prototype.attachRenderBuffer=function(type,renderBuffer){var gl=this.gl;gl.bindRenderbuffer(gl.RENDERBUFFER,renderBuffer),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.width,this.height),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl[type],gl.RENDERBUFFER,renderBuffer)},FrameBuffer.prototype.check=function(){var gl=this.gl,e=gl.checkFramebufferStatus(gl.FRAMEBUFFER);e!==gl.FRAMEBUFFER_COMPLETE&&wd.Log.error(!0,"Frame buffer object is incomplete:"+e.toString())},__decorate([wd.ensure(function(){var deviceManager=wd.DeviceManager.getInstance();wd.assert(null!==deviceManager.scissorTest,wd.Log.info.FUNC_SHOULD_NOT("DeviceManager->scissorTest","be null"))})],FrameBuffer.prototype,"restoreViewport",null),__decorate([wd.require(function(){})],FrameBuffer.prototype,"unBindAll",null),__decorate([wd.ensure(function(renderBuffer){wd.assert(!!renderBuffer,wd.Log.info.FUNC_NOT_EXIST("renderbuffer object"))})],FrameBuffer.prototype,"createRenderBuffer",null),FrameBuffer}();wd.FrameBuffer=FrameBuffer}(wd||(wd={}));var wd;!function(wd){!function(EFrameBufferAttachType){EFrameBufferAttachType[EFrameBufferAttachType.COLOR_ATTACHMENT0="COLOR_ATTACHMENT0"]="COLOR_ATTACHMENT0",EFrameBufferAttachType[EFrameBufferAttachType.DEPTH_ATTACHMENT="DEPTH_ATTACHMENT"]="DEPTH_ATTACHMENT"}(wd.EFrameBufferAttachType||(wd.EFrameBufferAttachType={}));wd.EFrameBufferAttachType}(wd||(wd={}));var wd;!function(wd){var Shader=function(){function Shader(){this._attributes=wdCb.Hash.create(),this._uniforms=wdCb.Hash.create(),this._vsSource="",this._fsSource="",this.libDirty=!1,this.definitionDataDirty=!1,this.mapManager=wd.MapManager.create(),this.libs=wdCb.Collection.create(),this.sourceBuilder=this.createShaderSourceBuilder(),this._programCache=null,this._instanceStateCache=null}return Object.defineProperty(Shader.prototype,"attributes",{get:function(){return this._attributes},set:function(attributes){this._isNotEqual(attributes,this._attributes)&&(this.definitionDataDirty=!0),this._attributes=attributes},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"uniforms",{get:function(){return this._uniforms},set:function(uniforms){this._isNotEqual(uniforms,this._uniforms)&&(this.definitionDataDirty=!0),this._uniforms=uniforms},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"vsSource",{get:function(){return this._vsSource},set:function(vsSource){vsSource!==this._vsSource&&(this.definitionDataDirty=!0),this._vsSource=vsSource},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"fsSource",{get:function(){return this._fsSource},set:function(fsSource){fsSource!==this._fsSource&&(this.definitionDataDirty=!0),this._fsSource=fsSource},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"dirty",{get:function(){return this.libDirty||this.definitionDataDirty},enumerable:!0,configurable:!0}),Object.defineProperty(Shader.prototype,"program",{get:function(){return wd.ProgramTable.getProgram(this._getProgramTableKey())},enumerable:!0,configurable:!0}),Shader.prototype.createVsShader=function(){var gl=wd.DeviceManager.getInstance().gl;
return this._initShader(gl.createShader(gl.VERTEX_SHADER),this.vsSource)},Shader.prototype.createFsShader=function(){var gl=wd.DeviceManager.getInstance().gl;return this._initShader(gl.createShader(gl.FRAGMENT_SHADER),this.fsSource)},Shader.prototype.init=function(material){this.libs.forEach(function(lib){lib.init()}),this.judgeRefreshShader(null,material),this.mapManager.init()},Shader.prototype.dispose=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.libs.forEach(function(lib){lib.dispose()}),this.mapManager.dispose(),this._clearAllCache()},Shader.prototype.hasLib=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(args[0]instanceof wd.ShaderLib){var lib=args[0];return this.libs.hasChild(lib)}var _class_2=args[0];return this.libs.hasChildWithFunc(function(lib){return lib instanceof _class_2})},Shader.prototype.addLib=function(lib){this.libs.addChild(lib),lib.shader=this,this.libDirty=!0},Shader.prototype.addShaderLibToTop=function(lib){this.libs.unShiftChild(lib),lib.shader=this,this.libDirty=!0},Shader.prototype.getLib=function(libClass){return this.libs.findOne(function(lib){return lib instanceof libClass})},Shader.prototype.getLibs=function(){return this.libs},Shader.prototype.removeLib=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];return this.libDirty=!0,this.libs.removeChild(args[0])},Shader.prototype.removeAllLibs=function(){this.libDirty=!0,this.libs.removeAllChildren()},Shader.prototype.sortLib=function(func){this.libDirty=!0,this.libs.sort(func,!0)},Shader.prototype.getInstanceState=function(){var isModelMatrixInstance=!1,isNormalMatrixInstance=!1,isHardwareInstance=!1,isBatchInstance=!1;return this.libs.forEach(function(lib){if(lib instanceof wd.InstanceShaderLib)return lib instanceof wd.NormalMatrixHardwareInstanceShaderLib?(isNormalMatrixInstance=!0,isHardwareInstance=!0,wdCb.$BREAK):lib instanceof wd.NormalMatrixBatchInstanceShaderLib?(isNormalMatrixInstance=!0,isBatchInstance=!0,wdCb.$BREAK):lib instanceof wd.ModelMatrixHardwareInstanceShaderLib?(isModelMatrixInstance=!0,void(isHardwareInstance=!0)):lib instanceof wd.ModelMatrixBatchInstanceShaderLib?(isModelMatrixInstance=!0,void(isBatchInstance=!0)):void 0}),{isModelMatrixInstance:isModelMatrixInstance,isNormalMatrixInstance:isNormalMatrixInstance,isHardwareInstance:isHardwareInstance,isBatchInstance:isBatchInstance}},Shader.prototype.judgeRefreshShader=function(cmd,material){this.libDirty&&(this._instanceStateCache=null,this.buildDefinitionData(cmd,material)),this.definitionDataDirty&&(this._programCache=null,this._registerAndUpdateProgram(),this._programCache=null),this.libDirty=!1,this.definitionDataDirty=!1},Shader.prototype._registerAndUpdateProgram=function(){var key=this._getProgramTableKey();wd.ProgramTable.hasProgram(key)||(wd.ProgramTable.addProgram(key,wd.Program.create()),this._updateProgram())},Shader.prototype._updateProgram=function(){this.program.initWithShader(this)},Shader.prototype._getProgramTableKey=function(){return this.vsSource+"\n"+this.fsSource},Shader.prototype._initShader=function(shader,source){var gl=wd.DeviceManager.getInstance().gl;return gl.shaderSource(shader,source),gl.compileShader(shader),gl.getShaderParameter(shader,gl.COMPILE_STATUS)?shader:(wd.Log.log(gl.getShaderInfoLog(shader)),wd.Log.log("attributes:\n",this.attributes),wd.Log.log("uniforms:\n",this.uniforms),wd.Log.log("source:\n",source),void 0)},Shader.prototype._isNotEqual=function(list1,list2){var result=!1;return list1.forEach(function(data,key){var list2Data=list2.getChild(key);if(!list2Data||data.type!==list2Data.type||data.value!==list2Data.value)return result=!0,wdCb.$BREAK}),result},Shader.prototype._clearAllCache=function(){this._programCache=null,this._instanceStateCache=null},__decorate([wd.ensureGetter(function(program){wd.assert(!!program,wd.Log.info.FUNC_NOT_EXIST("program\nits table key is:"+this._getProgramTableKey()))}),wd.cacheGetter(function(){return null!==this._programCache},function(){return this._programCache},function(program){this._programCache=program})],Shader.prototype,"program",null),__decorate([wd.execOnlyOnce("_isInit")],Shader.prototype,"init",null),__decorate([wd.ensure(function(){var self=this;this.libs.forEach(function(lib){wd.assert(wd.JudgeUtils.isEqual(lib.shader,self),wd.Log.info.FUNC_SHOULD("set ShaderLib.shader to be this"))}),wd.assert(this.libDirty===!0,wd.Log.info.FUNC_SHOULD("libDirty","be true"))})],Shader.prototype,"addLib",null),__decorate([wd.ensure(function(val,lib){var self=this;wd.assert(wd.JudgeUtils.isEqual(lib,this.libs.getChild(0)),wd.Log.info.FUNC_SHOULD("add shader lib to the top")),this.libs.forEach(function(lib){wd.assert(wd.JudgeUtils.isEqual(lib.shader,self),wd.Log.info.FUNC_SHOULD("set ShaderLib.shader to be this"))}),wd.assert(this.libDirty===!0,wd.Log.info.FUNC_SHOULD("libDirty","be true"))})],Shader.prototype,"addShaderLibToTop",null),__decorate([wd.ensure(function(_a){var isModelMatrixInstance=_a.isModelMatrixInstance,isNormalMatrixInstance=_a.isNormalMatrixInstance,isHardwareInstance=_a.isHardwareInstance,isBatchInstance=_a.isBatchInstance;isNormalMatrixInstance&&wd.assert(isModelMatrixInstance===!0,wd.Log.info.FUNC_MUST_BE("modelMatrixInstance if is normalMatrixInstance")),wd.assert(!(isHardwareInstance&&isBatchInstance),wd.Log.info.FUNC_SHOULD_NOT("both be hardware insstance and batch instance"))}),wd.cache(function(){return this._instanceStateCache},function(){return this._instanceStateCache},function(instanceState){this._instanceStateCache=instanceState})],Shader.prototype,"getInstanceState",null),Shader}();wd.Shader=Shader}(wd||(wd={}));var wd;!function(wd){var CustomShader=function(_super){function CustomShader(){_super.apply(this,arguments)}return __extends(CustomShader,_super),CustomShader.create=function(){var obj=new this;return obj},CustomShader.prototype.update=function(cmd,material){var program=null;this.judgeRefreshShader(cmd,material),program=this.program,program.use(),this.libs.forEach(function(lib){lib.sendShaderVariables(program,cmd,material)}),this.mapManager.bindAndUpdate(),this.mapManager.sendData(program)},CustomShader.prototype.read=function(definitionData){this.sourceBuilder.clearShaderDefinition(),this.sourceBuilder.read(definitionData),this.libDirty=!0},CustomShader.prototype.getSampler2DUniformsAfterRead=function(){return this.sourceBuilder.uniforms.filter(function(uniform,name){return uniform.type===wd.EVariableType.SAMPLER_2D})},CustomShader.prototype.buildDefinitionData=function(cmd,material){this.sourceBuilder.build(),this.attributes=this.sourceBuilder.attributes,this.uniforms=this.sourceBuilder.uniforms,this.vsSource=this.sourceBuilder.vsSource,this.fsSource=this.sourceBuilder.fsSource},CustomShader.prototype.createShaderSourceBuilder=function(){return wd.CustomShaderSourceBuilder.create()},CustomShader}(wd.Shader);wd.CustomShader=CustomShader}(wd||(wd={}));var wd;!function(wd){var EngineShader=function(_super){function EngineShader(){_super.apply(this,arguments)}return __extends(EngineShader,_super),EngineShader.prototype.buildDefinitionData=function(cmd,material){this.libs.forEach(function(lib){lib.setShaderDefinition(cmd,material)}),this.sourceBuilder.clearShaderDefinition(),this.sourceBuilder.build(this.libs),this.attributes=this.sourceBuilder.attributes,this.uniforms=this.sourceBuilder.uniforms,this.vsSource=this.sourceBuilder.vsSource,this.fsSource=this.sourceBuilder.fsSource},EngineShader.prototype.createShaderSourceBuilder=function(){return wd.EngineShaderSourceBuilder.create()},EngineShader}(wd.Shader);wd.EngineShader=EngineShader}(wd||(wd={}));var wd;!function(wd){var CommonShader=function(_super){function CommonShader(){_super.apply(this,arguments)}return __extends(CommonShader,_super),CommonShader.create=function(){var obj=new this;return obj},CommonShader.prototype.update=function(cmd,material){var program=null;this.judgeRefreshShader(cmd,material),program=this.program,program.use(),this.libs.forEach(function(lib){lib.sendShaderVariables(program,cmd,material)}),this.mapManager.bindAndUpdate(),this.mapManager.sendData(program)},CommonShader}(wd.EngineShader);wd.CommonShader=CommonShader}(wd||(wd={}));var wd;!function(wd){var ProceduralShader=function(_super){function ProceduralShader(){_super.apply(this,arguments)}return __extends(ProceduralShader,_super),ProceduralShader.prototype.init=function(){this.addLib(wd.CommonProceduralShaderLib.create()),_super.prototype.init.call(this,null)},ProceduralShader.prototype.update=function(cmd){var program=null;this.judgeRefreshShader(cmd,null),program=this.program,program.use(),this.libs.forEach(function(lib){lib.sendShaderVariables(program,cmd)})},ProceduralShader}(wd.EngineShader);wd.ProceduralShader=ProceduralShader}(wd||(wd={}));var wd;!function(wd){var CommonProceduralShader=function(_super){function CommonProceduralShader(){_super.apply(this,arguments)}return __extends(CommonProceduralShader,_super),CommonProceduralShader.create=function(){var obj=new this;return obj},CommonProceduralShader}(wd.ProceduralShader);wd.CommonProceduralShader=CommonProceduralShader}(wd||(wd={}));var wd;!function(wd){var CustomProceduralShader=function(_super){function CustomProceduralShader(texture){_super.call(this),this._texture=null,this._texture=texture}return __extends(CustomProceduralShader,_super),CustomProceduralShader.create=function(texture){var obj=new this(texture);return obj},CustomProceduralShader.prototype.update=function(cmd){_super.prototype.update.call(this,cmd),this._texture.mapManager.bindAndUpdate(),this._texture.mapManager.sendData(this.program)},CustomProceduralShader}(wd.ProceduralShader);wd.CustomProceduralShader=CustomProceduralShader}(wd||(wd={}));var wd;!function(wd){!function(EShaderGLSLData){EShaderGLSLData[EShaderGLSLData.MIRROR="MIRROR"]="MIRROR",EShaderGLSLData[EShaderGLSLData.DYNAMIC_CUBEMAP="DYNAMIC_CUBEMAP"]="DYNAMIC_CUBEMAP",EShaderGLSLData[EShaderGLSLData.REFRACTION="REFRACTION"]="REFRACTION",EShaderGLSLData[EShaderGLSLData.TWOD_SHADOWMAP="TWOD_SHADOWMAP"]="TWOD_SHADOWMAP",EShaderGLSLData[EShaderGLSLData.BUILD_CUBEMAP_SHADOWMAP="BUILD_CUBEMAP_SHADOWMAP"]="BUILD_CUBEMAP_SHADOWMAP",EShaderGLSLData[EShaderGLSLData.CUBEMAP_SHADOWMAP="CUBEMAP_SHADOWMAP"]="CUBEMAP_SHADOWMAP"}(wd.EShaderGLSLData||(wd.EShaderGLSLData={}));wd.EShaderGLSLData}(wd||(wd={}));var wd;!function(wd){!function(EShaderTypeOfScene){EShaderTypeOfScene[EShaderTypeOfScene.BUILD_TWOD_SHADOWMAP="BUILD_TWOD_SHADOWMAP"]="BUILD_TWOD_SHADOWMAP",EShaderTypeOfScene[EShaderTypeOfScene.BUILD_CUBEMAP_SHADOWMAP="BUILD_CUBEMAP_SHADOWMAP"]="BUILD_CUBEMAP_SHADOWMAP"}(wd.EShaderTypeOfScene||(wd.EShaderTypeOfScene={}));wd.EShaderTypeOfScene}(wd||(wd={}));var wd;!function(wd){!function(EShaderMapKeyOfScene){EShaderMapKeyOfScene[EShaderMapKeyOfScene.BUILD_TWOD_SHADOWMAP_INSTANCE="BUILD_TWOD_SHADOWMAP_INSTANCE"]="BUILD_TWOD_SHADOWMAP_INSTANCE",EShaderMapKeyOfScene[EShaderMapKeyOfScene.BUILD_TWOD_SHADOWMAP_NO_INSTANCE="BUILD_TWOD_SHADOWMAP_NO_INSTANCE"]="BUILD_TWOD_SHADOWMAP_NO_INSTANCE",EShaderMapKeyOfScene[EShaderMapKeyOfScene.BUILD_CUBEMAP_SHADOWMAP_INSTANCE="BUILD_CUBEMAP_SHADOWMAP_INSTANCE"]="BUILD_CUBEMAP_SHADOWMAP_INSTANCE",EShaderMapKeyOfScene[EShaderMapKeyOfScene.BUILD_CUBEMAP_SHADOWMAP_NO_INSTANCE="BUILD_CUBEMAP_SHADOWMAP_NO_INSTANCE"]="BUILD_CUBEMAP_SHADOWMAP_NO_INSTANCE"}(wd.EShaderMapKeyOfScene||(wd.EShaderMapKeyOfScene={}));wd.EShaderMapKeyOfScene}(wd||(wd={}));var wd;!function(wd){!function(EShaderMapKey){EShaderMapKey[EShaderMapKey.DEFAULT="DEFAULT"]="DEFAULT"}(wd.EShaderMapKey||(wd.EShaderMapKey={}));wd.EShaderMapKey}(wd||(wd={}));var wd;!function(wd){var MapManager=function(){function MapManager(){this._material=null,this._textureDirty=!1,this._allMapsCache=null,this._allSingleMapsCache=null,this._shadowMapController=wd.ShadowMapController.create(),this._arrayMapController=wd.MapArrayController.create(),this._envMapController=wd.EnvMapController.create(),this._commonMapController=wd.CommonMapController.create()}return MapManager.create=function(){var obj=new this;return obj},Object.defineProperty(MapManager.prototype,"material",{get:function(){return this._material},set:function(material){this._material=material,this._envMapController.material=material,this._commonMapController.material=material},enumerable:!0,configurable:!0}),MapManager.prototype.init=function(){for(var mapArr=this._getAllMaps(),i=0,len=mapArr.length;i<len;i++){var texture=mapArr[i];texture.init()}},MapManager.prototype.addMap=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var map=null;if(args[0]instanceof wd.TextureAsset){var asset=args[0];map=asset.toTexture()}else args[0]instanceof wd.Texture&&(map=args[0]);1===args.length?this._commonMapController.addMap(map):this._commonMapController.addMap(map,args[1]),this._textureDirty=!0},MapManager.prototype.addMapArray=function(samplerName,mapArray){this._arrayMapController.addMapArray(samplerName,mapArray),this._textureDirty=!0},MapManager.prototype.addTwoDShadowMap=function(shadowMap){this._shadowMapController.addTwoDShadowMap(shadowMap),this._textureDirty=!0},MapManager.prototype.getTwoDShadowMapList=function(){return this._shadowMapController.getTwoDShadowMapList()},MapManager.prototype.hasTwoDShadowMap=function(shadowMap){return this._shadowMapController.hasTwoDShadowMap(shadowMap)},MapManager.prototype.addCubemapShadowMap=function(shadowMap){this._shadowMapController.addCubemapShadowMap(shadowMap),this._textureDirty=!0},MapManager.prototype.getCubemapShadowMapList=function(){return this._shadowMapController.getCubemapShadowMapList()},MapManager.prototype.hasCubemapShadowMap=function(shadowMap){return this._shadowMapController.hasCubemapShadowMap(shadowMap)},MapManager.prototype.getMapList=function(){return this._commonMapController.getMapList()},MapManager.prototype.hasMap=function(map){return this._commonMapController.hasMap(map)},MapManager.prototype.getMapCount=function(){return this.getMapList().getCount()},MapManager.prototype.getEnvMap=function(){return this._envMapController.getEnvMap()},MapManager.prototype.setEnvMap=function(envMap){return envMap?(this._envMapController.setEnvMap(envMap),void(this._textureDirty=!0)):(this._envMapController.setEnvMap(null),void(this._textureDirty=!0))},MapManager.prototype.removeChild=function(map){for(var _i=0,_a=this._getAllControllerArr();_i<_a.length;_i++){var controller=_a[_i];controller.removeChild(map)}this._textureDirty=!0},MapManager.prototype.removeAllChildren=function(){for(var _i=0,_a=this._getAllControllerArr();_i<_a.length;_i++){var controller=_a[_i];controller.removeAllChildren()}this._textureDirty=!0},MapManager.prototype.removeAllShdaowMaps=function(){this._shadowMapController.removeAllChildren(),this._textureDirty=!0},MapManager.prototype.dispose=function(){for(var mapArr=this._getAllMaps(),i=0,len=mapArr.length;i<len;i++){var texture=mapArr[i];texture.dispose()}this.removeAllChildren()},MapManager.prototype.bindAndUpdate=function(){for(var mapArr=this._getAllMaps(),i=0,len=mapArr.length;i<len;i++){var texture=mapArr[i];texture.bindToUnit(i),texture.needUpdate&&texture.update(i)}},MapManager.prototype.sendData=function(program){this._sendSingleMapData(program),this._arrayMapController.sendMapData(program,this._getMaxUnitOfBindedSingleMap())},MapManager.prototype._sendSingleMapData=function(program){for(var mapArr=this._getAllSingleMaps(),len=mapArr.length,i=0;i<len;i++){var texture=mapArr[i];texture.sendData(program,texture.getSamplerName(i),i)}},MapManager.prototype._getAllMaps=function(){return[].concat(this._getAllSingleMaps(),this._arrayMapController.getAllMapArr())},MapManager.prototype._getMaxUnitOfBindedSingleMap=function(){return this._getAllSingleMaps().length},MapManager.prototype._getAllSingleMaps=function(){for(var arr=[],_i=0,_a=this._getAllSingleMapControllerArr();_i<_a.length;_i++){var controller=_a[_i];arr=arr.concat(controller.getAllMapArr())}return arr},MapManager.prototype._getAllSingleMapControllerArr=function(){return[this._shadowMapController,this._envMapController,this._commonMapController]},MapManager.prototype._getAllControllerArr=function(){return[this._shadowMapController,this._envMapController,this._arrayMapController,this._commonMapController]},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.assert(args[0]instanceof wd.TextureAsset||args[0]instanceof wd.Texture,wd.Log.info.FUNC_SHOULD("arguments[0]","be TextureAsset || Texture"))})],MapManager.prototype,"addMap",null),__decorate([wd.require(function(samplerName,mapArray){wd.assert(wd.JudgeUtils.isArrayExactly(mapArray),wd.Log.info.FUNC_SHOULD("second param","be array"));for(var _i=0,mapArray_1=mapArray;_i<mapArray_1.length;_i++){var map=mapArray_1[_i];wd.assert(map instanceof wd.Texture,wd.Log.info.FUNC_SHOULD(wd.Log.info.FUNC_SHOULD("second param","be Array<Texture>")))}})],MapManager.prototype,"addMapArray",null),__decorate([wd.require(function(shadowMap){wd.assert(!this._shadowMapController.hasTwoDShadowMap(shadowMap),wd.Log.info.FUNC_SHOULD_NOT("add the shadowMap which is already exist"))})],MapManager.prototype,"addTwoDShadowMap",null),__decorate([wd.require(function(shadowMap){wd.assert(!this._shadowMapController.hasCubemapShadowMap(shadowMap),wd.Log.info.FUNC_SHOULD_NOT("add the shadowMap which is already exist"))})],MapManager.prototype,"addCubemapShadowMap",null),__decorate([wd.ensure(function(mapList){mapList.forEach(function(map){wd.assert(map instanceof wd.BasicTexture||map instanceof wd.ProceduralTexture,wd.Log.info.FUNC_SHOULD("mapList","only contain BasicTexture or ProceduralTexture"))})})],MapManager.prototype,"getMapList",null),__decorate([wd.require(function(program){for(var mapMap={},maps=this._getAllMaps(),i=0,len=maps.length;i<len;i++){var map=maps[i],samplerName=map.getSamplerName(i);wd.assert(1!==mapMap[samplerName],wd.Log.info.FUNC_SHOULD_NOT("has duplicate maps, but actual has the ones with the same samplerName:"+samplerName)),mapMap[samplerName]=1}})],MapManager.prototype,"sendData",null),__decorate([wd.ensure(function(mapArr){for(var _i=0,mapArr_1=mapArr;_i<mapArr_1.length;_i++){var map=mapArr_1[_i];wd.assert(map instanceof wd.Texture,wd.Log.info.FUNC_SHOULD("each element","be Texture"))}}),wd.cache(function(){return!this._textureDirty&&this._allMapsCache},function(){return this._allMapsCache},function(mapList){this._allMapsCache=mapList,this._textureDirty=!1})],MapManager.prototype,"_getAllMaps",null),__decorate([wd.cache(function(){return!this._textureDirty&&this._allSingleMapsCache},function(){return this._allSingleMapsCache},function(mapList){this._allSingleMapsCache=mapList,this._textureDirty=!1})],MapManager.prototype,"_getAllSingleMaps",null),MapManager}();wd.MapManager=MapManager}(wd||(wd={}));var wd;!function(wd){var MapController=function(){function MapController(){}return MapController.prototype.hasMapHelper=function(source,target){return!!source&&source.hasChild(target)},MapController.prototype.setMapOption=function(map,option){map.variableData=option},MapController}();wd.MapController=MapController}(wd||(wd={}));var wd;!function(wd){var ShadowMapController=function(_super){function ShadowMapController(){_super.apply(this,arguments),this._twoDShadowMapList=wdCb.Collection.create(),this._cubemapShadowMapList=wdCb.Collection.create()}return __extends(ShadowMapController,_super),ShadowMapController.create=function(){var obj=new this;return obj},ShadowMapController.prototype.addTwoDShadowMap=function(shadowMap){this.setMapOption(shadowMap,{samplerData:this._twoDShadowMapList.getCount()}),this._twoDShadowMapList.addChild(shadowMap)},ShadowMapController.prototype.addCubemapShadowMap=function(shadowMap){this.setMapOption(shadowMap,{samplerData:this._cubemapShadowMapList.getCount()}),this._cubemapShadowMapList.addChild(shadowMap)},ShadowMapController.prototype.hasTwoDShadowMap=function(shadowMap){return this.hasMapHelper(this._twoDShadowMapList,shadowMap)},ShadowMapController.prototype.hasCubemapShadowMap=function(shadowMap){return this.hasMapHelper(this._cubemapShadowMapList,shadowMap)},ShadowMapController.prototype.getTwoDShadowMapList=function(){return this._twoDShadowMapList},ShadowMapController.prototype.getCubemapShadowMapList=function(){return this._cubemapShadowMapList},ShadowMapController.prototype.getAllMapArr=function(){return this._twoDShadowMapList.clone(!1).addChildren(this._cubemapShadowMapList).toArray()},ShadowMapController.prototype.removeChild=function(map){this._twoDShadowMapList.removeChild(map),this._cubemapShadowMapList.removeChild(map)},ShadowMapController.prototype.removeAllChildren=function(){this._twoDShadowMapList.removeAllChildren(),this._cubemapShadowMapList.removeAllChildren()},ShadowMapController}(wd.MapController);wd.ShadowMapController=ShadowMapController}(wd||(wd={}));var wd;!function(wd){var EnvMapController=function(_super){function EnvMapController(){_super.apply(this,arguments),this.material=null,this._map=null}return __extends(EnvMapController,_super),EnvMapController.create=function(){var obj=new this;return obj},EnvMapController.prototype.setEnvMap=function(envMap){return envMap?(envMap.material=this.material,void(this._map=envMap)):void(this._map=null)},EnvMapController.prototype.getEnvMap=function(){return this._map},EnvMapController.prototype.getAllMapArr=function(){return null!==this._map?[this._map]:[]},EnvMapController.prototype.removeChild=function(map){wd.JudgeUtils.isEqual(this._map,map)&&(this._map=null)},EnvMapController.prototype.removeAllChildren=function(){this._map=null},EnvMapController}(wd.MapController);wd.EnvMapController=EnvMapController}(wd||(wd={}));var wd;!function(wd){var MapArrayController=function(_super){function MapArrayController(){_super.apply(this,arguments),this._mapArrayList=wdCb.Collection.create()}return __extends(MapArrayController,_super),MapArrayController.create=function(){var obj=new this;return obj},MapArrayController.prototype.addMapArray=function(samplerName,mapArray){this._mapArrayList.addChild({samplerName:samplerName,mapArray:mapArray})},MapArrayController.prototype.sendMapData=function(program,maxUnitOfBindedSingleMap){var self=this;this._mapArrayList.forEach(function(mapData){var arrayMapCount=mapData.mapArray.length;program.sendUniformData(mapData.samplerName+"[0]",wd.EVariableType.SAMPLER_ARRAY,self._generateMapArrayUnitArray(maxUnitOfBindedSingleMap,maxUnitOfBindedSingleMap+arrayMapCount)),maxUnitOfBindedSingleMap+=arrayMapCount})},MapArrayController.prototype.getAllMapArr=function(){var arrayMap=[];return this._mapArrayList.forEach(function(mapData){arrayMap=arrayMap.concat(mapData.mapArray)}),arrayMap},MapArrayController.prototype.removeChild=function(map){this._mapArrayList.removeChild(map)},MapArrayController.prototype.removeAllChildren=function(){this._mapArrayList.removeAllChildren()},MapArrayController.prototype._generateMapArrayUnitArray=function(startUnit,endUnit){for(var arr=[];endUnit>startUnit;)arr.push(startUnit),startUnit++;return arr},__decorate([wd.ensure(function(mapArr){for(var _i=0,mapArr_2=mapArr;_i<mapArr_2.length;_i++){var map=mapArr_2[_i];wd.assert(map instanceof wd.Texture,wd.Log.info.FUNC_SHOULD("each element","be Texture"))}})],MapArrayController.prototype,"getAllMapArr",null),__decorate([wd.ensure(function(arr,startUnit,endUnit){wd.assert(arr.length===endUnit-startUnit,wd.Log.info.FUNC_SHOULD("length","be "+(endUnit-startUnit)+", but actual is "+arr.length)),arr.length>0&&(wd.assert(arr[0]===startUnit,wd.Log.info.FUNC_SHOULD("first element","be "+startUnit+", but actual is "+arr[0])),wd.assert(arr[arr.length-1]===endUnit-1,wd.Log.info.FUNC_SHOULD("last element","be "+(endUnit-1)+", but actual is "+arr[arr.length-1])))})],MapArrayController.prototype,"_generateMapArrayUnitArray",null),MapArrayController}(wd.MapController);wd.MapArrayController=MapArrayController}(wd||(wd={}));var wd;!function(wd){var CommonMapController=function(_super){function CommonMapController(){_super.apply(this,arguments),this.material=null,this._list=wdCb.Collection.create()}return __extends(CommonMapController,_super),CommonMapController.create=function(){var obj=new this;return obj},CommonMapController.prototype.addMap=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var map=args[0];if(2===args.length){var option=args[1];this.setMapOption(map,option)}map.material=this.material,this._list.addChild(map)},CommonMapController.prototype.getAllMapArr=function(){return this._list.toArray()},CommonMapController.prototype.getMapList=function(){return this._list.filter(function(map){return map instanceof wd.BasicTexture||map instanceof wd.ProceduralTexture})},CommonMapController.prototype.hasMap=function(map){return this.hasMapHelper(this._list,map)},CommonMapController.prototype.removeChild=function(map){this._list.removeChild(map)},CommonMapController.prototype.removeAllChildren=function(){this._list.removeAllChildren()},CommonMapController}(wd.MapController);wd.CommonMapController=CommonMapController}(wd||(wd={}));var wd;!function(wd){var ShaderSourceBuilder=function(){function ShaderSourceBuilder(){this.attributes=wdCb.Hash.create(),this.uniforms=wdCb.Hash.create(),this.vsSource=null,this.fsSource=null}return ShaderSourceBuilder.prototype.dispose=function(){this.clearShaderDefinition()},ShaderSourceBuilder.prototype.convertAttributesData=function(){var self=this;this.attributes.filter(function(data){return data.value!==wd.EVariableCategory.ENGINE&&wd.JudgeUtils.isArrayExactly(data.value)}).forEach(function(data,key){data.value=self._convertArrayToArrayBuffer(data.type,data.value)})},ShaderSourceBuilder.prototype._convertArrayToArrayBuffer=function(type,value){var size=this._getBufferSize(type);return wd.ArrayBuffer.create(value,size,wd.EBufferType.FLOAT)},ShaderSourceBuilder.prototype._getBufferSize=function(type){var size=null;switch(type){case wd.EVariableType.FLOAT_1:case wd.EVariableType.NUMBER_1:size=1;break;case wd.EVariableType.FLOAT_2:size=2;break;case wd.EVariableType.FLOAT_3:size=3;break;case wd.EVariableType.FLOAT_4:size=4;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("EVariableType",type))}return size},__decorate([wd.require(function(){this.attributes.forEach(function(data){wd.assert(!wd.JudgeUtils.isFloatArray(data.value),wd.Log.info.FUNC_SHOULD_NOT("attribute->value","be Float array"))})})],ShaderSourceBuilder.prototype,"convertAttributesData",null),__decorate([wd.require(function(type,value){wd.assert(wd.JudgeUtils.isArrayExactly(value),wd.Log.info.FUNC_SHOULD("value:"+value,"be array"))})],ShaderSourceBuilder.prototype,"_convertArrayToArrayBuffer",null),ShaderSourceBuilder}();wd.ShaderSourceBuilder=ShaderSourceBuilder}(wd||(wd={}));var wd;!function(wd){var CustomShaderSourceBuilder=function(_super){function CustomShaderSourceBuilder(){_super.apply(this,arguments)}return __extends(CustomShaderSourceBuilder,_super),CustomShaderSourceBuilder.create=function(){var obj=new this;return obj},CustomShaderSourceBuilder.prototype.read=function(definitionData){definitionData.attributes&&(this.attributes=wdCb.Hash.create(definitionData.attributes)),definitionData.uniforms&&(this.uniforms=wdCb.Hash.create(definitionData.uniforms)),this.vsSource=wd.LoaderManager.getInstance().get(definitionData.vsSourceId),this.fsSource=wd.LoaderManager.getInstance().get(definitionData.fsSourceId)},CustomShaderSourceBuilder.prototype.build=function(){this.convertAttributesData()},CustomShaderSourceBuilder.prototype.clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSource=null,this.fsSource=null},CustomShaderSourceBuilder}(wd.ShaderSourceBuilder);wd.CustomShaderSourceBuilder=CustomShaderSourceBuilder}(wd||(wd={}));var wd;!function(wd){var EngineShaderSourceBuilder=function(_super){function EngineShaderSourceBuilder(){_super.apply(this,arguments),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.vsSourceDefineList=wdCb.Collection.create(),this.fsSourceDefineList=wdCb.Collection.create(),this.vsSourceExtensionList=wdCb.Collection.create(),this.fsSourceExtensionList=wdCb.Collection.create()}return __extends(EngineShaderSourceBuilder,_super),EngineShaderSourceBuilder.create=function(){var obj=new this;return obj},EngineShaderSourceBuilder.prototype.build=function(libs){this._readLibSource(libs),null===this.vsSource&&this._buildVsSource(),null===this.fsSource&&this._buildFsSource(),this.convertAttributesData()},EngineShaderSourceBuilder.prototype.clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSourceDefineList.removeAllChildren(),this.fsSourceDefineList.removeAllChildren(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null},EngineShaderSourceBuilder.prototype._readLibSource=function(libs){var setSourceLibs=libs.filter(function(lib){return null!==lib.vsSource||null!==lib.fsSource});this._judgeAndSetVsSource(setSourceLibs),this._judgeAndSetFsSource(setSourceLibs),this._judgeAndSetPartSource(libs)},EngineShaderSourceBuilder.prototype._judgeAndSetVsSource=function(setSourceLibs){var setVsSourceLib=setSourceLibs.findOne(function(lib){return null!==lib.vsSource});setVsSourceLib&&(this.vsSource=setVsSourceLib.vsSource)},EngineShaderSourceBuilder.prototype._judgeAndSetFsSource=function(setSourceLibs){var setFsSourceLib=setSourceLibs.findOne(function(lib){return null!==lib.fsSource});setFsSourceLib&&(this.fsSource=setFsSourceLib.fsSource)},EngineShaderSourceBuilder.prototype._judgeAndSetPartSource=function(libs){var vsSource=this.vsSource,fsSource=this.fsSource,attributes=this.attributes,uniforms=this.uniforms,vsSourceDefineList=this.vsSourceDefineList,fsSourceDefineList=this.fsSourceDefineList,vsSourceExtensionList=this.vsSourceExtensionList,fsSourceExtensionList=this.fsSourceExtensionList,vsSourceTop="",vsSourceDefine="",vsSourceVarDeclare="",vsSourceFuncDeclare="",vsSourceFuncDefine="",vsSourceBody="",fsSourceTop="",fsSourceDefine="",fsSourceVarDeclare="",fsSourceFuncDeclare="",fsSourceFuncDefine="",fsSourceBody="";libs.forEach(function(lib){attributes.addChildren(lib.attributes),uniforms.addChildren(lib.uniforms),null===vsSource&&(vsSourceTop+=lib.vsSourceTop,vsSourceDefine+=lib.vsSourceDefine,vsSourceVarDeclare+=lib.vsSourceVarDeclare,vsSourceFuncDeclare+=lib.vsSourceFuncDeclare,vsSourceFuncDefine+=lib.vsSourceFuncDefine,vsSourceBody+=lib.vsSourceBody,vsSourceDefineList.addChildren(lib.vsSourceDefineList),vsSourceExtensionList.addChildren(lib.vsSourceExtensionList)),null===fsSource&&(fsSourceTop+=lib.fsSourceTop,fsSourceDefine+=lib.fsSourceDefine,fsSourceVarDeclare+=lib.fsSourceVarDeclare,fsSourceFuncDeclare+=lib.fsSourceFuncDeclare,fsSourceFuncDefine+=lib.fsSourceFuncDefine,fsSourceBody+=lib.fsSourceBody,fsSourceDefineList.addChildren(lib.fsSourceDefineList),fsSourceExtensionList.addChildren(lib.fsSourceExtensionList))}),null===vsSource&&(this.vsSourceTop=vsSourceTop,this.vsSourceDefine=vsSourceDefine,this.vsSourceVarDeclare=vsSourceVarDeclare,this.vsSourceFuncDeclare=vsSourceFuncDeclare,this.vsSourceFuncDefine=vsSourceFuncDefine,this.vsSourceBody=vsSourceBody),null===fsSource&&(this.fsSourceTop=fsSourceTop,this.fsSourceDefine=fsSourceDefine,this.fsSourceVarDeclare=fsSourceVarDeclare,this.fsSourceFuncDeclare=fsSourceFuncDeclare,this.fsSourceFuncDefine=fsSourceFuncDefine,this.fsSourceBody=fsSourceBody)},EngineShaderSourceBuilder.prototype._buildVsSource=function(){
this.vsSource=this._buildVsSourceTop()+this._buildVsSourceDefine()+this._buildVsSourceVarDeclare()+this._buildVsSourceFuncDeclare()+this._buildVsSourceFuncDefine()+this._buildVsSourceBody()},EngineShaderSourceBuilder.prototype._buildFsSource=function(){this.fsSource=this._buildFsSourceTop()+this._buildFsSourceDefine()+this._buildFsSourceVarDeclare()+this._buildFsSourceFuncDeclare()+this._buildFsSourceFuncDefine()+this._buildFsSourceBody()},EngineShaderSourceBuilder.prototype._buildVsSourceTop=function(){return this._buildVsSourceExtension()+this._getPrecisionSource()+this.vsSourceTop},EngineShaderSourceBuilder.prototype._buildVsSourceDefine=function(){return this._buildSourceDefine(this.vsSourceDefineList)+this.vsSourceDefine},EngineShaderSourceBuilder.prototype._buildVsSourceExtension=function(){return this._buildSourceExtension(this.vsSourceExtensionList)},EngineShaderSourceBuilder.prototype._buildVsSourceVarDeclare=function(){return this._generateAttributeSource()+this._generateUniformSource(this.vsSourceVarDeclare,this.vsSourceFuncDefine,this.vsSourceBody)+this.vsSourceVarDeclare},EngineShaderSourceBuilder.prototype._buildVsSourceFuncDeclare=function(){return this.vsSourceFuncDeclare},EngineShaderSourceBuilder.prototype._buildVsSourceFuncDefine=function(){return this.vsSourceFuncDefine},EngineShaderSourceBuilder.prototype._buildVsSourceBody=function(){return wd.ShaderSnippet.main_begin+this.vsSourceBody+wd.ShaderSnippet.main_end},EngineShaderSourceBuilder.prototype._buildFsSourceTop=function(){return this._buildFsSourceExtension()+this._getPrecisionSource()+this.fsSourceTop},EngineShaderSourceBuilder.prototype._buildFsSourceDefine=function(){return this._buildSourceDefine(this.fsSourceDefineList)+this.fsSourceDefine},EngineShaderSourceBuilder.prototype._buildFsSourceExtension=function(){return this._buildSourceExtension(this.fsSourceExtensionList)},EngineShaderSourceBuilder.prototype._buildFsSourceVarDeclare=function(){return this._generateUniformSource(this.fsSourceVarDeclare,this.fsSourceFuncDefine,this.fsSourceBody)+this.fsSourceVarDeclare},EngineShaderSourceBuilder.prototype._buildFsSourceFuncDeclare=function(){return this.fsSourceFuncDeclare},EngineShaderSourceBuilder.prototype._buildFsSourceFuncDefine=function(){return this.fsSourceFuncDefine},EngineShaderSourceBuilder.prototype._buildFsSourceBody=function(){return wd.ShaderSnippet.main_begin+this.fsSourceBody+wd.ShaderSnippet.main_end},EngineShaderSourceBuilder.prototype._buildSourceDefine=function(defineList){var result="";return defineList.forEach(function(define){result+=void 0===define.value?"#define "+define.name+"\n":"#define "+define.name+" "+define.value+"\n"}),result},EngineShaderSourceBuilder.prototype._buildSourceExtension=function(extensionList){var result="";return extensionList.forEach(function(name){result+="#extension "+name+" : enable\n"}),result},EngineShaderSourceBuilder.prototype._getPrecisionSource=function(){var precision=wd.GPUDetector.getInstance().precision,result=null;switch(precision){case wd.EGPUPrecision.HIGHP:result=wd.ShaderChunk.highp_fragment.top;break;case wd.EGPUPrecision.MEDIUMP:result=wd.ShaderChunk.mediump_fragment.top;break;case wd.EGPUPrecision.LOWP:result=wd.ShaderChunk.lowp_fragment.top;break;default:result=""}return result},EngineShaderSourceBuilder.prototype._generateAttributeSource=function(){var result="";return this.attributes.filter(function(data,key){return!!data}).forEach(function(data,key){result+="attribute "+wd.VariableTypeTable.getVariableType(data.type)+" "+key+";\n"}),result},EngineShaderSourceBuilder.prototype._generateUniformSource=function(sourceVarDeclare,sourceFuncDefine,sourceBody){var result="",self=this;return this.uniforms.filter(function(data,key){return!!data&&data.type!==wd.EVariableType.STRUCTURE&&data.type!==wd.EVariableType.STRUCTURES&&!self._isExistInSource(key,sourceVarDeclare)&&(self._isExistInSource(key,sourceFuncDefine)||self._isExistInSource(key,sourceBody))}).forEach(function(data,key){result+="uniform "+wd.VariableTypeTable.getVariableType(data.type)+" "+key+";\n"}),result},EngineShaderSourceBuilder.prototype._isExistInSource=function(key,source){return source.indexOf(key)!==-1},__decorate([wd.require(function(libs){wd.assert(null===this.vsSource,wd.Log.info.FUNC_SHOULD("vsSource","be null")),wd.assert(null===this.fsSource,wd.Log.info.FUNC_SHOULD("fsSource","be null"))})],EngineShaderSourceBuilder.prototype,"build",null),EngineShaderSourceBuilder}(wd.ShaderSourceBuilder);wd.EngineShaderSourceBuilder=EngineShaderSourceBuilder}(wd||(wd={}));var wd;!function(wd){!function(EVariableType){EVariableType[EVariableType.FLOAT_1="FLOAT_1"]="FLOAT_1",EVariableType[EVariableType.FLOAT_2="FLOAT_2"]="FLOAT_2",EVariableType[EVariableType.FLOAT_3="FLOAT_3"]="FLOAT_3",EVariableType[EVariableType.FLOAT_4="FLOAT_4"]="FLOAT_4",EVariableType[EVariableType.VECTOR_2="VECTOR_2"]="VECTOR_2",EVariableType[EVariableType.VECTOR_3="VECTOR_3"]="VECTOR_3",EVariableType[EVariableType.VECTOR_4="VECTOR_4"]="VECTOR_4",EVariableType[EVariableType.FLOAT_MAT3="FLOAT_MAT3"]="FLOAT_MAT3",EVariableType[EVariableType.FLOAT_MAT4="FLOAT_MAT4"]="FLOAT_MAT4",EVariableType[EVariableType.BUFFER="BUFFER"]="BUFFER",EVariableType[EVariableType.SAMPLER_CUBE="SAMPLER_CUBE"]="SAMPLER_CUBE",EVariableType[EVariableType.SAMPLER_2D="SAMPLER_2D"]="SAMPLER_2D",EVariableType[EVariableType.NUMBER_1="NUMBER_1"]="NUMBER_1",EVariableType[EVariableType.STRUCTURE="STRUCTURE"]="STRUCTURE",EVariableType[EVariableType.STRUCTURES="STRUCTURES"]="STRUCTURES",EVariableType[EVariableType.SAMPLER_ARRAY="SAMPLER_ARRAY"]="SAMPLER_ARRAY"}(wd.EVariableType||(wd.EVariableType={}));wd.EVariableType}(wd||(wd={}));var wd;!function(wd){!function(EVariableSemantic){EVariableSemantic[EVariableSemantic.POSITION="POSITION"]="POSITION",EVariableSemantic[EVariableSemantic.NORMAL="NORMAL"]="NORMAL",EVariableSemantic[EVariableSemantic.TEXCOORD="TEXCOORD"]="TEXCOORD",EVariableSemantic[EVariableSemantic.TANGENT="TANGENT"]="TANGENT",EVariableSemantic[EVariableSemantic.COLOR="COLOR"]="COLOR",EVariableSemantic[EVariableSemantic.MODEL="MODEL"]="MODEL",EVariableSemantic[EVariableSemantic.VIEW="VIEW"]="VIEW",EVariableSemantic[EVariableSemantic.PROJECTION="PROJECTION"]="PROJECTION",EVariableSemantic[EVariableSemantic.MODEL_VIEW="MODEL_VIEW"]="MODEL_VIEW",EVariableSemantic[EVariableSemantic.MODEL_VIEW_PROJECTION="MODEL_VIEW_PROJECTION"]="MODEL_VIEW_PROJECTION",EVariableSemantic[EVariableSemantic.MODEL_INVERSE="MODEL_INVERSE"]="MODEL_INVERSE",EVariableSemantic[EVariableSemantic.VIEW_INVERSE="VIEW_INVERSE"]="VIEW_INVERSE",EVariableSemantic[EVariableSemantic.PROJECTION_INVERSE="PROJECTION_INVERSE"]="PROJECTION_INVERSE",EVariableSemantic[EVariableSemantic.MODEL_VIEW_INVERSE="MODEL_VIEW_INVERSE"]="MODEL_VIEW_INVERSE",EVariableSemantic[EVariableSemantic.MODEL_VIEW_PROJECTION_INVERSE="MODEL_VIEW_PROJECTION_INVERSE"]="MODEL_VIEW_PROJECTION_INVERSE",EVariableSemantic[EVariableSemantic.MODEL_INVERSE_TRANSPOSE="MODEL_INVERSE_TRANSPOSE"]="MODEL_INVERSE_TRANSPOSE",EVariableSemantic[EVariableSemantic.MODEL_VIEW_INVERSE_TRANSPOSE="MODEL_VIEW_INVERSE_TRANSPOSE"]="MODEL_VIEW_INVERSE_TRANSPOSE",EVariableSemantic[EVariableSemantic.VIEWPORT="VIEWPORT"]="VIEWPORT"}(wd.EVariableSemantic||(wd.EVariableSemantic={}));wd.EVariableSemantic}(wd||(wd={}));var wd;!function(wd){!function(EVariableCategory){EVariableCategory[EVariableCategory.ENGINE="ENGINE"]="ENGINE",EVariableCategory[EVariableCategory.CUSTOM="CUSTOM"]="CUSTOM"}(wd.EVariableCategory||(wd.EVariableCategory={}));wd.EVariableCategory}(wd||(wd={}));var wd;!function(wd){var VariableLib=function(){function VariableLib(){}return VariableLib.a_position={type:wd.EVariableType.FLOAT_3,value:wd.EVariableCategory.ENGINE},VariableLib.a_positionVec2={type:wd.EVariableType.FLOAT_2,value:wd.EVariableCategory.ENGINE},VariableLib.a_currentFramePosition={type:wd.EVariableType.FLOAT_3,value:wd.EVariableCategory.ENGINE},VariableLib.a_nextFramePosition={type:wd.EVariableType.FLOAT_3,value:wd.EVariableCategory.ENGINE},VariableLib.a_normal={type:wd.EVariableType.FLOAT_3,value:wd.EVariableCategory.ENGINE},VariableLib.a_currentFrameNormal={type:wd.EVariableType.FLOAT_3,value:wd.EVariableCategory.ENGINE},VariableLib.a_nextFrameNormal={type:wd.EVariableType.FLOAT_3,value:wd.EVariableCategory.ENGINE},VariableLib.a_color={type:wd.EVariableType.FLOAT_3,value:wd.EVariableCategory.ENGINE},VariableLib.a_texCoord={type:wd.EVariableType.FLOAT_2,value:wd.EVariableCategory.ENGINE},VariableLib.a_tangent={type:wd.EVariableType.FLOAT_3,value:wd.EVariableCategory.ENGINE},VariableLib.u_mMatrix={type:wd.EVariableType.FLOAT_MAT4,value:wd.EVariableCategory.ENGINE},VariableLib.u_vMatrix={type:wd.EVariableType.FLOAT_MAT4,value:wd.EVariableCategory.ENGINE},VariableLib.u_pMatrix={type:wd.EVariableType.FLOAT_MAT4,value:wd.EVariableCategory.ENGINE},VariableLib.u_normalMatrix={type:wd.EVariableType.FLOAT_MAT3,value:wd.EVariableCategory.ENGINE},VariableLib.u_samplerCube0={type:wd.EVariableType.SAMPLER_CUBE,value:wd.EVariableCategory.ENGINE},VariableLib.u_sampler2D0={type:wd.EVariableType.SAMPLER_2D,value:wd.EVariableCategory.ENGINE},VariableLib.u_sampler2D1={type:wd.EVariableType.SAMPLER_2D,value:wd.EVariableCategory.ENGINE},VariableLib.u_lightMapSampler={type:wd.EVariableType.SAMPLER_2D,value:wd.EVariableCategory.ENGINE},VariableLib.u_diffuseMapSampler={type:wd.EVariableType.SAMPLER_2D,value:wd.EVariableCategory.ENGINE},VariableLib.u_specularMapSampler={type:wd.EVariableType.SAMPLER_2D,value:wd.EVariableCategory.ENGINE},VariableLib.u_emissionMapSampler={type:wd.EVariableType.SAMPLER_2D,value:wd.EVariableCategory.ENGINE},VariableLib.u_normalMapSampler={type:wd.EVariableType.SAMPLER_2D,value:wd.EVariableCategory.ENGINE},VariableLib.u_reflectionMapSampler={type:wd.EVariableType.SAMPLER_2D,value:wd.EVariableCategory.ENGINE},VariableLib.u_refractionMapSampler={type:wd.EVariableType.SAMPLER_2D,value:wd.EVariableCategory.ENGINE},VariableLib.u_cameraPos={type:wd.EVariableType.VECTOR_3,value:wd.EVariableCategory.ENGINE},VariableLib.u_refractionRatio={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_reflectivity={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_map0SourceRegion={type:wd.EVariableType.VECTOR_4,value:wd.EVariableCategory.ENGINE},VariableLib.u_map1SourceRegion={type:wd.EVariableType.VECTOR_4,value:wd.EVariableCategory.ENGINE},VariableLib.u_diffuseSourceRegion={type:wd.EVariableType.VECTOR_4,value:wd.EVariableCategory.ENGINE},VariableLib.u_map0RepeatRegion={type:wd.EVariableType.VECTOR_4,value:wd.EVariableCategory.ENGINE},VariableLib.u_map1RepeatRegion={type:wd.EVariableType.VECTOR_4,value:wd.EVariableCategory.ENGINE},VariableLib.u_diffuseRepeatRegion={type:wd.EVariableType.VECTOR_4,value:wd.EVariableCategory.ENGINE},VariableLib.u_combineMode={type:wd.EVariableType.NUMBER_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_mixRatio={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_lightMapIntensity={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_diffuse={type:wd.EVariableType.VECTOR_4,value:wd.EVariableCategory.ENGINE},VariableLib.u_specular={type:wd.EVariableType.VECTOR_4,value:wd.EVariableCategory.ENGINE},VariableLib.u_emission={type:wd.EVariableType.VECTOR_4,value:wd.EVariableCategory.ENGINE},VariableLib.u_shininess={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_lightModel={type:wd.EVariableType.NUMBER_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_isBothSide={type:wd.EVariableType.NUMBER_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_opacity={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_ambient={type:wd.EVariableType.VECTOR_4,value:wd.EVariableCategory.ENGINE},VariableLib.u_directionLights={type:wd.EVariableType.STRUCTURES,value:wd.EVariableCategory.ENGINE},VariableLib.u_pointLights={type:wd.EVariableType.STRUCTURES,value:wd.EVariableCategory.ENGINE},VariableLib.u_vpMatrixFromLight={type:wd.EVariableType.FLOAT_MAT4,value:wd.EVariableCategory.ENGINE},VariableLib.u_lightPos={type:wd.EVariableType.VECTOR_3,value:wd.EVariableCategory.ENGINE},VariableLib.u_farPlane={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_interpolation={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_tilesHeightNumber={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_tilesWidthNumber={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_amplitude={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_jointColor={type:wd.EVariableType.VECTOR_3,value:wd.EVariableCategory.ENGINE},VariableLib.u_time={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_speed={type:wd.EVariableType.VECTOR_2,value:wd.EVariableCategory.ENGINE},VariableLib.u_shift={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_alphaThreshold={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_fireColor={type:wd.EVariableType.STRUCTURE,value:wd.EVariableCategory.ENGINE},VariableLib.u_layerHeightDatas={type:wd.EVariableType.STRUCTURES,value:wd.EVariableCategory.ENGINE},VariableLib.u_layerSampler2Ds={type:wd.EVariableType.SAMPLER_ARRAY,value:wd.EVariableCategory.ENGINE},VariableLib.u_herb1Color={type:wd.EVariableType.VECTOR_3,value:wd.EVariableCategory.ENGINE},VariableLib.u_herb2Color={type:wd.EVariableType.VECTOR_3,value:wd.EVariableCategory.ENGINE},VariableLib.u_herb3Color={type:wd.EVariableType.VECTOR_3,value:wd.EVariableCategory.ENGINE},VariableLib.u_groundColor={type:wd.EVariableType.VECTOR_3,value:wd.EVariableCategory.ENGINE},VariableLib.u_ampScale={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_woodColor={type:wd.EVariableType.VECTOR_3,value:wd.EVariableCategory.ENGINE},VariableLib.u_roadColor={type:wd.EVariableType.VECTOR_3,value:wd.EVariableCategory.ENGINE},VariableLib.u_skyColor={type:wd.EVariableType.VECTOR_4,value:wd.EVariableCategory.ENGINE},VariableLib.u_cloudColor={type:wd.EVariableType.VECTOR_4,value:wd.EVariableCategory.ENGINE},VariableLib.u_brickColor={type:wd.EVariableType.VECTOR_3,value:wd.EVariableCategory.ENGINE},VariableLib.u_waveData={type:wd.EVariableType.STRUCTURE,value:wd.EVariableCategory.ENGINE},VariableLib.u_windMatrix={type:wd.EVariableType.FLOAT_MAT4,value:wd.EVariableCategory.ENGINE},VariableLib.u_bumpMapSampler={type:wd.EVariableType.SAMPLER_2D,value:wd.EVariableCategory.ENGINE},VariableLib.u_levelData={type:wd.EVariableType.STRUCTURE,value:wd.EVariableCategory.ENGINE},VariableLib.a_mVec4_0={type:wd.EVariableType.FLOAT_4,value:wd.EVariableCategory.ENGINE},VariableLib.a_mVec4_1={type:wd.EVariableType.FLOAT_4,value:wd.EVariableCategory.ENGINE},VariableLib.a_mVec4_2={type:wd.EVariableType.FLOAT_4,value:wd.EVariableCategory.ENGINE},VariableLib.a_mVec4_3={type:wd.EVariableType.FLOAT_4,value:wd.EVariableCategory.ENGINE},VariableLib.a_normalVec4_0={type:wd.EVariableType.FLOAT_3,value:wd.EVariableCategory.ENGINE},VariableLib.a_normalVec4_1={type:wd.EVariableType.FLOAT_3,value:wd.EVariableCategory.ENGINE},VariableLib.a_normalVec4_2={type:wd.EVariableType.FLOAT_3,value:wd.EVariableCategory.ENGINE},VariableLib.u_isRenderListEmpty={type:wd.EVariableType.NUMBER_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_isReflectionRenderListEmpty={type:wd.EVariableType.NUMBER_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_isRefractionRenderListEmpty={type:wd.EVariableType.NUMBER_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_bitmapSampler={type:wd.EVariableType.SAMPLER_2D,value:wd.EVariableCategory.ENGINE},VariableLib.a_page={type:wd.EVariableType.FLOAT_1,value:wd.EVariableCategory.ENGINE},VariableLib.u_pageSampler2Ds={type:wd.EVariableType.SAMPLER_ARRAY,value:wd.EVariableCategory.ENGINE},VariableLib}();wd.VariableLib=VariableLib}(wd||(wd={}));var wd;!function(wd){var _table=wdCb.Hash.create();_table.addChild(wd.EVariableType.FLOAT_1,"float"),_table.addChild(wd.EVariableType.FLOAT_2,"vec2"),_table.addChild(wd.EVariableType.FLOAT_3,"vec3"),_table.addChild(wd.EVariableType.FLOAT_4,"vec4"),_table.addChild(wd.EVariableType.VECTOR_2,"vec2"),_table.addChild(wd.EVariableType.VECTOR_3,"vec3"),_table.addChild(wd.EVariableType.VECTOR_4,"vec4"),_table.addChild(wd.EVariableType.FLOAT_MAT3,"mat3"),_table.addChild(wd.EVariableType.FLOAT_MAT4,"mat4"),_table.addChild(wd.EVariableType.NUMBER_1,"int"),_table.addChild(wd.EVariableType.SAMPLER_CUBE,"samplerCube"),_table.addChild(wd.EVariableType.SAMPLER_2D,"sampler2D");var VariableTypeTable=function(){function VariableTypeTable(){}return VariableTypeTable.getVariableType=function(type){var result=_table.getChild(type);return wd.Log.error(void 0===result,wd.Log.info.FUNC_NOT_EXIST(type,"in VariableTypeTable")),result},VariableTypeTable}();wd.VariableTypeTable=VariableTypeTable}(wd||(wd={}));var wd;!function(wd){var _table=wdCb.Hash.create();_table.addChild("lightMap","u_lightMapSampler"),_table.addChild("diffuseMap","u_diffuseMapSampler"),_table.addChild("specularMap","u_specularMapSampler"),_table.addChild("emissionMap","u_emissionMapSampler"),_table.addChild("normalMap","u_normalMapSampler"),_table.addChild("reflectionMap","u_reflectionMapSampler"),_table.addChild("refractionMap","u_refractionMapSampler"),_table.addChild("bitmap","u_bitmapSampler"),_table.addChild("bumpMap","u_bumpMapSampler");var VariableNameTable=function(){function VariableNameTable(){}return VariableNameTable.getVariableName=function(name){var result=_table.getChild(name);return wd.Log.error(void 0===result,wd.Log.info.FUNC_NOT_EXIST(name,"in VariableNameTable")),result},VariableNameTable}();wd.VariableNameTable=VariableNameTable}(wd||(wd={}));var wd;!function(wd){wd.POINT_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME=[{position:"u_pointLights[0].position",color:"u_pointLights[0].color",intensity:"u_pointLights[0].intensity",constant:"u_pointLights[0].constant",linear:"u_pointLights[0].linear",quadratic:"u_pointLights[0].quadratic",range:"u_pointLights[0].range"},{position:"u_pointLights[1].position",color:"u_pointLights[1].color",intensity:"u_pointLights[1].intensity",constant:"u_pointLights[1].constant",linear:"u_pointLights[1].linear",quadratic:"u_pointLights[1].quadratic",range:"u_pointLights[1].range"},{position:"u_pointLights[2].position",color:"u_pointLights[2].color",intensity:"u_pointLights[2].intensity",constant:"u_pointLights[2].constant",linear:"u_pointLights[2].linear",quadratic:"u_pointLights[2].quadratic",range:"u_pointLights[2].range"},{position:"u_pointLights[3].position",color:"u_pointLights[3].color",intensity:"u_pointLights[3].intensity",constant:"u_pointLights[3].constant",linear:"u_pointLights[3].linear",quadratic:"u_pointLights[3].quadratic",range:"u_pointLights[3].range"}],wd.DIRECTION_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME=[{position:"u_directionLights[0].position",color:"u_directionLights[0].color",intensity:"u_directionLights[0].intensity"},{position:"u_directionLights[1].position",color:"u_directionLights[1].color",intensity:"u_directionLights[1].intensity"},{position:"u_directionLights[2].position",color:"u_directionLights[2].color",intensity:"u_directionLights[2].intensity"},{position:"u_directionLights[3].position",color:"u_directionLights[3].color",intensity:"u_directionLights[3].intensity"}]}(wd||(wd={}));var wd;!function(wd){var ShaderLib=function(){function ShaderLib(){this.shader=null}return ShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},ShaderLib.prototype.init=function(){},ShaderLib.prototype.dispose=function(){},__decorate([wd.virtual],ShaderLib.prototype,"sendShaderVariables",null),__decorate([wd.virtual],ShaderLib.prototype,"init",null),__decorate([wd.virtual],ShaderLib.prototype,"dispose",null),ShaderLib}();wd.ShaderLib=ShaderLib}(wd||(wd={}));var wd;!function(wd){var CustomShaderLib=function(_super){function CustomShaderLib(){_super.apply(this,arguments)}return __extends(CustomShaderLib,_super),CustomShaderLib.create=function(){var obj=new this;return obj},CustomShaderLib.prototype.sendShaderVariables=function(program,cmd,material){var shader=this.shader;shader.attributes.forEach(function(attribute,name){wd.CustomShaderLibUtils.sendAttributeBufferWithSemantic(name,attribute.type,attribute.value,program,cmd)}),shader.uniforms.forEach(function(uniform,name){uniform.type!==wd.EVariableType.SAMPLER_2D&&wd.CustomShaderLibUtils.sendUniformDataWithSemantic(name,uniform.type,uniform.value,program,cmd)})},CustomShaderLib}(wd.ShaderLib);wd.CustomShaderLib=CustomShaderLib}(wd||(wd={}));var wd;!function(wd){var EngineShaderLib=function(_super){function EngineShaderLib(){_super.apply(this,arguments),this.type=null,this.attributes=wdCb.Hash.create(),this.uniforms=wdCb.Hash.create(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null,this.vsSourceDefineList=wdCb.Collection.create(),this.fsSourceDefineList=wdCb.Collection.create(),this.vsSourceExtensionList=wdCb.Collection.create(),this.fsSourceExtensionList=wdCb.Collection.create()}return __extends(EngineShaderLib,_super),EngineShaderLib.prototype.setShaderDefinition=function(cmd,material){var vs=null,fs=null;this._clearShaderDefinition(),vs=this.getVsChunk(),fs=this.getFsChunk(),vs&&this.setVsSource(vs),fs&&this.setFsSource(fs)},EngineShaderLib.prototype.sendAttributeBuffer=function(program,name,data){program.sendAttributeBuffer(name,wd.EVariableType.BUFFER,data)},EngineShaderLib.prototype.sendUniformData=function(program,name,data){program.sendUniformData(name,wd.VariableLib[name].type,data)},EngineShaderLib.prototype.getVsChunk=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var type=0===args.length?this.type:args[0];return this._getChunk(type,EShaderLibType.vs)},EngineShaderLib.prototype.getFsChunk=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var type=0===args.length?this.type:args[0];return this._getChunk(type,EShaderLibType.fs)},EngineShaderLib.prototype.setVsSource=function(vs,operator){void 0===operator&&(operator="="),wd.JudgeUtils.isString(vs)?this.vsSource=vs:this._setSource(vs,EShaderLibType.vs,operator)},EngineShaderLib.prototype.setFsSource=function(fs,operator){void 0===operator&&(operator="="),wd.JudgeUtils.isString(fs)?this.fsSource=fs:this._setSource(fs,EShaderLibType.fs,operator)},EngineShaderLib.prototype.addAttributeVariable=function(variableArr){this._addVariable(this.attributes,variableArr)},EngineShaderLib.prototype.addUniformVariable=function(variableArr){this._addVariable(this.uniforms,variableArr)},EngineShaderLib.prototype._addVariable=function(target,variableArr){variableArr.forEach(function(variable){wd.assert(wd.VariableLib[variable],wd.Log.info.FUNC_SHOULD(variable,"exist in VariableLib")),target.addChild(variable,wd.VariableLib[variable])})},EngineShaderLib.prototype._clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSourceDefineList.removeAllChildren(),this.fsSourceDefineList.removeAllChildren(),this.vsSourceExtensionList.removeAllChildren(),this.fsSourceExtensionList.removeAllChildren(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null},EngineShaderLib.prototype._getChunk=function(type,sourceType){var key=null;return type?(key=type.indexOf(".glsl")>-1?""+wdCb.PathUtils.basename(type,".glsl"):sourceType===EShaderLibType.vs?type+"_vertex":type+"_fragment",wd.ShaderChunk[key]?wd.ShaderChunk[key]:wd.ShaderChunk.empty):null},EngineShaderLib.prototype._setSource=function(chunk,sourceType,operator){if(chunk)switch(operator){case"+":this[sourceType+"SourceTop"]+=chunk.top,this[sourceType+"SourceDefine"]+=chunk.define,this[sourceType+"SourceVarDeclare"]+=chunk.varDeclare,this[sourceType+"SourceFuncDeclare"]+=chunk.funcDeclare,this[sourceType+"SourceFuncDefine"]+=chunk.funcDefine,this[sourceType+"SourceBody"]+=chunk.body;break;case"=":this[sourceType+"SourceTop"]=chunk.top,this[sourceType+"SourceDefine"]=chunk.define,this[sourceType+"SourceVarDeclare"]=chunk.varDeclare,this[sourceType+"SourceFuncDeclare"]=chunk.funcDeclare,this[sourceType+"SourceFuncDefine"]=chunk.funcDefine,this[sourceType+"SourceBody"]=chunk.body;break;default:wd.Log.error(!0,wd.Log.info.FUNC_INVALID("opertor:",operator))}},__decorate([wd.virtual],EngineShaderLib.prototype,"setShaderDefinition",null),__decorate([wd.require(function(program,name,data){wd.assert(!!wd.VariableLib[name],name+" should exist in VariableLib")})],EngineShaderLib.prototype,"sendUniformData",null),__decorate([wd.require(function(){wd.assert(null===this.vsSource,wd.Log.info.FUNC_SHOULD("vsSource","be null"))})],EngineShaderLib.prototype,"setVsSource",null),__decorate([wd.require(function(){wd.assert(null===this.fsSource,wd.Log.info.FUNC_SHOULD("fsSource","be null"))})],EngineShaderLib.prototype,"setFsSource",null),__decorate([wd.require(function(target,variableArr){variableArr.forEach(function(variable){wd.it("should exist in VariableLib",function(){wd.expect(wd.VariableLib[variable]).exist})})})],EngineShaderLib.prototype,"_addVariable",null),EngineShaderLib}(wd.ShaderLib);wd.EngineShaderLib=EngineShaderLib;var EShaderLibType;!function(EShaderLibType){EShaderLibType[EShaderLibType.vs="vs"]="vs",EShaderLibType[EShaderLibType.fs="fs"]="fs"}(EShaderLibType||(EShaderLibType={}))}(wd||(wd={}));var wd;!function(wd){var CommonShaderLib=function(_super){function CommonShaderLib(){_super.apply(this,arguments),this.type="common"}return __extends(CommonShaderLib,_super),CommonShaderLib.create=function(){var obj=new this;return obj},CommonShaderLib.prototype.sendShaderVariables=function(program,cmd,material){this.sendUniformData(program,"u_vMatrix",cmd.vMatrix),this.sendUniformData(program,"u_pMatrix",cmd.pMatrix)},CommonShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_vMatrix","u_pMatrix"]),this.vsSourceDefine=wd.ShaderChunk.common_define.define+wd.ShaderChunk.common_vertex.define,this.vsSourceFuncDefine=wd.ShaderChunk.common_function.funcDefine+wd.ShaderChunk.common_vertex.funcDefine,this.fsSourceDefine=wd.ShaderChunk.common_define.define+wd.ShaderChunk.common_fragment.define,this.fsSourceFuncDefine=wd.ShaderChunk.common_function.funcDefine+wd.ShaderChunk.common_fragment.funcDefine},CommonShaderLib}(wd.EngineShaderLib);wd.CommonShaderLib=CommonShaderLib}(wd||(wd={}));var wd;!function(wd){var EndShaderLib=function(_super){function EndShaderLib(){_super.apply(this,arguments),this.type="end"}return __extends(EndShaderLib,_super),EndShaderLib.create=function(){var obj=new this;return obj},EndShaderLib.prototype.sendShaderVariables=function(program,cmd,material){program.sendAllBufferData(cmd.vaoManager)},EndShaderLib}(wd.EngineShaderLib);wd.EndShaderLib=EndShaderLib}(wd||(wd={}));var wd;!function(wd){var VerticeCommonShaderLib=function(_super){function VerticeCommonShaderLib(){_super.apply(this,arguments),this.type="vertice_common"}return __extends(VerticeCommonShaderLib,_super),VerticeCommonShaderLib.create=function(){var obj=new this;return obj},VerticeCommonShaderLib.prototype.sendShaderVariables=function(program,cmd,material){this._sendAttributeVariables(program,cmd)},VerticeCommonShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addAttributeVariable(["a_position"])},VerticeCommonShaderLib.prototype._sendAttributeVariables=function(program,cmd){var verticeBuffer=cmd.buffers.getChild(wd.EBufferDataType.VERTICE);verticeBuffer&&this.sendAttributeBuffer(program,"a_position",verticeBuffer)},VerticeCommonShaderLib}(wd.EngineShaderLib);wd.VerticeCommonShaderLib=VerticeCommonShaderLib}(wd||(wd={}));var wd;!function(wd){var NormalCommonShaderLib=function(_super){function NormalCommonShaderLib(){_super.apply(this,arguments),this.type="normal_common"}return __extends(NormalCommonShaderLib,_super),NormalCommonShaderLib.create=function(){var obj=new this;return obj},NormalCommonShaderLib.prototype.sendShaderVariables=function(program,cmd,material){this._sendAttributeVariables(program,cmd)},NormalCommonShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addAttributeVariable(["a_normal"])},NormalCommonShaderLib.prototype._sendAttributeVariables=function(program,cmd){var normalBuffer=cmd.buffers.getChild(wd.EBufferDataType.NORMAL);normalBuffer&&this.sendAttributeBuffer(program,"a_normal",normalBuffer)},NormalCommonShaderLib}(wd.EngineShaderLib);wd.NormalCommonShaderLib=NormalCommonShaderLib}(wd||(wd={}));var wd;!function(wd){var BasicShaderLib=function(_super){function BasicShaderLib(){_super.apply(this,arguments),this.type="basic"}return __extends(BasicShaderLib,_super),BasicShaderLib.create=function(){var obj=new this;return obj},BasicShaderLib.prototype.sendShaderVariables=function(program,cmd,material){var colorBuffer=cmd.buffers.getChild(wd.EBufferDataType.COLOR);colorBuffer&&(this.sendAttributeBuffer(program,"a_color",colorBuffer),this.sendUniformData(program,"u_opacity",material.opacity))},BasicShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addAttributeVariable(["a_color"]),this.addUniformVariable(["u_opacity"]),this.vsSourceBody=wd.ShaderSnippet.setPos_mvp+wd.ShaderChunk.basic_vertex.body},BasicShaderLib}(wd.EngineShaderLib);wd.BasicShaderLib=BasicShaderLib}(wd||(wd={}));var wd;!function(wd){var EndBasicShaderLib=function(_super){function EndBasicShaderLib(){_super.apply(this,arguments),this.type="end_basic"}return __extends(EndBasicShaderLib,_super),EndBasicShaderLib.create=function(){var obj=new this;return obj},EndBasicShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},EndBasicShaderLib}(wd.EngineShaderLib);wd.EndBasicShaderLib=EndBasicShaderLib}(wd||(wd={}));var wd;!function(wd){var CommonMorphShaderLib=function(_super){function CommonMorphShaderLib(){_super.apply(this,arguments),this.type="common_morph"}return __extends(CommonMorphShaderLib,_super),CommonMorphShaderLib.create=function(){var obj=new this;return obj},CommonMorphShaderLib.prototype.sendShaderVariables=function(program,cmd,material){var anim=cmd.target.getComponent(wd.MorphAnimation);this.sendUniformData(program,"u_interpolation",anim.interpolation)},CommonMorphShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_interpolation"])},__decorate([wd.require(function(program,cmd,material){wd.assert(cmd.target.hasComponent(wd.MorphAnimation),wd.Log.info.FUNC_SHOULD("entityObject","has MorphAnimation component"))})],CommonMorphShaderLib.prototype,"sendShaderVariables",null),CommonMorphShaderLib}(wd.EngineShaderLib);wd.CommonMorphShaderLib=CommonMorphShaderLib}(wd||(wd={}));var wd;!function(wd){var VerticeMorphShaderLib=function(_super){function VerticeMorphShaderLib(){_super.apply(this,arguments),this.type="vertice_morph"}return __extends(VerticeMorphShaderLib,_super),VerticeMorphShaderLib.create=function(){var obj=new this;return obj},VerticeMorphShaderLib.prototype.sendShaderVariables=function(program,cmd,material){var morphVerticeData=cmd.buffers.getChild(wd.EBufferDataType.VERTICE);morphVerticeData&&(this.sendAttributeBuffer(program,"a_currentFramePosition",morphVerticeData[0]),
this.sendAttributeBuffer(program,"a_nextFramePosition",morphVerticeData[1]))},VerticeMorphShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addAttributeVariable(["a_currentFramePosition","a_nextFramePosition"])},__decorate([wd.require(function(program,cmd,material){wd.assert(cmd.target.hasComponent(wd.MorphAnimation),wd.Log.info.FUNC_SHOULD("entityObject","has MorphAnimation component"))})],VerticeMorphShaderLib.prototype,"sendShaderVariables",null),VerticeMorphShaderLib}(wd.EngineShaderLib);wd.VerticeMorphShaderLib=VerticeMorphShaderLib}(wd||(wd={}));var wd;!function(wd){var NormalMorphShaderLib=function(_super){function NormalMorphShaderLib(){_super.apply(this,arguments),this.type="normal_morph"}return __extends(NormalMorphShaderLib,_super),NormalMorphShaderLib.create=function(){var obj=new this;return obj},NormalMorphShaderLib.prototype.sendShaderVariables=function(program,cmd,material){var morphNormalData=cmd.buffers.getChild(wd.EBufferDataType.NORMAL);morphNormalData&&(this.sendAttributeBuffer(program,"a_currentFrameNormal",morphNormalData[0]),this.sendAttributeBuffer(program,"a_nextFrameNormal",morphNormalData[1]))},NormalMorphShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addAttributeVariable(["a_currentFrameNormal","a_nextFrameNormal"])},NormalMorphShaderLib}(wd.EngineShaderLib);wd.NormalMorphShaderLib=NormalMorphShaderLib}(wd||(wd={}));var wd;!function(wd){var SkyboxShaderLib=function(_super){function SkyboxShaderLib(){_super.apply(this,arguments),this.type="skybox"}return __extends(SkyboxShaderLib,_super),SkyboxShaderLib.create=function(){var obj=new this;return obj},SkyboxShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},SkyboxShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_samplerCube0"])},SkyboxShaderLib}(wd.EngineShaderLib);wd.SkyboxShaderLib=SkyboxShaderLib}(wd||(wd={}));var wd;!function(wd){var EnvMapShaderLib=function(_super){function EnvMapShaderLib(){_super.apply(this,arguments)}return __extends(EnvMapShaderLib,_super),EnvMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_samplerCube0"]),this.vsSourceBody=this.getVsChunk().body},EnvMapShaderLib}(wd.EngineShaderLib);wd.EnvMapShaderLib=EnvMapShaderLib}(wd||(wd={}));var wd;!function(wd){var CommonEnvMapShaderLib=function(_super){function CommonEnvMapShaderLib(){_super.apply(this,arguments),this.type="common_envMap"}return __extends(CommonEnvMapShaderLib,_super),CommonEnvMapShaderLib.create=function(){var obj=new this;return obj},CommonEnvMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){wd.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(program,wd.EShaderGLSLData.DYNAMIC_CUBEMAP)},CommonEnvMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_isRenderListEmpty"])},CommonEnvMapShaderLib}(wd.EnvMapShaderLib);wd.CommonEnvMapShaderLib=CommonEnvMapShaderLib}(wd||(wd={}));var wd;!function(wd){var ForBasicEnvMapShaderLib=function(_super){function ForBasicEnvMapShaderLib(){_super.apply(this,arguments)}return __extends(ForBasicEnvMapShaderLib,_super),ForBasicEnvMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){_super.prototype.sendShaderVariables.call(this,program,cmd,material),this.sendUniformData(program,"u_cameraPos",wd.Director.getInstance().scene.currentCamera.transform.position)},ForBasicEnvMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_cameraPos"])},ForBasicEnvMapShaderLib.prototype.setEnvMapSource=function(){var vs=this.getVsChunk("forBasic_envMap"),fs=this.getFsChunk("forBasic_envMap");this.vsSourceTop=vs.top,this.vsSourceDefine=vs.define,this.vsSourceVarDeclare=vs.varDeclare,this.vsSourceFuncDeclare=vs.funcDeclare,this.vsSourceFuncDefine=vs.funcDefine,this.vsSourceBody+=vs.body,this.setFsSource(fs)},ForBasicEnvMapShaderLib}(wd.EnvMapShaderLib);wd.ForBasicEnvMapShaderLib=ForBasicEnvMapShaderLib}(wd||(wd={}));var wd;!function(wd){var BasicForBasicEnvMapShaderLib=function(_super){function BasicForBasicEnvMapShaderLib(){_super.apply(this,arguments),this.type="basic_forBasic_envMap"}return __extends(BasicForBasicEnvMapShaderLib,_super),BasicForBasicEnvMapShaderLib.create=function(){var obj=new this;return obj},BasicForBasicEnvMapShaderLib}(wd.ForBasicEnvMapShaderLib);wd.BasicForBasicEnvMapShaderLib=BasicForBasicEnvMapShaderLib}(wd||(wd={}));var wd;!function(wd){var ReflectionForBasicEnvMapShaderLib=function(_super){function ReflectionForBasicEnvMapShaderLib(){_super.apply(this,arguments),this.type="reflection_forBasic_envMap"}return __extends(ReflectionForBasicEnvMapShaderLib,_super),ReflectionForBasicEnvMapShaderLib.create=function(){var obj=new this;return obj},ReflectionForBasicEnvMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},ReflectionForBasicEnvMapShaderLib}(wd.ForBasicEnvMapShaderLib);wd.ReflectionForBasicEnvMapShaderLib=ReflectionForBasicEnvMapShaderLib}(wd||(wd={}));var wd;!function(wd){var RefractionForBasicEnvMapShaderLib=function(_super){function RefractionForBasicEnvMapShaderLib(){_super.apply(this,arguments),this.type="refraction_forBasic_envMap"}return __extends(RefractionForBasicEnvMapShaderLib,_super),RefractionForBasicEnvMapShaderLib.create=function(){var obj=new this;return obj},RefractionForBasicEnvMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){_super.prototype.sendShaderVariables.call(this,program,cmd,material),this.sendUniformData(program,"u_refractionRatio",material.refractionRatio)},RefractionForBasicEnvMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_refractionRatio"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},RefractionForBasicEnvMapShaderLib}(wd.ForBasicEnvMapShaderLib);wd.RefractionForBasicEnvMapShaderLib=RefractionForBasicEnvMapShaderLib}(wd||(wd={}));var wd;!function(wd){var FresnelForBasicEnvMapShaderLib=function(_super){function FresnelForBasicEnvMapShaderLib(){_super.apply(this,arguments),this.type="fresnel_forBasic_envMap"}return __extends(FresnelForBasicEnvMapShaderLib,_super),FresnelForBasicEnvMapShaderLib.create=function(){var obj=new this;return obj},FresnelForBasicEnvMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){_super.prototype.sendShaderVariables.call(this,program,cmd,material),this.sendUniformData(program,"u_refractionRatio",material.refractionRatio),this.sendUniformData(program,"u_reflectivity",material.reflectivity)},FresnelForBasicEnvMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_refractionRatio","u_reflectivity"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},FresnelForBasicEnvMapShaderLib}(wd.ForBasicEnvMapShaderLib);wd.FresnelForBasicEnvMapShaderLib=FresnelForBasicEnvMapShaderLib}(wd||(wd={}));var wd;!function(wd){var ForLightEnvMapShaderLib=function(_super){function ForLightEnvMapShaderLib(){_super.apply(this,arguments)}return __extends(ForLightEnvMapShaderLib,_super),ForLightEnvMapShaderLib.prototype.setEnvMapSource=function(){var vs=this.getVsChunk("forLight_envMap"),fs=this.getFsChunk("forLight_envMap");this.vsSourceTop=vs.top,this.vsSourceDefine=vs.define,this.vsSourceVarDeclare=vs.varDeclare,this.vsSourceFuncDeclare=vs.funcDeclare,this.vsSourceFuncDefine=vs.funcDefine,this.vsSourceBody+=vs.body,this.setFsSource(fs)},ForLightEnvMapShaderLib}(wd.EnvMapShaderLib);wd.ForLightEnvMapShaderLib=ForLightEnvMapShaderLib}(wd||(wd={}));var wd;!function(wd){var BasicForLightEnvMapShaderLib=function(_super){function BasicForLightEnvMapShaderLib(){_super.apply(this,arguments),this.type="basic_forLight_envMap"}return __extends(BasicForLightEnvMapShaderLib,_super),BasicForLightEnvMapShaderLib.create=function(){var obj=new this;return obj},BasicForLightEnvMapShaderLib}(wd.ForLightEnvMapShaderLib);wd.BasicForLightEnvMapShaderLib=BasicForLightEnvMapShaderLib}(wd||(wd={}));var wd;!function(wd){var ReflectionForLightEnvMapShaderLib=function(_super){function ReflectionForLightEnvMapShaderLib(){_super.apply(this,arguments),this.type="reflection_forLight_envMap"}return __extends(ReflectionForLightEnvMapShaderLib,_super),ReflectionForLightEnvMapShaderLib.create=function(){var obj=new this;return obj},ReflectionForLightEnvMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},ReflectionForLightEnvMapShaderLib}(wd.ForLightEnvMapShaderLib);wd.ReflectionForLightEnvMapShaderLib=ReflectionForLightEnvMapShaderLib}(wd||(wd={}));var wd;!function(wd){var RefractionForLightEnvMapShaderLib=function(_super){function RefractionForLightEnvMapShaderLib(){_super.apply(this,arguments),this.type="refraction_forLight_envMap"}return __extends(RefractionForLightEnvMapShaderLib,_super),RefractionForLightEnvMapShaderLib.create=function(){var obj=new this;return obj},RefractionForLightEnvMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){_super.prototype.sendShaderVariables.call(this,program,cmd,material),this.sendUniformData(program,"u_refractionRatio",material.refractionRatio)},RefractionForLightEnvMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_refractionRatio"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},RefractionForLightEnvMapShaderLib}(wd.ForLightEnvMapShaderLib);wd.RefractionForLightEnvMapShaderLib=RefractionForLightEnvMapShaderLib}(wd||(wd={}));var wd;!function(wd){var FresnelForLightEnvMapShaderLib=function(_super){function FresnelForLightEnvMapShaderLib(){_super.apply(this,arguments),this.type="fresnel_forLight_envMap"}return __extends(FresnelForLightEnvMapShaderLib,_super),FresnelForLightEnvMapShaderLib.create=function(){var obj=new this;return obj},FresnelForLightEnvMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){_super.prototype.sendShaderVariables.call(this,program,cmd,material),null!==material.reflectivity?this.sendUniformData(program,"u_reflectivity",material.reflectivity):(this.sendUniformData(program,"u_reflectivity",wd.ShaderChunk.NULL),this.sendUniformData(program,"u_refractionRatio",material.refractionRatio))},FresnelForLightEnvMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_refractionRatio","u_reflectivity"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},FresnelForLightEnvMapShaderLib}(wd.ForLightEnvMapShaderLib);wd.FresnelForLightEnvMapShaderLib=FresnelForLightEnvMapShaderLib}(wd||(wd={}));var wd;!function(wd){var MapShaderLib=function(_super){function MapShaderLib(){_super.apply(this,arguments)}return __extends(MapShaderLib,_super),MapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){var texCoordBuffer=cmd.buffers.getChild(wd.EBufferDataType.TEXCOORD),mapList=null,map0=null;texCoordBuffer&&(this.sendAttributeBuffer(program,"a_texCoord",texCoordBuffer),mapList=material.mapList,map0=mapList.getChild(0),this.sendUniformData(program,"u_map0SourceRegion",map0.sourceRegionForGLSL),this.sendUniformData(program,"u_map0RepeatRegion",map0.repeatRegion),this.sendMapShaderVariables(program,cmd,material))},MapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addAttributeVariable(["a_texCoord"]),this.addUniformVariable(["u_sampler2D0","u_map0SourceRegion","u_map0RepeatRegion"]),this._setMapSource()},MapShaderLib.prototype.sendMapShaderVariables=function(program,cmd,material){},MapShaderLib.prototype._setMapSource=function(){var vs=this.getVsChunk("map_forBasic"),fs=this.getFsChunk("map_forBasic");this.vsSourceTop=vs.top,this.vsSourceDefine=vs.define,this.vsSourceVarDeclare=vs.varDeclare,this.vsSourceFuncDeclare=vs.funcDeclare,this.vsSourceFuncDefine=vs.funcDefine,this.vsSourceBody=vs.body,this.setFsSource(fs)},__decorate([wd.virtual],MapShaderLib.prototype,"sendMapShaderVariables",null),MapShaderLib}(wd.EngineShaderLib);wd.MapShaderLib=MapShaderLib}(wd||(wd={}));var wd;!function(wd){var BasicMapShaderLib=function(_super){function BasicMapShaderLib(){_super.apply(this,arguments),this.type="map_forBasic"}return __extends(BasicMapShaderLib,_super),BasicMapShaderLib.create=function(){var obj=new this;return obj},BasicMapShaderLib}(wd.MapShaderLib);wd.BasicMapShaderLib=BasicMapShaderLib}(wd||(wd={}));var wd;!function(wd){var MultiMapShaderLib=function(_super){function MultiMapShaderLib(){_super.apply(this,arguments),this.type="multi_map_forBasic"}return __extends(MultiMapShaderLib,_super),MultiMapShaderLib.create=function(){var obj=new this;return obj},MultiMapShaderLib.prototype.sendMapShaderVariables=function(program,cmd,material){var mapList=material.mapList,map1=mapList.getChild(1);this.sendUniformData(program,"u_combineMode",material.mapCombineMode),this.sendUniformData(program,"u_mixRatio",material.mapMixRatio),this.sendUniformData(program,"u_map1SourceRegion",map1.sourceRegionForGLSL),this.sendUniformData(program,"u_map1RepeatRegion",map1.repeatRegion)},MultiMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_sampler2D1","u_combineMode","u_mixRatio","u_map1SourceRegion","u_map1RepeatRegion"]),this.vsSourceVarDeclare+=this.getVsChunk().varDeclare,this.vsSourceBody+=this.getVsChunk().body,this.fsSourceVarDeclare=this.getFsChunk().varDeclare,this.fsSourceFuncDefine=this.getFsChunk().funcDefine,this.fsSourceBody=this.getFsChunk().body},MultiMapShaderLib}(wd.MapShaderLib);wd.MultiMapShaderLib=MultiMapShaderLib}(wd||(wd={}));var wd;!function(wd){var LightCommonShaderLib=function(_super){function LightCommonShaderLib(){_super.apply(this,arguments),this.type="lightCommon"}return __extends(LightCommonShaderLib,_super),LightCommonShaderLib.create=function(){var obj=new this;return obj},LightCommonShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},LightCommonShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.setVsSource(this.getVsChunk("light_common.glsl")),this.setVsSource(this.getVsChunk(),"+"),this.setFsSource(this.getFsChunk("light_common.glsl")),this.setFsSource(this.getFsChunk(),"+")},LightCommonShaderLib}(wd.EngineShaderLib);wd.LightCommonShaderLib=LightCommonShaderLib}(wd||(wd={}));var wd;!function(wd){var LightShaderLib=function(_super){function LightShaderLib(){_super.apply(this,arguments),this.type="light"}return __extends(LightShaderLib,_super),LightShaderLib.create=function(){var obj=new this;return obj},LightShaderLib.prototype.sendShaderVariables=function(program,cmd,material){this.sendUniformData(program,"u_cameraPos",wd.Director.getInstance().scene.currentCamera.transform.position),this.sendUniformData(program,"u_shininess",material.shininess),this.sendUniformData(program,"u_opacity",material.opacity),this.sendUniformData(program,"u_lightModel",this._convertLightModelToGLSLVariable(material.lightModel)),this._sendLightVariables(program)},LightShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_normalMatrix","u_cameraPos","u_shininess","u_ambient","u_opacity","u_isBothSide","u_lightModel"]),this._setLightDefinition(material)},LightShaderLib.prototype._sendLightVariables=function(program){var scene=wd.Director.getInstance().scene,directionLights=scene.directionLights,ambientLight=scene.ambientLight,pointLights=scene.pointLights;ambientLight&&this.sendUniformData(program,"u_ambient",ambientLight.getComponent(wd.AmbientLight).color.toVector4()),pointLights&&this._sendPointLightVariables(program,pointLights),directionLights&&this._sendDirectionLightVariables(program,directionLights)},LightShaderLib.prototype._sendPointLightVariables=function(program,pointLights){pointLights.forEach(function(pointLight,index){var lightComponent=pointLight.getComponent(wd.PointLight),structureMemberNameData=wd.POINT_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME[index];program.sendVector3(structureMemberNameData.position,lightComponent.position),program.sendColor4(structureMemberNameData.color,lightComponent.color),program.sendFloat1(structureMemberNameData.intensity,lightComponent.intensity),program.sendFloat1(structureMemberNameData.constant,lightComponent.constant),program.sendFloat1(structureMemberNameData.linear,lightComponent.linear),program.sendFloat1(structureMemberNameData.quadratic,lightComponent.quadratic),null!==lightComponent.range?program.sendFloat1(structureMemberNameData.range,lightComponent.range):program.sendFloat1(structureMemberNameData.range,wd.ShaderChunk.NULL)})},LightShaderLib.prototype._sendDirectionLightVariables=function(program,directionLights){var self=this;directionLights.forEach(function(directionLight,index){var lightComponent=directionLight.getComponent(wd.DirectionLight),structureMemberNameData=wd.DIRECTION_LIGHT_GLSLDATA_STRUCTURE_MEMBER_NAME[index];self._isZero(lightComponent.position)?program.sendVector3(structureMemberNameData.position,wd.DirectionLight.defaultPosition):program.sendVector3(structureMemberNameData.position,lightComponent.position),program.sendColor4(structureMemberNameData.color,lightComponent.color),program.sendFloat1(structureMemberNameData.intensity,lightComponent.intensity)})},LightShaderLib.prototype._isZero=function(position){var val=position.values;return 0===val[0]&&0===val[1]&&0===val[2]},LightShaderLib.prototype._setLightDefinition=function(material){var scene=wd.Director.getInstance().scene,directionLights=scene.directionLights,pointLights=scene.pointLights,direction_lights_count=0,point_lights_count=0;directionLights&&(this.addUniformVariable(["u_directionLights"]),direction_lights_count=directionLights.getCount()),pointLights&&(this.addUniformVariable(["u_pointLights"]),point_lights_count=pointLights.getCount()),this._addDefine(this.vsSourceDefineList,direction_lights_count,point_lights_count),this._addDefine(this.fsSourceDefineList,direction_lights_count,point_lights_count),material.side===wd.ESide.BOTH&&this.fsSourceDefineList.addChildren([{name:"BOTH_SIDE"}])},LightShaderLib.prototype._addDefine=function(list,direction_lights_count,point_lights_count){list.addChildren([{name:"DIRECTION_LIGHTS_COUNT",value:direction_lights_count},{name:"POINT_LIGHTS_COUNT",value:point_lights_count}])},LightShaderLib.prototype._convertLightModelToGLSLVariable=function(lightModel){switch(lightModel){case wd.ELightModel.BLINN:return 1;case wd.ELightModel.PHONG:return 2;case wd.ELightModel.CONSTANT:return 3;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("lightModel:"+lightModel))}},__decorate([wd.require(function(lightModel){wd.assert(lightModel!==wd.ELightModel.LAMBERT,wd.Log.info.FUNC_SHOULD_NOT("lightModel","=== ELightModel.LAMBERT"))})],LightShaderLib.prototype,"_convertLightModelToGLSLVariable",null),LightShaderLib}(wd.EngineShaderLib);wd.LightShaderLib=LightShaderLib}(wd||(wd={}));var wd;!function(wd){var LightEndShaderLib=function(_super){function LightEndShaderLib(){_super.apply(this,arguments),this.type="lightEnd"}return __extends(LightEndShaderLib,_super),LightEndShaderLib.create=function(){var obj=new this;return obj},LightEndShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},LightEndShaderLib}(wd.EngineShaderLib);wd.LightEndShaderLib=LightEndShaderLib}(wd||(wd={}));var wd;!function(wd){var BaseLightMapShaderLib=function(_super){function BaseLightMapShaderLib(){_super.apply(this,arguments)}return __extends(BaseLightMapShaderLib,_super),BaseLightMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},BaseLightMapShaderLib}(wd.EngineShaderLib);wd.BaseLightMapShaderLib=BaseLightMapShaderLib}(wd||(wd={}));var wd;!function(wd){var CommonLightMapShaderLib=function(_super){function CommonLightMapShaderLib(){_super.apply(this,arguments)}return __extends(CommonLightMapShaderLib,_super),CommonLightMapShaderLib.create=function(){var obj=new this;return obj},CommonLightMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){var texCoordBuffer=cmd.buffers.getChild(wd.EBufferDataType.TEXCOORD);texCoordBuffer&&this.sendAttributeBuffer(program,"a_texCoord",texCoordBuffer)},CommonLightMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addAttributeVariable(["a_texCoord"])},CommonLightMapShaderLib}(wd.EngineShaderLib);wd.CommonLightMapShaderLib=CommonLightMapShaderLib}(wd||(wd={}));var wd;!function(wd){var LightMapShaderLib=function(_super){function LightMapShaderLib(){_super.apply(this,arguments),this.type="lightMap"}return __extends(LightMapShaderLib,_super),LightMapShaderLib.create=function(){var obj=new this;return obj},LightMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){this.sendUniformData(program,"u_lightMapIntensity",material.lightMapIntensity)},LightMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable([wd.VariableNameTable.getVariableName("lightMap"),"u_lightMapIntensity"])},LightMapShaderLib}(wd.BaseLightMapShaderLib);wd.LightMapShaderLib=LightMapShaderLib}(wd||(wd={}));var wd;!function(wd){var DiffuseMapShaderLib=function(_super){function DiffuseMapShaderLib(){_super.apply(this,arguments),this.type="diffuseMap"}return __extends(DiffuseMapShaderLib,_super),DiffuseMapShaderLib.create=function(){var obj=new this;return obj},DiffuseMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){var diffuseMap=material.diffuseMap;return this.sendUniformData(program,"u_diffuseSourceRegion",diffuseMap.sourceRegionForGLSL),this.sendUniformData(program,"u_diffuseRepeatRegion",diffuseMap.repeatRegion),this},DiffuseMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable([wd.VariableNameTable.getVariableName("diffuseMap"),"u_diffuseSourceRegion","u_diffuseRepeatRegion"])},__decorate([wd.require(function(program,cmd,material){var diffuseMap=material.diffuseMap;wd.assert(!!diffuseMap,wd.Log.info.FUNC_MUST_DEFINE("diffuseMap")),wd.assert(!!diffuseMap.sourceRegionForGLSL&&!!diffuseMap.repeatRegion,wd.Log.info.FUNC_SHOULD("material.diffuseMap","has sourceRegionForGLSL,repeatRegion data"))})],DiffuseMapShaderLib.prototype,"sendShaderVariables",null),DiffuseMapShaderLib}(wd.BaseLightMapShaderLib);wd.DiffuseMapShaderLib=DiffuseMapShaderLib}(wd||(wd={}));var wd;!function(wd){var SpecularMapShaderLib=function(_super){function SpecularMapShaderLib(){_super.apply(this,arguments),this.type="specularMap"}return __extends(SpecularMapShaderLib,_super),SpecularMapShaderLib.create=function(){var obj=new this;return obj},SpecularMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable([wd.VariableNameTable.getVariableName("specularMap")])},SpecularMapShaderLib}(wd.BaseLightMapShaderLib);wd.SpecularMapShaderLib=SpecularMapShaderLib}(wd||(wd={}));var wd;!function(wd){var EmissionMapShaderLib=function(_super){function EmissionMapShaderLib(){_super.apply(this,arguments),this.type="emissionMap"}return __extends(EmissionMapShaderLib,_super),EmissionMapShaderLib.create=function(){var obj=new this;return obj},EmissionMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable([wd.VariableNameTable.getVariableName("emissionMap")])},EmissionMapShaderLib}(wd.BaseLightMapShaderLib);wd.EmissionMapShaderLib=EmissionMapShaderLib}(wd||(wd={}));var wd;!function(wd){var NormalMapShaderLib=function(_super){function NormalMapShaderLib(){_super.apply(this,arguments),this.type="normalMap"}return __extends(NormalMapShaderLib,_super),NormalMapShaderLib.create=function(){var obj=new this;return obj},NormalMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){var tangentBuffer=null;_super.prototype.sendShaderVariables.call(this,program,cmd,material),tangentBuffer=cmd.buffers.getChild(wd.EBufferDataType.TANGENT),tangentBuffer&&this.sendAttributeBuffer(program,"a_tangent",tangentBuffer)},NormalMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addAttributeVariable(["a_tangent"]),this.addUniformVariable([wd.VariableNameTable.getVariableName("normalMap")])},NormalMapShaderLib}(wd.BaseLightMapShaderLib);wd.NormalMapShaderLib=NormalMapShaderLib}(wd||(wd={}));var wd;!function(wd){var NoLightMapShaderLib=function(_super){function NoLightMapShaderLib(){_super.apply(this,arguments),this.type="noLightMap"}return __extends(NoLightMapShaderLib,_super),NoLightMapShaderLib.create=function(){var obj=new this;return obj},NoLightMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},NoLightMapShaderLib}(wd.EngineShaderLib);wd.NoLightMapShaderLib=NoLightMapShaderLib}(wd||(wd={}));var wd;!function(wd){var NoDiffuseMapShaderLib=function(_super){function NoDiffuseMapShaderLib(){_super.apply(this,arguments),this.type="noDiffuseMap"}return __extends(NoDiffuseMapShaderLib,_super),NoDiffuseMapShaderLib.create=function(){var obj=new this;return obj},NoDiffuseMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){this.sendUniformData(program,"u_diffuse",material.color.toVector4())},NoDiffuseMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_diffuse"])},NoDiffuseMapShaderLib}(wd.EngineShaderLib);wd.NoDiffuseMapShaderLib=NoDiffuseMapShaderLib}(wd||(wd={}));var wd;!function(wd){var NoSpecularMapShaderLib=function(_super){function NoSpecularMapShaderLib(){_super.apply(this,arguments),this.type="noSpecularMap"}return __extends(NoSpecularMapShaderLib,_super),NoSpecularMapShaderLib.create=function(){var obj=new this;return obj},NoSpecularMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){this.sendUniformData(program,"u_specular",material.specularColor.toVector4())},NoSpecularMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_specular"])},NoSpecularMapShaderLib}(wd.EngineShaderLib);wd.NoSpecularMapShaderLib=NoSpecularMapShaderLib}(wd||(wd={}));var wd;!function(wd){var NoEmissionMapShaderLib=function(_super){function NoEmissionMapShaderLib(){_super.apply(this,arguments),this.type="noEmissionMap"}return __extends(NoEmissionMapShaderLib,_super),NoEmissionMapShaderLib.create=function(){var obj=new this;return obj},NoEmissionMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){this.sendUniformData(program,"u_emission",material.emissionColor.toVector4())},NoEmissionMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_emission"])},NoEmissionMapShaderLib}(wd.EngineShaderLib);wd.NoEmissionMapShaderLib=NoEmissionMapShaderLib}(wd||(wd={}));var wd;!function(wd){var NoNormalMapShaderLib=function(_super){function NoNormalMapShaderLib(){_super.apply(this,arguments),this.type="noNormalMap"}return __extends(NoNormalMapShaderLib,_super),NoNormalMapShaderLib.create=function(){var obj=new this;return obj},NoNormalMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},NoNormalMapShaderLib}(wd.EngineShaderLib);wd.NoNormalMapShaderLib=NoNormalMapShaderLib}(wd||(wd={}));var wd;!function(wd){var BuildShadowMapShaderLib=function(_super){function BuildShadowMapShaderLib(){_super.apply(this,arguments)}return __extends(BuildShadowMapShaderLib,_super),BuildShadowMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.setFsSource(this.getFsChunk("commonBuildShadowMap_fragment.glsl")),this.setFsSource(this.getFsChunk(),"+")},BuildShadowMapShaderLib}(wd.EngineShaderLib);wd.BuildShadowMapShaderLib=BuildShadowMapShaderLib}(wd||(wd={}));var wd;!function(wd){var BuildTwoDShadowMapShaderLib=function(_super){function BuildTwoDShadowMapShaderLib(){_super.apply(this,arguments),this.type="buildTwoDShadowMap"}return __extends(BuildTwoDShadowMapShaderLib,_super),BuildTwoDShadowMapShaderLib.create=function(){var obj=new this;return obj},BuildTwoDShadowMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){program.sendMatrix4("u_vpMatrixFromLight",cmd.vMatrix.applyMatrix(cmd.pMatrix,!0))},BuildTwoDShadowMapShaderLib.prototype.setShaderDefinition=function(cmd,material){var fs=null;_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_vpMatrixFromLight"]),fs=wd.GPUDetector.getInstance().extensionDepthTexture?this.getFsChunk("buildTwoDShadowMap_depthMap"):this.getFsChunk("buildTwoDShadowMap_packDepth"),this.fsSourceBody=fs.body},BuildTwoDShadowMapShaderLib}(wd.BuildShadowMapShaderLib);wd.BuildTwoDShadowMapShaderLib=BuildTwoDShadowMapShaderLib}(wd||(wd={}));var wd;!function(wd){var BuildCubemapShadowMapShaderLib=function(_super){function BuildCubemapShadowMapShaderLib(){_super.apply(this,arguments),this.type="buildCubemapShadowMap"}return __extends(BuildCubemapShadowMapShaderLib,_super),BuildCubemapShadowMapShaderLib.create=function(){var obj=new this;return obj},BuildCubemapShadowMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){wd.Director.getInstance().scene.glslData.getChild(wd.EShaderGLSLData.BUILD_CUBEMAP_SHADOWMAP).forEach(function(data,index){var light=data.light;program.sendVector3("u_lightPos",light.position),program.sendFloat1("u_farPlane",light.shadowCameraFar)})},BuildCubemapShadowMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_lightPos","u_farPlane"])},BuildCubemapShadowMapShaderLib}(wd.BuildShadowMapShaderLib);wd.BuildCubemapShadowMapShaderLib=BuildCubemapShadowMapShaderLib}(wd||(wd={}));var wd;!function(wd){var TotalShadowMapShaderLib=function(_super){function TotalShadowMapShaderLib(){_super.apply(this,arguments),this.type="totalShadowMap"}return __extends(TotalShadowMapShaderLib,_super),TotalShadowMapShaderLib.create=function(){var obj=new this;return obj},TotalShadowMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},TotalShadowMapShaderLib}(wd.EngineShaderLib);wd.TotalShadowMapShaderLib=TotalShadowMapShaderLib}(wd||(wd={}));var wd;!function(wd){var ShadowMapShaderLib=function(_super){function ShadowMapShaderLib(){_super.apply(this,arguments),this._softTypeChangeSubscription=null}return __extends(ShadowMapShaderLib,_super),ShadowMapShaderLib.prototype.init=function(){var shader=this.shader;this._softTypeChangeSubscription=wd.EventManager.fromEvent(wd.Director.getInstance().scene.gameObjectScene,wd.EEngineEvent.SHADOWMAP_SOFTTYPE_CHANGE).subscribe(function(){
shader.libDirty=!0})},ShadowMapShaderLib.prototype.dispose=function(){this._softTypeChangeSubscription&&this._softTypeChangeSubscription.dispose()},ShadowMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this._setShadowMapSource()},ShadowMapShaderLib.prototype._setShadowMapSource=function(){var scene=wd.Director.getInstance().scene,shadowManager=scene.gameObjectScene.shadowManager,twoDShadowMapCountForGLSL=shadowManager.twoDShadowMapCountForGLSL,cubemapShadowMapCountForGLSL=shadowManager.cubemapShadowMapCountForGLSL;scene.shadowMap.softType===wd.EShadowMapSoftType.PCF&&this.fsSourceDefineList.addChildren([{name:"SHADOWMAP_TYPE_PCF"}]),this.vsSourceDefineList.addChild({name:"TWOD_SHADOWMAP_COUNT",value:twoDShadowMapCountForGLSL}),this.fsSourceDefineList.addChildren([{name:"TWOD_SHADOWMAP_COUNT",value:twoDShadowMapCountForGLSL},{name:"CUBEMAP_SHADOWMAP_COUNT",value:cubemapShadowMapCountForGLSL}])},ShadowMapShaderLib}(wd.EngineShaderLib);wd.ShadowMapShaderLib=ShadowMapShaderLib}(wd||(wd={}));var wd;!function(wd){var TwoDShadowMapShaderLib=function(_super){function TwoDShadowMapShaderLib(){_super.apply(this,arguments),this.type="twoDShadowMap"}return __extends(TwoDShadowMapShaderLib,_super),TwoDShadowMapShaderLib.create=function(){var obj=new this;return obj},TwoDShadowMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){var glslData=null;glslData=wd.Director.getInstance().scene.glslData.getChild(wd.EShaderGLSLData.TWOD_SHADOWMAP),glslData&&glslData.forEach(function(data,index){var camera=data.camera,light=data.light;return data.isRenderListEmpty?void program.sendNum1("u_isTwoDRenderListEmpty["+index+"]",1):(program.sendNum1("u_isTwoDRenderListEmpty["+index+"]",0),program.sendMatrix4("u_vpMatrixFromLight["+index+"]",camera.worldToCameraMatrix.applyMatrix(camera.pMatrix,!0)),program.sendFloat2("u_twoDShadowSize["+index+"]",[light.shadowMapWidth,light.shadowMapHeight]),program.sendFloat1("u_twoDShadowBias["+index+"]",light.shadowBias),program.sendFloat1("u_twoDShadowDarkness["+index+"]",light.shadowDarkness),void program.sendVector3("u_twoDLightPos["+index+"]",light.position))})},TwoDShadowMapShaderLib.prototype.setShaderDefinition=function(cmd,material){var fs=null;_super.prototype.setShaderDefinition.call(this,cmd,material),fs=wd.GPUDetector.getInstance().extensionDepthTexture?this.getFsChunk("twoDShadowMap_depthMap"):this.getFsChunk("twoDShadowMap_unpackDepth"),this.fsSourceFuncDeclare+=fs.funcDeclare,this.fsSourceFuncDefine+=fs.funcDefine},TwoDShadowMapShaderLib}(wd.ShadowMapShaderLib);wd.TwoDShadowMapShaderLib=TwoDShadowMapShaderLib}(wd||(wd={}));var wd;!function(wd){var CubemapShadowMapShaderLib=function(_super){function CubemapShadowMapShaderLib(){_super.apply(this,arguments),this.type="cubemapShadowMap"}return __extends(CubemapShadowMapShaderLib,_super),CubemapShadowMapShaderLib.create=function(){var obj=new this;return obj},CubemapShadowMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){var glslData=wd.Director.getInstance().scene.glslData.getChild(wd.EShaderGLSLData.CUBEMAP_SHADOWMAP);glslData&&glslData.forEach(function(data,index){var light=data.light;data.isRenderListEmpty?program.sendNum1("u_isCubemapRenderListEmpty["+index+"]",1):program.sendNum1("u_isCubemapRenderListEmpty["+index+"]",0),program.sendVector3("u_cubemapLightPos["+index+"]",light.position),program.sendFloat1("u_farPlane["+index+"]",light.shadowCameraFar),program.sendFloat1("u_cubemapShadowBias["+index+"]",light.shadowBias),program.sendFloat1("u_cubemapShadowDarkness["+index+"]",light.shadowDarkness)})},CubemapShadowMapShaderLib}(wd.ShadowMapShaderLib);wd.CubemapShadowMapShaderLib=CubemapShadowMapShaderLib}(wd||(wd={}));var wd;!function(wd){var NoShadowMapShaderLib=function(_super){function NoShadowMapShaderLib(){_super.apply(this,arguments),this.type="noShadowMap"}return __extends(NoShadowMapShaderLib,_super),NoShadowMapShaderLib.create=function(){var obj=new this;return obj},NoShadowMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},NoShadowMapShaderLib}(wd.EngineShaderLib);wd.NoShadowMapShaderLib=NoShadowMapShaderLib}(wd||(wd={}));var wd;!function(wd){var CustomShaderLibUtils=function(){function CustomShaderLibUtils(){}return CustomShaderLibUtils.sendUniformData=function(name,type,value,program){type===wd.EVariableType.STRUCTURE?this._sendStructureData(name,value,program):program.sendUniformData(name,type,value)},CustomShaderLibUtils.sendUniformDataWithSemantic=function(name,type,value,program,cmd){type===wd.EVariableType.STRUCTURE?this._sendStructureDataWithSemantic(name,value,program,cmd):program.sendUniformData(name,type,this._getUniformData(value,cmd))},CustomShaderLibUtils.sendAttributeBufferWithSemantic=function(name,type,value,program,cmd){program.sendAttributeBuffer(name,this._getAttributeType(type),this._getAttributeData(value,type,cmd))},CustomShaderLibUtils._sendStructureData=function(name,data,program){for(var fieldName in data)if(data.hasOwnProperty(fieldName)){var fieldValue=data[fieldName];program.sendStructureData(name+"."+fieldName,fieldValue.type,fieldValue.value)}},CustomShaderLibUtils._sendStructureDataWithSemantic=function(name,data,program,cmd){for(var fieldName in data)if(data.hasOwnProperty(fieldName)){var fieldValue=data[fieldName];program.sendStructureData(name+"."+fieldName,fieldValue.type,this._getUniformData(fieldValue.value,cmd))}},CustomShaderLibUtils._getAttributeData=function(data,type,cmd){switch(data){case wd.EVariableSemantic.POSITION:return cmd.buffers.getChild(wd.EBufferDataType.VERTICE);case wd.EVariableSemantic.TEXCOORD:return cmd.buffers.getChild(wd.EBufferDataType.TEXCOORD);case wd.EVariableSemantic.COLOR:return cmd.buffers.getChild(wd.EBufferDataType.COLOR);case wd.EVariableSemantic.NORMAL:return cmd.buffers.getChild(wd.EBufferDataType.NORMAL);case wd.EVariableSemantic.TANGENT:return cmd.buffers.getChild(wd.EBufferDataType.TANGENT);default:return data}},CustomShaderLibUtils._getAttributeType=function(type){return wd.EVariableType.BUFFER},CustomShaderLibUtils._getUniformData=function(data,cmd){switch(data){case wd.EVariableSemantic.MODEL:return cmd.mMatrix;case wd.EVariableSemantic.VIEW:return cmd.vMatrix;case wd.EVariableSemantic.PROJECTION:return cmd.pMatrix;case wd.EVariableSemantic.MODEL_VIEW_PROJECTION:return cmd.mvpMatrix;case wd.EVariableSemantic.MODEL_INVERSE:return cmd.mMatrix.clone().invert();case wd.EVariableSemantic.VIEW_INVERSE:return cmd.vMatrix.clone().invert();case wd.EVariableSemantic.PROJECTION_INVERSE:return cmd.pMatrix.clone().invert();case wd.EVariableSemantic.MODEL_VIEW_INVERSE:return cmd.mMatrix.applyMatrix(cmd.vMatrix,!0).invert();case wd.EVariableSemantic.MODEL_VIEW_PROJECTION_INVERSE:return cmd.mMatrix.applyMatrix(cmd.vMatrix,!0).applyMatrix(cmd.pMatrix,!1).invert();case wd.EVariableSemantic.MODEL_INVERSE_TRANSPOSE:return cmd.normalMatrix;case wd.EVariableSemantic.MODEL_VIEW_INVERSE_TRANSPOSE:return cmd.mMatrix.applyMatrix(cmd.vMatrix,!0).invertTo3x3().transpose();case wd.EVariableSemantic.VIEWPORT:return wd.DeviceManager.getInstance().getViewport();default:return data}},__decorate([wd.require(function(name,type,value,program){wd.assert(type!==wd.EVariableType.SAMPLER_2D&&type!==wd.EVariableType.SAMPLER_CUBE,wd.Log.info.FUNC_SHOULD_NOT("type","be SAMPLER_2D or SAMPLER_CUBE, but actual is "+type)),wd.assert(type!==wd.EVariableType.STRUCTURES,wd.Log.info.FUNC_NOT_SUPPORT("type === STRUCTURES")),type===wd.EVariableType.STRUCTURE&&wd.assert(wd.JudgeUtils.isDirectObject(value),wd.Log.info.FUNC_MUST_BE("value","object when type === STRUCTURE"))})],CustomShaderLibUtils,"sendUniformData",null),__decorate([wd.require(function(name,type,value,program,cmd){wd.assert(type!==wd.EVariableType.SAMPLER_2D&&type!==wd.EVariableType.SAMPLER_CUBE,wd.Log.info.FUNC_SHOULD_NOT("type","be SAMPLER_2D or SAMPLER_CUBE, but actual is "+type)),wd.assert(type!==wd.EVariableType.STRUCTURES,wd.Log.info.FUNC_NOT_SUPPORT("type === STRUCTURES")),type===wd.EVariableType.STRUCTURE&&wd.assert(wd.JudgeUtils.isDirectObject(value),wd.Log.info.FUNC_MUST_BE("value","object when type === STRUCTURE"))})],CustomShaderLibUtils,"sendUniformDataWithSemantic",null),__decorate([wd.require(function(data,type,cmd){switch(wd.assert("INDICE"!==data,wd.Log.info.FUNC_NOT_SUPPORT("semantic:INDICE")),data){case"POSITION":case"COLOR":case"NORMAL":case"TANGENT":wd.assert(type===wd.EVariableType.FLOAT_3,wd.Log.info.FUNC_SHOULD("type","be EVariableType.FLOAT_3"));break;case"TEXCOORD":wd.assert(type===wd.EVariableType.FLOAT_2,wd.Log.info.FUNC_SHOULD("type","be EVariableType.FLOAT_2"))}}),wd.ensure(function(data){wd.assert(data&&data instanceof wd.Buffer,wd.Log.info.FUNC_SHOULD("attributeData","be Buffer, but actual is "+data))})],CustomShaderLibUtils,"_getAttributeData",null),CustomShaderLibUtils}();wd.CustomShaderLibUtils=CustomShaderLibUtils}(wd||(wd={}));var wd;!function(wd){var RenderTargerRendererShaderLibUtils=function(){function RenderTargerRendererShaderLibUtils(){}return RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var glslData=null,program=args[0],glslDataKey=args[1],variableName=null;glslData=wd.Director.getInstance().scene.glslData.getChild(glslDataKey),glslData&&(variableName=3===args.length?args[2]:"u_isRenderListEmpty",glslData.isRenderListEmpty?program.sendUniformData(variableName,wd.EVariableType.NUMBER_1,1):program.sendUniformData(variableName,wd.EVariableType.NUMBER_1,0))},RenderTargerRendererShaderLibUtils}();wd.RenderTargerRendererShaderLibUtils=RenderTargerRendererShaderLibUtils}(wd||(wd={}));var wd;!function(wd){var InstanceShaderLib=function(_super){function InstanceShaderLib(){_super.apply(this,arguments)}return __extends(InstanceShaderLib,_super),InstanceShaderLib}(wd.EngineShaderLib);wd.InstanceShaderLib=InstanceShaderLib}(wd||(wd={}));var wd;!function(wd){var NoInstanceShaderLib=function(_super){function NoInstanceShaderLib(){_super.apply(this,arguments)}return __extends(NoInstanceShaderLib,_super),NoInstanceShaderLib}(wd.EngineShaderLib);wd.NoInstanceShaderLib=NoInstanceShaderLib}(wd||(wd={}));var wd;!function(wd){var ModelMatrixInstanceShaderLib=function(_super){function ModelMatrixInstanceShaderLib(){_super.apply(this,arguments)}return __extends(ModelMatrixInstanceShaderLib,_super),ModelMatrixInstanceShaderLib}(wd.InstanceShaderLib);wd.ModelMatrixInstanceShaderLib=ModelMatrixInstanceShaderLib}(wd||(wd={}));var wd;!function(wd){var NormalMatrixModelMatrixInstanceShaderLib=function(_super){function NormalMatrixModelMatrixInstanceShaderLib(){_super.apply(this,arguments)}return __extends(NormalMatrixModelMatrixInstanceShaderLib,_super),NormalMatrixModelMatrixInstanceShaderLib}(wd.InstanceShaderLib);wd.NormalMatrixModelMatrixInstanceShaderLib=NormalMatrixModelMatrixInstanceShaderLib}(wd||(wd={}));var wd;!function(wd){var ModelMatrixHardwareInstanceShaderLib=function(_super){function ModelMatrixHardwareInstanceShaderLib(){_super.apply(this,arguments),this.type="modelMatrix_hardware_instance"}return __extends(ModelMatrixHardwareInstanceShaderLib,_super),ModelMatrixHardwareInstanceShaderLib.create=function(){var obj=new this;return obj},ModelMatrixHardwareInstanceShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},ModelMatrixHardwareInstanceShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addAttributeVariable(["a_mVec4_0","a_mVec4_1","a_mVec4_2","a_mVec4_3"])},ModelMatrixHardwareInstanceShaderLib}(wd.ModelMatrixInstanceShaderLib);wd.ModelMatrixHardwareInstanceShaderLib=ModelMatrixHardwareInstanceShaderLib}(wd||(wd={}));var wd;!function(wd){var NormalMatrixHardwareInstanceShaderLib=function(_super){function NormalMatrixHardwareInstanceShaderLib(){_super.apply(this,arguments),this.type="normalMatrix_hardware_instance"}return __extends(NormalMatrixHardwareInstanceShaderLib,_super),NormalMatrixHardwareInstanceShaderLib.create=function(){var obj=new this;return obj},NormalMatrixHardwareInstanceShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},NormalMatrixHardwareInstanceShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addAttributeVariable(["a_normalVec4_0","a_normalVec4_1","a_normalVec4_2"])},NormalMatrixHardwareInstanceShaderLib}(wd.NormalMatrixModelMatrixInstanceShaderLib);wd.NormalMatrixHardwareInstanceShaderLib=NormalMatrixHardwareInstanceShaderLib}(wd||(wd={}));var wd;!function(wd){var ModelMatrixBatchInstanceShaderLib=function(_super){function ModelMatrixBatchInstanceShaderLib(){_super.apply(this,arguments),this.type="modelMatrix_batch_instance"}return __extends(ModelMatrixBatchInstanceShaderLib,_super),ModelMatrixBatchInstanceShaderLib.create=function(){var obj=new this;return obj},ModelMatrixBatchInstanceShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},ModelMatrixBatchInstanceShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_mMatrix"])},ModelMatrixBatchInstanceShaderLib}(wd.ModelMatrixInstanceShaderLib);wd.ModelMatrixBatchInstanceShaderLib=ModelMatrixBatchInstanceShaderLib}(wd||(wd={}));var wd;!function(wd){var NormalMatrixBatchInstanceShaderLib=function(_super){function NormalMatrixBatchInstanceShaderLib(){_super.apply(this,arguments),this.type="normalMatrix_batch_instance"}return __extends(NormalMatrixBatchInstanceShaderLib,_super),NormalMatrixBatchInstanceShaderLib.create=function(){var obj=new this;return obj},NormalMatrixBatchInstanceShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},NormalMatrixBatchInstanceShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_normalMatrix"])},NormalMatrixBatchInstanceShaderLib}(wd.NormalMatrixModelMatrixInstanceShaderLib);wd.NormalMatrixBatchInstanceShaderLib=NormalMatrixBatchInstanceShaderLib}(wd||(wd={}));var wd;!function(wd){var ModelMatrixNoInstanceShaderLib=function(_super){function ModelMatrixNoInstanceShaderLib(){_super.apply(this,arguments),this.type="modelMatrix_noInstance"}return __extends(ModelMatrixNoInstanceShaderLib,_super),ModelMatrixNoInstanceShaderLib.create=function(){var obj=new this;return obj},ModelMatrixNoInstanceShaderLib.prototype.sendShaderVariables=function(program,cmd,material){this.sendUniformData(program,"u_mMatrix",cmd.mMatrix)},ModelMatrixNoInstanceShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_mMatrix"])},ModelMatrixNoInstanceShaderLib}(wd.NoInstanceShaderLib);wd.ModelMatrixNoInstanceShaderLib=ModelMatrixNoInstanceShaderLib}(wd||(wd={}));var wd;!function(wd){var NormalMatrixNoInstanceShaderLib=function(_super){function NormalMatrixNoInstanceShaderLib(){_super.apply(this,arguments),this.type="normalMatrix_noInstance"}return __extends(NormalMatrixNoInstanceShaderLib,_super),NormalMatrixNoInstanceShaderLib.create=function(){var obj=new this;return obj},NormalMatrixNoInstanceShaderLib.prototype.sendShaderVariables=function(program,cmd,material){this.sendUniformData(program,"u_normalMatrix",cmd.normalMatrix)},NormalMatrixNoInstanceShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_normalMatrix"])},NormalMatrixNoInstanceShaderLib}(wd.NoInstanceShaderLib);wd.NormalMatrixNoInstanceShaderLib=NormalMatrixNoInstanceShaderLib}(wd||(wd={}));var wd;!function(wd){var ShaderChunk=function(){function ShaderChunk(){}return ShaderChunk.empty={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.NULL=-1,ShaderChunk.normal_morph_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 a_normal = a_currentFrameNormal + (a_nextFrameNormal - a_currentFrameNormal) * u_interpolation;\n"},ShaderChunk.vertice_morph_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 a_position = a_currentFramePosition + (a_nextFramePosition - a_currentFramePosition) * u_interpolation;\n"},ShaderChunk.basic_fragment={top:"",define:"",varDeclare:"varying vec3 v_color;\n",funcDeclare:"",funcDefine:"",body:"vec4 totalColor = vec4(v_color, 1.0);\n"},ShaderChunk.basic_vertex={top:"",define:"",varDeclare:"varying vec3 v_color;\n",funcDeclare:"",funcDefine:"",body:"v_color = a_color;\n"},ShaderChunk.end_basic_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragColor = vec4(totalColor.rgb, totalColor.a * u_opacity);\n"},ShaderChunk.common_define={top:"",define:"#define NULL -1.0\n",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.common_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.common_function={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"mat2 transpose(mat2 m) {\n  return mat2(  m[0][0], m[1][0],   // new col 0\n                m[0][1], m[1][1]    // new col 1\n             );\n  }\nmat3 transpose(mat3 m) {\n  return mat3(  m[0][0], m[1][0], m[2][0],  // new col 0\n                m[0][1], m[1][1], m[2][1],  // new col 1\n                m[0][2], m[1][2], m[2][2]   // new col 1\n             );\n  }\n\nbool isRenderListEmpty(int isRenderListEmpty){\n  return isRenderListEmpty == 1;\n}\n",body:""},ShaderChunk.common_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.highp_fragment={top:"precision highp float;\nprecision highp int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.lowp_fragment={top:"precision lowp float;\nprecision lowp int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.mediump_fragment={top:"precision mediump float;\nprecision mediump int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.common_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 flipNormal(vec3 normal){\n    vec3 normalForRefraction = normal;\n    normalForRefraction.y = -normalForRefraction.y;\n    normalForRefraction.z = -normalForRefraction.z;\n\n    return normalForRefraction;\n}\n",body:""},ShaderChunk.lightCommon_fragment={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n#if POINT_LIGHTS_COUNT > 0\nstruct PointLight {\n    vec3 position;\n    vec4 color;\n    float intensity;\n\n    float range;\n    float constant;\n    float linear;\n    float quadratic;\n};\nuniform PointLight u_pointLights[POINT_LIGHTS_COUNT];\n\n#endif\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\nstruct DirectionLight {\n    vec3 position;\n\n    float intensity;\n\n    vec4 color;\n};\nuniform DirectionLight u_directionLights[DIRECTION_LIGHTS_COUNT];\n#endif\n",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.lightCommon_vertex={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n#if POINT_LIGHTS_COUNT > 0\nstruct PointLight {\n    vec3 position;\n    vec4 color;\n    float intensity;\n\n    float range;\n    float constant;\n    float linear;\n    float quadratic;\n};\nuniform PointLight u_pointLights[POINT_LIGHTS_COUNT];\n\n#endif\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\nstruct DirectionLight {\n    vec3 position;\n\n    float intensity;\n\n    vec4 color;\n};\nuniform DirectionLight u_directionLights[DIRECTION_LIGHTS_COUNT];\n#endif\n",funcDeclare:"",funcDefine:"",body:"v_worldPosition = vec3(mMatrix * vec4(a_position, 1.0));\n"},ShaderChunk.lightEnd_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragColor = vec4(totalColor.rgb, totalColor.a * u_opacity);\n"},ShaderChunk.light_common={top:"",define:"",varDeclare:"",funcDeclare:"vec3 getDirectionLightDirByLightPos(vec3 lightPos);\nvec3 getPointLightDirByLightPos(vec3 lightPos);\nvec3 getPointLightDirByLightPos(vec3 lightPos, vec3 worldPosition);\n",funcDefine:"vec3 getDirectionLightDirByLightPos(vec3 lightPos){\n    return lightPos - vec3(0.0);\n    //return vec3(0.0) - lightPos;\n}\nvec3 getPointLightDirByLightPos(vec3 lightPos){\n    return lightPos - v_worldPosition;\n}\nvec3 getPointLightDirByLightPos(vec3 lightPos, vec3 worldPosition){\n    return lightPos - worldPosition;\n}\n",body:""},ShaderChunk.light_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float getBlinnShininess(float shininess, vec3 normal, vec3 lightDir, vec3 viewDir, float dotResultBetweenNormAndLight){\n        vec3 halfAngle = normalize(lightDir + viewDir);\n        float blinnTerm = dot(normal, halfAngle);\n\n        blinnTerm = clamp(blinnTerm, 0.0, 1.0);\n        blinnTerm = dotResultBetweenNormAndLight != 0.0 ? blinnTerm : 0.0;\n        blinnTerm = pow(blinnTerm, shininess);\n\n        return blinnTerm;\n}\n\nfloat getPhongShininess(float shininess, vec3 normal, vec3 lightDir, vec3 viewDir, float dotResultBetweenNormAndLight){\n        vec3 reflectDir = reflect(-lightDir, normal);\n        float phongTerm = dot(viewDir, reflectDir);\n\n        phongTerm = clamp(phongTerm, 0.0, 1.0);\n        phongTerm = dotResultBetweenNormAndLight != 0.0 ? phongTerm : 0.0;\n        phongTerm = pow(phongTerm, shininess);\n\n        return phongTerm;\n}\n\nvec4 calcLight(vec3 lightDir, vec4 color, float intensity, float attenuation, vec3 normal, vec3 viewDir)\n{\n        vec4 materialLight = getMaterialLight();\n        vec4 materialDiffuse = getMaterialDiffuse();\n        vec4 materialSpecular = getMaterialSpecular();\n        vec4 materialEmission = getMaterialEmission();\n\n        float dotResultBetweenNormAndLight = dot(normal, lightDir);\n        float diff = max(dotResultBetweenNormAndLight, 0.0);\n\n        vec4 emissionColor = materialEmission;\n\n        vec4 ambientColor = (u_ambient + materialLight) * materialDiffuse;\n\n\n        if(u_lightModel == 3){\n            return emissionColor + ambientColor;\n        }\n\n\n        vec4 diffuseColor = color * materialDiffuse;\n\n        //not affect alpha data\n        diffuseColor = vec4(diff * vec3(diffuseColor) * intensity, diffuseColor.a);\n\n\n        float spec = 0.0;\n\n        if(u_lightModel == 2){\n                spec = getPhongShininess(u_shininess, normal, lightDir, viewDir, diff);\n        }\n        else if(u_lightModel == 1){\n                spec = getBlinnShininess(u_shininess, normal, lightDir, viewDir, diff);\n        }\n\n        //not affect alpha data\n        vec4 specularColor = vec4(spec * vec3(materialSpecular) * intensity, materialSpecular.a);\n\n        vec4 tColor = diffuseColor + specularColor;\n\n        //not affect alpha data\n        return emissionColor + ambientColor + vec4(attenuation * vec3(tColor), tColor.a);\n}\n\n\n\n\n#if POINT_LIGHTS_COUNT > 0\n        vec4 calcPointLight(vec3 lightDir, PointLight light, vec3 normal, vec3 viewDir)\n{\n        //lightDir is not normalize computing distance\n        float distance = length(lightDir);\n\n        float attenuation = 0.0;\n\n        if(light.range == NULL || distance < light.range)\n        {\n            attenuation = 1.0 / (light.constant + light.linear * distance + light.quadratic * (distance * distance));\n        }\n\n        lightDir = normalize(lightDir);\n\n        return calcLight(lightDir, light.color, light.intensity, attenuation, normal, viewDir);\n}\n#endif\n\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\n        vec4 calcDirectionLight(vec3 lightDir, DirectionLight light, vec3 normal, vec3 viewDir)\n{\n        float attenuation = 1.0;\n\n        lightDir = normalize(lightDir);\n\n        return calcLight(lightDir, light.color, light.intensity, attenuation, normal, viewDir);\n}\n#endif\n\n\n\nvec4 calcTotalLight(vec3 norm, vec3 viewDir){\n    vec4 totalLight = vec4(0.0);\n\n    #if POINT_LIGHTS_COUNT > 0\n                for(int i = 0; i < POINT_LIGHTS_COUNT; i++){\n                totalLight += calcPointLight(getPointLightDir(i), u_pointLights[i], norm, viewDir);\n        }\n    #endif\n\n    #if DIRECTION_LIGHTS_COUNT > 0\n                for(int i = 0; i < DIRECTION_LIGHTS_COUNT; i++){\n                totalLight += calcDirectionLight(getDirectionLightDir(i), u_directionLights[i], norm, viewDir);\n        }\n    #endif\n\n        return totalLight;\n}\n",body:"vec3 normal = normalize(getNormal());\n\n#ifdef BOTH_SIDE\nnormal = normal * (-1.0 + 2.0 * float(gl_FrontFacing));\n#endif\n\nvec3 viewDir = normalize(getViewDir());\n\nvec4 totalColor = calcTotalLight(normal, viewDir);\n\ntotalColor *= vec4(getShadowVisibility(), 1.0);\n"},ShaderChunk.light_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_Position = u_pMatrix * u_vMatrix * vec4(v_worldPosition, 1.0);\n"},ShaderChunk.map_forBasic_fragment={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= texture2D(u_sampler2D0, v_mapCoord0);\n"},ShaderChunk.map_forBasic_vertex={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord0 = a_texCoord * u_map0SourceRegion.zw + u_map0SourceRegion.xy;\n\n    v_mapCoord0 = sourceTexCoord0 * u_map0RepeatRegion.zw + u_map0RepeatRegion.xy;\n"},ShaderChunk.multi_map_forBasic_fragment={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\nvarying vec2 v_mapCoord1;\n",funcDeclare:"",funcDefine:"vec4 getMapColor(){\n            vec4 color0 = texture2D(u_sampler2D0, v_mapCoord0);\n            vec4 color1 = texture2D(u_sampler2D1, v_mapCoord1);\n\n            if(u_combineMode == 0){\n                return mix(color0, color1, u_mixRatio);\n            }\n            else if(u_combineMode == 1){\n                return color0 * color1;\n            }\n            else if(u_combineMode == 2){\n                return color0 + color1;\n            }\n\n            /*!\n            solve error in window7 chrome/firefox:\n            not all control paths return a value.\n            failed to create d3d shaders\n            */\n            return vec4(1.0);\n\t\t}\n",body:"totalColor *= getMapColor();\n"},ShaderChunk.multi_map_forBasic_vertex={top:"",define:"",varDeclare:"varying vec2 v_mapCoord1;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord1 = a_texCoord * u_map1SourceRegion.zw + u_map1SourceRegion.xy;\n\n    v_mapCoord1 = sourceTexCoord1 * u_map1RepeatRegion.zw + u_map1RepeatRegion.xy;\n"},ShaderChunk.skybox_fragment={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"gl_FragColor = textureCube(u_samplerCube0, v_dir);\n"},ShaderChunk.skybox_vertex={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"vec4 pos = u_pMatrix * mat4(mat3(u_vMatrix)) * mMatrix * vec4(a_position, 1.0);\n\n    gl_Position = pos.xyww;\n\n    v_dir = a_position;\n"},ShaderChunk.basic_forBasic_envMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, v_dir);\n"},ShaderChunk.basic_forBasic_envMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"v_dir = a_position;\n"},ShaderChunk.forBasic_envMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_normal;\nvarying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"vec3 inDir = normalize(v_position - u_cameraPos);\n"},ShaderChunk.forBasic_envMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_normal;\nvarying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"v_normal = normalize( normalMatrix * a_normal);\n    v_position = vec3(mMatrix * vec4(a_position, 1.0));\n"},ShaderChunk.fresnel_forBasic_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float computeFresnelRatio(vec3 inDir, vec3 normal, float refractionRatio){\n    float f = pow(1.0 - refractionRatio, 2.0) / pow(1.0 + refractionRatio, 2.0);\n    float fresnelPower = 5.0;\n    float ratio = f + (1.0 - f) * pow((1.0 - dot(inDir, normal)), fresnelPower);\n\n    return ratio / 100.0;\n}\nvec4 getEnvMapTotalColor(vec3 inDir, vec3 normal){\n    vec3 reflectDir = reflect(inDir, normal);\n    vec3 refractDir = refract(inDir, flipNormal(normal), u_refractionRatio);\n\n    vec4 reflectColor = textureCube(u_samplerCube0, reflectDir);\n    vec4 refractColor = textureCube(u_samplerCube0, refractDir);\n\n    vec4 totalColor = vec4(0.0);\n\n\tif(u_reflectivity != NULL){\n        totalColor = mix(reflectColor, refractColor, u_reflectivity);\n\t}\n\telse{\n        totalColor = mix(reflectColor, refractColor, computeFresnelRatio(inDir, normal, u_refractionRatio));\n\t}\n\n\treturn totalColor;\n}\n",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= getEnvMapTotalColor(inDir, normalize(v_normal));\n}\n"},ShaderChunk.reflection_forBasic_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, reflect(inDir, normalize(v_normal)));\n}\n"},ShaderChunk.refraction_forBasic_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, refract(inDir, v_normal, u_refractionRatio));\n}\n"},ShaderChunk.basic_forLight_envMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_basicEnvMap_dir;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, v_basicEnvMap_dir);\n"},ShaderChunk.basic_forLight_envMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_basicEnvMap_dir;\n",funcDeclare:"",funcDefine:"",body:"v_basicEnvMap_dir = a_position;\n"},ShaderChunk.forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 inDir = normalize(v_worldPosition - u_cameraPos);\n"},ShaderChunk.forLight_envMap_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.fresnel_forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float computeFresnelRatio(vec3 inDir, vec3 normal, float refractionRatio){\n    float f = pow(1.0 - refractionRatio, 2.0) / pow(1.0 + refractionRatio, 2.0);\n    float fresnelPower = 5.0;\n    float ratio = f + (1.0 - f) * pow((1.0 - dot(inDir, normal)), fresnelPower);\n\n    return ratio / 100.0;\n}\n\nvec4 getEnvMapTotalColor(vec3 inDir, vec3 normal){\n    vec3 reflectDir = reflect(inDir, normal);\n\n/*!\n//todo why only fresnel->refraction need flip normal, but refraction don't need?\n*/\n    vec3 refractDir = refract(inDir, flipNormal(normal), u_refractionRatio);\n\n    vec4 reflectColor = textureCube(u_samplerCube0, reflectDir);\n    vec4 refractColor = textureCube(u_samplerCube0, refractDir);\n\n\n    vec4 totalColor = vec4(0.0);\n\n\tif(u_reflectivity != NULL){\n        totalColor = mix(reflectColor, refractColor, u_reflectivity);\n\t}\n\telse{\n        totalColor = mix(reflectColor, refractColor, computeFresnelRatio(inDir, normal, u_refractionRatio));\n\t}\n\n\treturn totalColor;\n}\n",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n\ttotalColor *= getEnvMapTotalColor(inDir, normalize(getNormal()));\n}\n"},ShaderChunk.reflection_forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, reflect(inDir, normalize(getNormal())));\n}\n"},ShaderChunk.refraction_forLight_envMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= textureCube(u_samplerCube0, refract(inDir, flipNormal(normal), u_refractionRatio));\n}\n"},ShaderChunk.modelMatrix_batch_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat4 mMatrix = u_mMatrix;\n"
},ShaderChunk.normalMatrix_batch_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat3 normalMatrix = u_normalMatrix;\n"},ShaderChunk.modelMatrix_hardware_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat4 mMatrix = mat4(a_mVec4_0, a_mVec4_1, a_mVec4_2, a_mVec4_3);\n"},ShaderChunk.normalMatrix_hardware_instance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat3 normalMatrix = mat3(a_normalVec4_0, a_normalVec4_1, a_normalVec4_2);\n"},ShaderChunk.modelMatrix_noInstance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat4 mMatrix = u_mMatrix;\n"},ShaderChunk.normalMatrix_noInstance_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"mat3 normalMatrix = u_normalMatrix;\n"},ShaderChunk.diffuseMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_diffuseMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialDiffuse() {\n        return texture2D(u_diffuseMapSampler, v_diffuseMapTexCoord);\n    }\n",body:""},ShaderChunk.diffuseMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_diffuseMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"//todo optimize(combine, reduce compute numbers)\n    //todo BasicTexture extract textureMatrix\n    vec2 sourceTexCoord = a_texCoord * u_diffuseSourceRegion.zw + u_diffuseSourceRegion.xy;\n    v_diffuseMapTexCoord = sourceTexCoord * u_diffuseRepeatRegion.zw + u_diffuseRepeatRegion.xy;\n"},ShaderChunk.emissionMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_emissionMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialEmission() {\n        return texture2D(u_emissionMapSampler, v_emissionMapTexCoord);\n    }\n",body:""},ShaderChunk.emissionMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_emissionMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_emissionMapTexCoord = a_texCoord;\n"},ShaderChunk.lightMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_lightMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialLight() {\n        return texture2D(u_lightMapSampler, v_lightMapTexCoord) * u_lightMapIntensity;\n    }\n",body:""},ShaderChunk.lightMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_lightMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_lightMapTexCoord = a_texCoord;\n"},ShaderChunk.noDiffuseMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialDiffuse() {\n        return u_diffuse;\n    }\n",body:""},ShaderChunk.noEmissionMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialEmission() {\n        return u_emission;\n    }\n",body:""},ShaderChunk.noLightMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialLight() {\n        return vec4(0.0);\n    }\n",body:""},ShaderChunk.noNormalMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_normal;\n",funcDeclare:"vec3 getNormal();\n\n",funcDefine:"#if POINT_LIGHTS_COUNT > 0\nvec3 getPointLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return getPointLightDirByLightPos(u_pointLights[x].position);\n        }\n    }\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvec3 getDirectionLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return getDirectionLightDirByLightPos(u_directionLights[x].position);\n        }\n    }\n\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n\nvec3 getViewDir(){\n    return normalize(u_cameraPos - v_worldPosition);\n}\nvec3 getNormal(){\n    return v_normal;\n}\n\n",body:""},ShaderChunk.noNormalMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_normal;\n",funcDeclare:"",funcDefine:"",body:"v_normal = normalize(normalMatrix * a_normal);\n"},ShaderChunk.noSpecularMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialSpecular() {\n        return u_specular;\n    }\n",body:""},ShaderChunk.normalMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_normalMapTexCoord;\nvarying vec3 v_viewDir;\n#if POINT_LIGHTS_COUNT > 0\nvarying vec3 v_pointLightDir[POINT_LIGHTS_COUNT];\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvarying vec3 v_directionLightDir[DIRECTION_LIGHTS_COUNT];\n#endif\n\n",funcDeclare:"vec3 getNormal();\n\nvec3 getLightDir(vec3 lightPos);\n\n",funcDefine:"#if POINT_LIGHTS_COUNT > 0\nvec3 getPointLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return v_pointLightDir[x];\n        }\n    }\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\n\nvec3 getDirectionLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return v_directionLightDir[x];\n        }\n    }\n\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n\nvec3 getViewDir(){\n    return v_viewDir;\n}\nvec3 getNormal(){\n        // Obtain normal from normal map in range [0,1]\n        vec3 normal = texture2D(u_normalMapSampler, v_normalMapTexCoord).rgb;\n\n        // Transform normal vector to range [-1,1]\n        return normalize(normal * 2.0 - 1.0);  // this normal is in tangent space\n}\n",body:""},ShaderChunk.normalMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_normalMapTexCoord;\n\tvarying vec3 v_viewDir;\n\n\n#if POINT_LIGHTS_COUNT > 0\nvarying vec3 v_pointLightDir[POINT_LIGHTS_COUNT];\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvarying vec3 v_directionLightDir[DIRECTION_LIGHTS_COUNT];\n#endif\n\n",funcDeclare:"",funcDefine:"mat3 computeTBN(mat3 normalMatrix){\n            vec3 T = normalize(normalMatrix * a_tangent);\n            vec3 N = normalize(normalMatrix * a_normal);\n            // re-orthogonalize T with respect to N\n            T = normalize(T - dot(T, N) * N);\n            // then retrieve perpendicular vector B with the cross product of T and N\n            vec3 B = cross(T, N);\n\n\n            return transpose(mat3(T, B, N));\n        }\n",body:"mat3 TBN = computeTBN(normalMatrix);\n\n    //v_tangentLightPos = TBN * light.position;\n    //v_tangentCameraPos  = TBN * u_cameraPos;\n    //v_tangentPos  = TBN * v_position;\n\n\n    vec3 tangentPosition = TBN * vec3(mMatrix * vec4(a_position, 1.0));\n\n    v_normalMapTexCoord = a_texCoord;\n\n    v_viewDir = normalize(TBN * u_cameraPos - tangentPosition);\n\n\n#if POINT_LIGHTS_COUNT > 0\n       for(int i = 0; i < POINT_LIGHTS_COUNT; i++){\n            //not normalize for computing distance\n            v_pointLightDir[i] = TBN * getPointLightDirByLightPos(u_pointLights[i].position, tangentPosition);\n       }\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\n       for(int i = 0; i < DIRECTION_LIGHTS_COUNT; i++){\n            v_directionLightDir[i] = normalize(- TBN * getDirectionLightDirByLightPos(u_directionLights[i].position));\n       }\n#endif\n\n"},ShaderChunk.specularMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_specularMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialSpecular() {\n        return texture2D(u_specularMapSampler, v_specularMapTexCoord);\n    }\n",body:""},ShaderChunk.specularMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_specularMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_specularMapTexCoord = a_texCoord;\n"},ShaderChunk.buildCubemapShadowMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n",funcDeclare:"",funcDefine:"",body:"\n// get distance between fragment and light source\n    float lightDistance = length(v_worldPosition - u_lightPos);\n\n    // map to [0,1] range by dividing by farPlane\n    lightDistance = lightDistance / u_farPlane;\n\n\ngl_FragData[0] = packDepth(lightDistance);\n\n\n//gl_FragColor = vec4(0.5, 0.0, 1.0, 1.0);\n//gl_FragData[0] = vec4(lightDistance, 1.0, 1.0, 1.0);\n"},ShaderChunk.buildCubemapShadowMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n",funcDeclare:"",funcDefine:"",body:"v_worldPosition = vec3(mMatrix * vec4(a_position, 1.0));\n    gl_Position = u_pMatrix * u_vMatrix * vec4(v_worldPosition, 1.0);\n"},ShaderChunk.buildTwoDShadowMap_depthMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.buildTwoDShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.buildTwoDShadowMap_packDepth_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragData[0] = packDepth(gl_FragCoord.z);\n"},ShaderChunk.buildTwoDShadowMap_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_Position = u_vpMatrixFromLight * mMatrix * vec4(a_position, 1.0);\n"},ShaderChunk.commonBuildShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"// Packing a float in GLSL with multiplication and mod\nvec4 packDepth(in float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n\n    return res;\n}\n",body:""},ShaderChunk.cubemapShadowMap_fragment={top:"",define:"",varDeclare:"uniform samplerCube u_cubemapShadowMapSampler[ CUBEMAP_SHADOWMAP_COUNT ];\n\n    uniform int u_isCubemapRenderListEmpty[ CUBEMAP_SHADOWMAP_COUNT ];\n\tuniform float u_cubemapShadowDarkness[ CUBEMAP_SHADOWMAP_COUNT ];\n\tuniform float u_cubemapShadowBias[ CUBEMAP_SHADOWMAP_COUNT ];\n\tuniform float u_farPlane[ CUBEMAP_SHADOWMAP_COUNT ];\n\tuniform vec3 u_cubemapLightPos[ CUBEMAP_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"// PCF\nfloat getCubemapShadowVisibilityByPCF(float currentDepth, vec3 fragToLight, samplerCube cubemapShadowMapSampler, float shadowBias, float farPlane, float shadowDarkness){\n    //only support in opengl es 3.0+\n    //vec3 sampleOffsetDirections[20] = vec3[]\n    //(\n       //vec3( 1,  1,  1), vec3( 1, -1,  1), vec3(-1, -1,  1), vec3(-1,  1,  1),\n       //vec3( 1,  1, -1), vec3( 1, -1, -1), vec3(-1, -1, -1), vec3(-1,  1, -1),\n       //vec3( 1,  1,  0), vec3( 1, -1,  0), vec3(-1, -1,  0), vec3(-1,  1,  0),\n       //vec3( 1,  0,  1), vec3(-1,  0,  1), vec3( 1,  0, -1), vec3(-1,  0, -1),\n       //vec3( 0,  1,  1), vec3( 0, -1,  1), vec3( 0, -1, -1), vec3( 0,  1, -1)\n    //);\n\n    vec3 sampleOffsetDirections[20];\n\n    sampleOffsetDirections[0] = vec3( 1,  1,  1);\n    sampleOffsetDirections[1] = vec3( 1,  -1,  1);\n    sampleOffsetDirections[2] = vec3( -1,  -1,  1);\n    sampleOffsetDirections[3] = vec3( -1,  1,  1);\n\n    sampleOffsetDirections[4] = vec3( 1,  1,  -1);\n    sampleOffsetDirections[5] = vec3( 1,  -1,  -1);\n    sampleOffsetDirections[6] = vec3( -1,  -1,  -1);\n    sampleOffsetDirections[7] = vec3( -1,  1,  -1);\n\n    sampleOffsetDirections[8] = vec3( 1,  1,  0);\n    sampleOffsetDirections[9] = vec3( 1,  -1,  0);\n    sampleOffsetDirections[10] = vec3( -1,  -1,  0);\n    sampleOffsetDirections[11] = vec3( -1,  1,  0);\n\n    sampleOffsetDirections[12] = vec3( 1,  0,  1);\n    sampleOffsetDirections[13] = vec3( -1,  0,  1);\n    sampleOffsetDirections[14] = vec3( 1,  0,  -1);\n    sampleOffsetDirections[15] = vec3( -1,  0,  -1);\n\n    sampleOffsetDirections[16] = vec3( 0,  1,  1);\n    sampleOffsetDirections[17] = vec3( 0,  -1,  1);\n    sampleOffsetDirections[18] = vec3( 0,  -1,  -1);\n    sampleOffsetDirections[19] = vec3( 0,  1,  -1);\n\n    float shadow = 0.0;\n    int samples = 20;\n\n    //float diskRadius = 0.00000;\n    //Another interesting trick we can apply here is that we can change the diskRadius based on how far the viewer is away from a fragment; this way we can increase the offset radius by the distance to the viewer, making the shadows softer when far away and sharper when close by.\n    float viewDistance = length(u_cameraPos - v_worldPosition);\n    float diskRadius = (1.0 + (viewDistance / farPlane)) / 25.0;\n\n    //for(int i = 0; i < samples; ++i)\n    for(int i = 0; i < 20; ++i)\n    {\n        float pcfDepth = unpackDepth(textureCube(cubemapShadowMapSampler, fragToLight + sampleOffsetDirections[i] * diskRadius));\n        pcfDepth *= farPlane;   // Undo mapping [0;1]\n        shadow += currentDepth - shadowBias > pcfDepth  ? shadowDarkness : 1.0;\n    }\n    shadow /= float(samples);\n\n    return shadow;\n}\n\n\nfloat getCubemapShadowVisibility(vec3 lightDir, samplerCube cubemapShadowMapSampler, vec3 lightPos, float farPlane, float shadowBias, float  shadowDarkness) {\n// Get vector between fragment position and light position\n    vec3 fragToLight= v_worldPosition - lightPos;\n    // Use the light to fragment vector to sample from the depth map\n    // Now get current linear depth as the length between the fragment and light position\n    float currentDepth = length(fragToLight);\n\n    #if defined(SHADOWMAP_TYPE_PCF)\n    return getCubemapShadowVisibilityByPCF(currentDepth, fragToLight, cubemapShadowMapSampler, getShadowBias(lightDir, shadowBias), farPlane, shadowDarkness);\n    #endif\n\n    float closestDepth = unpackDepth(textureCube(cubemapShadowMapSampler, fragToLight));\n\n    // It is currently in linear range between [0,1]. Re-transform back to original value\n    closestDepth *= farPlane;\n\n\n    return float(currentDepth > closestDepth + getShadowBias(lightDir, shadowBias) ? shadowDarkness : 1.0);\n}\n",body:""},ShaderChunk.noShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getShadowVisibility() {\n        return vec3(1.0);\n    }\n",body:""},ShaderChunk.totalShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"float getShadowBias(vec3 lightDir, float shadowBias);\nfloat unpackDepth(vec4 rgbaDepth);\n",funcDefine:"float getShadowBias(vec3 lightDir, float shadowBias){\n    float bias = shadowBias;\n\n    if(shadowBias == NULL){\n        bias = 0.005;\n    }\n\n\n     /*!\n     A shadow bias of 0.005 solves the issues of our scene by a large extent, but some surfaces that have a steep angle to the light source might still produce shadow acne. A more solid approach would be to change the amount of bias based on the surface angle towards the light: something we can solve with the dot product:\n     */\n\n     return max(bias * (1.0 - dot(normalize(getNormal()), lightDir)), bias);\n\n    //return bias;\n}\n\nvec3 getShadowVisibility() {\n    vec3 shadowColor = vec3(1.0);\n    vec3 twoDLightDir = vec3(0.0);\n    vec3 cubemapLightDir = vec3(0.0);\n\n\n\n    //to normalMap, the lightDir use the origin one instead of normalMap's lightDir here(the lightDir is used for computing shadowBias, the origin one is enough for it)\n\n    #if TWOD_SHADOWMAP_COUNT > 0\n\tfor( int i = 0; i < TWOD_SHADOWMAP_COUNT; i ++ ) {\n        if(isRenderListEmpty(u_isTwoDRenderListEmpty[i])){\n            continue;\n        }\n\n        twoDLightDir = getDirectionLightDirByLightPos(u_twoDLightPos[i]);\n\n\t////if is opposite to direction of light rays, no shadow\n\n        shadowColor *= getTwoDShadowVisibility(twoDLightDir, u_twoDShadowMapSampler[i], v_positionFromLight[i], u_twoDShadowBias[i], u_twoDShadowDarkness[i], u_twoDShadowSize[i]);\n\t}\n\t#endif\n\n\n\t#if CUBEMAP_SHADOWMAP_COUNT > 0\n\n\tfor( int i = 0; i < CUBEMAP_SHADOWMAP_COUNT; i ++ ) {\n        if(isRenderListEmpty(u_isCubemapRenderListEmpty[i])){\n            continue;\n        }\n\n\t////if is opposite to direction of light rays, no shadow\n\n        shadowColor *= getCubemapShadowVisibility(cubemapLightDir, u_cubemapShadowMapSampler[i], u_cubemapLightPos[i], u_farPlane[i], u_cubemapShadowBias[i], u_cubemapShadowDarkness[i]);\n\t}\n\t#endif\n\n\treturn shadowColor;\n}\n\nfloat unpackDepth(vec4 rgbaDepth) {\n    /*! make sure that the visibility from the shadow map which is not builded is always be 1.0 */\n    if(rgbaDepth == vec4(0.0)){\n        return 100000.0;\n    }\n\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n\n",body:""},ShaderChunk.twoDShadowMap_depthMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"float handleDepthMap(vec4 rgbaDepth);\n",funcDefine:"float handleDepthMap(vec4 rgbaDepth) {\n    return rgbaDepth.r;\n}\n",body:""},ShaderChunk.twoDShadowMap_fragment={top:"",define:"",varDeclare:"varying vec4 v_positionFromLight[ TWOD_SHADOWMAP_COUNT ];\n    uniform int u_isTwoDRenderListEmpty[ TWOD_SHADOWMAP_COUNT ];\n\tuniform sampler2D u_twoDShadowMapSampler[ TWOD_SHADOWMAP_COUNT ];\n\tuniform float u_twoDShadowDarkness[ TWOD_SHADOWMAP_COUNT ];\n\tuniform float u_twoDShadowBias[ TWOD_SHADOWMAP_COUNT ];\n\tuniform vec2 u_twoDShadowSize[ TWOD_SHADOWMAP_COUNT ];\n\tuniform vec3 u_twoDLightPos[ TWOD_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"// PCF\nfloat getTwoDShadowVisibilityByPCF(float currentDepth, vec2 shadowCoord, sampler2D twoDShadowMapSampler, float shadowBias, float shadowDarkness, vec2 shadowMapSize){\n\n    float shadow = 0.0;\n    vec2 texelSize = vec2(1.0 / shadowMapSize[0], 1.0 / shadowMapSize[1]);\n\n    for(int x = -1; x <= 1; ++x)\n    {\n        for(int y = -1; y <= 1; ++y)\n        {\n            float pcfDepth = handleDepthMap(texture2D(twoDShadowMapSampler, shadowCoord + vec2(x, y) * texelSize));\n            shadow += currentDepth - shadowBias > pcfDepth  ? shadowDarkness : 1.0;\n        }\n    }\n    shadow /= 9.0;\n\n    return shadow;\n}\n\n\n\nfloat getTwoDShadowVisibility(vec3 lightDir, sampler2D twoDShadowMapSampler, vec4 v_positionFromLight, float shadowBias, float shadowDarkness, vec2 shadowSize) {\n    //project texture\n    vec3 shadowCoord = (v_positionFromLight.xyz / v_positionFromLight.w) / 2.0 + 0.5;\n    //vec3 shadowCoord = vec3(0.5, 0.5, 0.5);\n\n    #ifdef SHADOWMAP_TYPE_PCF\n    // Percentage-close filtering\n    // (9 pixel kernel)\n    return getTwoDShadowVisibilityByPCF(shadowCoord.z, shadowCoord.xy, twoDShadowMapSampler, getShadowBias(lightDir, shadowBias), shadowDarkness, shadowSize);\n\n    #else\n    return shadowCoord.z > handleDepthMap(texture2D(twoDShadowMapSampler, shadowCoord.xy)) + getShadowBias(lightDir, shadowBias) ? shadowDarkness : 1.0;\n    #endif\n}\n",body:""},ShaderChunk.twoDShadowMap_unpackDepth_fragment={top:"",define:"",varDeclare:"",funcDeclare:"float handleDepthMap(vec4 rgbaDepth);\n",funcDefine:"float handleDepthMap(vec4 rgbaDepth) {\n    return unpackDepth(rgbaDepth);\n}\n",body:""},ShaderChunk.twoDShadowMap_vertex={top:"",define:"",varDeclare:"varying vec4 v_positionFromLight[ TWOD_SHADOWMAP_COUNT ];\nuniform mat4 u_vpMatrixFromLight[ TWOD_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"",body:"for( int i = 0; i < TWOD_SHADOWMAP_COUNT; i ++ ) {\n    v_positionFromLight[i] = u_vpMatrixFromLight[i] * vec4(v_worldPosition, 1.0);\n\t}\n"},ShaderChunk.basic_bitmapFont_fragment={top:"",define:"",varDeclare:"varying vec2 v_bitmapCoord;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= texture2D(u_bitmapSampler, v_bitmapCoord);\n"},ShaderChunk.common_bitmapFont_vertex={top:"",define:"",varDeclare:"varying vec2 v_bitmapCoord;\n",funcDeclare:"",funcDefine:"",body:"v_bitmapCoord = a_texCoord;\n"},ShaderChunk.multiPages_bitmapFont_fragment={top:"",define:"",varDeclare:"uniform sampler2D u_pageSampler2Ds[PAGE_COUNT];\nvarying vec2 v_bitmapCoord;\nvarying float v_page;\n",funcDeclare:"",funcDefine:"",body:""},ShaderChunk.multiPages_bitmapFont_vertex={top:"",define:"",varDeclare:"varying float v_page;\n",funcDeclare:"",funcDefine:"",body:"v_page = a_page;\n"},ShaderChunk.sdf_bitmapFont_smoothStep_fallback={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float sdfSmoothStep(float value) {\n    /*! gl_FragCoord.w is wrong, need fix! */\n    float afwidth = (1.0 / 32.0) * (1.4142135623730951 / (2.0 * gl_FragCoord.w));\n    return smoothstep(0.5 - afwidth, 0.5 + afwidth, value);\n}\n",body:""},ShaderChunk.sdf_bitmapFont_smoothStep_standardDerivatives={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float sdfSmoothStep(float value) {\n      float afwidth = length(vec2(dFdx(value), dFdy(value))) * 0.70710678118654757;\n    return smoothstep(0.5 - afwidth, 0.5 + afwidth, value);\n}\n",body:""},ShaderChunk.sdf_bitmapFont_smooth_fragment={top:"",define:"",varDeclare:"varying vec2 v_bitmapCoord;\n",funcDeclare:"",funcDefine:"",body:"gl_FragColor.a *= sdfSmoothStep(texture2D(u_bitmapSampler, v_bitmapCoord).a);\n"},ShaderChunk.mirror_fragment={top:"",define:"",varDeclare:"varying vec4 v_reflectionMapCoord;\n",funcDeclare:"",funcDefine:"//todo add more blend way to mix reflectionMap color and textureColor\n\t\tfloat blendOverlay(float base, float blend) {\n\t\t\treturn( base < 0.5 ? ( 2.0 * base * blend ) : (1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n\t\t}\n\t\tvec4 getReflectionMapColor(in vec4 materialColor){\n\t\t\tvec4 color = texture2DProj(u_reflectionMapSampler, v_reflectionMapCoord);\n\n\t\t\tcolor = vec4(blendOverlay(materialColor.r, color.r), blendOverlay(materialColor.g, color.g), blendOverlay(materialColor.b, color.b), 1.0);\n\n\t\t\treturn color;\n\t\t}\n",body:"if(!isRenderListEmpty(u_isRenderListEmpty)){\n    totalColor *= getReflectionMapColor(totalColor);\n}\n"},ShaderChunk.mirror_vertex={top:"",define:"",varDeclare:"varying vec4 v_reflectionMapCoord;\n",funcDeclare:"",funcDefine:"",body:"mat4 textureMatrix = mat4(\n                        0.5, 0.0, 0.0, 0.0,\n                        0.0, 0.5, 0.0, 0.0,\n                        0.0, 0.0, 0.5, 0.0,\n                        0.5, 0.5, 0.5, 1.0\n);\n\nv_reflectionMapCoord = textureMatrix * gl_Position;\n"},ShaderChunk.terrainLayer_fragment={top:"",define:"",varDeclare:"struct LayerHeightData {\n    float minHeight;\n    float maxHeight;\n};\nuniform LayerHeightData u_layerHeightDatas[LAYER_COUNT];\n//sampler2D can't be contained in struct\nuniform sampler2D u_layerSampler2Ds[LAYER_COUNT];\n\n\nvarying vec2 v_layerTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getLayerTextureColor(in sampler2D layerSampler2Ds[LAYER_COUNT], in LayerHeightData layerHeightDatas[LAYER_COUNT]){\n    vec4 color = vec4(0.0);\n    bool isInLayer = false;\n\n    float height = v_worldPosition.y;\n\n    for(int i = 0; i < LAYER_COUNT; i++){\n        if(height >= layerHeightDatas[i].minHeight && height <= layerHeightDatas[i].maxHeight){\n            //todo blend color\n            color += texture2D(layerSampler2Ds[i], v_layerTexCoord);\n\n            isInLayer = true;\n\n            break;\n        }\n    }\n\n    return isInLayer ? color : vec4(1.0);\n}\n",body:"\ntotalColor *= getLayerTextureColor(u_layerSampler2Ds, u_layerHeightDatas);\n"},ShaderChunk.terrainLayer_vertex={top:"",define:"",varDeclare:"varying vec2 v_layerTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_layerTexCoord = a_texCoord;\n"},ShaderChunk.water_bump_fragment={top:"",define:"",varDeclare:"varying vec2 v_bumpTexCoord;\n",funcDeclare:"",funcDefine:"",body:"// fetch bump texture, unpack from [0..1] to [-1..1]\n\tvec3 bumpNormal = 2.0 * texture2D(u_bumpMapSampler, v_bumpTexCoord).rgb - 1.0;\n\tvec2 perturbation = u_waveData.height * bumpNormal.rg;\n"},ShaderChunk.water_bump_vertex={top:"",define:"",varDeclare:"struct WaveData {\n    float length;\n    float height;\n};\nuniform WaveData u_waveData;\nvarying vec2 v_bumpTexCoord;\n",funcDeclare:"",funcDefine:"",body:"vec2 bumpTexCoord = vec2(u_windMatrix * vec4(a_texCoord, 0.0, 1.0));\n\tv_bumpTexCoord = bumpTexCoord / u_waveData.length;\n"},ShaderChunk.water_fragment={top:"",define:"",varDeclare:"struct WaveData {\n    float length;\n    float height;\n};\nuniform WaveData u_waveData;\nstruct LevelData {\n    float fresnelLevel;\n    float reflectionLevel;\n    float refractionLevel;\n};\nuniform LevelData u_levelData;\n\nvarying vec4 v_reflectionAndRefractionMapCoord;\n",funcDeclare:"",funcDefine:"",body:"vec2 projectedTexCoords = v_reflectionAndRefractionMapCoord.xy / v_reflectionAndRefractionMapCoord.w + perturbation;\n\n\n\n\n//totalColor = vec4(1.0 - fresnelTerm);\n//totalColor *= vec4(refractionColor, 1.0);\n//totalColor *= vec4(mix(reflectionColor, refractionColor, fresnelTerm), 1.0);\n//totalColor += vec4(reflectionColor * fresnelTerm * u_levelData.reflectionLevel + (1.0 - fresnelTerm) * refractionColor * u_levelData.refractionLevel, 1.0);\n\n//totalColor += vec4(reflectionColor * fresnelTerm * u_levelData.reflectionLevel + (1.0 - fresnelTerm) * refractionColor * u_levelData.refractionLevel, 1.0);\n\ntotalColor += vec4(getLightEffectColor(projectedTexCoords), 1.0);\n\n\n//totalColor *= vec4(mix(reflectionColor, refractionColor, 0.5), 1.0);\n"},ShaderChunk.water_fresnel_fragment={top:"",define:"",varDeclare:"varying vec3 v_position;\n",funcDeclare:"",funcDefine:"vec3 getLightEffectColor(vec2 projectedTexCoords){\n\tvec3 reflectionColor;\n\tvec3 refractionColor;\n\n    vec3 inDir = normalize(v_position - u_cameraPos);\n\n\tfloat fresnelTerm = max(dot(inDir, v_normal), 0.0);\n\tfresnelTerm = clamp((1.0 - fresnelTerm) * u_levelData.fresnelLevel, 0., 1.);\n\n    if(!isRenderListEmpty(u_isReflectionRenderListEmpty)){\n        reflectionColor = texture2D(u_reflectionMapSampler, projectedTexCoords).rgb;\n        reflectionColor = reflectionColor * fresnelTerm * u_levelData.reflectionLevel;\n\t}\n\telse{\n        reflectionColor = vec3(0.0);\n\t}\n\n    if(!isRenderListEmpty(u_isRefractionRenderListEmpty)){\n        refractionColor = texture2D(u_refractionMapSampler, projectedTexCoords).rgb;\n        refractionColor = (1.0 - fresnelTerm) * refractionColor * u_levelData.refractionLevel;\n\t}\n\telse{\n        refractionColor = vec3(0.0);\n\t}\n\n\treturn reflectionColor + refractionColor;\n}\n",body:""},ShaderChunk.water_fresnel_vertex={top:"",define:"",varDeclare:"varying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"v_position = a_position;\n"},ShaderChunk.water_noBump_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec2 perturbation = vec2(0.0);\n"},ShaderChunk.water_noLightEffect_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getLightEffectColor(vec2 projectedTexCoords){\n    return vec3(0.0);\n}\n",body:""},ShaderChunk.water_reflection_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getLightEffectColor(vec2 projectedTexCoords){\n    if(!isRenderListEmpty(u_isReflectionRenderListEmpty)){\n        return texture2D(u_reflectionMapSampler, projectedTexCoords).rgb * u_levelData.reflectionLevel;\n    }\n    return vec3(0.0);\n}\n",body:""},ShaderChunk.water_refraction_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getLightEffectColor(vec2 projectedTexCoords){\n    if(!isRenderListEmpty(u_isRefractionRenderListEmpty)){\n        return texture2D(u_refractionMapSampler, projectedTexCoords).rgb * u_levelData.refractionLevel;\n    }\n    return vec3(0.0);\n}\n",body:""},ShaderChunk.water_vertex={top:"",define:"",varDeclare:"varying vec4 v_reflectionAndRefractionMapCoord;\n",funcDeclare:"",funcDefine:"",body:"mat4 textureMatrix = mat4(\n                        0.5, 0.0, 0.0, 0.0,\n                        0.0, 0.5, 0.0, 0.0,\n                        0.0, 0.0, 0.5, 0.0,\n                        0.5, 0.5, 0.5, 1.0\n);\n\nv_reflectionAndRefractionMapCoord = textureMatrix * gl_Position;\n"},ShaderChunk.brick_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"float brickW = 1.0 / u_tilesWidthNumber;\n\tfloat brickH = 1.0 / u_tilesWidthNumber;\n\tfloat jointWPercentage = 0.01;\n\tfloat jointHPercentage = 0.05;\n\tvec3 color = u_brickColor;\n\tfloat yi = v_texCoord.y / brickH;\n\tfloat nyi = round(yi);\n\tfloat xi = v_texCoord.x / brickW;\n\n\tif (mod(floor(yi), 2.0) == 0.0){\n\t\txi = xi - 0.5;\n\t}\n\n\tfloat nxi = round(xi);\n\tvec2 brickv_texCoord = vec2((xi - floor(xi)) / brickH, (yi - floor(yi)) /  brickW);\n\n\tif (yi < nyi + jointHPercentage && yi > nyi - jointHPercentage){\n\t\tcolor = mix(u_jointColor, vec3(0.37, 0.25, 0.25), (yi - nyi) / jointHPercentage + 0.2);\n\t}\n\telse if (xi < nxi + jointWPercentage && xi > nxi - jointWPercentage){\n\t\tcolor = mix(u_jointColor, vec3(0.44, 0.44, 0.44), (xi - nxi) / jointWPercentage + 0.2);\n\t}\n\telse {\n\t\tfloat u_brickColorSwitch = mod(floor(yi) + floor(xi), 3.0);\n\n\t\tif (u_brickColorSwitch == 0.0)\n\t\t\tcolor = mix(color, vec3(0.33, 0.33, 0.33), 0.3);\n\t\telse if (u_brickColorSwitch == 2.0)\n\t\t\tcolor = mix(color, vec3(0.11, 0.11, 0.11), 0.3);\n\t}\n\n\tgl_FragColor = vec4(color, 1.0);\n"},ShaderChunk.cloud_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"gl_FragColor = mix(u_skyColor, u_cloudColor, fbm(v_texCoord * 12.0));\n"},ShaderChunk.common_proceduralTexture_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float rand(vec2 n) {\n\treturn fract(cos(dot(n, vec2(12.9898, 4.1414))) * 43758.5453);\n}\nfloat noise(vec2 n) {\n\tconst vec2 d = vec2(0.0, 1.0);\n\tvec2 b = floor(n), f = smoothstep(vec2(0.0), vec2(1.0), fract(n));\n\treturn mix(mix(rand(b), rand(b + d.yx), f.x), mix(rand(b + d.xy), rand(b + d.yy), f.x), f.y);\n}\n\nfloat turbulence(vec2 P)\n{\n\tfloat val = 0.0;\n\tfloat freq = 1.0;\n\tfor (int i = 0; i < 4; i++)\n\t{\n\t\tval += abs(noise(P*freq) / freq);\n\t\tfreq *= 2.07;\n\t}\n\treturn val;\n}\n\nfloat fbm(vec2 n) {\n\tfloat total = 0.0, amplitude = 1.0;\n\tfor (int i = 0; i < 4; i++) {\n\t\ttotal += noise(n) * amplitude;\n\t\tn += n;\n\t\tamplitude *= 0.5;\n\t}\n\treturn total;\n}\n\nfloat round(float number){\n\treturn sign(number)*floor(abs(number) + 0.5);\n}\n",body:""},ShaderChunk.common_proceduralTexture_vertex={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nconst vec2 MADD=vec2(0.5,0.5);\n",funcDeclare:"",funcDefine:"",body:"v_texCoord=a_positionVec2*MADD+MADD;\n\n    gl_Position=vec4(a_positionVec2, 0.0 ,1.0);\n"},ShaderChunk.fire_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nstruct FireColor {\n    vec3 c1;\n    vec3 c2;\n    vec3 c3;\n    vec3 c4;\n    vec3 c5;\n    vec3 c6;\n};\nuniform FireColor u_fireColor;\n",funcDeclare:"",funcDefine:"",body:"vec2 p = v_texCoord * 8.0;\n\tfloat q = fbm(p - u_time * 0.1);\n\tvec2 r = vec2(fbm(p + q + u_time * u_speed.x - p.x - p.y), fbm(p + q - u_time * u_speed.y));\n\tvec3 c = mix(u_fireColor.c1, u_fireColor.c2, fbm(p + r)) + mix(u_fireColor.c3, u_fireColor.c4, r.x) - mix(u_fireColor.c5, u_fireColor.c6, r.y);\n\tvec3 color = c * cos(u_shift * v_texCoord.y);\n\tfloat luminance = dot(color.rgb, vec3(0.3, 0.59, 0.11));\n\n\tgl_FragColor = vec4(color, luminance * u_alphaThreshold + (1.0 - u_alphaThreshold));\n"},ShaderChunk.grass_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"vec3 color = mix(u_groundColor, u_herb1Color, rand(gl_FragCoord.xy * 4.0));\n\tcolor = mix(color, u_herb2Color, rand(gl_FragCoord.xy * 8.0));\n\tcolor = mix(color, u_herb3Color, rand(gl_FragCoord.xy));\n\tcolor = mix(color, u_herb1Color, fbm(gl_FragCoord.xy * 16.0));\n\n\tgl_FragColor = vec4(color, 1.0);\n"
},ShaderChunk.marble_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nconst vec3 TILE_SIZE = vec3(1.1, 1.0, 1.1);\n//const vec3 TILE_PCT = vec3(0.98, 1.0, 0.98);\n",funcDeclare:"",funcDefine:"vec3 marble_color(float x)\n{\n\tvec3 col;\n\tx = 0.5*(x + 1.);\n\tx = sqrt(x);\n\tx = sqrt(x);\n\tx = sqrt(x);\n\tcol = vec3(.2 + .75*x);\n\tcol.b *= 0.95;\n\treturn col;\n}\n",body:"vec3 color;\n\tfloat brickW = 1.0 / u_tilesHeightNumber;\n\tfloat brickH = 1.0 / u_tilesWidthNumber;\n\tfloat jointWPercentage = 0.01;\n\tfloat jointHPercentage = 0.01;\n\tfloat yi = v_texCoord.y / brickH;\n\tfloat nyi = round(yi);\n\tfloat xi = v_texCoord.x / brickW;\n\n\tif (mod(floor(yi), 2.0) == 0.0){\n\t\txi = xi - 0.5;\n\t}\n\n\tfloat nxi = round(xi);\n\tvec2 brickv_texCoord = vec2((xi - floor(xi)) / brickH, (yi - floor(yi)) / brickW);\n\n\tif (yi < nyi + jointHPercentage && yi > nyi - jointHPercentage){\n\t\tcolor = mix(u_jointColor, vec3(0.37, 0.25, 0.25), (yi - nyi) / jointHPercentage + 0.2);\n\t}\n\telse if (xi < nxi + jointWPercentage && xi > nxi - jointWPercentage){\n\t\tcolor = mix(u_jointColor, vec3(0.44, 0.44, 0.44), (xi - nxi) / jointWPercentage + 0.2);\n\t}\n\telse {\n\t\tfloat t = 6.28 * brickv_texCoord.x / (TILE_SIZE.x + noise(vec2(v_texCoord)*6.0));\n\t\tt += u_amplitude * turbulence(brickv_texCoord.xy);\n\t\tt = sin(t);\n\t\tcolor = marble_color(t);\n\t}\n\n\tgl_FragColor = vec4(color, 1.0);\n"},ShaderChunk.road_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"float ratioy = mod(gl_FragCoord.y * 100.0 , fbm(v_texCoord * 2.0));\n\tvec3 color = u_roadColor * ratioy;\n\n\tgl_FragColor = vec4(color, 1.0);\n"},ShaderChunk.wood_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"float ratioy = mod(v_texCoord.x * u_ampScale, 2.0 + fbm(v_texCoord * 0.8));\n\tvec3 wood = u_woodColor * ratioy;\n\n\tgl_FragColor = vec4(wood, 1.0);\n"},ShaderChunk}();wd.ShaderChunk=ShaderChunk}(wd||(wd={}));var wd;!function(wd){var ShaderSnippet=function(){function ShaderSnippet(){}return ShaderSnippet.main_begin="void main(void){\n",ShaderSnippet.main_end="}\n",ShaderSnippet.setPos_mvp="gl_Position = u_pMatrix * u_vMatrix * mMatrix * vec4(a_position, 1.0);\n",ShaderSnippet}();wd.ShaderSnippet=ShaderSnippet}(wd||(wd={}));var wd;!function(wd){var Material=function(){function Material(){this._blendType=null,this._blendSrc=wd.EBlendFunc.ONE,this._blendDst=wd.EBlendFunc.ZERO,this._blendEquation=wd.EBlendEquation.ADD,this._color=wd.Color.create("#ffffff"),this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this.polygonOffsetMode=wd.EPolygonOffsetMode.NONE,this.side=wd.ESide.FRONT,this.blend=!1,this.blendFuncSeparate=null,this.blendEquationSeparate=[wd.EBlendEquation.ADD,wd.EBlendEquation.ADD],this.shading=wd.EShading.FLAT,this.geometry=null,this._shaderManager=wd.ShaderManager.create(this)}return Object.defineProperty(Material.prototype,"program",{get:function(){return this.shader.program},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"blendType",{get:function(){return this._blendType},set:function(blendType){if(null!==blendType){switch(blendType){case wd.EBlendType.NONE:this.blend=!1,this.blendSrc=wd.EBlendFunc.ONE,this.blendDst=wd.EBlendFunc.ZERO,this.blendEquation=wd.EBlendEquation.ADD;break;case wd.EBlendType.NORMAL:this.blend=!0,this.blendSrc=wd.EBlendFunc.SRC_ALPHA,this.blendDst=wd.EBlendFunc.ONE_MINUS_SRC_ALPHA,this.blendEquation=wd.EBlendEquation.ADD;break;case wd.EBlendType.PREMULTIPLIED:this.blend=!0,this.blendSrc=wd.EBlendFunc.ONE,this.blendDst=wd.EBlendFunc.ONE_MINUS_SRC_ALPHA,this.blendEquation=wd.EBlendEquation.ADD;break;case wd.EBlendType.ADDITIVE:this.blend=!0,this.blendSrc=wd.EBlendFunc.ONE,this.blendDst=wd.EBlendFunc.ONE,this.blendEquation=wd.EBlendEquation.ADD;break;case wd.EBlendType.ADDITIVEALPHA:this.blend=!0,this.blendSrc=wd.EBlendFunc.SRC_ALPHA,this.blendDst=wd.EBlendFunc.ONE,this.blendEquation=wd.EBlendEquation.ADD;break;case wd.EBlendType.MULTIPLICATIVE:this.blend=!0,this.blendSrc=wd.EBlendFunc.DST_COLOR,this.blendDst=wd.EBlendFunc.ZERO,this.blendEquation=wd.EBlendEquation.ADD;break;default:wd.Log.error(!0,wd.Log.info.FUNC_INVALID("blendType"))}this._blendType=blendType}},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"envMap",{get:function(){return this.mapManager.getEnvMap()},set:function(envMap){this.mapManager.setEnvMap(envMap)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"blendSrc",{get:function(){return this._blendSrc},set:function(blendSrc){this._blendSrc!==blendSrc&&(this._blendSrc=blendSrc,this.blendFuncSeparate=null)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"blendDst",{get:function(){return this._blendDst},set:function(blendDst){this._blendDst!==blendDst&&(this._blendDst=blendDst,this.blendFuncSeparate=null)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"blendEquation",{get:function(){return this._blendEquation},set:function(blendEquation){this._blendEquation!==blendEquation&&(this._blendEquation=blendEquation,this.blendEquationSeparate=null)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"color",{get:function(){return this._color},set:function(color){this._color.isEqual(color)||(this.geometry&&this.geometry.entityObject&&wd.EventManager.trigger(this.geometry.entityObject,wd.CustomEvent.create(wd.EEngineEvent.MATERIAL_COLOR_CHANGE)),this._color=color)},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"mapManager",{get:function(){return this._shaderManager.mapManager},enumerable:!0,configurable:!0}),Object.defineProperty(Material.prototype,"shader",{get:function(){return this._shaderManager.shader},enumerable:!0,configurable:!0}),Material.prototype.clone=function(){return wd.CloneUtils.clone(this)},Material.prototype.initWhenCreate=function(){this._shaderManager.setShader(this.createShader())},Material.prototype.init=function(){this._shaderManager.init()},Material.prototype.dispose=function(){this._shaderManager.dispose()},Material.prototype.updateShader=function(quadCmd){this._shaderManager.update(quadCmd)},Material.prototype.addShader=function(shaderKey,shader){this._shaderManager.addShader(shaderKey,shader)},Material.prototype.hasShader=function(shaderKey){return this._shaderManager.hasShader(shaderKey)},Material.prototype.getShader=function(shaderKey){return this._shaderManager.getShader(shaderKey)},Material.prototype.hasMap=function(map){return this.mapManager.hasMap(map)},__decorate([wd.cloneAttributeAsBasicType({order:1})],Material.prototype,"blendType",null),__decorate([wd.cloneAttributeAsCloneable()],Material.prototype,"envMap",null),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"blendSrc",null),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"blendDst",null),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"blendEquation",null),__decorate([wd.cloneAttributeAsCloneable()],Material.prototype,"color",null),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"redWrite",void 0),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"greenWrite",void 0),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"blueWrite",void 0),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"alphaWrite",void 0),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"polygonOffsetMode",void 0),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"side",void 0),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"blend",void 0),__decorate([wd.cloneAttributeAsBasicType({order:-1})],Material.prototype,"blendFuncSeparate",void 0),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"blendEquationSeparate",void 0),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"shading",void 0),__decorate([wd.cloneAttributeAsBasicType()],Material.prototype,"geometry",void 0),Material}();wd.Material=Material}(wd||(wd={}));var wd;!function(wd){var EngineMaterial=function(_super){function EngineMaterial(){_super.apply(this,arguments),this.refractionRatio=0,this.reflectivity=null,this.mapCombineMode=wd.ETextureCombineMode.MIX,this.mapMixRatio=.5}return __extends(EngineMaterial,_super),EngineMaterial.prototype.init=function(){this._addTopShaderLib(),this.addShaderLib(),this._addEndShaderLib(),_super.prototype.init.call(this)},EngineMaterial.prototype.addShaderLib=function(){},EngineMaterial.prototype.addNormalShaderLib=function(){wd.GlobalGeometryUtils.hasAnimation(this.geometry)&&!this.shader.hasLib(wd.NormalMorphShaderLib)?this._addShaderLibToTop(wd.NormalMorphShaderLib.create()):this.shader.hasLib(wd.NormalCommonShaderLib)||this._addShaderLibToTop(wd.NormalCommonShaderLib.create())},EngineMaterial.prototype.setBlendByOpacity=function(opacity){opacity<1&&opacity>=0?this.blend=!0:this.blend=!1},EngineMaterial.prototype.createShader=function(){return wd.CommonShader.create()},EngineMaterial.prototype._addTopShaderLib=function(){this.shader.addLib(wd.CommonShaderLib.create()),wd.InstanceUtils.addModelMatrixShaderLib(this.shader,this.geometry.entityObject),wd.GlobalGeometryUtils.hasAnimation(this.geometry)?(this.shader.addLib(wd.CommonMorphShaderLib.create()),this.shader.addLib(wd.VerticeMorphShaderLib.create())):this.shader.addLib(wd.VerticeCommonShaderLib.create())},EngineMaterial.prototype._addShaderLibToTop=function(lib){this.shader.addShaderLibToTop(lib)},EngineMaterial.prototype._addEndShaderLib=function(){this.shader.addLib(wd.EndShaderLib.create())},__decorate([wd.cloneAttributeAsBasicType()],EngineMaterial.prototype,"refractionRatio",void 0),__decorate([wd.cloneAttributeAsBasicType()],EngineMaterial.prototype,"reflectivity",void 0),__decorate([wd.cloneAttributeAsBasicType()],EngineMaterial.prototype,"mapCombineMode",void 0),__decorate([wd.cloneAttributeAsBasicType()],EngineMaterial.prototype,"mapMixRatio",void 0),__decorate([wd.virtual],EngineMaterial.prototype,"addShaderLib",null),EngineMaterial}(wd.Material);wd.EngineMaterial=EngineMaterial}(wd||(wd={}));var wd;!function(wd){var StandardLightMaterial=function(_super){function StandardLightMaterial(){_super.apply(this,arguments),this._lightMap=null,this._diffuseMap=null,this._specularMap=null,this._emissionMap=null,this._normalMap=null,this._shininess=32,this._opacity=1,this.lightModel=wd.ELightModel.PHONG,this.specularColor=wd.Color.create("#ffffff"),this.emissionColor=wd.Color.create("rgba(0,0,0,0)"),this.lightMapIntensity=1}return __extends(StandardLightMaterial,_super),Object.defineProperty(StandardLightMaterial.prototype,"lightMap",{get:function(){return this._lightMap},set:function(lightMap){this.mapManager.addMap(lightMap,{samplerVariableName:wd.VariableNameTable.getVariableName("lightMap")}),this._lightMap=lightMap},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"diffuseMap",{get:function(){return this._diffuseMap},set:function(diffuseMap){this.mapManager.addMap(diffuseMap,{samplerVariableName:wd.VariableNameTable.getVariableName("diffuseMap")}),this._diffuseMap=diffuseMap},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"specularMap",{get:function(){return this._specularMap},set:function(specularMap){this.mapManager.addMap(specularMap,{samplerVariableName:wd.VariableNameTable.getVariableName("specularMap")}),this._specularMap=specularMap},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"emissionMap",{get:function(){return this._emissionMap},set:function(emissionMap){this.mapManager.addMap(emissionMap,{samplerVariableName:wd.VariableNameTable.getVariableName("emissionMap")}),this._emissionMap=emissionMap},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"normalMap",{get:function(){return this._normalMap},set:function(normalMap){this.mapManager.addMap(normalMap,{samplerVariableName:wd.VariableNameTable.getVariableName("normalMap")}),this._normalMap=normalMap},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"shininess",{get:function(){return Number(this._shininess)<=0?32:this._shininess},set:function(shininess){this._shininess=shininess},enumerable:!0,configurable:!0}),Object.defineProperty(StandardLightMaterial.prototype,"opacity",{get:function(){return this._opacity},set:function(opacity){this.setBlendByOpacity(opacity),this._opacity=opacity},enumerable:!0,configurable:!0}),StandardLightMaterial.prototype.addExtendShaderLib=function(){},StandardLightMaterial.prototype.addEndShaderLib=function(){},StandardLightMaterial.prototype.addShaderLib=function(){var envMap=null;wd.InstanceUtils.addNormalModelMatrixShaderLib(this.shader,this.geometry.entityObject),this.addNormalShaderLib(),this.shader.addLib(wd.LightCommonShaderLib.create()),this._setLightMapShaderLib(),this.shader.addLib(wd.LightShaderLib.create()),envMap=this.envMap,envMap&&this._setEnvMapShaderLib(envMap),this.addExtendShaderLib(),this.shader.addLib(wd.LightEndShaderLib.create()),this.addEndShaderLib()},StandardLightMaterial.prototype._setLightMapShaderLib=function(){var scene=wd.Director.getInstance().scene;if(this.shader.addLib(wd.CommonLightMapShaderLib.create()),this._lightMap?this.shader.addLib(wd.LightMapShaderLib.create()):this.shader.addLib(wd.NoLightMapShaderLib.create()),this._diffuseMap?this.shader.addLib(wd.DiffuseMapShaderLib.create()):this.shader.addLib(wd.NoDiffuseMapShaderLib.create()),this._specularMap?this.shader.addLib(wd.SpecularMapShaderLib.create()):this.shader.addLib(wd.NoSpecularMapShaderLib.create()),this._emissionMap?this.shader.addLib(wd.EmissionMapShaderLib.create()):this.shader.addLib(wd.NoEmissionMapShaderLib.create()),this._normalMap?this.shader.addLib(wd.NormalMapShaderLib.create()):this.shader.addLib(wd.NoNormalMapShaderLib.create()),scene.shadowMap.enable){var hasTwoD=!1,hasCubemap=!1;this._hasTwoDShadowMap()&&(hasTwoD=!0,this.shader.addLib(wd.TwoDShadowMapShaderLib.create())),this._hasCubemapShadowMap()&&(hasCubemap=!0,this.shader.addLib(wd.CubemapShadowMapShaderLib.create())),hasTwoD||hasCubemap?this.shader.addLib(wd.TotalShadowMapShaderLib.create()):this.shader.addLib(wd.NoShadowMapShaderLib.create())}else this.shader.addLib(wd.NoShadowMapShaderLib.create())},StandardLightMaterial.prototype._setEnvMapShaderLib=function(envMap){switch(this.shader.addLib(wd.CommonEnvMapShaderLib.create()),envMap.mode){case wd.EEnvMapMode.BASIC:this.shader.addLib(wd.BasicForLightEnvMapShaderLib.create());break;case wd.EEnvMapMode.REFLECTION:this.shader.addLib(wd.ReflectionForLightEnvMapShaderLib.create());break;case wd.EEnvMapMode.REFRACTION:this.shader.addLib(wd.RefractionForLightEnvMapShaderLib.create());break;case wd.EEnvMapMode.FRESNEL:this.shader.addLib(wd.FresnelForLightEnvMapShaderLib.create());break;default:wd.Log.error(!0,wd.Log.info.FUNC_INVALID("EEnvMapMode"))}},StandardLightMaterial.prototype._hasTwoDShadowMap=function(){return wd.ShadowUtils.isReceive(this.geometry.entityObject)&&this.mapManager.getTwoDShadowMapList().getCount()>0},StandardLightMaterial.prototype._hasCubemapShadowMap=function(){return wd.ShadowUtils.isReceive(this.geometry.entityObject)&&this.mapManager.getCubemapShadowMapList().getCount()>0},__decorate([wd.requireSetter(function(lightMap){wd.assert(lightMap instanceof wd.ImageTexture||lightMap instanceof wd.ProceduralTexture,wd.Log.info.FUNC_SHOULD("lightMap","be ImageTexture or ProceduralTexture"))}),wd.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"lightMap",null),__decorate([wd.requireSetter(function(diffuseMap){wd.assert(diffuseMap instanceof wd.ImageTexture||diffuseMap instanceof wd.ProceduralTexture,wd.Log.info.FUNC_SHOULD("diffuseMap","be ImageTexture or ProceduralTexture"))}),wd.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"diffuseMap",null),__decorate([wd.requireSetter(function(specularMap){wd.assert(specularMap instanceof wd.ImageTexture||specularMap instanceof wd.ProceduralTexture,wd.Log.info.FUNC_SHOULD("specularMap","be ImageTexture or ProceduralTexture"))}),wd.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"specularMap",null),__decorate([wd.requireSetter(function(emissionMap){wd.assert(emissionMap instanceof wd.ImageTexture||emissionMap instanceof wd.ProceduralTexture,wd.Log.info.FUNC_SHOULD("emissionMap","be ImageTexture or ProceduralTexture"))}),wd.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"emissionMap",null),__decorate([wd.requireSetter(function(normalMap){wd.assert(normalMap instanceof wd.ImageTexture,wd.Log.info.FUNC_SHOULD("normalMap","be ImageTexture"))}),wd.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"normalMap",null),__decorate([wd.cloneAttributeAsBasicType()],StandardLightMaterial.prototype,"shininess",null),__decorate([wd.cloneAttributeAsBasicType({order:1})],StandardLightMaterial.prototype,"opacity",null),__decorate([wd.cloneAttributeAsBasicType()],StandardLightMaterial.prototype,"lightModel",void 0),__decorate([wd.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"specularColor",void 0),__decorate([wd.cloneAttributeAsCloneable()],StandardLightMaterial.prototype,"emissionColor",void 0),__decorate([wd.cloneAttributeAsBasicType()],StandardLightMaterial.prototype,"lightMapIntensity",void 0),__decorate([wd.virtual],StandardLightMaterial.prototype,"addExtendShaderLib",null),__decorate([wd.virtual],StandardLightMaterial.prototype,"addEndShaderLib",null),StandardLightMaterial}(wd.EngineMaterial);wd.StandardLightMaterial=StandardLightMaterial}(wd||(wd={}));var wd;!function(wd){var StandardBasicMaterial=function(_super){function StandardBasicMaterial(){_super.apply(this,arguments),this._opacity=1}return __extends(StandardBasicMaterial,_super),Object.defineProperty(StandardBasicMaterial.prototype,"mapList",{get:function(){return this.mapManager.getMapList()},enumerable:!0,configurable:!0}),Object.defineProperty(StandardBasicMaterial.prototype,"map",{set:function(map){if(map instanceof wd.Texture||map instanceof wd.TextureAsset)this.mapManager.addMap(map);else for(var mapArr=arguments[0],_i=0,mapArr_3=mapArr;_i<mapArr_3.length;_i++){var m=mapArr_3[_i];this.mapManager.addMap(m)}},enumerable:!0,configurable:!0}),Object.defineProperty(StandardBasicMaterial.prototype,"opacity",{get:function(){return this._opacity},set:function(opacity){this.setBlendByOpacity(opacity),this._opacity=opacity},enumerable:!0,configurable:!0}),StandardBasicMaterial.prototype.addExtendShaderLib=function(){},StandardBasicMaterial.prototype.addShaderLib=function(){var envMap=null;this.shader.addLib(wd.BasicShaderLib.create()),this._setMapShaderLib(),envMap=this.envMap,envMap&&(wd.InstanceUtils.addNormalModelMatrixShaderLib(this.shader,this.geometry.entityObject),this._setEnvMapShaderLib(envMap)),this.addExtendShaderLib(),this.shader.addLib(wd.EndBasicShaderLib.create())},StandardBasicMaterial.prototype._setMapShaderLib=function(){var mapManager=this.mapManager,mapCount=mapManager.getMapCount();mapCount>0&&(mapCount>1?this.shader.addLib(wd.MultiMapShaderLib.create()):this.shader.addLib(wd.BasicMapShaderLib.create()))},StandardBasicMaterial.prototype._setEnvMapShaderLib=function(envMap){switch(this.addNormalShaderLib(),this.shader.addLib(wd.CommonEnvMapShaderLib.create()),envMap.mode){case wd.EEnvMapMode.BASIC:this.shader.addLib(wd.BasicForBasicEnvMapShaderLib.create());break;case wd.EEnvMapMode.REFLECTION:this.shader.addLib(wd.ReflectionForBasicEnvMapShaderLib.create());break;case wd.EEnvMapMode.REFRACTION:this.shader.addLib(wd.RefractionForBasicEnvMapShaderLib.create());break;case wd.EEnvMapMode.FRESNEL:this.shader.addLib(wd.FresnelForBasicEnvMapShaderLib.create());break;default:wd.Log.error(!0,wd.Log.info.FUNC_INVALID("EEnvMapMode"))}},__decorate([wd.ensureGetter(function(mapList){wd.assert(mapList.getCount()<=2,wdCb.Log.info.FUNC_SUPPORT("only","map.count <= 2"))}),wd.cloneAttributeAsCustomType(function(source,target,memberName){source[memberName].forEach(function(map){target.mapManager.addMap(map.clone())})})],StandardBasicMaterial.prototype,"mapList",null),__decorate([wd.requireSetter(function(map){if(map instanceof wd.Texture||map instanceof wd.TextureAsset);else{var mapArr=map;wd.assert(wd.JudgeUtils.isArrayExactly(mapArr),wd.Log.info.FUNC_MUST_BE("array")),wd.assert(mapArr.length<=2,wd.Log.info.FUNC_SUPPORT("only","map.count <= 2"))}})],StandardBasicMaterial.prototype,"map",null),__decorate([wd.cloneAttributeAsBasicType({order:1})],StandardBasicMaterial.prototype,"opacity",null),__decorate([wd.virtual],StandardBasicMaterial.prototype,"addExtendShaderLib",null),StandardBasicMaterial}(wd.EngineMaterial);wd.StandardBasicMaterial=StandardBasicMaterial}(wd||(wd={}));var wd;!function(wd){var LineMaterial=function(_super){function LineMaterial(){_super.apply(this,arguments),this._lineWidth=1}return __extends(LineMaterial,_super),LineMaterial.create=function(){var obj=new this;return obj.initWhenCreate(),obj},Object.defineProperty(LineMaterial.prototype,"lineWidth",{get:function(){return this._lineWidth},set:function(lineWidth){this._lineWidth=lineWidth},enumerable:!0,configurable:!0}),LineMaterial.prototype.getTextureForRenderSort=function(){return this.mapList.getChild(0)},__decorate([wd.cloneAttributeAsBasicType(),wd.requireSetter(function(lineWidth){wd.it("lineWidth should <= 1",function(){wd.expect(lineWidth).not.to.greaterThan(1)})}),wd.ensureGetter(function(lineWidth){wd.it("lineWidth should <= 1",function(){wd.expect(lineWidth).not.to.greaterThan(1)})})],LineMaterial.prototype,"lineWidth",null),LineMaterial}(wd.StandardBasicMaterial);wd.LineMaterial=LineMaterial}(wd||(wd={}));var wd;!function(wd){var BasicMaterial=function(_super){function BasicMaterial(){_super.apply(this,arguments)}return __extends(BasicMaterial,_super),BasicMaterial.create=function(){var obj=new this;return obj.initWhenCreate(),obj},BasicMaterial.prototype.getTextureForRenderSort=function(){return this.mapList.getChild(0)},BasicMaterial}(wd.StandardBasicMaterial);wd.BasicMaterial=BasicMaterial}(wd||(wd={}));var wd;!function(wd){var SkyboxMaterial=function(_super){function SkyboxMaterial(){_super.apply(this,arguments)}return __extends(SkyboxMaterial,_super),SkyboxMaterial.create=function(){var obj=new this;return obj.initWhenCreate(),obj},SkyboxMaterial.prototype.initWhenCreate=function(){_super.prototype.initWhenCreate.call(this),this.side=wd.ESide.BACK},SkyboxMaterial.prototype.getTextureForRenderSort=function(){return null},SkyboxMaterial.prototype.addShaderLib=function(){this.shader.addLib(wd.SkyboxShaderLib.create())},SkyboxMaterial}(wd.EngineMaterial);wd.SkyboxMaterial=SkyboxMaterial}(wd||(wd={}));var wd;!function(wd){var LightMaterial=function(_super){function LightMaterial(){_super.apply(this,arguments)}return __extends(LightMaterial,_super),LightMaterial.create=function(){var obj=new this;return obj.initWhenCreate(),obj},LightMaterial.prototype.getTextureForRenderSort=function(){return this.diffuseMap},LightMaterial}(wd.StandardLightMaterial);wd.LightMaterial=LightMaterial}(wd||(wd={}));var wd;!function(wd){var ShaderMaterial=function(_super){function ShaderMaterial(){_super.apply(this,arguments)}return __extends(ShaderMaterial,_super),ShaderMaterial.create=function(){var obj=new this;return obj.initWhenCreate(),obj},ShaderMaterial.prototype.init=function(){this.shader.addLib(wd.CustomShaderLib.create()),this.shader.addLib(wd.EndShaderLib.create()),_super.prototype.init.call(this)},ShaderMaterial.prototype.getTextureForRenderSort=function(){return null},ShaderMaterial.prototype.read=function(definitionDataId){var _this=this;this.shader.read(wd.LoaderManager.getInstance().get(definitionDataId)),this.shader.getSampler2DUniformsAfterRead().forEach(function(uniform,name){_this.mapManager.addMap(wd.LoaderManager.getInstance().get(uniform.textureId),{samplerVariableName:name})})},ShaderMaterial.prototype.createShader=function(){return wd.CustomShader.create()},__decorate([wd.ensure(function(){wd.assert(2===this.shader.getLibs().getCount()&&this.shader.hasLib(wd.CustomShaderLib),wd.Log.info.FUNC_SHOULD("only has CustomShaderLib and EndShaderLib, not has other shader libs"))})],ShaderMaterial.prototype,"init",null),ShaderMaterial}(wd.Material);wd.ShaderMaterial=ShaderMaterial}(wd||(wd={}));var wd;!function(wd){!function(EShading){EShading[EShading.FLAT=0]="FLAT",EShading[EShading.SMOOTH=1]="SMOOTH"}(wd.EShading||(wd.EShading={}));wd.EShading}(wd||(wd={}));var wd;!function(wd){var ShaderManager=function(){function ShaderManager(material){this._material=null,this._otherShaderMap=wdCb.Hash.create(),this._mainShader=null,this._material=material}return ShaderManager.create=function(material){var obj=new this(material);return obj},Object.defineProperty(ShaderManager.prototype,"shader",{get:function(){var scene=wd.Director.getInstance().scene;return scene.isUseShader?this._otherShaderMap.getChild(scene.currentShaderType):this._mainShader},enumerable:!0,configurable:!0}),Object.defineProperty(ShaderManager.prototype,"mapManager",{get:function(){return this.shader.mapManager},enumerable:!0,configurable:!0}),ShaderManager.prototype.setShader=function(shader){this._mainShader=shader,this._mainShader.mapManager.material=this._material},ShaderManager.prototype.init=function(){var material=this._material;this._otherShaderMap.forEach(function(shader){shader.init(material)}),this._mainShader.init(material)},ShaderManager.prototype.dispose=function(){this._otherShaderMap.forEach(function(shader){shader.dispose()}),this._mainShader.dispose()},ShaderManager.prototype.update=function(quadCmd){this.shader.update(quadCmd,this._material)},ShaderManager.prototype.addShader=function(shaderKey,shader){this._otherShaderMap.addChild(shaderKey,shader)},ShaderManager.prototype.hasShader=function(shaderKey){return this._otherShaderMap.hasChild(shaderKey)},ShaderManager.prototype.getShader=function(shaderKey){return this._otherShaderMap.getChild(shaderKey)},__decorate([wd.ensureGetter(function(shader){wd.assert(!!shader,wd.Log.info.FUNC_NOT_EXIST("shader"))})],ShaderManager.prototype,"shader",null),ShaderManager}();wd.ShaderManager=ShaderManager}(wd||(wd={}));var wd;!function(wd){!function(EAssetType){EAssetType[EAssetType.UNKNOW=0]="UNKNOW",EAssetType[EAssetType.FONT=1]="FONT"}(wd.EAssetType||(wd.EAssetType={}));wd.EAssetType}(wd||(wd={}));var wd;!function(wd){var Loader=function(){function Loader(){this._container=wdCb.Hash.create()}return Loader.prototype.load=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var url=args[0],id=null,self=this,data=null,stream=null;return id=1===args.length?wd.JudgeUtils.isArrayExactly(url)?url.join("-"):url:args[1],data=this._container.getChild(id),stream=data?wdFrp.just(data):this.loadAsset(url,id).do(function(data){self._container.addChild(id,data),wd.LoaderManager.getInstance().add(id,self)},function(err){self._errorHandle(url,err)},null)},Loader.prototype.get=function(id){return this._container.getChild(id)},Loader.prototype.has=function(id){return this._container.hasChild(id)},Loader.prototype.dispose=function(){this._container.removeAllChildren()},Loader.prototype._errorHandle=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var path=null,err=null;path=wd.JudgeUtils.isArrayExactly(args[0])?args[0].join(","):args[0],err=args[1],wd.Log.log("load "+path+" asset fail:"+err)},Loader}();wd.Loader=Loader}(wd||(wd={}));var wd;!function(wd){var GLSLLoader=function(_super){function GLSLLoader(){_super.apply(this,arguments)}return __extends(GLSLLoader,_super),GLSLLoader.getInstance=function(){},GLSLLoader.prototype.loadAsset=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var url=args[0];return wd.AjaxLoader.load(url,"text")},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.assert(!wd.JudgeUtils.isArrayExactly(args[0]),wd.Log.info.FUNC_MUST_BE("url","string"))})],GLSLLoader.prototype,"loadAsset",null),GLSLLoader=__decorate([wd.singleton()],GLSLLoader)}(wd.Loader);wd.GLSLLoader=GLSLLoader}(wd||(wd={}));var wd;!function(wd){var JsLoader=function(_super){function JsLoader(){_super.apply(this,arguments)}return __extends(JsLoader,_super),JsLoader.getInstance=function(){},JsLoader.prototype.loadAsset=function(){for(var _this=this,args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var self=this,url=args[0];return wdFrp.fromPromise(new RSVP.Promise(function(resolve,reject){var script=self._createScript();script.async=!1,script.addEventListener("error",function(e){reject("load js file error. url:"+url)}),script.readyState?script.onreadystatechange=function(){"loaded"!==script.readyState&&"complete"!==script.readyState||(script.onreadystatechange=null,resolve(url))}:script.onload=function(){resolve(url)},script.src=url,_this._appendScript(script)}))},JsLoader.prototype._createScript=function(){var script=document.createElement("script");return script.type="text/javascript",script},JsLoader.prototype._appendScript=function(script){document.getElementsByTagName("head")[0].appendChild(script)},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.assert(!wd.JudgeUtils.isArrayExactly(args[0]),wd.Log.info.FUNC_MUST_BE("url","string"))})],JsLoader.prototype,"loadAsset",null),JsLoader=__decorate([wd.singleton()],JsLoader)}(wd.Loader);wd.JsLoader=JsLoader}(wd||(wd={}));var wd;!function(wd){var JSONLoader=function(_super){function JSONLoader(){_super.apply(this,arguments)}return __extends(JSONLoader,_super),JSONLoader.getInstance=function(){},JSONLoader.prototype.loadAsset=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var url=args[0];return wd.AjaxLoader.load(url,"json")},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.assert(!wd.JudgeUtils.isArrayExactly(args[0]),wd.Log.info.FUNC_MUST_BE("url","string"))})],JSONLoader.prototype,"loadAsset",null),JSONLoader=__decorate([wd.singleton()],JSONLoader)}(wd.Loader);wd.JSONLoader=JSONLoader}(wd||(wd={}));var wd;!function(wd){var VideoLoader=function(_super){function VideoLoader(){_super.apply(this,arguments)}return __extends(VideoLoader,_super),VideoLoader.getInstance=function(){},VideoLoader.prototype.loadAsset=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var urlArr=null;return urlArr=wd.JudgeUtils.isString(args[0])?[args[0]]:args[0],wdFrp.fromPromise(new RSVP.Promise(function(resolve,reject){wd.Video.create({urlArr:urlArr,onLoad:function(video){resolve(wd.VideoTextureAsset.create(video))},onError:function(err){reject(err)}})}))},VideoLoader=__decorate([wd.singleton()],VideoLoader)}(wd.Loader);wd.VideoLoader=VideoLoader}(wd||(wd={}));var wd;!function(wd){var TextureLoader=function(_super){function TextureLoader(){_super.apply(this,arguments)}return __extends(TextureLoader,_super),TextureLoader.getInstance=function(){},TextureLoader.prototype.loadAsset=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var extname=null,stream=null,url=args[0];switch(extname=wdCb.PathUtils.extname(url).toLowerCase()){case".jpg":case".jpeg":case".gif":case".bmp":stream=wd.ImageLoader.load(url).map(function(image){var asset=wd.ImageTextureAsset.create(image);return asset.format=wd.ETextureFormat.RGB,asset});break;case".png":stream=wd.ImageLoader.load(url).map(function(image){return wd.ImageTextureAsset.create(image)});break;case".dds":stream=wd.CompressedTextureLoader.load(url);break;default:wd.Log.error(!0,wd.Log.info.FUNC_NOT_SUPPORT(extname))}return stream},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.assert(!wd.JudgeUtils.isArrayExactly(args[0]),wd.Log.info.FUNC_MUST_BE("url","string"));
})],TextureLoader.prototype,"loadAsset",null),TextureLoader=__decorate([wd.singleton()],TextureLoader)}(wd.Loader);wd.TextureLoader=TextureLoader}(wd||(wd={}));var wd;!function(wd){var ImageLoader=function(){function ImageLoader(){}return ImageLoader.load=function(url){return wdFrp.fromPromise(new RSVP.Promise(function(resolve,reject){var img=null;img=new wd.root.Image,img.onload=function(){this.onload=null,resolve(img)},img.onerror=function(){reject("error")},img.src=url}))},ImageLoader}();wd.ImageLoader=ImageLoader}(wd||(wd={}));var wd;!function(wd){var AjaxLoader=function(){function AjaxLoader(){}return AjaxLoader.load=function(url,dataType){return wdFrp.fromPromise(new RSVP.Promise(function(resolve,reject){wdCb.AjaxUtils.ajax({type:"get",url:url,contentType:"text/plain; charset=utf-8",dataType:dataType,success:function(data){resolve(data)},error:function(XMLHttpRequest,errorThrown){reject("url:"+url+"\nreadyState:"+XMLHttpRequest.readyState+"\nstatus:"+XMLHttpRequest.status+"\nmessage:"+errorThrown.message+"\nresponseText:"+XMLHttpRequest.responseText)}})}))},AjaxLoader}();wd.AjaxLoader=AjaxLoader}(wd||(wd={}));var wd;!function(wd){var ModelLoaderUtils=function(){function ModelLoaderUtils(){}return ModelLoaderUtils.getPath=function(filePath,mapUrl){return wdCb.PathUtils.dirname(filePath)+"/"+mapUrl},ModelLoaderUtils}();wd.ModelLoaderUtils=ModelLoaderUtils}(wd||(wd={}));var wd;!function(wd){var CompressedTextureLoader=function(){function CompressedTextureLoader(){}return CompressedTextureLoader.load=function(url){var _this=this;return wd.AjaxLoader.load(url,"arraybuffer").map(function(data){var texDatas=wd.DDSParser.parse(data,!0),asset=wd.CompressedTextureAsset.create();return asset.width=texDatas.width,asset.height=texDatas.height,asset.mipmaps=texDatas.mipmaps,1==texDatas.mipmapCount&&(asset.minFilter=wd.ETextureFilterMode.LINEAR),asset.format=_this._getCompressedFormat(texDatas.format),asset})},CompressedTextureLoader._getCompressedFormat=function(format){var extension=wd.GPUDetector.getInstance().extensionCompressedTextureS3TC;if(format===wd.ETextureFormat.RGBA)return format;if(!extension)return null;switch(format){case wd.ETextureFormat.RGB_S3TC_DXT1:format=extension.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case wd.ETextureFormat.RGBA_S3TC_DXT1:format=extension.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case wd.ETextureFormat.RGBA_S3TC_DXT3:format=extension.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case wd.ETextureFormat.RGBA_S3TC_DXT5:format=extension.COMPRESSED_RGBA_S3TC_DXT5_EXT}return format},CompressedTextureLoader}();wd.CompressedTextureLoader=CompressedTextureLoader}(wd||(wd={}));var wd;!function(wd){var DDS_MAGIC=542327876,DDSD_MIPMAPCOUNT=131072,DDSCAPS2_CUBEMAP=512,DDPF_FOURCC=4,DDSParser=function(){function DDSParser(){}return DDSParser.parse=function(buffer,loadMipmaps){void 0===loadMipmaps&&(loadMipmaps=!0);var dds=new DDSData,FOURCC_DXT1=this._fourCCToInt32("DXT1"),FOURCC_DXT3=this._fourCCToInt32("DXT3"),FOURCC_DXT5=this._fourCCToInt32("DXT5"),headerLengthInt=31,off_magic=0,off_size=1,off_flags=2,off_height=3,off_width=4,off_mipmapCount=7,off_pfFlags=20,off_pfFourCC=21,off_RGBBitCount=22,off_RBitMask=23,off_GBitMask=24,off_BBitMask=25,off_ABitMask=26,off_caps2=28,header=new Int32Array(buffer,0,headerLengthInt),blockBytes=null,fourCC=null,isRGBAUncompressed=null,dataOffset=null,width=null,height=null,faces=null;if(header[off_magic]!==DDS_MAGIC)return wd.Log.error(!0,"Invalid magic number in DDS header."),dds;if(!header[off_pfFlags]&DDPF_FOURCC)return wd.Log.error(!0,"Unsupported format, must contain a FourCC code."),dds;switch(fourCC=header[off_pfFourCC],isRGBAUncompressed=!1,fourCC){case FOURCC_DXT1:blockBytes=8,dds.format=wd.ETextureFormat.RGB_S3TC_DXT1;break;case FOURCC_DXT3:blockBytes=16,dds.format=wd.ETextureFormat.RGBA_S3TC_DXT3;break;case FOURCC_DXT5:blockBytes=16,dds.format=wd.ETextureFormat.RGBA_S3TC_DXT5;break;default:if(!(32==header[off_RGBBitCount]&&16711680&header[off_RBitMask]&&65280&header[off_GBitMask]&&255&header[off_BBitMask]&&4278190080&header[off_ABitMask]))return wd.Log.error(!0,"Unsupported FourCC code "+this._int32ToFourCC(fourCC)),dds;isRGBAUncompressed=!0,blockBytes=64,dds.format=wd.ETextureFormat.RGBA}dds.mipmapCount=1,header[off_flags]&DDSD_MIPMAPCOUNT&&loadMipmaps!==!1&&(dds.mipmapCount=Math.max(1,header[off_mipmapCount])),dds.isCubemap=!!(header[off_caps2]&DDSCAPS2_CUBEMAP),dds.width=header[off_width],dds.height=header[off_height],dataOffset=header[off_size]+4,width=dds.width,height=dds.height,faces=dds.isCubemap?6:1;for(var face=0;face<faces;face++){for(var i=0;i<dds.mipmapCount;i++){var mipmap=null,byteArray=null,dataLength=null;isRGBAUncompressed?(byteArray=this._loadARGBMip(buffer,dataOffset,width,height),dataLength=byteArray.length):(dataLength=Math.max(4,width)/4*Math.max(4,height)/4*blockBytes,byteArray=new Uint8Array(buffer,dataOffset,dataLength)),mipmap={data:byteArray,width:width,height:height},dds.mipmaps.addChild(mipmap),dataOffset+=dataLength,width=Math.max(.5*width,1),height=Math.max(.5*height,1)}width=dds.width,height=dds.height}return dds},DDSParser._fourCCToInt32=function(value){return value.charCodeAt(0)+(value.charCodeAt(1)<<8)+(value.charCodeAt(2)<<16)+(value.charCodeAt(3)<<24)},DDSParser._int32ToFourCC=function(value){return String.fromCharCode(255&value,value>>8&255,value>>16&255,value>>24&255)},DDSParser._loadARGBMip=function(buffer,dataOffset,width,height){for(var dataLength=width*height*4,srcBuffer=new Uint8Array(buffer,dataOffset,dataLength),byteArray=new Uint8Array(dataLength),dst=0,src=0,y=0;y<height;y++)for(var x=0;x<width;x++){var b=null,g=null,r=null,a=null;b=srcBuffer[src],src++,g=srcBuffer[src],src++,r=srcBuffer[src],src++,a=srcBuffer[src],src++,byteArray[dst]=r,dst++,byteArray[dst]=g,dst++,byteArray[dst]=b,dst++,byteArray[dst]=a,dst++}return byteArray},DDSParser}();wd.DDSParser=DDSParser;var DDSData=function(){function DDSData(){this.mipmaps=wdCb.Collection.create(),this.width=0,this.height=0,this.format=null,this.mipmapCount=1,this.isCubemap=!1}return DDSData}();wd.DDSData=DDSData}(wd||(wd={}));var wd;!function(wd){var TextureAsset=function(){function TextureAsset(){this._width=null,this._height=null,this.generateMipmaps=!0,this.sourceRegionMethod=wd.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL,this.format=wd.ETextureFormat.RGBA,this.source=TextureAsset.defaultTexture,this.repeatRegion=wd.RectRegion.create(0,0,1,1),this.sourceRegion=null,this.sourceRegionMapping=wd.ETextureSourceRegionMapping.CANVAS,this.packAlignment=4,this.unpackAlignment=4,this.flipY=!0,this.premultiplyAlpha=!1,this.colorspaceConversion=wd.DeviceManager.getInstance().gl.BROWSER_DEFAULT_WEBGL,this.wrapS=wd.ETextureWrapMode.CLAMP_TO_EDGE,this.wrapT=wd.ETextureWrapMode.CLAMP_TO_EDGE,this.magFilter=wd.ETextureFilterMode.LINEAR,this.minFilter=wd.ETextureFilterMode.LINEAR_MIPMAP_LINEAR,this.type=wd.ETextureType.UNSIGNED_BYTE,this.mipmaps=wdCb.Collection.create(),this.anisotropy=0,this.needUpdate=!0}return Object.defineProperty(TextureAsset.prototype,"width",{get:function(){return null===this._width?this.source?this.source.width:null:this._width},set:function(width){this._width=width},enumerable:!0,configurable:!0}),Object.defineProperty(TextureAsset.prototype,"height",{get:function(){return null===this._height?this.source?this.source.height:null:this._height},set:function(height){this._height=height},enumerable:!0,configurable:!0}),TextureAsset.prototype.clone=function(){return wd.CloneUtils.clone(this)},TextureAsset.prototype.cloneToCubemapTexture=function(cubemapTexture){cubemapTexture.generateMipmaps=this.generateMipmaps,cubemapTexture.minFilter=this.minFilter,cubemapTexture.magFilter=this.magFilter,cubemapTexture.width=this.width,cubemapTexture.height=this.height,cubemapTexture.wrapS=this.wrapS,cubemapTexture.wrapT=this.wrapT,cubemapTexture.anisotropy=this.anisotropy,cubemapTexture.premultiplyAlpha=this.premultiplyAlpha,cubemapTexture.flipY=!1,cubemapTexture.unpackAlignment=this.unpackAlignment,cubemapTexture.packAlignment=this.packAlignment,cubemapTexture.colorspaceConversion=this.colorspaceConversion,cubemapTexture.needUpdate=this.needUpdate,cubemapTexture.mode=wd.EEnvMapMode.BASIC},TextureAsset.prototype.cloneTo=function(texture){return wd.Log.error(!texture,wd.Log.info.FUNC_MUST_DEFINE("texture")),texture.source=this.source,texture.width=this.width,texture.height=this.height,texture.mipmaps=this.mipmaps.clone(),texture.wrapS=this.wrapS,texture.wrapT=this.wrapT,texture.magFilter=this.magFilter,texture.minFilter=this.minFilter,texture.anisotropy=this.anisotropy,texture.format=this.format,texture.type=this.type,texture.repeatRegion=this.repeatRegion.clone(),texture.sourceRegion=this.sourceRegion&&this.sourceRegion.clone(),texture.sourceRegionMapping=this.sourceRegionMapping,texture.sourceRegionMethod=this.sourceRegionMethod,texture.generateMipmaps=this.generateMipmaps,texture.premultiplyAlpha=this.premultiplyAlpha,texture.flipY=this.flipY,texture.unpackAlignment=this.unpackAlignment,texture.packAlignment=this.packAlignment,texture.colorspaceConversion=this.colorspaceConversion,texture.needUpdate=this.needUpdate,texture},TextureAsset.defaultTexture=null,__decorate([wd.cloneAttributeAsBasicType()],TextureAsset.prototype,"source",void 0),TextureAsset}();wd.TextureAsset=TextureAsset}(wd||(wd={}));var wd;!function(wd){var ImageTextureAsset=function(_super){function ImageTextureAsset(source){_super.call(this),this.source=source}return __extends(ImageTextureAsset,_super),ImageTextureAsset.create=function(source){var obj=new this(source);return obj},ImageTextureAsset.prototype.toTexture=function(){return wd.ImageTexture.create(this)},ImageTextureAsset.prototype.toCubemapFaceTexture=function(){return wd.CubemapFaceImageTexture.create(this)},ImageTextureAsset.prototype.cloneToCubemapFaceTexture=function(cubemapFaceTexture){cubemapFaceTexture.source=this.source,cubemapFaceTexture.type=this.type,cubemapFaceTexture.format=this.format,cubemapFaceTexture.width=this.width,cubemapFaceTexture.height=this.height,cubemapFaceTexture.sourceRegion=this.sourceRegion,cubemapFaceTexture.sourceRegionMethod=wd.ETextureSourceRegionMethod.DRAW_IN_CANVAS},ImageTextureAsset}(wd.TextureAsset);wd.ImageTextureAsset=ImageTextureAsset}(wd||(wd={}));var wd;!function(wd){var VideoTextureAsset=function(_super){function VideoTextureAsset(video){_super.call(this),this.video=null,this.video=video,this.source=this.video.source}return __extends(VideoTextureAsset,_super),VideoTextureAsset.create=function(video){var obj=new this(video);return obj.initWhenCreate(),obj},VideoTextureAsset.prototype.initWhenCreate=function(){this.width=0,this.height=0,this.generateMipmaps=!1,this.minFilter=null,this.magFilter=null,this.sourceRegion=null,this.sourceRegionMethod=null},VideoTextureAsset.prototype.toTexture=function(){return wd.VideoTexture.create(this)},VideoTextureAsset.prototype.toCubemapFaceTexture=function(){return wd.Log.error(!0,wd.Log.info.FUNC_NOT_SUPPORT("video texture","cubemap"))},VideoTextureAsset.prototype.cloneToCubemapFaceTexture=function(cubemapFaceTexture){wd.Log.error(!0,wd.Log.info.FUNC_NOT_SUPPORT("video texture","cubemap"))},VideoTextureAsset}(wd.TextureAsset);wd.VideoTextureAsset=VideoTextureAsset}(wd||(wd={}));var wd;!function(wd){var CompressedTextureAsset=function(_super){function CompressedTextureAsset(){_super.apply(this,arguments)}return __extends(CompressedTextureAsset,_super),CompressedTextureAsset.create=function(){var obj=new this;return obj.initWhenCreate(),obj},CompressedTextureAsset.prototype.initWhenCreate=function(){this.generateMipmaps=!1,this.flipY=!1},CompressedTextureAsset.prototype.toTexture=function(){return wd.CompressedTexture.create(this)},CompressedTextureAsset.prototype.toCubemapFaceTexture=function(){return wd.CubemapFaceCompressedTexture.create(this)},CompressedTextureAsset.prototype.cloneToCubemapFaceTexture=function(cubemapFaceTexture){cubemapFaceTexture.type=this.type,cubemapFaceTexture.format=this.format,cubemapFaceTexture.width=this.width,cubemapFaceTexture.height=this.height,cubemapFaceTexture.mipmaps=this.mipmaps,cubemapFaceTexture.minFilter=this.minFilter},CompressedTextureAsset}(wd.TextureAsset);wd.CompressedTextureAsset=CompressedTextureAsset}(wd||(wd={}));var wd;!function(wd){!function(ETextureFilterMode){ETextureFilterMode[ETextureFilterMode.NEAREST="NEAREST"]="NEAREST",ETextureFilterMode[ETextureFilterMode.NEAREST_MIPMAP_MEAREST="NEAREST_MIPMAP_MEAREST"]="NEAREST_MIPMAP_MEAREST",ETextureFilterMode[ETextureFilterMode.NEAREST_MIPMAP_LINEAR="NEAREST_MIPMAP_LINEAR"]="NEAREST_MIPMAP_LINEAR",ETextureFilterMode[ETextureFilterMode.LINEAR="LINEAR"]="LINEAR",ETextureFilterMode[ETextureFilterMode.LINEAR_MIPMAP_NEAREST="LINEAR_MIPMAP_NEAREST"]="LINEAR_MIPMAP_NEAREST",ETextureFilterMode[ETextureFilterMode.LINEAR_MIPMAP_LINEAR="LINEAR_MIPMAP_LINEAR"]="LINEAR_MIPMAP_LINEAR"}(wd.ETextureFilterMode||(wd.ETextureFilterMode={}));wd.ETextureFilterMode}(wd||(wd={}));var wd;!function(wd){!function(ETextureWrapMode){ETextureWrapMode[ETextureWrapMode.REPEAT="REPEAT"]="REPEAT",ETextureWrapMode[ETextureWrapMode.MIRRORED_REPEAT="MIRRORED_REPEAT"]="MIRRORED_REPEAT",ETextureWrapMode[ETextureWrapMode.CLAMP_TO_EDGE="CLAMP_TO_EDGE"]="CLAMP_TO_EDGE"}(wd.ETextureWrapMode||(wd.ETextureWrapMode={}));wd.ETextureWrapMode}(wd||(wd={}));var wd;!function(wd){!function(ETextureFormat){ETextureFormat[ETextureFormat.RGB="RGB"]="RGB",ETextureFormat[ETextureFormat.RGBA="RGBA"]="RGBA",ETextureFormat[ETextureFormat.ALPHA="ALPHA"]="ALPHA",ETextureFormat[ETextureFormat.LUMINANCE="LUMINANCE"]="LUMINANCE",ETextureFormat[ETextureFormat.LUMINANCE_ALPHA="LUMINANCE_ALPHA"]="LUMINANCE_ALPHA",ETextureFormat[ETextureFormat.RGB_S3TC_DXT1="RGB_S3TC_DXT1"]="RGB_S3TC_DXT1",ETextureFormat[ETextureFormat.RGBA_S3TC_DXT1="RGBA_S3TC_DXT1"]="RGBA_S3TC_DXT1",ETextureFormat[ETextureFormat.RGBA_S3TC_DXT3="RGBA_S3TC_DXT3"]="RGBA_S3TC_DXT3",ETextureFormat[ETextureFormat.RGBA_S3TC_DXT5="RGBA_S3TC_DXT5"]="RGBA_S3TC_DXT5"}(wd.ETextureFormat||(wd.ETextureFormat={}));wd.ETextureFormat}(wd||(wd={}));var wd;!function(wd){!function(ETextureType){ETextureType[ETextureType.UNSIGNED_BYTE="UNSIGNED_BYTE"]="UNSIGNED_BYTE",ETextureType[ETextureType.UNSIGNED_SHORT_5_6_5="UNSIGNED_SHORT_5_6_5"]="UNSIGNED_SHORT_5_6_5",ETextureType[ETextureType.UNSIGNED_SHORT_4_4_4_4="UNSIGNED_SHORT_4_4_4_4"]="UNSIGNED_SHORT_4_4_4_4",ETextureType[ETextureType.UNSIGNED_SHORT_5_5_5_1="UNSIGNED_SHORT_5_5_5_1"]="UNSIGNED_SHORT_5_5_5_1"}(wd.ETextureType||(wd.ETextureType={}));wd.ETextureType}(wd||(wd={}));var wd;!function(wd){!function(EEnvMapMode){EEnvMapMode[EEnvMapMode.BASIC=0]="BASIC",EEnvMapMode[EEnvMapMode.REFLECTION=1]="REFLECTION",EEnvMapMode[EEnvMapMode.REFRACTION=2]="REFRACTION",EEnvMapMode[EEnvMapMode.FRESNEL=3]="FRESNEL"}(wd.EEnvMapMode||(wd.EEnvMapMode={}));wd.EEnvMapMode}(wd||(wd={}));var wd;!function(wd){!function(ETextureCombineMode){ETextureCombineMode[ETextureCombineMode.MIX=0]="MIX",ETextureCombineMode[ETextureCombineMode.MULTIPLY=1]="MULTIPLY",ETextureCombineMode[ETextureCombineMode.ADD=2]="ADD"}(wd.ETextureCombineMode||(wd.ETextureCombineMode={}));wd.ETextureCombineMode}(wd||(wd={}));var wd;!function(wd){!function(ETextureSourceRegionMapping){ETextureSourceRegionMapping[ETextureSourceRegionMapping.CANVAS=0]="CANVAS",ETextureSourceRegionMapping[ETextureSourceRegionMapping.UV=1]="UV"}(wd.ETextureSourceRegionMapping||(wd.ETextureSourceRegionMapping={}));wd.ETextureSourceRegionMapping}(wd||(wd={}));var wd;!function(wd){!function(ETextureSourceRegionMethod){ETextureSourceRegionMethod[ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL=0]="CHANGE_TEXCOORDS_IN_GLSL",ETextureSourceRegionMethod[ETextureSourceRegionMethod.DRAW_IN_CANVAS=1]="DRAW_IN_CANVAS"}(wd.ETextureSourceRegionMethod||(wd.ETextureSourceRegionMethod={}));wd.ETextureSourceRegionMethod}(wd||(wd={}));var wd;!function(wd){!function(ETextureTarget){ETextureTarget[ETextureTarget.TEXTURE_2D="TEXTURE_2D"]="TEXTURE_2D",ETextureTarget[ETextureTarget.TEXTURE_CUBE_MAP="TEXTURE_CUBE_MAP"]="TEXTURE_CUBE_MAP"}(wd.ETextureTarget||(wd.ETextureTarget={}));wd.ETextureTarget}(wd||(wd={}));var wd;!function(wd){var LoaderManager=function(){function LoaderManager(){this.assetCount=0,this.currentLoadedCount=0,this._assetTable=wdCb.Hash.create()}return LoaderManager.getInstance=function(){},LoaderManager.prototype.load=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var self=this;if(wd.JudgeUtils.isString(args[0])){var url=args[0],id=url;return this._createLoadSingleAssetStream(url,id)}var assetArr=args[0];return wdFrp.fromArray(assetArr).concatMap(function(asset){return self._createLoadMultiAssetStream(asset.type||wd.EAssetType.UNKNOW,asset.url,asset.id)})},LoaderManager.prototype.reset=function(){this.assetCount=0,this.currentLoadedCount=0},LoaderManager.prototype.dispose=function(){this.reset(),wd.LoaderFactory.createAllLoader().forEach(function(loader){loader.dispose()})},LoaderManager.prototype.get=function(id){var loader=this._assetTable.getChild(id);return loader?loader.get(id):null},LoaderManager.prototype.add=function(id,loader){this._assetTable.addChild(id,loader)},LoaderManager.prototype._createLoadMultiAssetStream=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var type=args[0],url=args[1],id=args[2],loader=this._getLoader(type,url),self=this;return loader.has(id)||self.assetCount++,loader.load(url,id).map(function(){return self.currentLoadedCount++,{currentLoadedCount:self.currentLoadedCount,assetCount:self.assetCount}})},LoaderManager.prototype._createLoadSingleAssetStream=function(url,id){var loader=this._getLoader(wd.EAssetType.UNKNOW,url);return loader.load(url,id)},LoaderManager.prototype._getLoader=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var type=args[0],extname=null;return extname=wd.JudgeUtils.isArrayExactly(args[1])?wdCb.PathUtils.extname(args[1][0]):wdCb.PathUtils.extname(args[1]),wd.LoaderFactory.create(type,extname.toLowerCase())},LoaderManager=__decorate([wd.singleton()],LoaderManager)}();wd.LoaderManager=LoaderManager}(wd||(wd={}));var wd;!function(wd){var LoaderFactory=function(){function LoaderFactory(){}return LoaderFactory.create=function(type,extname){var loader=null;switch(type){case wd.EAssetType.FONT:loader=wd.FontLoader.getInstance();break;case wd.EAssetType.UNKNOW:loader=this._getLoaderByExtname(extname);break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("asset type:"+type))}return loader},LoaderFactory.createAllLoader=function(){return wdCb.Collection.create([wd.JsLoader.getInstance(),wd.GLSLLoader.getInstance(),wd.TextureLoader.getInstance(),wd.VideoLoader.getInstance(),wd.FontLoader.getInstance(),wd.FntLoader.getInstance()])},LoaderFactory._getLoaderByExtname=function(extname){var loader=null;switch(extname){case".json":loader=wd.JSONLoader.getInstance();break;case".js":loader=wd.JsLoader.getInstance();break;case".glsl":loader=wd.GLSLLoader.getInstance();break;case".jpg":case".jpeg":case".png":case".dds":case".gif":case".bmp":loader=wd.TextureLoader.getInstance();break;case".mp4":case".ogv":case".webm":loader=wd.VideoLoader.getInstance();break;case".gltf":loader=wd.GLTFLoader.getInstance();break;case".wd":loader=wd.WDLoader.getInstance();break;case".eot":case".ttf":case".woff":case".svg":loader=wd.FontLoader.getInstance();break;case".fnt":loader=wd.FntLoader.getInstance();break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNKNOW("extname:"+extname))}return loader},LoaderFactory}();wd.LoaderFactory=LoaderFactory}(wd||(wd={}));var wd;!function(wd){var GLTFLoader=function(_super){function GLTFLoader(){_super.apply(this,arguments),this._arrayBufferMap=wdCb.Hash.create(),this._imageMap=wdCb.Hash.create()}return __extends(GLTFLoader,_super),GLTFLoader.getInstance=function(){},GLTFLoader.prototype.loadAsset=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var url=args[0],self=this,jsonData=null;return wd.AjaxLoader.load(url,"json").flatMap(function(json){return jsonData=json,self._createLoadAllAssetsStream(url,json)}).lastOrDefault().map(function(){return wd.GLTFAssembler.create().build(wd.GLTFParser.create().parse(jsonData,self._arrayBufferMap,self._imageMap))})},GLTFLoader.prototype._createLoadAllAssetsStream=function(url,json){return wdFrp.fromArray([this._createLoadBuffersStream(url,json),this._createLoadImageAssetStream(url,json)]).mergeAll()},GLTFLoader.prototype._createLoadBuffersStream=function(filePath,json){var arrayBufferMap=this._arrayBufferMap;return this._createLoadAssetStream(filePath,json,json.buffers,arrayBufferMap,function(id,url){return wd.AjaxLoader.load(url,"arraybuffer").do(function(buffer){wd.Log.error(!(buffer instanceof ArrayBuffer),wd.Log.info.FUNC_SHOULD("Buffer:"+id,"be an array buffer")),wd.Log.error(buffer.byteLength!==buffer.byteLength,wd.Log.info.FUNC_SHOULD("Buffer:"+id+"'s length is "+buffer.byteLength+", but it","be "+buffer.byteLength)),arrayBufferMap.addChild(id,buffer)})})},GLTFLoader.prototype._createLoadImageAssetStream=function(filePath,json){var imageMap=this._imageMap;return this._createLoadAssetStream(filePath,json,json.images,imageMap,function(id,url){return wd.ImageLoader.load(url).do(function(image){imageMap.addChild(id,image)})})},GLTFLoader.prototype._createLoadAssetStream=function(filePath,json,datas,dataMap,loadStreamFunc){var streamArr=[];if(datas){var id=null;for(id in datas)if(datas.hasOwnProperty(id)){var data=datas[id];if(wd.GLTFUtils.isBase64(data.uri))dataMap.addChild(id,wd.GLTFUtils.decodeArrayBuffer(data.uri));else{var url=wd.ModelLoaderUtils.getPath(filePath,data.uri);streamArr.push(loadStreamFunc(id,url))}}}return wdFrp.fromArray(streamArr).mergeAll()},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.assert(!wd.JudgeUtils.isArrayExactly(args[0]),wd.Log.info.FUNC_MUST_BE("url","string"))})],GLTFLoader.prototype,"loadAsset",null),GLTFLoader=__decorate([wd.singleton()],GLTFLoader)}(wd.Loader);wd.GLTFLoader=GLTFLoader}(wd||(wd={}));var wd;!function(wd){var GLTFAssembler=function(){function GLTFAssembler(){this._result=wdCb.Hash.create()}return GLTFAssembler.create=function(){var obj=new this;return obj},GLTFAssembler.prototype.build=function(parseData){return this._buildMetadata(parseData),this._buildModels(parseData),this._result},GLTFAssembler.prototype._buildMetadata=function(parseData){var metadata=wdCb.Hash.create();for(var i in parseData.metadata)parseData.metadata.hasOwnProperty(i)&&metadata.addChild(i,parseData.metadata[i]);this._result.addChild("metadata",metadata)},GLTFAssembler.prototype._buildModels=function(parseData){var models=wdCb.Collection.create(),self=this,build=function(object){var model=wd.GameObject.create();return object.name&&(model.name=object.name),self._isModelContainer(object)&&model.addTag(wd.EWDTag.CONTAINER),self._addComponentsFromGLTF(model,object.components),model.addComponent(wd.MeshRenderer.create()),object.children&&object.children.forEach(function(child){model.addChild(build(child))}),model};parseData.objects&&(parseData.objects.forEach(function(object){models.addChild(build(object))}),this._result.addChild("models",models))},GLTFAssembler.prototype._isModelContainer=function(object){return object.isContainer},GLTFAssembler.prototype._addComponentsFromGLTF=function(model,components){var self=this;components.forEach(function(component){self._isTransform(component)?model.addComponent(self._createTransform(component)):self._isCamera(component)?model.addComponent(self._createCamera(component)):self._isLight(component)?model.addComponent(self._createLight(component)):self._isGeometry(component)?model.addComponent(self._createGeometry(component)):self._isArticulatedAnimation(component)&&model.addComponent(self._createArticulatedAnimation(component))})},GLTFAssembler.prototype._isTransform=function(component){return!!component.matrix||!!component.position},GLTFAssembler.prototype._isCamera=function(component){return!!component.camera},GLTFAssembler.prototype._isLight=function(component){return!!component.lightColor&&!!component.type},GLTFAssembler.prototype._isGeometry=function(component){return!!component.material},GLTFAssembler.prototype._isArticulatedAnimation=function(component){return wd.GLTFUtils.isIGLTFArticulatedAnimation(component)},GLTFAssembler.prototype._createTransform=function(component){var transform=wd.ThreeDTransform.create();return component.matrix?(transform.localPosition=component.matrix.getTranslation(),transform.localRotation=component.matrix.getRotation(),transform.localScale=component.matrix.getScale()):(transform.localPosition=component.position,transform.localRotation=component.rotation,transform.localScale=component.scale),transform},GLTFAssembler.prototype._createCamera=function(component){return wd.BasicCameraController.create(component.camera)},GLTFAssembler.prototype._createLight=function(component){var light=null;switch(component.type){case"ambient":light=wd.AmbientLight.create(),light.color=component.lightColor;break;case"directional":light=wd.DirectionLight.create(),light.color=component.lightColor;break;case"point":light=wd.PointLight.create(),light.color=component.lightColor,wd.GLTFUtils.addData(light,"range",component.distance),wd.GLTFUtils.addData(light,"constant",component.constantAttenuation),wd.GLTFUtils.addData(light,"linear",component.linearAttenuation),wd.GLTFUtils.addData(light,"quadratic",component.quadraticAttenuation)}return light},GLTFAssembler.prototype._createGeometry=function(component){var geometry=wd.ModelGeometry.create();return geometry.vertices=component.vertices,geometry.faces=component.faces,wd.GLTFUtils.addData(geometry,"colors",component.colors),wd.GLTFUtils.addData(geometry,"texCoords",component.texCoords),geometry.drawMode=component.drawMode,geometry.material=this._createMaterial(component.material),geometry},GLTFAssembler.prototype._createMaterial=function(materialData){var material=null;switch(materialData.type){case"BasicMaterial":material=this._createBasicMaterial(materialData);break;case"LightMaterial":material=this._createLightMaterial(materialData);break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("material type:"+materialData.type))}return material},GLTFAssembler.prototype._createBasicMaterial=function(materialData){var material=wd.BasicMaterial.create();return this._setBasicDataOfMaterial(material,materialData),material},GLTFAssembler.prototype._createLightMaterial=function(materialData){var material=wd.LightMaterial.create();return this._setBasicDataOfMaterial(material,materialData),materialData.transparent===!0&&void 0!==materialData.opacity&&(material.opacity=materialData.opacity,material.blendType=wd.EBlendType.NORMAL),materialData.lightModel===wd.ELightModel.LAMBERT?(wd.Log.log(wd.Log.info.FUNC_NOT_SUPPORT("LAMBERT light model, use PHONG light model instead")),material.lightModel=wd.ELightModel.PHONG):material.lightModel=materialData.lightModel,wd.GLTFUtils.addData(material,"color",materialData.diffuseColor),wd.GLTFUtils.addData(material,"specularColor",materialData.specularColor),wd.GLTFUtils.addData(material,"emissionColor",materialData.emissionColor),wd.GLTFUtils.addData(material,"diffuseMap",materialData.diffuseMap),wd.GLTFUtils.addData(material,"specularMap",materialData.specularMap),wd.GLTFUtils.addData(material,"emissionMap",materialData.emissionMap),wd.GLTFUtils.addData(material,"shininess",materialData.shininess),material},GLTFAssembler.prototype._setBasicDataOfMaterial=function(material,materialData){materialData.doubleSided&&materialData.doubleSided===!0?material.side=wd.ESide.BOTH:material.side=wd.ESide.FRONT},GLTFAssembler.prototype._createArticulatedAnimation=function(component){var anim=wd.ArticulatedAnimation.create();return anim.data=wdCb.Hash.create(component),anim},GLTFAssembler}();wd.GLTFAssembler=GLTFAssembler}(wd||(wd={}));var wd;!function(wd){var GLTFParser=function(){function GLTFParser(){this._data={},this._arrayBufferMap=null,this._imageMap=null,this._json=null,this._geometryParser=wd.GLTFGeometryParser.create(),this._articulatedAnimationParser=wd.GLTFArticulatedAnimationParser.create()}return GLTFParser.create=function(){var obj=new this;return obj},GLTFParser.prototype.parse=function(json,arrayBufferMap,imageMap){return this._json=json,this._arrayBufferMap=arrayBufferMap,this._imageMap=imageMap,json.asset&&this._parseMetadata(),this._parseObjects(),json.animations&&this._articulatedAnimationParser.parse(json,this._data.objects,this._arrayBufferMap),this._data},GLTFParser.prototype._parseMetadata=function(){var metadata={},json=this._json;for(var i in json.asset)json.asset.hasOwnProperty(i)&&(metadata[i]=json.asset[i]);this._data.metadata=metadata},GLTFParser.prototype._parseObjects=function(){var self=this,json=this._json,objects=wdCb.Collection.create(),parse=function(nodeId,node){var object=wd.GLTFUtils.createObjectData();if(object.id=nodeId,node.name&&(object.name=node.name),node.meshes&&node.meshes.length>0){var mesh=null;node.meshes.length>1&&wd.Log.warn(wd.Log.info.FUNC_NOT_SUPPORT("multi mesh(geometry), just use the first mesh(geometry)")),mesh=json.meshes[node.meshes[0]],!node.name&&mesh.name&&(object.name=mesh.name),self._geometryParser.parse(json,object,mesh,self._arrayBufferMap,self._imageMap)}if(node.extensions&&node.extensions.KHR_materials_common&&node.extensions.KHR_materials_common.light&&object.components.addChild(self._parseLight(node.extensions.KHR_materials_common.light)),node.camera&&object.components.addChild(self._parseCamera(node.camera)),node.matrix?object.components.addChild(self._parseTransform(node.matrix)):node.rotation&&node.scale&&node.translation&&object.components.addChild(self._parseTransform(node.translation,node.rotation,node.scale)),node.children)for(var _i=0,_a=node.children;_i<_a.length;_i++){var childId=_a[_i];object.children.addChild(parse(childId,json.nodes[childId]))}return object};if(!json.scenes[json.scene])return void(this._data.objects=objects);for(var _i=0,_a=json.scenes[json.scene].nodes;_i<_a.length;_i++){var nodeId=_a[_i];objects.addChild(parse(nodeId,json.nodes[nodeId]))}this._data.objects=objects},GLTFParser.prototype._parseLight=function(lightId){var lightData=this._json.extensions.KHR_materials_common.lights[lightId],light={};return wd.GLTFUtils.addData(light,"type",lightData.type),this._parseLightDataByType(light,lightData,light.type),light},GLTFParser.prototype._parseLightDataByType=function(light,lightData,type){var data=lightData[type];switch(type){case"ambient":case"directional":light.lightColor=wd.GLTFUtils.getColor(data.color);break;case"point":light.lightColor=wd.GLTFUtils.getColor(data.color),wd.GLTFUtils.addData(light,"distance",data.distance),wd.GLTFUtils.addData(light,"constantAttenuation",data.constantAttenuation),wd.GLTFUtils.addData(light,"linearAttenuation",data.linearAttenuation),wd.GLTFUtils.addData(light,"quadraticAttenuation",data.quadraticAttenuation)}},GLTFParser.prototype._parseCamera=function(cameraId){var cameraData=this._json.cameras[cameraId],camera={};return this._parseCameraDataByType(camera,cameraData),camera},GLTFParser.prototype._parseCameraDataByType=function(camera,cameraData){var cameraComponent=null,type=cameraData.type,data=cameraData[type];switch(type){case"perspective":if(data=cameraData[type],cameraComponent=wd.PerspectiveCamera.create(),cameraComponent.near=data.znear,cameraComponent.far=data.zfar,data.aspectRatio)cameraComponent.aspect=data.aspectRatio;else{var view=wd.DeviceManager.getInstance().view;cameraComponent.aspect=view.width/view.height}cameraComponent.fovy=data.yfov,camera.camera=cameraComponent;break;case"orthographic":cameraComponent=wd.OrthographicCamera.create(),cameraComponent.near=data.znear,cameraComponent.far=data.zfar,cameraComponent.left=-data.xmag,cameraComponent.right=data.xmag,cameraComponent.top=data.ymag,cameraComponent.bottom=-data.ymag,camera.camera=cameraComponent;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("camera type:"+type));
}},GLTFParser.prototype._parseTransform=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var transform={};if(1===args.length){var matrix=args[0];transform.matrix=wd.Matrix4.create(new Float32Array(matrix))}else if(3===args.length){var translation=args[0],rotation=args[1],scale=args[2];transform.position=wd.Vector3.create(translation[0],translation[1],translation[2]),transform.rotation=wd.Quaternion.create(rotation[0],rotation[1],rotation[2],rotation[3]),transform.scale=wd.Vector3.create(scale[0],scale[1],scale[2])}return transform},__decorate([wd.require(function(lightId){var lights=this._json.extensions.KHR_materials_common.lights;wd.assert(lights&&lights[lightId],wd.Log.info.FUNC_NOT_EXIST("lightId:"+lightId))})],GLTFParser.prototype,"_parseLight",null),__decorate([wd.require(function(cameraId){var cameras=this._json.cameras;wd.assert(cameras&&cameras[cameraId],wd.Log.info.FUNC_NOT_EXIST("cameraId:"+cameraId))})],GLTFParser.prototype,"_parseCamera",null),GLTFParser}();wd.GLTFParser=GLTFParser}(wd||(wd={}));var wd;!function(wd){var GLTFGeometryParser=function(){function GLTFGeometryParser(){this._arrayBufferMap=null,this._imageMap=null,this._json=null,this._materialParser=wd.GLTFMaterialParser.create()}return GLTFGeometryParser.create=function(){var obj=new this;return obj},GLTFGeometryParser.prototype.parse=function(json,object,mesh,arrayBufferMap,imageMap){if(this._json=json,this._arrayBufferMap=arrayBufferMap,this._imageMap=imageMap,mesh.primitives.length>1){for(var _i=0,_a=mesh.primitives;_i<_a.length;_i++){var primitive=_a[_i],childObject=wd.GLTFUtils.createObjectData();this._setChildObjectNameWithMultiPrimitives(childObject,primitive),childObject.components.addChild(this._parseGeometry(primitive)),object.children.addChild(childObject)}object.isContainer=!0}else 1===mesh.primitives.length&&object.components.addChild(this._parseGeometry(mesh.primitives[0]))},GLTFGeometryParser.prototype._setChildObjectNameWithMultiPrimitives=function(object,primitive){object.name=primitive.material},GLTFGeometryParser.prototype._parseGeometry=function(primitive){var json=this._json,arrayBufferMap=this._arrayBufferMap,accessor=null,bufferArr=null,geometry={},vertices=null,texCoords=null,colors=null,normals=null,faces=null;for(var semantic in primitive.attributes)if(primitive.attributes.hasOwnProperty(semantic)){var attribute=primitive.attributes[semantic];if(accessor=json.accessors[attribute],bufferArr=wd.GLTFUtils.getBufferArrFromAccessor(json,accessor,arrayBufferMap),"POSITION"===semantic)vertices=[],this._addGeometryData(vertices,bufferArr);else if(semantic.indexOf("TEXCOORD_")>-1)texCoords=[],this._addGeometryData(texCoords,bufferArr),this._normalizeTexCoords(texCoords);else if("NORMAL"===semantic){normals=[];for(var _i=0,bufferArr_1=bufferArr;_i<bufferArr_1.length;_i++){var data=bufferArr_1[_i];normals.push(data)}}else"COLOR"===semantic&&(colors=[],this._addGeometryData(colors,bufferArr))}return faces=this._getFaces(json,primitive.indices,normals),wd.GLTFUtils.addData(geometry,"vertices",vertices),wd.GLTFUtils.addData(geometry,"colors",colors),wd.GLTFUtils.addData(geometry,"texCoords",texCoords),wd.GLTFUtils.addData(geometry,"faces",faces),wd.GLTFUtils.addData(geometry,"drawMode",this._parseDrawMode(primitive.mode)),geometry.material=this._materialParser.parse(json,primitive.material,this._imageMap),geometry},GLTFGeometryParser.prototype._addGeometryData=function(geometryData,sourceData){for(var i=0,len=sourceData.length;i<len;i++)geometryData.push(sourceData[i])},GLTFGeometryParser.prototype._getFaces=function(json,indices,normals){var accessor=null,bufferArr=null,face=null,faces=[];if(!indices)return[];accessor=json.accessors[indices],bufferArr=wd.GLTFUtils.getBufferArrFromAccessor(json,accessor,this._arrayBufferMap);for(var i=0,len=bufferArr.length;i<len;i+=3){var aIndex=bufferArr[i],bIndex=bufferArr[i+1],cIndex=bufferArr[i+2],verticeIndiceArr=[aIndex,bIndex,cIndex];face=wd.Face3.create(aIndex,bIndex,cIndex),wd.GeometryUtils.hasData(normals)&&this._addNormalData(face.vertexNormals,normals,verticeIndiceArr),faces.push(face)}return faces},GLTFGeometryParser.prototype._addNormalData=function(targetNormals,sourceNormals,normalIndiceArr){var aIndex=normalIndiceArr[0],bIndex=normalIndiceArr[1],cIndex=normalIndiceArr[2];targetNormals.addChildren([this._getThreeComponentData(sourceNormals,aIndex),this._getThreeComponentData(sourceNormals,bIndex),this._getThreeComponentData(sourceNormals,cIndex)])},GLTFGeometryParser.prototype._getThreeComponentData=function(sourceData,index){var startIndex=3*index;return wd.Vector3.create(sourceData[startIndex],sourceData[startIndex+1],sourceData[startIndex+2])},GLTFGeometryParser.prototype._parseDrawMode=function(mode){var drawMode=null;if(!mode)return null;switch(mode){case 0:drawMode=wd.EDrawMode.POINTS;break;case 1:drawMode=wd.EDrawMode.LINES;break;case 2:drawMode=wd.EDrawMode.LINE_LOOP;break;case 3:drawMode=wd.EDrawMode.LINE_STRIP;break;case 4:drawMode=wd.EDrawMode.TRIANGLES;break;case 5:drawMode=wd.EDrawMode.TRIANGLE_STRIP;break;case 6:drawMode=wd.EDrawMode.TRANGLE_FAN;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("mode:"+mode))}return drawMode},GLTFGeometryParser.prototype._normalizeTexCoords=function(texCoords){if(texCoords)for(var i=0,len=texCoords.length/2;i<len;i++)texCoords[2*i+1]=1-texCoords[2*i+1]},__decorate([wd.require(function(json,indices,normals){var accessor=null,bufferArr=null;return indices?(accessor=json.accessors[indices],bufferArr=wd.GLTFUtils.getBufferArrFromAccessor(json,accessor,this._arrayBufferMap),void wd.assert(bufferArr.length%3===0,wd.Log.info.FUNC_SHOULD("indices' count","3 times"))):[]})],GLTFGeometryParser.prototype,"_getFaces",null),GLTFGeometryParser}();wd.GLTFGeometryParser=GLTFGeometryParser}(wd||(wd={}));var wd;!function(wd){var GLTFMaterialParser=function(){function GLTFMaterialParser(){this._imageMap=null,this._json=null}return GLTFMaterialParser.create=function(){var obj=new this;return obj},GLTFMaterialParser.prototype.parse=function(json,materialId,imageMap){var materialData=null,materialExtension=null;if(this._json=json,this._imageMap=imageMap,!this._isUseKHRMaterialExtension()){wd.Log.log("no KHR_materials_common extension found, will use default material instead");var material_1={type:"BasicMaterial",doubleSided:!1};return material_1}var material={};return materialData=json.materials[materialId],wd.Log.error(!materialData.extensions||!materialData.extensions.KHR_materials_common,wd.Log.info.FUNC_SHOULD("materials","define KHR_materials_common extensions")),materialExtension=materialData.extensions.KHR_materials_common,wd.GLTFUtils.addData(material,"doubleSided",materialExtension.doubleSided),wd.GLTFUtils.addData(material,"transparent",Boolean(materialExtension.transparent)),material.type=this._getMaterialType(materialExtension.technique),material.lightModel=this._getLightModel(materialExtension.technique),this._addMaterialExtensionValues(material,materialExtension.values),material},GLTFMaterialParser.prototype._isUseKHRMaterialExtension=function(){var extensionsUsed=this._json.extensionsUsed;return!!extensionsUsed&&extensionsUsed.indexOf("KHR_materials_common")>-1},GLTFMaterialParser.prototype._getMaterialType=function(technique){var type=null;switch(technique){case"PHONG":case"BLINN":case"CONSTANT":case"LAMBERT":type="LightMaterial";break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("technique:"+technique))}return type},GLTFMaterialParser.prototype._getLightModel=function(technique){var model=null;switch(technique){case"PHONG":model=wd.ELightModel.PHONG;break;case"BLINN":model=wd.ELightModel.BLINN;break;case"CONSTANT":model=wd.ELightModel.CONSTANT;break;case"LAMBERT":model=wd.ELightModel.LAMBERT;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("technique:"+technique))}return model},GLTFMaterialParser.prototype._addMaterialExtensionValues=function(material,values){values&&(values.ambient&&wd.Log.warn(wd.Log.info.FUNC_NOT_SUPPORT("ambient of material")),this._addMaterialLightColor(material,"diffuse",values.diffuse),this._addMaterialLightColor(material,"specular",values.specular),this._addMaterialLightColor(material,"emission",values.emission),values.shininess&&(material.shininess=values.shininess.value),values.transparency&&(material.opacity=values.transparency.value))},GLTFMaterialParser.prototype._addMaterialLightColor=function(material,colorName,colorData){colorData&&(wd.JudgeUtils.isArrayExactly(colorData)?material[colorName+"Color"]=wd.GLTFUtils.getColor(colorData):this._isColor(colorData.type)?material[colorName+"Color"]=wd.GLTFUtils.getColor(colorData.value):material[colorName+"Map"]=this._getTexture(colorData.value))},GLTFMaterialParser.prototype._isColor=function(type){return 35666===Number(type)},GLTFMaterialParser.prototype._getTexture=function(textureId){var texture=null,asset=null;return this._json.textures&&this._json.textures[textureId]?(texture=this._json.textures[textureId],asset=this._createTextureAsset(texture.target,texture.source),texture.internalFormat!==texture.format&&wd.Log.warn("texture.internalFormat("+texture.internalFormat+") !== texture.format("+texture.format+"), here take texture.format value as their value"),texture.format&&(asset.format=this._getTextureFormat(texture.format)),texture.type&&(asset.type=this._getTextureType(texture.type)),this._addTextureSampler(asset,texture.sampler),asset.toTexture()):null},GLTFMaterialParser.prototype._createTextureAsset=function(target,imageId){var asset=null,source=this._imageMap.getChild(imageId);switch(source||wd.Log.warn("no image found in loader(id:"+imageId+")"),target){case 3553:asset=wd.ImageTextureAsset.create(source);break;default:wd.Log.error(!0,wd.Log.info.FUNC_NOT_SUPPORT("target except TEXTURE_2D"))}return asset},GLTFMaterialParser.prototype._getTextureType=function(type){var textureType=null;switch(type){case 5121:textureType=wd.ETextureType.UNSIGNED_BYTE;break;case 33635:textureType=wd.ETextureType.UNSIGNED_SHORT_5_6_5;break;case 32819:textureType=wd.ETextureType.UNSIGNED_SHORT_4_4_4_4;break;case 32820:textureType=wd.ETextureType.UNSIGNED_SHORT_5_5_5_1;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("texture->type:"+type))}return textureType},GLTFMaterialParser.prototype._getTextureFormat=function(format){var textureFormat=null;switch(format){case 6406:textureFormat=wd.ETextureFormat.ALPHA;break;case 6407:textureFormat=wd.ETextureFormat.RGB;break;case 6408:textureFormat=wd.ETextureFormat.RGBA;break;case 6409:textureFormat=wd.ETextureFormat.LUMINANCE;break;case 6410:textureFormat=wd.ETextureFormat.LUMINANCE_ALPHA;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("texture->format:"+format))}return textureFormat},GLTFMaterialParser.prototype._addTextureSampler=function(asset,samplerId){var sampler=this._json.samplers[samplerId];asset.wrapT=this._getTextureWrap(sampler.wrapT),asset.wrapS=this._getTextureWrap(sampler.wrapS),asset.minFilter=this._getTextureFilter(sampler.minFilter),asset.magFilter=this._getTextureFilter(sampler.magFilter)},GLTFMaterialParser.prototype._getTextureFilter=function(filter){var textureFilter=null;switch(filter){case 9728:textureFilter=wd.ETextureFilterMode.NEAREST;break;case 9729:textureFilter=wd.ETextureFilterMode.LINEAR;break;case 9984:textureFilter=wd.ETextureFilterMode.NEAREST_MIPMAP_MEAREST;break;case 9985:textureFilter=wd.ETextureFilterMode.LINEAR_MIPMAP_NEAREST;break;case 9986:textureFilter=wd.ETextureFilterMode.NEAREST_MIPMAP_LINEAR;break;case 9987:textureFilter=wd.ETextureFilterMode.LINEAR_MIPMAP_LINEAR;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("texture filter:"+filter))}return textureFilter},GLTFMaterialParser.prototype._getTextureWrap=function(wrap){var textureWrap=null;switch(wrap){case 33071:textureWrap=wd.ETextureWrapMode.CLAMP_TO_EDGE;break;case 33648:textureWrap=wd.ETextureWrapMode.MIRRORED_REPEAT;break;case 10497:textureWrap=wd.ETextureWrapMode.REPEAT;break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("texture wrap:"+wrap))}return textureWrap},__decorate([wd.require(function(asset,samplerId){wd.assert(!!this._json.samplers[samplerId],wd.Log.info.FUNC_NOT_EXIST("samplerId:"+samplerId))})],GLTFMaterialParser.prototype,"_addTextureSampler",null),GLTFMaterialParser}();wd.GLTFMaterialParser=GLTFMaterialParser}(wd||(wd={}));var wd;!function(wd){var GLTFArticulatedAnimationParser=function(){function GLTFArticulatedAnimationParser(){this._arrayBufferMap=null,this._json=null,this._translationArrayOffset=null,this._rotationArrayOffset=null,this._scaleArrayOffset=null}return GLTFArticulatedAnimationParser.create=function(){var obj=new this;return obj},GLTFArticulatedAnimationParser.prototype.parse=function(json,objects,arrayBufferMap){var _this=this,nodeWithAnimationMap=wdCb.Hash.create(),self=this;this._json=json,this._arrayBufferMap=arrayBufferMap;var _loop_2=function(animId){if(json.animations.hasOwnProperty(animId)){for(var animation_1=json.animations[animId],nodeWithChannelMap=wdCb.Hash.create(),i=0,len=animation_1.channels.length;i<len;i++){var channel=animation_1.channels[i],targetId=channel.target.id;nodeWithChannelMap.appendChild(targetId,channel)}nodeWithChannelMap.forEach(function(channelList,targetId){var keyFrameDataList=wdCb.Collection.create(),targetNode=self._findNode(objects,targetId),inputData=null,bufferInput=null;if(null===targetNode)return void wd.Log.warn("can't find node whose id is "+targetId+" to attach to animation named "+animId);self._addAnimationToNode(nodeWithAnimationMap,targetId,targetNode,self._getAnimName(animation_1,animId),keyFrameDataList),inputData=self._getInputData(animation_1,channelList),bufferInput=wd.GLTFUtils.getBufferArrFromAccessor(json,json.accessors[inputData],arrayBufferMap),_this._translationArrayOffset=0,_this._rotationArrayOffset=0,_this._scaleArrayOffset=0;for(var j=0;j<bufferInput.length;j++){var keyFrameData={};keyFrameData.time=_this._convertSecondToMillisecond(bufferInput[j]),keyFrameData.targets=_this._getKeyFrameDataTargets(animation_1,channelList),keyFrameDataList.addChild(keyFrameData)}})}};for(var animId in json.animations)_loop_2(animId);this._addAnimationComponent(nodeWithAnimationMap)},GLTFArticulatedAnimationParser.prototype._getAnimName=function(animation,animId){return animation.name?animation.name:animId},GLTFArticulatedAnimationParser.prototype._getInputData=function(animation,channelList){var result=null;return channelList.forEach(function(channel){var sampler=animation.samplers[channel.sampler];if(sampler)return result=animation.parameters[sampler.input],wdCb.$BREAK}),result},GLTFArticulatedAnimationParser.prototype._addAnimationToNode=function(nodeWithAnimationMap,targetId,targetNode,animName,keyFrameDataList){nodeWithAnimationMap.hasChild(targetId)||nodeWithAnimationMap.addChild(targetId,{node:targetNode,animationData:{}}),nodeWithAnimationMap.getChild(targetId).animationData[animName]=keyFrameDataList},GLTFArticulatedAnimationParser.prototype._getKeyFrameDataTargets=function(animation,channelList){var _this=this,targets=wdCb.Collection.create();return channelList.forEach(function(channel){var sampler=animation.samplers[channel.sampler],outputData=null,bufferOutput=null,targetPath=null,targetData={};if(sampler){switch(targetPath=channel.target.path,outputData=animation.parameters[sampler.output],bufferOutput=wd.GLTFUtils.getBufferArrFromAccessor(_this._json,_this._json.accessors[outputData],_this._arrayBufferMap),targetData.interpolationMethod=_this._convertTointerpolationMethod(sampler.interpolation),targetPath){case"translation":targetData.target=wd.EArticulatedAnimationTarget.TRANSLATION,targetData.data=wd.Vector3.create(bufferOutput[_this._translationArrayOffset],bufferOutput[_this._translationArrayOffset+1],bufferOutput[_this._translationArrayOffset+2]),_this._translationArrayOffset+=3;break;case"rotation":targetData.target=wd.EArticulatedAnimationTarget.ROTATION,targetData.data=wd.Quaternion.create(bufferOutput[_this._rotationArrayOffset],bufferOutput[_this._rotationArrayOffset+1],bufferOutput[_this._rotationArrayOffset+2],bufferOutput[_this._rotationArrayOffset+3]),_this._rotationArrayOffset+=4;break;case"scale":targetData.target=wd.EArticulatedAnimationTarget.SCALE,targetData.data=wd.Vector3.create(bufferOutput[_this._scaleArrayOffset],bufferOutput[_this._scaleArrayOffset+1],bufferOutput[_this._scaleArrayOffset+2]),_this._scaleArrayOffset+=3;break;default:wd.Log.error(!0,wd.Log.info.FUNC_NOT_SUPPORT("path:"+targetPath))}targets.addChild(targetData)}}),targets},GLTFArticulatedAnimationParser.prototype._findNode=function(objects,targetId){var find=function(objects){var result=objects.findOne(function(object){return object.id===targetId});return result?result:(objects.forEach(function(object){if(result=find(object.children))return wdCb.$BREAK}),result)};return find(objects)},GLTFArticulatedAnimationParser.prototype._addAnimationComponent=function(nodeWithAnimationMap){nodeWithAnimationMap.forEach(function(_a){var node=_a.node,animationData=_a.animationData;node.components.addChild(animationData)})},GLTFArticulatedAnimationParser.prototype._convertSecondToMillisecond=function(time){return 1e3*time},GLTFArticulatedAnimationParser.prototype._convertTointerpolationMethod=function(jsonInterpolation){switch(jsonInterpolation){case"LINEAR":return wd.EKeyFrameInterpolation.LINEAR;default:wd.Log.error(!0,wd.Log.info.FUNC_NOT_SUPPORT("interpolation:"+jsonInterpolation))}},__decorate([wd.require(function(animation,channelList){var inputSamplerList=wdCb.Collection.create();for(var samplerId in animation.samplers)if(animation.samplers.hasOwnProperty(samplerId)){var sampelr=animation.samplers[samplerId];inputSamplerList.addChild(sampelr.input)}wd.assert(1===inputSamplerList.removeRepeatItems().getCount(),wd.Log.info.FUNC_SHOULD("all sampler->input","be the same"))})],GLTFArticulatedAnimationParser.prototype,"_getInputData",null),__decorate([wd.ensure(function(returnVal,nodeWithAnimationMap){nodeWithAnimationMap.forEach(function(_a){var node=_a.node;_a.animationData;wd.assert(node.components.filter(function(component){return wd.GLTFUtils.isIGLTFArticulatedAnimation(component)}).getCount()<=1,wd.Log.info.FUNC_SHOULD("node","only has 1 IGLTFArticulatedAnimation component"))})})],GLTFArticulatedAnimationParser.prototype,"_addAnimationComponent",null),GLTFArticulatedAnimationParser}();wd.GLTFArticulatedAnimationParser=GLTFArticulatedAnimationParser}(wd||(wd={}));var wd;!function(wd){var GLTFUtils=function(){function GLTFUtils(){}return GLTFUtils.addData=function(target,sourceName,sourceData){void 0!==sourceData&&null!==sourceData&&(target[sourceName]=sourceData)},GLTFUtils.isBase64=function(uri){return!(uri.length<5)&&"data:"===uri.substr(0,5)},GLTFUtils.decodeArrayBuffer=function(base64Str){for(var base64=base64Str.split(",")[1],decodedString=atob(base64),bufferLength=decodedString.length,arraybuffer=new Uint8Array(new ArrayBuffer(bufferLength)),i=0;i<bufferLength;i++)arraybuffer[i]=decodedString.charCodeAt(i);return arraybuffer.buffer},GLTFUtils.createObjectData=function(){return{id:null,isContainer:!1,components:wdCb.Collection.create(),children:wdCb.Collection.create()}},GLTFUtils.getColor=function(value){var color=wd.Color.create();return color.r=Number(value[0]),color.g=Number(value[1]),color.b=Number(value[2]),4===value.length&&(color.a=Number(value[3])),color},GLTFUtils.getBufferArrFromAccessor=function(json,accessor,arrayBufferMap){var bufferView=json.bufferViews[accessor.bufferView],arrayBuffer=arrayBufferMap.getChild(bufferView.buffer),byteOffset=accessor.byteOffset+bufferView.byteOffset,count=accessor.count*this.getAccessorTypeSize(accessor);switch(accessor.componentType){case 5120:return new Int8Array(arrayBuffer,byteOffset,count);case 5121:return new Uint8Array(arrayBuffer,byteOffset,count);case 5122:return new Int16Array(arrayBuffer,byteOffset,count);case 5123:return new Uint16Array(arrayBuffer,byteOffset,count);case 5126:return new Float32Array(arrayBuffer,byteOffset,count);default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("componentType:"+accessor.componentType))}},GLTFUtils.getAccessorTypeSize=function(accessor){var type=accessor.type;switch(type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}},GLTFUtils.isIGLTFArticulatedAnimation=function(component){if(!wd.JudgeUtils.isDirectObject(component))return!1;for(var animName in component)return component[animName]instanceof wdCb.Collection&&component[animName].getCount()>0&&void 0!==component[animName].getChild(0).time},GLTFUtils}();wd.GLTFUtils=GLTFUtils}(wd||(wd={}));var wd;!function(wd){!function(EWDTag){EWDTag[EWDTag.CONTAINER="CONTAINER"]="CONTAINER"}(wd.EWDTag||(wd.EWDTag={}));wd.EWDTag}(wd||(wd={}));var wd;!function(wd){var WDLoader=function(_super){function WDLoader(){_super.apply(this,arguments),this._parseData=null}return __extends(WDLoader,_super),WDLoader.getInstance=function(){},WDLoader.prototype.loadAsset=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var url=args[0],self=this;return wd.AjaxLoader.load(url,"json").flatMap(function(json){return self._parseData=wd.WDParser.create().parse(json),self._createLoadMapStream(url,self._parseData)}).lastOrDefault().map(function(){return wd.WDBuilder.create().build(self._parseData)})},WDLoader.prototype._createLoadMapStream=function(filePath,parseData){var streamArr=[];return parseData.materials.forEach(function(material){var mapUrlArr=[];material.diffuseMapUrl&&mapUrlArr.push(["diffuseMap",material.diffuseMapUrl,material]),material.specularMapUrl&&mapUrlArr.push(["specularMap",material.specularMapUrl,material]),material.normalMapUrl&&mapUrlArr.push(["normalMap",material.normalMapUrl,material]),streamArr=streamArr.concat(mapUrlArr)}),wdFrp.fromArray(streamArr).flatMap(function(_a){var type=_a[0],mapUrl=_a[1],material=_a[2];return wd.TextureLoader.getInstance().load(wd.ModelLoaderUtils.getPath(filePath,mapUrl)).do(function(asset){material[type]=asset.toTexture()})})},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.assert(!wd.JudgeUtils.isArrayExactly(args[0]),wd.Log.info.FUNC_MUST_BE("url","string"))})],WDLoader.prototype,"loadAsset",null),WDLoader=__decorate([wd.singleton()],WDLoader)}(wd.Loader);wd.WDLoader=WDLoader}(wd||(wd={}));var wd;!function(wd){var WDParser=function(){function WDParser(){this._data={},this._objectParser=wd.WDObjectParser.create()}return WDParser.create=function(){var obj=new this;return obj},WDParser.prototype.parse=function(json){return this._parseMetadata(json),this._parseScene(json),this._parseMaterial(json),this._parseObject(json),this._data},WDParser.prototype._parseMetadata=function(json){this._data.metadata=json.metadata},WDParser.prototype._parseObject=function(json){this._objectParser.parse(this._data,json)},WDParser.prototype._parseScene=function(json){this._data.scene=json.scene,json.scene.ambientColor&&(this._data.scene.ambientColor=this._createColor(json.scene.ambientColor))},WDParser.prototype._parseMaterial=function(json){var _this=this;this._data.materials=wdCb.Hash.create(json.materials),this._data.materials.forEach(function(material){material.diffuseColor&&(material.diffuseColor=_this._createColor(material.diffuseColor)),material.specularColor&&(material.specularColor=_this._createColor(material.specularColor))})},WDParser.prototype._createColor=function(colorArr){return wd.Color.create("rgb("+colorArr.join(",").replace(/^(\d+),/g,"$1.0,").replace(/,(\d+),/g,",$1.0,").replace(/,(\d+)$/g,",$1.0")+")")},WDParser}();wd.WDParser=WDParser}(wd||(wd={}));var wd;!function(wd){var WDObjectParser=function(){function WDObjectParser(){}return WDObjectParser.create=function(){var obj=new this;return obj},WDObjectParser.prototype.parse=function(data,json){var parse=null,self=this;data.objects=wdCb.Collection.create(json.objects),parse=function(object){self._isObjectContainer(object)?object.isContainer=!0:(object.isContainer=!1,self._parseFromIndices(object)),object.children&&(object.children=wdCb.Collection.create(object.children),object.children.forEach(function(child){child.parent=object,parse(child)}))},data.objects.forEach(function(object){object.parent=null,parse(object),self._removeObjectContainerData(object)})},WDObjectParser.prototype._isObjectContainer=function(object){return!wd.GeometryUtils.hasData(object.verticeIndices)},WDObjectParser.prototype._parseFromIndices=function(object){this._duplicateVertexWithDifferentUvs(object),this._parseObjectFromIndices(object),this._removeRebundantIndiceData(object)},WDObjectParser.prototype._duplicateVertexWithDifferentUvs=function(object){var arr=[],container=wdCb.Hash.create(),verticeIndices=object.verticeIndices,uvIndices=object.uvIndices;if(wd.GeometryUtils.hasData(uvIndices))for(var i=0,len=verticeIndices.length;i<len;i++){var verticeIndex=verticeIndices[i];this._isSameVertexWithDifferentUvsByCompareToFirstOne(arr,uvIndices[i],verticeIndex)&&(this._isUvIndiceEqualTheOneOfAddedVertex(container,verticeIndex,uvIndices[i])?verticeIndices[i]=this._getVerticeIndexOfAddedVertexByFindContainer(container,verticeIndex,uvIndices[i]):this._addVertexData(object,container,verticeIndex,i),verticeIndex=verticeIndices[i]),arr[verticeIndex]=uvIndices[i]}},WDObjectParser.prototype._isSameVertexWithDifferentUvsByCompareToFirstOne=function(arr,uvIndex,verticeIndex){return void 0!==arr[verticeIndex]&&arr[verticeIndex]!==uvIndex},WDObjectParser.prototype._addVertexData=function(object,container,verticeIndex,index){var verticeIndices=object.verticeIndices,uvIndices=object.uvIndices,normalIndices=object.normalIndices,vertices=this._findData(object,"vertices"),normals=this._findData(object,"normals"),morphTargets=this._findData(object,"morphTargets"),verticeIndexOfAddedVertex=null;if(this._addThreeComponent(vertices,verticeIndex),verticeIndexOfAddedVertex=this._getVerticeIndexOfAddedVertex(vertices),verticeIndices[index]=verticeIndexOfAddedVertex,wd.GeometryUtils.hasData(morphTargets))for(var _i=0,morphTargets_1=morphTargets;_i<morphTargets_1.length;_i++){var frame=morphTargets_1[_i];this._addThreeComponent(frame.vertices,verticeIndex),wd.GeometryUtils.hasData(frame.normals)&&this._addDuplicateNormalOfAddedVertex(frame.normals,normalIndices,index,verticeIndex)}wd.GeometryUtils.hasData(normals)&&(this._addDuplicateNormalOfAddedVertex(normals,normalIndices,index,verticeIndex),wd.GeometryUtils.hasData(normalIndices)&&(normalIndices[index]=verticeIndexOfAddedVertex)),container.appendChild(String(verticeIndex),[uvIndices[index],verticeIndexOfAddedVertex])},WDObjectParser.prototype._addDuplicateNormalOfAddedVertex=function(normals,normalIndices,index,oldVerticeIndex){return wd.GeometryUtils.hasData(normalIndices)?void this._addThreeComponent(normals,normals,normalIndices[index]):void this._addThreeComponent(normals,normals,oldVerticeIndex)},WDObjectParser.prototype._isUvIndiceEqualTheOneOfAddedVertex=function(container,targetVerticeIndex,targetUvIndex){var data=container.getChild(String(targetVerticeIndex));return!!data&&data.hasChildWithFunc(function(_a){var uvIndex=_a[0];_a[1];return uvIndex===targetUvIndex})},WDObjectParser.prototype._getVerticeIndexOfAddedVertexByFindContainer=function(container,targetVerticeIndex,targetUvIndex){var data=container.getChild(String(targetVerticeIndex));return data.findOne(function(_a){var uvIndex=_a[0];_a[1];return uvIndex===targetUvIndex})[1]},WDObjectParser.prototype._getVerticeIndexOfAddedVertex=function(vertices){return vertices.length/3-1},WDObjectParser.prototype._addThreeComponent=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if(2===args.length){var data=args[0],index=args[1];data.push(data[3*index],data[3*index+1],data[3*index+2])}else{var targetData=args[0],sourceData=args[1],index=args[2];targetData.push(sourceData[3*index],sourceData[3*index+1],sourceData[3*index+2])}},WDObjectParser.prototype._parseObjectFromIndices=function(object){for(var uvs=[],faces=[],face=null,objectVertices=this._findData(object,"vertices"),objectUVs=this._findData(object,"uvs"),objectNormals=this._findData(object,"normals"),objectColors=this._findData(object,"colors"),i=0,len=object.verticeIndices.length;i<len;i+=3){var aIndex=object.verticeIndices[i],bIndex=object.verticeIndices[i+1],cIndex=object.verticeIndices[i+2],indexArr=[i,i+1,i+2],verticeIndiceArr=[aIndex,bIndex,cIndex];face=wd.Face3.create(aIndex,bIndex,cIndex),wd.GeometryUtils.hasData(object.uvIndices)&&wd.GeometryUtils.hasData(objectUVs)&&this._setUV(uvs,objectUVs,object.uvIndices,indexArr,verticeIndiceArr),wd.GeometryUtils.hasData(objectNormals)&&this._setNormal(face.vertexNormals,objectNormals,object.normalIndices,indexArr,verticeIndiceArr),faces.push(face)}object.vertices=objectVertices,wd.GeometryUtils.hasData(object.uvIndices)?object.uvs=uvs:object.uvs=objectUVs,object.colors=objectColors,object.faces=faces,this._setMorphTargets(object,object.verticeIndices,object.normalIndices)},WDObjectParser.prototype._getAnimName=function(frameName){var PATTERN=/([a-z]+)_?(\d+)/,DEFAULT_ANIM_NAME="default",parts=frameName.match(PATTERN);return parts&&parts.length>1?parts[1]:DEFAULT_ANIM_NAME},WDObjectParser.prototype._removeRebundantIndiceData=function(object){delete object.verticeIndices,delete object.uvIndices,delete object.normalIndices},WDObjectParser.prototype._removeObjectContainerData=function(object){var remove=null;(remove=function(object){object.isContainer&&(delete object.vertices,delete object.uvs,delete object.colors),object.children&&object.children.forEach(function(child){remove(child)})})(object)},WDObjectParser.prototype._findData=function(object,dataName){var data=null;do data=object[dataName];while(!data&&null!==(object=object.parent));return data},WDObjectParser.prototype._setUV=function(targetUVs,sourceUVs,uvIndices,indexArr,verticeIndiceArr){var uvIndice1=null,uvIndice2=null,uvIndice3=null,index1=indexArr[0],index2=indexArr[1],index3=indexArr[2],aIndex=verticeIndiceArr[0],bIndex=verticeIndiceArr[1],cIndex=verticeIndiceArr[2];uvIndice1=uvIndices[index1],uvIndice2=uvIndices[index2],uvIndice3=uvIndices[index3],this._setTwoComponentData(targetUVs,sourceUVs,aIndex,uvIndice1),this._setTwoComponentData(targetUVs,sourceUVs,bIndex,uvIndice2),this._setTwoComponentData(targetUVs,sourceUVs,cIndex,uvIndice3)},WDObjectParser.prototype._setTwoComponentData=function(targetData,sourceData,index,indice){targetData[2*index]=sourceData[2*indice],targetData[2*index+1]=sourceData[2*indice+1]},WDObjectParser.prototype._setThreeComponentData=function(targetData,sourceData,index,indice){targetData[3*index]=sourceData[3*indice],targetData[3*index+1]=sourceData[3*indice+1],targetData[3*index+2]=sourceData[3*indice+2]},WDObjectParser.prototype._getThreeComponentData=function(sourceData,index){var startIndex=3*index;return wd.Vector3.create(sourceData[startIndex],sourceData[startIndex+1],sourceData[startIndex+2])},WDObjectParser.prototype._setNormal=function(targetNormals,sourceNormals,normalIndices,indexArr,verticeIndiceArr){var index1=indexArr[0],index2=indexArr[1],index3=indexArr[2];return wd.GeometryUtils.hasData(normalIndices)?void this._addNormalData(targetNormals,sourceNormals,[normalIndices[index1],normalIndices[index2],normalIndices[index3]]):void this._addNormalData(targetNormals,sourceNormals,verticeIndiceArr)},WDObjectParser.prototype._addNormalData=function(targetNormals,sourceNormals,normalIndiceArr){var aIndex=normalIndiceArr[0],bIndex=normalIndiceArr[1],cIndex=normalIndiceArr[2];if(targetNormals instanceof wdCb.Collection)targetNormals.addChildren([this._getThreeComponentData(sourceNormals,aIndex),this._getThreeComponentData(sourceNormals,bIndex),this._getThreeComponentData(sourceNormals,cIndex)]);else for(var normals=targetNormals,_i=0,_a=[this._getThreeComponentData(sourceNormals,aIndex),this._getThreeComponentData(sourceNormals,bIndex),this._getThreeComponentData(sourceNormals,cIndex)];_i<_a.length;_i++){
var v=_a[_i];normals.push(v.x,v.y,v.z)}},WDObjectParser.prototype._setMorphTargets=function(object,verticeIndices,normalIndices){var objectMorphTargets=this._findData(object,"morphTargets"),morphTargets=null,morphNormals=null;if(wd.GeometryUtils.hasData(objectMorphTargets)){morphTargets=wdCb.Hash.create(),morphNormals=wdCb.Hash.create();for(var _i=0,objectMorphTargets_1=objectMorphTargets;_i<objectMorphTargets_1.length;_i++){var frameData=objectMorphTargets_1[_i],animName=this._getAnimName(frameData.name);if(morphTargets.appendChild(animName,frameData.vertices),wd.GeometryUtils.hasData(frameData.normals))if(wd.GeometryUtils.hasData(normalIndices)){for(var normals=[],i=0,len=verticeIndices.length;i<len;i++)this._setThreeComponentData(normals,frameData.normals,verticeIndices[i],normalIndices[i]);morphNormals.appendChild(animName,normals)}else morphNormals.appendChild(animName,frameData.normals)}}object.morphTargets=morphTargets,object.morphNormals=morphNormals},__decorate([wd.require(function(container,targetVerticeIndex,targetUvIndex){wd.assert(this._isUvIndiceEqualTheOneOfAddedVertex(container,targetVerticeIndex,targetUvIndex),wd.Log.info.FUNC_SHOULD("uvIndex","equal the one of added vertex"))})],WDObjectParser.prototype,"_getVerticeIndexOfAddedVertexByFindContainer",null),__decorate([wd.ensure(function(returnValue,object){wd.assert(!object.verticeIndices,wd.Log.info.FUNC_SHOULD("object.verticeIndices","be removed")),wd.assert(!object.uvIndices,wd.Log.info.FUNC_SHOULD("object.uvIndices","be removed")),wd.assert(!object.normalIndices,wd.Log.info.FUNC_SHOULD("object.normalIndices","be removed"))})],WDObjectParser.prototype,"_removeRebundantIndiceData",null),WDObjectParser}();wd.WDObjectParser=WDObjectParser}(wd||(wd={}));var wd;!function(wd){var WDBuilder=function(){function WDBuilder(){this._result=wdCb.Hash.create()}return WDBuilder.create=function(){var obj=new this;return obj},WDBuilder.prototype.build=function(parseData){return this._buildMetadata(parseData),this._buildScene(parseData),this._buildModels(parseData),this._result},WDBuilder.prototype._buildMetadata=function(parseData){var metadata=wdCb.Hash.create();for(var i in parseData.metadata)parseData.metadata.hasOwnProperty(i)&&metadata.addChild(i,parseData.metadata[i]);this._result.addChild("metadata",metadata)},WDBuilder.prototype._buildScene=function(parseData){var scene=wdCb.Hash.create();parseData.scene.ambientColor&&scene.addChild("ambientColor",parseData.scene.ambientColor),this._result.addChild("scene",scene)},WDBuilder.prototype._buildModels=function(parseData){var models=wdCb.Collection.create(),self=this,build=null;build=function(objects,models){objects.forEach(function(object){var geometry=null,model=null;model=wd.GameObject.create(),self._isModelContainer(object)?model.addTag(wd.EWDTag.CONTAINER):(geometry=wd.ModelGeometry.create(),geometry.vertices=object.vertices,geometry.faces=object.faces,geometry.texCoords=object.uvs,geometry.colors=object.colors,object.material&&(geometry.material=self._buildMaterial(object.material,parseData.materials)),geometry.morphTargets=object.morphTargets,geometry.morphFaceNormals=object.morphNormals,geometry.morphVertexNormals=object.morphNormals,wd.GeometryUtils.hasData(geometry.morphTargets)&&model.addComponent(wd.MorphAnimation.create()),model.addComponent(geometry)),model.name=object.name,model.addComponent(wd.MeshRenderer.create()),models.addChild(model),object.children&&build(object.children,model)})},build(parseData.objects,models),this._result.addChild("models",models)},WDBuilder.prototype._isModelContainer=function(object){return object.isContainer},WDBuilder.prototype._buildMaterial=function(materialName,materials){var DEFAULTYPE="LightMaterial",materialData=null,type=null,material=null;return _a=materials.findOne(function(material,name){return name===materialName}),materialData=_a[1],type=materialData.type||DEFAULTYPE,wdCb.Log.error(!wd[type],wdCb.Log.info.FUNC_NOT_EXIST("materialClass:"+type)),material=wd[type].create(),material.name=materialName,materialData.diffuseColor&&(material.color=materialData.diffuseColor),materialData.specularColor&&(material.specularColor=materialData.specularColor),materialData.diffuseMap&&(material.diffuseMap=materialData.diffuseMap),materialData.specularMap&&(material.specularMap=materialData.specularMap),materialData.normalMap&&(material.normalMap=materialData.normalMap),null!==materialData.shininess&&(material.shininess=materialData.shininess),null!==materialData.opacity&&(material.opacity=materialData.opacity),material;var _a},WDBuilder}();wd.WDBuilder=WDBuilder}(wd||(wd={}));var wd;!function(wd){var TYPE={".eot":"embedded-opentype",".ttf":"truetype",".woff":"woff",".svg":"svg"},FontLoader=function(_super){function FontLoader(){_super.apply(this,arguments),this._familyName=null}return __extends(FontLoader,_super),FontLoader.getInstance=function(){},FontLoader.prototype.dispose=function(){_super.prototype.dispose.call(this),wdCb.DomQuery.create("#"+this._familyName).remove()},FontLoader.prototype.loadAsset=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var familyName=args[1],self=this;return this._familyName=familyName,wdFrp.fromPromise(new RSVP.Promise(function(resolve,reject){self._addStyleElement(args,familyName),document.fonts?document.fonts.load("1em "+familyName).then(function(){resolve()},function(e){reject(e)}):(wd.Log.warn("your browser not support document.fonts api, so it can't ensure that the font is loaded"),resolve())}))},FontLoader.prototype._getType=function(url){return TYPE[wdCb.PathUtils.extname(url).toLowerCase()]},FontLoader.prototype._addStyleElement=function(args,familyName){var fontStyleEle=wdCb.DomQuery.create('<style id="'+familyName+'"></style>'),fontStr=null;if(fontStyleEle.prependTo("body"),fontStr="@font-face { font-family:"+familyName+"; src:",wd.JudgeUtils.isArrayExactly(args[0])){for(var urlArr=args[0],_i=0,urlArr_1=urlArr;_i<urlArr_1.length;_i++){var url=urlArr_1[_i];fontStr+="url('"+url+"') format('"+this._getType(url)+"'),"}fontStr=fontStr.replace(/,$/,";")}else{var url=args[0];fontStr+="url('"+url+"') format('"+this._getType(url)+"');"}fontStyleEle.get(0).textContent+=fontStr+"};"},__decorate([wd.require(function(url){var extname=wdCb.PathUtils.extname(url).toLowerCase();wd.assert(!!TYPE[extname],wd.Log.info.FUNC_UNKNOW("type:"+extname))})],FontLoader.prototype,"_getType",null),FontLoader=__decorate([wd.singleton()],FontLoader)}(wd.Loader);wd.FontLoader=FontLoader}(wd||(wd={}));var wd;!function(wd){var COMMON_EXP=/common [^\n]*(\n|$)/gi,PAGE_EXP=/page [^\n]*(\n|$)/gi,CHAR_EXP=/char [^\n]*(\n|$)/gi,KERNING_EXP=/kerning [^\n]*(\n|$)/gi,ITEM_EXP=/\w+=[^ \r\n]+/gi,INT_EXP=/^[\-]?\d+$/,FntParser=function(){function FntParser(){}return FntParser.create=function(){var obj=new this;return obj},FntParser.prototype.parseFnt=function(fntStr,url){var fnt={},commonObj=null,pageObj=null;return commonObj=this._parseStrToObj(fntStr.match(COMMON_EXP)[0]),fnt.commonHeight=commonObj.lineHeight,fnt.commonBase=commonObj.base,fnt.scaleW=commonObj.scaleW,fnt.scaleH=commonObj.scaleH,1!==commonObj.pages?fnt.isMultiPages=!0:fnt.isMultiPages=!1,pageObj=this._parseStrToObj(fntStr.match(PAGE_EXP)[0]),0!==pageObj.id&&wd.Log.log("file could not be found"),fnt.atlasName=wdCb.PathUtils.changeBasename(url,pageObj.file),this._parseChar(fntStr,fnt),this._parseKerning(fntStr,fnt),fnt},FntParser.prototype._parseStrToObj=function(str){var arr=str.match(ITEM_EXP),obj={};if(arr)for(var _i=0,arr_2=arr;_i<arr_2.length;_i++){var tempStr=arr_2[_i],index=tempStr.indexOf("="),key=tempStr.substring(0,index),value=tempStr.substring(index+1);value.match(INT_EXP)?value=parseInt(value):'"'==value[0]&&(value=value.substring(1,value.length-1)),obj[key]=value}return obj},FntParser.prototype._parseChar=function(fntStr,fnt){for(var charLines=fntStr.match(CHAR_EXP),fontDefDictionary={},_i=0,charLines_1=charLines;_i<charLines_1.length;_i++){var char=charLines_1[_i],charObj=this._parseStrToObj(char),charId=charObj.id;fontDefDictionary[charId]={id:charId,rect:{x:charObj.x,y:charObj.y,width:charObj.width,height:charObj.height},xOffset:charObj.xoffset,yOffset:charObj.yoffset,xAdvance:charObj.xadvance,page:charObj.page}}fnt.fontDefDictionary=fontDefDictionary},FntParser.prototype._parseKerning=function(fntStr,fnt){var kerningLines=fntStr.match(KERNING_EXP),kerningArray=[];if(null===kerningLines)return void(fnt.kerningArray=[]);for(var _i=0,kerningLines_1=kerningLines;_i<kerningLines_1.length;_i++){var kerning=kerningLines_1[_i],kerningObj=this._parseStrToObj(kerning);kerningArray.push({first:kerningObj.first,second:kerningObj.second,amount:kerningObj.amount})}fnt.kerningArray=kerningArray},FntParser}();wd.FntParser=FntParser}(wd||(wd={}));var wd;!function(wd){var FntLoader=function(_super){function FntLoader(){_super.apply(this,arguments),this._parser=wd.FntParser.create()}return __extends(FntLoader,_super),FntLoader.getInstance=function(){},FntLoader.prototype.loadAsset=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var url=args[0],self=this;return wd.AjaxLoader.load(url,"text").map(function(fntStr){return self._parser.parseFnt(fntStr,url)})},__decorate([wd.require(function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];wd.assert(!wd.JudgeUtils.isArrayExactly(args[0]),wd.Log.info.FUNC_MUST_BE("url","string"))})],FntLoader.prototype,"loadAsset",null),FntLoader=__decorate([wd.singleton()],FntLoader)}(wd.Loader);wd.FntLoader=FntLoader}(wd||(wd={}));var wd;!function(wd){var DeviceManager=function(){function DeviceManager(){this.view=null,this.gl=null,this._scissorTest=!1,this._depthTest=null,this._depthFunc=null,this._side=null,this.polygonOffset=null,this._polygonOffsetMode=null,this._depthWrite=null,this._blend=null,this._writeRed=null,this._writeGreen=null,this._writeBlue=null,this._writeAlpha=null,this._blendSrc=null,this._blendDst=null,this._blendEquation=null,this._blendFuncSeparate=null,this._blendEquationSeparate=null,this._scissorRegion=wd.RectRegion.create(),this._viewport=wd.RectRegion.create(),this._clearColor=null,this._pixelRatio=null}return DeviceManager.getInstance=function(){},Object.defineProperty(DeviceManager.prototype,"scissorTest",{get:function(){return this._scissorTest},set:function(scissorTest){var gl=this.gl;this._scissorTest!==scissorTest&&(scissorTest?gl.enable(gl.SCISSOR_TEST):gl.disable(gl.SCISSOR_TEST),this._scissorTest=scissorTest)},enumerable:!0,configurable:!0}),DeviceManager.prototype.setScissor=function(x,y,width,height){this._scissorRegion.y===y&&this._scissorRegion.width===width&&this._scissorRegion.height===height||(this.gl.scissor(x,y,width,height),this._scissorRegion.set(x,y,width,height),this.scissorTest=!0)},DeviceManager.prototype.setViewport=function(x,y,width,height){this._viewport.x===x&&this._viewport.y===y&&this._viewport.width===width&&this._viewport.height===height||(this._viewport.set(x,y,width,height),this.gl.viewport(x,y,width,height))},DeviceManager.prototype.getViewport=function(){return this._viewport},Object.defineProperty(DeviceManager.prototype,"depthTest",{get:function(){return this._depthTest},set:function(depthTest){var gl=this.gl;this._depthTest!==depthTest&&(depthTest?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST),this._depthTest=depthTest)},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(depthFunc){var gl=this.gl;this._depthFunc!==depthFunc&&(gl.depthFunc(gl[depthFunc]),this._depthFunc=depthFunc)},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"side",{get:function(){return this._side},set:function(side){var gl=this.gl;if(this._side!==side){switch(side){case ESide.NONE:gl.enable(gl.CULL_FACE),gl.cullFace(gl.FRONT_AND_BACK);break;case ESide.BOTH:gl.disable(gl.CULL_FACE);break;case ESide.FRONT:gl.enable(gl.CULL_FACE),gl.cullFace(gl.BACK);break;case ESide.BACK:gl.enable(gl.CULL_FACE),gl.cullFace(gl.FRONT);break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("side",side))}this._side=side}},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"polygonOffsetMode",{get:function(){return this._polygonOffsetMode},set:function(polygonOffsetMode){var gl=this.gl;if(this._polygonOffsetMode!==polygonOffsetMode){switch(polygonOffsetMode){case EPolygonOffsetMode.NONE:gl.polygonOffset(0,0),gl.disable(gl.POLYGON_OFFSET_FILL);break;case EPolygonOffsetMode.IN:gl.enable(gl.POLYGON_OFFSET_FILL),gl.polygonOffset(1,1);break;case EPolygonOffsetMode.OUT:gl.enable(gl.POLYGON_OFFSET_FILL),gl.polygonOffset(-1,-1);break;case EPolygonOffsetMode.CUSTOM:gl.enable(gl.POLYGON_OFFSET_FILL),wd.Log.error(!this.polygonOffset,wd.Log.info.FUNC_MUST_DEFINE("polygonOffset")),gl.polygonOffset(this.polygonOffset.x,this.polygonOffset.y)}this._polygonOffsetMode=polygonOffsetMode}},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"depthWrite",{get:function(){return this._depthWrite},set:function(depthWrite){this._depthWrite!==depthWrite&&(this.gl.depthMask(depthWrite),this._depthWrite=depthWrite)},enumerable:!0,configurable:!0}),Object.defineProperty(DeviceManager.prototype,"blend",{get:function(){return this._blend},set:function(blend){var gl=this.gl;this._blend!==blend&&(blend?gl.enable(gl.BLEND):gl.disable(gl.BLEND),this._blend=blend)},enumerable:!0,configurable:!0}),DeviceManager.prototype.setBlendFunc=function(blendSrc,blendDst){this._blendSrc===blendSrc&&this._blendDst===blendDst||(this._blend&&this.gl.blendFunc(this.gl[blendSrc],this.gl[blendDst]),this._blendSrc=blendSrc,this._blendDst=blendDst)},DeviceManager.prototype.setBlendEquation=function(blendEquation){this._blendEquation!==blendEquation&&(this._blend&&this.gl.blendEquation(this.gl[blendEquation]),this._blendEquation=blendEquation)},DeviceManager.prototype.setBlendFuncSeparate=function(blendFuncSeparate){var gl=this.gl;this._blendFuncSeparate&&this._blendFuncSeparate[0]===blendFuncSeparate[0]&&this._blendFuncSeparate[1]===blendFuncSeparate[1]||(this._blend&&gl.blendFuncSeparate(gl[blendFuncSeparate[0]],gl[blendFuncSeparate[1]],gl[blendFuncSeparate[2]],gl[blendFuncSeparate[3]]),this._blendFuncSeparate=blendFuncSeparate)},DeviceManager.prototype.setBlendEquationSeparate=function(blendEquationSeparate){var gl=this.gl;this._blendEquationSeparate&&this._blendEquationSeparate[0]===blendEquationSeparate[0]&&this._blendEquationSeparate[1]===blendEquationSeparate[1]||(this._blend&&gl.blendEquationSeparate(gl[blendEquationSeparate[0]],gl[blendEquationSeparate[1]]),this._blendEquationSeparate=blendEquationSeparate)},DeviceManager.prototype.setColorWrite=function(writeRed,writeGreen,writeBlue,writeAlpha){this._writeRed===writeRed&&this._writeGreen===writeGreen&&this._writeBlue===writeBlue&&this._writeAlpha===writeAlpha||(this.gl.colorMask(writeRed,writeGreen,writeBlue,writeAlpha),this._writeRed=writeRed,this._writeGreen=writeGreen,this._writeBlue=writeBlue,this._writeAlpha=writeAlpha)},DeviceManager.prototype.clear=function(options){var gl=this.gl,color=options.color;this._setClearColor(color),this.setColorWrite(!0,!0,!0,!0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT)},DeviceManager.prototype.createGL=function(canvasId,contextConfig,useDevicePixelRatio){var canvas=null;canvas=canvasId?wdCb.DomQuery.create("#"+canvasId).get(0):wdCb.DomQuery.create("<canvas></canvas>").prependTo("body").get(0),this.view=wd.ViewWebGL.create(canvas),useDevicePixelRatio&&this.setPixelRatio(window.devicePixelRatio),this.gl=this.view.getContext(contextConfig)},DeviceManager.prototype.setScreen=function(){var screenSize=wd.Main.screenSize,x=null,y=null,width=null,height=null,styleWidth=null,styleHeight=null;screenSize===wd.EScreenSize.FULL?(x=0,y=0,width=wd.root.innerWidth,height=wd.root.innerHeight,styleWidth="100%",styleHeight="100%",wdCb.DomQuery.create("body").css("margin","0")):(x=screenSize.x||0,y=screenSize.y||0,width=screenSize.width||wd.root.innerWidth,height=screenSize.height||wd.root.innerHeight,styleWidth=width+"px",styleHeight=height+"px"),this.view.initCanvas(),this.view.x=x,this.view.y=y,this.view.width=width,this.view.height=height,this.view.styleWidth=styleWidth,this.view.styleHeight=styleHeight,this.setViewport(0,0,width,height)},DeviceManager.prototype.setHardwareScaling=function(level){var width=this.view.width/level,height=this.view.height/level;this.view.width=width,this.view.height=height,this.setViewport(0,0,width,height)},DeviceManager.prototype.setPixelRatio=function(pixelRatio){this.view.width=Math.round(this.view.width*pixelRatio),this.view.height=Math.round(this.view.height*pixelRatio),this._pixelRatio=pixelRatio},DeviceManager.prototype.getPixelRatio=function(){return this._pixelRatio},DeviceManager.prototype._setClearColor=function(color){this._clearColor&&this._clearColor.isEqual(color)||(this.gl.clearColor(color.r,color.g,color.b,color.a),this._clearColor=color)},__decorate([wd.require(function(){wd.assert(null!==wd.Main.screenSize,wd.Log.info.FUNC_NOT_EXIST("Main.screenSize"))})],DeviceManager.prototype,"setScreen",null),__decorate([wd.require(function(level){wd.assert(level>0,wd.Log.info.FUNC_SHOULD("level","> 0, but actual is "+level))})],DeviceManager.prototype,"setHardwareScaling",null),DeviceManager=__decorate([wd.singleton()],DeviceManager)}();wd.DeviceManager=DeviceManager,function(EDepthFunction){EDepthFunction[EDepthFunction.NEVER="NEVER"]="NEVER",EDepthFunction[EDepthFunction.ALWAYS="ALWAYS"]="ALWAYS",EDepthFunction[EDepthFunction.LESS="LESS"]="LESS",EDepthFunction[EDepthFunction.LEQUAL="LEQUAL"]="LEQUAL",EDepthFunction[EDepthFunction.EQUAL="EQUAL"]="EQUAL",EDepthFunction[EDepthFunction.GEQUAL="GEQUAL"]="GEQUAL",EDepthFunction[EDepthFunction.GREATER="GREATER"]="GREATER",EDepthFunction[EDepthFunction.NOTEQUAL="NOTEQUAL"]="NOTEQUAL"}(wd.EDepthFunction||(wd.EDepthFunction={}));wd.EDepthFunction;!function(ESide){ESide[ESide.NONE=0]="NONE",ESide[ESide.BOTH=1]="BOTH",ESide[ESide.BACK=2]="BACK",ESide[ESide.FRONT=3]="FRONT"}(wd.ESide||(wd.ESide={}));var ESide=wd.ESide;!function(EPolygonOffsetMode){EPolygonOffsetMode[EPolygonOffsetMode.NONE=0]="NONE",EPolygonOffsetMode[EPolygonOffsetMode.IN=1]="IN",EPolygonOffsetMode[EPolygonOffsetMode.OUT=2]="OUT",EPolygonOffsetMode[EPolygonOffsetMode.CUSTOM=3]="CUSTOM"}(wd.EPolygonOffsetMode||(wd.EPolygonOffsetMode={}));var EPolygonOffsetMode=wd.EPolygonOffsetMode;!function(EBlendFunc){EBlendFunc[EBlendFunc.ZERO="ZEOR"]="ZERO",EBlendFunc[EBlendFunc.ONE="ONE"]="ONE",EBlendFunc[EBlendFunc.SRC_COLOR="SRC_COLOR"]="SRC_COLOR",EBlendFunc[EBlendFunc.ONE_MINUS_SRC_COLOR="ONE_MINUS_SRC_COLOR"]="ONE_MINUS_SRC_COLOR",EBlendFunc[EBlendFunc.DST_COLOR="DST_COLOR"]="DST_COLOR",EBlendFunc[EBlendFunc.ONE_MINUS_DST_COLOR="ONE_MINUS_DST_COLOR"]="ONE_MINUS_DST_COLOR",EBlendFunc[EBlendFunc.SRC_ALPHA="SRC_ALPHA"]="SRC_ALPHA",EBlendFunc[EBlendFunc.SRC_ALPHA_SATURATE="SRC_ALPHA_SATURATE"]="SRC_ALPHA_SATURATE",EBlendFunc[EBlendFunc.ONE_MINUS_SRC_ALPHA="ONE_MINUS_SRC_ALPHA"]="ONE_MINUS_SRC_ALPHA",EBlendFunc[EBlendFunc.DST_ALPHA="DST_ALPHA"]="DST_ALPHA",EBlendFunc[EBlendFunc.ONE_MINUS_DST_ALPH="ONE_MINUS_DST_ALPHA"]="ONE_MINUS_DST_ALPH"}(wd.EBlendFunc||(wd.EBlendFunc={}));wd.EBlendFunc;!function(EBlendEquation){EBlendEquation[EBlendEquation.ADD="FUNC_ADD"]="ADD",EBlendEquation[EBlendEquation.SUBTRACT="FUNC_SUBTRACT"]="SUBTRACT",EBlendEquation[EBlendEquation.REVERSE_SUBTRAC="FUNC_REVERSE_SUBTRACT"]="REVERSE_SUBTRAC"}(wd.EBlendEquation||(wd.EBlendEquation={}));wd.EBlendEquation;!function(EBlendType){EBlendType[EBlendType.NONE=0]="NONE",EBlendType[EBlendType.NORMAL=1]="NORMAL",EBlendType[EBlendType.ADDITIVE=2]="ADDITIVE",EBlendType[EBlendType.ADDITIVEALPHA=3]="ADDITIVEALPHA",EBlendType[EBlendType.MULTIPLICATIVE=4]="MULTIPLICATIVE",EBlendType[EBlendType.PREMULTIPLIED=5]="PREMULTIPLIED"}(wd.EBlendType||(wd.EBlendType={}));wd.EBlendType;!function(ECanvasType){ECanvasType[ECanvasType.TwoDUI="TwoDUI"]="TwoDUI"}(wd.ECanvasType||(wd.ECanvasType={}));wd.ECanvasType}(wd||(wd={}));var wd;!function(wd){var GPUDetector=function(){function GPUDetector(){this.maxTextureUnit=null,this.maxTextureSize=null,this.maxCubemapTextureSize=null,this.maxAnisotropy=null,this.extensionCompressedTextureS3TC=null,this.extensionTextureFilterAnisotropic=null,this.extensionInstancedArrays=null,this.extensionUintIndices=null,this.extensionDepthTexture=null,this.extensionVAO=null,this.extensionStandardDerivatives=null,this.precision=null,this._isDetected=!1}return GPUDetector.getInstance=function(){},Object.defineProperty(GPUDetector.prototype,"gl",{get:function(){return wd.DeviceManager.getInstance().gl},enumerable:!0,configurable:!0}),GPUDetector.prototype.detect=function(){this._isDetected=!0,this._detectExtension(),this._detectCapabilty()},GPUDetector.prototype._detectExtension=function(){this.extensionCompressedTextureS3TC=this._getExtension("WEBGL_compressed_texture_s3tc"),this.extensionTextureFilterAnisotropic=this._getExtension("EXT_texture_filter_anisotropic"),this.extensionInstancedArrays=this._getExtension("ANGLE_instanced_arrays"),this.extensionUintIndices=this._getExtension("element_index_uint"),this.extensionDepthTexture=this._getExtension("depth_texture"),this.extensionVAO=this._getExtension("vao"),this.extensionStandardDerivatives=this._getExtension("standard_derivatives")},GPUDetector.prototype._detectCapabilty=function(){var gl=this.gl;this.maxTextureUnit=gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=gl.getParameter(gl.MAX_TEXTURE_SIZE),this.maxCubemapTextureSize=gl.getParameter(gl.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxAnisotropy=this._getMaxAnisotropy(),this._detectPrecision()},GPUDetector.prototype._getExtension=function(name){var extension,gl=this.gl;switch(name){case"EXT_texture_filter_anisotropic":extension=gl.getExtension("EXT_texture_filter_anisotropic")||gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":extension=gl.getExtension("WEBGL_compressed_texture_s3tc")||gl.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":extension=gl.getExtension("WEBGL_compressed_texture_pvrtc")||gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"ANGLE_instanced_arrays":extension=gl.getExtension("ANGLE_instanced_arrays");break;case"element_index_uint":extension=null!==gl.getExtension("OES_element_index_uint");break;case"depth_texture":extension=null!==gl.getExtension("WEBKIT_WEBGL_depth_texture")||null!==gl.getExtension("WEBGL_depth_texture");break;case"vao":extension=gl.getExtension("OES_vertex_array_object");break;case"standard_derivatives":extension=gl.getExtension("OES_standard_derivatives");break;default:extension=gl.getExtension(name)}return extension},GPUDetector.prototype._getMaxAnisotropy=function(){var extension=this.extensionTextureFilterAnisotropic,gl=this.gl;return null!==extension?gl.getParameter(extension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0},GPUDetector.prototype._detectPrecision=function(){var gl=this.gl,vertexShaderPrecisionHighpFloat=gl.getShaderPrecisionFormat(gl.VERTEX_SHADER,gl.HIGH_FLOAT),vertexShaderPrecisionMediumpFloat=gl.getShaderPrecisionFormat(gl.VERTEX_SHADER,gl.MEDIUM_FLOAT),fragmentShaderPrecisionHighpFloat=gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER,gl.HIGH_FLOAT),fragmentShaderPrecisionMediumpFloat=gl.getShaderPrecisionFormat(gl.FRAGMENT_SHADER,gl.MEDIUM_FLOAT),highpAvailable=vertexShaderPrecisionHighpFloat.precision>0&&fragmentShaderPrecisionHighpFloat.precision>0,mediumpAvailable=vertexShaderPrecisionMediumpFloat.precision>0&&fragmentShaderPrecisionMediumpFloat.precision>0;highpAvailable?this.precision=EGPUPrecision.HIGHP:mediumpAvailable?(this.precision=EGPUPrecision.MEDIUMP,wd.Log.warn(wd.Log.info.FUNC_NOT_SUPPORT("gpu","highp, using mediump"))):(this.precision=EGPUPrecision.LOWP,wd.Log.warn(wd.Log.info.FUNC_NOT_SUPPORT("gpu","highp and mediump, using lowp")))},GPUDetector=__decorate([wd.singleton()],GPUDetector)}();wd.GPUDetector=GPUDetector,function(EGPUPrecision){EGPUPrecision[EGPUPrecision.HIGHP=0]="HIGHP",EGPUPrecision[EGPUPrecision.MEDIUMP=1]="MEDIUMP",EGPUPrecision[EGPUPrecision.LOWP=2]="LOWP"}(wd.EGPUPrecision||(wd.EGPUPrecision={}));var EGPUPrecision=wd.EGPUPrecision}(wd||(wd={}));var wd;!function(wd){!function(EScreenSize){EScreenSize[EScreenSize.FULL=0]="FULL"}(wd.EScreenSize||(wd.EScreenSize={}));wd.EScreenSize}(wd||(wd={}));var wd;!function(wd){var Point=function(){function Point(x,y){void 0===x&&(x=null),void 0===y&&(y=null),this.x=null,this.y=null,this.x=x,this.y=y}return Point.create=function(x,y){void 0===x&&(x=null),void 0===y&&(y=null);var obj=new this(x,y);return obj},Point}();wd.Point=Point}(wd||(wd={}));var wd;!function(wd){var Face3=function(){function Face3(aIndex,bIndex,cIndex,faceNormal,vertexNormals){this._faceNormal=null,this.aIndex=null,this.bIndex=null,this.cIndex=null,this.vertexNormals=null,this.aIndex=aIndex,this.bIndex=bIndex,this.cIndex=cIndex,this._faceNormal=faceNormal,this.vertexNormals=vertexNormals}return Face3.create=function(aIndex,bIndex,cIndex,faceNormal,vertexNormals){void 0===faceNormal&&(faceNormal=null),void 0===vertexNormals&&(vertexNormals=wdCb.Collection.create());var obj=new this(aIndex,bIndex,cIndex,faceNormal,vertexNormals);return obj},Object.defineProperty(Face3.prototype,"faceNormal",{get:function(){return null!==this._faceNormal?this._faceNormal:wd.Vector3.create(0,0,0)},set:function(faceNormal){this._faceNormal=faceNormal},enumerable:!0,configurable:!0}),Face3.prototype.clone=function(){return wd.CloneUtils.clone(this)},Face3.prototype.hasFaceNormal=function(){return null!==this._faceNormal},Face3.prototype.hasVertexNormal=function(){return this.vertexNormals.getCount()>0},__decorate([wd.cloneAttributeAsCloneable()],Face3.prototype,"_faceNormal",void 0),__decorate([wd.cloneAttributeAsBasicType()],Face3.prototype,"aIndex",void 0),__decorate([wd.cloneAttributeAsBasicType()],Face3.prototype,"bIndex",void 0),__decorate([wd.cloneAttributeAsBasicType()],Face3.prototype,"cIndex",void 0),__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){target[memberName]=source[memberName].clone(!0)})],Face3.prototype,"vertexNormals",void 0),Face3}();wd.Face3=Face3}(wd||(wd={}));var wd;!function(wd){var RectRegion=function(_super){function RectRegion(){_super.apply(this,arguments)}return __extends(RectRegion,_super),Object.defineProperty(RectRegion.prototype,"width",{get:function(){return this.z},set:function(width){this.z=width},enumerable:!0,configurable:!0}),Object.defineProperty(RectRegion.prototype,"height",{get:function(){return this.w},set:function(height){this.w=height},enumerable:!0,configurable:!0}),RectRegion.prototype.clone=function(){return this.copyHelper(RectRegion.create())},RectRegion.prototype.isNotEmpty=function(){return 0!==this.x||0!==this.y||0!==this.width||0!==this.height},RectRegion}(wd.Vector4);wd.RectRegion=RectRegion}(wd||(wd={}));var wd;!function(wd){var ViewWebGL=function(){function ViewWebGL(dom){this._dom=null,this._dom=dom}return ViewWebGL.create=function(view){var obj=new this(view);return obj},Object.defineProperty(ViewWebGL.prototype,"offset",{get:function(){for(var view=this._dom,offset={x:view.offsetLeft,y:view.offsetTop};view=view.offsetParent;)offset.x+=view.offsetLeft,offset.y+=view.offsetTop;return offset},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"dom",{get:function(){return this._dom},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"width",{get:function(){return this._dom.clientWidth},set:function(width){this._dom.width=width},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"height",{get:function(){return this._dom.clientHeight},set:function(height){this._dom.height=height},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"styleWidth",{get:function(){return this._dom.style.width},set:function(styleWidth){this._dom.style.width=styleWidth},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"styleHeight",{get:function(){return this._dom.style.height},set:function(styleHeight){this._dom.style.height=styleHeight},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"x",{get:function(){return Number(this._dom.style.left.slice(0,-2))},set:function(x){this._dom.style.left=x+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(ViewWebGL.prototype,"y",{get:function(){return Number(this._dom.style.top.slice(0,-2))},set:function(y){this._dom.style.top=y+"px"},enumerable:!0,configurable:!0}),ViewWebGL.prototype.initCanvas=function(){this._dom.style.cssText="position:absolute;left:0;top:0;"},ViewWebGL.prototype.getContext=function(contextConfig){return this._dom.getContext("webgl",contextConfig.options)||this._dom.getContext("experimental-webgl",contextConfig.options)},ViewWebGL}();wd.ViewWebGL=ViewWebGL}(wd||(wd={}));var wd;!function(wd){var Color=function(){function Color(){this._r=null,this._g=null,this._b=null,this._a=null,this._colorString=null,this._colorVec3Cache=null,this._colorVec4Cache=null}return Color.create=function(colorVal){var obj=new this;return obj.initWhenCreate(colorVal),obj},Object.defineProperty(Color.prototype,"dirty",{set:function(dirty){dirty&&this._clearCache()},enumerable:!0,configurable:!0}),Object.defineProperty(Color.prototype,"r",{get:function(){return this._r},set:function(r){this._r!==r&&(this.dirty=!0,this._r=r)},enumerable:!0,configurable:!0}),Object.defineProperty(Color.prototype,"g",{get:function(){return this._g},set:function(g){this._g!==g&&(this.dirty=!0,this._g=g)},enumerable:!0,configurable:!0}),Object.defineProperty(Color.prototype,"b",{get:function(){return this._b},set:function(b){this._b!==b&&(this.dirty=!0,this._b=b)},enumerable:!0,configurable:!0}),Object.defineProperty(Color.prototype,"a",{get:function(){return this._a},set:function(a){this._a!==a&&(this.dirty=!0,this._a=a)},enumerable:!0,configurable:!0}),Color.prototype.initWhenCreate=function(colorVal){colorVal&&(this._colorString=colorVal,this._setColor(colorVal))},Color.prototype.toVector3=function(){return wd.Vector3.create(this.r,this.g,this.b)},Color.prototype.toVector4=function(){return wd.Vector4.create(this.r,this.g,this.b,this.a)},Color.prototype.toString=function(){return this._colorString},Color.prototype.clone=function(){return Color.create(this._colorString)},Color.prototype.isEqual=function(color){return this.r===color.r&&this.g===color.g&&this.b===color.b&&this.a===color.a},Color.prototype._setColor=function(colorVal){var REGEX_RGBA=/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*([^\)]+)\)$/i,REGEX_RGBA_2=/^rgba\((\d+\.\d+),\s*(\d+\.\d+),\s*(\d+\.\d+),\s*([^\)]+)\)$/i,REGEX_RGB=/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/i,REGEX_RGB_2=/^rgb\((\d+\.\d+),\s*(\d+\.\d+),\s*(\d+\.\d+)\)$/i,REGEX_NUM=/^\#([0-9a-f]{6})$/i,color=null;return REGEX_RGBA.test(colorVal)?(color=REGEX_RGBA.exec(colorVal),this.r=this._getColorValue(color,1),this.g=this._getColorValue(color,2),this.b=this._getColorValue(color,3),this.a=Number(color[4]),this):REGEX_RGBA_2.test(colorVal)?(color=REGEX_RGBA_2.exec(colorVal),this.r=parseFloat(color[1]),this.g=parseFloat(color[2]),this.b=parseFloat(color[3]),this.a=Number(color[4]),this):REGEX_RGB.test(colorVal)?(color=REGEX_RGB.exec(colorVal),this.r=this._getColorValue(color,1),this.g=this._getColorValue(color,2),this.b=this._getColorValue(color,3),this.a=1,this):REGEX_RGB_2.test(colorVal)?(color=REGEX_RGB_2.exec(colorVal),this.r=parseFloat(color[1]),this.g=parseFloat(color[2]),this.b=parseFloat(color[3]),this.a=1,this):REGEX_NUM.test(colorVal)?(color=REGEX_NUM.exec(colorVal),this._setHex(parseInt(color[1],16)),this):void 0},Color.prototype._getColorValue=function(color,index,num){return void 0===num&&(num=255),Math.min(num,parseInt(color[index],10))/num},Color.prototype._setHex=function(hex){
return hex=Math.floor(hex),this.r=(hex>>16&255)/255,this.g=(hex>>8&255)/255,this.b=(255&hex)/255,this.a=1,this},Color.prototype._clearCache=function(){this._colorVec3Cache=null,this._colorVec4Cache=null},__decorate([wd.ensureGetter(function(r){wd.assert(r>=0,wd.Log.info.FUNC_SHOULD("r",">= 0, but actual is "+r))})],Color.prototype,"r",null),__decorate([wd.ensureGetter(function(g){wd.assert(g>=0,wd.Log.info.FUNC_SHOULD("g",">= 0, but actual is "+g))})],Color.prototype,"g",null),__decorate([wd.ensureGetter(function(b){wd.assert(b>=0,wd.Log.info.FUNC_SHOULD("b",">= 0, but actual is "+b))})],Color.prototype,"b",null),__decorate([wd.ensureGetter(function(a){wd.assert(a>=0,wd.Log.info.FUNC_SHOULD("a",">= 0, but actual is "+a))})],Color.prototype,"a",null),__decorate([wd.cache(function(){return null!==this._colorVec3Cache},function(){return this._colorVec3Cache},function(result){this._colorVec3Cache=result})],Color.prototype,"toVector3",null),__decorate([wd.cache(function(){return null!==this._colorVec4Cache},function(){return this._colorVec4Cache},function(result){this._colorVec4Cache=result})],Color.prototype,"toVector4",null),Color}();wd.Color=Color}(wd||(wd={}));var wd;!function(wd){var Texture=function(_super){function Texture(){_super.apply(this,arguments),this.name="",this.material=null,this.width=null,this.height=null,this.variableData=null,this.wrapS=null,this.wrapT=null,this.magFilter=null,this.minFilter=null,this.glTexture=null,this.needUpdate=null,this.target=wd.ETextureTarget.TEXTURE_2D}return __extends(Texture,_super),Object.defineProperty(Texture.prototype,"geometry",{get:function(){return this.material.geometry},enumerable:!0,configurable:!0}),Texture.prototype.clone=function(){return wd.CloneUtils.clone(this)},Texture.prototype.bindToUnit=function(unit){var gl=wd.DeviceManager.getInstance().gl;if(!wd.TextureCache.isCached(unit,this))return wd.TextureCache.addActiveTexture(unit,this),gl.activeTexture(gl["TEXTURE"+String(unit)]),gl.bindTexture(gl[this.target],this.glTexture),this},Texture.prototype.sendData=function(program,name,unit){program.sendUniformData(name,this.getSamplerType(),unit)},Texture.prototype.dispose=function(){var gl=wd.DeviceManager.getInstance().gl;gl.deleteTexture(this.glTexture),delete this.glTexture,this._unBindAllUnit()},Texture.prototype.filterFallback=function(filter){return filter===wd.ETextureFilterMode.NEAREST||filter===wd.ETextureFilterMode.NEAREST_MIPMAP_MEAREST||filter===wd.ETextureFilterMode.NEAREST_MIPMAP_LINEAR?wd.ETextureFilterMode.NEAREST:wd.ETextureFilterMode.LINEAR},Texture.prototype.getSamplerNameByVariableData=function(unit,type){var samplerName=null;return this.variableData?this.variableData.samplerVariableName&&(samplerName=this.variableData.samplerVariableName):samplerName=type===wd.EVariableType.SAMPLER_2D?"u_sampler2D"+unit:"u_samplerCube"+unit,samplerName},Texture.prototype.getSamplerType=function(){var type=null;switch(this.target){case wd.ETextureTarget.TEXTURE_2D:type=wd.EVariableType.SAMPLER_2D;break;case wd.ETextureTarget.TEXTURE_CUBE_MAP:type=wd.EVariableType.SAMPLER_CUBE}return type},Texture.prototype.isSourcePowerOfTwo=function(){return wd.TextureUtils.isPowerOfTwo(this.width,this.height)},Texture.prototype.setTextureParameters=function(textureType,isSourcePowerOfTwo){var gl=wd.DeviceManager.getInstance().gl;isSourcePowerOfTwo?(gl.texParameteri(textureType,gl.TEXTURE_WRAP_S,gl[this.wrapS]),gl.texParameteri(textureType,gl.TEXTURE_WRAP_T,gl[this.wrapT]),gl.texParameteri(textureType,gl.TEXTURE_MAG_FILTER,gl[this.magFilter]),gl.texParameteri(textureType,gl.TEXTURE_MIN_FILTER,gl[this.minFilter])):(gl.texParameteri(textureType,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(textureType,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(textureType,gl.TEXTURE_MAG_FILTER,gl[this.filterFallback(this.magFilter)]),gl.texParameteri(textureType,gl.TEXTURE_MIN_FILTER,gl[this.filterFallback(this.minFilter)]))},Texture.prototype._unBindAllUnit=function(){for(var gl=wd.DeviceManager.getInstance().gl,maxTextureUnit=wd.GPUDetector.getInstance().maxTextureUnit,channel=0;channel<maxTextureUnit;channel++)gl.activeTexture(gl["TEXTURE"+channel]),gl.bindTexture(gl.TEXTURE_2D,null),gl.bindTexture(gl.TEXTURE_CUBE_MAP,null);wd.TextureCache.clearAllBindTextureUnitCache()},__decorate([wd.cloneAttributeAsBasicType()],Texture.prototype,"name",void 0),__decorate([wd.cloneAttributeAsBasicType()],Texture.prototype,"material",void 0),__decorate([wd.cloneAttributeAsBasicType()],Texture.prototype,"width",void 0),__decorate([wd.cloneAttributeAsBasicType()],Texture.prototype,"height",void 0),__decorate([wd.cloneAttributeAsBasicType()],Texture.prototype,"variableData",void 0),__decorate([wd.cloneAttributeAsBasicType()],Texture.prototype,"wrapS",void 0),__decorate([wd.cloneAttributeAsBasicType()],Texture.prototype,"wrapT",void 0),__decorate([wd.cloneAttributeAsBasicType()],Texture.prototype,"magFilter",void 0),__decorate([wd.cloneAttributeAsBasicType()],Texture.prototype,"minFilter",void 0),__decorate([wd.cloneAttributeAsBasicType()],Texture.prototype,"needUpdate",void 0),__decorate([wd.require(function(unit,texture){var maxTextureUnit=wd.GPUDetector.getInstance().maxTextureUnit;wd.assert(unit>=0,wd.Log.info.FUNC_SHOULD("texture unit",">= 0, but actual is "+unit)),wd.assert(unit<maxTextureUnit,"trying to cache "+unit+" texture units, but GPU only supports "+maxTextureUnit+" units")})],Texture.prototype,"bindToUnit",null),__decorate([wd.virtual],Texture.prototype,"isSourcePowerOfTwo",null),Texture}(wd.Entity);wd.Texture=Texture}(wd||(wd={}));var wd;!function(wd){var TextureUtils=function(){function TextureUtils(){}return TextureUtils.isPowerOfTwo=function(width,height){return wd.JudgeUtils.isPowerOfTwo(width)&&wd.JudgeUtils.isPowerOfTwo(height)},TextureUtils}();wd.TextureUtils=TextureUtils}(wd||(wd={}));var wd;!function(wd_2){var BasicTextureUtils=function(_super){function BasicTextureUtils(){_super.apply(this,arguments)}return __extends(BasicTextureUtils,_super),BasicTextureUtils.isDrawPartOfTexture=function(sourceRegion,sourceRegionMethod){return sourceRegion&&sourceRegion.isNotEmpty()&&sourceRegionMethod===wd_2.ETextureSourceRegionMethod.DRAW_IN_CANVAS},BasicTextureUtils.drawPartOfTextureByCanvas=function(source,canvasWidth,canvasHeight,sx,sy,sWidth,sHeight,dx,wd,dWidth,dHeight){var canvas=wdCb.DomQuery.create("<canvas></canvas>").get(0),ctx=null;return canvas.width=canvasWidth,canvas.height=canvasHeight,ctx=canvas.getContext("2d"),ctx.drawImage(source,sx,sy,sWidth,sHeight,dx,wd,dWidth,dHeight),canvas},BasicTextureUtils.isSourcePowerOfTwo=function(sourceRegion,sourceRegionMethod,width,height){return this.isDrawPartOfTexture(sourceRegion,sourceRegionMethod)?this.isPowerOfTwo(sourceRegion.width,sourceRegion.height):this.isPowerOfTwo(width,height)},BasicTextureUtils.needClampMaxSize=function(maxSize,width,height){return width>maxSize||height>maxSize},BasicTextureUtils.clampToMaxSize=function(source,maxSize){var maxDimension=null,newWidth=null,newHeight=null,canvas=null;return maxDimension=Math.max(source.width,source.height),newWidth=Math.floor(source.width*maxSize/maxDimension),newHeight=Math.floor(source.height*maxSize/maxDimension),canvas=this.drawPartOfTextureByCanvas(source,newWidth,newHeight,0,0,source.width,source.height,0,0,newWidth,newHeight),wd_2.Log.log("source is too big (width:"+source.width+", height:"+source.height+"), resize it to be width:"+canvas.width+", height:"+canvas.height+"."),canvas},BasicTextureUtils}(wd_2.TextureUtils);wd_2.BasicTextureUtils=BasicTextureUtils}(wd||(wd={}));var wd;!function(wd){var RenderTargetTexture=function(_super){function RenderTargetTexture(){_super.apply(this,arguments),this._renderRate=1}return __extends(RenderTargetTexture,_super),Object.defineProperty(RenderTargetTexture.prototype,"renderRate",{get:function(){return this._renderRate},set:function(renderRate){this._renderRate=renderRate},enumerable:!0,configurable:!0}),RenderTargetTexture.prototype.initWhenCreate=function(){this.needUpdate=!1,this.minFilter=wd.ETextureFilterMode.LINEAR,this.magFilter=wd.ETextureFilterMode.LINEAR,this.wrapS=wd.ETextureWrapMode.CLAMP_TO_EDGE,this.wrapT=wd.ETextureWrapMode.CLAMP_TO_EDGE},RenderTargetTexture.prototype.init=function(){},RenderTargetTexture.prototype.update=function(){},RenderTargetTexture.prototype.getPosition=function(){return this.geometry.entityObject.transform.position},RenderTargetTexture.prototype.setEmptyTexture=function(texture){var gl=wd.DeviceManager.getInstance().gl;gl.bindTexture(gl[this.target],texture),this.setTextureParameters(gl[this.target],this.isSourcePowerOfTwo())},__decorate([wd.require(function(texture){wd.assert(!!texture,wd.Log.info.FUNC_NOT_EXIST("texture object"))})],RenderTargetTexture.prototype,"setEmptyTexture",null),RenderTargetTexture}(wd.Texture);wd.RenderTargetTexture=RenderTargetTexture}(wd||(wd={}));var wd;!function(wd){var TwoDRenderTargetTexture=function(_super){function TwoDRenderTargetTexture(){_super.apply(this,arguments),this._renderList=null}return __extends(TwoDRenderTargetTexture,_super),Object.defineProperty(TwoDRenderTargetTexture.prototype,"renderList",{get:function(){return this._renderList},set:function(renderList){wd.JudgeUtils.isArrayExactly(renderList)?this._renderList=wdCb.Collection.create(renderList):this._renderList=renderList},enumerable:!0,configurable:!0}),TwoDRenderTargetTexture.prototype.initWhenCreate=function(){_super.prototype.initWhenCreate.call(this),this.width=256,this.height=256},TwoDRenderTargetTexture.prototype.createEmptyTexture=function(){var gl=wd.DeviceManager.getInstance().gl,texture=gl.createTexture();this.setEmptyTexture(texture),this.texImageEmpty(),this.glTexture=texture},TwoDRenderTargetTexture.prototype.texImageEmpty=function(){var gl=wd.DeviceManager.getInstance().gl;gl.texImage2D(gl[this.target],0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null)},__decorate([wd.requireSetter(function(renderList){wd.assert(wd.JudgeUtils.isArrayExactly(renderList)||wd.JudgeUtils.isCollection(renderList),wd.Log.info.FUNC_MUST_BE("renderList","array or collection"))}),wd.cloneAttributeAsCloneable()],TwoDRenderTargetTexture.prototype,"renderList",null),__decorate([wd.virtual],TwoDRenderTargetTexture.prototype,"texImageEmpty",null),TwoDRenderTargetTexture}(wd.RenderTargetTexture);wd.TwoDRenderTargetTexture=TwoDRenderTargetTexture}(wd||(wd={}));var wd;!function(wd){var ShadowMapTextureUtils=function(){function ShadowMapTextureUtils(){}return ShadowMapTextureUtils.setTextureParameters=function(textureType){var gl=wd.DeviceManager.getInstance().gl,scene=wd.Director.getInstance().scene;scene.shadowMap.softType===wd.EShadowMapSoftType.PCF&&(gl.texParameteri(textureType,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(textureType,gl.TEXTURE_MIN_FILTER,gl.NEAREST))},ShadowMapTextureUtils}();wd.ShadowMapTextureUtils=ShadowMapTextureUtils}(wd||(wd={}));var wd;!function(wd){var LightEffectTexture=function(_super){function LightEffectTexture(){_super.apply(this,arguments),this._plane=null}return __extends(LightEffectTexture,_super),LightEffectTexture.prototype.getSamplerName=function(unit){return this.getSamplerNameByVariableData(unit,wd.EVariableType.SAMPLER_2D)},LightEffectTexture.prototype.getPlane=function(){var normalData=null,normal=null,p=null;return this._plane&&!this.geometry.entityObject.transform.dirtyLocal?this._plane:(wd.Log.error(!(this.geometry instanceof wd.PlaneGeometry),wd.Log.info.FUNC_MUST_BE("geometry","PlaneGeometry")),normalData=this.geometry.geometryData.normals,normal=this.geometry.entityObject.transform.localRotation.multiplyVector3(wd.Vector3.create(normalData[0],normalData[1],normalData[2])).normalize(),p=this.getPosition(),this._plane=wd.Plane.create(normal.x,normal.y,normal.z,-p.dot(normal)),this._plane)},LightEffectTexture}(wd.TwoDRenderTargetTexture);wd.LightEffectTexture=LightEffectTexture}(wd||(wd={}));var wd;!function(wd){var MirrorTexture=function(_super){function MirrorTexture(){_super.apply(this,arguments)}return __extends(MirrorTexture,_super),MirrorTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},MirrorTexture.prototype.init=function(){return _super.prototype.init.call(this),wd.Director.getInstance().scene.addCommonRenderTargetRenderer(wd.MirrorRenderTargetRenderer.create(this)),this},MirrorTexture}(wd.LightEffectTexture);wd.MirrorTexture=MirrorTexture}(wd||(wd={}));var wd;!function(wd){var RefractionTexture=function(_super){function RefractionTexture(){_super.apply(this,arguments)}return __extends(RefractionTexture,_super),RefractionTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},RefractionTexture.prototype.init=function(){return _super.prototype.init.call(this),wd.Director.getInstance().scene.addCommonRenderTargetRenderer(wd.RefractionRenderTargetRenderer.create(this)),this},RefractionTexture}(wd.LightEffectTexture);wd.RefractionTexture=RefractionTexture}(wd||(wd={}));var wd;!function(wd){var TwoDShadowMapTexture=function(_super){function TwoDShadowMapTexture(){_super.apply(this,arguments)}return __extends(TwoDShadowMapTexture,_super),TwoDShadowMapTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},TwoDShadowMapTexture.prototype.getSamplerName=function(unit){return"u_twoDShadowMapSampler["+this.variableData.samplerData+"]"},TwoDShadowMapTexture.prototype.setTextureParameters=function(textureType,isSourcePowerOfTwo){_super.prototype.setTextureParameters.call(this,textureType,isSourcePowerOfTwo),wd.ShadowMapTextureUtils.setTextureParameters(textureType)},TwoDShadowMapTexture.prototype.texImageEmpty=function(){if(wd.GPUDetector.getInstance().extensionDepthTexture){var gl=wd.DeviceManager.getInstance().gl;return void gl.texImage2D(gl[this.target],0,gl.DEPTH_COMPONENT,this.width,this.height,0,gl.DEPTH_COMPONENT,gl.UNSIGNED_SHORT,null)}_super.prototype.texImageEmpty.call(this)},__decorate([wd.require(function(unit){wd.assert(wd.JudgeUtils.isNumber(this.variableData.samplerData),wd.Log.info.FUNC_MUST_BE("shadowMapTexture->variableData.samplerData","samplerIndex"))})],TwoDShadowMapTexture.prototype,"getSamplerName",null),TwoDShadowMapTexture}(wd.TwoDRenderTargetTexture);wd.TwoDShadowMapTexture=TwoDShadowMapTexture}(wd||(wd={}));var wd;!function(wd){var CubemapRenderTargetTexture=function(_super){function CubemapRenderTargetTexture(){_super.apply(this,arguments),this.target=wd.ETextureTarget.TEXTURE_CUBE_MAP}return __extends(CubemapRenderTargetTexture,_super),CubemapRenderTargetTexture.prototype.createEmptyTexture=function(){var gl=wd.DeviceManager.getInstance().gl,texture=gl.createTexture(),i=null;for(this.setEmptyTexture(texture),i=0;i<6;i++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);this.glTexture=texture},CubemapRenderTargetTexture}(wd.RenderTargetTexture);wd.CubemapRenderTargetTexture=CubemapRenderTargetTexture}(wd||(wd={}));var wd;!function(wd){var CubemapShadowMapTexture=function(_super){function CubemapShadowMapTexture(){_super.apply(this,arguments)}return __extends(CubemapShadowMapTexture,_super),CubemapShadowMapTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},CubemapShadowMapTexture.prototype.getSamplerName=function(unit){return"u_cubemapShadowMapSampler["+this.variableData.samplerData+"]"},__decorate([wd.require(function(unit){wd.assert(wd.JudgeUtils.isNumber(this.variableData.samplerData),wd.Log.info.FUNC_MUST_BE("shadowMapTexture->variableData.samplerData","samplerIndex"))})],CubemapShadowMapTexture.prototype,"getSamplerName",null),CubemapShadowMapTexture}(wd.CubemapRenderTargetTexture);wd.CubemapShadowMapTexture=CubemapShadowMapTexture}(wd||(wd={}));var wd;!function(wd){var DynamicCubemapTexture=function(_super){function DynamicCubemapTexture(){_super.apply(this,arguments),this._renderList=null,this.size=256,this.near=.1,this.far=100,this.mode=null}return __extends(DynamicCubemapTexture,_super),DynamicCubemapTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},Object.defineProperty(DynamicCubemapTexture.prototype,"renderList",{get:function(){return this._renderList},set:function(renderList){var convertedRenderList=wdCb.Hash.create();renderList instanceof wdCb.Hash||(wd.JudgeUtils.isDirectObject(renderList)?renderList=wdCb.Hash.create(renderList):wd.Log.error(!0,wd.Log.info.FUNC_MUST_BE("renderList","array or wdCb.Collection"))),renderList.forEach(function(faceRenderList,face){wd.JudgeUtils.isArrayExactly(faceRenderList)?convertedRenderList.addChild(face,wdCb.Collection.create(faceRenderList)):wd.JudgeUtils.isCollection(faceRenderList)?convertedRenderList.addChild(face,faceRenderList):wd.Log.error(!0,wd.Log.info.FUNC_MUST_BE("faceRenderList","array or wdCb.Collection"))}),this._renderList=convertedRenderList},enumerable:!0,configurable:!0}),DynamicCubemapTexture.prototype.init=function(){return _super.prototype.init.call(this),this.width=this.size,this.height=this.size,wd.Director.getInstance().scene.addCommonRenderTargetRenderer(wd.DynamicCubemapRenderTargetRenderer.create(this)),this},DynamicCubemapTexture.prototype.getSamplerName=function(unit){return this.getSamplerNameByVariableData(unit,wd.EVariableType.SAMPLER_CUBE)},__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){var result=null;null!==source[memberName]&&(result=wdCb.Hash.create(),source[memberName].forEach(function(list,key){result.addChild(key,list.clone())}),target[memberName]=result)})],DynamicCubemapTexture.prototype,"renderList",null),__decorate([wd.cloneAttributeAsBasicType()],DynamicCubemapTexture.prototype,"size",void 0),__decorate([wd.cloneAttributeAsBasicType()],DynamicCubemapTexture.prototype,"near",void 0),__decorate([wd.cloneAttributeAsBasicType()],DynamicCubemapTexture.prototype,"far",void 0),__decorate([wd.cloneAttributeAsBasicType()],DynamicCubemapTexture.prototype,"mode",void 0),DynamicCubemapTexture}(wd.CubemapRenderTargetTexture);wd.DynamicCubemapTexture=DynamicCubemapTexture}(wd||(wd={}));var wd;!function(wd){var BasicTexture=function(_super){function BasicTexture(){_super.apply(this,arguments),this.p_sourceRegionMethod=null,this._sourceRegion=null,this.generateMipmaps=null,this.format=null,this.source=null,this.repeatRegion=null,this.sourceRegionMapping=null,this.packAlignment=null,this.unpackAlignment=null,this.flipY=null,this.premultiplyAlpha=null,this.colorspaceConversion=null,this.type=null,this.mipmaps=null,this.anisotropy=null,this._sourceRegionDirty=!1,this._sourceRegionForGLSLCache=null}return __extends(BasicTexture,_super),Object.defineProperty(BasicTexture.prototype,"sourceRegionMethod",{get:function(){return this.p_sourceRegionMethod},set:function(sourceRegionMethod){this.p_sourceRegionMethod=sourceRegionMethod},enumerable:!0,configurable:!0}),Object.defineProperty(BasicTexture.prototype,"sourceRegion",{get:function(){return this._sourceRegion},set:function(sourceRegion){this._sourceRegion=sourceRegion,this._sourceRegionDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(BasicTexture.prototype,"sourceRegionForGLSL",{get:function(){return this.sourceRegion&&this.sourceRegionMethod===wd.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL?this._convertSourceRegionToUV(this.sourceRegion):wd.RectRegion.create(0,0,1,1)},enumerable:!0,configurable:!0}),BasicTexture.prototype.initWhenCreate=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];var gl=wd.DeviceManager.getInstance().gl;this.glTexture=gl.createTexture(),this.needUpdate=!0},BasicTexture.prototype.init=function(){},BasicTexture.prototype.dispose=function(){_super.prototype.dispose.call(this),this._sourceRegionForGLSLCache=null},BasicTexture.prototype.update=function(){var gl=wd.DeviceManager.getInstance().gl,isSourcePowerOfTwo=this.isSourcePowerOfTwo();return gl.pixelStorei(gl.PACK_ALIGNMENT,this.packAlignment),gl.pixelStorei(gl.UNPACK_ALIGNMENT,this.unpackAlignment),gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,this.flipY),gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),gl.pixelStorei(gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this.colorspaceConversion),this.needClampMaxSize()&&(this.clampToMaxSize(),isSourcePowerOfTwo=this.isSourcePowerOfTwo(),isSourcePowerOfTwo||wd.Log.warn("texture size is not power of two after clampToMaxSize()")),this.setTextureParameters(gl[this.target],isSourcePowerOfTwo),this.allocateSourceToTexture(isSourcePowerOfTwo),this.generateMipmaps&&isSourcePowerOfTwo&&gl.generateMipmap(gl[this.target]),this.needUpdate=!1,this},BasicTexture.prototype.getSamplerName=function(unit){return this.getSamplerNameByVariableData(unit,wd.EVariableType.SAMPLER_2D)},BasicTexture.prototype.needClampMaxSize=function(){return!!this.source&&wd.BasicTextureUtils.needClampMaxSize(wd.GPUDetector.getInstance().maxTextureSize,this.source.width,this.source.height)},BasicTexture.prototype.clampToMaxSize=function(){this.source=wd.BasicTextureUtils.clampToMaxSize(this.source,wd.GPUDetector.getInstance().maxTextureSize)},BasicTexture.prototype.setTextureParameters=function(textureType,isSourcePowerOfTwo){_super.prototype.setTextureParameters.call(this,textureType,isSourcePowerOfTwo),this._setAnisotropy(textureType)},BasicTexture.prototype.isSourcePowerOfTwo=function(){return wd.BasicTextureUtils.isSourcePowerOfTwo(this.sourceRegion,this.sourceRegionMethod,this.width,this.height)},BasicTexture.prototype._setAnisotropy=function(textureType){var gpu=wd.GPUDetector.getInstance(),gl=wd.DeviceManager.getInstance().gl;gpu.extensionTextureFilterAnisotropic&&this.anisotropy>1&&gl.texParameterf(textureType,gpu.extensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(this.anisotropy,gpu.maxAnisotropy))},BasicTexture.prototype._convertSourceRegionCanvasMapToUV=function(sourceRegion){var width=this.width,height=this.height,region=null;return region=wd.RectRegion.create(sourceRegion.x/width,sourceRegion.y/height,sourceRegion.width/width,sourceRegion.height/height),region.y=1-region.y-region.height,region},BasicTexture.prototype._convertSourceRegionToUV=function(sourceRegion){return this.sourceRegionMapping===wd.ETextureSourceRegionMapping.CANVAS?this._convertSourceRegionCanvasMapToUV(sourceRegion):this.sourceRegionMapping===wd.ETextureSourceRegionMapping.UV?sourceRegion:void 0},__decorate([wd.cloneAttributeAsBasicType()],BasicTexture.prototype,"sourceRegionMethod",null),__decorate([wd.cloneAttributeAsCloneable()],BasicTexture.prototype,"sourceRegion",null),__decorate([wd.cacheGetter(function(){return!this._sourceRegionDirty&&null!==this._sourceRegionForGLSLCache},function(){return this._sourceRegionForGLSLCache},function(result){this._sourceRegionForGLSLCache=result,this._sourceRegionDirty=!1})],BasicTexture.prototype,"sourceRegionForGLSL",null),__decorate([wd.cloneAttributeAsBasicType()],BasicTexture.prototype,"generateMipmaps",void 0),__decorate([wd.cloneAttributeAsBasicType()],BasicTexture.prototype,"format",void 0),__decorate([wd.cloneAttributeAsBasicType()],BasicTexture.prototype,"source",void 0),__decorate([wd.cloneAttributeAsCloneable()],BasicTexture.prototype,"repeatRegion",void 0),__decorate([wd.cloneAttributeAsBasicType()],BasicTexture.prototype,"sourceRegionMapping",void 0),__decorate([wd.cloneAttributeAsBasicType()],BasicTexture.prototype,"packAlignment",void 0),__decorate([wd.cloneAttributeAsBasicType()],BasicTexture.prototype,"unpackAlignment",void 0),__decorate([wd.cloneAttributeAsBasicType()],BasicTexture.prototype,"flipY",void 0),__decorate([wd.cloneAttributeAsBasicType()],BasicTexture.prototype,"premultiplyAlpha",void 0),__decorate([wd.cloneAttributeAsBasicType()],BasicTexture.prototype,"colorspaceConversion",void 0),__decorate([wd.cloneAttributeAsBasicType()],BasicTexture.prototype,"type",void 0),__decorate([wd.cloneAttributeAsCloneable()],BasicTexture.prototype,"mipmaps",void 0),__decorate([wd.cloneAttributeAsBasicType()],BasicTexture.prototype,"anisotropy",void 0),__decorate([wd.virtual],BasicTexture.prototype,"needClampMaxSize",null),BasicTexture}(wd.Texture);wd.BasicTexture=BasicTexture}(wd||(wd={}));var wd;!function(wd){var TwoDTexture=function(_super){function TwoDTexture(asset){_super.call(this),this.asset=null,this.asset=asset}return __extends(TwoDTexture,_super),TwoDTexture.prototype.clone=function(){return wd.CloneUtils.clone(this,null,[this.asset])},TwoDTexture.prototype.initWhenCreate=function(){_super.prototype.initWhenCreate.call(this),this.asset.cloneTo(this)},TwoDTexture}(wd.BasicTexture);wd.TwoDTexture=TwoDTexture}(wd||(wd={}));var wd;!function(wd){var CommonTexture=function(_super){function CommonTexture(){_super.apply(this,arguments)}return __extends(CommonTexture,_super),CommonTexture.prototype.allocateSourceToTexture=function(isSourcePowerOfTwo){var mipmapCmd=null,noMipmapCmd=null,gl=wd.DeviceManager.getInstance().gl;isSourcePowerOfTwo&&this.mipmaps.getCount()>0?(mipmapCmd=wd.DrawMipmapTwoDTextureCommand.create(),mipmapCmd.mipmaps=this.mipmaps,mipmapCmd.format=this.format,mipmapCmd.type=this.type,mipmapCmd.sourceRegion=this.sourceRegion,mipmapCmd.sourceRegionMethod=this.sourceRegionMethod,mipmapCmd.glTarget=gl.TEXTURE_2D,mipmapCmd.execute(),this.generateMipmaps=!1):(noMipmapCmd=wd.DrawNoMipmapTwoDTextureCommand.create(),noMipmapCmd.source=this.source,noMipmapCmd.format=this.format,noMipmapCmd.type=this.type,noMipmapCmd.sourceRegion=this.sourceRegion,noMipmapCmd.sourceRegionMethod=this.sourceRegionMethod,noMipmapCmd.glTarget=gl.TEXTURE_2D,noMipmapCmd.execute())},CommonTexture}(wd.TwoDTexture);wd.CommonTexture=CommonTexture}(wd||(wd={}));var wd;!function(wd){var ImageTexture=function(_super){function ImageTexture(arg){if(arg instanceof wd.ImageTextureAsset){var asset=arg;_super.call(this,asset)}else{var canvas=arg;_super.call(this,wd.ImageTextureAsset.create(canvas))}}return __extends(ImageTexture,_super),ImageTexture.create=function(arg){var obj=new this(arg);return obj.initWhenCreate(),obj},ImageTexture}(wd.CommonTexture);wd.ImageTexture=ImageTexture}(wd||(wd={}));var wd;!function(wd){var VideoTexture=function(_super){function VideoTexture(){_super.apply(this,arguments),this._video=null,this._startLoopSubscription=null}return __extends(VideoTexture,_super),VideoTexture.create=function(asset){var obj=new this(asset);return obj.initWhenCreate(),obj},VideoTexture.prototype.initWhenCreate=function(){_super.prototype.initWhenCreate.call(this),this._video=this.asset.video},VideoTexture.prototype.init=function(){var self=this;return _super.prototype.init.call(this),this._startLoopSubscription=wd.EventManager.fromEvent(wd.EEngineEvent.STARTLOOP).subscribe(function(){self._video.isStop?self.needUpdate=!1:self.needUpdate=!0}),this},VideoTexture.prototype.dispose=function(){this._startLoopSubscription&&this._startLoopSubscription.dispose()},VideoTexture.prototype.needClampMaxSize=function(){return!1},VideoTexture}(wd.CommonTexture);wd.VideoTexture=VideoTexture}(wd||(wd={}));var wd;!function(wd){var CubemapTexture=function(_super){function CubemapTexture(assets){_super.call(this),this.assets=null,this.textures=wdCb.Collection.create(),this.mode=null,this.target=wd.ETextureTarget.TEXTURE_CUBE_MAP,this._areAllCompressedAsset=!1,this.assets=assets}return __extends(CubemapTexture,_super),CubemapTexture.create=function(assets){var obj=new this(assets);return obj.initWhenCreate(assets),obj},CubemapTexture.prototype.clone=function(){var resultAssets=null;return resultAssets=null!==this.assets?[].concat(this.assets):null,wd.CloneUtils.clone(this,null,[resultAssets])},CubemapTexture.prototype.initWhenCreate=function(assets){_super.prototype.initWhenCreate.call(this),this._areAssetsAllCompressedAsset(assets)?this._areAllCompressedAsset=!0:this._areAllCompressedAsset=!1,this._createTextures(assets),this._getRepresentAsset(assets).cloneToCubemapTexture(this),this._areAllCompressedAsset?(this.generateMipmaps=!1,this._hasNoMipmapCompressedAsset()&&(this.minFilter=this.filterFallback(this.minFilter))):this.generateMipmaps=!0,this.flipY=!1},CubemapTexture.prototype.getSamplerName=function(unit){return this.getSamplerNameByVariableData(unit,wd.EVariableType.SAMPLER_CUBE)},CubemapTexture.prototype.allocateSourceToTexture=function(isSourcePowerOfTwo){this._areAllCompressedAsset?this.textures.forEach(function(texture,i){texture.draw(i)}):this.textures.forEach(function(texture,i){texture.draw(i)})},CubemapTexture.prototype.needClampMaxSize=function(){var needAllClampMaxSize=!1;return this.textures.forEach(function(texture){if(texture.needClampMaxSize())return needAllClampMaxSize=!0,wdCb.$BREAK}),needAllClampMaxSize},CubemapTexture.prototype.isSourcePowerOfTwo=function(){var areAllSourcePowerOfTwo=!0;return this.textures.forEach(function(texture){if(!texture.isSourcePowerOfTwo())return areAllSourcePowerOfTwo=!1,wdCb.$BREAK}),areAllSourcePowerOfTwo},CubemapTexture.prototype.clampToMaxSize=function(){this.textures.forEach(function(texture){texture.clampToMaxSize()})},CubemapTexture.prototype._hasNoMipmapCompressedAsset=function(){var self=this;return!!this._areAllCompressedAsset&&this.textures.filter(function(texture){return!self._isMipmapFilter(texture.minFilter)}).getCount()>0},CubemapTexture.prototype._isMipmapFilter=function(filter){return filter===wd.ETextureFilterMode.LINEAR_MIPMAP_LINEAR||filter===wd.ETextureFilterMode.LINEAR_MIPMAP_NEAREST||filter===wd.ETextureFilterMode.NEAREST_MIPMAP_LINEAR||filter===wd.ETextureFilterMode.NEAREST_MIPMAP_MEAREST},CubemapTexture.prototype._getRepresentAsset=function(assets){return assets[0].asset},CubemapTexture.prototype._areAssetsAllImageAssets=function(assets){for(var areImageAssets=[],_i=0,assets_1=assets;_i<assets_1.length;_i++){var data=assets_1[_i];data.asset instanceof wd.ImageTextureAsset&&areImageAssets.push(data)}return 6===areImageAssets.length},CubemapTexture.prototype._areAssetsAllCompressedAsset=function(assets){for(var areCompressedAssets=[],_i=0,assets_2=assets;_i<assets_2.length;_i++){var data=assets_2[_i];data.asset instanceof wd.CompressedTextureAsset&&areCompressedAssets.push(data)}return 6===areCompressedAssets.length},CubemapTexture.prototype._createTextures=function(assets){for(var self=this,_i=0,assets_3=assets;_i<assets_3.length;_i++){var data=assets_3[_i],face=data.asset.toCubemapFaceTexture();if(data.sourceRegion&&face instanceof wd.CubemapFaceImageTexture){var twoDFace=face;twoDFace.sourceRegion=data.sourceRegion}data.type&&(face.type=data.type),self.textures.addChild(face)}},CubemapTexture.prototype._areTextureSizOfAllFaceseEqual=function(assets){for(var textureWidthSizeArr=[],textureHeightSizeArr=[],_i=0,assets_4=assets;_i<assets_4.length;_i++){var data=assets_4[_i];data.sourceRegion?(textureWidthSizeArr.push(data.sourceRegion.width),textureHeightSizeArr.push(data.sourceRegion.height)):(textureWidthSizeArr.push(data.asset.width),textureHeightSizeArr.push(data.asset.height))}return this._areAllElementsEqual(textureWidthSizeArr)&&this._areAllElementsEqual(textureHeightSizeArr)},CubemapTexture.prototype._hasSourceRegion=function(assets){for(var _i=0,assets_5=assets;_i<assets_5.length;_i++){var data=assets_5[_i];if(data.sourceRegion)return!0}return!1},CubemapTexture.prototype._areAllElementsEqual=function(arr){for(var lastEle=arr[0],_i=0,arr_3=arr;_i<arr_3.length;_i++){var ele=arr_3[_i];if(ele!==lastEle)return!1}return!0},__decorate([wd.cloneAttributeAsBasicType()],CubemapTexture.prototype,"mode",void 0),__decorate([wd.require(function(assets){wd.assert(6===assets.length,wd.Log.info.FUNC_MUST("cubemap","has 6 assets")),wd.assert(this._areAssetsAllImageAssets(assets)||this._areAssetsAllCompressedAsset(assets),wd.Log.info.FUNC_MUST_BE("cubemap six face's assets","all ImageTextureAsset or all CompressedTextureAsset")),this._areAssetsAllCompressedAsset(assets)&&wd.assert(!this._hasSourceRegion(assets),wd.Log.info.FUNC_SHOULD_NOT("compressed face","contain sourceRegion data")),wd.assert(this._areTextureSizOfAllFaceseEqual(assets),wd.Log.info.FUNC_MUST_BE("all cubemap faces' texture size","equal"))})],CubemapTexture.prototype,"initWhenCreate",null),
CubemapTexture}(wd.BasicTexture);wd.CubemapTexture=CubemapTexture}(wd||(wd={}));var wd;!function(wd){var CubemapFaceTexture=function(){function CubemapFaceTexture(){this.type=wd.ETextureType.UNSIGNED_BYTE,this.format=null,this.width=null,this.height=null}return CubemapFaceTexture}();wd.CubemapFaceTexture=CubemapFaceTexture}(wd||(wd={}));var wd;!function(wd){var CubemapFaceImageTexture=function(_super){function CubemapFaceImageTexture(){_super.apply(this,arguments),this.sourceRegion=null,this.source=null}return __extends(CubemapFaceImageTexture,_super),CubemapFaceImageTexture.create=function(asset){var obj=new this;return obj.initWhenCreate(asset),obj},Object.defineProperty(CubemapFaceImageTexture.prototype,"sourceRegionMethod",{get:function(){return wd.ETextureSourceRegionMethod.DRAW_IN_CANVAS},set:function(sourceRegionMethod){},enumerable:!0,configurable:!0}),CubemapFaceImageTexture.prototype.initWhenCreate=function(asset){asset.cloneToCubemapFaceTexture(this)},CubemapFaceImageTexture.prototype.isSourcePowerOfTwo=function(){return wd.BasicTextureUtils.isSourcePowerOfTwo(this.sourceRegion,this.sourceRegionMethod,this.width,this.height)},CubemapFaceImageTexture.prototype.needClampMaxSize=function(){return!!this.source&&wd.BasicTextureUtils.needClampMaxSize(wd.GPUDetector.getInstance().maxCubemapTextureSize,this.source.width,this.source.height)},CubemapFaceImageTexture.prototype.clampToMaxSize=function(){var maxSize=wd.GPUDetector.getInstance().maxCubemapTextureSize;this.source=wd.BasicTextureUtils.clampToMaxSize(this.source,maxSize)},CubemapFaceImageTexture.prototype.draw=function(index){var noMipmapCmd=wd.DrawNoMipmapTwoDTextureCommand.create(),gl=wd.DeviceManager.getInstance().gl;noMipmapCmd.source=this.source,noMipmapCmd.sourceRegion=this.sourceRegion,noMipmapCmd.sourceRegionMethod=this.sourceRegionMethod,noMipmapCmd.glTarget=gl.TEXTURE_CUBE_MAP_POSITIVE_X+index,noMipmapCmd.format=this.format,noMipmapCmd.type=this.type,noMipmapCmd.execute()},__decorate([wd.requireSetter(function(sourceRegionMethod){wd.assert(sourceRegionMethod===wd.ETextureSourceRegionMethod.DRAW_IN_CANVAS,wd.Log.info.FUNC_SUPPORT("cubemap twoD face texture->sourceRegionMethod only","DRAW_IN_CANVAS"))})],CubemapFaceImageTexture.prototype,"sourceRegionMethod",null),CubemapFaceImageTexture}(wd.CubemapFaceTexture);wd.CubemapFaceImageTexture=CubemapFaceImageTexture}(wd||(wd={}));var wd;!function(wd){var CubemapFaceCompressedTexture=function(_super){function CubemapFaceCompressedTexture(){_super.apply(this,arguments),this.mipmaps=null,this.minFilter=null}return __extends(CubemapFaceCompressedTexture,_super),CubemapFaceCompressedTexture.create=function(asset){var obj=new this;return obj.initWhenCreate(asset),obj},CubemapFaceCompressedTexture.prototype.initWhenCreate=function(asset){asset.cloneToCubemapFaceTexture(this)},CubemapFaceCompressedTexture.prototype.isSourcePowerOfTwo=function(){return wd.BasicTextureUtils.isSourcePowerOfTwo(null,null,this.width,this.height)},CubemapFaceCompressedTexture.prototype.needClampMaxSize=function(){return wd.BasicTextureUtils.needClampMaxSize(wd.GPUDetector.getInstance().maxCubemapTextureSize,this.width,this.height)},CubemapFaceCompressedTexture.prototype.clampToMaxSize=function(){wd.Log.warn("CubemapFaceCompressedTexture's texture size is over maxCubemapTextureSize")},CubemapFaceCompressedTexture.prototype.draw=function(index){var compressedCmd=wd.DrawCompressedTextureCommand.create(),gl=wd.DeviceManager.getInstance().gl;compressedCmd.glTarget=gl.TEXTURE_CUBE_MAP_POSITIVE_X+index,compressedCmd.type=this.type,compressedCmd.format=this.format,compressedCmd.mipmaps=this.mipmaps,compressedCmd.execute()},CubemapFaceCompressedTexture}(wd.CubemapFaceTexture);wd.CubemapFaceCompressedTexture=CubemapFaceCompressedTexture}(wd||(wd={}));var wd;!function(wd){var CompressedTexture=function(_super){function CompressedTexture(){_super.apply(this,arguments)}return __extends(CompressedTexture,_super),CompressedTexture.create=function(asset){var obj=new this(asset);return obj.initWhenCreate(),obj},Object.defineProperty(CompressedTexture.prototype,"sourceRegionMethod",{get:function(){return wd.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL},set:function(sourceRegionMethod){this.p_sourceRegionMethod=sourceRegionMethod},enumerable:!0,configurable:!0}),CompressedTexture.prototype.allocateSourceToTexture=function(isSourcePowerOfTwo){var gl=wd.DeviceManager.getInstance().gl,compressedCmd=wd.DrawCompressedTextureCommand.create();compressedCmd.glTarget=gl.TEXTURE_2D,compressedCmd.type=this.type,compressedCmd.format=this.format,compressedCmd.mipmaps=this.mipmaps,compressedCmd.sourceRegion=this.sourceRegion,compressedCmd.sourceRegionMethod=this.sourceRegionMethod,compressedCmd.execute(),this.mipmaps.getCount()>1&&(this.generateMipmaps=!1)},CompressedTexture.prototype.needClampMaxSize=function(){return!1},__decorate([wd.ensureGetter(function(sourceRegionMethod){wd.it("compressed texture not support ETextureSourceRegionMethod.DRAW_IN_CANVAS, will use ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL instead",function(){wd.expect(this.p_sourceRegionMethod).not.to.equal(wd.ETextureSourceRegionMethod.DRAW_IN_CANVAS),wd.expect(sourceRegionMethod).to.equal(wd.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL)},this)})],CompressedTexture.prototype,"sourceRegionMethod",null),CompressedTexture}(wd.TwoDTexture);wd.CompressedTexture=CompressedTexture}(wd||(wd={}));var wd;!function(wd){var DrawTextureCommand=function(){function DrawTextureCommand(){this.format=null,this.type=null,this.sourceRegion=null,this.sourceRegionMethod=wd.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL,this.glTarget=null}return DrawTextureCommand.prototype.getDrawTarget=function(source,sourceRegion){void 0===sourceRegion&&(sourceRegion=this.sourceRegion);var result=null;return result=wd.BasicTextureUtils.isDrawPartOfTexture(sourceRegion,this.sourceRegionMethod)?wd.BasicTextureUtils.drawPartOfTextureByCanvas(source,sourceRegion.width,sourceRegion.height,sourceRegion.x,sourceRegion.y,sourceRegion.width,sourceRegion.height,0,0,sourceRegion.width,sourceRegion.height):source},DrawTextureCommand}();wd.DrawTextureCommand=DrawTextureCommand}(wd||(wd={}));var wd;!function(wd){var DrawCompressedTextureCommand=function(_super){function DrawCompressedTextureCommand(){_super.apply(this,arguments),this.mipmaps=null}return __extends(DrawCompressedTextureCommand,_super),DrawCompressedTextureCommand.create=function(){var obj=new this;return obj},DrawCompressedTextureCommand.prototype.execute=function(){var gl=wd.DeviceManager.getInstance().gl,self=this;wd.Log.error(null===this.format,wd.Log.info.FUNC_NOT_SUPPORT(this.format)),this.format!==wd.ETextureFormat.RGBA?this.mipmaps.forEach(function(mipmap,index){gl.compressedTexImage2D(self.glTarget,index,self.format,mipmap.width,mipmap.height,0,self.getDrawTarget(mipmap.data))}):this.mipmaps.forEach(function(mipmap,index){gl.texImage2D(self.glTarget,index,gl[self.format],mipmap.width,mipmap.height,0,gl[self.format],gl[self.type],self.getDrawTarget(mipmap.data))})},DrawCompressedTextureCommand}(wd.DrawTextureCommand);wd.DrawCompressedTextureCommand=DrawCompressedTextureCommand}(wd||(wd={}));var wd;!function(wd){var DrawTwoDTextureCommand=function(_super){function DrawTwoDTextureCommand(){_super.apply(this,arguments),this.source=null}return __extends(DrawTwoDTextureCommand,_super),DrawTwoDTextureCommand.prototype.drawTexture=function(index,source){var gl=wd.DeviceManager.getInstance().gl;gl.texImage2D(this.glTarget,index,gl[this.format],gl[this.format],gl[this.type],this.getDrawTarget(source))},DrawTwoDTextureCommand}(wd.DrawTextureCommand);wd.DrawTwoDTextureCommand=DrawTwoDTextureCommand}(wd||(wd={}));var wd;!function(wd){var DrawMipmapTwoDTextureCommand=function(_super){function DrawMipmapTwoDTextureCommand(){_super.apply(this,arguments),this.mipmaps=null}return __extends(DrawMipmapTwoDTextureCommand,_super),DrawMipmapTwoDTextureCommand.create=function(){var obj=new this;return obj},DrawMipmapTwoDTextureCommand.prototype.execute=function(){var self=this;this.mipmaps.forEach(function(mipmap,index){self.drawTexture(index,mipmap)})},DrawMipmapTwoDTextureCommand}(wd.DrawTwoDTextureCommand);wd.DrawMipmapTwoDTextureCommand=DrawMipmapTwoDTextureCommand}(wd||(wd={}));var wd;!function(wd){var DrawNoMipmapTwoDTextureCommand=function(_super){function DrawNoMipmapTwoDTextureCommand(){_super.apply(this,arguments)}return __extends(DrawNoMipmapTwoDTextureCommand,_super),DrawNoMipmapTwoDTextureCommand.create=function(){var obj=new this;return obj},DrawNoMipmapTwoDTextureCommand.prototype.execute=function(){this.drawTexture(0,this.source)},DrawNoMipmapTwoDTextureCommand}(wd.DrawTwoDTextureCommand);wd.DrawNoMipmapTwoDTextureCommand=DrawNoMipmapTwoDTextureCommand}(wd||(wd={}));var wd;!function(wd){var Video=function(){function Video(_a){var urlArr=_a.urlArr,_b=_a.onLoad,onLoad=void 0===_b?function(video){}:_b,_c=_a.onError,onError=void 0===_c?function(err){}:_c;this.url=null,this.source=null,this.isStop=!1,this._urlArr=null,this._onLoad=null,this._onError=null,this._urlArr=wdCb.Collection.create(urlArr),this._onLoad=onLoad,this._onError=onError}return Video.create=function(data){var obj=new this(data);return obj.initWhenCreate(),obj},Video.prototype.initWhenCreate=function(){this.url=this._getCanPlayUrl(),this.source=document.createElement("video"),this.source.src=this.url,this._bindEvent()},Video.prototype.play=function(){this.isStop=!1,this.source.play()},Video.prototype._getCanPlayUrl=function(){var self=this,canPlayUrl=null,extnameArr=[];return this._urlArr.forEach(function(url){var extname=wdCb.PathUtils.extname(url);if(extnameArr.push(extname),self._canplay(extname))return canPlayUrl=url,wdCb.$BREAK}),wd.Log.error(null===canPlayUrl,wd.Log.info.FUNC_NOT_SUPPORT("browser",extnameArr.join(","))),canPlayUrl},Video.prototype._canplay=function(extname){var video=document.createElement("video"),mimeStr=null;switch(extname){case".mp4":mimeStr='video/mp4; codecs="avc1.42e01e, mp4a.40.2"';break;case".ogv":mimeStr='video/ogg; codecs="theora, vorbis"';break;case".webm":mimeStr='video/webm; codecs="vp8, vorbis"';break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT(extname))}return!!video.canPlayType&&""!==video.canPlayType(mimeStr)},Video.prototype._bindEvent=function(){var self=this;this.source.addEventListener("canplaythrough",function(){self._onLoad(self)},!1),this.source.addEventListener("error",function(){self._onError("errorCode "+self.source.error.code)},!1),this.source.addEventListener("ended",function(){self.isStop=!0},!1)},Video}();wd.Video=Video}(wd||(wd={}));var wd;!function(wd){var VideoManager=function(){function VideoManager(){}return VideoManager.getInstance=function(){},VideoManager.prototype.play=function(id){var asset=wd.VideoLoader.getInstance().get(id),video=null;wd.Log.error(!asset,wd.Log.info.FUNC_NOT_EXIST("video asset which id is "+id)),video=asset.video,video.play()},VideoManager=__decorate([wd.singleton()],VideoManager)}();wd.VideoManager=VideoManager}(wd||(wd={}));var wd;!function(wd){wd.JudgeUtils.isNodeJs()?wd.root=global:wd.root=window}(wd||(wd={}));var wd;!function(wd){var ProceduralShaderLib=function(_super){function ProceduralShaderLib(){_super.apply(this,arguments)}return __extends(ProceduralShaderLib,_super),ProceduralShaderLib.prototype.sendShaderVariables=function(program,cmd){},ProceduralShaderLib.prototype.setShaderDefinition=function(cmd){_super.prototype.setShaderDefinition.call(this,cmd,null)},__decorate([wd.virtual],ProceduralShaderLib.prototype,"sendShaderVariables",null),__decorate([wd.virtual],ProceduralShaderLib.prototype,"setShaderDefinition",null),ProceduralShaderLib}(wd.EngineShaderLib);wd.ProceduralShaderLib=ProceduralShaderLib}(wd||(wd={}));var wd;!function(wd){var ProceduralRenderTargetRenderer=function(_super){function ProceduralRenderTargetRenderer(){_super.apply(this,arguments),this.frameBuffer=null,this._indexBuffer=null,this._vertexBuffer=null,this._shader=null,this._vaoManager=wd.GPUDetector.getInstance().extensionVAO?wd.VAOManager.create():null}return __extends(ProceduralRenderTargetRenderer,_super),ProceduralRenderTargetRenderer.prototype.init=function(){_super.prototype.init.call(this),this._initBuffer(),this._shader=this.createShader(),this._shader.init(),this._vaoManager&&this._vaoManager.init()},ProceduralRenderTargetRenderer.prototype.dispose=function(){_super.prototype.dispose.call(this),this._indexBuffer.dispose(),this._vertexBuffer.dispose(),this._shader.dispose(),this._vaoManager&&this._vaoManager.dispose()},ProceduralRenderTargetRenderer.prototype.initFrameBuffer=function(){var frameBuffer=this.frameBufferOperator,gl=wd.DeviceManager.getInstance().gl;this.frameBuffer=frameBuffer.createFrameBuffer(),frameBuffer.bindFrameBuffer(this.frameBuffer),frameBuffer.attachTexture(gl.TEXTURE_2D,this.texture.glTexture),frameBuffer.check(),frameBuffer.unBindAll()},ProceduralRenderTargetRenderer.prototype.renderFrameBufferTexture=function(renderList,renderer){this.frameBufferOperator.bindFrameBuffer(this.frameBuffer),this.texture.bindToUnit(0),this.frameBufferOperator.setViewport(),renderer.addCommand(this._createRenderCommand()),renderer.clear(),renderer.webglState=wd.BasicState.create(),renderer.render(),this.frameBufferOperator.unBindFrameBuffer(),this.frameBufferOperator.restoreViewport()},ProceduralRenderTargetRenderer.prototype.disposeFrameBuffer=function(){var gl=wd.DeviceManager.getInstance().gl;gl.deleteFramebuffer(this.frameBuffer)},ProceduralRenderTargetRenderer.prototype.getRenderList=function(){return null},ProceduralRenderTargetRenderer.prototype.isRenderListEmpty=function(){return!1},ProceduralRenderTargetRenderer.prototype._initBuffer=function(){wd.BufferTable.hasBuffer(wd.BufferTableKey.PROCEDURAL_VERTEX)?this._vertexBuffer=wd.BufferTable.getBuffer(wd.BufferTableKey.PROCEDURAL_VERTEX):(this._vertexBuffer=wd.ArrayBuffer.create([1,1,-1,1,-1,-1,1,-1],2,wd.EBufferType.FLOAT),wd.BufferTable.addBuffer(wd.BufferTableKey.PROCEDURAL_VERTEX,this._vertexBuffer)),wd.BufferTable.hasBuffer(wd.BufferTableKey.PROCEDURAL_INDEX)?this._indexBuffer=wd.BufferTable.getBuffer(wd.BufferTableKey.PROCEDURAL_INDEX):(this._indexBuffer=wd.ElementBuffer.create([0,1,2,0,2,3],wd.EBufferType.UNSIGNED_SHORT),wd.BufferTable.addBuffer(wd.BufferTableKey.PROCEDURAL_INDEX,this._indexBuffer))},ProceduralRenderTargetRenderer.prototype._createRenderCommand=function(){var command=wd.ProceduralCommand.create();return command.vertexBuffer=this._vertexBuffer,command.indexBuffer=this._indexBuffer,command.shader=this._shader,command.vaoManager=this._vaoManager,command},ProceduralRenderTargetRenderer}(wd.RenderTargetRenderer);wd.ProceduralRenderTargetRenderer=ProceduralRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var ProceduralTexture=function(_super){function ProceduralTexture(){_super.apply(this,arguments),this.repeatRegion=wd.RectRegion.create(0,0,1,1)}return __extends(ProceduralTexture,_super),Object.defineProperty(ProceduralTexture.prototype,"sourceRegionForGLSL",{get:function(){return wd.RectRegion.create(0,0,1,1)},enumerable:!0,configurable:!0}),ProceduralTexture.prototype.initWhenCreate=function(){_super.prototype.initWhenCreate.call(this),this.renderRate=0},ProceduralTexture.prototype.getSamplerName=function(unit){return this.getSamplerNameByVariableData(unit,wd.EVariableType.SAMPLER_2D)},__decorate([wd.cloneAttributeAsCloneable()],ProceduralTexture.prototype,"repeatRegion",void 0),ProceduralTexture}(wd.TwoDRenderTargetTexture);wd.ProceduralTexture=ProceduralTexture}(wd||(wd={}));var wd;!function(wd){var CommonProceduralShaderLib=function(_super){function CommonProceduralShaderLib(){_super.apply(this,arguments),this.type="common_proceduralTexture"}return __extends(CommonProceduralShaderLib,_super),CommonProceduralShaderLib.create=function(){var obj=new this;return obj},CommonProceduralShaderLib.prototype.sendShaderVariables=function(program,cmd){this.sendAttributeBuffer(program,"a_positionVec2",cmd.vertexBuffer),program.sendAllBufferData(cmd.vaoManager)},CommonProceduralShaderLib.prototype.setShaderDefinition=function(cmd){_super.prototype.setShaderDefinition.call(this,cmd),this.addAttributeVariable(["a_positionVec2"])},CommonProceduralShaderLib}(wd.ProceduralShaderLib);wd.CommonProceduralShaderLib=CommonProceduralShaderLib}(wd||(wd={}));var wd;!function(wd){var FireProceduralShaderLib=function(_super){function FireProceduralShaderLib(proceduralTexture){_super.call(this),this.type="fire_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=proceduralTexture}return __extends(FireProceduralShaderLib,_super),FireProceduralShaderLib.create=function(proceduralTexture){var obj=new this(proceduralTexture);return obj},FireProceduralShaderLib.prototype.sendShaderVariables=function(program,cmd){var texture=this._proceduralTexture;texture.computeTime(),this.sendUniformData(program,"u_time",texture.time),this.sendUniformData(program,"u_speed",texture.speed),this.sendUniformData(program,"u_shift",texture.shift),this.sendUniformData(program,"u_alphaThreshold",texture.alphaThreshold),texture.fireColorMap.forEach(function(color,name){program.sendStructureData("u_fireColor."+name,wd.EVariableType.VECTOR_3,color.toVector3())})},FireProceduralShaderLib.prototype.setShaderDefinition=function(cmd){_super.prototype.setShaderDefinition.call(this,cmd),this.addUniformVariable(["u_time","u_speed","u_shift","u_alphaThreshold","u_fireColor"])},FireProceduralShaderLib}(wd.ProceduralShaderLib);wd.FireProceduralShaderLib=FireProceduralShaderLib}(wd||(wd={}));var wd;!function(wd){var FireProceduralRenderTargetRenderer=function(_super){function FireProceduralRenderTargetRenderer(){_super.apply(this,arguments)}return __extends(FireProceduralRenderTargetRenderer,_super),FireProceduralRenderTargetRenderer.create=function(texture){var obj=new this(texture);return obj.initWhenCreate(),obj},FireProceduralRenderTargetRenderer.prototype.createShader=function(){var shader=wd.CommonProceduralShader.create();return shader.addLib(wd.FireProceduralShaderLib.create(this.texture)),shader},FireProceduralRenderTargetRenderer}(wd.ProceduralRenderTargetRenderer);wd.FireProceduralRenderTargetRenderer=FireProceduralRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var FireProceduralTexture=function(_super){function FireProceduralTexture(){_super.apply(this,arguments),this._fireColorMap=null,this.fireColorType=EFireProceduralTextureColorType.RED,this.speed=wd.Vector2.create(.5,.3),this.alphaThreshold=.5,this.shift=1,this.time=0}return __extends(FireProceduralTexture,_super),FireProceduralTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},Object.defineProperty(FireProceduralTexture.prototype,"fireColorMap",{get:function(){if(null!==this._fireColorMap)return this._fireColorMap;switch(this.fireColorType){case EFireProceduralTextureColorType.CUSTOM:return this._fireColorMap;case EFireProceduralTextureColorType.RED:return wdCb.Hash.create({c1:wd.Color.create("rgb(0.5, 0.0, 0.1)"),c2:wd.Color.create("rgb(0.9, 0.0, 0.0)"),c3:wd.Color.create("rgb(0.2, 0.0, 0.0)"),c4:wd.Color.create("rgb(1.0, 0.9, 0.0)"),c5:wd.Color.create("rgb(0.1, 0.1, 0.1)"),c6:wd.Color.create("rgb(0.9, 0.9, 0.9)")});case EFireProceduralTextureColorType.BLUE:return wdCb.Hash.create({c1:wd.Color.create("rgb(0.1, 0.0, 0.5)"),c2:wd.Color.create("rgb(0.0, 0.0, 0.5)"),c3:wd.Color.create("rgb(0.1, 0.0, 0.2)"),c4:wd.Color.create("rgb(0.0, 0.0, 1.0)"),c5:wd.Color.create("rgb(0.1, 0.2, 0.3)"),c6:wd.Color.create("rgb(0.0, 0.2, 0.9)")});case EFireProceduralTextureColorType.PURPLE:return wdCb.Hash.create({c1:wd.Color.create("rgb(0.5, 0.0, 1.0)"),c2:wd.Color.create("rgb(0.9, 0.0, 1.0)"),c3:wd.Color.create("rgb(0.2, 0.0, 1.0)"),c4:wd.Color.create("rgb(1.0, 0.9, 1.0)"),c5:wd.Color.create("rgb(0.1, 0.1, 1.0)"),c6:wd.Color.create("rgb(0.9, 0.9, 1.0)")});case EFireProceduralTextureColorType.GREEN:return wdCb.Hash.create({c1:wd.Color.create("rgb(0.5, 1.0, 0.0)"),c2:wd.Color.create("rgb(0.5, 1.0, 0.0)"),c3:wd.Color.create("rgb(0.3, 0.4, 0.0)"),c4:wd.Color.create("rgb(0.5, 1.0, 0.0)"),c5:wd.Color.create("rgb(0.2, 0.0, 0.0)"),c6:wd.Color.create("rgb(0.5, 1.0, 0.0)")});default:wd.Log.error(!0,wd.Log.info.FUNC_UNEXPECT("fireColorType:"+this.fireColorType))}},set:function(fireColorMap){this._fireColorMap=fireColorMap},enumerable:!0,configurable:!0}),FireProceduralTexture.prototype.initWhenCreate=function(){_super.prototype.initWhenCreate.call(this),this.renderRate=1},FireProceduralTexture.prototype.init=function(){return _super.prototype.init.call(this),wd.Director.getInstance().scene.addProceduralRenderTargetRenderer(wd.FireProceduralRenderTargetRenderer.create(this)),this},FireProceduralTexture.prototype.computeTime=function(){this.time+=.1},__decorate([wd.cloneAttributeAsBasicType()],FireProceduralTexture.prototype,"_fireColorMap",void 0),__decorate([wd.requireSetter(function(fireColorMap){wd.assert(6===fireColorMap.getCount(),wd.Log.info.FUNC_SHOULD("contain 6 colors"))}),wd.ensureGetter(function(value){wd.assert(6===value.getCount(),wd.Log.info.FUNC_SHOULD("contain 6 colors"))})],FireProceduralTexture.prototype,"fireColorMap",null),__decorate([wd.cloneAttributeAsBasicType()],FireProceduralTexture.prototype,"fireColorType",void 0),__decorate([wd.cloneAttributeAsCloneable()],FireProceduralTexture.prototype,"speed",void 0),__decorate([wd.cloneAttributeAsBasicType()],FireProceduralTexture.prototype,"alphaThreshold",void 0),__decorate([wd.cloneAttributeAsBasicType()],FireProceduralTexture.prototype,"shift",void 0),__decorate([wd.cloneAttributeAsBasicType()],FireProceduralTexture.prototype,"time",void 0),FireProceduralTexture}(wd.ProceduralTexture);wd.FireProceduralTexture=FireProceduralTexture,function(EFireProceduralTextureColorType){EFireProceduralTextureColorType[EFireProceduralTextureColorType.CUSTOM=0]="CUSTOM",EFireProceduralTextureColorType[EFireProceduralTextureColorType.RED=1]="RED",EFireProceduralTextureColorType[EFireProceduralTextureColorType.PURPLE=2]="PURPLE",EFireProceduralTextureColorType[EFireProceduralTextureColorType.GREEN=3]="GREEN",EFireProceduralTextureColorType[EFireProceduralTextureColorType.BLUE=4]="BLUE"}(wd.EFireProceduralTextureColorType||(wd.EFireProceduralTextureColorType={}));var EFireProceduralTextureColorType=wd.EFireProceduralTextureColorType}(wd||(wd={}));var wd;!function(wd){var MarbleProceduralRenderTargetRenderer=function(_super){function MarbleProceduralRenderTargetRenderer(){_super.apply(this,arguments)}return __extends(MarbleProceduralRenderTargetRenderer,_super),MarbleProceduralRenderTargetRenderer.create=function(texture){var obj=new this(texture);return obj.initWhenCreate(),obj},MarbleProceduralRenderTargetRenderer.prototype.createShader=function(){var shader=wd.CommonProceduralShader.create();return shader.addLib(wd.MarbleProceduralShaderLib.create(this.texture)),shader},MarbleProceduralRenderTargetRenderer}(wd.ProceduralRenderTargetRenderer);wd.MarbleProceduralRenderTargetRenderer=MarbleProceduralRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var MarbleProceduralTexture=function(_super){function MarbleProceduralTexture(){_super.apply(this,arguments),this.tilesHeightNumber=3,this.tilesWidthNumber=3,this.amplitude=9,this.jointColor=wd.Color.create("rgb(0.72, 0.72, 0.72)")}return __extends(MarbleProceduralTexture,_super),MarbleProceduralTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},MarbleProceduralTexture.prototype.init=function(){return _super.prototype.init.call(this),wd.Director.getInstance().scene.addProceduralRenderTargetRenderer(wd.MarbleProceduralRenderTargetRenderer.create(this)),this},__decorate([wd.cloneAttributeAsBasicType()],MarbleProceduralTexture.prototype,"tilesHeightNumber",void 0),__decorate([wd.cloneAttributeAsBasicType()],MarbleProceduralTexture.prototype,"tilesWidthNumber",void 0),__decorate([wd.cloneAttributeAsBasicType()],MarbleProceduralTexture.prototype,"amplitude",void 0),__decorate([wd.cloneAttributeAsCloneable()],MarbleProceduralTexture.prototype,"jointColor",void 0),MarbleProceduralTexture}(wd.ProceduralTexture);wd.MarbleProceduralTexture=MarbleProceduralTexture}(wd||(wd={}));var wd;!function(wd){var MarbleProceduralShaderLib=function(_super){function MarbleProceduralShaderLib(proceduralTexture){_super.call(this),this.type="marble_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=proceduralTexture}return __extends(MarbleProceduralShaderLib,_super),MarbleProceduralShaderLib.create=function(proceduralTexture){var obj=new this(proceduralTexture);return obj},MarbleProceduralShaderLib.prototype.sendShaderVariables=function(program,cmd){var texture=this._proceduralTexture;this.sendUniformData(program,"u_tilesHeightNumber",texture.tilesHeightNumber),this.sendUniformData(program,"u_tilesWidthNumber",texture.tilesWidthNumber),this.sendUniformData(program,"u_amplitude",texture.amplitude),this.sendUniformData(program,"u_jointColor",texture.jointColor.toVector3())},MarbleProceduralShaderLib.prototype.setShaderDefinition=function(cmd){_super.prototype.setShaderDefinition.call(this,cmd),this.addUniformVariable(["u_tilesHeightNumber","u_tilesWidthNumber","u_amplitude","u_jointColor"])},MarbleProceduralShaderLib}(wd.ProceduralShaderLib);wd.MarbleProceduralShaderLib=MarbleProceduralShaderLib}(wd||(wd={}));var wd;!function(wd){var GrassProceduralRenderTargetRenderer=function(_super){function GrassProceduralRenderTargetRenderer(){_super.apply(this,arguments)}return __extends(GrassProceduralRenderTargetRenderer,_super),GrassProceduralRenderTargetRenderer.create=function(texture){var obj=new this(texture);return obj.initWhenCreate(),obj},GrassProceduralRenderTargetRenderer.prototype.createShader=function(){var shader=wd.CommonProceduralShader.create();return shader.addLib(wd.GrassProceduralShaderLib.create(this.texture)),shader},GrassProceduralRenderTargetRenderer}(wd.ProceduralRenderTargetRenderer);wd.GrassProceduralRenderTargetRenderer=GrassProceduralRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var GrassProceduralTexture=function(_super){function GrassProceduralTexture(){_super.apply(this,arguments),this.herb1Color=wd.Color.create("rgb(0.29, 0.38, 0.02)"),this.herb2Color=wd.Color.create("rgb(0.36, 0.49, 0.09)"),this.herb3Color=wd.Color.create("rgb(0.51, 0.6, 0.28)"),this.groundColor=wd.Color.create("rgb(1.0,1.0,1.0)")}return __extends(GrassProceduralTexture,_super),GrassProceduralTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},GrassProceduralTexture.prototype.init=function(){return _super.prototype.init.call(this),wd.Director.getInstance().scene.addProceduralRenderTargetRenderer(wd.GrassProceduralRenderTargetRenderer.create(this)),this},__decorate([wd.cloneAttributeAsCloneable()],GrassProceduralTexture.prototype,"herb1Color",void 0),__decorate([wd.cloneAttributeAsCloneable()],GrassProceduralTexture.prototype,"herb2Color",void 0),__decorate([wd.cloneAttributeAsCloneable()],GrassProceduralTexture.prototype,"herb3Color",void 0),__decorate([wd.cloneAttributeAsCloneable()],GrassProceduralTexture.prototype,"groundColor",void 0),GrassProceduralTexture}(wd.ProceduralTexture);wd.GrassProceduralTexture=GrassProceduralTexture}(wd||(wd={}));var wd;!function(wd){var GrassProceduralShaderLib=function(_super){function GrassProceduralShaderLib(proceduralTexture){_super.call(this),this.type="grass_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=proceduralTexture}return __extends(GrassProceduralShaderLib,_super),GrassProceduralShaderLib.create=function(proceduralTexture){var obj=new this(proceduralTexture);return obj},GrassProceduralShaderLib.prototype.sendShaderVariables=function(program,cmd){var texture=this._proceduralTexture;this.sendUniformData(program,"u_herb1Color",texture.herb1Color.toVector3()),this.sendUniformData(program,"u_herb2Color",texture.herb2Color.toVector3()),this.sendUniformData(program,"u_herb3Color",texture.herb3Color.toVector3()),this.sendUniformData(program,"u_groundColor",texture.groundColor.toVector3())},GrassProceduralShaderLib.prototype.setShaderDefinition=function(cmd){_super.prototype.setShaderDefinition.call(this,cmd),this.addUniformVariable(["u_herb1Color","u_herb2Color","u_herb3Color","u_groundColor"])},GrassProceduralShaderLib}(wd.ProceduralShaderLib);wd.GrassProceduralShaderLib=GrassProceduralShaderLib}(wd||(wd={}));var wd;!function(wd){var WoodProceduralRenderTargetRenderer=function(_super){function WoodProceduralRenderTargetRenderer(){_super.apply(this,arguments)}return __extends(WoodProceduralRenderTargetRenderer,_super),WoodProceduralRenderTargetRenderer.create=function(texture){var obj=new this(texture);return obj.initWhenCreate(),obj},WoodProceduralRenderTargetRenderer.prototype.createShader=function(){var shader=wd.CommonProceduralShader.create();return shader.addLib(wd.WoodProceduralShaderLib.create(this.texture)),shader},WoodProceduralRenderTargetRenderer}(wd.ProceduralRenderTargetRenderer);wd.WoodProceduralRenderTargetRenderer=WoodProceduralRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var WoodProceduralTexture=function(_super){function WoodProceduralTexture(){_super.apply(this,arguments),this.ampScale=100,this.woodColor=wd.Color.create("rgb(0.32, 0.17, 0.09)")}return __extends(WoodProceduralTexture,_super),WoodProceduralTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},WoodProceduralTexture.prototype.init=function(){return _super.prototype.init.call(this),wd.Director.getInstance().scene.addProceduralRenderTargetRenderer(wd.WoodProceduralRenderTargetRenderer.create(this)),this},__decorate([wd.cloneAttributeAsBasicType()],WoodProceduralTexture.prototype,"ampScale",void 0),__decorate([wd.cloneAttributeAsCloneable()],WoodProceduralTexture.prototype,"woodColor",void 0),WoodProceduralTexture}(wd.ProceduralTexture);wd.WoodProceduralTexture=WoodProceduralTexture}(wd||(wd={}));var wd;!function(wd){var WoodProceduralShaderLib=function(_super){function WoodProceduralShaderLib(proceduralTexture){_super.call(this),this.type="wood_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=proceduralTexture}return __extends(WoodProceduralShaderLib,_super),WoodProceduralShaderLib.create=function(proceduralTexture){var obj=new this(proceduralTexture);return obj},WoodProceduralShaderLib.prototype.sendShaderVariables=function(program,cmd){var texture=this._proceduralTexture;this.sendUniformData(program,"u_ampScale",texture.ampScale),this.sendUniformData(program,"u_woodColor",texture.woodColor.toVector3())},WoodProceduralShaderLib.prototype.setShaderDefinition=function(cmd){_super.prototype.setShaderDefinition.call(this,cmd),this.addUniformVariable(["u_ampScale","u_woodColor"])},WoodProceduralShaderLib}(wd.ProceduralShaderLib);wd.WoodProceduralShaderLib=WoodProceduralShaderLib}(wd||(wd={}));var wd;!function(wd){var RoadProceduralRenderTargetRenderer=function(_super){function RoadProceduralRenderTargetRenderer(){_super.apply(this,arguments)}return __extends(RoadProceduralRenderTargetRenderer,_super),RoadProceduralRenderTargetRenderer.create=function(texture){var obj=new this(texture);return obj.initWhenCreate(),obj},RoadProceduralRenderTargetRenderer.prototype.createShader=function(){var shader=wd.CommonProceduralShader.create();return shader.addLib(wd.RoadProceduralShaderLib.create(this.texture)),shader},RoadProceduralRenderTargetRenderer}(wd.ProceduralRenderTargetRenderer);wd.RoadProceduralRenderTargetRenderer=RoadProceduralRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var RoadProceduralTexture=function(_super){function RoadProceduralTexture(){_super.apply(this,arguments),this.roadColor=wd.Color.create("rgb(0.53, 0.53, 0.53)")}return __extends(RoadProceduralTexture,_super),RoadProceduralTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},RoadProceduralTexture.prototype.init=function(){return _super.prototype.init.call(this),wd.Director.getInstance().scene.addProceduralRenderTargetRenderer(wd.RoadProceduralRenderTargetRenderer.create(this)),
this},__decorate([wd.cloneAttributeAsCloneable()],RoadProceduralTexture.prototype,"roadColor",void 0),RoadProceduralTexture}(wd.ProceduralTexture);wd.RoadProceduralTexture=RoadProceduralTexture}(wd||(wd={}));var wd;!function(wd){var RoadProceduralShaderLib=function(_super){function RoadProceduralShaderLib(proceduralTexture){_super.call(this),this.type="road_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=proceduralTexture}return __extends(RoadProceduralShaderLib,_super),RoadProceduralShaderLib.create=function(proceduralTexture){var obj=new this(proceduralTexture);return obj},RoadProceduralShaderLib.prototype.sendShaderVariables=function(program,cmd){var texture=this._proceduralTexture;this.sendUniformData(program,"u_roadColor",texture.roadColor.toVector3())},RoadProceduralShaderLib.prototype.setShaderDefinition=function(cmd){_super.prototype.setShaderDefinition.call(this,cmd),this.addUniformVariable(["u_roadColor"])},RoadProceduralShaderLib}(wd.ProceduralShaderLib);wd.RoadProceduralShaderLib=RoadProceduralShaderLib}(wd||(wd={}));var wd;!function(wd){var CloudProceduralRenderTargetRenderer=function(_super){function CloudProceduralRenderTargetRenderer(){_super.apply(this,arguments)}return __extends(CloudProceduralRenderTargetRenderer,_super),CloudProceduralRenderTargetRenderer.create=function(texture){var obj=new this(texture);return obj.initWhenCreate(),obj},CloudProceduralRenderTargetRenderer.prototype.createShader=function(){var shader=wd.CommonProceduralShader.create();return shader.addLib(wd.CloudProceduralShaderLib.create(this.texture)),shader},CloudProceduralRenderTargetRenderer}(wd.ProceduralRenderTargetRenderer);wd.CloudProceduralRenderTargetRenderer=CloudProceduralRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var CloudProceduralTexture=function(_super){function CloudProceduralTexture(){_super.apply(this,arguments),this.skyColor=wd.Color.create("rgb(0.15, 0.68, 1.0)"),this.cloudColor=wd.Color.create("rgb(1.0, 1.0, 1.0)")}return __extends(CloudProceduralTexture,_super),CloudProceduralTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},CloudProceduralTexture.prototype.init=function(){return _super.prototype.init.call(this),wd.Director.getInstance().scene.addProceduralRenderTargetRenderer(wd.CloudProceduralRenderTargetRenderer.create(this)),this},__decorate([wd.cloneAttributeAsCloneable()],CloudProceduralTexture.prototype,"skyColor",void 0),__decorate([wd.cloneAttributeAsCloneable()],CloudProceduralTexture.prototype,"cloudColor",void 0),CloudProceduralTexture}(wd.ProceduralTexture);wd.CloudProceduralTexture=CloudProceduralTexture}(wd||(wd={}));var wd;!function(wd){var CloudProceduralShaderLib=function(_super){function CloudProceduralShaderLib(proceduralTexture){_super.call(this),this.type="cloud_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=proceduralTexture}return __extends(CloudProceduralShaderLib,_super),CloudProceduralShaderLib.create=function(proceduralTexture){var obj=new this(proceduralTexture);return obj},CloudProceduralShaderLib.prototype.sendShaderVariables=function(program,cmd){var texture=this._proceduralTexture;this.sendUniformData(program,"u_skyColor",texture.skyColor.toVector4()),this.sendUniformData(program,"u_cloudColor",texture.cloudColor.toVector4())},CloudProceduralShaderLib.prototype.setShaderDefinition=function(cmd){_super.prototype.setShaderDefinition.call(this,cmd),this.addUniformVariable(["u_skyColor","u_cloudColor"])},CloudProceduralShaderLib}(wd.ProceduralShaderLib);wd.CloudProceduralShaderLib=CloudProceduralShaderLib}(wd||(wd={}));var wd;!function(wd){var BrickProceduralRenderTargetRenderer=function(_super){function BrickProceduralRenderTargetRenderer(){_super.apply(this,arguments)}return __extends(BrickProceduralRenderTargetRenderer,_super),BrickProceduralRenderTargetRenderer.create=function(texture){var obj=new this(texture);return obj.initWhenCreate(),obj},BrickProceduralRenderTargetRenderer.prototype.createShader=function(){var shader=wd.CommonProceduralShader.create();return shader.addLib(wd.BrickProceduralShaderLib.create(this.texture)),shader},BrickProceduralRenderTargetRenderer}(wd.ProceduralRenderTargetRenderer);wd.BrickProceduralRenderTargetRenderer=BrickProceduralRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var BrickProceduralTexture=function(_super){function BrickProceduralTexture(){_super.apply(this,arguments),this.tilesHeightNumber=15,this.tilesWidthNumber=5,this.brickColor=wd.Color.create("rgb(0.77, 0.47, 0.40)"),this.jointColor=wd.Color.create("rgb(0.72, 0.72, 0.72)")}return __extends(BrickProceduralTexture,_super),BrickProceduralTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},BrickProceduralTexture.prototype.init=function(){return _super.prototype.init.call(this),wd.Director.getInstance().scene.addProceduralRenderTargetRenderer(wd.BrickProceduralRenderTargetRenderer.create(this)),this},__decorate([wd.cloneAttributeAsBasicType()],BrickProceduralTexture.prototype,"tilesHeightNumber",void 0),__decorate([wd.cloneAttributeAsBasicType()],BrickProceduralTexture.prototype,"tilesWidthNumber",void 0),__decorate([wd.cloneAttributeAsCloneable()],BrickProceduralTexture.prototype,"brickColor",void 0),__decorate([wd.cloneAttributeAsCloneable()],BrickProceduralTexture.prototype,"jointColor",void 0),BrickProceduralTexture}(wd.ProceduralTexture);wd.BrickProceduralTexture=BrickProceduralTexture}(wd||(wd={}));var wd;!function(wd){var BrickProceduralShaderLib=function(_super){function BrickProceduralShaderLib(proceduralTexture){_super.call(this),this.type="brick_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=proceduralTexture}return __extends(BrickProceduralShaderLib,_super),BrickProceduralShaderLib.create=function(proceduralTexture){var obj=new this(proceduralTexture);return obj},BrickProceduralShaderLib.prototype.sendShaderVariables=function(program,cmd){var texture=this._proceduralTexture;this.sendUniformData(program,"u_tilesWidthNumber",texture.tilesWidthNumber),this.sendUniformData(program,"u_tilesHeightNumber",texture.tilesHeightNumber),this.sendUniformData(program,"u_brickColor",texture.brickColor.toVector3()),this.sendUniformData(program,"u_jointColor",texture.jointColor.toVector3())},BrickProceduralShaderLib.prototype.setShaderDefinition=function(cmd){_super.prototype.setShaderDefinition.call(this,cmd),this.addUniformVariable(["u_tilesHeightNumber","u_tilesWidthNumber","u_brickColor","u_jointColor"])},BrickProceduralShaderLib}(wd.ProceduralShaderLib);wd.BrickProceduralShaderLib=BrickProceduralShaderLib}(wd||(wd={}));var wd;!function(wd){var CustomProceduralRenderTargetRenderer=function(_super){function CustomProceduralRenderTargetRenderer(){_super.apply(this,arguments)}return __extends(CustomProceduralRenderTargetRenderer,_super),CustomProceduralRenderTargetRenderer.create=function(texture){var obj=new this(texture);return obj.initWhenCreate(),obj},CustomProceduralRenderTargetRenderer.prototype.createShader=function(){var shader=wd.CustomProceduralShader.create(this.texture);return shader.addLib(wd.CustomProceduralShaderLib.create(this.texture)),shader},CustomProceduralRenderTargetRenderer}(wd.ProceduralRenderTargetRenderer);wd.CustomProceduralRenderTargetRenderer=CustomProceduralRenderTargetRenderer}(wd||(wd={}));var wd;!function(wd){var CustomProceduralTexture=function(_super){function CustomProceduralTexture(){_super.apply(this,arguments),this.mapManager=wd.MapManager.create(),this.uniformMap=wdCb.Hash.create(),this.fsSource=null}return __extends(CustomProceduralTexture,_super),CustomProceduralTexture.create=function(){var obj=new this;return obj.initWhenCreate(),obj},CustomProceduralTexture.prototype.init=function(){return _super.prototype.init.call(this),wd.Director.getInstance().scene.addProceduralRenderTargetRenderer(wd.CustomProceduralRenderTargetRenderer.create(this)),this},CustomProceduralTexture.prototype.read=function(shaderConfigId){var shaderConfig=wd.LoaderManager.getInstance().get(shaderConfigId),uniforms=shaderConfig.uniforms;this.fsSource=wd.LoaderManager.getInstance().get(shaderConfig.fsSourceId),this.renderRate=shaderConfig.renderRate||0;for(var name_2 in uniforms)if(uniforms.hasOwnProperty(name_2)){var uniform=uniforms[name_2];uniform.type===wd.EVariableType.SAMPLER_2D?this.mapManager.addMap(wd.LoaderManager.getInstance().get(uniform.textureId),{samplerVariableName:name_2}):this.uniformMap.addChild(name_2,uniform)}},__decorate([wd.cloneAttributeAsCustomType(function(source,target,memberName){source[memberName].getMapList().forEach(function(map){target[memberName].addMap(map.clone())})})],CustomProceduralTexture.prototype,"mapManager",void 0),__decorate([wd.cloneAttributeAsCloneable()],CustomProceduralTexture.prototype,"uniformMap",void 0),__decorate([wd.cloneAttributeAsBasicType()],CustomProceduralTexture.prototype,"fsSource",void 0),__decorate([wd.require(function(shaderConfigId){var shaderConfig=wd.LoaderManager.getInstance().get(shaderConfigId),uniforms=shaderConfig.uniforms;for(var name_3 in uniforms)if(uniforms.hasOwnProperty(name_3)){var uniform=uniforms[name_3];wd.assert(uniform.type!==wd.EVariableType.SAMPLER_CUBE,wd.Log.info.FUNC_NOT_SUPPORT("uniforms","EVariableType.SAMPLER_CUBE type"))}}),wd.ensure(function(){wd.assert(null!==this.fsSource,wd.Log.info.FUNC_SHOULD("read fragment glsl source"))})],CustomProceduralTexture.prototype,"read",null),CustomProceduralTexture}(wd.ProceduralTexture);wd.CustomProceduralTexture=CustomProceduralTexture}(wd||(wd={}));var wd;!function(wd){var CustomProceduralShaderLib=function(_super){function CustomProceduralShaderLib(proceduralTexture){_super.call(this),this.type="custom_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=proceduralTexture}return __extends(CustomProceduralShaderLib,_super),CustomProceduralShaderLib.create=function(proceduralTexture){var obj=new this(proceduralTexture);return obj},CustomProceduralShaderLib.prototype.sendShaderVariables=function(program,cmd){var texture=this._proceduralTexture,uniformMap=texture.uniformMap;uniformMap.forEach(function(uniform,name){wd.CustomShaderLibUtils.sendUniformData(name,uniform.type,uniform.value,program)})},CustomProceduralShaderLib.prototype.setShaderDefinition=function(cmd){var texture=this._proceduralTexture;_super.prototype.setShaderDefinition.call(this,cmd),this.setFsSource(texture.fsSource)},CustomProceduralShaderLib}(wd.ProceduralShaderLib);wd.CustomProceduralShaderLib=CustomProceduralShaderLib}(wd||(wd={}));var wd;!function(wd){var MirrorMaterial=function(_super){function MirrorMaterial(){_super.apply(this,arguments),this._reflectionMap=null}return __extends(MirrorMaterial,_super),MirrorMaterial.create=function(){var obj=new this;return obj.initWhenCreate(),obj},Object.defineProperty(MirrorMaterial.prototype,"reflectionMap",{get:function(){return this._reflectionMap},set:function(reflectionMap){this.mapManager.addMap(reflectionMap,{samplerVariableName:wd.VariableNameTable.getVariableName("reflectionMap")}),this._reflectionMap=reflectionMap},enumerable:!0,configurable:!0}),MirrorMaterial.prototype.getTextureForRenderSort=function(){return this.reflectionMap},MirrorMaterial.prototype.addExtendShaderLib=function(){this.reflectionMap&&this.shader.addLib(wd.MirrorShaderLib.create())},__decorate([wd.cloneAttributeAsCloneable()],MirrorMaterial.prototype,"reflectionMap",null),MirrorMaterial}(wd.StandardLightMaterial);wd.MirrorMaterial=MirrorMaterial}(wd||(wd={}));var wd;!function(wd){var MirrorShaderLib=function(_super){function MirrorShaderLib(){_super.apply(this,arguments),this.type="mirror"}return __extends(MirrorShaderLib,_super),MirrorShaderLib.create=function(){var obj=new this;return obj},MirrorShaderLib.prototype.sendShaderVariables=function(program,cmd,material){wd.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(program,wd.EShaderGLSLData.MIRROR)},MirrorShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_isRenderListEmpty",wd.VariableNameTable.getVariableName("reflectionMap")])},MirrorShaderLib}(wd.EngineShaderLib);wd.MirrorShaderLib=MirrorShaderLib}(wd||(wd={}));var wd;!function(wd){var TerrainLayerShaderLib=function(_super){function TerrainLayerShaderLib(){_super.apply(this,arguments),this.type="terrainLayer"}return __extends(TerrainLayerShaderLib,_super),TerrainLayerShaderLib.create=function(){var obj=new this;return obj},TerrainLayerShaderLib.prototype.sendShaderVariables=function(program,cmd,material){material.layer.mapDataList.forEach(function(mapData,index){program.sendStructureData("u_layerHeightDatas["+index+"].minHeight",wd.EVariableType.FLOAT_1,mapData.minHeight),program.sendStructureData("u_layerHeightDatas["+index+"].maxHeight",wd.EVariableType.FLOAT_1,mapData.maxHeight)})},TerrainLayerShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_layerHeightDatas","u_layerSampler2Ds"]),this.fsSourceDefineList.addChildren([{name:"LAYER_COUNT",value:material.layer.mapDataList.getCount()}])},__decorate([wd.require(function(cmd,material){wd.assert(!!material,wd.Log.info.FUNC_NOT_EXIST("param:material")),wd.assert(material.layer.mapDataList.getCount()>=0,wd.Log.info.FUNC_SHOULD("TerrainMaterial->layer->mapDataList->count",">= 0"))})],TerrainLayerShaderLib.prototype,"setShaderDefinition",null),TerrainLayerShaderLib}(wd.EngineShaderLib);wd.TerrainLayerShaderLib=TerrainLayerShaderLib}(wd||(wd={}));var wd;!function(wd){var TerrainMaterial=function(_super){function TerrainMaterial(){_super.apply(this,arguments),this.layer=TerrainLayerMapModel.create()}return __extends(TerrainMaterial,_super),TerrainMaterial.create=function(){var obj=new this;return obj.initWhenCreate(),obj},TerrainMaterial.prototype.init=function(){this.mapManager.addMapArray("u_layerSampler2Ds",this.layer.mapArray),_super.prototype.init.call(this)},TerrainMaterial.prototype.getTextureForRenderSort=function(){return this.layer.mapArray[0]},TerrainMaterial.prototype.addExtendShaderLib=function(){this.layer.mapDataList.getCount()>0&&this.shader.addLib(wd.TerrainLayerShaderLib.create())},__decorate([wd.cloneAttributeAsCloneable()],TerrainMaterial.prototype,"layer",void 0),TerrainMaterial}(wd.StandardLightMaterial);wd.TerrainMaterial=TerrainMaterial;var TerrainLayerMapModel=function(){function TerrainLayerMapModel(){this._mapDataList=wdCb.Collection.create()}return TerrainLayerMapModel.create=function(){var obj=new this;return obj},Object.defineProperty(TerrainLayerMapModel.prototype,"mapDataList",{get:function(){return this._mapDataList},set:function(mapDataList){this._mapDataList=mapDataList},enumerable:!0,configurable:!0}),Object.defineProperty(TerrainLayerMapModel.prototype,"mapArray",{get:function(){var arr=[];return this._mapDataList.forEach(function(data){arr.push(data.diffuseMap)}),arr},enumerable:!0,configurable:!0}),TerrainLayerMapModel.prototype.clone=function(){return wd.CloneUtils.clone(this)},__decorate([wd.requireSetter(function(mapDataList){wd.it("mapDataList should be Collection type",function(){wd.expect(mapDataList).instanceOf(wdCb.Collection)}),wd.it("minHeight should < maxHeight",function(){mapDataList.forEach(function(mapData){wd.expect(mapData.minHeight).lessThan(mapData.maxHeight)})}),wd.it("height range should not overlap",function(){mapDataList.forEach(function(mapData){mapDataList.filter(function(data){return data.minHeight!==mapData.minHeight||data.maxHeight!==mapData.maxHeight}).forEach(function(data){wd.expect(mapData.minHeight>=data.maxHeight||mapData.maxHeight<=data.minHeight).true})})})}),wd.cloneAttributeAsCloneable()],TerrainLayerMapModel.prototype,"mapDataList",null),__decorate([wd.ensureGetter(function(mapArray){for(var _i=0,mapArray_2=mapArray;_i<mapArray_2.length;_i++){var map=mapArray_2[_i];wd.assert(map instanceof wd.Texture,wd.Log.info.FUNC_SHOULD("return Array<Texture>"))}})],TerrainLayerMapModel.prototype,"mapArray",null),TerrainLayerMapModel}();wd.TerrainLayerMapModel=TerrainLayerMapModel}(wd||(wd={}));var wd;!function(wd){var WaterBumpMapShaderLib=function(_super){function WaterBumpMapShaderLib(){_super.apply(this,arguments),this.type="water_bump"}return __extends(WaterBumpMapShaderLib,_super),WaterBumpMapShaderLib.create=function(){var obj=new this;return obj},WaterBumpMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){program.sendUniformData("u_windMatrix",wd.EVariableType.FLOAT_MAT4,material.wind.matrix)},WaterBumpMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable([wd.VariableNameTable.getVariableName("bumpMap"),"u_windMatrix"])},WaterBumpMapShaderLib}(wd.EngineShaderLib);wd.WaterBumpMapShaderLib=WaterBumpMapShaderLib}(wd||(wd={}));var wd;!function(wd){var WaterFresnelShaderLib=function(_super){function WaterFresnelShaderLib(){_super.apply(this,arguments),this.type="water_fresnel"}return __extends(WaterFresnelShaderLib,_super),WaterFresnelShaderLib.create=function(){var obj=new this;return obj},WaterFresnelShaderLib.prototype.sendShaderVariables=function(program,cmd,material){wd.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(program,wd.EShaderGLSLData.MIRROR,"u_isReflectionRenderListEmpty"),wd.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(program,wd.EShaderGLSLData.REFRACTION,"u_isRefractionRenderListEmpty"),program.sendStructureData("u_levelData.fresnelLevel",wd.EVariableType.FLOAT_1,material.fresnelLevel),program.sendStructureData("u_levelData.refractionLevel",wd.EVariableType.FLOAT_1,material.refractionLevel),program.sendStructureData("u_levelData.reflectionLevel",wd.EVariableType.FLOAT_1,material.reflectionLevel)},WaterFresnelShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_levelData","u_isReflectionRenderListEmpty","u_isRefractionRenderListEmpty",wd.VariableNameTable.getVariableName("reflectionMap"),wd.VariableNameTable.getVariableName("refractionMap")])},WaterFresnelShaderLib}(wd.EngineShaderLib);wd.WaterFresnelShaderLib=WaterFresnelShaderLib}(wd||(wd={}));var wd;!function(wd){var WaterMaterial=function(_super){function WaterMaterial(){_super.apply(this,arguments),this._bumpMap=null,this._reflectionMap=null,this._refractionMap=null,this.wind=WaterWindModel.create(),this.wave=WaterWaveModel.create(),this.fresnelLevel=1,this.reflectionLevel=.6,this.refractionLevel=.8}return __extends(WaterMaterial,_super),WaterMaterial.create=function(){var obj=new this;return obj.initWhenCreate(),obj},Object.defineProperty(WaterMaterial.prototype,"bumpMap",{get:function(){return this._bumpMap},set:function(bumpMap){bumpMap.wrapS=wd.ETextureWrapMode.REPEAT,bumpMap.wrapT=wd.ETextureWrapMode.REPEAT,this.mapManager.addMap(bumpMap,{samplerVariableName:wd.VariableNameTable.getVariableName("bumpMap")}),this._bumpMap=bumpMap},enumerable:!0,configurable:!0}),Object.defineProperty(WaterMaterial.prototype,"reflectionMap",{get:function(){return this._reflectionMap},set:function(reflectionMap){this.mapManager.addMap(reflectionMap,{samplerVariableName:wd.VariableNameTable.getVariableName("reflectionMap")}),this._reflectionMap=reflectionMap},enumerable:!0,configurable:!0}),Object.defineProperty(WaterMaterial.prototype,"refractionMap",{get:function(){return this._refractionMap},set:function(refractionMap){this.mapManager.addMap(refractionMap,{samplerVariableName:wd.VariableNameTable.getVariableName("refractionMap")}),this._refractionMap=refractionMap},enumerable:!0,configurable:!0}),WaterMaterial.prototype.updateShader=function(cmd){this._computeTime(),_super.prototype.updateShader.call(this,cmd)},WaterMaterial.prototype.getTextureForRenderSort=function(){return this.reflectionMap},WaterMaterial.prototype.addExtendShaderLib=function(){this.bumpMap?this.shader.addLib(wd.WaterBumpMapShaderLib.create()):this.shader.addLib(wd.WaterNoBumpMapShaderLib.create()),this.shader.addLib(wd.WaterShaderLib.create()),this.reflectionMap&&this.refractionMap?this.shader.addLib(wd.WaterFresnelShaderLib.create()):this.reflectionMap?this.shader.addLib(wd.WaterReflectionMapShaderLib.create()):this.refractionMap?this.shader.addLib(wd.WaterRefractionMapShaderLib.create()):this.shader.addLib(wd.WaterNoLightEffectShaderLib.create())},WaterMaterial.prototype._computeTime=function(){this.wind.time+=1e-4},__decorate([wd.requireSetter(function(bumpMap){wd.assert(bumpMap instanceof wd.ImageTexture)}),wd.cloneAttributeAsCloneable()],WaterMaterial.prototype,"bumpMap",null),__decorate([wd.cloneAttributeAsCloneable()],WaterMaterial.prototype,"reflectionMap",null),__decorate([wd.cloneAttributeAsCloneable()],WaterMaterial.prototype,"refractionMap",null),__decorate([wd.cloneAttributeAsCloneable()],WaterMaterial.prototype,"wind",void 0),__decorate([wd.cloneAttributeAsCloneable()],WaterMaterial.prototype,"wave",void 0),__decorate([wd.cloneAttributeAsBasicType()],WaterMaterial.prototype,"fresnelLevel",void 0),__decorate([wd.cloneAttributeAsBasicType()],WaterMaterial.prototype,"reflectionLevel",void 0),__decorate([wd.cloneAttributeAsBasicType()],WaterMaterial.prototype,"refractionLevel",void 0),WaterMaterial}(wd.StandardLightMaterial);wd.WaterMaterial=WaterMaterial;var WaterWindModel=function(){function WaterWindModel(){this.time=0,this.direction=wd.Vector2.create(0,1)}return WaterWindModel.create=function(){var obj=new this;return obj},Object.defineProperty(WaterWindModel.prototype,"matrix",{get:function(){return wd.Matrix4.create().translate(this.direction.x*this.time,this.direction.y*this.time,0)},enumerable:!0,configurable:!0}),WaterWindModel.prototype.clone=function(){return wd.CloneUtils.clone(this)},__decorate([wd.cloneAttributeAsBasicType()],WaterWindModel.prototype,"time",void 0),__decorate([wd.cloneAttributeAsBasicType()],WaterWindModel.prototype,"direction",void 0),WaterWindModel}();wd.WaterWindModel=WaterWindModel;var WaterWaveModel=function(){function WaterWaveModel(){this.height=.15,this.length=.1}return WaterWaveModel.create=function(){var obj=new this;return obj},WaterWaveModel.prototype.clone=function(){return wd.CloneUtils.clone(this)},__decorate([wd.cloneAttributeAsBasicType()],WaterWaveModel.prototype,"height",void 0),__decorate([wd.cloneAttributeAsBasicType()],WaterWaveModel.prototype,"length",void 0),WaterWaveModel}();wd.WaterWaveModel=WaterWaveModel}(wd||(wd={}));var wd;!function(wd){var WaterNoBumpMapShaderLib=function(_super){function WaterNoBumpMapShaderLib(){_super.apply(this,arguments),this.type="water_noBump"}return __extends(WaterNoBumpMapShaderLib,_super),WaterNoBumpMapShaderLib.create=function(){var obj=new this;return obj},WaterNoBumpMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},WaterNoBumpMapShaderLib}(wd.EngineShaderLib);wd.WaterNoBumpMapShaderLib=WaterNoBumpMapShaderLib}(wd||(wd={}));var wd;!function(wd){var WaterNoLightEffectShaderLib=function(_super){function WaterNoLightEffectShaderLib(){_super.apply(this,arguments),this.type="water_noLightEffect"}return __extends(WaterNoLightEffectShaderLib,_super),WaterNoLightEffectShaderLib.create=function(){var obj=new this;return obj},WaterNoLightEffectShaderLib.prototype.sendShaderVariables=function(program,cmd,material){},WaterNoLightEffectShaderLib}(wd.EngineShaderLib);wd.WaterNoLightEffectShaderLib=WaterNoLightEffectShaderLib}(wd||(wd={}));var wd;!function(wd){var WaterReflectionMapShaderLib=function(_super){function WaterReflectionMapShaderLib(){_super.apply(this,arguments),this.type="water_reflection"}return __extends(WaterReflectionMapShaderLib,_super),WaterReflectionMapShaderLib.create=function(){var obj=new this;return obj},WaterReflectionMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){wd.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(program,wd.EShaderGLSLData.MIRROR,"u_isReflectionRenderListEmpty"),program.sendStructureData("u_levelData.reflectionLevel",wd.EVariableType.FLOAT_1,material.reflectionLevel)},WaterReflectionMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_levelData","u_isReflectionRenderListEmpty",wd.VariableNameTable.getVariableName("reflectionMap")])},WaterReflectionMapShaderLib}(wd.EngineShaderLib);wd.WaterReflectionMapShaderLib=WaterReflectionMapShaderLib}(wd||(wd={}));var wd;!function(wd){var WaterRefractionMapShaderLib=function(_super){function WaterRefractionMapShaderLib(){_super.apply(this,arguments),this.type="water_refraction"}return __extends(WaterRefractionMapShaderLib,_super),WaterRefractionMapShaderLib.create=function(){var obj=new this;return obj},WaterRefractionMapShaderLib.prototype.sendShaderVariables=function(program,cmd,material){wd.RenderTargerRendererShaderLibUtils.judgeAndSendIsRenderListEmptyVariable(program,wd.EShaderGLSLData.REFRACTION,"u_isRefractionRenderListEmpty"),program.sendStructureData("u_levelData.refractionLevel",wd.EVariableType.FLOAT_1,material.refractionLevel)},WaterRefractionMapShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_levelData","u_isRefractionRenderListEmpty",wd.VariableNameTable.getVariableName("refractionMap")])},WaterRefractionMapShaderLib}(wd.EngineShaderLib);wd.WaterRefractionMapShaderLib=WaterRefractionMapShaderLib}(wd||(wd={}));var wd;!function(wd){var WaterShaderLib=function(_super){function WaterShaderLib(){_super.apply(this,arguments),this.type="water"}return __extends(WaterShaderLib,_super),WaterShaderLib.create=function(){var obj=new this;return obj},WaterShaderLib.prototype.sendShaderVariables=function(program,cmd,material){program.sendStructureData("u_waveData.length",wd.EVariableType.FLOAT_1,material.wave.length),program.sendStructureData("u_waveData.height",wd.EVariableType.FLOAT_1,material.wave.height)},WaterShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_waveData"])},WaterShaderLib}(wd.EngineShaderLib);wd.WaterShaderLib=WaterShaderLib}(wd||(wd={}));var wd;!function(wd){var BitmapFontMaterial=function(_super){function BitmapFontMaterial(){_super.apply(this,arguments),this.enableSdf=!1,this.sdfType=wd.SdfBitmapFontType.SMOOTH,this.alphaTest=1e-4,this._bitmap=null,this._pageMapList=null}return __extends(BitmapFontMaterial,_super),BitmapFontMaterial.create=function(){var obj=new this;return obj.initWhenCreate(),obj},Object.defineProperty(BitmapFontMaterial.prototype,"bitmap",{get:function(){return this._bitmap},set:function(map){this.mapManager.addMap(map,{samplerVariableName:wd.VariableNameTable.getVariableName("bitmap")}),this._bitmap=map},enumerable:!0,configurable:!0}),Object.defineProperty(BitmapFontMaterial.prototype,"pageMapList",{get:function(){return this._pageMapList},set:function(pageMapList){this._pageMapList=pageMapList},enumerable:!0,configurable:!0}),BitmapFontMaterial.prototype.isMapFlipY=function(){return null!==this.pageMapList&&this.pageMapList.getCount()>0?this.pageMapList.getChild(0).flipY:this.bitmap.flipY},BitmapFontMaterial.prototype.initWhenCreate=function(){_super.prototype.initWhenCreate.call(this),this.blend=!0},BitmapFontMaterial.prototype.init=function(){this._hasMultiPages()&&this.mapManager.addMapArray("u_pageSampler2Ds",this.pageMapList.toArray()),_super.prototype.init.call(this)},BitmapFontMaterial.prototype.getTextureForRenderSort=function(){return this.bitmap?this.bitmap:this.pageMapList?this.pageMapList.getChild(0):null},BitmapFontMaterial.prototype.addExtendShaderLib=function(){this._hasMultiPages()?this.shader.addLib(wd.MultiPagesBitmapFontShaderLib.create()):this._isSdfFont()||this.shader.addLib(wd.BasicBitmapFontShaderLib.create())},BitmapFontMaterial.prototype.addEndShaderLib=function(){if(this.shader.addLib(wd.CommonBitmapFontShaderLib.create()),this._isSdfFont())switch(this.sdfType){case wd.SdfBitmapFontType.SMOOTH:this.shader.addLib(wd.SdfBitmapFontSmoothShaderLib.create());break;default:wd.Log.error(!0,wd.Log.info.FUNC_UNKNOW("sdfType:"+this.sdfType))}},BitmapFontMaterial.prototype._hasMultiPages=function(){return this.geometry.hasMultiPages()},BitmapFontMaterial.prototype._isSdfFont=function(){return this.enableSdf},__decorate([wd.cloneAttributeAsBasicType()],BitmapFontMaterial.prototype,"enableSdf",void 0),__decorate([wd.cloneAttributeAsBasicType()],BitmapFontMaterial.prototype,"sdfType",void 0),__decorate([wd.cloneAttributeAsBasicType()],BitmapFontMaterial.prototype,"alphaTest",void 0),__decorate([wd.requireSetter(function(map){wd.it("should add ImageTexture",function(){wd.expect(map).instanceOf(wd.ImageTexture)})}),wd.cloneAttributeAsCloneable()],BitmapFontMaterial.prototype,"bitmap",null),__decorate([wd.requireSetter(function(pageMapList){wd.it("pageMapList should be Collection type",function(){wd.expect(pageMapList).instanceOf(wdCb.Collection)})}),wd.cloneAttributeAsCloneable()],BitmapFontMaterial.prototype,"pageMapList",null),__decorate([wd.virtual,wd.require(function(){wd.it("should only set pageMap or bitmap ",function(){wd.expect(0!==this.pageMapList&&null===this.bitmap||null===this.pageMapList&&null!==this.bitmap).true},this),wd.describe("if has multi pages",function(){wd.it("each map in pageMapList should be all flipY or all not",function(){var count=this.pageMapList.filter(function(map){return map.flipY===!0}).getCount();wd.expect(0===count||count===this.pageMapList.getCount()).true})},function(){return null!==this.pageMapList&&this.pageMapList.getCount()>0},this)})],BitmapFontMaterial.prototype,"isMapFlipY",null),__decorate([wd.ensure(function(hasMultiPages){hasMultiPages&&wd.it("should has one page map at least",function(){wd.expect(this.pageMapList.getCount()).greaterThan(0)},this)})],BitmapFontMaterial.prototype,"_hasMultiPages",null),BitmapFontMaterial}(wd.StandardLightMaterial);wd.BitmapFontMaterial=BitmapFontMaterial}(wd||(wd={}));var wd;!function(wd){var BasicBitmapFontShaderLib=function(_super){function BasicBitmapFontShaderLib(){_super.apply(this,arguments),this.type="basic_bitmapFont"}return __extends(BasicBitmapFontShaderLib,_super),BasicBitmapFontShaderLib.create=function(){var obj=new this;return obj},BasicBitmapFontShaderLib}(wd.EngineShaderLib);wd.BasicBitmapFontShaderLib=BasicBitmapFontShaderLib}(wd||(wd={}));var wd;!function(wd){var CommonBitmapFontShaderLib=function(_super){function CommonBitmapFontShaderLib(){_super.apply(this,arguments),this.type="common_bitmapFont"}return __extends(CommonBitmapFontShaderLib,_super),CommonBitmapFontShaderLib.create=function(){var obj=new this;return obj},CommonBitmapFontShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addUniformVariable(["u_bitmapSampler"])},CommonBitmapFontShaderLib}(wd.EngineShaderLib);wd.CommonBitmapFontShaderLib=CommonBitmapFontShaderLib}(wd||(wd={}));var wd;!function(wd){var MultiPagesBitmapFontShaderLib=function(_super){function MultiPagesBitmapFontShaderLib(){_super.apply(this,arguments),this.type="multiPages_bitmapFont"}return __extends(MultiPagesBitmapFontShaderLib,_super),MultiPagesBitmapFontShaderLib.create=function(){var obj=new this;return obj},MultiPagesBitmapFontShaderLib.prototype.sendShaderVariables=function(program,cmd,material){var pageBuffer=cmd.buffers.getChild(wd.EBufferDataType.CUSTOM,"pages");pageBuffer&&this.sendAttributeBuffer(program,"a_page",pageBuffer)},MultiPagesBitmapFontShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),this.addAttributeVariable(["a_page"]),this.addUniformVariable(["u_pageSampler2Ds"]),this.fsSourceBody+=material.pageMapList.map(function(map,index){
var cond=0===index?"if":"else if";return cond+"(v_page == "+index+".0) {\n                    totalColor *= texture2D(u_pageSampler2Ds["+index+"], v_bitmapCoord);\n                    }"}).toArray().join("\n")+"\n",this.fsSourceDefineList.addChildren([{name:"PAGE_COUNT",value:material.pageMapList.getCount()}])},__decorate([wd.require(function(program,cmd,material){wd.it("should exist page buffer",function(){wd.expect(cmd.buffers.getChild(wd.EBufferDataType.CUSTOM,"pages")).exist})})],MultiPagesBitmapFontShaderLib.prototype,"sendShaderVariables",null),MultiPagesBitmapFontShaderLib}(wd.EngineShaderLib);wd.MultiPagesBitmapFontShaderLib=MultiPagesBitmapFontShaderLib}(wd||(wd={}));var wd;!function(wd){var SdfBitmapFontSmoothShaderLib=function(_super){function SdfBitmapFontSmoothShaderLib(){_super.apply(this,arguments),this.type="sdf_bitmapFont_smooth"}return __extends(SdfBitmapFontSmoothShaderLib,_super),SdfBitmapFontSmoothShaderLib.create=function(){var obj=new this;return obj},SdfBitmapFontSmoothShaderLib.prototype.setShaderDefinition=function(cmd,material){_super.prototype.setShaderDefinition.call(this,cmd,material),wd.GPUDetector.getInstance().extensionStandardDerivatives?(this.fsSourceExtensionList.addChild("GL_OES_standard_derivatives"),this.fsSourceFuncDefine=wd.ShaderChunk.sdf_bitmapFont_smoothStep_standardDerivatives.funcDefine):this.fsSourceFuncDefine=wd.ShaderChunk.sdf_bitmapFont_smoothStep_fallback.funcDefine,this.fsSourceBody+="if (gl_FragColor.a < "+material.alphaTest+"){\n    discard;\n}"},SdfBitmapFontSmoothShaderLib}(wd.EngineShaderLib);wd.SdfBitmapFontSmoothShaderLib=SdfBitmapFontSmoothShaderLib}(wd||(wd={}));var wd;!function(wd){!function(SdfBitmapFontType){SdfBitmapFontType[SdfBitmapFontType.SMOOTH=0]="SMOOTH"}(wd.SdfBitmapFontType||(wd.SdfBitmapFontType={}));wd.SdfBitmapFontType}(wd||(wd={}));var wd;!function(wd){var ActionEngine=function(_super){function ActionEngine(){_super.apply(this,arguments)}return __extends(ActionEngine,_super),ActionEngine.getInstance=function(){},ActionEngine.prototype.update=function(elapsed){var removeQueue=[];this.list.forEach(function(child){return child.isFinish?void removeQueue.push(child):void(child.isStop||child.isPause||child.update(elapsed))});for(var _i=0,removeQueue_1=removeQueue;_i<removeQueue_1.length;_i++){var child=removeQueue_1[_i];child.entityObject.removeComponent(child)}},ActionEngine=__decorate([wd.singleton()],ActionEngine)}(wd.ComponentContainer);wd.ActionEngine=ActionEngine}(wd||(wd={}));var wd;!function(wd){var ScriptEngine=function(){function ScriptEngine(){this._scriptList=wdCb.Collection.create()}return ScriptEngine.getInstance=function(){},ScriptEngine.prototype.addChild=function(entityObject,scriptName,classInstance){entityObject.scriptManager.addChild(scriptName,classInstance),this._scriptList.addChild(classInstance)},ScriptEngine.prototype.removeChild=function(entityObject,classInstance){entityObject.scriptManager.removeChild(classInstance),this._scriptList.removeChild(classInstance)},ScriptEngine.prototype.removeAllChildren=function(){this._scriptList.removeAllChildren()},ScriptEngine.prototype.findScript=function(entityObject,scriptName){return entityObject.scriptManager.getChild(scriptName)},ScriptEngine.prototype.execEntityObjectScript=function(entityObject,method){entityObject.scriptManager.execScript(method)},ScriptEngine.prototype.execEntityObjectScriptOnlyOnce=function(entityObject,method){entityObject.scriptManager.execScriptOnlyOnce(method)},ScriptEngine.prototype.execEntityObjectScriptWithData=function(entityObject,method,data){entityObject.scriptManager.execScriptWithData(method,data)},ScriptEngine.prototype.execScript=function(method){this._scriptList.forEach(function(script){script[method]&&script[method]()})},ScriptEngine.prototype.execScriptWithData=function(method,data){this._scriptList.forEach(function(script){script[method]&&script[method](data)})},ScriptEngine.prototype.execEntityObjectEventScriptWithData=function(entityObject,method,data){entityObject.scriptManager.execEventScriptWithData(method,data)},ScriptEngine=__decorate([wd.singleton()],ScriptEngine)}();wd.ScriptEngine=ScriptEngine}(wd||(wd={}));var wd;!function(wd){var LODEngine=function(_super){function LODEngine(){_super.apply(this,arguments)}return __extends(LODEngine,_super),LODEngine.getInstance=function(){},LODEngine.prototype.update=function(elapsed){this.list.forEach(function(child){child.update(elapsed)})},LODEngine=__decorate([wd.singleton()],LODEngine)}(wd.ComponentContainer);wd.LODEngine=LODEngine}(wd||(wd={}));var wd;!function(wd){var SpacePartitionEngine=function(_super){function SpacePartitionEngine(){_super.apply(this,arguments)}return __extends(SpacePartitionEngine,_super),SpacePartitionEngine.getInstance=function(){},SpacePartitionEngine.prototype.update=function(elapsed){this.list.forEach(function(child){child.update(elapsed)})},SpacePartitionEngine=__decorate([wd.singleton()],SpacePartitionEngine)}(wd.ComponentContainer);wd.SpacePartitionEngine=SpacePartitionEngine}(wd||(wd={}));var wd;!function(wd){var AnimationEngine=function(_super){function AnimationEngine(){_super.apply(this,arguments)}return __extends(AnimationEngine,_super),AnimationEngine.getInstance=function(){},AnimationEngine.prototype.update=function(elapsed){this.list.forEach(function(child){child.update(elapsed)})},AnimationEngine=__decorate([wd.singleton()],AnimationEngine)}(wd.ComponentContainer);wd.AnimationEngine=AnimationEngine}(wd||(wd={}));var wd;!function(wd){var CollisionEngine=function(_super){function CollisionEngine(){_super.apply(this,arguments),this._collisionDetector=wd.CollisionDetector.create()}return __extends(CollisionEngine,_super),CollisionEngine.getInstance=function(){},CollisionEngine.prototype.update=function(elapsed){this.list.forEach(function(child){child.update(elapsed)})},CollisionEngine.prototype.detect=function(elapsed){this._collisionDetector.update(elapsed)},CollisionEngine=__decorate([wd.singleton()],CollisionEngine)}(wd.ComponentContainer);wd.CollisionEngine=CollisionEngine}(wd||(wd={}));var wd;!function(wd){var PhysicsEngine=function(_super){function PhysicsEngine(){_super.apply(this,arguments),this.physicsEngineAdapter=wd.PhysicsEngineFactory.createNullAdapter()}return __extends(PhysicsEngine,_super),PhysicsEngine.getInstance=function(){},PhysicsEngine.prototype.removeChild=function(body){var physicsEngineAdapter=this.physicsEngineAdapter;if(_super.prototype.removeChild.call(this,body),physicsEngineAdapter){var entityObject=body.entityObject;physicsEngineAdapter.removeGameObject(entityObject),physicsEngineAdapter.removeConstraints(entityObject)}},PhysicsEngine.prototype.initPhysicsEngineAdapter=function(){var physics=wd.Director.getInstance().scene.physics;this.physicsEngineAdapter=wd.PhysicsEngineFactory.create(physics.enable,physics.engine),this.physicsEngineAdapter.init()},PhysicsEngine.prototype.initBody=function(){this.list.forEach(function(child){child.initBody()})},PhysicsEngine.prototype.initConstraint=function(){this.list.forEach(function(child){child.initConstraint()})},PhysicsEngine.prototype.update=function(elapsed){var physics=wd.Director.getInstance().scene.physics;physics.enable&&this.physicsEngineAdapter.update(elapsed)},PhysicsEngine=__decorate([wd.singleton()],PhysicsEngine)}(wd.ComponentContainer);wd.PhysicsEngine=PhysicsEngine}(wd||(wd={}));var wd;!function(wd){var BillboardEngine=function(_super){function BillboardEngine(){_super.apply(this,arguments)}return __extends(BillboardEngine,_super),BillboardEngine.getInstance=function(){},BillboardEngine.prototype.update=function(elapsed){this.list.forEach(function(child){child.update(elapsed)})},BillboardEngine=__decorate([wd.singleton()],BillboardEngine)}(wd.ComponentContainer);wd.BillboardEngine=BillboardEngine}(wd||(wd={}));var wd;!function(wd){var UIEngine=function(_super){function UIEngine(){_super.apply(this,arguments)}return __extends(UIEngine,_super),UIEngine.prototype.update=function(elapsed){this.list.forEach(function(child){child.update(elapsed)})},UIEngine=__decorate([wd.singleton()],UIEngine)}(wd.ComponentContainer);wd.UIEngine=UIEngine}(wd||(wd={}));var wd;!function(wd){var ThreeDUIEngine=function(_super){function ThreeDUIEngine(){_super.apply(this,arguments)}return __extends(ThreeDUIEngine,_super),ThreeDUIEngine.getInstance=function(){},ThreeDUIEngine=__decorate([wd.singleton()],ThreeDUIEngine)}(wd.UIEngine);wd.ThreeDUIEngine=ThreeDUIEngine}(wd||(wd={}));var wd;!function(wd){var TwoDUIEngine=function(_super){function TwoDUIEngine(){_super.apply(this,arguments)}return __extends(TwoDUIEngine,_super),TwoDUIEngine.getInstance=function(){},TwoDUIEngine.prototype.render=function(){var _this=this;this.list.forEach(function(ui){_this._isDirty(ui.entityObject)&&ui.render()},this)},TwoDUIEngine.prototype._isDirty=function(uiObject){return uiObject.getComponent(wd.UIRenderer).state===wd.EUIRendererState.DIRTY},TwoDUIEngine=__decorate([wd.singleton()],TwoDUIEngine)}(wd.UIEngine);wd.TwoDUIEngine=TwoDUIEngine}(wd||(wd={}));