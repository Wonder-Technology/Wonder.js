!function(t,e){"undefined"!=typeof module&&module.exports?module.exports.browser=e():"function"==typeof define&&define.amd?define(e):this[t]=e()}("bowser",function(){function t(t){function r(e){var r=t.match(e);return r&&r.length>1&&r[1]||""}var n,o=r(/(ipod|iphone|ipad)/i).toLowerCase(),i=/like android/i.test(t),a=!i&&/android/i.test(t),s=r(/version\/(\d+(\.\d+)?)/i),c=/tablet/i.test(t),u=!c&&/[^-]mobi/i.test(t);/opera|opr/i.test(t)?n={name:"Opera",opera:e,version:s||r(/(?:opera|opr)[\s\/](\d+(\.\d+)?)/i)}:/windows phone/i.test(t)?n={name:"Windows Phone",windowsphone:e,msie:e,version:r(/iemobile\/(\d+(\.\d+)?)/i)}:/msie|trident/i.test(t)?n={name:"Internet Explorer",msie:e,version:r(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:/chrome|crios|crmo/i.test(t)?n={name:"Chrome",chrome:e,version:r(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:o?(n={name:"iphone"==o?"iPhone":"ipad"==o?"iPad":"iPod"},s&&(n.version=s)):/sailfish/i.test(t)?n={name:"Sailfish",sailfish:e,version:r(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(t)?n={name:"SeaMonkey",seamonkey:e,version:r(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel/i.test(t)?(n={name:"Firefox",firefox:e,version:r(/(?:firefox|iceweasel)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(t)&&(n.firefoxos=e)):/silk/i.test(t)?n={name:"Amazon Silk",silk:e,version:r(/silk\/(\d+(\.\d+)?)/i)}:a?n={name:"Android",version:s}:/phantom/i.test(t)?n={name:"PhantomJS",phantom:e,version:r(/phantomjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(t)||/rim\stablet/i.test(t)?n={name:"BlackBerry",blackberry:e,version:s||r(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:/(web|hpw)os/i.test(t)?(n={name:"WebOS",webos:e,version:s||r(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(t)&&(n.touchpad=e)):n=/bada/i.test(t)?{name:"Bada",bada:e,version:r(/dolfin\/(\d+(\.\d+)?)/i)}:/tizen/i.test(t)?{name:"Tizen",tizen:e,version:r(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||s}:/safari/i.test(t)?{name:"Safari",safari:e,version:s}:{},/(apple)?webkit/i.test(t)?(n.name=n.name||"Webkit",n.webkit=e,!n.version&&s&&(n.version=s)):!n.opera&&/gecko\//i.test(t)&&(n.name=n.name||"Gecko",n.gecko=e,n.version=n.version||r(/gecko\/(\d+(\.\d+)?)/i)),a||n.silk?n.android=e:o&&(n[o]=e,n.ios=e);var l="";o?(l=r(/os (\d+([_\s]\d+)*) like mac os x/i),l=l.replace(/[_\s]/g,".")):a?l=r(/android[ \/-](\d+(\.\d+)*)/i):n.windowsphone?l=r(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):n.webos?l=r(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):n.blackberry?l=r(/rim\stablet\sos\s(\d+(\.\d+)*)/i):n.bada?l=r(/bada\/(\d+(\.\d+)*)/i):n.tizen&&(l=r(/tizen[\/\s](\d+(\.\d+)*)/i)),l&&(n.osversion=l);var h=l.split(".")[0];return c||"ipad"==o||a&&(3==h||4==h&&!u)||n.silk?n.tablet=e:(u||"iphone"==o||"ipod"==o||a||n.blackberry||n.webos||n.bada)&&(n.mobile=e),n.msie&&n.version>=10||n.chrome&&n.version>=20||n.firefox&&n.version>=20||n.safari&&n.version>=6||n.opera&&n.version>=10||n.ios&&n.osversion&&n.osversion.split(".")[0]>=6||n.blackberry&&n.version>=10.1?n.a=e:n.msie&&n.version<10||n.chrome&&n.version<20||n.firefox&&n.version<20||n.safari&&n.version<6||n.opera&&n.version<10||n.ios&&n.osversion&&n.osversion.split(".")[0]<6?n.c=e:n.x=e,n}var e=!0,r=t("undefined"!=typeof navigator?navigator.userAgent:"");return r._detect=t,r}),function(){"use strict";function t(t){return"function"==typeof t||"object"==typeof t&&null!==t}function e(t){return"function"==typeof t}function r(t){return"object"==typeof t&&null!==t}function n(){}function o(t,e){for(var r=0,n=t.length;n>r;r++)if(t[r]===e)return r;return-1}function i(t){var e=t._promiseCallbacks;return e||(e=t._promiseCallbacks={}),e}function a(t,e){return"onerror"===t?void Ct.on("error",e):2!==arguments.length?Ct[t]:void(Ct[t]=e)}function s(){setTimeout(function(){for(var t,e=0;e<Et.length;e++){t=Et[e];var r=t.payload;r.guid=r.key+r.id,r.childGuid=r.key+r.childId,r.error&&(r.stack=r.error.stack),Ct.trigger(t.name,t.payload)}Et.length=0},50)}function c(t,e,r){1===Et.push({name:t,payload:{key:e._guidKey,id:e._id,eventName:t,detail:e._result,childId:r&&r._id,label:e._label,timeStamp:mt(),error:Ct["instrument-with-stack"]?new Error(e._label):null}})&&s()}function u(){return new TypeError("A promises callback cannot return that same promise.")}function l(){}function h(t){try{return t.then}catch(e){return xt.error=e,xt}}function p(t,e,r,n){try{t.call(e,r,n)}catch(o){return o}}function f(t,e,r){Ct.async(function(t){var n=!1,o=p(r,e,function(r){n||(n=!0,e!==r?y(t,r):m(t,r))},function(e){n||(n=!0,v(t,e))},"Settle: "+(t._label||" unknown promise"));!n&&o&&(n=!0,v(t,o))},t)}function d(t,e){e._state===Ot?m(t,e._result):e._state===St?(e._onError=null,v(t,e._result)):b(e,void 0,function(r){e!==r?y(t,r):m(t,r)},function(e){v(t,e)})}function _(t,r){if(r.constructor===t.constructor)d(t,r);else{var n=h(r);n===xt?v(t,xt.error):void 0===n?m(t,r):e(n)?f(t,r,n):m(t,r)}}function y(e,r){e===r?m(e,r):t(r)?_(e,r):m(e,r)}function g(t){t._onError&&t._onError(t._result),C(t)}function m(t,e){t._state===Tt&&(t._result=e,t._state=Ot,0===t._subscribers.length?Ct.instrument&&wt("fulfilled",t):Ct.async(C,t))}function v(t,e){t._state===Tt&&(t._state=St,t._result=e,Ct.async(g,t))}function b(t,e,r,n){var o=t._subscribers,i=o.length;t._onError=null,o[i]=e,o[i+Ot]=r,o[i+St]=n,0===i&&t._state&&Ct.async(C,t)}function C(t){var e=t._subscribers,r=t._state;if(Ct.instrument&&wt(r===Ot?"fulfilled":"rejected",t),0!==e.length){for(var n,o,i=t._result,a=0;a<e.length;a+=3)n=e[a],o=e[a+r],n?T(r,n,o,i):o(i);t._subscribers.length=0}}function E(){this.error=null}function w(t,e){try{return t(e)}catch(r){return Dt.error=r,Dt}}function T(t,r,n,o){var i,a,s,c,l=e(n);if(l){if(i=w(n,o),i===Dt?(c=!0,a=i.error,i=null):s=!0,r===i)return void v(r,u())}else i=o,s=!0;r._state!==Tt||(l&&s?y(r,i):c?v(r,a):t===Ot?m(r,i):t===St&&v(r,i))}function O(t,e){var r=!1;try{e(function(e){r||(r=!0,y(t,e))},function(e){r||(r=!0,v(t,e))})}catch(n){v(t,n)}}function S(t,e,r){return t===Ot?{state:"fulfilled",value:r}:{state:"rejected",reason:r}}function x(t,e,r,n){this._instanceConstructor=t,this.promise=new t(l,n),this._abortOnReject=r,this._validateInput(e)?(this._input=e,this.length=e.length,this._remaining=e.length,this._init(),0===this.length?m(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&m(this.promise,this._result))):v(this.promise,this._validationError())}function D(t,e){return new Lt(this,t,!0,e).promise}function L(t,e){function r(t){y(i,t)}function n(t){v(i,t)}var o=this,i=new o(l,e);if(!gt(t))return v(i,new TypeError("You must pass an array to race.")),i;for(var a=t.length,s=0;i._state===Tt&&a>s;s++)b(o.resolve(t[s]),void 0,r,n);return i}function M(t,e){var r=this;if(t&&"object"==typeof t&&t.constructor===r)return t;var n=new r(l,e);return y(n,t),n}function A(t,e){var r=this,n=new r(l,e);return v(n,t),n}function R(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function P(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function N(t,r){this._id=Ft++,this._label=r,this._state=void 0,this._result=void 0,this._subscribers=[],Ct.instrument&&wt("created",this),l!==t&&(e(t)||R(),this instanceof N||P(),O(this,t))}function F(t,e,r){this._superConstructor(t,e,!1,r)}function U(t,e){return new F(Ut,t,e).promise}function j(t,e){return Ut.all(t,e)}function I(t,e){Jt[Gt]=t,Jt[Gt+1]=e,Gt+=2,2===Gt&&It()}function B(){var t=process.nextTick,e=process.versions.node.match(/^(?:(\d+)\.)?(?:(\d+)\.)?(\*|\d+)$/);return Array.isArray(e)&&"0"===e[1]&&"10"===e[2]&&(t=setImmediate),function(){t(W)}}function V(){return function(){jt(W)}}function G(){var t=0,e=new zt(W),r=document.createTextNode("");return e.observe(r,{characterData:!0}),function(){r.data=t=++t%2}}function H(){var t=new MessageChannel;return t.port1.onmessage=W,function(){t.port2.postMessage(0)}}function k(){return function(){setTimeout(W,1)}}function W(){for(var t=0;Gt>t;t+=2){var e=Jt[t],r=Jt[t+1];e(r),Jt[t]=void 0,Jt[t+1]=void 0}Gt=0}function z(){try{var t=require,e=t("vertx");return jt=e.runOnLoop||e.runOnContext,V()}catch(r){return k()}}function q(t){var e={};return e.promise=new Ut(function(t,r){e.resolve=t,e.reject=r},t),e}function X(t,r,n){return Ut.all(t,n).then(function(t){if(!e(r))throw new TypeError("You must pass a function as filter's second argument.");for(var o=t.length,i=new Array(o),a=0;o>a;a++)i[a]=r(t[a]);return Ut.all(i,n).then(function(e){for(var r=new Array(o),n=0,i=0;o>i;i++)e[i]&&(r[n]=t[i],n++);return r.length=n,r})})}function J(t,e,r){this._superConstructor(t,e,!0,r)}function K(t,e,r){this._superConstructor(t,e,!1,r)}function Y(t,e){return new K(Ut,t,e).promise}function Q(t,e){return new Qt(Ut,t,e).promise}function $(t,r,n){return Ut.all(t,n).then(function(t){if(!e(r))throw new TypeError("You must pass a function as map's second argument.");for(var o=t.length,i=new Array(o),a=0;o>a;a++)i[a]=r(t[a]);return Ut.all(i,n)})}function Z(){this.value=void 0}function tt(t){try{return t.then}catch(e){return ee.value=e,ee}}function et(t,e,r){try{t.apply(e,r)}catch(n){return ee.value=n,ee}}function rt(t,e){for(var r,n,o={},i=t.length,a=new Array(i),s=0;i>s;s++)a[s]=t[s];for(n=0;n<e.length;n++)r=e[n],o[r]=a[n+1];return o}function nt(t){for(var e=t.length,r=new Array(e-1),n=1;e>n;n++)r[n-1]=t[n];return r}function ot(t,e){return{then:function(r,n){return t.call(e,r,n)}}}function it(t,e){var r=function(){for(var r,n=this,o=arguments.length,i=new Array(o+1),a=!1,s=0;o>s;++s){if(r=arguments[s],!a){if(a=ct(r),a===re){var c=new Ut(l);return v(c,re.value),c}a&&a!==!0&&(r=ot(a,r))}i[s]=r}var u=new Ut(l);return i[o]=function(t,r){t?v(u,t):void 0===e?y(u,r):e===!0?y(u,nt(arguments)):gt(e)?y(u,rt(arguments,e)):y(u,r)},a?st(u,i,t,n):at(u,i,t,n)};return r.__proto__=t,r}function at(t,e,r,n){var o=et(r,n,e);return o===ee&&v(t,o.value),t}function st(t,e,r,n){return Ut.all(e).then(function(e){var o=et(r,n,e);return o===ee&&v(t,o.value),t})}function ct(t){return t&&"object"==typeof t?t.constructor===Ut?!0:tt(t):!1}function ut(t,e){return Ut.race(t,e)}function lt(t,e){return Ut.reject(t,e)}function ht(t,e){return Ut.resolve(t,e)}function pt(t){throw setTimeout(function(){throw t}),t}function ft(t,e){Ct.async(t,e)}function dt(){Ct.on.apply(Ct,arguments)}function _t(){Ct.off.apply(Ct,arguments)}var yt;yt=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};var gt=yt,mt=Date.now||function(){return(new Date).getTime()},vt=Object.create||function(t){if(arguments.length>1)throw new Error("Second argument not supported");if("object"!=typeof t)throw new TypeError("Argument must be an object");return n.prototype=t,new n},bt={mixin:function(t){return t.on=this.on,t.off=this.off,t.trigger=this.trigger,t._promiseCallbacks=void 0,t},on:function(t,e){var r,n=i(this);r=n[t],r||(r=n[t]=[]),-1===o(r,e)&&r.push(e)},off:function(t,e){var r,n,a=i(this);return e?(r=a[t],n=o(r,e),void(-1!==n&&r.splice(n,1))):void(a[t]=[])},trigger:function(t,e){var r,n,o=i(this);if(r=o[t])for(var a=0;a<r.length;a++)(n=r[a])(e)}},Ct={instrument:!1};bt.mixin(Ct);var Et=[],wt=c,Tt=void 0,Ot=1,St=2,xt=new E,Dt=new E,Lt=x;x.prototype._validateInput=function(t){return gt(t)},x.prototype._validationError=function(){return new Error("Array Methods must be provided an Array")},x.prototype._init=function(){this._result=new Array(this.length)},x.prototype._enumerate=function(){for(var t=this.length,e=this.promise,r=this._input,n=0;e._state===Tt&&t>n;n++)this._eachEntry(r[n],n)},x.prototype._eachEntry=function(t,e){var n=this._instanceConstructor;r(t)?t.constructor===n&&t._state!==Tt?(t._onError=null,this._settledAt(t._state,e,t._result)):this._willSettleAt(n.resolve(t),e):(this._remaining--,this._result[e]=this._makeResult(Ot,e,t))},x.prototype._settledAt=function(t,e,r){var n=this.promise;n._state===Tt&&(this._remaining--,this._abortOnReject&&t===St?v(n,r):this._result[e]=this._makeResult(t,e,r)),0===this._remaining&&m(n,this._result)},x.prototype._makeResult=function(t,e,r){return r},x.prototype._willSettleAt=function(t,e){var r=this;b(t,void 0,function(t){r._settledAt(Ot,e,t)},function(t){r._settledAt(St,e,t)})};var Mt=D,At=L,Rt=M,Pt=A,Nt="rsvp_"+mt()+"-",Ft=0,Ut=N;N.cast=Rt,N.all=Mt,N.race=At,N.resolve=Rt,N.reject=Pt,N.prototype={constructor:N,_guidKey:Nt,_onError:function(t){Ct.async(function(e){setTimeout(function(){e._onError&&Ct.trigger("error",t)},0)},this)},then:function(t,e,r){var n=this,o=n._state;if(o===Ot&&!t||o===St&&!e)return Ct.instrument&&wt("chained",this,this),this;n._onError=null;var i=new this.constructor(l,r),a=n._result;if(Ct.instrument&&wt("chained",n,i),o){var s=arguments[o-1];Ct.async(function(){T(o,i,s,a)})}else b(n,i,t,e);return i},"catch":function(t,e){return this.then(null,t,e)},"finally":function(t,e){var r=this.constructor;return this.then(function(e){return r.resolve(t()).then(function(){return e})},function(e){return r.resolve(t()).then(function(){throw e})},e)}},F.prototype=vt(Lt.prototype),F.prototype._superConstructor=Lt,F.prototype._makeResult=S,F.prototype._validationError=function(){return new Error("allSettled must be called with an array")};var jt,It,Bt=U,Vt=j,Gt=0,Ht=({}.toString,I),kt="undefined"!=typeof window?window:void 0,Wt=kt||{},zt=Wt.MutationObserver||Wt.WebKitMutationObserver,qt="undefined"!=typeof process&&"[object process]"==={}.toString.call(process),Xt="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,Jt=new Array(1e3);It=qt?B():zt?G():Xt?H():void 0===kt&&"function"==typeof require?z():k();var Kt=q,Yt=X,Qt=J;J.prototype=vt(Lt.prototype),J.prototype._superConstructor=Lt,J.prototype._init=function(){this._result={}},J.prototype._validateInput=function(t){return t&&"object"==typeof t},J.prototype._validationError=function(){return new Error("Promise.hash must be called with an object")},J.prototype._enumerate=function(){var t=this.promise,e=this._input,r=[];for(var n in e)t._state===Tt&&Object.prototype.hasOwnProperty.call(e,n)&&r.push({position:n,entry:e[n]});var o=r.length;this._remaining=o;for(var i,a=0;t._state===Tt&&o>a;a++)i=r[a],this._eachEntry(i.entry,i.position)},K.prototype=vt(Qt.prototype),K.prototype._superConstructor=Lt,K.prototype._makeResult=S,K.prototype._validationError=function(){return new Error("hashSettled must be called with an object")};var $t=Y,Zt=Q,te=$,ee=new Z,re=new Z,ne=it,oe=ut,ie=lt,ae=ht,se=pt;Ct.async=Ht;if("undefined"!=typeof window&&"object"==typeof window.__PROMISE_INSTRUMENTATION__){var ce=window.__PROMISE_INSTRUMENTATION__;a("instrument",!0);for(var ue in ce)ce.hasOwnProperty(ue)&&dt(ue,ce[ue])}var le={race:oe,Promise:Ut,allSettled:Bt,hash:Zt,hashSettled:$t,denodeify:ne,on:dt,off:_t,map:te,filter:Yt,resolve:ae,reject:ie,all:Vt,rethrow:se,defer:Kt,EventTarget:bt,configure:a,async:ft};"function"==typeof define&&define.amd?define(function(){return le}):"undefined"!=typeof module&&module.exports?module.exports=le:"undefined"!=typeof this&&(this.RSVP=le)}.call(this);var wdCb;!function(t){var e=Math.pow(2,53)-1,r=function(){function t(){}return t.isArray=function(t){var r=t&&t.length;return"number"==typeof r&&r>=0&&e>=r},t.isArrayExactly=function(t){return"[object Array]"===Object.prototype.toString.call(t)},t.isNumber=function(t){return"number"==typeof t},t.isNumberExactly=function(t){return"[object Number]"===Object.prototype.toString.call(t)},t.isString=function(t){return"string"==typeof t},t.isStringExactly=function(t){return"[object String]"===Object.prototype.toString.call(t)},t.isBoolean=function(t){return t===!0||t===!1||"[boolect Boolean]"===toString.call(t)},t.isDom=function(t){return!(!t||1!==t.nodeType)},t.isObject=function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},t.isDirectObject=function(t){return"[object Object]"===Object.prototype.toString.call(t)},t.isHostMethod=function(t,e){var r=typeof t[e];return"function"===r||"object"===r&&!!t[e]||"unknown"===r},t.isNodeJs=function(){return("undefined"!=typeof global&&global.module||"undefined"!=typeof module)&&"undefined"!=typeof module.exports},t.isFunction=function(t){return!0},t}();t.JudgeUtils=r,"function"!=typeof/./&&"object"!=typeof Int8Array?r.isFunction=function(t){return"function"==typeof t}:r.isFunction=function(t){return"[object Function]"===Object.prototype.toString.call(t)}}(wdCb||(wdCb={}));var wdCb;!function(t){Object.defineProperty(t,"root",{get:function(){return t.JudgeUtils.isNodeJs()?global:window}})}(wdCb||(wdCb={}));var wdCb;!function(t){if("performance"in t.root==!1&&(t.root.performance={}),Date.now=Date.now||function(){return(new Date).getTime()},"now"in t.root.performance==!1){var e=t.root.performance.timing&&t.root.performance.timing.navigationStart?performance.timing.navigationStart:Date.now();t.root.performance.now=function(){return Date.now()-e}}}(wdCb||(wdCb={}));var wdCb;!function(t){t.$BREAK={"break":!0},t.$REMOVE=void 0}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.log=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];this._exec("log",e)||t.root.alert(e.join(",")),this._exec("trace",e)},e.assert=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];t&&(this._exec("assert",arguments,1)||this.log.apply(this,Array.prototype.slice.call(arguments,1)))},e.error=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(t)throw new Error(Array.prototype.slice.call(arguments,1).join("\n"))},e.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=this._exec("warn",arguments);r?this._exec("trace",["warn trace"]):this.log.apply(this,arguments)},e._exec=function(e,r,n){return void 0===n&&(n=0),t.root.console&&t.root.console[e]?(t.root.console[e].apply(t.root.console,Array.prototype.slice.call(r,n)),!0):!1},e.info={INVALID_PARAM:"invalid parameter",ABSTRACT_ATTRIBUTE:"abstract attribute need override",ABSTRACT_METHOD:"abstract method need override",helperFunc:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r="";return t.forEach(function(t){r+=String(t)+" "}),r.slice(0,-1)},assertion:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(2===t.length)return this.helperFunc(t[0],t[1]);if(3===t.length)return this.helperFunc(t[1],t[0],t[2]);throw new Error("args.length must <= 3")},FUNC_INVALID:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("invalid"),this.assertion.apply(this,t)},FUNC_MUST:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must"),this.assertion.apply(this,t)},FUNC_MUST_BE:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must be"),this.assertion.apply(this,t)},FUNC_MUST_NOT_BE:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must not be"),this.assertion.apply(this,t)},FUNC_SHOULD:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("should"),this.assertion.apply(this,t)},FUNC_SHOULD_NOT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("should not"),this.assertion.apply(this,t)},FUNC_SUPPORT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("support"),this.assertion.apply(this,t)},FUNC_NOT_SUPPORT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("not support"),this.assertion.apply(this,t)},FUNC_MUST_DEFINE:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must define"),this.assertion.apply(this,t)},FUNC_MUST_NOT_DEFINE:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("must not define"),this.assertion.apply(this,t)},FUNC_UNKNOW:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("unknow"),this.assertion.apply(this,t)},FUNC_EXPECT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("expect"),this.assertion.apply(this,t)},FUNC_UNEXPECT:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("unexpect"),this.assertion.apply(this,t)},FUNC_NOT_EXIST:function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return t.unshift("not exist"),this.assertion.apply(this,t)}},e}();t.Log=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){this.children=null}return e.prototype.getCount=function(){return this.children.length},e.prototype.hasChild=function(t){for(var e=null,r=this.children,n=0,o=r.length;o>n;n++){if(e=r[n],t.uid&&e.uid&&t.uid==e.uid)return!0;if(t===e)return!0}return!1},e.prototype.hasChildWithFunc=function(t){for(var e=0,r=this.children.length;r>e;e++)if(t(this.children[e],e))return!0;return!1},e.prototype.getChildren=function(){return this.children},e.prototype.getChild=function(t){return this.children[t]},e.prototype.addChild=function(t){return this.children.push(t),this},e.prototype.addChildren=function(r){if(t.JudgeUtils.isArray(r)){var n=r;this.children=this.children.concat(n)}else if(r instanceof e){var n=r;this.children=this.children.concat(n.getChildren())}else{var o=r;this.addChild(o)}return this},e.prototype.unShiftChild=function(t){this.children.unshift(t)},e.prototype.removeAllChildren=function(){return this.children=[],this},e.prototype.forEach=function(t,e){return this._forEach(this.children,t,e),this},e.prototype.toArray=function(){return this.children},e.prototype.copyChildren=function(){return this.children.slice(0)},e.prototype.removeChildHelper=function(e){var r=null;if(t.JudgeUtils.isFunction(e)){var n=e;r=this._removeChild(this.children,n)}else r=e.uid?this._removeChild(this.children,function(t){return t.uid?t.uid===e.uid:!1}):this._removeChild(this.children,function(t){return t===e});return r},e.prototype._forEach=function(e,r,n){var o=n||t.root,i=0,a=e.length;for(i=0;a>i&&r.call(o,e[i],i)!==t.$BREAK;i++);},e.prototype._removeChild=function(t,e){var r=this,n=[],o=[];return this._forEach(t,function(t,i){e.call(r,t)?n.push(t):o.push(t)}),this.children=o,n},e}();t.List=e}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdCb;!function(t){var e=function(e){function r(t){void 0===t&&(t=[]),e.call(this),this.children=t}return __extends(r,e),r.create=function(t){void 0===t&&(t=[]);var e=new this(t);return e},r.prototype.copy=function(e){return void 0===e&&(e=!1),e?r.create(t.ExtendUtils.extendDeep(this.children)):r.create(t.ExtendUtils.extend([],this.children))},r.prototype.filter=function(t){for(var e=this.children,n=[],o=null,i=0,a=e.length;a>i;i++)o=e[i],t.call(e,o,i)&&n.push(o);return r.create(n)},r.prototype.findOne=function(e){var r=this.children,n=null;return this.forEach(function(o,i){return e.call(r,o,i)?(n=o,t.$BREAK):void 0}),n},r.prototype.reverse=function(){return r.create(this.copyChildren().reverse())},r.prototype.removeChild=function(t){return r.create(this.removeChildHelper(t))},r.prototype.sort=function(t,e){return void 0===e&&(e=!1),e?(this.children.sort(t),this):r.create(this.copyChildren().sort(t))},r.prototype.map=function(e){var n=[];return this.forEach(function(r,o){var i=e(r,o);i!==t.$REMOVE&&n.push(i)}),r.create(n)},r.prototype.removeRepeatItems=function(){var t=r.create();return this.forEach(function(e){t.hasChild(e)||t.addChild(e)}),t},r}(t.List);t.Collection=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(t){void 0===t&&(t={}),this._children=null,this._children=t}return e.create=function(t){void 0===t&&(t={});var e=new this(t);return e},e.prototype.getChildren=function(){return this._children},e.prototype.getCount=function(){var t=0,e=this._children,r=null;for(r in e)e.hasOwnProperty(r)&&t++;return t},e.prototype.getKeys=function(){var e=t.Collection.create(),r=this._children,n=null;for(n in r)r.hasOwnProperty(n)&&e.addChild(n);return e},e.prototype.getValues=function(){var e=t.Collection.create(),r=this._children,n=null;for(n in r)r.hasOwnProperty(n)&&e.addChild(r[n]);return e},e.prototype.getChild=function(t){return this._children[t]},e.prototype.setValue=function(t,e){return this._children[t]=e,this},e.prototype.addChild=function(t,e){return this._children[t]=e,this},e.prototype.addChildren=function(t){var r=null,n=null;n=t instanceof e?t.getChildren():t;for(r in n)n.hasOwnProperty(r)&&this.addChild(r,n[r])},e.prototype.appendChild=function(e,r){if(this._children[e]instanceof t.Collection){var n=this._children[e];n.addChild(r)}else this._children[e]=t.Collection.create().addChild(r);return this},e.prototype.removeChild=function(e){var r=[];if(t.JudgeUtils.isString(e)){var n=e;r.push(this._children[n]),this._children[n]=void 0,delete this._children[n]}else if(t.JudgeUtils.isFunction(e)){var o=e,i=this;this.forEach(function(t,e){o(t,e)&&(r.push(i._children[e]),i._children[e]=void 0,delete i._children[e])})}return t.Collection.create(r)},e.prototype.removeAllChildren=function(){this._children={}},e.prototype.hasChild=function(t){return void 0!==this._children[t]},e.prototype.hasChildWithFunc=function(e){var r=!1;return this.forEach(function(n,o){return e(n,o)?(r=!0,t.$BREAK):void 0}),r},e.prototype.forEach=function(e,r){var n=this._children;for(var o in n)if(n.hasOwnProperty(o)&&e.call(r,n[o],o)===t.$BREAK)break;return this},e.prototype.filter=function(t){var r={},n=this._children,o=null;for(var i in n)n.hasOwnProperty(i)&&(o=n[i],t.call(n,o,i)&&(r[i]=o));return e.create(r)},e.prototype.findOne=function(e){var r=[],n=this,o=this._children;return this.forEach(function(i,a){return e.call(o,i,a)?(r=[a,n.getChild(a)],t.$BREAK):void 0}),r},e.prototype.map=function(r){var n={};return this.forEach(function(e,o){var i=r(e,o);i!==t.$REMOVE&&(t.Log.error(!t.JudgeUtils.isArray(i)||2!==i.length,t.Log.info.FUNC_MUST_BE("iterator","[key, value]")),n[i[0]]=i[1])}),e.create(n)},e.prototype.toCollection=function(){var e=t.Collection.create();return this.forEach(function(r,n){r instanceof t.Collection?e.addChildren(r):e.addChild(r)}),e},e.prototype.toArray=function(){var e=[];return this.forEach(function(r,n){r instanceof t.Collection?e=e.concat(r.getChildren()):e.push(r)}),e},e}();t.Hash=e}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdCb;!function(t){var e=function(t){function e(e){void 0===e&&(e=[]),t.call(this),this.children=e}return __extends(e,t),e.create=function(t){void 0===t&&(t=[]);var e=new this(t);return e},Object.defineProperty(e.prototype,"front",{get:function(){return this.children[this.children.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rear",{get:function(){return this.children[0]},enumerable:!0,configurable:!0}),e.prototype.push=function(t){this.children.unshift(t)},e.prototype.pop=function(){return this.children.pop()},e.prototype.clear=function(){this.removeAllChildren()},e}(t.List);t.Queue=e}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdCb;!function(t){var e=function(t){function e(e){void 0===e&&(e=[]),t.call(this),this.children=e}return __extends(e,t),e.create=function(t){void 0===t&&(t=[]);var e=new this(t);return e},Object.defineProperty(e.prototype,"top",{get:function(){return this.children[this.children.length-1]},enumerable:!0,configurable:!0}),e.prototype.push=function(t){this.children.push(t)},e.prototype.pop=function(){return this.children.pop()},e.prototype.clear=function(){this.removeAllChildren()},e}(t.List);t.Stack=e}(wdCb||(wdCb={}));var wdCb;!function(wdCb){var AjaxUtils=function(){function AjaxUtils(){}return AjaxUtils.ajax=function(conf){var type=conf.type,url=conf.url,data=conf.data,dataType=conf.dataType,success=conf.success,error=conf.error,xhr=null,self=this;if(null===type&&(type="get"),null===dataType&&(dataType="text"),xhr=this._createAjax(error))try{xhr.open(type,url,!0),this._isSoundFile(dataType)&&(xhr.responseType="arraybuffer"),"GET"===type||"get"===type?xhr.send(null):("POST"===type||"post"===type)&&(xhr.setRequestHeader("content-type","application/x-www-form-urlencoded"),xhr.send(data)),xhr.onreadystatechange=function(){4!==xhr.readyState||200!==xhr.status&&!self._isLocalFile(xhr.status)||("text"===dataType||"TEXT"===dataType?null!==success&&success(xhr.responseText):"xml"===dataType||"XML"===dataType?null!==success&&success(xhr.responseXML):"json"===dataType||"JSON"===dataType?null!==success&&success(eval("("+xhr.responseText+")")):self._isSoundFile(dataType)&&null!==success&&success(xhr.response))}}catch(e){error(xhr,e)}},AjaxUtils._createAjax=function(t){var e=null;try{e=new ActiveXObject("microsoft.xmlhttp")}catch(r){try{e=new XMLHttpRequest}catch(n){return t(e,{message:"您的浏览器不支持ajax，请更换！"}),null}}return e},AjaxUtils._isLocalFile=function(t){return document.URL.contain("file://")&&0===t},AjaxUtils._isSoundFile=function(t){return"arraybuffer"===t},AjaxUtils}();wdCb.AjaxUtils=AjaxUtils}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.removeRepeatItems=function(t,e){void 0===e&&(e=function(t,e){return t===e});var r=[],n=this;return t.forEach(function(t){n.contain(r,function(r){return e(r,t)})||r.push(t)}),r},e.contain=function(e,r){if(t.JudgeUtils.isFunction(r))for(var n=r,o=0,i=e.length;i>o;o++){var a=e[o];if(n.call(null,a,o))return!0}else for(var o=0,i=e.length;i>o;o++){var a=e[o];if(r===a||a.contain&&a.contain(r))return!0}return!1},e}();t.ArrayUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.toString=function(e){return t.JudgeUtils.isNumber(e)?String(e):t.JudgeUtils.isFunction(e)?this._convertCodeToString(e):t.JudgeUtils.isDirectObject(e)||t.JudgeUtils.isArray(e)?JSON.stringify(e):String(e)},e._convertCodeToString=function(t){return t.toString().split("\n").slice(1,-1).join("\n")+"\n"},e}();t.ConvertUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.bindEvent=function(t,e){return function(r){return e.call(t,r)}},e.addEvent=function(e,r,n){t.JudgeUtils.isHostMethod(e,"addEventListener")?e.addEventListener(r,n,!1):t.JudgeUtils.isHostMethod(e,"attachEvent")?e.attachEvent("on"+r,n):e["on"+r]=n},e.removeEvent=function(e,r,n){t.JudgeUtils.isHostMethod(e,"removeEventListener")?e.removeEventListener(r,n,!1):t.JudgeUtils.isHostMethod(e,"detachEvent")?e.detachEvent("on"+r,n):e["on"+r]=null},e}();t.EventUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){}return e.extendDeep=function(t,e,r){void 0===r&&(r=function(t,e){return!0});var n=null,o=0,i=Object.prototype.toString,a="[object Array]",s="[object Object]",c="",u=null;if(i.call(t)===a)for(u=e||[],n=0,o=t.length;o>n;n++)r(t[n],n)&&(c=i.call(t[n]),c===a||c===s?(u[n]=c===a?[]:{},arguments.callee(t[n],u[n])):u[n]=t[n]);else if(i.call(t)===s){u=e||{};for(n in t)r(t[n],n)&&(c=i.call(t[n]),c===a||c===s?(u[n]=c===a?[]:{},arguments.callee(t[n],u[n])):u[n]=t[n])}else u=t;return u},e.extend=function(t,e){var r="";for(r in e)t[r]=e[r];return t},e.copyPublicAttri=function(e){var r={};return this.extendDeep(e,r,function(e,r){return"_"!==r.slice(0,1)&&!t.JudgeUtils.isFunction(e)}),r},e}();t.ExtendUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,r=function(){function t(){}return t.basename=function(t,e){var r=this._splitPath(t)[2];return e&&r.substr(-1*e.length)===e&&(r=r.substr(0,r.length-e.length)),r},t.changeExtname=function(t,e){var e=e||"",r=t.indexOf("?"),n="";return r>0&&(n=t.substring(r),t=t.substring(0,r)),r=t.lastIndexOf("."),0>r?t+e+n:t.substring(0,r)+e+n;
},t.changeBasename=function(t,e,r){void 0===r&&(r=!1);var n=null,o=null,i=null;return 0==e.indexOf(".")?this.changeExtname(t,e):(n=t.indexOf("?"),o="",i=r?this.extname(t):"",n>0&&(o=t.substring(n),t=t.substring(0,n)),n=t.lastIndexOf("/"),n=0>=n?0:n+1,t.substring(0,n)+e+i+o)},t.extname=function(t){return this._splitPath(t)[3]},t.dirname=function(t){var e=this._splitPath(t),r=e[0],n=e[1];return r||n?(n&&(n=n.substr(0,n.length-1)),r+n):"."},t._splitPath=function(t){return e.exec(t).slice(1)},t}();t.PathUtils=r}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function t(){}return t.bind=function(t,e){return function(){return e.apply(t,arguments)}},t}();t.FunctionUtils=e}(wdCb||(wdCb={}));var wdCb;!function(t){var e=function(){function e(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];return this._doms=null,t.JudgeUtils.isDom(e[0])?this._doms=[e[0]]:this._isDomEleStr(e[0])?this._doms=[this._buildDom(e[0])]:this._doms=document.querySelectorAll(e[0]),this}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=new this(t[0]);return r},e.prototype.get=function(t){return this._doms[t]},e.prototype.prepend=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=null;r=this._buildDom(t[0]);for(var n=0,o=this._doms;n<o.length;n++){var i=o[n];1===i.nodeType&&i.insertBefore(r,i.firstChild)}return this},e.prototype.prependTo=function(t){var r=null;r=e.create(t);for(var n=0,o=this._doms;n<o.length;n++){var i=o[n];1===i.nodeType&&r.prepend(i)}return this},e.prototype.remove=function(){for(var t=0,e=this._doms;t<e.length;t++){var r=e[t];r&&r.parentNode&&"BODY"!=r.tagName&&r.parentNode.removeChild(r)}return this},e.prototype.css=function(t,e){for(var r=0,n=this._doms;r<n.length;r++){var o=n[r];o.style[t]=e}},e.prototype.attr=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(1===t.length){var r=t[0];return this.get(0).getAttribute(r)}for(var n=t[0],o=t[1],i=0,a=this._doms;i<a.length;i++){var s=a[i];s.setAttribute(n,o)}},e.prototype._isDomEleStr=function(t){return null!==t.match(/<(\w+)[^>]*><\/\1>/)},e.prototype._buildDom=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(t.JudgeUtils.isString(e[0])){var n=this._createElement("div"),o=e[0];return n.innerHTML=o,n.firstChild}return e[0]},e.prototype._createElement=function(t){return document.createElement(t)},e}();t.DomQuery=e}(wdCb||(wdCb={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.isPromise=function(e){return!!e&&!t.isFunction.call(this,e.subscribe)&&t.isFunction.call(this,e.then)},e.isEqual=function(t,e){return t.uid===e.uid},e.isIObserver=function(t){return t.next&&t.error&&t.completed},e}(wdCb.JudgeUtils);t.JudgeUtils=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.fromNodeCallback=function(e,r){return function(){for(var n=[],o=0;o<arguments.length;o++)n[o-0]=arguments[o];return t.createStream(function(t){var o=function(e){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];return e?void t.error(e):(r.length<=1?t.next.apply(t,r):t.next(r),void t.completed())};n.push(o),e.apply(r,n)})}},t.fromStream=function(e,r){return void 0===r&&(r="end"),e.pause(),t.createStream(function(t){var n=function(e){t.next(e)},o=function(e){t.error(e)},i=function(){t.completed()};return e.addListener("data",n),e.addListener("error",o),e.addListener(r,i),e.resume(),function(){e.removeListener("data",n),e.removeListener("error",o),e.removeListener(r,i)}})},t.fromReadableStream=function(e){return t.fromStream(e,"end")},t.fromWritableStream=function(e){return t.fromStream(e,"finish")},t.fromTransformStream=function(e){return t.fromStream(e,"finish")}}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(e){this._uid=null,this._uid=e+String(t.UID++)}return Object.defineProperty(t.prototype,"uid",{get:function(){return this._uid},set:function(t){this._uid=t},enumerable:!0,configurable:!0}),t.UID=1,t}();t.Entity=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(){}return t.isTest=!1,t}();t.Main=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){function e(t,e){void 0===e&&(e="contract error"),u.error(!t,e)}function r(e){return function(r,n,o){var i=o.value;return o.value=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];return t.Main.isTest&&e.apply(this,r),i.apply(this,r)},o}}function n(e){return function(r,n,o){var i=o.value;return o.value=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];var o=i.apply(this,r),a=[o].concat(r);return t.Main.isTest&&e.apply(this,a),o},o}}function o(e){return function(r,n,o){var i=o.get;return o.get=function(){return t.Main.isTest&&e.call(this),i.call(this)},o}}function i(e){return function(r,n,o){var i=o.set;return o.set=function(r){t.Main.isTest&&e.call(this,r),i.call(this,r)},o}}function a(e){return function(r,n,o){var i=o.get;return o.get=function(){var r=i.call(this);return t.Main.isTest&&e.call(this,r),r},o}}function s(e){return function(r,n,o){var i=o.set;return o.set=function(r){var n=i.call(this,r),o=[n,r];t.Main.isTest&&e.apply(this,o)},o}}function c(e){return function(r){t.Main.isTest&&e(r)}}var u=wdCb.Log;t.assert=e,t.require=r,t.ensure=n,t.requireGetter=o,t.requireSetter=i,t.ensureGetter=a,t.ensureSetter=s,t.invariant=c}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(t){this._disposeHandler=null,this._disposeHandler=t}return t.create=function(t){void 0===t&&(t=function(){});var e=new this(t);return e},t.prototype.setDisposeHandler=function(t){this._disposeHandler=t},t.prototype.dispose=function(){this._disposeHandler()},t}();t.SingleDisposable=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(t){this._group=wdCb.Collection.create(),t&&this._group.addChild(t)}return t.create=function(t){var e=new this(t);return e},t.prototype.add=function(t){return this._group.addChild(t),this},t.prototype.dispose=function(){this._group.forEach(function(t){t.dispose()})},t}();t.GroupDisposable=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(t,e){this._subject=null,this._observer=null,this._subject=t,this._observer=e}return t.create=function(t,e){var r=new this(t,e);return r},t.prototype.dispose=function(){this._subject.remove(this._observer),this._observer.dispose()},t}();t.InnerSubscription=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(){this._container=wdCb.Collection.create()}return t.create=function(){var t=new this;return t},t.prototype.addChild=function(t){this._container.addChild(t)},t.prototype.dispose=function(){this._container.forEach(function(t){t.dispose()})},t}();t.InnerSubscriptionGroup=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){Object.defineProperty(t,"root",{get:function(){return t.JudgeUtils.isNodeJs()?global:window}})}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.ABSTRACT_ATTRIBUTE=null}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.root.RSVP&&(t.root.RSVP.onerror=function(t){throw t},t.root.RSVP.on("error",t.root.RSVP.onerror))}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wdFrp;!function(t){var e=wdCb.Log,r=function(r){function n(e){r.call(this,"Stream"),this.scheduler=t.ABSTRACT_ATTRIBUTE,this.subscribeFunc=null,this.subscribeFunc=e||function(){}}return __extends(n,r),n.prototype.buildStream=function(e){return t.SingleDisposable.create(this.subscribeFunc(e)||function(){})},n.prototype["do"]=function(e,r,n){return t.DoStream.create(this,e,r,n)},n.prototype.map=function(e){return t.MapStream.create(this,e)},n.prototype.flatMap=function(t){return this.map(t).mergeAll()},n.prototype.mergeAll=function(){return t.MergeAllStream.create(this)},n.prototype.takeUntil=function(e){return t.TakeUntilStream.create(this,e)},n.prototype.take=function(e){void 0===e&&(e=1);var r=this;return 0===e?t.empty():t.createStream(function(t){r.subscribe(function(r){e>0&&t.next(r),e--,0>=e&&t.completed()},function(e){t.error(e)},function(){t.completed()})})},n.prototype.takeLast=function(e){void 0===e&&(e=1);var r=this;return 0===e?t.empty():t.createStream(function(t){var n=[];r.subscribe(function(t){n.push(t),n.length>e&&n.shift()},function(e){t.error(e)},function(){for(;n.length>0;)t.next(n.shift());t.completed()})})},n.prototype.takeWhile=function(e,r){void 0===r&&(r=this);var n=this,o=null;return o=wdCb.FunctionUtils.bind(r,e),t.createStream(function(t){var e=0,r=!1;n.subscribe(function(i){if(o(i,e++,n))try{t.next(i),r=!0}catch(a){return void t.error(a)}else r&&t.completed()},function(e){t.error(e)},function(){t.completed()})})},n.prototype.filter=function(e,r){if(void 0===r&&(r=this),this instanceof t.FilterStream){var n=this;return n.internalFilter(e,r)}return t.FilterStream.create(this,e,r)},n.prototype.filterWithState=function(e,r){if(void 0===r&&(r=this),this instanceof t.FilterStream){var n=this;return n.internalFilter(e,r)}return t.FilterWithStateStream.create(this,e,r)},n.prototype.concat=function(){var e=null;return e=t.JudgeUtils.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments,0),e.unshift(this),t.ConcatStream.create(e)},n.prototype.merge=function(){var e=null,r=null;return e=t.JudgeUtils.isArray(arguments[0])?arguments[0]:Array.prototype.slice.call(arguments,0),e.unshift(this),r=t.fromArray(e).mergeAll()},n.prototype.repeat=function(e){return void 0===e&&(e=-1),t.RepeatStream.create(this,e)},n.prototype.ignoreElements=function(){return t.IgnoreElementsStream.create(this)},n.prototype.handleSubject=function(t){return this._isSubject(t)?(this._setSubject(t),!0):!1},n.prototype._isSubject=function(e){return e instanceof t.Subject},n.prototype._setSubject=function(t){t.source=this},__decorate([t.require(function(r){void 0===r&&(r=1),t.assert(r>=0,e.info.FUNC_SHOULD("count",">= 0"))})],n.prototype,"take",null),__decorate([t.require(function(r){void 0===r&&(r=1),t.assert(r>=0,e.info.FUNC_SHOULD("count",">= 0"))})],n.prototype,"takeLast",null),n}(t.Entity);t.Stream=r}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.root.requestNextAnimationFrame=function(){var e=void 0,r=void 0,n=null,o=t.root.navigator&&t.root.navigator.userAgent,i=0,a=this;return r=function(e){e=t.root.performance.now(),a.callback(e)},t.root.requestAnimationFrame?requestAnimationFrame:(t.root.webkitRequestAnimationFrame&&(e=t.root.webkitRequestAnimationFrame,t.root.webkitRequestAnimationFrame=function(t,n){return a.callback=t,e(r,n)}),t.root.msRequestAnimationFrame&&(e=t.root.msRequestAnimationFrame,t.root.msRequestAnimationFrame=function(t){return a.callback=t,e(r)}),t.root.mozRequestAnimationFrame&&(i=o.indexOf("rv:"),-1!=o.indexOf("Gecko")&&(n=o.substr(i+3,3),"2.0"===n&&(t.root.mozRequestAnimationFrame=void 0))),t.root.webkitRequestAnimationFrame||t.root.mozRequestAnimationFrame||t.root.oRequestAnimationFrame||t.root.msRequestAnimationFrame||function(e,r){var n,o;t.root.setTimeout(function(){n=t.root.performance.now(),e(n),o=t.root.performance.now(),a.timeout=1e3/60-(o-n)},a.timeout)})}(),t.root.cancelNextRequestAnimationFrame=t.root.cancelRequestAnimationFrame||t.root.webkitCancelAnimationFrame||t.root.webkitCancelRequestAnimationFrame||t.root.mozCancelRequestAnimationFrame||t.root.oCancelRequestAnimationFrame||t.root.msCancelRequestAnimationFrame||clearTimeout;var e=function(){function e(){this._requestLoopId=null}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=new this;return r},Object.defineProperty(e.prototype,"requestLoopId",{get:function(){return this._requestLoopId},set:function(t){this._requestLoopId=t},enumerable:!0,configurable:!0}),e.prototype.publishRecursive=function(t,e,r){r(e)},e.prototype.publishInterval=function(e,r,n,o){return t.root.setInterval(function(){r=o(r)},n)},e.prototype.publishIntervalRequest=function(e,r){var n=this,o=function(e){var i=r(e);i||(n._requestLoopId=t.root.requestNextAnimationFrame(o))};this._requestLoopId=t.root.requestNextAnimationFrame(o)},e}();t.Scheduler=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(t){function e(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(t.call(this,"Observer"),this._isDisposed=null,this.onUserNext=null,this.onUserError=null,this.onUserCompleted=null,this._isStop=!1,this._disposable=null,1===e.length){var n=e[0];this.onUserNext=function(t){n.next(t)},this.onUserError=function(t){n.error(t)},this.onUserCompleted=function(){n.completed()}}else{var o=e[0],i=e[1],a=e[2];this.onUserNext=o||function(t){},this.onUserError=i||function(t){throw t},this.onUserCompleted=a||function(){}}}return __extends(e,t),Object.defineProperty(e.prototype,"isDisposed",{get:function(){return this._isDisposed},set:function(t){this._isDisposed=t},enumerable:!0,configurable:!0}),e.prototype.next=function(t){return this._isStop?void 0:this.onNext(t)},e.prototype.error=function(t){this._isStop||(this._isStop=!0,this.onError(t))},e.prototype.completed=function(){this._isStop||(this._isStop=!0,this.onCompleted())},e.prototype.dispose=function(){this._isStop=!0,this._isDisposed=!0,this._disposable&&this._disposable.dispose()},e.prototype.setDisposable=function(t){this._disposable=t},e}(t.Entity);t.Observer=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function e(){this._source=null,this._observer=new t.SubjectObserver}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"source",{get:function(){return this._source},set:function(t){this._source=t},enumerable:!0,configurable:!0}),e.prototype.subscribe=function(e,r,n){var o=e instanceof t.Observer?e:t.AutoDetachObserver.create(e,r,n);return this._observer.addChild(o),t.InnerSubscription.create(this,o)},e.prototype.next=function(t){this._observer.next(t)},e.prototype.error=function(t){this._observer.error(t)},e.prototype.completed=function(){this._observer.completed()},e.prototype.start=function(){this._source&&this._observer.setDisposable(this._source.buildStream(this))},e.prototype.remove=function(t){this._observer.removeChild(t)},e.prototype.dispose=function(){this._observer.dispose()},e}();t.Subject=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(){e.call(this,"GeneratorSubject"),this._isStart=!1,this.observer=new t.SubjectObserver}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"isStart",{get:function(){return this._isStart},set:function(t){this._isStart=t},enumerable:!0,configurable:!0}),r.prototype.onBeforeNext=function(t){},r.prototype.onAfterNext=function(t){},r.prototype.onIsCompleted=function(t){return!1},r.prototype.onBeforeError=function(t){},r.prototype.onAfterError=function(t){},r.prototype.onBeforeCompleted=function(){},r.prototype.onAfterCompleted=function(){},r.prototype.subscribe=function(e,r,n){var o=e instanceof t.Observer?e:t.AutoDetachObserver.create(e,r,n);return this.observer.addChild(o),t.InnerSubscription.create(this,o)},r.prototype.next=function(t){if(this._isStart&&!this.observer.isEmpty())try{this.onBeforeNext(t),this.observer.next(t),this.onAfterNext(t),this.onIsCompleted(t)&&this.completed()}catch(e){this.error(e)}},r.prototype.error=function(t){this._isStart&&!this.observer.isEmpty()&&(this.onBeforeError(t),this.observer.error(t),this.onAfterError(t))},r.prototype.completed=function(){this._isStart&&!this.observer.isEmpty()&&(this.onBeforeCompleted(),this.observer.completed(),this.onAfterCompleted())},r.prototype.toStream=function(){var e=this,r=null;return r=t.AnonymousStream.create(function(t){e.subscribe(t)})},r.prototype.start=function(){var e=this;this._isStart=!0,this.observer.setDisposable(t.SingleDisposable.create(function(){e.dispose()}))},r.prototype.stop=function(){this._isStart=!1},r.prototype.remove=function(t){this.observer.removeChild(t)},r.prototype.dispose=function(){this.observer.dispose()},r}(t.Entity);t.GeneratorSubject=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e,r){return new this(t,e,r)},e.prototype.onNext=function(t){this.onUserNext(t)},e.prototype.onError=function(t){this.onUserError(t)},e.prototype.onCompleted=function(){this.onUserCompleted()},e}(t.Observer);t.AnonymousObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return 1===t.length?new this(t[0]):new this(t[0],t[1],t[2])},e.prototype.dispose=function(){return this.isDisposed?void wdCb.Log.log("only can dispose once"):void t.prototype.dispose.call(this)},e.prototype.onNext=function(t){try{this.onUserNext(t)}catch(e){this.onError(e)}},e.prototype.onError=function(t){try{this.onUserError(t)}catch(e){throw e}finally{this.dispose()}},e.prototype.onCompleted=function(){try{this.onUserCompleted(),this.dispose()}catch(t){throw t}},e}(t.Observer);t.AutoDetachObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(t){function e(e,r){t.call(this,null,null,null),this._currentObserver=null,this._selector=null,this._currentObserver=e,this._selector=r}return __extends(e,t),e.create=function(t,e){return new this(t,e)},e.prototype.onNext=function(t){var e=null;try{e=this._selector(t)}catch(r){this._currentObserver.error(r)}finally{this._currentObserver.next(e)}},e.prototype.onError=function(t){this._currentObserver.error(t)},e.prototype.onCompleted=function(){this._currentObserver.completed()},e}(t.Observer);t.MapObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(t){function e(e,r){t.call(this,null,null,null),this._currentObserver=null,this._prevObserver=null,this._currentObserver=e,this._prevObserver=r}return __extends(e,t),e.create=function(t,e){return new this(t,e)},e.prototype.onNext=function(t){try{this._prevObserver.next(t)}catch(e){this._prevObserver.error(e),this._currentObserver.error(e)}finally{this._currentObserver.next(t)}},e.prototype.onError=function(t){try{this._prevObserver.error(t)}catch(e){}finally{this._currentObserver.error(t)}},e.prototype.onCompleted=function(){try{this._prevObserver.completed()}catch(t){this._prevObserver.error(t),this._currentObserver.error(t)}finally{this._currentObserver.completed()}},e}(t.Observer);t.DoObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function n(t,r,n){e.call(this,null,null,null),this._currentObserver=null,this._done=!1,this._streamGroup=null,this._groupDisposable=null,this._currentObserver=t,this._streamGroup=r,this._groupDisposable=n}return __extends(n,e),n.create=function(t,e,r){return new this(t,e,r)},Object.defineProperty(n.prototype,"currentObserver",{get:function(){return this._currentObserver},set:function(t){this._currentObserver=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"done",{get:function(){return this._done},set:function(t){this._done=t},enumerable:!0,configurable:!0}),n.prototype.onNext=function(e){wdCb.Log.error(!(e instanceof t.Stream||t.JudgeUtils.isPromise(e)),wdCb.Log.info.FUNC_MUST_BE("innerSource","Stream or Promise")),t.JudgeUtils.isPromise(e)&&(e=t.fromPromise(e)),this._streamGroup.addChild(e),this._groupDisposable.add(e.buildStream(r.create(this,this._streamGroup,e)))},n.prototype.onError=function(t){this._currentObserver.error(t)},n.prototype.onCompleted=function(){this.done=!0,0===this._streamGroup.getCount()&&this._currentObserver.completed()},n}(t.Observer);t.MergeAllObserver=e;var r=function(e){function r(t,r,n){e.call(this,null,null,null),this._parent=null,this._streamGroup=null,this._currentStream=null,this._parent=t,this._streamGroup=r,this._currentStream=n}return __extends(r,e),r.create=function(t,e,r){var n=new this(t,e,r);return n},r.prototype.onNext=function(t){this._parent.currentObserver.next(t)},r.prototype.onError=function(t){this._parent.currentObserver.error(t)},r.prototype.onCompleted=function(){var e=this._currentStream,r=this._parent;this._streamGroup.removeChild(function(r){return t.JudgeUtils.isEqual(r,e)}),this._isAsync()&&0===this._streamGroup.getCount()&&r.currentObserver.completed()},r.prototype._isAsync=function(){return this._parent.done},r}(t.Observer)}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(t){function e(e){t.call(this,null,null,null),this._prevObserver=null,this._prevObserver=e}return __extends(e,t),e.create=function(t){return new this(t)},e.prototype.onNext=function(t){this._prevObserver.completed()},e.prototype.onError=function(t){this._prevObserver.error(t)},e.prototype.onCompleted=function(){},e}(t.Observer);t.TakeUntilObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(t){function e(e,r){t.call(this,null,null,null),this.currentObserver=null,this._startNextStream=null,this.currentObserver=e,this._startNextStream=r}return __extends(e,t),e.create=function(t,e){return new this(t,e)},e.prototype.onNext=function(t){this.currentObserver.next(t)},e.prototype.onError=function(t){this.currentObserver.error(t)},e.prototype.onCompleted=function(){this._startNextStream()},e}(t.Observer);t.ConcatObserver=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function e(){this.observers=wdCb.Collection.create(),this._disposable=null}return e.prototype.isEmpty=function(){return 0===this.observers.getCount()},e.prototype.next=function(t){this.observers.forEach(function(e){e.next(t)})},e.prototype.error=function(t){this.observers.forEach(function(e){e.error(t)})},e.prototype.completed=function(){this.observers.forEach(function(t){t.completed()})},e.prototype.addChild=function(t){this.observers.addChild(t),t.setDisposable(this._disposable)},e.prototype.removeChild=function(e){this.observers.removeChild(function(r){return t.JudgeUtils.isEqual(r,e)})},e.prototype.dispose=function(){this.observers.forEach(function(t){t.dispose()}),this.observers.removeAllChildren()},e.prototype.setDisposable=function(t){this.observers.forEach(function(e){e.setDisposable(t)}),this._disposable=t},e}();t.SubjectObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(t){function e(e){t.call(this,null,null,null),this._currentObserver=null,this._currentObserver=e}return __extends(e,t),e.create=function(t){return new this(t)},e.prototype.onNext=function(t){},e.prototype.onError=function(t){this._currentObserver.error(t)},e.prototype.onCompleted=function(){this._currentObserver.completed()},e}(t.Observer);t.IgnoreElementsObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(t){function e(e,r,n){t.call(this,null,null,null),this.prevObserver=null,this.source=null,this.i=0,this.predicate=null,this.prevObserver=e,this.predicate=r,this.source=n}return __extends(e,t),e.create=function(t,e,r){return new this(t,e,r)},e.prototype.onNext=function(t){try{this.predicate(t,this.i++,this.source)&&this.prevObserver.next(t)}catch(e){this.prevObserver.error(e)}},e.prototype.onError=function(t){this.prevObserver.error(t)},e.prototype.onCompleted=function(){this.prevObserver.completed()},e}(t.Observer);t.FilterObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._isTrigger=!1}return __extends(r,e),r.create=function(t,e,r){return new this(t,e,r)},r.prototype.onNext=function(e){var r=null;try{this.predicate(e,this.i++,this.source)?(r=this._isTrigger?{value:e,state:t.FilterState.TRIGGER}:{value:e,state:t.FilterState.ENTER},this.prevObserver.next(r),this._isTrigger=!0):(this._isTrigger&&(r={value:e,state:t.FilterState.LEAVE},this.prevObserver.next(r)),this._isTrigger=!1)}catch(n){this.prevObserver.error(n)}},r}(t.FilterObserver);t.FilterWithStateObserver=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.prototype.subscribe=function(e,r,n){var o=null;if(!this.handleSubject(e))return o=e instanceof t.Observer?t.AutoDetachObserver.create(e):t.AutoDetachObserver.create(e,r,n),o.setDisposable(this.buildStream(o)),o},r.prototype.buildStream=function(t){return e.prototype.buildStream.call(this,t),this.subscribeCore(t)},r}(t.Stream);t.BaseStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(r,n,o,i){e.call(this,null),this._source=null,this._observer=null,this._source=r,this._observer=t.AnonymousObserver.create(n,o,i),this.scheduler=this._source.scheduler}return __extends(r,e),r.create=function(t,e,r,n){var o=new this(t,e,r,n);return o},r.prototype.subscribeCore=function(e){return this._source.buildStream(t.DoObserver.create(e,this._observer))},r}(t.BaseStream);t.DoStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t,r){e.call(this,null),this._source=null,this._selector=null,this._source=t,this.scheduler=this._source.scheduler,this._selector=r}return __extends(r,e),r.create=function(t,e){var r=new this(t,e);return r},r.prototype.subscribeCore=function(e){return this._source.buildStream(t.MapObserver.create(e,this._selector))},r}(t.BaseStream);t.MapStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t,r){e.call(this,null),this._array=null,this._array=t,this.scheduler=r}return __extends(r,e),r.create=function(t,e){var r=new this(t,e);return r},r.prototype.subscribeCore=function(e){function r(t){o>t?(e.next(n[t]),arguments.callee(t+1)):e.completed()}var n=this._array,o=n.length;return this.scheduler.publishRecursive(e,0,r),t.SingleDisposable.create()},r}(t.BaseStream);t.FromArrayStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t,r){e.call(this,null),this._promise=null,this._promise=t,this.scheduler=r}return __extends(r,e),r.create=function(t,e){var r=new this(t,e);return r},r.prototype.subscribeCore=function(e){return this._promise.then(function(t){e.next(t),e.completed()},function(t){e.error(t)},e),t.SingleDisposable.create()},r}(t.BaseStream);t.FromPromiseStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t,r){e.call(this,null),this._addHandler=null,this._removeHandler=null,this._addHandler=t,this._removeHandler=r}return __extends(r,e),r.create=function(t,e){var r=new this(t,e);return r},r.prototype.subscribeCore=function(e){function r(t){e.next(t)}var n=this;return this._addHandler(r),t.SingleDisposable.create(function(){n._removeHandler(r)})},r}(t.BaseStream);t.FromEventPatternStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(r){e.call(this,r),this.scheduler=t.Scheduler.create()}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.subscribe=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null;if(e[0]instanceof t.Subject){var o=e[0];return void this.handleSubject(o)}if(t.JudgeUtils.isIObserver(e[0]))n=t.AutoDetachObserver.create(e[0]);else{var i=e[0],a=e[1]||null,s=e[2]||null;n=t.AutoDetachObserver.create(i,a,s)}return n.setDisposable(this.buildStream(n)),n},r}(t.Stream);t.AnonymousStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t,r){e.call(this,null),this._interval=null,this._interval=t,this.scheduler=r}return __extends(r,e),r.create=function(t,e){var r=new this(t,e);return r.initWhenCreate(),r},r.prototype.initWhenCreate=function(){this._interval=this._interval<=0?1:this._interval},r.prototype.subscribeCore=function(e){var r=null;return r=this.scheduler.publishInterval(e,0,this._interval,function(t){
return e.next(t),t+1}),t.SingleDisposable.create(function(){t.root.clearInterval(r)})},r}(t.BaseStream);t.IntervalStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t){e.call(this,null),this._isEnd=!1,this.scheduler=t}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.subscribeCore=function(e){var r=this;return this.scheduler.publishIntervalRequest(e,function(t){return e.next(t),r._isEnd}),t.SingleDisposable.create(function(){t.root.cancelNextRequestAnimationFrame(r.scheduler.requestLoopId),r._isEnd=!0})},r}(t.BaseStream);t.IntervalRequestStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t){e.call(this,null),this._source=null,this._observer=null,this._source=t,this.scheduler=this._source.scheduler}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.subscribeCore=function(e){var r=wdCb.Collection.create(),n=t.GroupDisposable.create();return this._source.buildStream(t.MergeAllObserver.create(e,r,n)),n},r}(t.BaseStream);t.MergeAllStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(r,n){e.call(this,null),this._source=null,this._otherStream=null,this._source=r,this._otherStream=t.JudgeUtils.isPromise(n)?t.fromPromise(n):n,this.scheduler=this._source.scheduler}return __extends(r,e),r.create=function(t,e){var r=new this(t,e);return r},r.prototype.subscribeCore=function(e){var r=t.GroupDisposable.create(),n=t.AutoDetachObserver.create(e),o=null;return o=this._source.buildStream(e),r.add(o),n.setDisposable(o),r.add(this._otherStream.buildStream(t.TakeUntilObserver.create(n))),r},r}(t.BaseStream);t.TakeUntilStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(r){e.call(this,null),this._sources=wdCb.Collection.create();var n=this;this.scheduler=r[0].scheduler,r.forEach(function(e){t.JudgeUtils.isPromise(e)?n._sources.addChild(t.fromPromise(e)):n._sources.addChild(e)})}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.subscribeCore=function(e){function r(a){return a===o?void e.completed():void i.add(n._sources.getChild(a).buildStream(t.ConcatObserver.create(e,function(){r(a+1)})))}var n=this,o=this._sources.getCount(),i=t.GroupDisposable.create();return this.scheduler.publishRecursive(e,0,r),t.GroupDisposable.create(i)},r}(t.BaseStream);t.ConcatStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t,r){e.call(this,null),this._source=null,this._count=null,this._source=t,this._count=r,this.scheduler=this._source.scheduler}return __extends(r,e),r.create=function(t,e){var r=new this(t,e);return r},r.prototype.subscribeCore=function(e){function r(i){return 0===i?void e.completed():void o.add(n._source.buildStream(t.ConcatObserver.create(e,function(){r(i-1)})))}var n=this,o=t.GroupDisposable.create();return this.scheduler.publishRecursive(e,this._count,r),t.GroupDisposable.create(o)},r}(t.BaseStream);t.RepeatStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t){e.call(this,null),this._source=null,this._source=t,this.scheduler=this._source.scheduler}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.subscribeCore=function(e){return this._source.buildStream(t.IgnoreElementsObserver.create(e))},r}(t.BaseStream);t.IgnoreElementsStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t){e.call(this,null),this._buildStreamFunc=null,this._buildStreamFunc=t}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.subscribeCore=function(e){var r=t.GroupDisposable.create();return r.add(this._buildStreamFunc().buildStream(e)),r},r}(t.BaseStream);t.DeferStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t,r,n){e.call(this,null),this.predicate=null,this._source=null,this._source=t,this.predicate=wdCb.FunctionUtils.bind(n,r)}return __extends(r,e),r.create=function(t,e,r){var n=new this(t,e,r);return n},r.prototype.subscribeCore=function(t){return this._source.subscribe(this.createObserver(t))},r.prototype.internalFilter=function(t,e){return this.createStreamForInternalFilter(this._source,this._innerPredicate(t,this),e)},r.prototype.createObserver=function(e){return t.FilterObserver.create(e,this.predicate,this)},r.prototype.createStreamForInternalFilter=function(t,e,n){return r.create(t,e,n)},r.prototype._innerPredicate=function(t,e){var r=this;return function(n,o,i){return e.predicate(n,o,i)&&t.call(r,n,o,i)}},r}(t.BaseStream);t.FilterStream=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t,e,r){var n=new this(t,e,r);return n},r.prototype.createObserver=function(e){return t.FilterWithStateObserver.create(e,this.predicate,this)},r.prototype.createStreamForInternalFilter=function(t,e,n){return r.create(t,e,n)},r}(t.FilterStream);t.FilterWithStateStream=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){t.createStream=function(e){return t.AnonymousStream.create(e)},t.fromArray=function(e,r){return void 0===r&&(r=t.Scheduler.create()),t.FromArrayStream.create(e,r)},t.fromPromise=function(e,r){return void 0===r&&(r=t.Scheduler.create()),t.FromPromiseStream.create(e,r)},t.fromEventPattern=function(e,r){return t.FromEventPatternStream.create(e,r)},t.interval=function(e,r){return void 0===r&&(r=t.Scheduler.create()),t.IntervalStream.create(e,r)},t.intervalRequest=function(e){return void 0===e&&(e=t.Scheduler.create()),t.IntervalRequestStream.create(e)},t.empty=function(){return t.createStream(function(t){t.completed()})},t.callFunc=function(e,r){return void 0===r&&(r=t.root),t.createStream(function(t){try{t.next(e.call(r,null))}catch(n){t.error(n)}t.completed()})},t.judge=function(t,e,r){return t()?e():r()},t.defer=function(e){return t.DeferStream.create(e)},t.just=function(e){return t.createStream(function(t){t.next(e),t.completed()})}}(wdFrp||(wdFrp={}));var wdFrp;!function(t){!function(t){t[t.TRIGGER=0]="TRIGGER",t[t.ENTER=1]="ENTER",t[t.LEAVE=2]="LEAVE"}(t.FilterState||(t.FilterState={}));t.FilterState}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(t,e){return t===e},r=function(){function t(t,r,n,o){this._time=null,this._value=null,this._actionType=null,this._comparer=null,this._time=t,this._value=r,this._actionType=n,this._comparer=o||e}return t.create=function(t,e,r,n){var o=new this(t,e,r,n);return o},Object.defineProperty(t.prototype,"time",{get:function(){return this._time},set:function(t){this._time=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"value",{get:function(){return this._value},set:function(t){this._value=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"actionType",{get:function(){return this._actionType},set:function(t){this._actionType=t},enumerable:!0,configurable:!0}),t.prototype.equals=function(t){return this._time===t.time&&this._comparer(this._value,t.value)},t}();t.Record=r}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t){e.call(this,null,null,null),this._messages=[],this._scheduler=null,this._scheduler=t}return __extends(r,e),r.create=function(t){var e=new this(t);return e},Object.defineProperty(r.prototype,"messages",{get:function(){return this._messages},set:function(t){this._messages=t},enumerable:!0,configurable:!0}),r.prototype.onNext=function(e){var r=null;r=t.JudgeUtils.isDirectObject(e)?t.Record.create(this._scheduler.clock,e,t.ActionType.NEXT,function(t,e){var r=!0;for(var n in t)if(t.hasOwnProperty(n)&&t[n]!==e[n]){r=!1;break}return r}):t.Record.create(this._scheduler.clock,e,t.ActionType.NEXT),this._messages.push(r)},r.prototype.onError=function(e){this._messages.push(t.Record.create(this._scheduler.clock,e,t.ActionType.ERROR))},r.prototype.onCompleted=function(){this._messages.push(t.Record.create(this._scheduler.clock,null,t.ActionType.COMPLETED))},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._scheduler.remove(this)},r.prototype.copy=function(){var t=r.create(this._scheduler);return t.messages=this._messages,t},r}(t.Observer);t.MockObserver=e}(wdFrp||(wdFrp={}));var wdFrp;!function(t){var e=function(){function t(t,e){this._messages=[],this._scheduler=null,this._scheduler=t,this._messages=e}return t.create=function(t,e){var r=new this(t,e);return r},t.prototype.then=function(t,e,r){this._scheduler.setStreamMap(r,this._messages)},t}();t.MockPromise=e}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=200,r=1e3,n=function(n){function o(t){n.call(this),this._clock=null,this._isReset=!1,this._isDisposed=!1,this._timerMap=wdCb.Hash.create(),this._streamMap=wdCb.Hash.create(),this._subscribedTime=null,this._disposedTime=null,this._observer=null,this._isReset=t}return __extends(o,n),o.next=function(e,r){return t.JudgeUtils.isDirectObject(r)?t.Record.create(e,r,t.ActionType.NEXT,function(t,e){var r=!0;for(var n in t)if(t.hasOwnProperty(n)&&t[n]!==e[n]){r=!1;break}return r}):t.Record.create(e,r,t.ActionType.NEXT)},o.error=function(e,r){return t.Record.create(e,r,t.ActionType.ERROR)},o.completed=function(e){return t.Record.create(e,null,t.ActionType.COMPLETED)},o.create=function(t){void 0===t&&(t=!1);var e=new this(t);return e},Object.defineProperty(o.prototype,"clock",{get:function(){return this._clock},set:function(t){this._clock=t},enumerable:!0,configurable:!0}),o.prototype.setStreamMap=function(e,r){var n=this;r.forEach(function(r){var o=null;switch(r.actionType){case t.ActionType.NEXT:o=function(){e.next(r.value)};break;case t.ActionType.ERROR:o=function(){e.error(r.value)};break;case t.ActionType.COMPLETED:o=function(){e.completed()};break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("actionType"))}n._streamMap.addChild(String(r.time),o)})},o.prototype.remove=function(t){this._isDisposed=!0},o.prototype.publishRecursive=function(t,e,r){var n=this,o=null,i=null;this._setClock(),o=t.next,i=t.completed,t.next=function(e){o.call(t,e),n._tick(1)},t.completed=function(){i.call(t),n._tick(1)},r(e)},o.prototype.publishInterval=function(t,e,r,n){var i=10,a=[];for(this._setClock();i>0&&!this._isDisposed;)this._tick(r),a.push(o.next(this._clock,e)),e++,i--;return this.setStreamMap(t,a),NaN},o.prototype.publishIntervalRequest=function(t,e){var r=10,n=[],i=100,a=0;for(this._setClock();r>0&&!this._isDisposed;)this._tick(i),n.push(o.next(this._clock,a)),a++,r--;return this.setStreamMap(t,n),NaN},o.prototype._setClock=function(){this._isReset&&(this._clock=this._subscribedTime)},o.prototype.startWithTime=function(t,e,r){var n,o,i=this.createObserver(),a=this;return this._subscribedTime=e,this._disposedTime=r,this._clock=e,this._runAt(e,function(){n=t(),o=n.subscribe(i)}),this._runAt(r,function(){o.dispose(),a._isDisposed=!0}),this._observer=i,this.start(),i},o.prototype.startWithSubscribe=function(t,n){return void 0===n&&(n=e),this.startWithTime(t,n,r)},o.prototype.startWithDispose=function(t,n){return void 0===n&&(n=r),this.startWithTime(t,e,n)},o.prototype.publicAbsolute=function(t,e){this._runAt(t,function(){e()})},o.prototype.start=function(){for(var t=this._getMinAndMaxTime(),e=t[0],r=t[1],n=e;r>=n;)this._clock=n,this._exec(n,this._timerMap),this._clock=n,this._runStream(n),n++,r=this._getMinAndMaxTime()[1]},o.prototype.createStream=function(e){return t.TestStream.create(Array.prototype.slice.call(arguments,0),this)},o.prototype.createObserver=function(){return t.MockObserver.create(this)},o.prototype.createResolvedPromise=function(e,r){return t.MockPromise.create(this,[o.next(e,r),o.completed(e+1)])},o.prototype.createRejectPromise=function(e,r){return t.MockPromise.create(this,[o.error(e,r)])},o.prototype._getMinAndMaxTime=function(){var t=this._timerMap.getKeys().addChildren(this._streamMap.getKeys());return t=t.map(function(t){return Number(t)}).toArray(),[Math.min.apply(Math,t),Math.max.apply(Math,t)]},o.prototype._exec=function(t,e){var r=e.getChild(String(t));r&&r()},o.prototype._runStream=function(t){var e=this._streamMap.getChild(String(t));e&&e()},o.prototype._runAt=function(t,e){this._timerMap.addChild(String(t),e)},o.prototype._tick=function(t){this._clock+=t},o}(t.Scheduler);t.TestScheduler=n}(wdFrp||(wdFrp={}));var wdFrp;!function(t){!function(t){t[t.NEXT=0]="NEXT",t[t.ERROR=1]="ERROR",t[t.COMPLETED=2]="COMPLETED"}(t.ActionType||(t.ActionType={}));t.ActionType}(wdFrp||(wdFrp={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wdFrp;!function(t){var e=function(e){function r(t,r){e.call(this,null),this.scheduler=null,this._messages=null,this._messages=t,this.scheduler=r}return __extends(r,e),r.create=function(t,e){var r=new this(t,e);return r},r.prototype.subscribeCore=function(e){return this.scheduler.setStreamMap(e,this._messages),t.SingleDisposable.create()},r}(t.BaseStream);t.TestStream=e}(wdFrp||(wdFrp={}));var wd;!function(t){t.DebugConfig={isTest:!1,debugCollision:!1,showDebugPanel:!1}}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.clear=function(){this.count.renderGameObjects=0,this.count.drawCalls=0},e.init=function(){var e=this;this._startLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.STARTLOOP).subscribe(function(){t.DebugConfig.showDebugPanel&&(console.log("totalGameObjects:"+e.count.totalGameObjects+", renderGameObjects:"+e.count.renderGameObjects+", drawCalls:"+e.count.drawCalls),console.log("fps:"+e.during.fps),e.clear())})},e.dispose=function(){this._startLoopSubscription.dispose()},e.count={get totalGameObjects(){var e=0;return t.Director.getInstance().scene.getChildren().forEach(function(r){return r.hasComponent(t.SpacePartition)?void(e+=r.getComponent(t.SpacePartition).getChildren().getCount()):void e++}),e},renderGameObjects:0,drawCalls:0},e.during={get fps(){return t.Director.getInstance().fps}},e._startLoopSubscription=null,e}();t.DebugStatistics=e}(wd||(wd={}));var wdFrp;!function(t){t.fromCollection=function(e,r){void 0===r&&(r=t.Scheduler.create());var n=e.toArray();return 0===n.length?t.empty():t.fromArray(n,r)}}(wdFrp||(wdFrp={}));var wd;!function(t){function e(e,r){void 0===r&&(r="contract error"),t.Log.error(!e,r)}function r(e){return function(r,n,o){var i=o.value;return o.value=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];return t.Main.isTest&&e.apply(this,r),i.apply(this,r)},o}}function n(e){return function(r,n,o){var i=o.value;return o.value=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];var o=i.apply(this,r);if(t.Main.isTest){var a=[o].concat(r);e.apply(this,a)}return o},o}}function o(e){return function(r,n,o){var i=o.get;return o.get=function(){return t.Main.isTest&&e.call(this),i.call(this)},o}}function i(e){return function(r,n,o){var i=o.set;return o.set=function(r){t.Main.isTest&&e.call(this,r),i.call(this,r)},o}}function a(e){return function(r,n,o){var i=o.get;return o.get=function(){var r=i.call(this);return t.Main.isTest&&e.call(this,r),r},o}}function s(e){return function(r,n,o){var i=o.set;return o.set=function(r){var n=i.call(this,r);if(t.Main.isTest){var o=[n,r];e.apply(this,o)}},o}}function c(e){return function(r){t.Main.isTest&&e(r)}}t.assert=e,t.require=r,t.ensure=n,t.requireGetter=o,t.requireSetter=i,t.ensureGetter=a,t.ensureSetter=s,t.invariant=c}(wd||(wd={}));var wd;!function(t){function e(t,e,r){return function(n,o,i){var a=i.get;return i.get=function(){var n=null;return t.call(this)?e.call(this):(n=a.call(this),r.call(this,n),n)},i}}function r(t,e,r){return function(n,o,i){var a=i.value;return i.value=function(){for(var n=[],o=0;o<arguments.length;o++)n[o-0]=arguments[o];var i=null;return t.apply(this,n)?e.apply(this,n):(i=a.apply(this,n),r.apply(this,[i].concat(n)),i)},i}}t.cacheGetter=e,t.cache=r}(wd||(wd={}));var wd;!function(t){function e(t,e,r){return r}t.virtual=e}(wd||(wd={}));var wd;!function(t){function e(t){return function(e,r,n){var i=n.get,a=n.set;return n.get=function(){if(this.isPhysicsEngineAdapterExist()){var e=this.getPhysicsEngineAdapter()["get"+t](this.entityObject);return null!==e?e:this["_"+o(t)]}return i.call(this)},n.set=function(e){a.call(this,e),this.isPhysicsEngineAdapterExist()&&this.getPhysicsEngineAdapter()["set"+t](this.entityObject,e)},n}}function r(e){return function(r,i,a){var s=a.get,c=a.set;return a.get=function(){var r=t.Director.getInstance().scene;if(n(r)){var i=r.physicsEngineAdapter["get"+e]();return null!==i?i:this["_"+o(e)]}return s.call(this)},a.set=function(r){var o=t.Director.getInstance().scene;c.call(this,r),n(o)&&o.physicsEngineAdapter["set"+e](r)},a}}function n(t){return t.physicsEngineAdapter&&t.physicsEngineAdapter.world}function o(t){var e=t.slice(0,1);return""+e.toLowerCase()+t.slice(1)}t.operateBodyDataGetterAndSetter=e,t.operateWorldDataGetterAndSetter=r}(wd||(wd={}));var wd;!function(t){function e(e){return function(r){t.Script.addScript(e,r)}}t.script=e}(wd||(wd={}));var wd;!function(t){function e(t){return function(e,r,n){var o=n.value;return n.value=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];return this[t]?void 0:(this[t]=!0,o.apply(this,e))},n}}t.execOnlyOnce=e}(wd||(wd={}));var wd;!function(t){t.ABSTRACT_ATTRIBUTE=null}(wd||(wd={}));var wd;!function(t){t.DEG_TO_RAD=Math.PI/180,t.RAD_TO_DEG=180/Math.PI}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=new Float32Array(2),t.length>0&&(this.values[0]=t[0],this.values[1]=t[1])}return t.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=null;return r=0===t.length?new this:new this(t[0],t[1])},Object.defineProperty(t.prototype,"x",{get:function(){return this.values[0]},set:function(t){this.values[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.values[1]},set:function(t){this.values[1]=t},enumerable:!0,configurable:!0}),t.prototype.set=function(t,e){this.x=t,this.y=e},t.prototype.add=function(t){return this.values[0]=this.values[0]+t.values[0],this.values[1]=this.values[1]+t.values[1],this},t.prototype.mul=function(t){return this.values[0]=this.values[0]*t.values[0],this.values[1]=this.values[1]*t.values[1],this},t.prototype.copy=function(){return t.create(this.x,this.y)},t}();t.Vector2=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=null,this.values=new Float32Array(3),t.length>0&&(this.values[0]=t[0],this.values[1]=t[1],this.values[2]=t[2])}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=null;return r=0===t.length?new this:new this(t[0],t[1],t[2])},Object.defineProperty(e.prototype,"x",{get:function(){return this.values[0]},set:function(t){this.values[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.values[1]},set:function(t){this.values[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this.values[2]},set:function(t){this.values[2]=t},enumerable:!0,configurable:!0}),e.prototype.normalize=function(){var t=this.values,e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return 0===e?(t[0]=0,t[1]=0,t[2]=0,this):(t[0]=t[0]/e,t[1]=t[1]/e,t[2]=t[2]/e,t[0]===-0&&(t[0]=0),t[1]===-0&&(t[1]=0),t[2]===-0&&(t[2]=0),this)},e.prototype.isZero=function(){var t=this.values;return 0===t[0]&&0===t[1]&&0===t[2]},e.prototype.scale=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=this.values;if(1===t.length){var n=t[0];r[0]*=n,r[1]*=n,r[2]*=n}else if(3===t.length){var o=t[0],i=t[1],a=t[2];r[0]*=o,r[1]*=i,r[2]*=a}return this},e.prototype.set=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(3===t.length)this.x=t[0],this.y=t[1],this.z=t[2];else{var r=t[0];this.x=r.x,this.y=r.y,this.z=r.z}},e.prototype.sub=function(t){return this.values[0]=this.values[0]-t.values[0],this.values[1]=this.values[1]-t.values[1],this.values[2]=this.values[2]-t.values[2],this},e.prototype.sub2=function(t,e){return this.values[0]=t.values[0]-e.values[0],this.values[1]=t.values[1]-e.values[1],this.values[2]=t.values[2]-e.values[2],this},e.prototype.add=function(t){return this.values[0]=this.values[0]+t.values[0],this.values[1]=this.values[1]+t.values[1],this.values[2]=this.values[2]+t.values[2],this},e.prototype.add2=function(t,e){return this.values[0]=t.values[0]+e.values[0],this.values[1]=t.values[1]+e.values[1],this.values[2]=t.values[2]+e.values[2],this},e.prototype.mul=function(t){return this.values[0]=this.values[0]*t.values[0],this.values[1]=this.values[1]*t.values[1],this.values[2]=this.values[2]*t.values[2],this},e.prototype.mul2=function(t,e){return this.values[0]=t.values[0]*e.values[0],this.values[1]=t.values[1]*e.values[1],this.values[2]=t.values[2]*e.values[2],this},e.prototype.reverse=function(){return this.values[0]=-this.values[0],this.values[1]=-this.values[1],this.values[2]=-this.values[2],this},e.prototype.copy=function(){var t=e.create(),r=0,n=this.values.length;for(r=0;n>r;r++)t.values[r]=this.values[r];return t},e.prototype.toVector4=function(){return t.Vector4.create(this.values[0],this.values[1],this.values[2],1)},e.prototype.length=function(){var t=this.values;return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},e.prototype.cross=function(t,e){var r,n,o,i,a,s,c,u,l;return r=t.values,n=e.values,o=this.values,i=r[0],a=r[1],s=r[2],c=n[0],u=n[1],l=n[2],o[0]=a*l-u*s,o[1]=s*c-l*i,o[2]=i*u-c*a,this},e.prototype.lerp=function(t,e,r){var n=t.values,o=e.values,i=this.values;return i[0]=n[0]+r*(o[0]-n[0]),i[1]=n[1]+r*(o[1]-n[1]),i[2]=n[2]+r*(o[2]-n[2]),this},e.prototype.dot=function(t){var e=this.values,r=t.values;return e[0]*r[0]+e[1]*r[1]+e[2]*r[2]},e.prototype.min=function(t){return this.x>t.x&&(this.x=t.x),this.y>t.y&&(this.y=t.y),this.z>t.z&&(this.z=t.z),this},e.prototype.max=function(t){return this.x<t.x&&(this.x=t.x),this.y<t.y&&(this.y=t.y),this.z<t.z&&(this.z=t.z),this},e.prototype.isEqual=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},e.prototype.toArray=function(){return[this.x,this.y,this.z]},e.prototype.applyMatrix4=function(t){var e=this.x,r=this.y,n=this.z,o=t.values;return this.x=o[0]*e+o[4]*r+o[8]*n+o[12],this.y=o[1]*e+o[5]*r+o[9]*n+o[13],this.z=o[2]*e+o[6]*r+o[10]*n+o[14],this},e.prototype.distanceTo=function(t){return Math.sqrt(this.distanceToSquared(t))},e.prototype.distanceToSquared=function(t){var e=this.x-t.x,r=this.y-t.y,n=this.z-t.z;return Math.pow(e,2)+Math.pow(r,2)+Math.pow(n,2)},e.up=e.create(0,1,0),e.forward=e.create(0,0,1),e.right=e.create(1,0,0),e}();t.Vector3=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=new Float32Array(4),t.length>0&&(this.values[0]=t[0],this.values[1]=t[1],this.values[2]=t[2],this.values[3]=t[3])}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=null;return r=0===t.length?new this:new this(t[0],t[1],t[2],t[3])},Object.defineProperty(e.prototype,"x",{get:function(){return this.values[0]},set:function(t){this.values[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this.values[1]},set:function(t){this.values[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this.values[2]},set:function(t){this.values[2]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"w",{get:function(){return this.values[3]},set:function(t){this.values[3]=t},enumerable:!0,configurable:!0}),e.prototype.normalize=function(){var t=this.values,r=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3]);return 0===r?e.create(0,0,0,0):(t[0]=t[0]/r,t[1]=t[1]/r,t[2]=t[2]/r,t[3]=t[3]/r,this)},e.prototype.copy=function(){return this.copyHelper(e.create())},e.prototype.toVector3=function(){return t.Vector3.create(this.values[0],this.values[1],this.values[2])},e.prototype.multiplyScalar=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},e.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},e.prototype.set=function(t,e,r,n){this.x=t,this.y=e,this.z=r,this.w=n},e.prototype.copyHelper=function(t){var e=t,r=0,n=this.values.length;for(r=0;n>r;r++)e.values[r]=this.values[r];return e},e}();t.Vector4=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=null,this._matrixArr=null,1===t.length?this.values=t[0]:this.values=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._matrixArr=[]}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=null;return r=0===t.length?new this:new this(t[0])},e.prototype.push=function(){this._matrixArr.push(this.values)},e.prototype.pop=function(){this.values=this._matrixArr.pop()},e.prototype.set=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=this.values,n=null;if(1===t.length){var o=t[0];n=o.values}else n=[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]];return r[0]=n[0],r[1]=n[1],r[2]=n[2],r[3]=n[3],r[4]=n[4],r[5]=n[5],r[6]=n[6],r[7]=n[7],r[8]=n[8],r[9]=n[9],r[10]=n[10],r[11]=n[11],r[12]=n[12],r[13]=n[13],r[14]=n[14],r[15]=n[15],this},e.prototype.setIdentity=function(){var t=this.values;return t[0]=1,t[4]=0,t[8]=0,t[12]=0,t[1]=0,t[5]=1,t[9]=0,t[13]=0,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1,this},e.prototype.invert=function(){var t,e,r,n,o,i,a,s,c,u,l,h,p,f,d,_,y,g,m,v,b,C,E,w,T,O,S,x,D,L;return L=this.values,t=L[0],e=L[1],r=L[2],n=L[3],o=L[4],i=L[5],a=L[6],s=L[7],c=L[8],u=L[9],l=L[10],h=L[11],p=L[12],f=L[13],d=L[14],_=L[15],y=t*i-e*o,g=t*a-r*o,m=t*s-n*o,v=e*a-r*i,b=e*s-n*i,C=r*s-n*a,E=c*f-u*p,w=c*d-l*p,T=c*_-h*p,O=u*d-l*f,S=u*_-h*f,x=l*_-h*d,D=1/(y*x-g*S+m*O+v*T-b*w+C*E),L[0]=(i*x-a*S+s*O)*D,L[1]=(-e*x+r*S-n*O)*D,L[2]=(f*C-d*b+_*v)*D,L[3]=(-u*C+l*b-h*v)*D,L[4]=(-o*x+a*T-s*w)*D,L[5]=(t*x-r*T+n*w)*D,L[6]=(-p*C+d*m-_*g)*D,L[7]=(c*C-l*m+h*g)*D,L[8]=(o*S-i*T+s*E)*D,L[9]=(-t*S+e*T-n*E)*D,L[10]=(p*b-f*m+_*y)*D,L[11]=(-c*b+u*m-h*y)*D,L[12]=(-o*O+i*w-a*E)*D,L[13]=(t*O-e*w+r*E)*D,L[14]=(-p*v+f*g-d*y)*D,L[15]=(c*v-u*g+l*y)*D,this},e.prototype.invertTo3x3=function(){var e,r,n,o,i,a,s,c,u,l,h,p,f,d=t.Matrix3.create();return l=this.values,h=d.values,e=l[10]*l[5]-l[6]*l[9],r=-l[10]*l[1]+l[2]*l[9],n=l[6]*l[1]-l[2]*l[5],o=-l[10]*l[4]+l[6]*l[8],i=l[10]*l[0]-l[2]*l[8],a=-l[6]*l[0]+l[2]*l[4],s=l[9]*l[4]-l[5]*l[8],c=-l[9]*l[0]+l[1]*l[8],u=l[5]*l[0]-l[1]*l[4],p=l[0]*e+l[1]*o+l[2]*s,0===p?(t.Log.warn("can't invert matrix, determinant is 0"),d):(f=1/p,h[0]=f*e,h[1]=f*r,h[2]=f*n,h[3]=f*o,h[4]=f*i,h[5]=f*a,h[6]=f*s,h[7]=f*c,h[8]=f*u,d)},e.prototype.transpose=function(){var t,e=this.values;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},e.prototype.setTranslate=function(t,e,r){var n=this.values;return n[0]=1,n[4]=0,n[8]=0,n[12]=t,n[1]=0,n[5]=1,n[9]=0,n[13]=e,n[2]=0,n[6]=0,n[10]=1,n[14]=r,n[3]=0,n[7]=0,n[11]=0,n[15]=1,this},e.prototype.translate=function(t,r,n){return this.applyMatrix(e.create().setTranslate(t,r,n)),this},e.prototype.setRotate=function(t,e,r,n){var o,i,a,s,c,u,l,h,p,f,d,_,t=Math.PI*t/180;return o=this.values,i=Math.sin(t),a=Math.cos(t),0!==e&&0===r&&0===n?(0>e&&(i=-i),o[0]=1,o[4]=0,o[8]=0,o[12]=0,o[1]=0,o[5]=a,o[9]=-i,o[13]=0,o[2]=0,o[6]=i,o[10]=a,o[14]=0,o[3]=0,o[7]=0,o[11]=0,o[15]=1):0===e&&0!==r&&0===n?(0>r&&(i=-i),o[0]=a,o[4]=0,o[8]=i,o[12]=0,o[1]=0,o[5]=1,o[9]=0,o[13]=0,o[2]=-i,o[6]=0,o[10]=a,o[14]=0,o[3]=0,o[7]=0,o[11]=0,o[15]=1):0===e&&0===r&&0!==n?(0>n&&(i=-i),o[0]=a,o[4]=-i,o[8]=0,o[12]=0,o[1]=i,o[5]=a,o[9]=0,o[13]=0,o[2]=0,o[6]=0,o[10]=1,o[14]=0,o[3]=0,o[7]=0,o[11]=0,o[15]=1):(s=Math.sqrt(e*e+r*r+n*n),1!==s&&(c=1/s,e*=c,r*=c,n*=c),u=1-a,l=e*r,h=r*n,p=n*e,f=e*i,d=r*i,_=n*i,o[0]=e*e*u+a,o[1]=l*u+_,o[2]=p*u-d,o[3]=0,o[4]=l*u-_,o[5]=r*r*u+a,o[6]=h*u+f,o[7]=0,o[8]=p*u+d,o[9]=h*u-f,o[10]=n*n*u+a,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1),this},e.prototype.rotate=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=t[0];if(2===t.length){var o=t[1];this.applyMatrix(e.create().setRotate(n,o.values[0],o.values[1],o.values[2]))}else if(4===t.length){var i=t[1],a=t[2],s=t[3];this.applyMatrix(e.create().setRotate(n,i,a,s))}return this},e.prototype.setScale=function(t,e,r){var n=this.values;return n[0]=t,n[4]=0,n[8]=0,n[12]=0,n[1]=0,n[5]=e,n[9]=0,n[13]=0,n[2]=0,n[6]=0,n[10]=r,n[14]=0,n[3]=0,n[7]=0,n[11]=0,n[15]=1,this},e.prototype.scale=function(t,r,n){return this.applyMatrix(e.create().setScale(t,r,n)),this},e.prototype.setLookAt=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n,o,i,a,s,c;3===e.length?(a=e[0],s=e[1],c=e[2]):9===e.length&&(a=t.Vector3.create(e[0],e[1],e[2]),s=t.Vector3.create(e[3],e[4],e[5]),c=t.Vector3.create(e[6],e[7],e[8])),n=t.Vector3.create(),i=a.copy().sub(s).normalize(),o=c.copy().normalize(),n.cross(o,i).normalize(),o.cross(i,n);var u=this.values;return u[0]=n.x,u[1]=n.y,u[2]=n.z,u[3]=0,u[4]=o.x,u[5]=o.y,u[6]=o.z,u[7]=0,u[8]=i.x,u[9]=i.y,u[10]=i.z,u[11]=0,u[12]=a.x,u[13]=a.y,u[14]=a.z,u[15]=1,this},e.prototype.lookAt=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];var n=e.create();
return this.applyMatrix(n.setLookAt.apply(n,t)),this},e.prototype.setOrtho=function(t,e,r,n,o,i){var a,s,c,u=this.values;return a=1/(e-t),s=1/(n-r),c=1/(i-o),u[0]=2*a,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=2*s,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=-2*c,u[11]=0,u[12]=-(e+t)*a,u[13]=-(n+r)*s,u[14]=-(i+o)*c,u[15]=1,this},e.prototype.ortho=function(t,r,n,o,i,a){return this.applyMatrix(e.create().setOrtho(t,r,n,o,i,a)),this},e.prototype.setPerspective=function(e,r,n,o){var i=null,a=null,s=null,c=null,e=Math.PI*e/180/2;return s=Math.sin(e),t.Log.error(0===s,t.Log.info.FUNC_MUST_NOT_BE("frustum","null")),a=1/(o-n),c=Math.cos(e)/s,i=this.values,i[0]=c/r,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=c,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=-(o+n)*a,i[11]=-1,i[12]=0,i[13]=0,i[14]=-2*n*o*a,i[15]=0,this},e.prototype.perspective=function(t,r,n,o){return this.applyMatrix(e.create().setPerspective(t,r,n,o)),this},e.prototype.applyMatrix=function(t,e){void 0===e&&(e=!1);var r=this,n=t.copy();return e?n.multiply(r):(this.values=n.multiply(r).values,this)},e.prototype.multiply=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=null,n=null,o=null;o=this.values,1===t.length?(r=this.values,n=t[0].values):2===t.length&&(r=t[0].values,n=t[1].values);var i=r[0],a=r[1],s=r[2],c=r[3],u=r[4],l=r[5],h=r[6],p=r[7],f=r[8],d=r[9],_=r[10],y=r[11],g=r[12],m=r[13],v=r[14],b=r[15],C=n[0],E=n[1],w=n[2],T=n[3],O=n[4],S=n[5],x=n[6],D=n[7],L=n[8],M=n[9],A=n[10],R=n[11],P=n[12],N=n[13],F=n[14],U=n[15];return o[0]=C*i+E*u+w*f+T*g,o[1]=C*a+E*l+w*d+T*m,o[2]=C*s+E*h+w*_+T*v,o[3]=C*c+E*p+w*y+T*b,o[4]=O*i+S*u+x*f+D*g,o[5]=O*a+S*l+x*d+D*m,o[6]=O*s+S*h+x*_+D*v,o[7]=O*c+S*p+x*y+D*b,o[8]=L*i+M*u+A*f+R*g,o[9]=L*a+M*l+A*d+R*m,o[10]=L*s+M*h+A*_+R*v,o[11]=L*c+M*p+A*y+R*b,o[12]=P*i+N*u+F*f+U*g,o[13]=P*a+N*l+F*d+U*m,o[14]=P*s+N*h+F*_+U*v,o[15]=P*c+N*p+F*y+U*b,this},e.prototype.multiplyVector4=function(e){var r=this.values,n=e.values,o=[];return o[0]=n[0]*r[0]+n[1]*r[4]+n[2]*r[8]+n[3]*r[12],o[1]=n[0]*r[1]+n[1]*r[5]+n[2]*r[9]+n[3]*r[13],o[2]=n[0]*r[2]+n[1]*r[6]+n[2]*r[10]+n[3]*r[14],o[3]=n[0]*r[3]+n[1]*r[7]+n[2]*r[11]+n[3]*r[15],t.Vector4.create(o[0],o[1],o[2],o[3])},e.prototype.multiplyVector3=function(e){var r=this.values,n=e.values,o=[];return o[0]=n[0]*r[0]+n[1]*r[4]+n[2]*r[8],o[1]=n[0]*r[1]+n[1]*r[5]+n[2]*r[9],o[2]=n[0]*r[2]+n[1]*r[6]+n[2]*r[10],t.Vector3.create(o[0],o[1],o[2])},e.prototype.multiplyPoint=function(e){var r=this.values,n=e.values,o=[];return o[0]=n[0]*r[0]+n[1]*r[4]+n[2]*r[8]+r[12],o[1]=n[0]*r[1]+n[1]*r[5]+n[2]*r[9]+r[13],o[2]=n[0]*r[2]+n[1]*r[6]+n[2]*r[10]+r[14],t.Vector3.create(o[0],o[1],o[2])},e.prototype.copy=function(){var t=e.create(),r=0,n=this.values.length;for(r=0;n>r;r++)t.values[r]=this.values[r];return t},e.prototype.getX=function(){return t.Vector3.create(this.values[0],this.values[1],this.values[2])},e.prototype.getY=function(){return t.Vector3.create(this.values[4],this.values[5],this.values[6])},e.prototype.getZ=function(){return t.Vector3.create(this.values[8],this.values[9],this.values[10])},e.prototype.getTranslation=function(){return t.Vector3.create(this.values[12],this.values[13],this.values[14])},e.prototype.getScale=function(){return t.Vector3.create(this.getX().length(),this.getY().length(),this.getZ().length())},e.prototype.getRotation=function(){return t.Quaternion.create().setFromMatrix(this)},e.prototype.getEulerAngles=function(){var e,r,n,o,i,a,s,c,u=this.getScale();return o=u.x,i=u.y,a=u.z,s=this.values,r=Math.asin(-s[2]/o),c=.5*Math.PI,c>r?r>-c?(e=Math.atan2(s[6]/i,s[10]/a),n=Math.atan2(s[1]/o,s[0]/o)):(n=0,e=-Math.atan2(s[4]/i,s[5]/i)):(n=0,e=Math.atan2(s[4]/i,s[5]/i)),t.Vector3.create(e,r,n).scale(t.RAD_TO_DEG)},e.prototype.setTRS=function(t,e,r){var n,o,i,a,s,c,u,l,h,p,f,d,_,y,g,m,v,b,C,E,w,T,O;return n=t.x,o=t.y,i=t.z,a=e.x,s=e.y,c=e.z,u=e.w,l=r.x,h=r.y,p=r.z,f=a+a,d=s+s,_=c+c,y=a*f,g=a*d,m=a*_,v=s*d,b=s*_,C=c*_,E=u*f,w=u*d,T=u*_,O=this.values,O[0]=(1-(v+C))*l,O[1]=(g+T)*l,O[2]=(m-w)*l,O[3]=0,O[4]=(g-T)*h,O[5]=(1-(y+C))*h,O[6]=(b+E)*h,O[7]=0,O[8]=(m+w)*p,O[9]=(b-E)*p,O[10]=(1-(y+v))*p,O[11]=0,O[12]=n,O[13]=o,O[14]=i,O[15]=1,this},__decorate([t.require(function(e,r,n,o,i,a){t.assert(e!==r&&n!==o&&i!==a,t.Log.info.FUNC_MUST_NOT_BE("frustum","null"))})],e.prototype,"setOrtho",null),__decorate([t.require(function(e,r,n,o){t.assert(n!==o&&0!==r,t.Log.info.FUNC_MUST_NOT_BE("frustum","null")),t.assert(n>0,t.Log.info.FUNC_MUST("near","> 0")),t.assert(o>0,t.Log.info.FUNC_MUST("far","> 0"))})],e.prototype,"setPerspective",null),e}();t.Matrix4=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];this.values=null,1===t.length?this.values=t[0]:this.values=new Float32Array([1,0,0,0,1,0,0,0,1])}return e.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=null;return r=0===t.length?new this:new this(t[0])},Object.defineProperty(e.prototype,"a",{get:function(){return this.values[0]},set:function(t){this.values[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"c",{get:function(){return this.values[1]},set:function(t){this.values[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"b",{get:function(){return this.values[3]},set:function(t){this.values[3]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"d",{get:function(){return this.values[4]},set:function(t){this.values[4]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tx",{get:function(){return this.values[6]},set:function(t){this.values[6]=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ty",{get:function(){return this.values[7]},set:function(t){this.values[7]=t},enumerable:!0,configurable:!0}),e.prototype.setIdentity=function(){var t=this.values;return t[0]=1,t[3]=0,t[6]=0,t[1]=0,t[4]=1,t[7]=0,t[2]=0,t[5]=0,t[8]=1,this},e.prototype.invert=function(){var t=this.values[0],e=this.values[1],r=this.values[3],n=this.values[4],o=this.values[6],i=this.values[7],a=t*n-e*r;return this.values[0]=n/a,this.values[1]=-e/a,this.values[3]=-r/a,this.values[4]=t/a,this.values[6]=(r*i-n*o)/a,this.values[7]=-(t*i-e*o)/a,this},e.prototype.multiplyScalar=function(t){var e=this.values;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this},e.prototype.multiplyVector2=function(e){var r=e.x,n=e.y,o=t.Vector2.create(),i=this.values;return o.x=i[0]*r+i[3]*n,o.y=i[1]*r+i[4]*n,o},e.prototype.multiplyPoint=function(e){var r=e.x,n=e.y,o=t.Vector2.create(),i=this.values;return o.x=i[0]*r+i[3]*n+this.tx,o.y=i[1]*r+i[4]*n+this.ty,o},e.prototype.multiply=function(t){var e=this.a*t.a+this.c*t.b,r=this.b*t.a+this.d*t.b,n=this.a*t.c+this.c*t.d,o=this.b*t.c+this.d*t.d,i=this.a*t.tx+this.c*t.ty+this.tx,a=this.b*t.tx+this.d*t.ty+this.ty;return this.a=e,this.b=r,this.c=n,this.d=o,this.tx=i,this.ty=a,this},e.prototype.transpose=function(){var t,e=this.values;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},e.prototype.copy=function(){return e.create().set(this)},e.prototype.set=function(t){var e=this.values,r=t.values;return e[0]=r[0],e[3]=r[3],e[6]=r[6],e[1]=r[1],e[4]=r[4],e[7]=r[7],e[2]=r[2],e[5]=r[5],e[8]=r[8],this},e.prototype.setTS=function(t,e){this.setPosition(t.x,t.y),this.setScale(e.x,e.y)},e.prototype.rotate=function(e){var r=e*t.DEG_TO_RAD,n=Math.cos(r),o=Math.sin(r),i=this.a*n+this.c*o,a=this.b*n+this.d*o,s=this.a*-o+this.c*n,c=this.b*-o+this.d*n;return this.a=i,this.b=a,this.c=s,this.d=c,this},e.prototype.setRotation=function(e){var r=e*t.DEG_TO_RAD,n=Math.cos(r),o=Math.sin(r),i=this.values;return i[0]=n,i[1]=-o,i[3]=o,i[4]=n,this},e.prototype.translate=function(t,e){this.tx+=this.a*t+this.c*e,this.ty+=this.b*t+this.d*e},e.prototype.setPosition=function(t,e){this.tx=t,this.ty=e},e.prototype.scale=function(t,e){return this.a*=t,this.b*=t,this.c*=e,this.d*=e,this},e.prototype.setScale=function(t,e){var r=this.values;return r[0]=t,r[4]=e,this},e.prototype.getTranslation=function(){return t.Vector2.create(this.tx,this.ty)},e.prototype.getScale=function(){return t.Vector2.create(Math.sqrt(this.a*this.a+this.b*this.b),Math.sqrt(this.c*this.c+this.d*this.d))},e.prototype.getRotation=function(){return this._getSkewX()},e.prototype.getSkew=function(){return t.Vector2.create(this._getSkewX(),this._getSkewY())},e.prototype._getDeltaTransformPoint=function(t,e){return{x:e.x*t.a+e.y*t.c+0,y:e.x*t.b+e.y*t.d+0}},e.prototype._getSkewX=function(){var t=this._getDeltaTransformPoint(this,{x:0,y:1});return 180/Math.PI*Math.atan2(t.y,t.x)-90},e.prototype._getSkewY=function(){var t=this._getDeltaTransformPoint(this,{x:1,y:0});return 180/Math.PI*Math.atan2(t.y,t.x)},e}();t.Matrix3=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e,r,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===n&&(n=1),this.x=null,this.y=null,this.z=null,this.w=null,this.x=t,this.y=e,this.z=r,this.w=n}return e.create=function(t,e,r,n){var o=new this(t,e,r,n);return o},e.prototype.setFromEulerAngles=function(e){var r,n,o,i,a,s,c,u=e.x,l=e.y,h=e.z;return c=.5*t.DEG_TO_RAD,u*=c,l*=c,h*=c,r=Math.sin(u),n=Math.cos(u),o=Math.sin(l),i=Math.cos(l),a=Math.sin(h),s=Math.cos(h),this.x=r*i*s-n*o*a,this.y=n*o*s+r*i*a,this.z=n*i*a-r*o*s,this.w=n*i*s+r*o*a,this},e.prototype.multiply=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r,n,o,i,a,s,c,u,l,h,p=this;return 1===t.length?(l=this,h=t[0]):2===t.length&&(l=t[0],h=t[1]),r=l.x,n=l.y,o=l.z,i=l.w,a=h.x,s=h.y,c=h.z,u=h.w,p.x=i*a+r*u+n*c-o*s,p.y=i*s+n*u+o*a-r*c,p.z=i*c+o*u+r*s-n*a,p.w=i*u-r*a-n*s-o*c,p},e.prototype.setFromMatrix=function(t){var e,r,n,o,i,a,s,c,u,l,h,p,f,d,_,y;return y=t.values,e=y[0],r=y[1],n=y[2],o=y[4],i=y[5],a=y[6],s=y[8],c=y[9],u=y[10],f=1/Math.sqrt(e*e+r*r+n*n),d=1/Math.sqrt(o*o+i*i+a*a),_=1/Math.sqrt(s*s+c*c+u*u),e*=f,r*=f,n*=f,o*=d,i*=d,a*=d,s*=_,c*=_,u*=_,l=e+i+u,l>=0?(h=Math.sqrt(l+1),this.w=.5*h,h=.5/h,this.x=(a-c)*h,this.y=(s-n)*h,this.z=(r-o)*h):e>i?e>u?(p=e-(i+u)+1,p=Math.sqrt(p),this.x=.5*p,p=.5/p,this.w=(a-c)*p,this.y=(r+o)*p,this.z=(n+s)*p):(p=u-(e+i)+1,p=Math.sqrt(p),this.z=.5*p,p=.5/p,this.w=(r-o)*p,this.x=(s+n)*p,this.y=(c+a)*p):i>u?(p=i-(u+e)+1,p=Math.sqrt(p),this.y=.5*p,p=.5/p,this.w=(s-n)*p,this.z=(a+c)*p,this.x=(o+r)*p):(p=u-(e+i)+1,p=Math.sqrt(p),this.z=.5*p,p=.5/p,this.w=(r-o)*p,this.x=(s+n)*p,this.y=(c+a)*p),this},e.prototype.setFromAxisAngle=function(e,r){var n,o;return r=r.normalize(),e*=.5*t.DEG_TO_RAD,n=Math.sin(e),o=Math.cos(e),this.x=n*r.x,this.y=n*r.y,this.z=n*r.z,this.w=o,this},e.prototype.invert=function(){return this.conjugate().normalize()},e.prototype.conjugate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},e.prototype.clone=function(){return e.create(this.x,this.y,this.z,this.w)},e.prototype.copy=function(){return e.create(this.x,this.y,this.z,this.w)},e.prototype.normalize=function(){var t=this.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},e.prototype.length=function(){var t,e,r,n;return t=this.x,e=this.y,r=this.z,n=this.w,Math.sqrt(t*t+e*e+r*r+n*n)},e.prototype.multiplyVector3=function(e){var r=this,n=e.x,o=e.y,i=e.z,a=r.x,s=r.y,c=r.z,u=r.w,l=u*n+s*i-c*o,h=u*o+c*n-a*i,p=u*i+a*o-s*n,f=-a*n-s*o-c*i;return t.Vector3.create(l*u+f*-a+h*-c-p*-s,h*u+f*-s+p*-a-l*-c,p*u+f*-c+l*-s-h*-a)},e.prototype.set=function(t,e,r,n){this.x=t,this.y=e,this.z=r,this.w=n},e.prototype.sub=function(t){var e=t.copy().invert().multiply(this);return this.set(e.x,e.y,e.z,e.w),this},e.prototype.getEulerAngles=function(){var e,r,n,o,i,a,s,c;return o=this.x,i=this.y,a=this.z,s=this.w,c=2*(s*i-o*a),-.99999>=c?(e=2*Math.atan2(o,s),r=-Math.PI/2,n=0):c>=.99999?(e=2*Math.atan2(o,s),r=Math.PI/2,n=0):(e=Math.atan2(2*(s*o+i*a),1-2*(o*o+i*i)),r=Math.asin(c),n=Math.atan2(2*(s*a+o*i),1-2*(i*i+a*a))),t.Vector3.create(e,r,n).scale(t.RAD_TO_DEG)},e.prototype.slerp=function(t,r,n){var o,i,a=n,s=t.x*r.x+t.y*r.y+t.z*r.z+t.w*r.w,c=!1;if(0>s&&(c=!0,s=-s),s>.999999)i=1-a,o=c?-a:a;else{var u=Math.acos(s),l=1/Math.sin(u);i=Math.sin((1-a)*u)*l,o=c?-Math.sin(a*u)*l:Math.sin(a*u)*l}return e.create(i*t.x+o*r.x,i*t.y+o*r.y,i*t.z+o*r.z,i*t.w+o*r.w)},e}();t.Quaternion=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(e,r,n,o){this.normal=t.Vector3.create(0,1,0),this.d=0,this.normal=t.Vector3.create(e,r,n),this.d=o}return e.create=function(t,e,r,n){var o=new this(t,e,r,n);return o},e.prototype.getReflectionMatrix=function(){this.normalize();var e=this.normal.x,r=this.normal.y,n=this.normal.z,o=-2*e,i=-2*r,a=-2*n,s=t.Matrix4.create();return s.values[0]=o*e+1,s.values[1]=i*e,s.values[2]=a*e,s.values[3]=0,s.values[4]=o*r,s.values[5]=i*r+1,s.values[6]=a*r,s.values[7]=0,s.values[8]=o*n,s.values[9]=i*n,s.values[10]=a*n+1,s.values[11]=0,s.values[12]=o*this.d,s.values[13]=i*this.d,s.values[14]=a*this.d,s.values[15]=1,s},e.prototype.normalize=function(){var t=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),e=0;return 0!==t&&(e=1/t),this.normal.x*=e,this.normal.y*=e,this.normal.z*=e,this.d*=e,this},e.prototype.copy=function(){return e.create(this.normal.x,this.normal.y,this.normal.z,this.d)},e.prototype.dotCoordinate=function(t){return this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z+this.d},e}();t.Plane=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e){this._origin=null,this._direction=null,this._origin=t,this._direction=e}return e.create=function(t,e){var r=new this(t,e);return r},e.prototype.isIntersectWithAABB=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null,o=null,i=t.Vector3.create(),a=null,s=null,c=t.Vector3.create(),u=t.Vector3.create(),l=this._origin,h=this._direction;if(1===e.length){var p=e[0];n=p.center,o=p.halfExtents}else if(2===e.length){var f=e[0],d=e[1];n=t.AABBShape.getCenter(f,d),o=t.AABBShape.getHalfExtents(f,d)}return i.sub2(l,n),a=t.Vector3.create(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z)),u.mul2(i,h),a.x>o.x&&u.x>=0?!1:a.y>o.y&&u.y>=0?!1:a.z>o.z&&u.z>=0?!1:(s=t.Vector3.create(Math.abs(h.x),Math.abs(h.y),Math.abs(h.z)),c.cross(h,i),c.set(Math.abs(c.x),Math.abs(c.y),Math.abs(c.z)),c.x>o.y*s.z+o.z*s.y?!1:c.y>o.x*s.z+o.z*s.x?!1:c.z>o.x*s.y+o.y*s.x?!1:!0)},e.prototype.isIntersectWithSphere=function(e){var r=e.center,n=e.radius,o=t.Vector3.create(),i=0,a=0,s=0,c=0,u=this._origin,l=this._direction;return o.sub2(u,r),o.dot(o)<n*n?!0:(i=l.dot(l),a=2*l.dot(o),s=r.dot(r),s+=u.dot(u),s-=2*r.dot(u),s-=n*n,c=a*a-4*i*s,0>c?!1:!0)},e}();t.Ray=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this.uid=null,this._tagList=wdCb.Collection.create(),this.uid=t._count,t._count+=1}return t.prototype.addTag=function(t){this._tagList.addChild(t)},t.prototype.removeTag=function(t){this._tagList.removeChild(t)},t.prototype.getTagList=function(){return this._tagList},t.prototype.hasTag=function(t){return this._tagList.hasChild(t)},t.prototype.containTag=function(t){return this._tagList.hasChildWithFunc(function(e){return e.indexOf(t)>-1})},t._count=1,t}();t.Entity=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.entityObject=null}return __extends(r,e),r.prototype.init=function(){},r.prototype.dispose=function(){},Object.defineProperty(r.prototype,"transform",{get:function(){return this.entityObject?this.entityObject.transform:null},enumerable:!0,configurable:!0}),r.prototype.addToObject=function(t){this.entityObject&&this.entityObject.removeComponent(this),this.entityObject=t},r.prototype.removeFromObject=function(t){this.entityObject=null},__decorate([t.virtual],r.prototype,"init",null),__decorate([t.virtual],r.prototype,"dispose",null),r}(t.Entity);t.Component=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(){function t(){this._scheduleCount=0,this._schedules=wdCb.Hash.create()}return t.create=function(){var t=new this;return t},t.prototype.update=function(t){var e=this;this._schedules.forEach(function(r,n){r.isStop||r.isPause||(r.update(t),r.isFinish&&e.remove(n))})},t.prototype.scheduleLoop=function(t,e){return void 0===e&&(e=[]),this._schedule(i,Array.prototype.slice.call(arguments,0))},t.prototype.scheduleFrame=function(t,e,r){return void 0===e&&(e=1),this._schedule(a,Array.prototype.slice.call(arguments,0))},t.prototype.scheduleInterval=function(t,e,r){return void 0===e&&(e=0),this._schedule(o,Array.prototype.slice.call(arguments,0))},t.prototype.scheduleTime=function(t,e,r){return void 0===e&&(e=0),this._schedule(n,Array.prototype.slice.call(arguments,0))},t.prototype.pause=function(t){if(0===arguments.length){var e=this;this._schedules.forEach(function(t,r){e.pause(r)})}else if(1===arguments.length){var r=this._schedules.getChild(arguments[0]);r.pause()}},t.prototype.resume=function(t){if(0===arguments.length){var e=this;this._schedules.forEach(function(t,r){e.resume(r)})}else if(1===arguments.length){var r=this._schedules.getChild(arguments[0]);r.resume()}},t.prototype.start=function(t){if(0===arguments.length){var e=this;this._schedules.forEach(function(t,r){e.start(r)})}else if(1===arguments.length){var r=this._schedules.getChild(arguments[0]);r.start()}},t.prototype.stop=function(t){if(0===arguments.length){var e=this;this._schedules.forEach(function(t,r){e.stop(r)})}else if(1===arguments.length){var r=this._schedules.getChild(arguments[0]);r.stop()}},t.prototype.has=function(t){return!!this._schedules.hasChild(t)},t.prototype.remove=function(t){this._schedules.removeChild(t)},t.prototype.removeAll=function(){this._schedules.removeAllChildren()},t.prototype._schedule=function(t,e){var r=this._buildId();return this._schedules.setValue(r,t.create.apply(t,e)),r},t.prototype._buildId=function(){return"Schedule_"+this._scheduleCount++},t}();t.Scheduler=e;var r=function(){function e(e,r){this.isPause=!1,this.isStop=!1,this.pauseTime=null,this.pauseElapsed=null,this.startTime=null,this.isFinish=!1,this.task=null,this.args=null,this.timeController=t.CommonTimeController.create(),this.task=e,this.args=r}return e.prototype.pause=function(){this.isPause=!0,this.timeController.pause()},e.prototype.resume=function(){this.isPause=!1,this.timeController.resume()},e.prototype.start=function(){this.isStop=!1,this.timeController.start()},e.prototype.stop=function(){this.isStop=!0,this.timeController.stop()},e.prototype.finish=function(){this.isFinish=!0},e}(),n=function(t){function e(e,r,n){void 0===r&&(r=0),void 0===n&&(n=[]),t.call(this,e,n),this._time=null,this._time=r}return __extends(e,t),e.create=function(t,e,r){void 0===e&&(e=0),void 0===r&&(r=[]);var n=new this(t,e,r);return n},e.prototype.update=function(t){var e=this.timeController.computeElapseTime(t);e>=this._time&&(this.task.apply(this,this.args),this.finish())},e}(r),o=function(t){function e(e,r,n){void 0===r&&(r=0),void 0===n&&(n=[]),t.call(this,e,n),this._intervalTime=null,this._elapsed=0,this._intervalTime=r}return __extends(e,t),e.create=function(t,e,r){void 0===e&&(e=0),void 0===r&&(r=[]);var n=new this(t,e,r);return n},e.prototype.update=function(t){var e=this.timeController.computeElapseTime(t);e-this._elapsed>=this._intervalTime&&(this.task.apply(this,this.args),this._elapsed=e)},e.prototype.start=function(){t.prototype.start.call(this),this._elapsed=0},e}(r),i=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e){void 0===e&&(e=[]);var r=new this(t,e);return r},e.prototype.update=function(t){this.task.apply(this,this.args)},e}(r),a=function(t){function e(e,r,n){void 0===r&&(r=1),void 0===n&&(n=[]),t.call(this,e,n),this._frame=null,this._frame=r}return __extends(e,t),e.create=function(t,e,r){void 0===e&&(e=1),void 0===r&&(r=[]);var n=new this(t,e,r);return n},e.prototype.update=function(t){this._frame--,this._frame<=0&&(this.task.apply(this,this.args),this.finish())},e}(r)}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e;!function(t){t[t.NORMAL=0]="NORMAL",t[t.STOP=1]="STOP",t[t.PAUSE=2]="PAUSE"}(e||(e={}));var r=function(){function r(){this.scene=null,this.scheduler=null,this.renderer=null,this.domEventManager=t.DomEventManager.create(),this._gameLoop=null,this._eventSubscription=null,this._gameState=e.NORMAL,this._timeController=t.DirectorTimeController.create()}return r.getInstance=function(){return null===this._instance&&(this._instance=new this,this._instance.initWhenCreate()),this._instance},Object.defineProperty(r.prototype,"gameTime",{get:function(){return this._timeController.gameTime},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fps",{get:function(){return this._timeController.fps},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isNormal",{get:function(){return this._gameState===e.NORMAL},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isStop",{get:function(){return this._gameState===e.STOP},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isPause",{get:function(){return this._gameState===e.PAUSE},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isTimeChange",{get:function(){return this._timeController.isTimeChange},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"elapsed",{get:function(){return this._timeController.elapsed},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"view",{get:function(){return t.DeviceManager.getInstance().view},enumerable:!0,configurable:!0}),r.prototype.initWhenCreate=function(){this.scene=t.SceneDispatcher.create(),this.scheduler=t.Scheduler.create(),this.renderer=t.WebGLRenderer.create()},r.prototype.start=function(){this._gameState=e.NORMAL,this._startLoop()},r.prototype.stop=function(){this._gameLoop&&this._gameLoop.dispose(),this._gameState=e.STOP,this._timeController.stop(),this.scheduler.stop(),this._eventSubscription&&this._eventSubscription.dispose()},r.prototype.pause=function(){this._gameState!==e.PAUSE&&(this._gameState=e.PAUSE,this._timeController.pause(),this.scheduler.pause())},r.prototype.resume=function(){this._gameState=e.NORMAL,this._timeController.resume(),this.scheduler.resume()},r.prototype.getDeltaTime=function(){return this._timeController.deltaTime},r.prototype.initUIObjectScene=function(){var t=this.scene.uiObjectScene;this._initDomEvent(),t.onEnter(),t.init()},r.prototype.runUIObjectScene=function(e){var r=this.scene.uiObjectScene;t.EventManager.trigger(r,t.CustomEvent.create(t.EEngineEvent.STARTLOOP)),r.update(e),t.EventManager.trigger(r,t.CustomEvent.create(t.EEngineEvent.ENDLOOP))},r.prototype._startLoop=function(){var t=this;this._gameLoop=this._buildInitStream().ignoreElements().concat(this._buildLoopStream()).subscribe(function(e){t._loopBody(e)})},r.prototype._buildInitStream=function(){var t=this;return wdFrp.callFunc(function(){t._init()},this)},r.prototype._init=function(){this._initGameObjectScene(),this.initUIObjectScene(),t.DebugStatistics.init()},r.prototype._initGameObjectScene=function(){var e=this.scene.gameObjectScene;this._initDomEvent(),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.BEFORE_GAMEOBJECT_INIT)),e.onEnter(),e.init(),this.renderer.init(),this._timeController.start(),this.scheduler.start(),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.AFTER_GAMEOBJECT_INIT)),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.AFTER_GAMEOBJECT_INIT_RIGIDBODY_ADD_CONSTRAINT))},r.prototype._buildLoopStream=function(){return wdFrp.intervalRequest()},r.prototype._loopBody=function(t){var r=null;return this._gameState===e.PAUSE||this._gameState===e.STOP?!1:(r=this._timeController.computeElapseTime(t),this._run(r),!0)},r.prototype._run=function(t){this._runGameObjectScene(t),this.runUIObjectScene(t)},r.prototype._runGameObjectScene=function(e){var r=this.scene.gameObjectScene;this._timeController.tick(e),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.STARTLOOP)),this.scheduler.update(e),r.update(e),r.render(this.renderer),this.renderer.clear(),this.renderer.hasCommand()&&this.renderer.render(),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.ENDLOOP))},r.prototype._initDomEvent=function(){this._eventSubscription=this.domEventManager.initDomEvent()},r._instance=null,__decorate([t.execOnlyOnce("_isInitUIScene")],r.prototype,"initUIObjectScene",null),__decorate([t.execOnlyOnce("_isInitDomEvent")],r.prototype,"_initDomEvent",null),r}();t.Director=r}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return Object.defineProperty(e,"isTest",{get:function(){return this._isTest},set:function(t){this._isTest=t,wdFrp.Main.isTest=t},enumerable:!0,configurable:!0}),e.setConfig=function(e){var r=e.canvasId,n=e.isTest,o=void 0===n?t.DebugConfig.isTest:n,i=e.screenSize,a=void 0===i?t.EScreenSize.FULL:i;return this.isTest=o,this.screenSize=a,this._canvasId=r,this},e.init=function(){return t.DeviceManager.getInstance().createGL(this._canvasId),t.DeviceManager.getInstance().setScreen(),t.GPUDetector.getInstance().detect(),this},e._isTest=!1,e.screenSize=null,e._canvasId=null,e}();t.Main=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.designatedTriggerList=null,this._lastTriggerList=null,this._isDragEventTriggering=!1,this._triggerListOfDragEvent=null}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"scene",{get:function(){return t.Director.getInstance().scene},enumerable:!0,configurable:!0}),e.prototype.initDomEvent=function(){var e=this;return wdFrp.fromArray([t.EventManager.fromEvent(t.EEventName.CLICK),t.EventManager.fromEvent(t.EEventName.MOUSEDOWN),t.EventManager.fromEvent(t.EEventName.MOUSEUP),t.EventManager.fromEvent(t.EEventName.MOUSEWHEEL),this._buildMouseDragStream()]).mergeAll().filter(function(e){return!t.Director.getInstance().isPause}).map(function(t){var r=e._getMouseEventTriggerList(t);return e._isDragEventTriggering&&(e._triggerListOfDragEvent=r),e._getMouseEventTriggerListData(t,r)}).merge(this._buildMouseMoveStream()).subscribe(function(t){var r=t[0],n=t[1];r.forEach(function(t){e._trigger(n.copy(),t)})})},e.prototype._buildMouseDragStream=function(){var e=this;return t.EventManager.fromEvent(document,t.EEventName.MOUSEDOWN).flatMap(function(r){return t.EventManager.fromEvent(document,t.EEventName.MOUSEMOVE).takeUntil(t.EventManager.fromEvent(document,t.EEventName.MOUSEUP)["do"](function(t){e._isDragEventTriggering=!1}))}).map(function(r){return r.name=t.EEventName.MOUSEDRAG,e._isDragEventTriggering=!0,r})},e.prototype._buildMouseMoveStream=function(){var e=this;return t.EventManager.fromEvent(t.EEventName.MOUSEMOVE).filter(function(e){return!t.Director.getInstance().isPause}).map(function(t){var r=null;r=e.designatedTriggerList?e.designatedTriggerList:e._isDragEventTriggering?e._triggerListOfDragEvent:e._getMouseEventTriggerList(t);var n=e._getMouseOverAndMouseOutObject(r,e._lastTriggerList),o=n.mouseoverObjects,i=n.mouseoutObjects;return e._setMouseOverTag(o),e._setMouseOutTag(i),e._lastTriggerList=r.copy(),r=i.addChildren(r),e._getMouseEventTriggerListData(t,r)})},e.prototype._getMouseOverAndMouseOutObject=function(e,r){var n=wdCb.Collection.create(),o=wdCb.Collection.create();return r?(r.forEach(function(r){e.hasChildWithFunc(function(e){return t.JudgeUtils.isEqual(e,r)})||o.addChild(r)}),e.forEach(function(e){r.hasChildWithFunc(function(r){return t.JudgeUtils.isEqual(e,r)})||n.addChild(e)})):n=e,{mouseoverObjects:n,mouseoutObjects:o}},e.prototype._setMouseOverTag=function(t){t.forEach(function(t){t.addTag(r.MOUSE_OVER)})},e.prototype._setMouseOutTag=function(t){t.forEach(function(t){t.addTag(r.MOUSE_OUT)})},e.prototype._setEventNameByEventTag=function(e,n){return e.hasTag(r.MOUSE_OVER)?n.name=t.EEventName.MOUSEOVER:e.hasTag(r.MOUSE_OUT)&&(n.name=t.EEventName.MOUSEOUT),n},e.prototype._removeEventTag=function(t){t.removeTag(r.MOUSE_OVER),t.removeTag(r.MOUSE_OUT)},e.prototype._trigger=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=e[0],o=e[1],i=!1,a=null,s=null,c=null;3===e.length&&e[2]?(i=!0,a=n):(a=this._setEventNameByEventTag(o,n),this._removeEventTag(o)),c=t.EventTriggerTable.getScriptHandlerName(a.name),s=t.CustomEvent.create(t.EEngineEvent[t.EventTriggerTable.getScriptEngineEvent(a.name)]),s.getDataFromDomEvent(a),t.EventManager.trigger(o,s,a,i),a.getDataFromCustomEvent(s),o.execEventScript(c,a),!a.isStopPropagation&&o.bubbleParent&&this._trigger(a.copy(),o.bubbleParent,!0)},e.prototype._getMouseEventTriggerList=function(t){var e=null,r=null,n=null;return this.designatedTriggerList?this.designatedTriggerList:(n=wdCb.Collection.create(),e=this._findTopGameObject(t,this.scene.gameObjectScene),r=this._findTopUIObject(t,this.scene.uiObjectScene),e&&n.addChild(e),r&&n.addChild(r),this._isSceneAsTopOne(t,n)&&n.addChild(this.scene),n)},e.prototype._isSceneAsTopOne=function(t,e){return this._isTriggerScene(t)&&0===e.getCount()},e.prototype._findTopGameObject=function(t,e){var r=this;return this._findTriggerGameObjectList(t,e).sort(function(t,e){return r._getDistanceToCamera(t)-r._getDistanceToCamera(e)}).getChild(0)},e.prototype._getDistanceToCamera=function(e){return e.transform.position.copy().sub(t.Director.getInstance().scene.currentCamera.transform.position).length()},e.prototype._findTopUIObject=function(t,e){return this._findTriggerUIObjectList(t,e).sort(function(t,e){return e.transform.zIndex-t.transform.zIndex}).getChild(0)},e.prototype._findTriggerGameObjectList=function(e,r){var n=wdCb.Collection.create(),o=this,i=function(r){r.hasComponent(t.SpacePartition)?r.getSpacePartition().getIntersectListWithRay(e).forEach(function(t){o._addTriggerObjectByQueryDetector(t,e,n)}):(o._addTriggerObjectByQueryDetector(r,e,n),r.forEach(function(t){i(t)}))};return r.forEach(function(t){i(t)}),n},e.prototype._findTriggerUIObjectList=function(t,e){var r=wdCb.Collection.create(),n=this,o=function(e){n._addTriggerObjectByQueryDetector(e,t,r),e.forEach(function(t){o(t)})};return e.forEach(function(t){o(t)}),r},e.prototype._addTriggerObjectByQueryDetector=function(e,r,n){if(e.hasComponent(t.EventTriggerDetector)){var o=e.getComponent(t.EventTriggerDetector);o.isTrigger(r)&&n.addChild(e)}},e.prototype._isTriggerScene=function(e){var r=this.scene.getComponent(t.EventTriggerDetector);return r.isTrigger(e)},e.prototype._getMouseEventTriggerListData=function(t,e){return[e,t]},e}();t.DomEventManager=e;var r;!function(t){t[t.MOUSE_OVER="MOUSE_OVER"]="MOUSE_OVER",t[t.MOUSE_OUT="MOUSE_OUT"]="MOUSE_OUT"}(r||(r={}))}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);
return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._scriptList=wdCb.Hash.create(),this._bubbleParent=null,this._transform=null,this.name=null,this.parent=null,this.isVisible=!0,this.actionManager=t.ActionManager.create(),this.children=wdCb.Collection.create(),this.startLoopHandler=null,this.endLoopHandler=null,this.components=wdCb.Collection.create(),this._scriptExecuteHistory=wdCb.Hash.create(),this._hasComponentCache=wdCb.Hash.create(),this._getComponentCache=wdCb.Hash.create(),this._rendererComponent=null,this._animation=null,this._collider=null,this._componentChangeSubscription=null}return __extends(r,e),Object.defineProperty(r.prototype,"scriptList",{get:function(){return this._scriptList},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bubbleParent",{get:function(){return this._bubbleParent?this._bubbleParent:this.parent},set:function(t){this._bubbleParent=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"transform",{get:function(){return this._transform},set:function(t){t&&(this._transform&&this.removeComponent(this._transform),this.addComponent(t),this._transform=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"componentDirty",{set:function(t){t===!0&&this.clearCache()},enumerable:!0,configurable:!0}),r.prototype.initWhenCreate=function(){this.transform=this.createTransform()},r.prototype.init=function(){var e=this,r=this;return this.startLoopHandler=wdCb.FunctionUtils.bind(this,function(){e.onStartLoop()}),this.endLoopHandler=wdCb.FunctionUtils.bind(this,function(){e.onEndLoop()}),this.bindStartLoopEvent(),this.bindEndLoopEvent(),this._componentChangeSubscription=t.EventManager.fromEvent(this,t.EEngineEvent.COMPONENT_CHANGE).subscribe(function(){r._onComponentChange()}),this.initComponent(),this.forEach(function(t){t.init()}),this.afterInitChildren(),this},r.prototype.onStartLoop=function(){this.execScript("onStartLoop")},r.prototype.onEndLoop=function(){this.execScript("onEndLoop")},r.prototype.onEnter=function(){},r.prototype.onExit=function(){this.execScript("onExit")},r.prototype.onDispose=function(){this.execScript("onDispose")},r.prototype.dispose=function(){var e=null;this.onDispose(),this.parent&&(this.parent.removeChild(this),this.parent=null),t.EventManager.off(this),t.EventManager.off(t.EEngineEvent.STARTLOOP,this.startLoopHandler),t.EventManager.off(t.EEngineEvent.ENDLOOP,this.endLoopHandler),this._componentChangeSubscription&&this._componentChangeSubscription.dispose(),e=this.removeAllComponent(),e.forEach(function(t){t.dispose()}),this.forEach(function(t){t.dispose()})},r.prototype.hasChild=function(t){return this.children.hasChild(t)},r.prototype.addChild=function(t){return t.parent&&t.parent.removeChild(t),t.parent=this,t.transform.parent=this.transform,this.children.addChild(t),t.onEnter(),this},r.prototype.addChildren=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.children.addChildren(t[0]),this},r.prototype.forEach=function(t){return this.children.forEach(t),this},r.prototype.filter=function(t){return this.children.filter(t)},r.prototype.sort=function(t,e){return void 0===e&&(e=!1),this.children.sort(t,e)},r.prototype.getChildren=function(){return this.children},r.prototype.getChild=function(t){return this.children.getChild(t)},r.prototype.findChildByUid=function(t){return this.children.findOne(function(e){return e.uid===t})},r.prototype.findChildByTag=function(t){return this.children.findOne(function(e){return e.hasTag(t)})},r.prototype.findChildByName=function(t){return this.children.findOne(function(e){return e.name.search(t)>-1})},r.prototype.findChildrenByName=function(t){return this.children.filter(function(e){return e.name.search(t)>-1})},r.prototype.getComponent=function(t){return this.components.findOne(function(e){return e instanceof t})},r.prototype.findComponentByUid=function(t){return this.components.findOne(function(e){return e.uid===t})},r.prototype.getFirstComponent=function(){return this.components.getChild(0)},r.prototype.forEachComponent=function(t){return this.components.forEach(t),this},r.prototype.removeChild=function(t){return t.onExit(),this.children.removeChild(t),t.parent=null,this},r.prototype.hasComponent=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=this._getHasComponentCacheKey(e[0]),o=this._hasComponentCache.getChild(n);if(void 0!==o)return o;if(t.JudgeUtils.isComponenet(e[0])){var i=e[0];o=this.components.hasChild(i)}else{var a=e[0];o=this.components.hasChildWithFunc(function(t){return t instanceof a})}return this._hasComponentCache.addChild(n,o),o},r.prototype.addComponent=function(e){return this.hasComponent(e)?(t.Log.assert(!1,"the component already exist"),this):(e instanceof t.RendererComponent?this._rendererComponent=e:e instanceof t.Animation?this._animation=e:e instanceof t.Collider&&(this._collider=e),this.components.addChild(e),e.addToObject(this),this.componentDirty=!0,this)},r.prototype.removeComponent=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null;return n=e[0]instanceof t.Component?e[0]:this.getComponent(e[0]),this.components.removeChild(n),this._removeComponentHandler(n),this.componentDirty=!0,this},r.prototype.removeAllComponent=function(){var t=this,e=wdCb.Collection.create();return this.components.forEach(function(r){t._removeComponentHandler(r),e.addChild(r)},this),this.components.removeAllChildren(),this.componentDirty=!0,e},r.prototype.render=function(e,r){var n=null,o=null;this.isVisible&&(n=this._getGeometry(),o=this._getRendererComponent(),o&&n&&(o.render(e,n,r),t.DebugStatistics.count.renderGameObjects++),this.getRenderList().forEach(function(t){t.render(e,r)}))},r.prototype.update=function(t){var e=this._getAnimation(),r=this._getCollider();e&&e.update(t),this.actionManager.update(t),this.execScript("update",t),r&&r.update(t),this.beforeUpdateChildren(t),this.forEach(function(e){e.update(t)})},r.prototype.execScript=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=t[0],n=this;if(1===t.length)this._scriptList.forEach(function(t,e){t[r]&&t[r](),n._addToScriptExecuteHistory(e,r)});else if(2===t.length){var o=t[1];this._scriptList.forEach(function(t,e){t[r]&&t[r](o),n._addToScriptExecuteHistory(e,r)})}else if(3===t.length){var i=t[1],a=t[2];this._scriptList.forEach(function(t,e){a&&n._isScriptExecuted(e,r)||(t[r]&&t[r](i),n._addToScriptExecuteHistory(e,r))})}},r.prototype.execEventScript=function(t,e){this._scriptList.forEach(function(r){r[t]&&(e?r[t](e):r[t]())})},r.prototype.getComponentCount=function(t){return this.components.filter(function(e){return e instanceof t}).getCount()},r.prototype.beforeUpdateChildren=function(t){},r.prototype.afterInitChildren=function(){},r.prototype.bindStartLoopEvent=function(){t.EventManager.on(t.EEngineEvent.STARTLOOP,this.startLoopHandler)},r.prototype.bindEndLoopEvent=function(){t.EventManager.on(t.EEngineEvent.ENDLOOP,this.endLoopHandler)},r.prototype.getRenderList=function(){return this.isVisible?this.children:null},r.prototype.initComponent=function(){this.hasComponent(t.Geometry)&&this.getComponent(t.Geometry).init(),this.components.filter(function(e){return!(e instanceof t.Geometry)}).forEach(function(t){t.init()})},r.prototype.getAllChildren=function(){var t=wdCb.Collection.create(),e=function(r){t.addChildren(r.getChildren()),r.forEach(function(t){e(t)})};return e(this),t},r.prototype.clearCache=function(){this._hasComponentCache.removeAllChildren(),this._getComponentCache.removeAllChildren()},r.prototype._getGeometry=function(){return this.getComponent(t.Geometry)},r.prototype._getAnimation=function(){return this._animation},r.prototype._getRendererComponent=function(){return this._rendererComponent},r.prototype._getCollider=function(){return this._collider},r.prototype._removeComponentHandler=function(t){t.removeFromObject(this)},r.prototype._addToScriptExecuteHistory=function(t,e){this._scriptExecuteHistory.addChild(this._buildScriptHistoryKey(t,e),!0)},r.prototype._isScriptExecuted=function(t,e){return this._scriptExecuteHistory.getChild(this._buildScriptHistoryKey(t,e))},r.prototype._buildScriptHistoryKey=function(t,e){return t+"_"+e},r.prototype._getHasComponentCacheKey=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(t.JudgeUtils.isComponenet(e[0])){var n=e[0];return String(n.uid)}var o=e[0];return o.name},r.prototype._onComponentChange=function(){this.clearCache()},__decorate([t.virtual],r.prototype,"initWhenCreate",null),__decorate([t.cache(function(t){return this._getComponentCache.hasChild(t.name)},function(t){return this._getComponentCache.getChild(t.name)},function(t,e){this._getComponentCache.addChild(e.name,t)})],r.prototype,"getComponent",null),__decorate([t.virtual],r.prototype,"beforeUpdateChildren",null),__decorate([t.virtual],r.prototype,"afterInitChildren",null),__decorate([t.virtual],r.prototype,"bindStartLoopEvent",null),__decorate([t.virtual],r.prototype,"bindEndLoopEvent",null),__decorate([t.virtual],r.prototype,"getRenderList",null),__decorate([t.require(function(){t.assert(this.getComponentCount(t.Geometry)<=1,t.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 geometry component"))})],r.prototype,"_getGeometry",null),__decorate([t.require(function(){t.assert(this.getComponentCount(t.Animation)<=1,t.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 animation component"))})],r.prototype,"_getAnimation",null),__decorate([t.require(function(){t.assert(this.getComponentCount(t.RendererComponent)<=1,t.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 rendererComponent"))})],r.prototype,"_getRendererComponent",null),__decorate([t.require(function(){t.assert(this.getComponentCount(t.Collider)<=1,t.Log.info.FUNC_SHOULD_NOT("entityObject","contain more than 1 collider component"))})],r.prototype,"_getCollider",null),__decorate([t.ensure(function(e){t.assert(t.JudgeUtils.isString(e),t.Log.info.FUNC_SHOULD("key:"+e,"be string"))})],r.prototype,"_getHasComponentCacheKey",null),r}(t.Entity);t.EntityObject=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.name="uiObject"+String(this.uid),this.uiManager=t.UIManager.create(this)}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.beforeUpdateChildren=function(t){this.uiManager.update(t)},r.prototype.createTransform=function(){return t.RectTransform.create()},r.prototype.addComponent=function(t){return e.prototype.addComponent.call(this,t),this},r.prototype.addChild=function(t){return e.prototype.addChild.call(this,t),this},__decorate([t.require(function(e){e instanceof t.UI&&t.assert(!this.getComponent(t.UI),t.Log.info.FUNC_SHOULD("only has one UI component"))})],r.prototype,"addComponent",null),__decorate([t.require(function(e){t.assert(this.getComponent(t.UIRenderer)===e.getComponent(t.UIRenderer),t.Log.info.FUNC_MUST_BE("the UIRenderer of UIObject and its children","the same one"))})],r.prototype,"addChild",null),r}(t.EntityObject);t.UIObject=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.name="gameObject"+String(this.uid)}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.getSpacePartition=function(){return this.getComponent(t.SpacePartition)},r.prototype.getComponent=function(r){if(this._isGeometry(r)){var n=this.getComponent(t.LODController);if(n&&n.activeGeometry)return n.activeGeometry}return e.prototype.getComponent.call(this,r)},r.prototype.update=function(r){var n=this.getComponent(t.LODController);n&&n.update(r),e.prototype.update.call(this,r)},r.prototype.createTransform=function(){return t.ThreeDTransform.create()},r.prototype.getRenderList=function(){return this.hasComponent(t.Octree)?this.getSpacePartition().getRenderListByFrustumCull():this.children},r.prototype.afterInitChildren=function(){return this.hasComponent(t.Octree)?this.getSpacePartition().build():void 0},r.prototype._isGeometry=function(t){return"Geometry"===t.name},r}(t.EntityObject);t.GameObject=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.name="scene"+String(this.uid),this.uiObjectScene=t.UIObjectScene.create(),this.gameObjectScene=t.GameObjectScene.create()}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(r.prototype,"scriptList",{get:function(){return this.gameObjectScene.scriptList},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"actionManager",{get:function(){return this.gameObjectScene.actionManager},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"ambientLight",{get:function(){return this.gameObjectScene.ambientLight},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"directionLights",{get:function(){return this.gameObjectScene.directionLights},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pointLights",{get:function(){return this.gameObjectScene.pointLights},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"side",{get:function(){return this.gameObjectScene.side},set:function(t){this.gameObjectScene.side=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"shadowMap",{get:function(){return this.gameObjectScene.shadowMap},set:function(t){this.gameObjectScene.shadowMap=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"shader",{get:function(){return this.gameObjectScene.shader},set:function(t){this.gameObjectScene.shader=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"currentCamera",{get:function(){return this.gameObjectScene.currentCamera},set:function(t){this.gameObjectScene.currentCamera=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isUseProgram",{get:function(){return this.gameObjectScene.isUseProgram},set:function(t){this.gameObjectScene.isUseProgram=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"physics",{get:function(){return this.gameObjectScene.physics},set:function(t){this.gameObjectScene.physics=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"physicsEngineAdapter",{get:function(){return this.gameObjectScene.physicsEngineAdapter},set:function(t){this.gameObjectScene.physicsEngineAdapter=t},enumerable:!0,configurable:!0}),r.prototype.initWhenCreate=function(){e.prototype.initWhenCreate.call(this),this.addComponent(t.SceneEventTriggerDetector.create())},r.prototype.useProgram=function(t){this.gameObjectScene.useProgram(t)},r.prototype.unUseProgram=function(){this.gameObjectScene.unUseProgram()},r.prototype.addChild=function(e){return e instanceof t.GameObject?this.gameObjectScene.addChild(e):e instanceof t.UIObject&&this.uiObjectScene.addChild(e),e.parent=this,this},r.prototype.addRenderTargetRenderer=function(t){return this.gameObjectScene.addRenderTargetRenderer(t)},r.prototype.addProceduralRenderTargetRenderer=function(t){return this.gameObjectScene.addProceduralRenderTargetRenderer(t)},r.prototype.removeRenderTargetRenderer=function(t){this.gameObjectScene.removeRenderTargetRenderer(t)},r.prototype.dispose=function(){this.gameObjectScene.dispose(),this.uiObjectScene.dispose()},r.prototype.hasChild=function(e){return e instanceof t.GameObject?this.gameObjectScene.hasChild(e):e instanceof t.UIObject?this.uiObjectScene.hasChild(e):void 0},r.prototype.addChildren=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(e[0]instanceof t.EntityObject){var n=e[0];this.addChild(n)}if(e[0]instanceof wdCb.Collection){var o=e[0],i=this;o.forEach(function(t){i.addChild(t)})}else if(t.JudgeUtils.isArrayExactly(e[0]))for(var o=e[0],a=0,s=o;a<s.length;a++){var n=s[a];this.addChild(n)}return this},r.prototype.getChildren=function(){return this.gameObjectScene.getChildren().addChildren(this.uiObjectScene.getChildren())},r.prototype.findChildByUid=function(t){var e=this.gameObjectScene.findChildByUid(t);return e||(e=this.uiObjectScene.findChildByUid(t)),e},r.prototype.findChildByTag=function(t){var e=this.gameObjectScene.findChildByTag(t);return e||(e=this.uiObjectScene.findChildByTag(t)),e},r.prototype.findChildByName=function(t){var e=this.gameObjectScene.findChildByName(t);return e||(e=this.uiObjectScene.findChildByName(t)),e},r.prototype.findChildrenByName=function(t){return this.gameObjectScene.findChildrenByName(t).addChildren(this.uiObjectScene.findChildrenByName(t))},r.prototype.removeChild=function(e){return e instanceof t.GameObject?this.gameObjectScene.removeChild(e):e instanceof t.UIObject?this.uiObjectScene.removeChild(e):void 0},r.prototype.onStartLoop=function(){this.gameObjectScene.onStartLoop(),this.uiObjectScene.onStartLoop()},r.prototype.onEndLoop=function(){this.gameObjectScene.onEndLoop(),this.uiObjectScene.onEndLoop()},r.prototype.onEnter=function(){this.gameObjectScene.onEnter(),this.uiObjectScene.onEnter()},r.prototype.onExit=function(){this.gameObjectScene.onExit(),this.uiObjectScene.onExit()},r.prototype.onDispose=function(){this.gameObjectScene.onDispose(),this.uiObjectScene.onDispose()},r.prototype.execScript=function(t,e){this.gameObjectScene.execScript.apply(this.gameObjectScene,arguments)},r.prototype.execEventScript=function(t,e){this.gameObjectScene.execEventScript.apply(this.gameObjectScene,arguments)},r.prototype.createTransform=function(){return null},r}(t.EntityObject);t.SceneDispatcher=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.EntityObject);t.Scene=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._currentCamera=null,this.side=null,this.shadowMap=o.create(this),this.shader=null,this.isUseProgram=!1,this.physics=r.create(),this.physicsEngineAdapter=null,this._lightManager=t.LightManager.create(),this._renderTargetRendererList=wdCb.Collection.create(),this._proceduralRendererList=wdCb.Collection.create(),this._collisionDetector=t.CollisionDetector.create(),this._cameraList=wdCb.Collection.create()}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"ambientLight",{get:function(){return this._lightManager.ambientLight},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"directionLights",{get:function(){return this._lightManager.directionLights},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pointLights",{get:function(){return this._lightManager.pointLights},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currentCamera",{get:function(){return this._currentCamera||this._cameraList.getChild(0)},set:function(e){if(t.JudgeUtils.isNumber(e)){var r=e;this._currentCamera=this._cameraList.getChild(r)}else if(e instanceof t.GameObject){var n=e;this._currentCamera=n}},enumerable:!0,configurable:!0}),n.prototype.init=function(){return this.physics.enable&&(this.physicsEngineAdapter=t.PhysicsEngineFactory.create(this.physics.engine),this.physicsEngineAdapter.init()),e.prototype.init.call(this),this._renderTargetRendererList.forEach(function(t){return t.init()}),this._proceduralRendererList.forEach(function(t){return t.init()}),this},n.prototype.useProgram=function(t){this.isUseProgram=!0,this.shader=t},n.prototype.unUseProgram=function(){this.isUseProgram=!1},n.prototype.addChild=function(t){var r=this._getCameras(t),n=this._getLights(t);return r.getCount()>0&&this._cameraList.addChildren(r),n.getCount()>0&&this._lightManager.addChildren(n),e.prototype.addChild.call(this,t)},n.prototype.addRenderTargetRenderer=function(t){this._renderTargetRendererList.addChild(t)},n.prototype.addProceduralRenderTargetRenderer=function(t){this._proceduralRendererList.addChild(t)},n.prototype.removeRenderTargetRenderer=function(t){this._renderTargetRendererList.removeChild(t)},n.prototype.update=function(t){var r=this._getCurrentCameraComponent();this.physics.enable&&this.physicsEngineAdapter.update(t),r&&r.update(t),e.prototype.update.call(this,t),this._collisionDetector.detect(this)},n.prototype.render=function(t){var r=this;this._renderTargetRendererList.forEach(function(e){e.render(t,r.currentCamera)}),this._renderProceduralRenderer(t),e.prototype.render.call(this,t,this.currentCamera)},n.prototype.createTransform=function(){return null},n.prototype._renderProceduralRenderer=function(t){this._proceduralRendererList.filter(function(t){return t.needRender()}).forEach(function(e){e.render(t)})},n.prototype._getCameras=function(t){return this._find(t,this._isCamera)},n.prototype._getLights=function(t){return this._find(t,this._isLight)},n.prototype._find=function(t,e){var r=this,n=wdCb.Collection.create(),o=function(t){e.call(r,t)&&n.addChild(t),t.forEach(function(t){o(t)})};return o(t),n},n.prototype._isCamera=function(e){return e.hasComponent(t.CameraController)},n.prototype._isLight=function(e){return e.hasComponent(t.Light)},n.prototype._getCurrentCameraComponent=function(){return this.currentCamera?this.currentCamera.getComponent(t.CameraController):null},__decorate([t.requireSetter(function(e){if(t.JudgeUtils.isNumber(e)){var r=e;t.assert(!!this._cameraList.getChild(r),t.Log.info.FUNC_NOT_EXIST("current camera in cameraList"))}})],n.prototype,"currentCamera",null),n}(t.Scene);t.GameObjectScene=e;var r=function(){function e(){this._gravity=t.Vector3.create(0,-9.8,0),this.enable=!1,this.engine=t.EPhysicsEngineType.CANNON,this.iterations=10}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"gravity",{get:function(){return this._gravity},set:function(t){this._gravity=t},enumerable:!0,configurable:!0}),__decorate([t.operateWorldDataGetterAndSetter("Gravity")],e.prototype,"gravity",null),e}();t.PhysicsConfig=r,function(t){t[t.NONE=0]="NONE",t[t.PCF=1]="PCF"}(t.EShadowMapSoftType||(t.EShadowMapSoftType={}));var n=t.EShadowMapSoftType,o=function(){function e(t){this._scene=null,this._enable=!0,this._softType=n.NONE,this._scene=t}return e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"enable",{get:function(){return this._enable},set:function(t){this._enable=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"softType",{get:function(){return this._softType},set:function(e){e!==this._softType&&(t.EventManager.broadcast(this._scene,t.CustomEvent.create(t.EEngineEvent.SHADOWMAP_SOFTTYPE_CHANGE)),this._softType=e)},enumerable:!0,configurable:!0}),e}();t.ShadowMapModel=o}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.onEndLoop=function(){e.prototype.onEndLoop.call(this),this._resetAllTransformState(),this._resetAllRendererClearCanvasFlag()},r.prototype.onStartLoop=function(){e.prototype.onStartLoop.call(this),this._sortSiblingChildren()},r.prototype.createTransform=function(){return null},r.prototype.beforeUpdateChildren=function(e){var r=this;this._resetAllRendererState(),this.forEach(function(e){var n=r._getUIRenderer(e);n.dirty?(n.isClearCanvas||(n.clearCanvas(),n.dirtyDuringCurrentLoop=!1),n.state=t.EUIRendererState.DIRTY,n.resetDirty()):n.state!==t.EUIRendererState.DIRTY&&(n.state=t.EUIRendererState.NOT_DIRTY)})},r.prototype.bindStartLoopEvent=function(){t.EventManager.on(this,t.EEngineEvent.STARTLOOP,this.startLoopHandler)},r.prototype.bindEndLoopEvent=function(){t.EventManager.on(this,t.EEngineEvent.ENDLOOP,this.endLoopHandler)},r.prototype._getUIRenderer=function(e){return e.getComponent(t.UIRenderer)},r.prototype._resetAllRendererClearCanvasFlag=function(){var t=this;this.forEach(function(e){var r=t._getUIRenderer(e);r.isClearCanvas=!1})},r.prototype._resetAllRendererState=function(){var e=this;this.forEach(function(r){var n=e._getUIRenderer(r);n.state=t.EUIRendererState.NORMAL})},r.prototype._resetAllTransformState=function(){var t=this,e=function(r){t._isNotDirtyDuringThisLoop(t._getUIRenderer(r))&&t._resetTransformFlag(r),r.forEach(function(t){e(t)})};this.forEach(function(t){e(t)})},r.prototype._isNotDirtyDuringThisLoop=function(t){return!t.dirtyDuringCurrentLoop},r.prototype._resetTransformFlag=function(t){var e=t.transform;e.isTranslate=!1,e.isScale=!1,e.isRotate=!1},r.prototype._sortSiblingChildren=function(){var t=function(e){e.sort(function(t,e){return t.transform.zIndex-e.transform.zIndex},!0),e.forEach(function(e){t(e)})};t(this)},__decorate([t.require(function(e){this.forEach(function(e){t.assert(e instanceof t.UIObject,t.Log.info.FUNC_MUST_BE("child","UIObject")),t.assert(e.hasComponent(t.UI),t.Log.info.FUNC_SHOULD("UIObject","contain ui component"))})})],r.prototype,"beforeUpdateChildren",null),__decorate([t.require(function(e){t.assert(e.getComponentCount(t.UIRenderer)<=1,t.Log.info.FUNC_SHOULD_NOT("uiObject","contain more than 1 uiRenderer component"))})],r.prototype,"_getUIRenderer",null),__decorate([t.ensure(function(){var e=this;this.getAllChildren().forEach(function(r){var n=e._getUIRenderer(r);t.assert(!n.isClearCanvas,t.Log.info.FUNC_SHOULD("reset all UIRenderers->isClearCanvas"))})})],r.prototype,"_resetAllRendererClearCanvasFlag",null),__decorate([t.ensure(function(){var e=this;this.getAllChildren().forEach(function(r){var n=e._getUIRenderer(r);t.assert(n.state===t.EUIRendererState.NORMAL,t.Log.info.FUNC_SHOULD("reset all UIRenderers->state"))})})],r.prototype,"_resetAllRendererState",null),r}(t.Scene);t.UIObjectScene=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this._lastCollideObjects=null,this._collisionTable=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},e.prototype.detect=function(e){var n=e.filter(function(e){return e.hasComponent(t.Collider)||t.JudgeUtils.isSpacePartitionObject(e)}),o=this;this._clearCollisionTable(),n.forEach(function(e){if(!e.hasComponent(t.RigidBody)){var i=o._getCollideObjects(e,n),a=i.targetCollideObjects,s=i.sourceCollideObjects;s.forEach(function(t){a.getCount()>0?(o._isCollisionStart(t)?(t.execScript("onCollisionStart",a),t.execScript("onContact",a),o._triggerCollisionEventOfCollideObjectWhichHasRigidBody(a,t,["onCollisionStart","onContact"])):(t.execScript("onContact",a),o._triggerCollisionEventOfCollideObjectWhichHasRigidBody(a,t,["onContact"])),t.addTag(r.COLLIDED),o._lastCollideObjects=a):(o._isCollisionEnd(t)&&(t.execScript("onCollisionEnd"),o._triggerCollisionEventOfCollideObjectWhichHasRigidBody(o._lastCollideObjects,t,["onCollisionEnd"])),t.removeTag(r.COLLIDED))})}})},e.prototype._getCollideObjects=function(e,r){var n=wdCb.Collection.create(),o=wdCb.Collection.create(),i=this,a=null;return t.JudgeUtils.isSpacePartitionObject(e)?(r.forEach(function(r){t.JudgeUtils.isSelf(e,r)||(t.JudgeUtils.isSpacePartitionObject(r)?i._getCollideObjectsWithSpacePartition(r.getSpacePartition(),e.getSpacePartition(),n,o):i._getCollideObjectsWithSpacePartition(r,e.getSpacePartition(),n,o))}),this._recordCollisionTargets(n,o),{targetCollideObjects:n.removeRepeatItems(),sourceCollideObjects:o.removeRepeatItems()}):(a=e.getComponent(t.Collider),r.forEach(function(r){t.JudgeUtils.isSelf(e,r)||(t.JudgeUtils.isSpacePartitionObject(r)?i._getCollideObjectsWithSpacePartition(r.getSpacePartition(),a,e,n,o):i._getCollideObjectsByGameObjectToGameObject(e,a,r,n))}),o.addChild(e),n.getCount()>0&&this._recordCollisionTargets(n,o),{targetCollideObjects:n.removeRepeatItems(),sourceCollideObjects:o.removeRepeatItems()})},e.prototype._getCollideObjectsByGameObjectToGameObject=function(t,e,n,o){this._isTargetCollidedWithSourceInCurrentFrame(t,n)?o.addChild(n):this._isNotTransform(t)&&this._isNotTransform(n)&&!t.hasTag(r.COLLIDED)||!e.isCollide(n)||o.addChild(n)},e.prototype._clearCollisionTable=function(){this._collisionTable.removeAllChildren()},e.prototype._isTargetCollidedWithSourceInCurrentFrame=function(e,r){var n=this._collisionTable.getChild(String(r.uid));return n?n.hasChildWithFunc(function(r){return t.JudgeUtils.isEqual(r,e)}):!1},e.prototype._recordCollisionTargets=function(t,e){var r=this._collisionTable;e.forEach(function(e){t.forEach(function(t){r.appendChild(String(e.uid),t)})})},e.prototype._getCollideObjectsWithSpacePartition=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(4===e.length){if(e[0]instanceof t.GameObject&&e[1]instanceof t.SpacePartition){var n=e[0],o=e[1],i=e[2],a=e[3],s=n.getComponent(t.Collider),c=this;o.getCollideObjects(s.shape).forEach(function(t){c._getCollideObjectsByGameObjectToGameObject(n,s,t,a)}),a.getCount()>0&&i.addChild(n),a.removeAllChildren(),a.addChildren(o.getChildren())}else if(e[0]instanceof t.SpacePartition&&e[1]instanceof t.SpacePartition){var u=e[0],o=e[1],l=e[2],h=e[3],p=this;o.getChildren().forEach(function(e){var r=e.getComponent(t.Collider);p._getCollideObjectsWithSpacePartition(u,r,e,l,h)})}}else if(5===e.length){var f=e[0],d=e[1],_=e[2],y=e[3],g=e[4],m=this;if(!d)return;return f.getCollideObjects(d.shape).forEach(function(t){m._getCollideObjectsByGameObjectToGameObject(_,d,t,y)}),void g.addChild(_)}},e.prototype._isCollisionStart=function(t){return!t.hasTag(r.COLLIDED)},e.prototype._isCollisionEnd=function(t){return t.hasTag(r.COLLIDED)},e.prototype._triggerCollisionEventOfCollideObjectWhichHasRigidBody=function(e,r,n){
e.filter(function(e){return e.hasComponent(t.RigidBody)}).forEach(function(t){for(var e=0,o=n;e<o.length;e++){var i=o[e];t.execScript(i,wdCb.Collection.create([r]))}})},e.prototype._isNotTransform=function(t){return!t.transform.isTransform},__decorate([t.require(function(e,r){r.forEach(function(e){t.assert(e instanceof t.GameObject,t.Log.info.FUNC_SHOULD("targetObject","be GameObject"))})})],e.prototype,"_getCollideObjects",null),__decorate([t.require(function(e,r,n,o){t.assert(e instanceof t.GameObject&&n instanceof t.GameObject,t.Log.info.FUNC_SHOULD("sourceObject and targetObject","be GameObject"))})],e.prototype,"_getCollideObjectsByGameObjectToGameObject",null),e}();t.CollisionDetector=e;var r;!function(t){t[t.COLLIDED="COLLIDED"]="COLLIDED"}(r||(r={}))}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this.listenerMap=wdCb.Hash.create()}return t.prototype.hasChild=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=t[0],n=t[1],o=this.listenerMap.getChild(this.buildKey(r,n));return o&&o.getCount()>0},t.prototype.hasChildWithFunc=function(t){return this.listenerMap.hasChildWithFunc(t)},t.prototype.appendChild=function(t,e,r){this.listenerMap.appendChild(this.buildKey(t,e),r)},t.prototype.filter=function(t){return this.listenerMap.filter(t)},t.prototype.forEach=function(t){return this.listenerMap.forEach(t)},t.prototype.getEventNameFromKey=function(t){var e=this.getEventSeparator();return t.indexOf(e)>-1?t.split(e)[1]:t},t.prototype.isEventName=function(t,e){return t.indexOf(""+this.getEventSeparator()+e)>-1||t===e},t}();t.EventListenerMap=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.getChild=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=this;if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];return this.listenerMap.getChild(o)}if(1===e.length&&e[0]instanceof t.EntityObject){var i=e[0];return this.listenerMap.filter(function(t,e){return n.isTarget(e,i,t)})}if(2===e.length){var a=e[0],o=e[1];return this.listenerMap.getChild(this.buildKey(a,o))}},r.prototype.removeChild=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=this;if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];this.listenerMap.removeChild(function(t,e){return n.isEventName(e,o)})}else if(1===e.length&&e[0]instanceof t.EntityObject){var i=e[0];this.listenerMap.removeChild(function(t,e){return n.isTarget(e,i,t)})}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var a=e[0],s=e[1],c=null;this.listenerMap.hasChild(a)&&(c=this.listenerMap.getChild(a),wdCb.Collection.create().addChild(c.removeChild(function(t){return t.originHandler===s})),0===c.getCount()&&this.listenerMap.removeChild(a))}else if(2===e.length&&t.JudgeUtils.isNumber(e[0])){var u=e[0],a=e[1];this.listenerMap.removeChild(this.buildKey(u,a))}else if(2===e.length&&e[0]instanceof t.EntityObject){var l=e[0],a=e[1];this.listenerMap.removeChild(this.buildKey(l,a))}else if(3===e.length&&e[0]instanceof t.EntityObject){var a=e[1],h=e[2];this.listenerMap.forEach(function(t,e){return t.removeChild(function(t){return t.originHandler===h}),0===t.getCount()?wdCb.$REMOVE:void 0})}},r.prototype.getUidFromKey=function(t){var e=""+r.eventSeparator;return t.indexOf(e)>-1?Number(t.split(e)[0]):null},r.prototype.isTarget=function(t,e,r){return t.indexOf(this._buildKeyPrefix(e.uid))>-1&&void 0!==r},r.prototype.getEventSeparator=function(){return""+r.eventSeparator},r.prototype.buildKey=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(t.JudgeUtils.isNumber(e[0])){var n=e[0],o=e[1];return this._buildKeyWithUid(n,o)}if(e[0]instanceof t.EntityObject){var i=e[0],o=e[1];return this._buildKeyWithUid(i.uid,o)}if(null===e[0]){var o=e[1];return o}},r.prototype._buildKeyWithUid=function(t,e){return""+this._buildKeyPrefix(t)+r.eventSeparator+e},r.prototype._buildKeyPrefix=function(t){return""+String(t)},r.eventSeparator="@",r}(t.EventListenerMap);t.CustomEventListenerMap=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.getChild=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(1===t.length){var r=t[0];return this.listenerMap.getChild(r)}if(2===t.length){var n=t[0],r=t[1];return this.listenerMap.getChild(this.buildKey(n,r))}},r.prototype.removeChild=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=this,o=null;if(1===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0];o=this._getEventDataOffDataList(i,this.listenerMap.removeChild(function(t,e){return n.isEventName(e,i)}))}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var a=e[0],s=e[1],c=wdCb.Collection.create();this.listenerMap.forEach(function(t,e){if(n.isEventName(e,a)){var r=t.removeChild(function(t){return t.originHandler===s});if(r.getCount()>0&&c.addChild(r),0===t.getCount())return wdCb.$REMOVE}}),o=this._getEventDataOffDataList(a,c)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var u=e[0],l=e[1];o=this._getEventDataOffDataList(l,this.listenerMap.removeChild(this.buildKey(u,l)))}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var l=e[1],h=wdCb.Collection.create(),p=e[2];this.listenerMap.forEach(function(t,e){var r=t.removeChild(function(t){return t.originHandler===p});return r.getCount()>0&&h.addChild(r),0===t.getCount()?wdCb.$REMOVE:void 0}),o=this._getEventDataOffDataList(l,h)}return o},r.prototype.isDom=function(t,e,r){return t.indexOf(this._buildKeyPrefix(e))>-1&&void 0!==r},r.prototype.getEventSeparator=function(){return""+r.eventSeparator},r.prototype.buildKey=function(t,e){return""+this._buildKeyPrefix(t)+r.eventSeparator+e},r.prototype._buildKeyPrefix=function(t){return t.id?""+t.tagName+t.id:""+t.tagName},r.prototype._getEventDataOffDataList=function(t,e){return e.map(function(e){return e.map(function(e){return{dom:e.dom,eventName:t,domHandler:e.domHandler}})})},r.eventSeparator="@",r}(t.EventListenerMap);t.DomEventListenerMap=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.MOUSE=0]="MOUSE",t[t.KEYBOARD=1]="KEYBOARD",t[t.CUSTOM=2]="CUSTOM"}(t.EEventType||(t.EEventType={}));t.EEventType}(wd||(wd={}));var wd;!function(t){var e;!function(t){t[t.FALLBACK="fallback"]="FALLBACK",t[t.FIREFOX="firefox"]="FIREFOX",t[t.CHROME="chrome"]="CHROME"}(e||(e={})),function(t){t[t.CLICK="click"]="CLICK",t[t.MOUSEOVER="mouseover"]="MOUSEOVER",t[t.MOUSEUP="mouseup"]="MOUSEUP",t[t.MOUSEOUT="mouseout"]="MOUSEOUT",t[t.MOUSEMOVE="mousemove"]="MOUSEMOVE",t[t.MOUSEDOWN="mousedown"]="MOUSEDOWN",t[t.MOUSEWHEEL="mousewheel|DOMMouseScroll*"+e.FIREFOX]="MOUSEWHEEL",t[t.MOUSEDRAG="mousedrag"]="MOUSEDRAG",t[t.KEYDOWN="keydown"]="KEYDOWN",t[t.KEYUP="keyup"]="KEYUP",t[t.KEYPRESS="keypress"]="KEYPRESS"}(t.EEventName||(t.EEventName={}));var r=(t.EEventName,"|"),n="*",o=function(){function t(){}return t.handleEventName=function(t){for(var e=t,n=null,o=[],i=null,a=0,s=e.split(r);a<s.length;a++){var c=s[a];this._isFallbackEventName(c)?n=c:o.push(c)}return i=this._getSpecifyBrowserEventName(o),null!==i?i:n},t._isFallbackEventName=function(t){return 1===t.split(n).length},t._getSpecifyBrowserEventName=function(t){for(var r=null,o=0,i=t;o<i.length;o++){var a=i[o],s=a.split(n),c=s[0],u=s[1];switch(u){case e.CHROME:bowser.chrome&&(r=c);break;case e.FIREFOX:bowser.firefox&&(r=c)}if(r)break}return r},t}();t.EventNameHandler=o}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BROADCAST=0]="BROADCAST",t[t.EMIT=1]="EMIT"}(t.EEventPhase||(t.EEventPhase={}));t.EEventPhase}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create();e.addChild(t.EEventName.CLICK,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEOVER,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEOUT,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEMOVE,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEDOWN,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEUP,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEWHEEL,t.EEventType.MOUSE),e.addChild(t.EEventName.MOUSEDRAG,t.EEventType.MOUSE),e.addChild(t.EEventName.KEYDOWN,t.EEventType.KEYBOARD),e.addChild(t.EEventName.KEYPRESS,t.EEventType.KEYBOARD),e.addChild(t.EEventName.KEYUP,t.EEventType.KEYBOARD);var r=function(){function r(){}return r.getEventType=function(r){var n=e.getChild(r);return void 0===n&&(n=t.EEventType.CUSTOM),n},r}();t.EventTable=r}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this.p_type=null,this.name=null,this.currentTarget=null,this.isStopPropagation=!1,this.phase=null,this.name=t}return Object.defineProperty(e.prototype,"type",{get:function(){return t.Log.error(null===this.p_type,t.Log.info.ABSTRACT_ATTRIBUTE),this.p_type},enumerable:!0,configurable:!0}),e.prototype.stopPropagation=function(){this.isStopPropagation=!0},e.prototype.copyMember=function(t,e,r){return r.forEach(function(r){t[r]=e[r]}),t},e}();t.Event=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(t,r){e.call(this,r),this._event=null,this.event=t}return __extends(r,e),Object.defineProperty(r.prototype,"event",{get:function(){return this._event},set:function(e){this._event=e||t.root.event},enumerable:!0,configurable:!0}),r.prototype.preventDefault=function(){var t=this._event;bowser.msie&&Number(bowser.version)<=8?t.returnValue=!1:t.preventDefault()},r.prototype.getDataFromCustomEvent=function(t){this.target=t.target,this.currentTarget=t.currentTarget,this.isStopPropagation=t.isStopPropagation},r}(t.Event);t.DomEvent=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._location=null,this._locationInView=null,this._button=null,this.lastX=null,this.lastY=null,this.p_type=t.EEventType.MOUSE}return __extends(r,e),r.create=function(t,e){var r=new this(t,e);return r},Object.defineProperty(r.prototype,"location",{get:function(){var e=null,r=this.event;return this._location?this._location:(e=t.Point.create(),bowser.msie?(e.x=r.clientX+document.body.scrollLeft||document.documentElement.scrollLeft,e.y=r.clientY+document.body.scrollTop||document.documentElement.scrollTop):(e.x=r.pageX,e.y=r.pageY),e)},set:function(t){this._location=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"locationInView",{get:function(){var e=null,r=null;return this._locationInView?this._locationInView:(e=this.location,r=t.DeviceManager.getInstance().view.offset,t.Point.create(e.x-r.x,e.y-r.y))},set:function(t){this._locationInView=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"button",{get:function(){var e=this.event,r=null;if(this._button)return this._button;if(bowser.msie)switch(e.button){case 1:r=t.EMouseButton.LEFT;break;case 4:r=t.EMouseButton.RIGHT;break;case 2:r=t.EMouseButton.CENTER;break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("multi mouse button"))}else switch(e.button){case 0:r=t.EMouseButton.LEFT;break;case 1:r=t.EMouseButton.RIGHT;break;case 2:r=t.EMouseButton.CENTER;break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("multi mouse button"))}return r},set:function(t){this._button=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"wheel",{get:function(){var t=this.event;return t.detail?-1*t.detail:t.wheelDelta?t.wheelDelta/120:0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"movementDelta",{get:function(){var t=this.event,e=null,r=null;if(this._isPointerLocked())e=t.movementX||t.webkitMovementX||t.mozMovementX||0,r=t.movementY||t.webkitMovementY||t.mozMovementY||0;else{var n=this.location,o=this.lastX,i=this.lastY;null===o&&null===i?(e=0,r=0):(e=n.x-o,r=n.y-i)}return{x:e,y:r}},enumerable:!0,configurable:!0}),r.prototype.copy=function(){var t=r.create(this.event,this.name);return this.copyMember(t,this,["target","currentTarget","isStopPropagation","phase","lastX","lastY"])},r.prototype._isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)},r}(t.DomEvent);t.MouseEvent=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},r={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},n=function(n){function o(){n.apply(this,arguments),this.p_type=t.EEventType.KEYBOARD,this.keyState=null}return __extends(o,n),o.create=function(t,e){var r=new this(t,e);return r},Object.defineProperty(o.prototype,"ctrlKey",{get:function(){return this.event.ctrlKey},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"altKey",{get:function(){return this.event.altKey},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"shiftKey",{get:function(){return this.event.shiftKey},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"metaKey",{get:function(){return this.event.metaKey},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"keyCode",{get:function(){return this.event.keyCode},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"key",{get:function(){var t=e[this.keyCode],n=null;return t?t:(n=String.fromCharCode(this.keyCode).toLowerCase(),this.shiftKey?r[n]:n)},enumerable:!0,configurable:!0}),o.prototype.copy=function(){var t=o.create(this.event,this.name);return this.copyMember(t,this,["target","currentTarget","isStopPropagation","phase","altKey","shiftKey","ctrlKey","metaKey","keyCode","key"])},o}(t.DomEvent);t.KeyboardEvent=n}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.userData=null,this.p_type=t.EEventType.CUSTOM}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.copyPublicAttri=function(e,r){return wdCb.ExtendUtils.extend(e,function(e,r){return"_"!==r.slice(0,1)&&!t.JudgeUtils.isFunction(e)}),e},r.prototype.copy=function(){var t=r.create(this.name);return this.copyMember(t,this,["target","currentTarget","isStopPropagation","phase"])},r.prototype.getDataFromDomEvent=function(t){this.target=t.target,this.currentTarget=t.currentTarget,this.isStopPropagation=t.isStopPropagation},r}(t.Event);t.CustomEvent=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.CENTER=2]="CENTER"}(t.EMouseButton||(t.EMouseButton={}));t.EMouseButton}(wd||(wd={}));var wd;!function(t){var e=function(){function t(t){this.eventType=null,this.priority=null,this.handlerDataList=wdCb.Collection.create(),this.eventType=t.eventType,this.priority=t.priority||1}return t.create=function(t){var e=new this(t);return e.initWhenCreate(t),e},t.prototype.initWhenCreate=function(t){this._setHandlerDataList(t)},t.prototype._setHandlerDataList=function(t){var e=null,r=/on\w+/;for(e in t)t.hasOwnProperty(e)&&r.test(e)&&this.handlerDataList.addChild({eventName:this._parseEventName(e),handler:t[e]})},t.prototype._parseEventName=function(t){return t.slice(2).toLowerCase()},t}();t.EventListener=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t}();t.EventHandler=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.prototype.off=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=this,o=t.DomEventRegister.getInstance(),i=null;i=o.remove.apply(o,e),i&&i.forEach(function(t){t.forEach(function(t){n._unBind(t.dom,t.eventName,t.domHandler)})})},r.prototype.trigger=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null,o=null,i=null,a=null;1===e.length?(o=e[0],n=this.getDefaultDom()):(n=e[0],o=e[1]),i=o.name,a=t.DomEventRegister.getInstance().getEventRegisterDataList(n,i),null!==a&&0!==a.getCount()&&a.forEach(function(t){var e=o.copy();t.handler(e,t.eventData)})},r.prototype.clearHandler=function(){},r.prototype.buildDomHandler=function(e,r){var n=this,o=t.root;return wdCb.EventUtils.bindEvent(o,function(t){n.triggerDomEvent(e,t,r)})},r.prototype.handler=function(e,r,n,o){var i=null,a=n;n=this.addEngineHandler(r,n),i=t.DomEventRegister.getInstance().isBinded(e,r)?t.DomEventRegister.getInstance().getDomHandler(e,r):this._bind(e,r),t.DomEventRegister.getInstance().register(e,r,this.createEventData(),n,a,i,o)},r.prototype._bind=function(e,r){var n=null;return n=this.buildDomHandler(e,r),wdCb.EventUtils.addEvent(e,t.EventNameHandler.handleEventName(r),n),n},r.prototype._unBind=function(e,r,n){wdCb.EventUtils.removeEvent(e,t.EventNameHandler.handleEventName(r),n)},__decorate([t.virtual],r.prototype,"clearHandler",null),r}(t.EventHandler);t.DomEventHandler=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.on=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=null,n=null,o=null,i=null;3===t.length?(r=this.getDefaultDom(),n=t[0],o=t[1],i=t[2]):(r=t[0],n=t[1],o=t[2],i=t[3]),this.handler(r,n,o,i)},r.prototype.getDefaultDom=function(){return document.body},r.prototype.triggerDomEvent=function(e,r,n){var o=this._createEventObject(e,r,n);t.EventManager.trigger(e,o)},r.prototype.addEngineHandler=function(e,r){var n=null;switch(e){case t.EEventName.MOUSEMOVE:n=this._handleMove(r);break;default:n=r}return n},r.prototype.createEventData=function(){var t=wdCb.Hash.create();return t.addChild("lastX",null),t.addChild("lastY",null),t},r.prototype._handleMove=function(t){var e=this;return function(r,n){e._copyEventDataToEventObject(r,n),t(r),e._saveLocation(r,n)}},r.prototype._createEventObject=function(e,r,n){var o=t.MouseEvent.create(r?r:t.root.event,n);return o.target=e,o},r.prototype._copyEventDataToEventObject=function(t,e){t.lastX=e.getChild("lastX"),t.lastY=e.getChild("lastY")},r.prototype._saveLocation=function(t,e){var r=t.location;e.addChild("lastX",r.x),e.addChild("lastY",r.y)},r._instance=null,__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(4===e.length){var n=e[0];t.assert(t.JudgeUtils.isDom(n),t.Log.info.FUNC_MUST_BE("first param","HTMLElement"))}})],r.prototype,"on",null),r}(t.DomEventHandler);t.MouseEventHandler=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.on=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null,o=null,i=null;3===e.length?(n=e[0],o=e[1],i=e[2]):(t.Log.warn("keyboard event can only bind on document.body"),n=e[1],o=e[2],i=e[3]),this.handler(this.getDefaultDom(),n,o,i)},r.prototype.triggerDomEvent=function(e,r,n){var o=this._createEventObject(e,r,n);t.EventManager.trigger(e,o)},r.prototype.getDefaultDom=function(){return document.body},r.prototype.addEngineHandler=function(e,r){var n=null;switch(e){case t.EEventName.KEYDOWN:n=this._handleKeyDown(r);break;case t.EEventName.KEYUP:n=this._handleKeyUp(r);break;default:n=r}return n},r.prototype.createEventData=function(){var t=wdCb.Hash.create();return t.addChild("keyState",{}),t},r.prototype._handleKeyDown=function(t){var e=this;return function(r,n){var o=n.getChild("keyState");e._setKeyStateAllFalse(o),o[r.key]=!0,e._copyEventDataToEventObject(r,n),t(r)}},r.prototype._handleKeyUp=function(t){var e=this;return function(r,n){e._setKeyStateAllFalse(n.getChild("keyState")),e._copyEventDataToEventObject(r,n),t(r)}},r.prototype._copyEventDataToEventObject=function(t,e){t.keyState=e.getChild("keyState")},r.prototype._setKeyStateAllFalse=function(t){for(var e in t)t.hasOwnProperty(e)&&(t[e]=!1)},r.prototype._createEventObject=function(e,r,n){var o=t.KeyboardEvent.create(r?r:t.root.event,n);return o.target=e,o},r._instance=null,r}(t.DomEventHandler);t.KeyboardEventHandler=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.on=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(3===e.length){var n=e[0],o=e[1],i=o,a=e[2];t.CustomEventRegister.getInstance().register(null,n,o,i,null,a)}else if(4===e.length){var s=e[0],n=e[1],o=e[2],i=o,a=e[3];t.CustomEventRegister.getInstance().register(s,n,o,i,null,a)}},r.prototype.off=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=t.CustomEventRegister.getInstance();n.remove.apply(n,e)},r.prototype.trigger=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=null;if(1===t.length||2===t.length){var n=null;return 1===t.length?r=t[0]:(r=t[0],n=t[1]),this._triggerEventHandler(r,n)}if(3===t.length||4===t.length){var o=null,n=null,i=null;return 3===t.length?(o=t[0],r=t[1],i=t[2]):(o=t[0],r=t[1],n=t[2],i=t[3]),this._triggerTargetAndEventHandler(o,r,n,i)}},r.prototype._triggerEventHandler=function(e,r){var n=null,o=this;return n=t.CustomEventRegister.getInstance().getEventRegisterDataList(e.name),null===n||0===n.getCount()?!1:(n.forEach(function(t){e.currentTarget=t.target,e.target=t.target,o._setUserData(e,r),t.handler(e)}),!0)},r.prototype._triggerTargetAndEventHandler=function(e,r,n,o){var i=null,a=!1,s=this;return o||(r.target=e),i=t.CustomEventRegister.getInstance().getEventRegisterDataList(e,r.name),null===i||0===i.getCount()?!1:(i.forEach(function(t){r.currentTarget=t.target,s._setUserData(r,n),t.handler(r),r.isStopPropagation&&(a=!0)}),a)},r.prototype._setUserData=function(t,e){e&&(t.userData=e)},r._instance=null,r}(t.EventHandler);t.CustomEventHandler=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t}();t.EventDispatcher=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.trigger=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=e.length;if(1===n){var o=e[0],i=o.type;return t.EventHandlerFactory.createEventHandler(i).trigger(o)}if(2===n&&t.EventUtils.isEvent(e[0])){var a=e[0],s=e[1],i=a.type;return t.EventHandlerFactory.createEventHandler(i).trigger(a,s)}if(2===n&&t.EventUtils.isEntityObject(e[0])||3===n&&t.JudgeUtils.isBoolean(e[2])){var c=e[0],u=e[1],l=void 0===e[2]?!1:e[2],i=u.type;return t.EventHandlerFactory.createEventHandler(i).trigger(c,u,l)}if(3===n||4===n){var c=e[0],h=e[1],s=e[2],l=void 0===e[3]?!1:e[3],i=h.type;return t.EventHandlerFactory.createEventHandler(i).trigger(c,h,s,l)}},r.prototype.emit=function(e,r,n){var o=!1;if(e){r.phase=t.EEventPhase.EMIT,r.target=e;do{if(o=this._triggerWithUserData(e,r,n,!0))break;e=e.bubbleParent}while(e)}},r.prototype.broadcast=function(e,r,n){var o=this,i=function(t){var e=t.getChildren();0!==e.getCount()&&e.forEach(function(t){o._triggerWithUserData(t,r,n,!0),i(t)})};e&&(r.phase=t.EEventPhase.BROADCAST,r.target=e,this._triggerWithUserData(e,r,n,!0),i(e))},r.prototype._triggerWithUserData=function(t,e,r,n){return r?this.trigger(t,e,r,n):this.trigger(t,e,n)},r._instance=null,r}(t.EventDispatcher);t.CustomEventDispatcher=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.trigger=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(1===e.length){var n=e[0],o=n.type;t.EventHandlerFactory.createEventHandler(o).trigger(n)}else if(2===e.length){var i=e[0],a=e[1],o=a.type;t.EventHandlerFactory.createEventHandler(o).trigger(i,a)}},r._instance=null,r}(t.EventDispatcher);t.DomEventDispatcher=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.listenerMap=t.ABSTRACT_ATTRIBUTE}return e.prototype.getEventRegisterDataList=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=this.listenerMap.getChild.apply(this.listenerMap,t);return r?r.sort(function(t,e){return e.priority-t.priority}):null},e.prototype.filter=function(t){return this.listenerMap.filter(t)},e.prototype.forEach=function(t){return this.listenerMap.forEach(t)},e.prototype.getChild=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.listenerMap.getChild.apply(this.listenerMap,Array.prototype.slice.call(arguments,0))},e.prototype.getEventNameFromKey=function(t){return this.listenerMap.getEventNameFromKey(t)},e}();t.EventRegister=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.listenerMap=t.CustomEventListenerMap.create()}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.register=function(t,e,r,n,o,i){this.listenerMap.appendChild(t,e,{target:t,eventName:e,handler:r,originHandler:n,domHandler:o,priority:i})},r.prototype.remove=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=e[0];if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];this.listenerMap.removeChild(o)}else if(1===e.length&&e[0]instanceof t.EntityObject)this.listenerMap.removeChild(n),this._handleAfterAllEventHandlerRemoved(n);else if(2===e.length&&t.JudgeUtils.isFunction(e[1])){var o=e[0],i=e[1];this.listenerMap.removeChild(o,i)}else if(2===e.length&&t.JudgeUtils.isNumber(e[0])){var a=e[0],o=e[1];this.listenerMap.removeChild(a,o)}else(2===e.length&&e[0]instanceof t.EntityObject||3===e.length)&&(this.listenerMap.removeChild.apply(this.listenerMap,e),this._isAllEventHandlerRemoved(n)&&this._handleAfterAllEventHandlerRemoved(n))},r.prototype.setBubbleParent=function(t,e){t.bubbleParent=e},r.prototype.getUidFromKey=function(t){return this.listenerMap.getUidFromKey(t)},r.prototype.isTarget=function(t,e,r){return this.listenerMap.isTarget(t,e,r)},r.prototype._isAllEventHandlerRemoved=function(t){return!this.listenerMap.hasChildWithFunc(function(e,r){return r.indexOf(String(t.uid))>-1&&e&&e.getCount()>0})},r.prototype._handleAfterAllEventHandlerRemoved=function(t){this.setBubbleParent(t,null)},r._instance=null,r}(t.EventRegister);t.CustomEventRegister=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.listenerMap=t.DomEventListenerMap.create()}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.register=function(t,e,r,n,o,i,a){this.listenerMap.appendChild(t,e,{dom:t,eventName:e,eventData:r,handler:n,originHandler:o,domHandler:i,priority:a})},r.prototype.remove=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null;if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];n=this.listenerMap.removeChild(o)}else if(2===e.length&&t.JudgeUtils.isFunction(e[1])){var o=e[0],i=e[1];n=this.listenerMap.removeChild(o,i)}else(2===e.length&&t.JudgeUtils.isDom(e[0])||3===e.length)&&(n=this.listenerMap.removeChild.apply(this.listenerMap,e));return n},r.prototype.isBinded=function(t,e){return this.listenerMap.hasChild(t,e)},r.prototype.isDom=function(t,e,r){return this.listenerMap.isDom(t,e,r)},r.prototype.getDomHandler=function(t,e){var r=this.getChild(t,e);return r&&r.getCount()>0?r.getChild(0).domHandler:void 0},r._instance=null,r}(t.EventRegister);t.DomEventRegister=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t}();t.EventBinder=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;
if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.on=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(2===e.length){var n=e[0],o=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(n)).on(n,o)}else if(3===e.length&&t.JudgeUtils.isString(e[0])){var n=e[0],o=e[1],i=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(n)).on(n,o,i)}else if(3===e.length&&e[0]instanceof t.EntityObject){var a=e[0],n=e[1],o=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(n)).on(a,n,o)}else if(4===e.length){var a=e[0],n=e[1],o=e[2],i=e[3];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(n)).on(a,n,o,i)}},r.prototype.off=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=t.CustomEventRegister.getInstance();if(0===e.length)n.forEach(function(e,r){var o=n.getEventNameFromKey(r),i=n.getUidFromKey(r);i?t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(i,o):t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(o)});else if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];n.forEach(function(e,r){var i=n.getEventNameFromKey(r);i===o&&t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(o)})}else if(1===e.length&&e[0]instanceof t.EntityObject){var i=e[0];n.forEach(function(e,r){var o=n.getEventNameFromKey(r);n.isTarget(r,i,e)&&t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(i,o)})}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var a=e[0],s=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(a,s)}else if(2===e.length&&e[0]instanceof t.EntityObject){var c=e[0],a=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(c,a)}else if(3===e.length&&e[0]instanceof t.EntityObject){var c=e[0],a=e[1],s=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(c,a,s)}},r.prototype._checkEventSeparator=function(e){t.assert(-1===e.indexOf(t.CustomEventListenerMap.eventSeparator),t.Log.info.FUNC_SHOULD_NOT("eventName","contain "+t.CustomEventListenerMap.eventSeparator))},r._instance=null,__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(1===e.length);else if(2===e.length){var n=e[0];this._checkEventSeparator(n)}else if(3===e.length&&t.JudgeUtils.isString(e[0])){var n=e[0];this._checkEventSeparator(n)}else if(3===e.length&&e[0]instanceof t.EntityObject){var n=e[1];this._checkEventSeparator(n)}else if(4===e.length){var n=e[1];this._checkEventSeparator(n)}})],r.prototype,"on",null),r}(t.EventBinder);t.CustomEventBinder=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.on=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(1===e.length){var n=e[0]instanceof t.EventListener?e[0]:t.EventListener.create(e[0]);n.handlerDataList.forEach(function(e){t.EventHandlerFactory.createEventHandler(n.eventType).on(e.eventName,e.handler,n.priority)})}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0],i=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).on(o,i)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var a=e[0],s=e[0]instanceof t.EventListener?e[0]:t.EventListener.create(e[0]);s.handlerDataList.forEach(function(e){t.EventHandlerFactory.createEventHandler(s.eventType).on(a,e.eventName,e.handler,s.priority)})}else if(3===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0],i=e[1],c=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).on(o,i,c)}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var u=e[0],o=e[1],i=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).on(u,o,i)}else if(4===e.length){var u=e[0],o=e[1],i=e[2],c=e[3];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).on(u,o,i,c)}},r.prototype.off=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=t.DomEventRegister.getInstance();if(0===e.length)n.forEach(function(e,r){var o=n.getEventNameFromKey(r);t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(o)});else if(1===e.length&&t.JudgeUtils.isString(e[0])){var o=e[0];n.forEach(function(e,r){var i=n.getEventNameFromKey(r);i===o&&t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(o)})}else if(1===e.length&&t.JudgeUtils.isDom(e[0])){var i=e[0];n.forEach(function(e,r){var o=n.getEventNameFromKey(r);n.isDom(r,i,e)&&t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(o)).off(i,o)})}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var a=e[0],s=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(a,s)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var c=e[0],a=e[1];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(c,a)}else if(3===e.length){var c=e[0],a=e[1],s=e[2];t.EventHandlerFactory.createEventHandler(t.EventTable.getEventType(a)).off(c,a,s)}},r.prototype._checkEventSeparator=function(e){t.assert(-1===e.indexOf(t.DomEventListenerMap.eventSeparator),t.Log.info.FUNC_SHOULD_NOT("eventName","contain "+t.DomEventListenerMap.eventSeparator))},r._instance=null,__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(1===e.length);else if(2===e.length);else if(3===e.length&&t.JudgeUtils.isString(e[0])){var n=e[0];this._checkEventSeparator(n)}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var n=e[1];this._checkEventSeparator(n)}else if(4===e.length){var n=e[1];this._checkEventSeparator(n)}})],r.prototype,"on",null),r}(t.EventBinder);t.DomEventBinder=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.createEventHandler=function(e){var r=null;switch(e){case t.EEventType.MOUSE:r=t.MouseEventHandler.getInstance();break;case t.EEventType.KEYBOARD:r=t.KeyboardEventHandler.getInstance();break;case t.EEventType.CUSTOM:r=t.CustomEventHandler.getInstance();break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("eventType"))}return r},e}();t.EventHandlerFactory=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.createEventBinder=function(e){var r=null,n=t.EventTable.getEventType(e);switch(n){case t.EEventType.MOUSE:case t.EEventType.KEYBOARD:r=t.DomEventBinder.getInstance();break;case t.EEventType.CUSTOM:r=t.CustomEventBinder.getInstance();break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("eventName:"+e))}return r},e}();t.EventBinderFactory=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.createEventDispatcher=function(e){var r=null,n=e.type;switch(n){case t.EEventType.MOUSE:case t.EEventType.KEYBOARD:r=t.DomEventDispatcher.getInstance();break;case t.EEventType.CUSTOM:r=t.CustomEventDispatcher.getInstance();break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("event:"+e))}return r},e}();t.EventDispatcherFactory=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.isEvent=function(t){return t&&void 0!==t.currentTarget},t.isEntityObject=function(t){return t&&void 0!==t.scriptList},t}();t.EventUtils=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){}return e.on=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(1===e.length){var n=e[0],o=t.DomEventBinder.getInstance();o.on(n)}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0],a=e[1],s=1,o=t.EventBinderFactory.createEventBinder(i);o.on(i,a,s)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var c=e[0],n=e[1],o=t.DomEventBinder.getInstance();o.on(c,n)}else if(3===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0],a=e[1],s=e[2],o=t.EventBinderFactory.createEventBinder(i);o.on(i,a,s)}else if(3===e.length&&e[0]instanceof t.EntityObject){var u=e[0],i=e[1],a=e[2],s=1,o=t.CustomEventBinder.getInstance();o.on(u,i,a,s)}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var c=e[0],i=e[1],a=e[2],s=1,o=t.DomEventBinder.getInstance();o.on(c,i,a,s)}else if(4===e.length&&e[0]instanceof t.EntityObject){var u=e[0],i=e[1],a=e[2],s=e[3],o=t.CustomEventBinder.getInstance();o.on(u,i,a,s)}else if(4===e.length&&t.JudgeUtils.isDom(e[0])){var c=e[0],i=e[1],a=e[2],s=e[3],o=t.DomEventBinder.getInstance();o.on(c,i,a,s)}},e.off=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(0===e.length){var n=t.CustomEventBinder.getInstance(),o=t.DomEventBinder.getInstance();n.off(),o.off()}else if(1===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0],a=t.EventBinderFactory.createEventBinder(i);a.off(i)}else if(1===e.length&&e[0]instanceof t.EntityObject){var i=e[0],a=t.CustomEventBinder.getInstance();a.off(i)}else if(1===e.length&&t.JudgeUtils.isDom(e[0])){var i=e[0],a=t.DomEventBinder.getInstance();a.off(i)}else if(2===e.length&&t.JudgeUtils.isString(e[0])){var i=e[0],s=e[1],a=t.EventBinderFactory.createEventBinder(i);a.off(i,s)}else if(2===e.length&&e[0]instanceof t.EntityObject){var c=e[0],i=e[1],a=t.CustomEventBinder.getInstance();a.off(c,i)}else if(2===e.length&&t.JudgeUtils.isDom(e[0])){var u=e[0],i=e[1],a=t.DomEventBinder.getInstance();a.off(u,i)}else if(3===e.length&&e[0]instanceof t.EntityObject){var c=e[0],i=e[1],s=e[2],a=t.CustomEventBinder.getInstance();a.off(c,i,s)}else if(3===e.length&&t.JudgeUtils.isDom(e[0])){var u=e[0],i=e[1],s=e[2],a=t.DomEventBinder.getInstance();a.off(u,i,s)}},e.trigger=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=e.length;if(1===n){var o=e[0],i=t.EventDispatcherFactory.createEventDispatcher(o);i.trigger(o)}else if(2===n&&t.EventUtils.isEvent(e[0])){var a=e[0],s=e[1],i=t.CustomEventDispatcher.getInstance();i.trigger(a,s)}else if(2===n&&t.EventUtils.isEntityObject(e[0])){var c=e[0],u=e[1],i=t.CustomEventDispatcher.getInstance();if(!c)return;i.trigger(c,u)}else if(2===n){var l=e[0],h=e[1],i=t.DomEventDispatcher.getInstance();if(!l)return;i.trigger(l,h)}else if(3===n){var c=e[0],p=e[1],s=e[2],i=t.CustomEventDispatcher.getInstance();if(!c)return;i.trigger(c,p,s)}else if(4===n){var c=e[0],f=e[1],s=e[2],d=e[3],i=t.CustomEventDispatcher.getInstance();if(!c)return;i.trigger(c,f,s,d)}},e.broadcast=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=t.CustomEventDispatcher.getInstance();n.broadcast.apply(n,e)},e.emit=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=t.CustomEventDispatcher.getInstance();n.emit.apply(n,e)},e.fromEvent=function(){for(var r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];var o=null,i=null;if(1===r.length){var a=r[0];o=function(t){e.on(a,t)},i=function(t){e.off(a,t)}}else if(2===r.length&&t.JudgeUtils.isNumber(r[1])){var s=r[0],c=r[1];o=function(t){e.on(s,t,c)},i=function(t){e.off(s,t)}}else if(2===r.length){var u=r[1];o=function(t){e.on(r[0],u,t)},i=function(t){e.off(r[0],u,t)}}else if(3===r.length){var l=r[1],h=r[2];o=function(t){e.on(r[0],l,t,h)},i=function(t){e.off(r[0],l,t)}}return wdFrp.fromEventPattern(o,i)},e.setBubbleParent=function(e,r){t.CustomEventRegister.getInstance().setBubbleParent(e,r)},__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(e[0]instanceof t.EntityObject){var n=e[1];t.assert(t.EventTable.getEventType(n)===t.EEventType.CUSTOM,t.Log.info.FUNC_MUST_BE("event","custom event"))}else if(t.JudgeUtils.isDom(e[0])){var n=e[1],o=t.EventTable.getEventType(n);t.assert(o===t.EEventType.MOUSE||o===t.EEventType.KEYBOARD,t.Log.info.FUNC_MUST_BE("event","dom event"))}})],e,"on",null),__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(e.length>2&&e[0]instanceof t.EntityObject){var n=e[1];t.assert(t.EventTable.getEventType(n)===t.EEventType.CUSTOM,t.Log.info.FUNC_MUST_BE("event","custom event"))}else if(e.length>2&&t.JudgeUtils.isDom(e[0])){var n=e[1],o=t.EventTable.getEventType(n);t.assert(o===t.EEventType.MOUSE||o===t.EEventType.KEYBOARD,t.Log.info.FUNC_MUST_BE("event","dom event"))}})],e,"off",null),__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(2===e.length&&e[0]instanceof t.Event){var n=e[0];t.assert(n instanceof t.CustomEvent,t.Log.info.FUNC_MUST_BE("event type","CUSTOM"))}else if(2===e.length&&e[0]instanceof t.EntityObject);else if(2===e.length)e[0]&&t.assert(t.JudgeUtils.isDom(e[0]),t.Log.info.FUNC_MUST_BE("the first param","dom"));else if(e[0]instanceof t.EntityObject){var o=e[1];t.assert(o instanceof t.CustomEvent,t.Log.info.FUNC_MUST_BE("event type","CUSTOM"))}})],e,"trigger",null),__decorate([t.require(function(e,r,n){t.assert(r instanceof t.CustomEvent,t.Log.info.FUNC_MUST_BE("eventObject","CustomEvent"))})],e,"broadcast",null),__decorate([t.require(function(e,r,n){t.assert(r instanceof t.CustomEvent,t.Log.info.FUNC_MUST_BE("eventObject","CustomEvent"))})],e,"emit",null),__decorate([t.require(function(e,r){t.assert(e instanceof t.EntityObject,"only EntityObject can setBubleParent")})],e,"setBubbleParent",null),e}();t.EventManager=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.STARTLOOP="wd_startLoop"]="STARTLOOP",t[t.ENDLOOP="wd_endLoop"]="ENDLOOP",t[t.BEFORE_GAMEOBJECT_INIT="wd_beforeGameObjectInit"]="BEFORE_GAMEOBJECT_INIT",t[t.AFTER_GAMEOBJECT_INIT="wd_afterGameObjectInit"]="AFTER_GAMEOBJECT_INIT",t[t.AFTER_GAMEOBJECT_INIT_RIGIDBODY_ADD_CONSTRAINT="wd_afterGameObjectInit_rigidBowd_addConstraint"]="AFTER_GAMEOBJECT_INIT_RIGIDBODY_ADD_CONSTRAINT",t[t.MOUSE_CLICK="wd_mouseclick"]="MOUSE_CLICK",t[t.MOUSE_DOWN="wd_mousedown"]="MOUSE_DOWN",t[t.MOUSE_UP="wd_mouseup"]="MOUSE_UP",t[t.MOUSE_MOVE="wd_mousemove"]="MOUSE_MOVE",t[t.MOUSE_OVER="wd_mouseover"]="MOUSE_OVER",t[t.MOUSE_OUT="wd_mouseout"]="MOUSE_OUT",t[t.MOUSE_WHEEL="wd_mousewheel"]="MOUSE_WHEEL",t[t.MOUSE_DRAG="wd_mousedrag"]="MOUSE_DRAG",t[t.MATERIAL_CHANGE="wd_material_change"]="MATERIAL_CHANGE",t[t.MATERIAL_COLOR_CHANGE="wd_material_color_change"]="MATERIAL_COLOR_CHANGE",t[t.UI_WIDTH_CHANGE="wd_ui_width_change"]="UI_WIDTH_CHANGE",t[t.UI_HEIGHT_CHANGE="wd_ui_height_change"]="UI_HEIGHT_CHANGE",t[t.TRANSFORM_TRANSLATE="wd_transform_translate"]="TRANSFORM_TRANSLATE",t[t.TRANSFORM_ROTATE="wd_transform_rotate"]="TRANSFORM_ROTATE",t[t.TRANSFORM_SCALE="wd_transform_scale"]="TRANSFORM_SCALE",t[t.SHADOWMAP_SOFTTYPE_CHANGE="wd_shadowMap_softType_change"]="SHADOWMAP_SOFTTYPE_CHANGE",t[t.COMPONENT_CHANGE="wd_component_change"]="COMPONENT_CHANGE"}(t.EEngineEvent||(t.EEngineEvent={}));t.EEngineEvent}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.activeGeometry=null,this._levelList=wdCb.Collection.create(),this._originGeometry=null}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.init=function(){var r=this.entityObject;this.activeGeometry=r.getComponent(t.Geometry),this._originGeometry=this.activeGeometry,this._levelList.filter(function(t){var e=t.geometry;t.distanceBetweenCameraAndObject;return!!e}).forEach(function(t){var e=t.geometry;t.distanceBetweenCameraAndObject;e.entityObject=r,e.init(),e.createBuffersFromGeometryData()}),e.prototype.init.call(this)},r.prototype.addGeometryLevel=function(t,e){this._levelList.addChild({distanceBetweenCameraAndObject:t,geometry:e}),this._levelList.sort(function(t,e){return e.distanceBetweenCameraAndObject-t.distanceBetweenCameraAndObject},!0)},r.prototype.update=function(e){var r=t.Vector3.create().sub2(t.Director.getInstance().scene.currentCamera.transform.position,this.entityObject.transform.position).length(),n=!0,o=null;return this._levelList.forEach(function(t){var e=t.geometry,i=t.distanceBetweenCameraAndObject;return r>=i?(o=e,n=!1,wdCb.$BREAK):void 0}),o===t.ELODGeometryState.INVISIBLE?(this.activeGeometry=null,void(this.entityObject.isVisible=!1)):(this.entityObject.isVisible=!0,void(o&&!t.JudgeUtils.isEqual(o,this.activeGeometry)?(this.activeGeometry=o,t.EventManager.trigger(this.entityObject,t.CustomEvent.create(t.EEngineEvent.COMPONENT_CHANGE))):n&&(this.activeGeometry=this._originGeometry)))},r}(t.Component);t.LODController=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.INVISIBLE=0]="INVISIBLE"}(t.ELODGeometryState||(t.ELODGeometryState={}));t.ELODGeometryState}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.Component);t.EventTriggerDetector=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.isTrigger=function(e){var r=this.entityObject.transform,n=r.width,o=r.height,i=r.position,a=e.locationInView,s=null;return s=t.Vector2.create(i.x-n/2,i.y-o/2),t.EventTriggerDetectorUtils.isInRect(a,s,n,o)},r}(t.EventTriggerDetector);t.UIEventTriggerDetector=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.isTrigger=function(e){var r=t.Director.getInstance().scene,n=r.currentCamera.getComponent(t.CameraController),o=e.locationInView;return n.isIntersectWithRay(this.entityObject,o.x,o.y)},r}(t.EventTriggerDetector);t.RayCasterEventTriggerDetector=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.isTrigger=function(e){var r=t.DeviceManager.getInstance().view,n=r.width,o=r.height,i=e.locationInView,a=t.Vector2.create(0,0);return t.EventTriggerDetectorUtils.isInRect(i,a,n,o)},r}(t.EventTriggerDetector);t.SceneEventTriggerDetector=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.isInRect=function(t,e,r,n){return t.x>=e.x&&t.x<=e.x+r&&t.y>=e.y&&t.y<=e.y+n},t}();t.EventTriggerDetectorUtils=e}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create(),r=wdCb.Hash.create();e.addChild(t.EEventName.CLICK,"onMouseClick"),e.addChild(t.EEventName.MOUSEOVER,"onMouseOver"),e.addChild(t.EEventName.MOUSEOUT,"onMouseOut"),e.addChild(t.EEventName.MOUSEMOVE,"onMouseMove"),e.addChild(t.EEventName.MOUSEDOWN,"onMouseDown"),e.addChild(t.EEventName.MOUSEUP,"onMouseUp"),e.addChild(t.EEventName.MOUSEWHEEL,"onMouseWheel"),e.addChild(t.EEventName.MOUSEDRAG,"onMouseDrag"),r.addChild(t.EEventName.CLICK,"MOUSE_CLICK"),r.addChild(t.EEventName.MOUSEDOWN,"MOUSE_DOWN"),r.addChild(t.EEventName.MOUSEUP,"MOUSE_UP"),r.addChild(t.EEventName.MOUSEMOVE,"MOUSE_MOVE"),r.addChild(t.EEventName.MOUSEOVER,"MOUSE_OVER"),r.addChild(t.EEventName.MOUSEOUT,"MOUSE_OUT"),r.addChild(t.EEventName.MOUSEWHEEL,"MOUSE_WHEEL"),r.addChild(t.EEventName.MOUSEDRAG,"MOUSE_DRAG");var n=function(){function t(){}return t.getScriptHandlerName=function(t){var r=e.getChild(t);return r},t.getScriptEngineEvent=function(t){var e=r.getChild(t);return e},t}();t.EventTriggerTable=n}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(t){void 0===t&&(t=null),e.call(this),this.url=null,this.url=t}return __extends(r,e),r.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(0===t.length)return new this;if(1===t.length){var r=t[0];return new this(r)}},r.addScript=function(t,e){this.scriptList.push({name:t,"class":e})},r.prototype.createLoadJsStream=function(){return t.Log.error(!this.url,t.Log.info.FUNC_MUST_DEFINE("url")),t.LoaderManager.getInstance().load(this.url).map(function(){return r.scriptList.pop()})},r.prototype.addToObject=function(t){var r=this;e.prototype.addToObject.call(this,t),this.createLoadJsStream().subscribe(function(e){r._handlerAfterLoadedScript(e,t)})},r.prototype._handlerAfterLoadedScript=function(e,r){this._addScriptToEntityObject(r,e),r.execScript("onEnter",null,!0),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.BEFORE_GAMEOBJECT_INIT)),r.execScript("init",null,!0),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.AFTER_GAMEOBJECT_INIT)),t.EventManager.trigger(t.CustomEvent.create(t.EEngineEvent.AFTER_GAMEOBJECT_INIT_RIGIDBODY_ADD_CONSTRAINT))},r.prototype._addScriptToEntityObject=function(t,e){t.scriptList.addChild(e.name,new e["class"](t))},r.scriptList=wdCb.Stack.create(),r}(t.Component);t.Script=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.p_parent=null,this._isTranslate=!1,this._isRotate=!1,this._isScale=!1,this.dirtyLocal=!0,this.children=wdCb.Collection.create()}return __extends(r,e),Object.defineProperty(r.prototype,"parent",{get:function(){return this.p_parent},set:function(t){this.setParent(t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isTransform",{get:function(){return this.isTranslate||this.isRotate||this.isScale},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isTranslate",{get:function(){return this._isTranslate},set:function(e){this._setGlobalTransformState(t.ETransformState.ISTRANSLATE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isRotate",{get:function(){return this._isRotate},set:function(e){this._setGlobalTransformState(t.ETransformState.ISROTATE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isScale",{get:function(){return this._isScale},set:function(e){this._setGlobalTransformState(t.ETransformState.ISSCALE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isLocalTranslate",{set:function(e){this._setLocalTransformState(t.ETransformState.ISLOCALTRANSLATE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isLocalRotate",{set:function(e){this._setLocalTransformState(t.ETransformState.ISLOCALROTATE,e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isLocalScale",{set:function(e){this._setLocalTransformState(t.ETransformState.ISLOCALSCALE,e)},enumerable:!0,configurable:!0}),r.prototype.addChild=function(t){this.children.addChild(t)},r.prototype.removeChild=function(t){this.children.removeChild(t)},r.prototype.setChildrenTransformState=function(t,e){e&&this.children.forEach(function(e){e[t]=!0})},r.prototype.handleWhenSetTransformState=function(t){},r.prototype.setParent=function(t){return this.p_parent&&this.p_parent.removeChild(this),t?(this.p_parent=t,void this.p_parent.addChild(this)):void(this.p_parent=null)},r.prototype.getMatrix=function(t,e){var r=wdCb.Collection.create(),n=this.p_parent;for(r.addChild(this);null!==n;)r.addChild(n),n=n.parent;return r.reverse().forEach(function(e){e[t]()}),this[e]},r.prototype._setGlobalTransformState=function(t,e){this["_"+t]=e,e&&(this.dirtyLocal=!0,this.clearCache(),this.handleWhenSetTransformState(t)),e&&this.setChildrenTransformState(t,e)},r.prototype._setLocalTransformState=function(t,e){e&&(this.dirtyLocal=!0,this.clearCache()),e&&this.setChildrenTransformState(t,e)},__decorate([t.virtual],r.prototype,"handleWhenSetTransformState",null),r}(t.Component);t.Transform=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._localToWorldMatrix=null,this._position=t.Vector3.create(),this._rotation=t.Quaternion.create(0,0,0,1),this._scale=t.Vector3.create(1,1,1),this._eulerAngles=null,this._localPosition=t.Vector3.create(0,0,0),this._localRotation=t.Quaternion.create(0,0,0,1),this._localEulerAngles=null,this._localScale=t.Vector3.create(1,1,1),this.dirtyWorld=null,this._localToParentMatrix=t.Matrix4.create(),this._endLoopSubscription=null,this._localToWorldMatrixCache=null,this._positionCache=null,this._rotationCache=null,this._scaleCache=null,this._eulerAnglesCache=null,this._localEulerAnglesCache=null}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"localToWorldMatrix",{get:function(){return this.getMatrix("sync","_localToWorldMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"position",{get:function(){return this._position=this.localToWorldMatrix.getTranslation(),this._position},set:function(t){null===this.p_parent?this._localPosition=t.copy():this._localPosition=this.p_parent.localToWorldMatrix.copy().invert().multiplyPoint(t),this.isTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rotation",{get:function(){return this._rotation.setFromMatrix(this.localToWorldMatrix),this._rotation},set:function(t){null===this.p_parent?this._localRotation=t.copy():this._localRotation=this.p_parent.rotation.copy().invert().multiply(t),this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scale",{get:function(){return this._scale=this.localToWorldMatrix.getScale(),this._scale},set:function(t){null===this.p_parent?this._localScale=t.copy():this._localScale=this.p_parent.localToWorldMatrix.copy().invert().multiplyVector3(t),this.isScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"eulerAngles",{get:function(){return this._eulerAngles=this.localToWorldMatrix.getEulerAngles(),this._eulerAngles},set:function(t){this._localRotation.setFromEulerAngles(t),null!==this.p_parent&&(this._localRotation=this.p_parent.rotation.copy().invert().multiply(this._localRotation)),this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"localPosition",{get:function(){return this._localPosition},set:function(t){this._localPosition=t.copy(),this.isLocalTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"localRotation",{get:function(){return this._localRotation},set:function(t){this._localRotation=t.copy(),this.isLocalRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"localEulerAngles",{get:function(){return this._localEulerAngles=this._localRotation.getEulerAngles(),this._localEulerAngles},set:function(t){this._localRotation.setFromEulerAngles(t),this.isLocalRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"localScale",{get:function(){return this._localScale},set:function(t){this._localScale=t.copy(),this.isLocalScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"up",{get:function(){return this.localToWorldMatrix.getY().normalize()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this.localToWorldMatrix.getX().normalize()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"forward",{get:function(){return this.localToWorldMatrix.getZ().normalize().scale(-1)},enumerable:!0,configurable:!0}),r.prototype.init=function(){var e=this;this._endLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.ENDLOOP).subscribe(function(){e._resetTransformFlag()})},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._endLoopSubscription&&this._endLoopSubscription.dispose()},r.prototype.sync=function(){this.dirtyLocal&&(this._localToParentMatrix.setTRS(this._localPosition,this._localRotation,this._localScale),this.dirtyLocal=!1,this.dirtyWorld=!0),this.dirtyWorld&&(null===this.p_parent?this._localToWorldMatrix=this._localToParentMatrix.copy():this._localToWorldMatrix=this.p_parent.localToWorldMatrix.copy().multiply(this._localToParentMatrix),this.dirtyWorld=!1,this.children.forEach(function(t){t.dirtyWorld=!0}))},r.prototype.translateLocal=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null;return n=3===e.length?t.Vector3.create(e[0],e[1],e[2]):e[0],this._localPosition=this._localPosition.add(this._localRotation.multiplyVector3(n)),this.isTranslate=!0,this},r.prototype.translate=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null;return n=3===e.length?t.Vector3.create(e[0],e[1],e[2]):e[0],this.position=n.add(this.position),this},r.prototype.rotate=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null,o=t.Quaternion.create();return n=3===e.length?t.Vector3.create(e[0],e[1],e[2]):e[0],o.setFromEulerAngles(n),null===this.p_parent?this._localRotation=o.multiply(this._localRotation):(o=this.p_parent.rotation.copy().invert().multiply(o),this._localRotation=o.multiply(this.rotation)),this.isRotate=!0,this},r.prototype.rotateLocal=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null,o=t.Quaternion.create();return n=3===e.length?t.Vector3.create(e[0],e[1],e[2]):e[0],o.setFromEulerAngles(n),this._localRotation.multiply(o),this.isRotate=!0,this},r.prototype.rotateAround=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];
var n=null,o=null,i=null,a=null,s=null;return 3===e.length?(n=e[0],o=e[1],i=e[2]):(n=e[0],o=t.Vector3.create(e[1],e[2],e[3]),i=t.Vector3.create(e[4],e[5],e[6])),a=t.Quaternion.create().setFromAxisAngle(n,i),s=this.position.copy().sub(o),s=a.multiplyVector3(s),this.position=o.add(s),this.rotation=a.multiply(this.rotation),this},r.prototype.lookAt=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null,o=null;return 1===e.length?(n=e[0],o=t.Vector3.up):2===e.length?(n=e[0],o=e[1]):3===e.length?(n=t.Vector3.create(e[0],e[1],e[2]),o=t.Vector3.up):(n=t.Vector3.create(e[0],e[1],e[2]),o=t.Vector3.create(e[3],e[4],e[5])),this.rotation=t.Quaternion.create().setFromMatrix(t.Matrix4.create().setLookAt(this.position,n,o)),this},r.prototype.clearCache=function(){this._localToWorldMatrixCache=null,this._positionCache=null,this._rotationCache=null,this._scaleCache=null,this._eulerAnglesCache=null,this._localEulerAnglesCache=null},r.prototype.handleWhenSetTransformState=function(e){var r=null;switch(e){case t.ETransformState.ISTRANSLATE:r=t.EEngineEvent.TRANSFORM_TRANSLATE;break;case t.ETransformState.ISROTATE:r=t.EEngineEvent.TRANSFORM_ROTATE;break;case t.ETransformState.ISSCALE:r=t.EEngineEvent.TRANSFORM_SCALE;break;default:t.Log.error(!0,t.Log.info.FUNC_UNKNOW("transformState:"+e))}t.EventManager.trigger(this.entityObject,t.CustomEvent.create(r))},r.prototype._resetTransformFlag=function(){this.isTranslate=!1,this.isScale=!1,this.isRotate=!1},__decorate([t.cacheGetter(function(){return null!==this._localToWorldMatrixCache},function(){return this._localToWorldMatrixCache},function(t){this._localToWorldMatrixCache=t})],r.prototype,"localToWorldMatrix",null),__decorate([t.cacheGetter(function(){return null!==this._positionCache},function(){return this._positionCache},function(t){this._positionCache=t})],r.prototype,"position",null),__decorate([t.cacheGetter(function(){return null!==this._rotationCache},function(){return this._rotationCache},function(t){this._rotationCache=t})],r.prototype,"rotation",null),__decorate([t.cacheGetter(function(){return null!==this._scaleCache},function(){return this._scaleCache},function(t){this._scaleCache=t})],r.prototype,"scale",null),__decorate([t.cacheGetter(function(){return null!==this._eulerAnglesCache},function(){return this._eulerAnglesCache},function(t){this._eulerAnglesCache=t})],r.prototype,"eulerAngles",null),__decorate([t.cacheGetter(function(){return null!==this._localEulerAnglesCache},function(){return this._localEulerAnglesCache},function(t){this._localEulerAnglesCache=t})],r.prototype,"localEulerAngles",null),r}(t.Transform);t.ThreeDTransform=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._rotationMatrix=null,this._localPositionAndScaleMatrix=t.Matrix3.create(),this._position=t.Vector2.create(),this._rotation=0,this._scale=t.Vector2.create(1,1),this._localPosition=t.Vector2.create(0,0),this._localScale=t.Vector2.create(1,1),this._anchorX=t.Vector2.create(.5,.5),this._anchorY=t.Vector2.create(.5,.5),this._width=null,this._height=null,this.dirtyRotation=!0,this.dirtyPositionAndScale=!0,this.pivot=t.Vector2.create(0,0),this.zIndex=1,this._localRotationMatrix=t.Matrix3.create(),this._localToParentMatrix=t.Matrix3.create(),this._rotationMatrixCache=null,this._localPositionAndScaleMatrixCache=null}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"rotationMatrix",{get:function(){return this.getMatrix("syncRotation","_rotationMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"localPositionAndScaleMatrix",{get:function(){return this.getMatrix("syncPositionAndScale","_localPositionAndScaleMatrix")},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"position",{get:function(){return this._position=this.localPositionAndScaleMatrix.getTranslation(),this._position},set:function(t){null===this.p_parent?this._localPosition=t.copy():this._localPosition=this.p_parent.localPositionAndScaleMatrix.copy().invert().multiplyPoint(t),this.isTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rotation",{get:function(){return this._rotation=this.rotationMatrix.getRotation(),this._rotation},set:function(t){this.resetRotation(),this.rotate(t),this.dirtyRotation=!0,this.isRotate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scale",{get:function(){return this._scale=this.localPositionAndScaleMatrix.getScale(),this._scale},set:function(t){null===this.p_parent?this._localScale=t.copy():this._localScale=this.p_parent.localPositionAndScaleMatrix.copy().invert().multiplyVector2(t),this.isScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"localPosition",{get:function(){return this._localPosition},set:function(t){this._localPosition=t.copy(),this.isLocalTranslate=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"localScale",{get:function(){return this._localScale},set:function(t){this._localScale=t.copy(),this.isLocalScale=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"anchorX",{get:function(){return this._anchorX},set:function(e){var r=null;if(this._anchorX=e,e.x===e.y){var n=(e.x-.5)*this._getParentWidth();return void(this.position=t.Vector2.create(this._getParentPosition().x+n,this.position.y))}r=this._getParentWidth(),this.position=t.Vector2.create(this._getParentPosition().x+(e.x+e.y-1)/2*r,this.position.y),this.width=r/this._getParentScale().x*(e.y-e.x)*this.scale.x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"anchorY",{get:function(){return this._anchorY},set:function(e){var r=null;if(this._anchorY=e,e.x===e.y){var n=(e.x-.5)*this._getParentHeight();return void(this.position=t.Vector2.create(this.position.x,this._getParentPosition().y+n))}r=this._getParentHeight(),this.position=t.Vector2.create(this.position.x,this._getParentPosition().y+(e.x+e.y-1)/2*r),this.height=r/this._getParentScale().y*(e.y-e.x)*this.scale.y},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"width",{get:function(){return this._width*this.scale.x},set:function(e){e!==this._width&&(this._width=e,this.entityObject&&t.EventManager.trigger(this.entityObject,t.CustomEvent.create(t.EEngineEvent.UI_WIDTH_CHANGE)))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._height*this.scale.y},set:function(e){e!==this._height&&(this._height=e,this.entityObject&&t.EventManager.trigger(this.entityObject,t.CustomEvent.create(t.EEngineEvent.UI_HEIGHT_CHANGE)))},enumerable:!0,configurable:!0}),r.prototype.init=function(){},r.prototype.dispose=function(){},r.prototype.syncRotation=function(){this.dirtyRotation&&(null===this.p_parent?this._rotationMatrix=this._localRotationMatrix.copy():this._rotationMatrix=this.p_parent.rotationMatrix.copy().multiply(this._localRotationMatrix),this.children.forEach(function(t){t.dirtyRotation=!0}))},r.prototype.syncPositionAndScale=function(){this.dirtyLocal&&(this._localToParentMatrix.setTS(this._localPosition,this._localScale),this.dirtyLocal=!1,this.dirtyPositionAndScale=!0),this.dirtyPositionAndScale&&(null===this.p_parent?this._localPositionAndScaleMatrix=this._localToParentMatrix.copy():this._localPositionAndScaleMatrix=this.p_parent.localPositionAndScaleMatrix.copy().multiply(this._localToParentMatrix),this.dirtyLocal=!1,this.children.forEach(function(t){t.dirtyPositionAndScale=!0}))},r.prototype.translate=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null;return n=2===e.length?t.Vector2.create(e[0],e[1]):e[0],this.position=n.add(this.position),this},r.prototype.rotate=function(t){var e=this.position;return this.rotateAround(t,e.x+this.pivot.x,e.y-this.pivot.y),this.dirtyRotation=!0,this.isRotate=!0,this},r.prototype.rotateAround=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null,o=null,i=null,a=null;return 2===e.length?(n=e[0],o=e[1]):(n=e[0],o=t.Vector2.create(e[1],e[2])),i=o.x,a=o.y,this._translateInRotationMatrix(i,a),this._rotateAroundCanvasOriginPoint(n),this._translateInRotationMatrix(-i,-a),this},r.prototype._translateInRotationMatrix=function(t,e){return this._localRotationMatrix.translate(t,e),this},r.prototype.resetPosition=function(){this.position=t.Vector2.create(0,0)},r.prototype.resetScale=function(){this.scale=t.Vector2.create(1,1)},r.prototype.resetRotation=function(){this._localRotationMatrix.setIdentity()},r.prototype.handleWhenSetTransformState=function(e){var r=null;switch(e){case t.ETransformState.ISTRANSLATE:r=t.EEngineEvent.TRANSFORM_TRANSLATE;break;case t.ETransformState.ISROTATE:r=t.EEngineEvent.TRANSFORM_ROTATE;break;case t.ETransformState.ISSCALE:r=t.EEngineEvent.TRANSFORM_SCALE;break;default:t.Log.error(!0,t.Log.info.FUNC_UNKNOW("transformState:"+e))}t.EventManager.trigger(this.entityObject,t.CustomEvent.create(r))},r.prototype.clearCache=function(){this._rotationMatrixCache=null,this._localPositionAndScaleMatrixCache=null},r.prototype._rotateAroundCanvasOriginPoint=function(t){return this._localRotationMatrix.rotate(t),this.dirtyRotation=!0,this},r.prototype._getParentWidth=function(){return null===this.p_parent?t.DeviceManager.getInstance().view.width:this.p_parent.width},r.prototype._getParentHeight=function(){return null===this.p_parent?t.DeviceManager.getInstance().view.height:this.p_parent.height},r.prototype._getParentPosition=function(){if(null===this.p_parent){var e=t.DeviceManager.getInstance().view;return t.Vector2.create(e.width/2,e.height/2)}return this.p_parent.position},r.prototype._getParentScale=function(){return null===this.p_parent?t.Vector2.create(1,1):this.p_parent.scale},__decorate([t.cacheGetter(function(){return null!==this._rotationMatrixCache},function(){return this._rotationMatrixCache},function(t){this._rotationMatrixCache=t})],r.prototype,"rotationMatrix",null),__decorate([t.cacheGetter(function(){return null!==this._localPositionAndScaleMatrixCache},function(){return this._localPositionAndScaleMatrixCache},function(t){this._localPositionAndScaleMatrixCache=t})],r.prototype,"localPositionAndScaleMatrix",null),__decorate([t.requireSetter(function(e){t.assert(e.x<=e.y,t.Log.info.FUNC_SHOULD("minX","<= maxY")),t.assert(e.x>=0&&e.x<=1,t.Log.info.FUNC_SHOULD("minX",">= 0 && <= 1")),t.assert(e.y>=0&&e.y<=1,t.Log.info.FUNC_SHOULD("maxX",">= 0 && <= 1"))})],r.prototype,"anchorX",null),__decorate([t.requireSetter(function(e){t.assert(e.x<=e.y,t.Log.info.FUNC_SHOULD("minY","<= maxY")),t.assert(e.x>=0&&e.x<=1,t.Log.info.FUNC_SHOULD("minY",">= 0 && <= 1")),t.assert(e.y>=0&&e.y<=1,t.Log.info.FUNC_SHOULD("maxY",">= 0 && <= 1"))})],r.prototype,"anchorY",null),r}(t.Transform);t.RectTransform=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.ISTRANSLATE="isTranslate"]="ISTRANSLATE",t[t.ISROTATE="isRotate"]="ISROTATE",t[t.ISSCALE="isScale"]="ISSCALE",t[t.ISLOCALTRANSLATE="isLocalTranslate"]="ISLOCALTRANSLATE",t[t.ISLOCALROTATE="isLocalRotate"]="ISLOCALROTATE",t[t.ISLOCALSCALE="isLocalScale"]="ISLOCALSCALE"}(t.ETransformState||(t.ETransformState={}));t.ETransformState}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this.list=wdCb.Collection.create()}return t.prototype.addChild=function(t){this.hasChild(t)||this.list.addChild(t)},t.prototype.removeChild=function(t){this.list.removeChild(t)},t.prototype.hasChild=function(t){return this.list.hasChild(t)},t}();t.ComponentContainer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.update=function(t){var e=[];this.list.forEach(function(r){return r.isFinish?void e.push(r):void(r.isStop||r.isPause||r.update(t))});for(var r=0,n=e;r<n.length;r++){var o=n[r];o.entityObject.removeComponent(o)}},e}(t.ComponentContainer);t.ActionManager=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(t){e.call(this),this._uiObject=null,this._uiObject=t}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.update=function(t){0!==this.list.getCount()&&this._isDirty()&&this.list.forEach(function(e){e.update(t)})},r.prototype._isDirty=function(){return this._uiObject.getComponent(t.UIRenderer).state===t.EUIRendererState.DIRTY},__decorate([t.require(function(e){t.assert(this.list.getCount()<=1,t.Log.info.FUNC_SHOULD("only contain one ui component"))})],r.prototype,"update",null),r}(t.ComponentContainer);t.UIManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._lights=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"ambientLight",{get:function(){return this._lights.getChild(t.AmbientLight.type)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"directionLights",{get:function(){return this._lights.getChild(t.DirectionLight.type)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pointLights",{get:function(){return this._lights.getChild(t.PointLight.type)},enumerable:!0,configurable:!0}),e.prototype.addChild=function(e){e.hasComponent(t.AmbientLight)?this._lights.addChild(t.AmbientLight.type,e):e.hasComponent(t.DirectionLight)?this._lights.appendChild(t.DirectionLight.type,e):e.hasComponent(t.PointLight)?this._lights.appendChild(t.PointLight.type,e):t.Log.error(!0,t.Log.info.FUNC_INVALID("light"))},e.prototype.addChildren=function(t){var e=this;t.forEach(function(t){e.addChild(t)})},e}();t.LightManager=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.isFrameChange=!1,this.state=r.DEFAULT,this.pauseTime=null,this.resumeTime=null,this.pauseDuration=null,this.frameCount=null,this._isResume=!1}return __extends(n,e),Object.defineProperty(n.prototype,"isStart",{get:function(){return this.state===r.RUN},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isStop",{get:function(){return this.state===r.STOP},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isPause",{get:function(){return this.state===r.PAUSE},enumerable:!0,configurable:!0}),n.prototype.pause=function(){this.state=r.PAUSE,this.pauseTime=this.getPauseTime()},n.prototype.resume=function(){this.state=r.RUN,this._isResume=!0,this.resumeTime=this.getResumeTime()},n.prototype.stop=function(){this.state=r.STOP},n.prototype.update=function(t){if(this.state!==r.DEFAULT&&!this.isStop){if(this.isPause)return void this.handleWhenPause(t);this._isResume&&(this._isResume=!1,this.continueFromPausePoint(t)),this.handleBeforeJudgeWhetherCurrentFrameFinish(t),this.isCurrentFrameFinish(t)?this.handleWhenCurrentFrameFinish(t):this.isFrameChange=!1,this.handleAfterJudgeWhetherCurrentFrameFinish(t)}},n.prototype.getPauseTime=function(){return this.getCurrentTime()},n.prototype.getResumeTime=function(){return this.getCurrentTime()},n.prototype.getCurrentTime=function(){return t.Director.getInstance().elapsed},n.prototype.continueFromPausePoint=function(t){this.pauseDuration+=this.resumeTime-this.pauseTime},n}(t.Component);t.Animation=e,function(t){t[t.DEFAULT=0]="DEFAULT",t[t.RUN=1]="RUN",t[t.STOP=2]="STOP",t[t.PAUSE=3]="PAUSE"}(t.EAnimationState||(t.EAnimationState={}));var r=t.EAnimationState}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.interpolation=0,this.currentFrame=0,this.duration=null,this.fps=null,this.currentAnimName=null,this._prevFrameEndTime=null}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"nextFrame",{get:function(){var t=this.currentFrame+1;return t>=this.frameCount&&(t=0),t},enumerable:!0,configurable:!0}),r.prototype.init=function(){},r.prototype.dispose=function(){},r.prototype.play=function(e,r){var n=this.entityObject.getComponent(t.ModelGeometry);this.currentAnimName=e,this.fps=r,this.duration=1/r*1e3,this.frameCount=n.morphTargets.getChild(e).getCount(),this.resetAnim(),this.state=t.EAnimationState.RUN},r.prototype.handleWhenPause=function(t){},r.prototype.handleWhenCurrentFrameFinish=function(e){this.isFrameChange=!0,this._prevFrameEndTime=t.MathUtils.maxFloorIntegralMultiple(e-this.pauseDuration,this.duration),this.currentFrame++,this._isFinishAllFrames()&&(this.currentFrame=0)},r.prototype.handleBeforeJudgeWhetherCurrentFrameFinish=function(t){null===this._prevFrameEndTime&&(this._prevFrameEndTime=this.getCurrentTime())},r.prototype.isCurrentFrameFinish=function(t){return t-this._prevFrameEndTime-this.pauseDuration>this.duration},r.prototype.handleAfterJudgeWhetherCurrentFrameFinish=function(t){this._computeInterpolation(t)},r.prototype.resetAnim=function(){this._prevFrameEndTime=null,this.currentFrame=0,this.pauseDuration=0},r.prototype._computeInterpolation=function(t){this.interpolation=this.fps*(t-this._prevFrameEndTime-this.pauseDuration)/1e3},r.prototype._isFinishAllFrames=function(){return this.currentFrame>=this.frameCount},__decorate([t.require(function(e,r){var n=this.entityObject.getComponent(t.ModelGeometry);t.assert(n,t.Log.info.FUNC_SHOULD("this entityObject","add ModelGeometry component")),t.assert(n.morphTargets.getChild(e)&&n.morphTargets.getChild(e).getCount()>0,t.Log.info.FUNC_NOT_EXIST('"'+e+'" animation'))}),t.ensure(function(){t.assert(this.frameCount>1,t.Log.info.FUNC_SHOULD("frames.count","> 1"))})],r.prototype,"play",null),__decorate([t.require(function(e){t.assert(e-this._prevFrameEndTime-this.pauseDuration>=0,t.Log.info.FUNC_SHOULD("elapsedTime of current frame:"+(e-this._prevFrameEndTime-this.pauseDuration),">= 0"))})],r.prototype,"isCurrentFrameFinish",null),__decorate([t.ensure(function(){var e=this.interpolation;t.assert(e>=0&&1>=e,t.Log.info.FUNC_SHOULD("interpolation("+e,">= 0 && <= 1"))})],r.prototype,"_computeInterpolation",null),r}(t.Animation);t.MorphAnimation=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.data=null,this._currentFrame=null,this._currentAnimName=null,this._beginElapsedTimeOfFirstFrame=null,this._prevFrameTime=null,this._currentAnimData=null,this._currentFrameData=null,this._prevFrameData=null,this._startFrameDataMap=wdCb.Hash.create()}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.init=function(){},r.prototype.dispose=function(){},r.prototype.play=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(t.JudgeUtils.isNumber(e[0])){var n=e[0],o=0,i=this;this.data.forEach(function(t,e){return n===o?(i._currentAnimName=e,i._currentAnimData=t,wdCb.$BREAK):void o++})}else if(t.JudgeUtils.isString(e[0])){var a=e[0];this._currentAnimName=a,this._currentAnimData=this.data.getChild(a)}this.resetAnim(),this._saveStartFrameData(this.entityObject.transform),this.frameCount=this._currentAnimData.getCount(),this.state=t.EAnimationState.RUN},r.prototype.handleWhenPause=function(t){},r.prototype.handleWhenCurrentFrameFinish=function(t){this.isFrameChange=!0,this._updateFrame(t),this._saveStartFrameData(this._prevFrameData)},r.prototype.handleBeforeJudgeWhetherCurrentFrameFinish=function(t){null===this._beginElapsedTimeOfFirstFrame&&(this._beginElapsedTimeOfFirstFrame=this.getCurrentTime())},r.prototype.isCurrentFrameFinish=function(t){return t-this._beginElapsedTimeOfFirstFrame-this.pauseDuration>this._currentFrameData.time},r.prototype.handleAfterJudgeWhetherCurrentFrameFinish=function(t){this._updateTargets(t)},r.prototype.resetAnim=function(){this._beginElapsedTimeOfFirstFrame=null,this._prevFrameTime=0,this.pauseDuration=0,this._currentFrame=0,this._prevFrameData=null,this._updateCurrentFrameData(),this._startFrameDataMap.removeAllChildren()},r.prototype._updateTargets=function(e){var r=this,n=this.entityObject.transform,o=this._startFrameDataMap;this._currentFrameData.targets.forEach(function(i){var a=i.data,s=o.getChild(i.target),c=r._computeInterpolation(e,i.interpolationMethod);switch(i.target){case t.EArticulatedAnimationTarget.TRANSLATION:n.localPosition=t.Vector3.create().lerp(s,a,c);break;case t.EArticulatedAnimationTarget.ROTATION:n.localRotation=t.Quaternion.create().slerp(s,a,c);break;case t.EArticulatedAnimationTarget.SCALE:n.localScale=t.Vector3.create().lerp(s,a,c);break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("EArticulatedAnimationTarget:"+i.target))}})},r.prototype._computeInterpolation=function(e,r){var n=null;switch(r){case t.EKeyFrameInterpolation.LINEAR:n=this._currentFrameData.time-this._prevFrameTime===0?1:(e-this._beginElapsedTimeOfFirstFrame-this.pauseDuration-this._prevFrameTime)/(this._currentFrameData.time-this._prevFrameTime);break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("interpolationMethod:"+r))}return n},r.prototype._saveStartFrameData=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=this._startFrameDataMap;if(this._isFrameData(e[0])){var o=e[0];o.targets.forEach(function(t){n.addChild(t.target,t.data)})}else{var i=e[0];n.addChild(t.EArticulatedAnimationTarget.TRANSLATION,i.localPosition),n.addChild(t.EArticulatedAnimationTarget.ROTATION,i.localRotation),n.addChild(t.EArticulatedAnimationTarget.SCALE,i.localScale)}},r.prototype._updateCurrentFrameData=function(){this._currentFrameData=this._currentAnimData.getChild(this._currentFrame)},r.prototype._updateFrame=function(t){this._updateCurrentFrameIndex(t),this._isFinishAllFrames()?(this._currentFrame=0,this._beginElapsedTimeOfFirstFrame=this._getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames(t),this._prevFrameTime=0,this._prevFrameData=this._currentAnimData.getChild(this.frameCount-1),this._updateCurrentFrameData()):this._prevFrameTime=this._currentAnimData.getChild(this._currentFrame-1).time},r.prototype._getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames=function(e){return t.MathUtils.maxFloorIntegralMultiple(e,this._currentAnimData.getChild(this.frameCount-1).time)},r.prototype._isFinishAllFrames=function(){return this._currentFrame>=this.frameCount},r.prototype._updateCurrentFrameIndex=function(t){do this._currentFrame++,this._prevFrameData=this._currentFrameData,this._updateCurrentFrameData();while(!this._isFinishAllFrames()&&this.isCurrentFrameFinish(t))},r.prototype._isFrameData=function(t){return void 0!==t.time&&void 0!==t.targets},__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(t.JudgeUtils.isNumber(e[0])){var n=e[0];t.assert(this.data.getCount()>=n+1,t.Log.info.FUNC_NOT_EXIST("animation index:"+n))}else if(t.JudgeUtils.isString(e[0])){var o=e[0];t.assert(this.data.hasChild(o),t.Log.info.FUNC_NOT_EXIST("animation name:"+o))}}),t.ensure(function(){t.assert(!!this._currentAnimData,t.Log.info.FUNC_NOT_EXIST("animation name:"+this._currentAnimName)),this._currentAnimData.forEach(function(e){t.assert(e.time>=0,t.Log.info.FUNC_SHOULD("time",">= 0")),t.assert(e.targets.getCount()>0,t.Log.info.FUNC_SHOULD("ArticulatedAnimationFrameData->targets.getCount()","> 0")),e.targets.forEach(function(e){var r=e.data;switch(e.target){case t.EArticulatedAnimationTarget.TRANSLATION:t.assert(r instanceof t.Vector3,t.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget === TRANSLATION, its data","Vector3"));break;case t.EArticulatedAnimationTarget.ROTATION:t.assert(r instanceof t.Quaternion,t.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget ===ROTATION, its data","Quaternion"));break;case t.EArticulatedAnimationTarget.SCALE:t.assert(r instanceof t.Vector3,t.Log.info.FUNC_MUST_BE("if target:EArticulatedAnimationTarget === SCALE, its data","Vector3"));break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("EArticulatedAnimationTarget:"+e.target))}})})})],r.prototype,"play",null),__decorate([t.require(function(e){t.assert(e-this._beginElapsedTimeOfFirstFrame-this.pauseDuration>=0,t.Log.info.FUNC_SHOULD("elapsedTime of current frame:"+(e-this._beginElapsedTimeOfFirstFrame-this.pauseDuration),">= 0"))})],r.prototype,"isCurrentFrameFinish",null),__decorate([t.ensure(function(e,r,n){t.assert(e>=0&&1>=e,t.Log.info.FUNC_SHOULD("interpolation:"+e,">= 0 && <= 1"))})],r.prototype,"_computeInterpolation",null),__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(this._isFrameData(e[0])){var n=e[0];t.assert(null!==this._currentFrameData,t.Log.info.FUNC_SHOULD("set currentFrameData")),this._currentFrameData.targets.forEach(function(e,r){t.assert(n.targets.getChild(r).target===e.target,t.Log.info.FUNC_SHOULD("the current frame and the start frame","modify the same targets"))})}})],r.prototype,"_saveStartFrameData",null),__decorate([t.require(function(e){var r=this._currentAnimData.getChild(this.frameCount-1).time;t.assert(e>=r,t.Log.info.FUNC_SHOULD("elapsedTime:"+e,">= lastEndFrameTime:"+r))})],r.prototype,"_getBeginElapsedTimeOfFirstFrameWhenFinishAllFrames",null),r}(t.Animation);t.ArticulatedAnimation=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.LINEAR=0]="LINEAR"}(t.EKeyFrameInterpolation||(t.EKeyFrameInterpolation={}));t.EKeyFrameInterpolation}(wd||(wd={}));var wd;!function(t){!function(t){t[t.TRANSLATION="position"]="TRANSLATION",t[t.ROTATION="rotation"]="ROTATION",t[t.SCALE="scale"]="SCALE"}(t.EArticulatedAnimationTarget||(t.EArticulatedAnimationTarget={}));t.EArticulatedAnimationTarget}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._material=null,this.buffers=null,this.drawMode=t.EDrawMode.TRIANGLES}return __extends(r,e),Object.defineProperty(r.prototype,"material",{get:function(){return this._material},set:function(e){t.JudgeUtils.isEqual(e,this._material)||(this._material=e,this._material.geometry=this,this.entityObject&&t.EventManager.trigger(this.entityObject,t.CustomEvent.create(t.EEngineEvent.MATERIAL_CHANGE)))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"geometryData",{get:function(){return this.buffers.geometryData},enumerable:!0,configurable:!0}),r.prototype.init=function(){var t=null,e=this.computeData(),r=e.vertices,n=e.faces,o=e.texCoords,i=e.colors,a=e.morphTargets;this.buffers=this.createBufferContainer(),t=this.createGeometryData(r,n,o,i,a),this.buffers.geometryData=t,this.buffers.init(),this._material.init(),this.computeNormals()},r.prototype.hasFaceNormals=function(){return this.buffers.geometryData.hasFaceNormals()},r.prototype.hasVertexNormals=function(){return this.buffers.geometryData.hasVertexNormals()},r.prototype.isSmoothShading=function(){return this._material.shading===t.EShading.SMOOTH},r.prototype.dispose=function(){this.buffers.dispose(),this._material.dispose()},r.prototype.computeFaceNormals=function(){this.buffers.geometryData.computeFaceNormals()},r.prototype.computeVertexNormals=function(){this.buffers.geometryData.computeVertexNormals()},r.prototype.createBuffersFromGeometryData=function(){this.buffers.createBuffersFromGeometryData()},r.prototype.computeNormals=function(){this.isSmoothShading()?this.hasVertexNormals()||this.computeVertexNormals():this.hasFaceNormals()||this.computeFaceNormals()},r.prototype.createBufferContainer=function(){return t.CommonBufferContainer.create(this.entityObject)},r.prototype.createGeometryData=function(t,e,r,n,o){return this.createCommonGeometryData(t,e,r,n)},r.prototype.createCommonGeometryData=function(e,r,n,o){var i=t.CommonGeometryData.create(this);return i.vertices=e,i.faces=r,i.texCoords=n,i.colors=o,i},__decorate([t.ensure(function(){var e=this.buffers.geometryData;t.assert(e.vertices.length>0,t.Log.info.FUNC_MUST("vertices.count","> 0")),t.assert(3*e.faces.length===e.indices.length,t.Log.info.FUNC_SHOULD("faces.count","be "+e.indices.length/3+", but actual is "+e.faces.length))})],r.prototype,"init",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],r.prototype,"hasFaceNormals",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],r.prototype,"hasVertexNormals",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],r.prototype,"computeFaceNormals",null),__decorate([t.require(function(){t.assert(!!this.buffers,t.Log.info.FUNC_NOT_EXIST("buffers"))})],r.prototype,"createBuffersFromGeometryData",null),__decorate([t.virtual],r.prototype,"computeNormals",null),__decorate([t.virtual],r.prototype,"createBufferContainer",null),__decorate([t.virtual],r.prototype,"createGeometryData",null),r}(t.Component);t.Geometry=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);
return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){}return e.convertToFaces=function(e,r){for(var n=this.hasData(r),o=[],i=0,a=e.length;a>i;i+=3){var s=e[i],c=e[i+1],u=e[i+2],l=t.Face3.create(s,c,u);n&&(l.vertexNormals.addChildren([this.getThreeComponent(r,s),this.getThreeComponent(r,c),this.getThreeComponent(r,u)]),l.faceNormal=l.vertexNormals.getChild(0).copy()),o.push(l)}return o},e.hasData=function(t){return t&&(t.length&&t.length>0||t.getCount&&t.getCount()>0)},e.getThreeComponent=function(e,r){var n=3*r;return t.Vector3.create(e[n],e[n+1],e[n+2])},e.iterateThreeComponent=function(e,r){for(var n=0,o=e.length;o>n;n+=3)r(t.Vector3.create(e[n],e[n+1],e[n+2]))},e.setThreeComponent=function(e,r,n){r instanceof t.Vector3?(e[3*n]=r.x,e[3*n+1]=r.y,e[3*n+2]=r.z):(e[3*n]=r[0],e[3*n+1]=r[1],e[3*n+2]=r[2])},__decorate([t.require(function(e){e&&t.assert(e instanceof wdCb.Collection||e instanceof wdCb.Hash||t.JudgeUtils.isArrayExactly(e),t.Log.info.FUNC_SHOULD("data","be Array or Collection or Hash"))})],e,"hasData",null),__decorate([t.require(function(e,r){t.assert(e.length%3===0,t.Log.info.FUNC_SHOULD("dataArr.length","times of three"))})],e,"iterateThreeComponent",null),e}();t.GeometryUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._vertices=[],this._texCoords=[],this._colors=[],this._indices=[],this._normals=[]}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"vertices",{get:function(){return this._vertices},set:function(e){this._vertices=e,this.buffers&&(this.buffers.geometryData.vertices=e,this.buffers.removeCache(t.EBufferDataType.VERTICE))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"texCoords",{get:function(){return this._texCoords},set:function(e){this._texCoords=e,this.buffers&&(this.buffers.geometryData.texCoords=e,this.buffers.removeCache(t.EBufferDataType.TEXCOORD))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"colors",{get:function(){return this._colors},set:function(e){this._colors=e,this.buffers&&(this.buffers.geometryData.colors=e,this.buffers.removeCache(t.EBufferDataType.COLOR))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"indices",{get:function(){return this._indices},set:function(e){this._indices=e,this.buffers&&(this.buffers.geometryData.faces=t.GeometryUtils.convertToFaces(e,this.normals),this.buffers.removeCache(t.EBufferDataType.INDICE))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"normals",{get:function(){return this._normals},set:function(e){this._normals=e,this.buffers&&(this.buffers.geometryData.faces=t.GeometryUtils.convertToFaces(this.indices,e),this.buffers.removeCache(t.EBufferDataType.NORMAL))},enumerable:!0,configurable:!0}),r.prototype.computeData=function(){return{vertices:this.vertices,faces:t.GeometryUtils.convertToFaces(this.indices,this.normals),texCoords:this.texCoords,colors:this.colors}},r}(t.Geometry);t.CustomGeometry=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.vertices=null,this.colors=null,this.texCoords=null,this.faces=null,this.morphTargets=null,this.morphFaceNormals=wdCb.Hash.create(),this.morphVertexNormals=wdCb.Hash.create()}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.hasAnimation=function(){return this._hasMorphTargets()&&this.entityObject&&this.entityObject.hasComponent(t.MorphAnimation)},r.prototype.hasMorphFaceNormals=function(){return this.buffers.geometryData.hasMorphFaceNormals()},r.prototype.hasMorphVertexNormals=function(){return this.buffers.geometryData.hasMorphVertexNormals()},r.prototype.computeMorphNormals=function(){this.buffers.geometryData.computeMorphNormals()},r.prototype.computeNormals=function(){e.prototype.computeNormals.call(this),this._hasMorphTargets()&&(this.isSmoothShading()?this.hasMorphVertexNormals()||this.computeMorphNormals():this.hasMorphFaceNormals()||this.computeMorphNormals())},r.prototype.computeData=function(){return{vertices:this.vertices,faces:this.faces,texCoords:this.texCoords,colors:this.colors,morphTargets:this.morphTargets}},r.prototype.createBufferContainer=function(){return this.hasAnimation()?t.MorphBufferContainer.create(this.entityObject,this.entityObject.getComponent(t.MorphAnimation)):t.CommonBufferContainer.create(this.entityObject)},r.prototype.createGeometryData=function(e,r,n,o,i){if(this.hasAnimation()){var a=t.MorphGeometryData.create(this);return a.vertices=e,a.faces=r,a.texCoords=n,a.colors=o,a.morphTargets=i,a}return this.createCommonGeometryData(e,r,n,o)},r.prototype._hasMorphTargets=function(){return this.morphTargets&&this.morphTargets.getCount()>0},__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],r.prototype,"hasMorphFaceNormals",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],r.prototype,"hasMorphVertexNormals",null),__decorate([t.require(function(){t.assert(this.buffers&&this.buffers.geometryData,t.Log.info.FUNC_MUST_DEFINE("buffers->geometryData"))})],r.prototype,"computeMorphNormals",null),__decorate([t.require(function(){this.hasAnimation()&&t.assert(this.entityObject.getComponent(t.MorphAnimation),t.Log.info.FUNC_SHOULD("entityObject with ModelGeometry","add MorphAnimation component"))})],r.prototype,"createBufferContainer",null),r}(t.Geometry);t.ModelGeometry=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.width=null,this.height=null,this.depth=null,this.widthSegments=1,this.heightSegments=1,this.depthSegments=1}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.computeData=function(){function e(e,r,n){var o,i,a,s,c=p.length/3;for(a=0;r>=a;a++)for(s=0;n>=s;s++){var y=t.Vector3.create(),g=t.Vector3.create(),m=t.Vector3.create(),v=t.Vector3.create();y.lerp(h[u[e][0]],h[u[e][1]],a/r),g.lerp(h[u[e][0]],h[u[e][2]],s/n),m.sub2(g,h[u[e][0]]),v.add2(y,m),o=a/r,i=s/n,p.push(v.x,v.y,v.z),f.push(l[e][0],l[e][1],l[e][2]),d.push(o,i),r>a&&n>s&&(_.push(c+s+a*(r+1),c+s+(a+1)*(r+1),c+s+a*(r+1)+1),_.push(c+s+(a+1)*(r+1),c+s+(a+1)*(r+1)+1,c+s+a*(r+1)+1))}}var r=this.width,n=this.height,o=this.depth,i=this.widthSegments,a=this.heightSegments,s=this.depthSegments,c={FRONT:0,BACK:1,TOP:2,BOTTOM:3,RIGHT:4,LEFT:5},u=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],h=[t.Vector3.create(-r,-n,o),t.Vector3.create(r,-n,o),t.Vector3.create(r,n,o),t.Vector3.create(-r,n,o),t.Vector3.create(r,-n,-o),t.Vector3.create(-r,-n,-o),t.Vector3.create(-r,n,-o),t.Vector3.create(r,n,-o)],p=[],f=[],d=[],_=[];return e(c.FRONT,i,a),e(c.BACK,i,a),e(c.TOP,i,s),e(c.BOTTOM,i,s),e(c.RIGHT,s,a),e(c.LEFT,s,a),{vertices:p,faces:t.GeometryUtils.convertToFaces(_,f),texCoords:d}},r}(t.Geometry);t.BoxGeometry=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.width=null,this.height=null}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.computeData=function(){var e=this.width,r=this.height,n=-e/2,o=e/2,i=r/2,a=-r/2,s=[],c=[],u=[],l=[];return s=[o,i,0,n,i,0,n,a,0,o,a,0],u=[0,1,2,0,2,3],c=[1,1,0,1,0,0,1,0],l=[0,0,1,0,0,1,0,0,1,0,0,1],{vertices:s,faces:t.GeometryUtils.convertToFaces(u,l),texCoords:c}},r}(t.Geometry);t.RectGeometry=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.width=null,this.height=null,this.widthSegments=1,this.heightSegments=1}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.computeData=function(){var e=this.width,r=this.height,n=this.widthSegments,o=this.heightSegments,i=null,a=null,s=null,c=null,u=null,l=null,h=null,p=[],f=[],d=[],_=[];for(l=0;n>=l;l++)for(h=0;o>=h;h++)i=-e+2*e*l/n,a=0,s=-(-r+2*r*h/o),c=l/n,u=h/o,p.push(i,a,s),d.push(0,1,0),f.push(c,u),n>l&&o>h&&(_.push(h+l*(n+1),h+(l+1)*(n+1),h+l*(n+1)+1),_.push(h+(l+1)*(n+1),h+(l+1)*(n+1)+1,h+l*(n+1)+1));return{vertices:p,faces:t.GeometryUtils.convertToFaces(_,d),texCoords:f}},r}(t.Geometry);t.PlaneGeometry=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.LATITUDELONGTITUDE=0]="LATITUDELONGTITUDE"}(t.ESphereDrawMode||(t.ESphereDrawMode={}));t.ESphereDrawMode}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.radius=1,this.sphereDrawMode=t.ESphereDrawMode.LATITUDELONGTITUDE,this.segments=20}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.computeData=function(){var e=this.radius,n=this.sphereDrawMode,o=this.segments,i=null;if(n===t.ESphereDrawMode.LATITUDELONGTITUDE){var a=r.create(e,o).getData(),s=a.vertices,c=a.indices,u=a.normals,l=a.texCoords;return{vertices:s,faces:t.GeometryUtils.convertToFaces(c,u),texCoords:l}}return i},n}(t.Geometry);t.SphereGeometry=e;var r=function(){function t(t,e){this._radius=null,this._latitudeBands=null,this._longitudeBands=null,this._radius=t,this._latitudeBands=e,this._longitudeBands=e}return t.create=function(t,e){var r=new this(t,e);return r},t.prototype.getData=function(){for(var t=[],e=[],r=[],n=[],o=0;o<=this._latitudeBands;o++)for(var i=o*Math.PI/this._latitudeBands,a=Math.sin(i),s=Math.cos(i),c=0;c<=this._longitudeBands;c++){var u=2*c*Math.PI/this._longitudeBands,l=Math.sin(u),h=Math.cos(u),p=this._radius*h*a,f=this._radius*s,d=this._radius*l*a,_=1-c/this._longitudeBands,y=1-o/this._latitudeBands;e.push(p),e.push(f),e.push(d),r.push(_),r.push(y),t.push(p),t.push(f),t.push(d)}for(var o=0;o<this._latitudeBands;o++)for(var c=0;c<this._longitudeBands;c++){var g=o*(this._longitudeBands+1)+c,m=g+this._longitudeBands+1;n.push(g+1),n.push(m),n.push(g),n.push(g+1),n.push(m+1),n.push(m)}return{vertices:t,indices:n,normals:e,texCoords:r}},t}()}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.width=null,this.height=null}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.computeData=function(){var e=this.width,r=this.height,n=-e/2,o=e/2,i=r/2,a=-r/2,s=[],c=[],u=[],l=[];return s=[0,i,0,n,a,0,o,a,0],u=[0,1,2],c=[.5,1,0,0,1,0],l=[0,0,1,0,0,1,0,0,1],{vertices:s,faces:t.GeometryUtils.convertToFaces(u,l),texCoords:c}},r}(t.Geometry);t.TriangleGeometry=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.subdivisions=1,this.range={width:10,height:10},this.minHeight=0,this.maxHeight=10,this.heightMapAsset=null}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.computeData=function(){var t=this.heightMapAsset.source,e=t.width,r=t.height;return this._createGroundFromHeightMap(this._readHeightMapData(t,e,r),e,r)},r.prototype._readHeightMapData=function(t,e,r){var n=document.createElement("canvas"),o=n.getContext("2d");return n.width=e,n.height=r,o.drawImage(t,0,0),o.getImageData(0,0,e,r).data},r.prototype._createGroundFromHeightMap=function(e,r,n){for(var o=[],i=[],a=[],s=this.subdivisions,c=this.range.width,u=this.range.height,l=0;s>=l;l++)for(var h=0;s>=h;h++){var p=h*c/s-c/2,f=(s-l)*u/s-u/2;o.push(p,this._getHeight(p,f,e,r,n),f),a.push(h/s,1-l/s)}return{vertices:o,faces:t.GeometryUtils.convertToFaces(this._getIndices(),i),texCoords:a}},r.prototype._getHeight=function(t,e,r,n,o){var i=this.range.width,a=this.range.height,s=(t+i/2)/i*(n-1)|0,c=(1-(e+a/2)/a)*(o-1)|0,u=4*(s+c*n),l=r[u]/255,h=r[u+1]/255,p=r[u+2]/255,f=.3*l+.59*h+.11*p,d=this.minHeight,_=this.maxHeight;return d+(_-d)*f},r.prototype._getIndices=function(){for(var t=[],e=this.subdivisions,r=0;e>r;r++)for(var n=0;e>n;n++)t.push(n+r*(e+1)),t.push(n+1+r*(e+1)),t.push(n+1+(r+1)*(e+1)),t.push(n+r*(e+1)),t.push(n+1+(r+1)*(e+1)),t.push(n+(r+1)*(e+1));return t},r}(t.Geometry);t.TerrainGeometry=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(t){this._vertices=null,this._faces=null,this._texCoords=null,this._colors=null,this._tangents=null,this.tangentDirty=!0,this.colorDirty=!0,this.geometry=null,this._normalCache=null,this._normalFromFaceCache=null,this._normalFromVertexCache=null,this._indiceCache=null,this._colorCache=null,this._normalDirty=!0,this._indiceDirty=!0,this._materialColorChangeSubscription=null,this.geometry=t}return Object.defineProperty(e.prototype,"vertices",{get:function(){return this._vertices},set:function(t){this._vertices=t,this.tangentDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normals",{get:function(){var t=this.geometry;return t.isSmoothShading()?(this.hasVertexNormals()||this.computeVertexNormals(),this.normalsFromVertexNormals):(this.hasFaceNormals()||this.computeFaceNormals(),this.normalsFromFaceNormal)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normalsFromFaceNormal",{get:function(){var e=null;return this.hasFaceNormals()?(e=[],this._faces.forEach(function(r){var n=r.faceNormal;t.GeometryUtils.setThreeComponent(e,n,r.aIndex),t.GeometryUtils.setThreeComponent(e,n,r.bIndex),t.GeometryUtils.setThreeComponent(e,n,r.cIndex)}),this._fillEmptyData(e),e):[]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normalsFromVertexNormals",{get:function(){var e=null;return this.hasVertexNormals()?(e=[],this._faces.forEach(function(r){t.GeometryUtils.setThreeComponent(e,r.vertexNormals.getChild(0),r.aIndex),t.GeometryUtils.setThreeComponent(e,r.vertexNormals.getChild(1),r.bIndex),t.GeometryUtils.setThreeComponent(e,r.vertexNormals.getChild(2),r.cIndex)}),this._fillEmptyData(e),e):[]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"indices",{get:function(){for(var t=[],e=0,r=this._faces;e<r.length;e++){var n=r[e];t.push(n.aIndex,n.bIndex,n.cIndex)}return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"faces",{get:function(){return this._faces},set:function(t){this._faces=t,this.onChangeFace()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"texCoords",{get:function(){return this._texCoords},set:function(t){this._texCoords=t,this.tangentDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"colors",{get:function(){return this._needGetColorsFromMaterial()?this._getColorsFromMaterial(this._vertices):this._colors},set:function(t){this._colors=t,this.colorDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tangents",{get:function(){return this.tangentDirty&&(this.tangentDirty=!1,t.GeometryUtils.hasData(this.normals)&&t.GeometryUtils.hasData(this.texCoords)&&t.GeometryUtils.hasData(this.indices)&&(this._tangents=this._calculateTangents(this._vertices,this.normals,this.texCoords,this.indices))),this._tangents},enumerable:!0,configurable:!0}),e.prototype.init=function(){var e=this;this._materialColorChangeSubscription=wdFrp.fromArray([t.EventManager.fromEvent(this.geometry.entityObject,t.EEngineEvent.MATERIAL_COLOR_CHANGE),t.EventManager.fromEvent(this.geometry.entityObject,t.EEngineEvent.MATERIAL_CHANGE)]).subscribe(function(){e._needGetColorsFromMaterial()&&(e.colorDirty=!0)})},e.prototype.dispose=function(){this._materialColorChangeSubscription&&this._materialColorChangeSubscription.dispose()},e.prototype.computeFaceNormals=function(){for(var t=this._vertices,e=0,r=this._faces;e<r.length;e++){var n=r[e];n.faceNormal=this.computeFaceNormalsHelper(t,n.aIndex,n.bIndex,n.cIndex)}},e.prototype.computeVertexNormals=function(){var t=null;this.hasFaceNormals()||this.computeFaceNormals(),t=this.computeVertexNormalsHelper(this._vertices);for(var e=0,r=this._faces;e<r.length;e++){var n=r[e];n.vertexNormals=wdCb.Collection.create([t[n.aIndex],t[n.bIndex],t[n.cIndex]])}},e.prototype.hasFaceNormals=function(){for(var t=0,e=this._faces;t<e.length;t++){var r=e[t];if(!r.hasFaceNormal())return!1}return!0},e.prototype.hasVertexNormals=function(){for(var t=0,e=this._faces;t<e.length;t++){var r=e[t];if(!r.hasVertexNormal())return!1}return!0},e.prototype.onChangeFace=function(){this.tangentDirty=!0,this._normalDirty=!0,this._indiceDirty=!0},e.prototype.computeFaceNormalsHelper=function(e,r,n,o){var i=t.GeometryUtils.getThreeComponent(e,r),a=t.GeometryUtils.getThreeComponent(e,n),s=t.GeometryUtils.getThreeComponent(e,o),c=t.Vector3.create().sub2(s,a),u=t.Vector3.create().sub2(i,a);return t.Vector3.create().cross(c,u).normalize()},e.prototype.computeVertexNormalsHelper=function(e){var r=e.length/3,n=null;n=new Array(r);for(var o=0;r>o;o++)n[o]=t.Vector3.create();for(var i=0,a=this._faces;i<a.length;i++){var s=a[i],c=null;c=s.faceNormal,n[s.aIndex].add(c),n[s.bIndex].add(c),n[s.cIndex].add(c)}for(var o=0;r>o;o++)n[o].normalize();return n},e.prototype._getColorsFromMaterial=function(t){var e=[],r=0,n=this.geometry.material.color,o=n.r,i=n.g,a=n.b,s=null;for(s=t.length/3,r=0;s>r;r++)e.push(o,i,a);return e},e.prototype._fillEmptyData=function(t){for(var e=0,r=t.length;r>e;e++)isNaN(t[e])&&(t[e]=0)},e.prototype._calculateTangents=function(e,r,n,o){var i,a,s,c,u,l,h,p,f,d,_,y,g,m,v,b=o.length/3,C=e.length/3,E=t.Vector3.create(),w=t.Vector3.create(),T=t.Vector3.create(),O=t.Vector3.create(),S=t.Vector3.create(),x=t.Vector2.create(),D=t.Vector2.create(),L=t.Vector2.create(),M=new Float32Array(3*C),A=new Float32Array(3*C),R=t.Vector3.create(),P=t.Vector3.create(),N=[];for(v=0;b>v;v++)i=o[3*v],a=o[3*v+1],s=o[3*v+2],T.set(e[3*i],e[3*i+1],e[3*i+2]),O.set(e[3*a],e[3*a+1],e[3*a+2]),S.set(e[3*s],e[3*s+1],e[3*s+2]),x.set(n[2*i],n[2*i+1]),D.set(n[2*a],n[2*a+1]),L.set(n[2*s],n[2*s+1]),c=O.x-T.x,u=S.x-T.x,l=O.y-T.y,h=S.y-T.y,p=O.z-T.z,f=S.z-T.z,d=D.x-x.x,_=L.x-x.x,y=D.y-x.y,g=L.y-x.y,m=1/(d*g-_*y),E.set((g*c-y*u)*m,(g*l-y*h)*m,(g*p-y*f)*m),w.set((d*u-_*c)*m,(d*h-_*l)*m,(d*f-_*p)*m),M[3*i+0]+=E.x,M[3*i+1]+=E.y,M[3*i+2]+=E.z,M[3*a+0]+=E.x,M[3*a+1]+=E.y,M[3*a+2]+=E.z,M[3*s+0]+=E.x,M[3*s+1]+=E.y,M[3*s+2]+=E.z,A[3*i+0]+=w.x,A[3*i+1]+=w.y,A[3*i+2]+=w.z,A[3*a+0]+=w.x,A[3*a+1]+=w.y,A[3*a+2]+=w.z,A[3*s+0]+=w.x,A[3*s+1]+=w.y,A[3*s+2]+=w.z;for(y=t.Vector3.create(),g=t.Vector3.create(),v=0;C>v;v++){var F=null;R.set(r[3*v],r[3*v+1],r[3*v+2]),y.set(M[3*v],M[3*v+1],M[3*v+2]),g.set(A[3*v],A[3*v+1],A[3*v+2]),F=R.dot(y),P=R.copy().scale(F),P.sub2(y,P).normalize(),N[4*v]=P.x,N[4*v+1]=P.y,N[4*v+2]=P.z,P.cross(R,y),N[4*v+3]=P.dot(g)<0?-1:1}return N},e.prototype._needGetColorsFromMaterial=function(){var t=this._colors;return!t||0===t.length},__decorate([t.requireGetter(function(){t.assert(this._faces.length>0,t.Log.info.FUNC_SHOULD("faces.count","> 0"));for(var e=0,r=this._faces;e<r.length;e++){var n=r[e];this.geometry.isSmoothShading()&&t.assert(n.vertexNormals&&3===n.vertexNormals.getCount(),t.Log.info.FUNC_SHOULD("faces->vertexNormals.count","=== 3"))}}),t.cacheGetter(function(){return!this._normalDirty&&this._normalCache},function(){return this._normalCache},function(t){this._normalCache=t,this._normalDirty=!1})],e.prototype,"normals",null),__decorate([t.requireGetter(function(){t.assert(this._faces.length>0,t.Log.info.FUNC_SHOULD("geometry","has faces"))}),t.ensureGetter(function(e){for(var r=0,n=e;r<n.length;r++){var o=n[r];t.assert(t.JudgeUtils.isNumber(o),t.Log.info.FUNC_SHOULD("normals data","be number"))}}),t.cacheGetter(function(){return!this._normalDirty&&this._normalFromFaceCache},function(){return this._normalFromFaceCache},function(t){this._normalFromFaceCache=t,this._normalDirty=!1})],e.prototype,"normalsFromFaceNormal",null),__decorate([t.requireGetter(function(){t.assert(this._faces.length>0,t.Log.info.FUNC_SHOULD("geometry","has faces"))}),t.ensureGetter(function(e){for(var r=0,n=e;r<n.length;r++){var o=n[r];t.assert(t.JudgeUtils.isNumber(o),t.Log.info.FUNC_SHOULD("normals data","be number"))}}),t.cacheGetter(function(){return!this._normalDirty&&this._normalFromVertexCache},function(){return this._normalFromVertexCache},function(t){this._normalFromVertexCache=t,this._normalDirty=!1})],e.prototype,"normalsFromVertexNormals",null),__decorate([t.cacheGetter(function(){return!this._indiceDirty&&this._indiceCache},function(){return this._indiceCache},function(t){this._indiceCache=t,this._indiceDirty=!1})],e.prototype,"indices",null),__decorate([t.ensureGetter(function(e){t.assert(e.length===this._vertices.length,t.Log.info.FUNC_SHOULD("colors.length:"+e.length,"=== vertices.length:"+this._vertices.length))}),t.cacheGetter(function(){return!this.colorDirty&&this._colorCache},function(){return this._colorCache},function(t){this._colorCache=t,this.colorDirty=!1})],e.prototype,"colors",null),__decorate([t.require(function(){t.assert(t.GeometryUtils.hasData(this.vertices),t.Log.info.FUNC_MUST("contain vertices"))}),t.ensure(function(){for(var e=0,r=this._faces;e<r.length;e++){var n=r[e];t.assert(n.faceNormal instanceof t.Vector3,t.Log.info.FUNC_SHOULD_NOT("faceNormal","be null"))}})],e.prototype,"computeFaceNormals",null),__decorate([t.virtual],e.prototype,"onChangeFace",null),e}();t.GeometryData=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e}(t.GeometryData);t.CommonGeometryData=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._morphTargets=null,this._morphNormalCache=null,this._morphNormalDirty=!0}return __extends(r,e),r.create=function(t){var e=new this(t);return e},Object.defineProperty(r.prototype,"morphNormals",{get:function(){var t=this.geometry;return this._morphNormalDirty=!1,t.isSmoothShading()?(this.hasMorphVertexNormals()||this.computeMorphNormals(),t.morphVertexNormals):(this.hasMorphFaceNormals()||this.computeMorphNormals(),t.morphFaceNormals)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"morphTargets",{get:function(){return this._morphTargets},set:function(t){this._morphTargets=t,this._morphNormalDirty=!0},enumerable:!0,configurable:!0}),r.prototype.computeMorphNormals=function(){var t=this.geometry,e=this;this._morphTargets.forEach(function(n,o){var i=wdCb.Collection.create(),a=wdCb.Collection.create();n.forEach(function(n){var o=r.create(t),s=null,c=null;o.vertices=n,o.faces=e._copyFaces(t.faces),o.computeFaceNormals(),o.computeVertexNormals(),u=e._getMorphNormals(o),s=u[0],c=u[1],i.addChild(s),a.addChild(c);var u}),t.morphFaceNormals.addChild(o,i),t.morphVertexNormals.addChild(o,a)})},r.prototype.hasMorphFaceNormals=function(){return this.geometry.morphFaceNormals.getCount()>0},r.prototype.hasMorphVertexNormals=function(){return this.geometry.morphVertexNormals.getCount()>0},r.prototype.onChangeFace=function(){this._morphNormalDirty=!0},r.prototype._copyFaces=function(t){for(var e=[],r=0,n=t;r<n.length;r++){var o=n[r];e.push(o.copy())}return e},r.prototype._getMorphNormals=function(t){return[t.normalsFromFaceNormal,t.normalsFromVertexNormals]},__decorate([t.cacheGetter(function(){return!this._morphNormalDirty&&this._morphNormalCache},function(){return this._morphNormalCache},function(t){this._morphNormalCache=t})],r.prototype,"morphNormals",null),r}(t.GeometryData);t.MorphGeometryData=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(t){this.geometryData=null,this.entityObject=null,this.container=wdCb.Hash.create(),this._colorBuffer=null,this._texCoordBuffer=null,this._tangentBuffer=null,this._indiceBuffer=null,this._materialChangeSubscription=null,this.entityObject=t}return e.prototype.init=function(){var e=this;this._materialChangeSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MATERIAL_CHANGE).subscribe(function(){e.removeCache(t.EBufferDataType.COLOR),e.geometryData.colorDirty=!0}),this.geometryData.init()},e.prototype.removeCache=function(t){this.container.removeChild(t)},e.prototype.getChild=function(e){var r=null;switch(e){case t.EBufferDataType.VERTICE:r=this.getVertice(e);break;case t.EBufferDataType.NORMAL:r=this.getNormal(e);break;case t.EBufferDataType.TANGENT:r=this._getTangent(e);break;case t.EBufferDataType.COLOR:r=this._getColor(e);break;case t.EBufferDataType.INDICE:r=this._getIndice(e);break;case t.EBufferDataType.TEXCOORD:r=this._getTexCoord(e);break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("EBufferDataType: "+e))}return r},e.prototype.dispose=function(){this.container.forEach(function(t){t.dispose()}),this.geometryData.dispose(),this._materialChangeSubscription&&this._materialChangeSubscription.dispose()},e.prototype.createBuffersFromGeometryData=function(){this.getChild(t.EBufferDataType.VERTICE),this.getChild(t.EBufferDataType.NORMAL),this.getChild(t.EBufferDataType.TANGENT),this.getChild(t.EBufferDataType.COLOR),this.getChild(t.EBufferDataType.INDICE),this.getChild(t.EBufferDataType.TEXCOORD)},e.prototype.createBufferOnlyOnce=function(t,e){this[t]||(this[t]=e.create())},e.prototype.hasData=function(t){return t&&t.length>0},e.prototype._getTangent=function(e){var r=null;return r=this.geometryData[t.BufferDataTable.getGeometryDataName(e)],this.hasData(r)?(this.createBufferOnlyOnce("_tangentBuffer",t.ArrayBuffer),this._tangentBuffer.resetData(new Float32Array(r),3,t.EBufferType.FLOAT),this._tangentBuffer):null},e.prototype._getColor=function(e){var r=null;return r=this.geometryData[t.BufferDataTable.getGeometryDataName(e)],this.hasData(r)?(this.createBufferOnlyOnce("_colorBuffer",t.ArrayBuffer),this._colorBuffer.resetData(new Float32Array(r),3,t.EBufferType.FLOAT),this._colorBuffer):null},e.prototype._getIndice=function(e){var r=null;return r=this.geometryData[t.BufferDataTable.getGeometryDataName(e)],this.hasData(r)?(this.createBufferOnlyOnce("_indiceBuffer",t.ElementBuffer),this._indiceBuffer.resetData(new Uint16Array(r),t.EBufferType.UNSIGNED_SHORT),this._indiceBuffer):null},e.prototype._getTexCoord=function(e){var r=null;return r=this.geometryData[t.BufferDataTable.getGeometryDataName(e)],this.hasData(r)?(this.createBufferOnlyOnce("_texCoordBuffer",t.ArrayBuffer),this._texCoordBuffer.resetData(new Float32Array(r),2,t.EBufferType.FLOAT),this._texCoordBuffer):null},e.prototype._needReCalcuteTangent=function(e){return this.geometryData.tangentDirty&&e===t.EBufferDataType.TANGENT},__decorate([t.cache(function(t){return this.container.hasChild(t)&&!this._needReCalcuteTangent(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],e.prototype,"_getTangent",null),__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],e.prototype,"_getColor",null),__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],e.prototype,"_getIndice",null),__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],e.prototype,"_getTexCoord",null),e}();t.BufferContainer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._verticeBuffer=null,this._normalBuffer=null}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.getVertice=function(e){var r=this.geometryData[t.BufferDataTable.getGeometryDataName(e)];return this.hasData(r)?(this.createBufferOnlyOnce("_verticeBuffer",t.ArrayBuffer),this._verticeBuffer.resetData(new Float32Array(r),3,t.EBufferType.FLOAT),this._verticeBuffer):null},r.prototype.getNormal=function(e){var r=this.geometryData[t.BufferDataTable.getGeometryDataName(e)];return this.hasData(r)?(this.createBufferOnlyOnce("_normalBuffer",t.ArrayBuffer),this._normalBuffer.resetData(new Float32Array(r),3,t.EBufferType.FLOAT),this._normalBuffer):null},__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],r.prototype,"getVertice",null),__decorate([t.cache(function(t){return this.container.hasChild(t)},function(t){return this.container.getChild(t)},function(t,e){this.container.addChild(e,t)})],r.prototype,"getNormal",null),
r}(t.BufferContainer);t.CommonBufferContainer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(t,r){e.call(this,t),this._animation=null,this._isCacheChangeFlag={},this._isCacheChangeInLastLoop={},this._currentVerticeBuffer=null,this._nextVerticeBuffer=null,this._currentNormalBuffer=null,this._nextNormalBuffer=null,this._animation=r}return __extends(r,e),r.create=function(t,e){var r=new this(t,e);return r},r.prototype.getVertice=function(t){return this._getMorphData(t,this.geometryData.morphTargets)},r.prototype.getNormal=function(t){return this._getMorphData(t,this.geometryData.morphNormals)},r.prototype._getMorphData=function(e,r){var n=null,o=null,i=null;if(this._isNotPlayAnimation())return this._getStaticData(e);if(0===r.getCount())return null;if(o=r.getChild(this._animation.currentAnimName),wdCb.Log.error(!o,wdCb.Log.info.FUNC_SHOULD('"'+this._animation.currentAnimName+'" animation',"contain frame data")),n=this.container.getChild(e))if(this._animation.isFrameChange&&(this._isCacheChangeInLastLoop[e]||this._isCacheNotChange(e))){var a=n[0],s=n[1],c=null,u=null;c=s,u=a.resetData(new Float32Array(o.getChild(this._animation.nextFrame))),i=[c,u],this.container.addChild(e,i),this._isCacheChangeFlag[e]=!0,this._isCacheChangeInLastLoop[e]=!0}else this._isCacheChangeFlag[e]=!1,this._isCacheChangeInLastLoop[e]=!1,i=n;else{var a=this._getCurrentBuffer(e),s=this._getNextBuffer(e);a.resetData(new Float32Array(o.getChild(this._animation.currentFrame)),3,t.EBufferType.FLOAT),s.resetData(new Float32Array(o.getChild(this._animation.nextFrame)),3,t.EBufferType.FLOAT),i=[a,s],this.container.addChild(e,i),this._isCacheChangeInLastLoop[e]=!1}return i},r.prototype._getCurrentBuffer=function(e){return e===t.EBufferDataType.VERTICE?(this.createBufferOnlyOnce("_currentVerticeBuffer",t.ArrayBuffer),this._currentVerticeBuffer):(this.createBufferOnlyOnce("_currentNormalBuffer",t.ArrayBuffer),this._currentNormalBuffer)},r.prototype._getNextBuffer=function(e){return e===t.EBufferDataType.VERTICE?(this.createBufferOnlyOnce("_nextVerticeBuffer",t.ArrayBuffer),this._nextVerticeBuffer):(this.createBufferOnlyOnce("_nextNormalBuffer",t.ArrayBuffer),this._nextNormalBuffer)},r.prototype._isCacheNotChange=function(t){return!this._isCacheChangeFlag[t]},r.prototype._isNotPlayAnimation=function(){return null===this._animation.currentAnimName},r.prototype._getStaticData=function(e){var r=null,n=null;switch(e){case t.EBufferDataType.VERTICE:r=this.geometryData.vertices;break;case t.EBufferDataType.NORMAL:r=this.geometryData.normals;break;default:t.Log.error(!0,t.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))}return this.hasData(r)?(this._animation.interpolation=0,n=[this._getCurrentBuffer(e).resetData(new Float32Array(r),3,t.EBufferType.FLOAT),this._getNextBuffer(e).resetData(new Float32Array(r),3,t.EBufferType.FLOAT)]):null},r.prototype._getStaticDataCacheData=function(t){return"static_"+t},__decorate([t.require(function(e){t.assert(this.geometryData.morphTargets&&this.geometryData.morphTargets.getCount()>0,t.Log.info.FUNC_SHOULD("set morphTargets"))})],r.prototype,"getVertice",null),__decorate([t.require(function(e){t.assert(this.geometryData.morphTargets&&this.geometryData.morphTargets.getCount()>0,t.Log.info.FUNC_SHOULD("set morphTargets"))})],r.prototype,"getNormal",null),__decorate([t.require(function(e){t.assert(e===t.EBufferDataType.VERTICE||e===t.EBufferDataType.NORMAL,t.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))})],r.prototype,"_getCurrentBuffer",null),__decorate([t.require(function(e){t.assert(e===t.EBufferDataType.VERTICE||e===t.EBufferDataType.NORMAL,t.Log.info.FUNC_SHOULD("type","be EBufferDataType.VERTICE or EBufferDataType.NORMAL"))})],r.prototype,"_getNextBuffer",null),__decorate([t.cache(function(t){return this.container.hasChild(this._getStaticDataCacheData(t))},function(t){return this.container.getChild(this._getStaticDataCacheData(t))},function(t,e){this.container.addChild(this._getStaticDataCacheData(e),t)})],r.prototype,"_getStaticData",null),r}(t.BufferContainer);t.MorphBufferContainer=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this._worldToCameraMatrix=null,this._near=null,this._far=null,this.pMatrix=t.Matrix4.create(),this.entityObject=null,this.dirty=!1}return Object.defineProperty(e.prototype,"cameraToWorldMatrix",{get:function(){return this.entityObject.transform.localToWorldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"worldToCameraMatrix",{get:function(){return this._worldToCameraMatrix?this._worldToCameraMatrix:this.cameraToWorldMatrix.copy().invert()},set:function(t){this._worldToCameraMatrix=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"near",{get:function(){return this._near},set:function(t){this._near=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"far",{get:function(){return this._far},set:function(t){this._far=t,this.dirty=!0},enumerable:!0,configurable:!0}),e.prototype.init=function(){this.dirty&&(this.updateProjectionMatrix(),this.dirty=!1)},e.prototype.dispose=function(){},e.prototype.update=function(t){this.dirty&&(this.updateProjectionMatrix(),this.dirty=!1)},e.prototype.getInvViewProjMat=function(){return this.pMatrix.copy().multiply(this.worldToCameraMatrix).invert()},__decorate([t.requireGetter(function(){t.assert(this.entityObject,t.Log.info.FUNC_MUST_DEFINE("entityObject"))})],e.prototype,"cameraToWorldMatrix",null),__decorate([t.virtual],e.prototype,"init",null),__decorate([t.virtual],e.prototype,"dispose",null),e}();t.Camera=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._left=null,this._right=null,this._bottom=null,this._top=null}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"left",{get:function(){return this._left},set:function(t){this._left=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this._right},set:function(t){this._right=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bottom",{get:function(){return this._bottom},set:function(t){this._bottom=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"top",{get:function(){return this._top},set:function(t){this._top=t,this.dirty=!0},enumerable:!0,configurable:!0}),r.prototype.convertScreenToWorld=function(e,r,n){var o=t.DeviceManager.getInstance(),i=o.view.width,a=o.view.height,s=t.Vector3.create(2*e/i-1,(a-r)/a*2-1,(n-this.far)/(this.far-this.near)*2+1);return this.getInvViewProjMat().multiplyPoint(s)},r.prototype.updateProjectionMatrix=function(){this.pMatrix.setOrtho(this._left,this._right,this._bottom,this._top,this.near,this.far)},r}(t.Camera);t.OrthographicCamera=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._fovy=null,this._aspect=null}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"fovy",{get:function(){return this._fovy},set:function(t){this._fovy=t,this.dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"aspect",{get:function(){return this._aspect},set:function(t){this._aspect=t,this.dirty=!0},enumerable:!0,configurable:!0}),r.prototype.zoomIn=function(t,e){void 0===e&&(e=1),this.fovy=Math.max(this.fovy-t,e)},r.prototype.zoomOut=function(t,e){void 0===e&&(e=179),this.fovy=Math.min(this.fovy+t,e)},r.prototype.convertScreenToWorld=function(e,r,n){var o=t.DeviceManager.getInstance(),i=o.view.width,a=o.view.height,s=t.Vector3.create(2*e/i-1,1-2*r/a,1),c=this.getInvViewProjMat(),u=null,l=null;return u=c.multiplyPoint(s),l=s.x*c.values[3]+s.y*c.values[7]+s.z*c.values[11]+c.values[15],u.scale(1/l),t.Vector3.create().lerp(this.entityObject.transform.position,u,n/this.far)},r.prototype.updateProjectionMatrix=function(){this.pMatrix.setPerspective(this._fovy,this._aspect,this.near,this.far)},r}(t.Camera);t.PerspectiveCamera=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(t){e.call(this),this.camera=null,this._worldToCameraMatrixCache=null,this._clearCacheSubscription=null,this.camera=t}return __extends(r,e),Object.defineProperty(r.prototype,"cameraToWorldMatrix",{get:function(){return this.camera.cameraToWorldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"worldToCameraMatrix",{get:function(){return this._getWorldToCameraMatrix()},set:function(t){this.camera.worldToCameraMatrix=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pMatrix",{get:function(){return this.camera.pMatrix},set:function(t){this.camera.pMatrix=t},enumerable:!0,configurable:!0}),r.prototype.init=function(){var e=this;this.camera.entityObject=this.entityObject,this.camera.init(),this._clearCacheSubscription=wdFrp.fromArray([t.EventManager.fromEvent(t.EEngineEvent.ENDLOOP),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_TRANSLATE),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_ROTATE),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_SCALE)]).mergeAll().subscribe(function(){e._clearCache()})},r.prototype.update=function(t){this.camera.update(t)},r.prototype.dispose=function(){this.camera.dispose(),this._clearCacheSubscription&&this._clearCacheSubscription.dispose()},r.prototype.isIntersectWithRay=function(e,r,n){var o=null;return e.hasComponent(t.Collider)?(o=e.getComponent(t.Collider).shape,o.isIntersectWithRay(this.createRay(r,n))):!1},r.prototype.createRay=function(e,r){var n=this.convertScreenToWorld(e,r,this.camera.near),o=this.convertScreenToWorld(e,r,this.camera.far);return t.Ray.create(n,o.sub(n))},r.prototype.convertScreenToWorld=function(t,e,r){return this.camera.convertScreenToWorld(t,e,r)},r.prototype.getPlanes=function(){for(var e=[],r=this.worldToCameraMatrix.applyMatrix(this.pMatrix,!0),n=0;6>n;n++)e.push(t.Plane.create(0,0,0,0));return this._setPlanes(r,e),e},r.prototype._setPlanes=function(t,e){e[0].normal.x=t.values[3]+t.values[2],e[0].normal.y=t.values[7]+t.values[6],e[0].normal.z=t.values[11]+t.values[10],e[0].d=t.values[15]+t.values[14],e[0].normalize(),e[1].normal.x=t.values[3]-t.values[2],e[1].normal.y=t.values[7]-t.values[6],e[1].normal.z=t.values[11]-t.values[10],e[1].d=t.values[15]-t.values[14],e[1].normalize(),e[2].normal.x=t.values[3]+t.values[0],e[2].normal.y=t.values[7]+t.values[4],e[2].normal.z=t.values[11]+t.values[8],e[2].d=t.values[15]+t.values[12],e[2].normalize(),e[3].normal.x=t.values[3]-t.values[0],e[3].normal.y=t.values[7]-t.values[4],e[3].normal.z=t.values[11]-t.values[8],e[3].d=t.values[15]-t.values[12],e[3].normalize(),e[4].normal.x=t.values[3]-t.values[1],e[4].normal.y=t.values[7]-t.values[5],e[4].normal.z=t.values[11]-t.values[9],e[4].d=t.values[15]-t.values[13],e[4].normalize(),e[5].normal.x=t.values[3]+t.values[1],e[5].normal.y=t.values[7]+t.values[5],e[5].normal.z=t.values[11]+t.values[9],e[5].d=t.values[15]+t.values[13],e[5].normalize()},r.prototype._clearCache=function(){this._worldToCameraMatrixCache=null},r.prototype._getWorldToCameraMatrix=function(){return this.camera.worldToCameraMatrix},__decorate([t.cacheGetter(function(){return null!==this._worldToCameraMatrixCache},function(){return this._worldToCameraMatrixCache},function(t){this._worldToCameraMatrixCache=t})],r.prototype,"worldToCameraMatrix",null),r}(t.Component);t.CameraController=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e}(t.CameraController);t.BasicCameraController=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(r){e.call(this,r),this._control=null,r instanceof t.PerspectiveCamera?this._control=t.FlyPerspectiveCameraControl.create(r):this._control=t.FlyOrthographicCameraControl.create(r)}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.init=function(){e.prototype.init.call(this),this._control.init(this.entityObject)},r.prototype.update=function(t){e.prototype.update.call(this,t),this._control.update(t)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._control.dispose()},r}(t.CameraController);t.FlyCameraController=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this.moveSpeed=1.2,this.rotateSpeed=100,this.cameraComponent=null,this._rotateX=0,this._rotateY=0,this._isRotate=!1,this._mouseDragSubscription=null,this._keydownSubscription=null,this._gameObject=null,this.cameraComponent=t}return e.prototype.init=function(t){var e=t.transform.eulerAngles;this._rotateX=e.x,this._rotateY=e.y,this._gameObject=t,this._bindCanvasEvent()},e.prototype.update=function(e){this._isRotate&&(this._isRotate=!1,this._gameObject.transform.eulerAngles=t.Vector3.create(this._rotateX,this._rotateY,0))},e.prototype.dispose=function(){this._removeEvent()},e.prototype._move=function(e){var r=this.moveSpeed,n=this._gameObject,o=e.keyState;o.a||o.left?n.transform.translateLocal(t.Vector3.create(-r,0,0)):o.d||o.right?n.transform.translateLocal(t.Vector3.create(r,0,0)):o.w||o.up?n.transform.translateLocal(t.Vector3.create(0,0,-r)):(o.s||o.down)&&n.transform.translateLocal(t.Vector3.create(0,0,r))},e.prototype._bindCanvasEvent=function(){var e=this,r=this.rotateSpeed,n=t.EventManager.fromEvent(t.Director.getInstance().scene,t.EEngineEvent.MOUSE_DRAG),o=t.EventManager.fromEvent(t.EEventName.KEYDOWN),i=t.Director.getInstance().view;this._mouseDragSubscription=n.map(function(t){var n=t.userData.movementDelta,o=null,a=null,s=r/i.height;return o=s*n.x,a=s*n.y,e._isRotate=!0,{dx:o,dy:a}}).subscribe(function(t){e._rotateY-=t.dx,e._rotateX-=t.dy}),this._keydownSubscription=o.subscribe(function(t){e._move(t),e.zoom(t)})},e.prototype._removeEvent=function(){this._mouseDragSubscription.dispose(),this._keydownSubscription.dispose()},e}();t.FlyCameraControl=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.zoomSpeed=10}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.zoom=function(t){var e=this.zoomSpeed,r=t.keyState;r.g?this.cameraComponent.zoomIn(e):r.h&&this.cameraComponent.zoomOut(e)},e}(t.FlyCameraControl);t.FlyPerspectiveCameraControl=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.zoom=function(t){},e}(t.FlyCameraControl);t.FlyOrthographicCameraControl=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.moveSpeedX=1,this.moveSpeedY=1,this.rotateSpeed=1,this.wheelSpeed=1,this.distance=10,this.phi=Math.PI/2,this.theta=Math.PI/2,this.target=t.Vector3.create(0,0,0),this.thetaMargin=.05,this.minDistance=.05,this._isChange=!0,this._mouseDragSubscription=null,this._mouseWheelSubscription=null,this._keydownSubscription=null}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.init=function(){e.prototype.init.call(this),this._bindCanvasEvent()},r.prototype.update=function(r){var n=null,o=null,i=null;e.prototype.update.call(this,r),this._isChange&&(this._isChange=!1,n=this.distance*Math.cos(this.phi)*Math.sin(this.theta)+this.target.x,i=this.distance*Math.sin(this.phi)*Math.sin(this.theta)+this.target.z,o=this.distance*Math.cos(this.theta)+this.target.y,this.entityObject.transform.position=t.Vector3.create(n,o,i),this.entityObject.transform.lookAt(this.target))},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._removeEvent()},r.prototype._bindCanvasEvent=function(){var e=this,r=t.Director.getInstance().scene,n=t.EventManager.fromEvent(r,t.EEngineEvent.MOUSE_WHEEL),o=t.EventManager.fromEvent(r,t.EEngineEvent.MOUSE_DRAG),i=t.EventManager.fromEvent(t.EEventName.KEYDOWN);this._mouseDragSubscription=o.subscribe(function(t){e._changeOrbit(t.userData)}),this._mouseWheelSubscription=n.subscribe(function(t){var r=t.userData;r.preventDefault(),e._changeDistance(r)}),this._keydownSubscription=i.subscribe(function(t){e._changeTarget(t)})},r.prototype._changeOrbit=function(t){var e=t.movementDelta;this._isChange=!0,this.phi+=e.x/(100/this.rotateSpeed),this.theta-=e.y/(100/this.rotateSpeed),this._contrainTheta()},r.prototype._changeTarget=function(e){var r=this.moveSpeedX,n=this.moveSpeedY,o=null,i=null,a=e.keyState,s=this.entityObject.transform;this._isChange=!0,a.a||a.left?o=-r:a.d||a.right?o=r:a.w||a.up?i=n:(a.s||a.down)&&(i=-n),this.target.add(t.Vector3.create(s.right.x*o,0,s.right.z*o)),this.target.add(t.Vector3.create(s.up.x*i,s.up.y*i,0))},r.prototype._changeDistance=function(t){this._isChange=!0,this.distance-=this.wheelSpeed*t.wheel,this._contrainDistance()},r.prototype._contrainDistance=function(){this.distance=t.MathUtils.bigThan(this.distance,this.minDistance)},r.prototype._contrainTheta=function(){this.theta=t.MathUtils.clamp(this.theta,this.thetaMargin,Math.PI-this.thetaMargin)},r.prototype._removeEvent=function(){this._mouseDragSubscription.dispose(),this._mouseWheelSubscription.dispose(),this._keydownSubscription.dispose()},r}(t.CameraController);t.ArcballCameraController=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.p_target=null,this.isFinish=!1}return __extends(r,e),Object.defineProperty(r.prototype,"isStart",{get:function(){return!this.isStop},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isStop",{get:function(){return t.Log.error(!0,t.Log.info.ABSTRACT_ATTRIBUTE)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isPause",{get:function(){return t.Log.error(!0,t.Log.info.ABSTRACT_ATTRIBUTE)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"target",{get:function(){return this.p_target},set:function(t){this.p_target=t},enumerable:!0,configurable:!0}),r.prototype.reset=function(){this.isFinish=!1},r.prototype.addToObject=function(t){e.prototype.addToObject.call(this,t),this.target=t,t.actionManager.addChild(this)},r.prototype.removeFromObject=function(t){e.prototype.removeFromObject.call(this,t),t.actionManager.removeChild(this)},r.prototype.init=function(){this.start()},r.prototype.finish=function(){this.isFinish=!0,this.stop()},r}(t.Component);t.Action=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"isStop",{get:function(){return!1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isPause",{get:function(){return!1},enumerable:!0,configurable:!0}),e.prototype.start=function(){},e.prototype.stop=function(){},e.prototype.pause=function(){},e.prototype.resume=function(){},e}(t.Action);t.ActionInstant=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(r,n,o){e.call(this),this._context=null,this._callFunc=null,this._dataArr=null,this._context=n||t.root,this._callFunc=r,this._dataArr=wdCb.Collection.create(o)}return __extends(r,e),r.create=function(t,e){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var o=Array.prototype.slice.call(arguments,2),i=new this(t,e,o);return i},r.prototype.reverse=function(){return this},r.prototype.update=function(t){this._callFunc&&this._callFunc.call(this._context,this.p_target,this._dataArr),this.finish()},r.prototype.copy=function(){return new r(this._context,this._callFunc,this._dataArr.copy(!0).getChildren())},r}(t.ActionInstant);t.CallFunc=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.elapsed=null,this.duration=null,this._isStop=!0,this._isPause=!1,this._timeController=t.CommonTimeController.create()}return __extends(r,e),Object.defineProperty(r.prototype,"isStop",{get:function(){return this._isStop},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isPause",{get:function(){return this._isPause},enumerable:!0,configurable:!0}),r.prototype.update=function(t){t<this._timeController.startTime||(this.elapsed=this._convertToRatio(this._timeController.computeElapseTime(t)),this.updateBody(t),1===this.elapsed&&this.finish())},r.prototype.start=function(){this._isStop=!1,this._timeController.start()},r.prototype.stop=function(){this._isStop=!0,this._timeController.stop()},r.prototype.reset=function(){e.prototype.reset.call(this),this._isStop=!0},r.prototype.pause=function(){this._isPause=!0,this._timeController.pause()},r.prototype.resume=function(){this._isPause=!1,this._timeController.resume()},r.prototype.updateBody=function(t){},r.prototype._convertToRatio=function(t){var e=t/this.duration;return e>1?1:e},__decorate([t.virtual],r.prototype,"updateBody",null),r}(t.Action);t.ActionInterval=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"target",{set:function(t){this.p_target=t,this.getInnerActions().forEach(function(e){e.target=t})},enumerable:!0,configurable:!0}),e.prototype.init=function(){t.prototype.init.call(this),this.iterate("init")},e.prototype.reverse=function(){return this.iterate("reverse"),this},e.prototype.reset=function(){return t.prototype.reset.call(this),this.iterate("reset"),this},e.prototype.iterate=function(t,e){this.getInnerActions().forEach(function(r){r[t].apply(r,e)})},e}(t.ActionInterval);t.Control=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(t){e.call(this),this._actions=wdCb.Collection.create(),this._currentAction=null,this._actionIndex=0,this._actions.addChildren(t)}return __extends(r,e),r.create=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null;return t.Log.assert(e.length>=2,"Sequence should has two actions at least"),n=new this(e),n.initWhenCreate(),n},r.prototype.initWhenCreate=function(){this._currentAction=this._actions.getChild(0)},r.prototype.update=function(t){return this._actionIndex===this._actions.getCount()?void this.finish():(this._currentAction=this._actions.getChild(this._actionIndex),this._currentAction.isFinish?void this._startNextActionAndJudgeFinish():(this._currentAction.update(t),this._currentAction.isFinish&&this._startNextActionAndJudgeFinish(),null))},r.prototype.copy=function(){var t=[];return this._actions.forEach(function(e){t.push(e.copy())}),r.create.apply(r,t)},r.prototype.reset=function(){return e.prototype.reset.call(this),this._actionIndex=0,this._currentAction=this._actions.getChild(this._actionIndex),this},r.prototype.start=function(){return e.prototype.start.call(this),this._currentAction.start(),this},r.prototype.stop=function(){return e.prototype.stop.call(this),this._currentAction.stop(),this},r.prototype.pause=function(){return e.prototype.pause.call(this),this._currentAction.pause(),this},r.prototype.resume=function(){return e.prototype.resume.call(this),this._currentAction.resume(),this},r.prototype.reverse=function(){return this._actions=this._actions.reverse(),e.prototype.reverse.call(this),this},r.prototype.getInnerActions=function(){return this._actions},r.prototype._startNextActionAndJudgeFinish=function(){return this._actionIndex++,this._actionIndex===this._actions.getCount()?void this.finish():void this._actions.getChild(this._actionIndex).start()},r}(t.Control);t.Sequence=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(t){e.call(this),this._actions=wdCb.Collection.create(),this._actions.addChildren(t)}return __extends(r,e),r.create=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null;return t.Log.assert(e.length>=2,"Sequence should has two actions at least"),n=new this(e)},r.prototype.update=function(t){return this._isFinish()?void this.finish():(this.iterate("update",[t]),void(this._isFinish()&&this.finish()))},r.prototype.start=function(){return e.prototype.start.call(this),this.iterate("start"),this},r.prototype.stop=function(){return e.prototype.stop.call(this),this.iterate("stop"),this},r.prototype.pause=function(){return e.prototype.pause.call(this),this.iterate("pause"),this},r.prototype.resume=function(){return e.prototype.resume.call(this),this.iterate("resume"),this},r.prototype.copy=function(){var t=[];return this._actions.forEach(function(e){t.push(e.copy())}),r.create.apply(r,t)},r.prototype.reset=function(){return e.prototype.reset.call(this),this.iterate("reset"),this},r.prototype.reverse=function(){return this._actions=this._actions.reverse(),e.prototype.reverse.call(this),this},r.prototype.getInnerActions=function(){return this._actions},r.prototype.iterate=function(t,e){this._actions.forEach(function(r){r[t].apply(r,e)})},r.prototype._isFinish=function(){var t=!0;return this._actions.forEach(function(e){return e.isFinish?void 0:(t=!1,wdCb.$BREAK)}),t},r}(t.Control);t.Spawn=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(e){t.call(this),this.duration=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.reverse=function(){return this},e.prototype.copy=function(){return e.create(this.duration)},e}(t.ActionInterval);t.DelayTime=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(e,r){t.call(this),this._innerAction=null,this._originTimes=null,this._times=null,this._innerAction=e,this._times=r}return __extends(e,t),e.create=function(t,e){var r=new this(t,e);return r.initWhenCreate(),r},e.prototype.initWhenCreate=function(){this._originTimes=this._times},e.prototype.update=function(t){if(0===this._times)return void this.finish();if(this._innerAction.update(t),this._innerAction.isFinish){if(this._times-=1,0!==this._times)return this._innerAction.reset(),void this._innerAction.start();this.finish()}},e.prototype.copy=function(){return e.create(this._innerAction.copy(),this._times)},e.prototype.reset=function(){return t.prototype.reset.call(this),this._times=this._originTimes,this},e.prototype.start=function(){t.prototype.start.call(this),this._innerAction.start()},e.prototype.stop=function(){t.prototype.stop.call(this),this._innerAction.stop()},e.prototype.pause=function(){t.prototype.pause.call(this),this._innerAction.pause()},e.prototype.resume=function(){t.prototype.resume.call(this),this._innerAction.resume()},e.prototype.getInnerActions=function(){return wdCb.Collection.create([this._innerAction])},e}(t.Control);t.Repeat=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(e){t.call(this),this._innerAction=null,this._innerAction=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.update=function(t){this._innerAction.update(t),this._innerAction.isFinish&&(this._innerAction.reset(),this._innerAction.start())},e.prototype.copy=function(){return e.create(this._innerAction.copy())},e.prototype.start=function(){
t.prototype.start.call(this),this._innerAction.start()},e.prototype.stop=function(){t.prototype.stop.call(this),this._innerAction.stop()},e.prototype.pause=function(){t.prototype.pause.call(this),this._innerAction.pause()},e.prototype.resume=function(){t.prototype.resume.call(this),this._innerAction.resume()},e.prototype.getInnerActions=function(){return wdCb.Collection.create([this._innerAction])},e}(t.Control);t.RepeatForever=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._object=null,this._valuesStart=wdCb.Hash.create(),this._valuesEnd=wdCb.Hash.create(),this._easingFunction=r.Easing.Linear.None,this._interpolationFunction=r.Interpolation.Linear,this._onStartCallback=null,this._onStartCallbackFired=!1,this._onUpdateCallback=null,this._onFinishCallback=null,this._onStopCallback=null}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.updateBody=function(e){var r=this,n=null;return this._onStartCallbackFired===!1&&(null!==this._onStartCallback&&this._onStartCallback.call(this._object.getChildren()),this._onStartCallbackFired=!0),n=this._easingFunction(this.elapsed),this._valuesEnd.forEach(function(e,o){var i=r._valuesStart.getChild(o),a=e;a instanceof Array?r._object.setValue(o,r._interpolationFunction(a,n)):(t.JudgeUtils.isString(a)&&(a=i+t.root.parseFloat(a,10)),t.JudgeUtils.isNumber(a)&&r._object.setValue(o,i+(a-i)*n))}),null!==this._onUpdateCallback&&this._onUpdateCallback.call(this._object.getChildren(),n),!0},r.prototype.from=function(e){var r=this;return this._object=wdCb.Hash.create(e),this._object.forEach(function(e,n){r._valuesStart.addChild(n,t.root.parseFloat(e,10))}),this},r.prototype.to=function(t,e){return void 0===e&&(e=1e3),this.duration=e,this._valuesEnd=wdCb.Hash.create(t),this},r.prototype.init=function(){var t=this;e.prototype.init.call(this),this._valuesEnd.forEach(function(e,r){if(e instanceof Array){if(0===e.length)return;t._valuesEnd.setValue(r,[t._object.getChild(r)].concat(t._valuesEnd.getChild(r)))}t._valuesStart.setValue(r,t._object.getChild(r)),t._valuesStart.getChild(r)instanceof Array==!1&&t._valuesStart.setValue(r,1*t._valuesStart.getChild(r))})},r.prototype.start=function(){return e.prototype.start.call(this),this._onStartCallbackFired=!1,this},r.prototype.stop=function(){return e.prototype.stop.call(this),null!==this._onStopCallback&&this._onStopCallback.call(this._object.getChildren()),this},r.prototype.copy=function(){return r.create().from(this._valuesStart.getChildren()).to(this._valuesEnd.getChildren(),this.duration).easing(this._easingFunction).interpolation(this._interpolationFunction).onStart(this._onStartCallback).onStop(this._onStopCallback).onFinish(this._onFinishCallback).onUpdate(this._onUpdateCallback)},r.prototype.reverse=function(){var t=this._valuesStart;this._valuesStart=this._valuesEnd,this._valuesEnd=t},r.prototype.easing=function(t){return this._easingFunction=t,this},r.prototype.interpolation=function(t){return this._interpolationFunction=t,this},r.prototype.onUpdate=function(t){return this._onUpdateCallback=t,this},r.prototype.onFinish=function(t){return this._onFinishCallback=t,this},r.prototype.onStart=function(t){return this._onStartCallback=t,this},r.prototype.onStop=function(t){return this._onStopCallback=t,this},r.prototype.finish=function(){e.prototype.finish.call(this),null!==this._onFinishCallback&&this._onFinishCallback.call(this._object.getChildren())},r.Easing={Linear:{None:function(t){return t}},Quadratic:{In:function(t){return t*t},Out:function(t){return t*(2-t)},InOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}},Cubic:{In:function(t){return t*t*t},Out:function(t){return--t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}},Quartic:{In:function(t){return t*t*t*t},Out:function(t){return 1- --t*t*t*t},InOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}},Quintic:{In:function(t){return t*t*t*t*t},Out:function(t){return--t*t*t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}},Sinusoidal:{In:function(t){return 1-Math.cos(t*Math.PI/2)},Out:function(t){return Math.sin(t*Math.PI/2)},InOut:function(t){return.5*(1-Math.cos(Math.PI*t))}},Exponential:{In:function(t){return 0===t?0:Math.pow(1024,t-1)},Out:function(t){return 1===t?1:1-Math.pow(2,-10*t)},InOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(-Math.pow(2,-10*(t-1))+2)}},Circular:{In:function(t){return 1-Math.sqrt(1-t*t)},Out:function(t){return Math.sqrt(1- --t*t)},InOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}},Elastic:{In:function(t){var e,r=.1,n=.4;return 0===t?0:1===t?1:(!r||1>r?(r=1,e=n/4):e=n*Math.asin(1/r)/(2*Math.PI),-(r*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/n)))},Out:function(t){var e,r=.1,n=.4;return 0===t?0:1===t?1:(!r||1>r?(r=1,e=n/4):e=n*Math.asin(1/r)/(2*Math.PI),r*Math.pow(2,-10*t)*Math.sin((t-e)*(2*Math.PI)/n)+1)},InOut:function(t){var e,r=.1,n=.4;return 0===t?0:1===t?1:(!r||1>r?(r=1,e=n/4):e=n*Math.asin(1/r)/(2*Math.PI),(t*=2)<1?-.5*(r*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/n)):r*Math.pow(2,-10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/n)*.5+1)}},Back:{In:function(t){var e=1.70158;return t*t*((e+1)*t-e)},Out:function(t){var e=1.70158;return--t*t*((e+1)*t+e)+1},InOut:function(t){var e=2.5949095;return(t*=2)<1?.5*(t*t*((e+1)*t-e)):.5*((t-=2)*t*((e+1)*t+e)+2)}},Bounce:{In:function(t){return 1-r.Easing.Bounce.Out(1-t)},Out:function(t){return 1/2.75>t?7.5625*t*t:2/2.75>t?7.5625*(t-=1.5/2.75)*t+.75:2.5/2.75>t?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},InOut:function(t){return.5>t?.5*r.Easing.Bounce.In(2*t):.5*r.Easing.Bounce.Out(2*t-1)+.5}}},r.Interpolation={Linear:function(t,e){var n=t.length-1,o=n*e,i=Math.floor(o),a=r.Interpolation.Utils.Linear;return 0>e?a(t[0],t[1],o):e>1?a(t[n],t[n-1],n-o):a(t[i],t[i+1>n?n:i+1],o-i)},Bezier:function(t,e){var n,o=0,i=t.length-1,a=Math.pow,s=r.Interpolation.Utils.Bernstein;for(n=0;i>=n;n++)o+=a(1-e,i-n)*a(e,n)*t[n]*s(i,n);return o},CatmullRom:function(t,e){var n=t.length-1,o=n*e,i=Math.floor(o),a=r.Interpolation.Utils.CatmullRom;return t[0]===t[n]?(0>e&&(i=Math.floor(o=n*(1+e))),a(t[(i-1+n)%n],t[i],t[(i+1)%n],t[(i+2)%n],o-i)):0>e?t[0]-(a(t[0],t[0],t[1],t[1],-o)-t[0]):e>1?t[n]-(a(t[n],t[n],t[n-1],t[n-1],o-n)-t[n]):a(t[i?i-1:0],t[i],t[i+1>n?n:i+1],t[i+2>n?n:i+2],o-i)},Utils:{Linear:function(t,e,r){return(e-t)*r+t},Bernstein:function(t,e){var n=r.Interpolation.Utils.Factorial;return n(t)/n(e)/n(t-e)},Factorial:function(){var t=[1];return function(e){var r,n=1;if(t[e])return t[e];for(r=e;r>1;r--)n*=r;return t[e]=n}}(),CatmullRom:function(t,e,r,n,o){var i=.5*(r-t),a=.5*(n-e),s=o*o,c=o*s;return(2*e-2*r+i+a)*c+(-3*e+3*r-2*i-a)*s+i*o+e}}},r}(t.ActionInterval);t.Tween=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.Component);t.RendererComponent=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.render=function(t,e,r){t.addCommand(this.createDrawCommand(e,r))},r.prototype.createDrawCommand=function(e,r){var n=t.QuadCommand.create(),o=r.getComponent(t.CameraController),i=e.material,a=this.entityObject.transform.position;return n.buffers=e.buffers,n.animation=e.entityObject.getComponent(t.Animation),n.drawMode=e.drawMode,n.mMatrix=this.entityObject.transform.localToWorldMatrix,n.vMatrix=o.worldToCameraMatrix,n.pMatrix=o.pMatrix,n.material=i,n.z=a.z,n.blend=i.blend,n},__decorate([t.require(function(e,r){var n=r.getComponent(t.CameraController);t.assert(!!n&&!!n.camera,t.Log.info.FUNC_MUST("camera","add Camera Component")),t.assert(!!e,t.Log.info.FUNC_MUST("Mesh","add geometry component"))})],r.prototype,"createDrawCommand",null),r}(t.RendererComponent);t.MeshRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.render=function(t,e,r){t.skyboxCommand=this.createDrawCommand(e,r)},e}(t.MeshRenderer);t.SkyboxRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._zIndex=1,this.dirtyDuringCurrentLoop=!1,this._dirty=!0,this.context=null,this.isClearCanvas=!1,this.state=t.EUIRendererState.NORMAL,this.canvas=null,this._referenceList=wdCb.Collection.create()}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(r.prototype,"zIndex",{get:function(){return this._zIndex},set:function(t){t!==this._zIndex&&(this._zIndex=t,this.canvas&&wdCb.DomQuery.create(this.canvas).css("zIndex",t))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"dirty",{get:function(){return this._dirty},set:function(t){t&&(this._dirty=!0,this.dirtyDuringCurrentLoop=!0)},enumerable:!0,configurable:!0}),r.prototype.resetDirty=function(){this._dirty=!1},r.prototype.addToObject=function(t){this._referenceList.addChild(t),this.entityObject=t},r.prototype.removeFromObject=function(t){this._referenceList.removeChild(t),this._referenceList.getCount()>0||e.prototype.removeFromObject.call(this,t)},r.prototype.init=function(){},r.prototype.initWhenCreate=function(){this._createOverlayCanvas()},r.prototype.dispose=function(){this._referenceList.getCount()>0||wdCb.DomQuery.create(this.canvas).remove()},r.prototype.render=function(t,e,r){},r.prototype.clearCanvas=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.isClearCanvas=!0},r.prototype._createOverlayCanvas=function(){var e=null,r=null;this.canvas||(e=wdCb.DomQuery.create("<canvas></canvas>").prependTo("body"),r=t.DeviceManager.getInstance().view,e.css("position","absolute"),e.css("left",r.x+"px"),e.css("top",r.y+"px"),e.css("zIndex",this.zIndex),e.attr("width",r.width),e.attr("height",r.height),this.canvas=e.get(0),this.context=this.canvas.getContext("2d"))},__decorate([t.execOnlyOnce("_isInit")],r.prototype,"init",null),r}(t.RendererComponent);t.UIRenderer=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.NORMAL=0]="NORMAL",t[t.DIRTY=1]="DIRTY",t[t.NOT_DIRTY=2]="NOT_DIRTY"}(t.EUIRendererState||(t.EUIRendererState={}));t.EUIRendererState}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.Component);t.SpacePartition=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.maxDepth=2,this.maxNodeCapacity=64,this._root=null,this._selectionList=wdCb.Collection.create()}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.addToObject=function(t){e.prototype.addToObject.call(this,t)},r.prototype.build=function(){var e=this.getChildren(),r=0,n=this.maxNodeCapacity,o=this.maxDepth,i=function(e,r,a,s,c){for(var u=new t.Vector3((r.x-e.x)/2,(r.y-e.y)/2,(r.z-e.z)/2),l=0;2>l;l++)for(var h=0;2>h;h++)for(var p=0;2>p;p++){var f=e.copy().add(u.copy().scale(l,h,p)),d=e.copy().add(u.copy().scale(l+1,h+1,p+1)),_=t.OctreeNode.create(f,d,n,a+1,o);_.addEntityObjects(s),_.entityObjectCount>n&&o>a&&i(f,d,a+1,s,_),c.addNode(_)}};this._updateColliderForFirstCheck(e);var a=this._getWorldExtends(e),s=a.worldMin,c=a.worldMax;this._root=t.OctreeNode.create(s,c,n,r+1,o),i(s,c,r,e,this._root)},r.prototype.getRenderListByFrustumCull=function(){var e=t.Director.getInstance().scene.currentCamera.getComponent(t.CameraController).getPlanes();return this._visitRoot("findAndAddToRenderList",[e,this._selectionList])},r.prototype.getIntersectListWithRay=function(e){var r=e.locationInView;return this._visitRoot("findAndAddToIntersectList",[t.Director.getInstance().scene.currentCamera.getComponent(t.CameraController).createRay(r.x,r.y),this._selectionList])},r.prototype.getCollideObjects=function(t){return this._visitRoot("findAndAddToCollideList",[t,this._selectionList])},r.prototype.getChildren=function(){return this.entityObject.getChildren()},r.prototype._visitRoot=function(t,e){return this._selectionList.removeAllChildren(),this._root.nodeList.forEach(function(r){r[t].apply(r,e)}),this._selectionList=this._selectionList.removeRepeatItems(),this._selectionList},r.prototype._updateColliderForFirstCheck=function(e){var r=null,n=this;e.forEach(function(e){e.hasComponent(t.ColliderForFirstCheck)?r=e.getComponent(t.BoxColliderForFirstCheck):(r=n._createCollider(),e.addComponent(r),r.init()),r.update(null)})},r.prototype._getWorldExtends=function(e){var r=t.Vector3.create(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=t.Vector3.create(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),o=this;return e.forEach(function(e){var i=null,a=null,s=null,c=null;s=e.getComponent(t.BoxColliderForFirstCheck),c=s.shape,i=c.getMin(),a=c.getMax(),o._checkExtends(i,r,n),o._checkExtends(a,r,n)}),{worldMin:r,worldMax:n}},r.prototype._createCollider=function(){return t.BoxColliderForFirstCheck.create()},r.prototype._checkExtends=function(t,e,r){t.x<e.x&&(e.x=t.x),t.y<e.y&&(e.y=t.y),t.z<e.z&&(e.z=t.z),t.x>r.x&&(r.x=t.x),t.y>r.y&&(r.y=t.y),t.z>r.z&&(r.z=t.z)},__decorate([t.require(function(e){t.assert(e instanceof t.GameObject,t.Log.info.FUNC_SHOULD("Octree component","add to GameObject"))})],r.prototype,"addToObject",null),__decorate([t.require(function(){t.assert(!!t.Director.getInstance().scene.currentCamera.getComponent(t.CameraController),t.Log.info.FUNC_SHOULD("contain CameraController component"))})],r.prototype,"getRenderListByFrustumCull",null),__decorate([t.require(function(){t.assert(!!t.Director.getInstance().scene.currentCamera.getComponent(t.CameraController),t.Log.info.FUNC_SHOULD("contain CameraController component"))})],r.prototype,"getIntersectListWithRay",null),r}(t.SpacePartition);t.Octree=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(t,e,r,n,o){this.entityObjectList=wdCb.Collection.create(),this.nodeList=wdCb.Collection.create(),this._depth=null,this._maxDepth=null,this._capacity=null,this._minPoint=null,this._maxPoint=null,this._boundingVectors=null,this._capacity=r,this._depth=n,this._maxDepth=o,this._minPoint=t,this._maxPoint=e}return e.create=function(t,e,r,n,o){var i=new this(t,e,r,n,o);return i.initWhenCreate(),i},Object.defineProperty(e.prototype,"entityObjectCount",{get:function(){return this.entityObjectList.getCount()},enumerable:!0,configurable:!0}),e.prototype.initWhenCreate=function(){this._boundingVectors=t.BoundingRegionUtils.buildBoundingVectors(this._minPoint,this._maxPoint)},e.prototype.addEntityObjects=function(e){var r=this,n=this._minPoint,o=this._maxPoint;e.forEach(function(e){e.getComponent(t.BoxColliderForFirstCheck).shape.isIntersectWithBox(n,o)&&r.entityObjectList.addChild(e)})},e.prototype.addNode=function(t){this.nodeList.addChild(t)},e.prototype.findAndAddToRenderList=function(e,r){if(t.BoundingRegionUtils.isAABBIntersectFrustum(this._boundingVectors,e)){if(this._hasNode())return void this.nodeList.forEach(function(t){t.findAndAddToRenderList(e,r)});r.addChildren(this.entityObjectList.filter(function(t){return t.isVisible}))}},e.prototype.findAndAddToIntersectList=function(t,e){if(t.isIntersectWithAABB(this._minPoint,this._maxPoint)){if(this._hasNode())return void this.nodeList.forEach(function(r){r.findAndAddToIntersectList(t,e)});e.addChildren(this.entityObjectList)}},e.prototype.findAndAddToCollideList=function(t,e){if(t.isIntersectWithBox(this._minPoint,this._maxPoint)){if(this._hasNode())return void this.nodeList.forEach(function(r){r.findAndAddToCollideList(t,e)});e.addChildren(this.entityObjectList)}},e.prototype._hasNode=function(){return this.nodeList.getCount()>0},__decorate([t.require(function(e){e.forEach(function(e){t.assert(e instanceof t.GameObject,t.Log.info.FUNC_SHOULD("add gameObjects"))})})],e.prototype,"addEntityObjects",null),e}();t.OctreeNode=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.Component);t.ColliderForFirstCheck=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._collider=t.BoxCollider.create()}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"shape",{get:function(){return this._collider.shape},enumerable:!0,configurable:!0}),r.prototype.init=function(){this._collider.entityObject=this.entityObject,this._collider.init()},r.prototype.update=function(t){this._collider.update(t)},r}(t.ColliderForFirstCheck);t.BoxColliderForFirstCheck=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type=t.ABSTRACT_ATTRIBUTE,this.boundingRegion=null}return __extends(r,e),Object.defineProperty(r.prototype,"shape",{get:function(){return this.boundingRegion.shape},enumerable:!0,configurable:!0}),r.prototype.init=function(){this.boundingRegion=this.createBoundingRegion(),this.boundingRegion.init(),this.buildBoundingRegion()},r.prototype.update=function(t){this.boundingRegion.update()},r.prototype.updateShape=function(){this.boundingRegion.updateShape()},r.prototype.isIntersectWith=function(e){return e instanceof t.BoxCollider?this.boundingRegion.isIntersectWithBox(e.boundingRegion):e instanceof t.SphereCollider?this.boundingRegion.isIntersectWithSphere(e.boundingRegion):void t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT(this.type+" collider","intersect with "+e.type+" collider"))},r.prototype.isCollide=function(e){var n=null;return this._isSelf(e)||!e.hasComponent(r)?!1:(n=e.getComponent(r),e.hasComponent(t.RigidBody)&&n.updateShape(),this.isIntersectWith(n))},r.prototype._isSelf=function(e){return t.JudgeUtils.isSelf(this.entityObject,e)},__decorate([t.require(function(e){t.assert(e instanceof r,t.Log.info.FUNC_SHOULD("target","be collider"))})],r.prototype,"isIntersectWith",null),r}(t.Component);t.Collider=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.center=t.Vector3.create(0,0,0),this.halfExtents=null,this.type=t.EColliderType.BOX}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.createBoundingRegion=function(){return t.BoxBoundingRegion.create(this.entityObject)},r.prototype.buildBoundingRegion=function(){this.boundingRegion.build(this.center,this.halfExtents)},r}(t.Collider);t.BoxCollider=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.center=t.Vector3.create(0,0,0),this.radius=null,this.type=t.EColliderType.SPHERE}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.createBoundingRegion=function(){return t.SphereBoundingRegion.create(this.entityObject)},r.prototype.buildBoundingRegion=function(){this.boundingRegion.build(this.center,this.radius)},r}(t.Collider);t.SphereCollider=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(t){this.shape=null,this.entityObject=null,this.isUserSpecifyTheRegion=!1,this.originShape=null,this.debugObject=null,this.entityObject=t}return e.prototype.init=function(){this.shape=this.createShape()},e.prototype.build=function(e){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];var o=Array.prototype.slice.call(arguments,0);this.isBuildUserSpecifyBoundingRegion.apply(this,o)?(this.isUserSpecifyTheRegion=!0,this.shape.setFromShapeParam.apply(this.shape,o)):this.shape.setFromPoints(t.ColliderUtils.getVertices(this.entityObject)),this.originShape=this.shape.copy(),t.DebugConfig.debugCollision&&(this.debugObject=this.buildDebugObjectFromShape(this.shape),t.Director.getInstance().scene.addChild(this.debugObject))},e.prototype.update=function(){this.isNotTransformed()||(t.DebugConfig.debugCollision?(this.updateShape(),this.updateDebugObjectFromShape(this.shape)):this.entityObject.hasComponent(t.RigidBody)||this.updateShape())},e.prototype.isIntersectWithSphere=function(t){return this.shape.isIntersectWithSphere(t.shape)},e.prototype.isIntersectWithBox=function(t){return this.shape.isIntersectWithBox(t.shape)},e.prototype.buildDebugObjectFromShape=function(e){var r=null,n=null,o=null,i=null;return r=t.BasicMaterial.create(),r.color=t.Color.create("rgb(255,0,0)"),n=t.CustomGeometry.create(),n.material=r,n.drawMode=t.EDrawMode.LINES,this.setDebugObjectGeometry(n,e),o=t.MeshRenderer.create(),i=t.GameObject.create(),i.addComponent(n),i.addComponent(o),i.transform.translate(e.center),i.name="debugBoundingRegion"+this.entityObject.uid,i.init(),i},__decorate([t.ensure(function(e,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];this.isBuildUserSpecifyBoundingRegion.apply(this,Array.prototype.slice.call(arguments,1))&&t.assert(this.shape.center.isEqual(r),t.Log.info.FUNC_SHOULD_NOT("transform shape when build"))})],e.prototype,"build",null),e}();t.BoundingRegion=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.updateShape=function(){var t=this.entityObject.transform;this.isUserSpecifyTheRegion?this.shape.setFromTranslationAndScale(this.originShape,t.localToWorldMatrix):t.isRotate?this.shape.setFromObject(this.entityObject):this.shape.setFromTranslationAndScale(this.originShape,t.localToWorldMatrix)},r.prototype.createShape=function(){return t.AABBShape.create()},r.prototype.updateDebugObjectFromShape=function(e){var r=this.debugObject.getComponent(t.CustomGeometry);this.setDebugObjectGeometry(r,e),this.debugObject.transform.position=e.center},r.prototype.setDebugObjectGeometry=function(t,e){var r=e.halfExtents,n=r.x,o=r.y,i=r.z;t.vertices=[-n,-o,-i,-n,-o,i,n,-o,i,n,-o,-i,-n,o,-i,-n,o,i,n,o,i,n,o,-i],t.indices=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]},r.prototype.isBuildUserSpecifyBoundingRegion=function(t,e){return!!t&&!!e},r.prototype.isNotTransformed=function(){var t=this.entityObject.transform;return!t.isRotate&&!t.isTranslate&&!t.isScale},__decorate([t.require(function(e){t.assert(this.debugObject,t.Log.info.FUNC_SHOULD("build debugObject"))})],r.prototype,"updateDebugObjectFromShape",null),__decorate([t.require(function(e,r){t.assert(r.halfExtents&&!r.halfExtents.isZero(),t.Log.info.FUNC_SHOULD_NOT("halfExtents","be zero"))})],r.prototype,"setDebugObjectGeometry",null),r}(t.BoundingRegion);t.BoxBoundingRegion=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.updateShape=function(){var t=this.entityObject.transform;this.shape.setFromTranslationAndScale(this.originShape,t.localToWorldMatrix)},r.prototype.createShape=function(){return t.SphereShape.create()},r.prototype.updateDebugObjectFromShape=function(e){this.debugObject.transform.position=e.center;var r=e.radius/this.originShape.radius;this.debugObject.transform.scale=t.Vector3.create(r,r,r)},r.prototype.isNotTransformed=function(){var t=this.entityObject.transform;return!t.isTranslate&&!t.isScale},r.prototype.isBuildUserSpecifyBoundingRegion=function(t,e){return!!t&&!!e},r.prototype.setDebugObjectGeometry=function(t,e){for(var r=40,n=3,o=e.radius,i=[],a=0,s=0;n>s;s++){var c=0,u=1,l=2,h=null;1===s?(c=1,u=0,l=2):2===s&&(c=0,u=2,l=1);for(var p=0;r>p;p++)h=2*Math.PI*(p/r),i[a+c]=o*Math.cos(h),i[a+u]=0,i[a+l]=o*Math.sin(h),a+=3,h=2*Math.PI*((p+1)/r),i[a+c]=o*Math.cos(h),i[a+u]=0,i[a+l]=o*Math.sin(h),a+=3}t.vertices=i},__decorate([t.require(function(e){t.assert(this.debugObject,t.Log.info.FUNC_SHOULD("build debugObject"))})],r.prototype,"updateDebugObjectFromShape",null),__decorate([t.require(function(e,r){t.assert(r.radius>0,t.Log.info.FUNC_SHOULD("radius","> 0"))})],r.prototype,"setDebugObjectGeometry",null),r}(t.BoundingRegion);t.SphereBoundingRegion=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.isAABBInFrustum=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=null,n=null;if(2===t.length)r=t[0],n=t[1];else if(3===t.length){var o=t[0],i=t[1];r=this.buildBoundingVectors(o,i),n=t[2]}for(var a=0;6>a;a++)for(var s=0;8>s;s++)if(n[a].dotCoordinate(r[s])<0)return!1;return!0},t.isAABBIntersectFrustum=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=null,n=null;if(2===t.length)r=t[0],n=t[1];else if(3===t.length){var o=t[0],i=t[1];r=this.buildBoundingVectors(o,i),n=t[2]}for(var a=0;6>a;a++){for(var s=8,c=0;8>c&&n[a].dotCoordinate(r[c])<0;c++)s--;if(0===s)return!1}return!0},t.buildBoundingVectors=function(t,e){var r=[];return r.push(t.copy()),r.push(e.copy()),r.push(t.copy()),r[2].x=e.x,r.push(t.copy()),r[3].y=e.y,r.push(t.copy()),r[4].z=e.z,r.push(e.copy()),r[5].z=t.z,r.push(e.copy()),r[6].x=t.x,r.push(e.copy()),r[7].y=t.y,r},t}();t.BoundingRegionUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.center=t.Vector3.create(0,0,0)}return e.prototype.isBoxAndSphereIntersected=function(t,e){var r=e.center,n=e.radius;return r.distanceToSquared(t.closestPointTo(r))<Math.pow(n,2)},e}();t.Shape=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.halfExtents=t.Vector3.create(.5,.5,.5)}return __extends(r,e),r.create=function(){var t=new this;return t},r.getCenter=function(e,r){return t.Vector3.create().add2(r,e).scale(.5)},r.getHalfExtents=function(e,r){return t.Vector3.create().sub2(r,e).scale(.5)},r.prototype.setMinMax=function(t,e){this.center=r.getCenter(t,e),this.halfExtents=r.getHalfExtents(t,e)},r.prototype.getMin=function(){return this.center.copy().sub(this.halfExtents)},r.prototype.getMax=function(){return this.center.copy().add(this.halfExtents)},r.prototype.setFromShapeParam=function(t,e){this.center=t,this.halfExtents=e},r.prototype.setFromPoints=function(e){var r=this,n=this._getEmptyMin(),o=this._getEmptyMax();return t.GeometryUtils.iterateThreeComponent(e,function(t){
r._expandByPoint(t,n,o)}),this.setMinMax(n,o),this},r.prototype.setFromTransformedAABB=function(t,e){var r=this.center,n=this.halfExtents,o=t.center.values,i=t.halfExtents.values,a=e.values,s=a[0],c=a[4],u=a[8],l=a[1],h=a[5],p=a[9],f=a[2],d=a[6],_=a[10],y=Math.abs(s),g=Math.abs(c),m=Math.abs(u),v=Math.abs(l),b=Math.abs(h),C=Math.abs(p),E=Math.abs(f),w=Math.abs(d),T=Math.abs(_);r.set(a[12]+s*o[0]+c*o[1]+u*o[2],a[13]+l*o[0]+h*o[1]+p*o[2],a[14]+f*o[0]+d*o[1]+_*o[2]),n.set(y*i[0]+g*i[1]+m*i[2],v*i[0]+b*i[1]+C*i[2],E*i[0]+w*i[1]+T*i[2])},r.prototype.setFromTranslationAndScale=function(t,e){var r=e.getTranslation(),n=e.getScale();this.center=t.center.copy().add(r),this.halfExtents=t.halfExtents.copy().mul(n)},r.prototype.setFromObject=function(e){var r=e.transform.localToWorldMatrix,n=t.ColliderUtils.getVertices(e),o=this,i=this._getEmptyMin(),a=this._getEmptyMax();t.GeometryUtils.iterateThreeComponent(n,function(t){t.applyMatrix4(r),o._expandByPoint(t,i,a)}),this.setMinMax(i,a)},r.prototype.isIntersectWithBox=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=this.getMax(),n=this.getMin(),o=null,i=null;if(1===t.length){var a=t[0];i=a.getMin(),o=a.getMax()}else 2===t.length&&(i=t[0],o=t[1]);return n.x<=o.x&&r.x>=i.x&&n.y<=o.y&&r.y>=i.y&&n.z<=o.z&&r.z>=i.z},r.prototype.isIntersectWithSphere=function(t){return this.isBoxAndSphereIntersected(this,t)},r.prototype.isIntersectWithRay=function(t){return t.isIntersectWithAABB(this)},r.prototype.closestPointTo=function(e){var r=this.getMin(),n=this.getMax(),o=t.Vector3.create();return e.x<r.x?o.x=r.x:e.x>n.x?o.x=n.x:o.x=e.x,e.y<r.y?o.y=r.y:e.y>n.y?o.y=n.y:o.y=e.y,e.z<r.z?o.z=r.z:e.z>n.z?o.z=n.z:o.z=e.z,o},r.prototype.containPoint=function(t){for(var e=this.getMin(),r=this.getMax(),n=0;3>n;++n)if(t.values[n]<e.values[n]||t.values[n]>r.values[n])return!1;return!0},r.prototype.copy=function(){var t=r.create();return t.center=this.center.copy(),t.halfExtents=this.halfExtents.copy(),t},r.prototype._getEmptyMin=function(){return t.Vector3.create(1/0,1/0,1/0)},r.prototype._getEmptyMax=function(){return t.Vector3.create(-(1/0),-(1/0),-(1/0))},r.prototype._expandByPoint=function(t,e,r){e.min(t),r.max(t)},__decorate([t.require(function(e){var r=t.ColliderUtils.getVertices(e);t.assert(r&&r.length>0,t.Log.info.FUNC_MUST_DEFINE("vertices"))})],r.prototype,"setFromObject",null),r}(t.Shape);t.AABBShape=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.radius=1}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.setFromShapeParam=function(t,e){this.center=t,this.radius=e},r.prototype.setFromPoints=function(e){var r=t.AABBShape.create();this.center=r.setFromPoints(e).center,this.radius=this._findMaxDistanceOfPointsToCenter(e)},r.prototype.setFromTranslationAndScale=function(t,e){var r=e.getTranslation(),n=e.getScale();this.center=t.center.copy().add(r),this.radius=t.radius*Math.max(n.x,n.y,n.z)},r.prototype.isIntersectWithSphere=function(t){var e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=Math.pow(e,2)},r.prototype.isIntersectWithBox=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null;if(1===e.length)n=e[0];else if(2===e.length){var o=e[0],i=e[1];n=t.AABBShape.create(),n.setMinMax(o,i)}return this.isBoxAndSphereIntersected(n,this)},r.prototype.isIntersectWithRay=function(t){return t.isIntersectWithSphere(this)},r.prototype.containPoint=function(t){return t.distanceToSquared(this.center)<=Math.pow(this.radius,2)},r.prototype.copy=function(){var t=r.create();return t.center=this.center.copy(),t.radius=this.radius,t},r.prototype._findMaxDistanceOfPointsToCenter=function(e){var r=0,n=this.center;return t.GeometryUtils.iterateThreeComponent(e,function(t){r=Math.max(r,n.distanceToSquared(t))}),Math.sqrt(r)},r}(t.Shape);t.SphereShape=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BOX="box"]="BOX",t[t.SPHERE="sphere"]="SPHERE"}(t.EColliderType||(t.EColliderType={}));t.EColliderType}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){}return e.getVertices=function(e){return e.hasComponent(t.Geometry)?e.getComponent(t.Geometry).geometryData.vertices:e.hasTag(t.EWDTag.CONTAINER)?e.getChild(0).getComponent(t.Geometry).vertices:null},__decorate([t.require(function(e){if(!e.hasComponent(t.Geometry)&&e.hasTag(t.EWDTag.CONTAINER)){var r=e.getChild(0).getComponent(t.Geometry).vertices,n=e.getChild(1).getComponent(t.Geometry).vertices;t.assert(!!r&&r.length===n.length,t.Log.info.FUNC_SHOULD("if entityObject is EWDTag.CONTAINER, then its children should has its vertices"))}})],e,"getVertices",null),e}();t.ColliderUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._friction=0,this._restitution=0,this._children=wdCb.Collection.create(),this.lockConstraint=t.LockConstraint.create(this),this.distanceConstraint=t.DistanceConstraint.create(this),this.hingeConstraint=t.HingeConstraint.create(this),this.pointToPointConstraintList=t.PointToPointConstraintList.create(this),this._afterInitSubscription=null,this._afterInitRigidbodyAddConstraintSubscription=null}return __extends(r,e),Object.defineProperty(r.prototype,"friction",{get:function(){return this._friction},set:function(t){this._friction=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"restitution",{get:function(){return this._restitution},set:function(t){this._restitution=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"children",{get:function(){return this._children},set:function(e){if(t.JudgeUtils.isArrayExactly(e)){var r=e;this._children=wdCb.Collection.create(r)}else{var n=e;this._children=n}this._children.forEach(function(t){t.addTag("isRigidbodyChild")})},enumerable:!0,configurable:!0}),r.prototype.init=function(){var e=this;this._afterInitSubscription=t.EventManager.fromEvent(t.EEngineEvent.AFTER_GAMEOBJECT_INIT).subscribe(function(){e._afterInitHandler()}),this._afterInitRigidbodyAddConstraintSubscription=t.EventManager.fromEvent(t.EEngineEvent.AFTER_GAMEOBJECT_INIT_RIGIDBODY_ADD_CONSTRAINT).subscribe(function(){e._afterInitRigidbodyAddConstraintHandler()})},r.prototype.addConstraint=function(){var t=this,e=this.getPhysicsEngineAdapter();this.lockConstraint&&this.lockConstraint.connectedBody&&e.addLockConstraint(this.entityObject,this.lockConstraint),this.distanceConstraint&&this.distanceConstraint.connectedBody&&e.addDistanceConstraint(this.entityObject,this.distanceConstraint),this.hingeConstraint&&this.hingeConstraint.connectedBody&&e.addHingeConstraint(this.entityObject,this.hingeConstraint),this.pointToPointConstraintList&&this.pointToPointConstraintList.getCount()>0&&this.pointToPointConstraintList.forEach(function(r){e.addPointToPointConstraint(t.entityObject,r)},this)},r.prototype.removeFromObject=function(t){var r=this.getPhysicsEngineAdapter();r&&(this.getPhysicsEngineAdapter().removeGameObject(t),this.getPhysicsEngineAdapter().removeConstraints(t)),e.prototype.removeFromObject.call(this,t)},r.prototype.dispose=function(){this._children.forEach(function(t){t.removeTag("isRigidbodyChild")},this),this._afterInitSubscription&&this._afterInitSubscription.dispose(),this._afterInitRigidbodyAddConstraintSubscription&&this._afterInitRigidbodyAddConstraintSubscription.dispose()},r.prototype.getPhysicsEngineAdapter=function(){return t.Director.getInstance().scene.physicsEngineAdapter},r.prototype.isPhysicsEngineAdapterExist=function(){return!!t.Director.getInstance().scene&&!!t.Director.getInstance().scene.physicsEngineAdapter},r.prototype.addBodyToPhysicsEngine=function(t,e){void 0===e&&(e={});var r=this.getPhysicsEngineAdapter(),n=this.entityObject.transform.position,o=this.entityObject.transform.rotation;r[t](this.entityObject,wdCb.ExtendUtils.extend({position:n,rotation:o,children:this._children,lockConstraint:this.lockConstraint,onContact:wdCb.FunctionUtils.bind(this,this._onContact),onCollisionStart:wdCb.FunctionUtils.bind(this,this._onCollisionStart),onCollisionEnd:wdCb.FunctionUtils.bind(this,this._onCollisionEnd),friction:this.friction,restitution:this.restitution},e))},r.prototype._onContact=function(t){this.entityObject.execScript("onContact",wdCb.Collection.create([t]))},r.prototype._onCollisionStart=function(t){this.entityObject.execScript("onCollisionStart",wdCb.Collection.create([t]))},r.prototype._onCollisionEnd=function(){this.entityObject.execScript("onCollisionEnd")},r.prototype._isContainer=function(t){var e=t.getComponent(r);return e.children.getCount()>0},r.prototype._afterInitHandler=function(){this.addBody()},r.prototype._afterInitRigidbodyAddConstraintHandler=function(){this.addConstraint()},__decorate([t.operateBodyDataGetterAndSetter("Friction")],r.prototype,"friction",null),__decorate([t.operateBodyDataGetterAndSetter("Restitution")],r.prototype,"restitution",null),__decorate([t.require(function(){this._isContainer(this.entityObject)?t.assert(!this.entityObject.getComponent(t.Collider),t.Log.info.FUNC_SHOULD_NOT("container","add collider component in the case of compound")):(t.assert(!!this.entityObject.getComponent(t.Collider),t.Log.info.FUNC_MUST_DEFINE("collider component when add rigid body component")),t.assert(!!this.entityObject.getComponent(t.Collider).shape,t.Log.info.FUNC_SHOULD("create collider.shape before adding rigid body component")))})],r.prototype,"addBodyToPhysicsEngine",null),__decorate([t.execOnlyOnce("_isAfterInit")],r.prototype,"_afterInitHandler",null),__decorate([t.execOnlyOnce("_isAfterInitRigidbodyAddConstraint")],r.prototype,"_afterInitRigidbodyAddConstraintHandler",null),r}(t.Component);t.RigidBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._linearDamping=0,this._angularDamping=0,this._velocity=t.Vector3.create(0,0,0),this._angularVelocity=t.Vector3.create(0,0,0),this._mass=1,this.impulse=null,this.force=null,this.hitPoint=null}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"linearDamping",{get:function(){return this._linearDamping},set:function(t){this._linearDamping=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"angularDamping",{get:function(){return this._angularDamping},set:function(t){this._angularDamping=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"angularVelocity",{get:function(){return this._angularVelocity},set:function(t){this._angularVelocity=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"mass",{get:function(){return this._mass},set:function(t){this._mass=t},enumerable:!0,configurable:!0}),r.prototype.addBody=function(){this.addBodyToPhysicsEngine("addDynamicBody",{mass:this.mass,linearDamping:this.linearDamping,angularDamping:this.angularDamping,velocity:this.velocity,angularVelocity:this.angularVelocity,impulse:this.impulse,force:this.force,hitPoint:this.hitPoint})},__decorate([t.operateBodyDataGetterAndSetter("LinearDamping")],r.prototype,"linearDamping",null),__decorate([t.operateBodyDataGetterAndSetter("AngularDamping")],r.prototype,"angularDamping",null),__decorate([t.operateBodyDataGetterAndSetter("Velocity")],r.prototype,"velocity",null),__decorate([t.operateBodyDataGetterAndSetter("AngularVelocity")],r.prototype,"angularVelocity",null),__decorate([t.operateBodyDataGetterAndSetter("Mass")],r.prototype,"mass",null),r}(t.RigidBody);t.DynamicRigidBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._velocity=t.Vector3.create(0,0,0),this._angularVelocity=t.Vector3.create(0,0,0),this._mass=1}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"angularVelocity",{get:function(){return this._angularVelocity},set:function(t){this._angularVelocity=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"mass",{get:function(){return this._mass},set:function(t){this._mass=t},enumerable:!0,configurable:!0}),r.prototype.addBody=function(){this.addBodyToPhysicsEngine("addKinematicBody",{mass:this.mass,velocity:this.velocity,angularVelocity:this.angularVelocity})},__decorate([t.operateBodyDataGetterAndSetter("Velocity")],r.prototype,"velocity",null),__decorate([t.operateBodyDataGetterAndSetter("AngularVelocity")],r.prototype,"angularVelocity",null),__decorate([t.operateBodyDataGetterAndSetter("Mass")],r.prototype,"mass",null),r}(t.RigidBody);t.KinematicRigidBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.addBody=function(){this.addBodyToPhysicsEngine("addStaticBody")},e}(t.RigidBody);t.StaticRigidBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(){function t(t){this.maxForce=null,this.rigidBody=null,this.rigidBody=t}return t}();t.PhysicsConstraint=e;var r=function(t){function e(){t.apply(this,arguments),this._connectedBody=null}return __extends(e,t),e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(t){var e=null;this._connectedBody=t,this.rigidBody.isPhysicsEngineAdapterExist()&&(e=this.rigidBody.getPhysicsEngineAdapter(),e.removeLockConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint())},enumerable:!0,configurable:!0}),e}(e);t.LockConstraint=r;var n=function(t){function e(){t.apply(this,arguments),this._connectedBody=null,this.distance=null}return __extends(e,t),e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(t){var e=null;this._connectedBody=t,this.rigidBody.isPhysicsEngineAdapterExist()&&(e=this.rigidBody.getPhysicsEngineAdapter(),e.removeDistanceConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint())},enumerable:!0,configurable:!0}),e}(e);t.DistanceConstraint=n;var o=function(t){function e(){t.apply(this,arguments),this._connectedBody=null,this.pivotA=null,this.pivotB=null,this.axisA=null,this.axisB=null}return __extends(e,t),e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"connectedBody",{get:function(){return this._connectedBody},set:function(t){var e=null;this._connectedBody=t,this.rigidBody.isPhysicsEngineAdapterExist()&&(e=this.rigidBody.getPhysicsEngineAdapter(),e.removeHingeConstraint(this.rigidBody.entityObject),this.rigidBody.addConstraint())},enumerable:!0,configurable:!0}),e}(e);t.HingeConstraint=o;var i=function(t){function e(){t.apply(this,arguments),this.connectedBody=null,this.pivotA=null,this.pivotB=null}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e}(e);t.PointToPointConstraint=i;var a=function(){function e(t){this._rigidBody=null,this._list=wdCb.Collection.create(),this._rigidBody=t}return e.create=function(t){var e=new this(t);return e},e.prototype.forEach=function(e,r){void 0===r&&(r=t.root),this._list.forEach(e,r)},e.prototype.getCount=function(){return this._list.getCount()},e.prototype.addChild=function(t){var e=null;this._list.addChild(t),this._rigidBody.isPhysicsEngineAdapterExist()&&(e=this._rigidBody.getPhysicsEngineAdapter(),e.addPointToPointConstraint(this._rigidBody.entityObject,t))},e.prototype.addChildren=function(e){var r=this;if(t.JudgeUtils.isArrayExactly(e))for(var n=0,o=e;n<o.length;n++){var i=o[n];this.addChild(i)}else{var a=e;a.forEach(function(t){r.addChild(t)},this)}},e.prototype.removeChild=function(t){var e=null;this._list.removeChild(t),this._rigidBody.isPhysicsEngineAdapterExist()&&(e=this._rigidBody.getPhysicsEngineAdapter(),e.removePointToPointConstraint(t))},e}();t.PointToPointConstraintList=a}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.create=function(e){var r=null;switch(e){case t.EPhysicsEngineType.CANNON:r=t.CannonAdapter.create();break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNEXPECT("physics engine type"))}return r},e}();t.PhysicsEngineFactory=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.CANNON=0]="CANNON"}(t.EPhysicsEngineType||(t.EPhysicsEngineType={}));t.EPhysicsEngineType}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.dataList=wdCb.Collection.create()}return e.prototype.getCount=function(){return this.dataList.getCount()},e.prototype.removeByGameObject=function(e){this.dataList.removeChild(function(r){var n=r.entityObject;r.body;return t.JudgeUtils.isEqual(n,e)})},e}();t.CannonDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.remove=function(t){this.removeByGameObject(t)},r.prototype.updateBodyTransformData=function(){this.dataList.forEach(function(e){var r=e.entityObject,n=e.body,o=r.transform;(o.isTranslate||o.isRotate)&&(n.position=t.CannonUtils.convertToCannonVector3(r.transform.position),n.quaternion=t.CannonUtils.convertToCannonQuaternion(r.transform.rotation))})},r.prototype.updateGameObjectTransformData=function(){this.dataList.forEach(function(e){var r=e.entityObject,n=e.body;r.hasTag("isRigidbodyChild")||(r.transform.position=t.CannonUtils.convertToWonderVector3(n.position),r.transform.rotation=t.CannonUtils.convertToWonderQuaternion(n.quaternion))})},r.prototype.add=function(t,e){this.dataList.addChild({entityObject:t,body:e})},r.prototype.findGameObjectByBody=function(t){var e=this.dataList.findOne(function(e){var r=(e.entityObject,e.body);return r===t});return null!==e?e.entityObject:null},r.prototype.findBodyByGameObject=function(e){var r=this.dataList.findOne(function(r){var n=r.entityObject;r.body;return t.JudgeUtils.isEqual(n,e)});return null!==r?r.body:null},r}(t.CannonDataList);t.CannonGameObjectDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.remove=function(t){this.removeByGameObject(t)},r.prototype.findMaterialByGameObject=function(e){var r=this.dataList.findOne(function(r){var n=r.entityObject;r.material;return t.JudgeUtils.isEqual(n,e)});return null!==r?r.material:null},r.prototype.add=function(t,e){this.dataList.addChild({entityObject:t,material:e})},r.prototype.addContactMaterial=function(t,e,r,n){this.dataList.forEach(function(o){var i=(o.entityObject,o.material);t.addContactMaterial(new CANNON.ContactMaterial(i,e,{friction:r,restitution:n}))})},r.prototype.getContactMaterialData=function(t,e,r){var n=null;return this.dataList.forEach(function(o){var i=(o.entityObject,o.material),a=t.getContactMaterial(i,e);return a?(n=a[r],wdCb.$BREAK):void 0}),n},r.prototype.getContactMaterials=function(t,e){var r=[];return this.dataList.forEach(function(n){var o=(n.entityObject,n.material),i=t.getContactMaterial(o,e);i&&r.push(i)}),r},r.prototype.setContactMaterialData=function(t,e,r,n){this.dataList.forEach(function(o){var i=(o.entityObject,o.material),a=t.getContactMaterial(i,e);a&&(a[r]=n)})},r}(t.CannonDataList);t.CannonMaterialList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(t.CannonDataList);t.CannonConstraintDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.prototype.add=function(t,e){this.dataList.addChild({entityObject:t,constraint:e})},r.prototype.remove=function(t){this.removeByGameObject(t)},r.prototype.findConstraintByGameObject=function(e){var r=this.dataList.findOne(function(r){var n=r.entityObject;return t.JudgeUtils.isEqual(n,e)});return null!==r?r.constraint:null},r}(t.CannonConstraintDataList);t.CannonSingleConstraintDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.CannonSingleConstraintDataList);t.CannonLockConstraintDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.filter=function(t){return this.dataList.filter(t)},r.prototype.forEach=function(t){this.dataList.forEach(t)},r.prototype.add=function(t,e,r){this.dataList.addChild({entityObject:t,pointToPointConstraint:e,cannonConstraint:r})},r.prototype.remove=function(e){this.dataList.removeChild(function(r){var n=r.pointToPointConstraint;return t.JudgeUtils.isEqual(n,e)})},r.prototype.findCannonConstraintByPointToPointConstraint=function(e){var r=this.dataList.findOne(function(r){var n=r.pointToPointConstraint;return t.JudgeUtils.isEqual(n,e)});return null!==r?r.cannonConstraint:null},r}(t.CannonConstraintDataList);t.CannonPointToPointConstraintDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.CannonSingleConstraintDataList);t.CannonDistanceConstraintDataList=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.CannonSingleConstraintDataList);t.CannonHingeConstraintDataList=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.convertToCannonVector3=function(t){return new CANNON.Vec3(t.x,t.y,t.z)},e.convertToCannonQuaternion=function(t){return new CANNON.Quaternion(t.x,t.y,t.z,t.w)},e.convertToWonderVector3=function(e){return t.Vector3.create(e.x,e.y,e.z)},e.convertToWonderQuaternion=function(e){return t.Quaternion.create(e.x,e.y,e.z,e.w)},e}();t.CannonUtils=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this.world=null,this._materialList=t.CannonMaterialList.create(),this._gameObjectDataList=t.CannonGameObjectDataList.create(),this._lockConstraintDataList=t.CannonLockConstraintDataList.create(),this._distanceConstraintDataList=t.CannonDistanceConstraintDataList.create(),this._hingeConstraintDataList=t.CannonHingeConstraintDataList.create(),this._pointToPointConstraintDataList=t.CannonPointToPointConstraintDataList.create(),this._dynamicBody=null,this._kinematicBody=null,this._staticBody=null,this._lockConstraint=null,this._distanceConstraint=null,this._hingeConstraint=null,this._pointToPointConstraint=null}return e.create=function(){var t=new this;return t},e.prototype.getGravity=function(e){return t.CannonUtils.convertToWonderVector3(this.world.gravity)},e.prototype.setGravity=function(e){this.world.gravity=t.CannonUtils.convertToCannonVector3(e)},e.prototype.getFriction=function(t,e){return this._getMaterialData(t,"friction")},e.prototype.setFriction=function(t,e){this._setMaterialData(t,"friction",e)},e.prototype.getRestitution=function(t,e){return this._getMaterialData(t,"restitution")},e.prototype.setRestitution=function(t,e){this._setMaterialData(t,"restitution",e)},e.prototype.getLinearDamping=function(t){return this._getNumberData(t,"linearDamping")},e.prototype.setLinearDamping=function(t,e){return this._setNumberData(t,"linearDamping",e)},e.prototype.getAngularDamping=function(t){return this._getNumberData(t,"angularDamping")},e.prototype.setAngularDamping=function(t,e){return this._setNumberData(t,"angularDamping",e)},e.prototype.getMass=function(t){return this._getNumberData(t,"mass")},e.prototype.setMass=function(t,e){return this._setNumberData(t,"mass",e)},e.prototype.getVelocity=function(t){return this._getVec3Data(t,"velocity")},e.prototype.setVelocity=function(t,e){this._setVec3Data(t,"velocity",e)},e.prototype.getAngularVelocity=function(t){return this._getVec3Data(t,"angularVelocity")},e.prototype.setAngularVelocity=function(t,e){this._setVec3Data(t,"angularVelocity",e)},e.prototype.init=function(){var e=t.Director.getInstance().scene.physics,r=e.gravity,n=e.iterations;this.world=new CANNON.World,this.world.broadphase=new CANNON.NaiveBroadphase,this.world.solver.iterations=n,this.world.gravity.set(r.x,r.y,r.z),this._dynamicBody=t.CannonDynamicBody.create(this.world,this._gameObjectDataList,this._materialList),this._kinematicBody=t.CannonKinematicBody.create(this.world,this._gameObjectDataList,this._materialList),this._staticBody=t.CannonStaticBody.create(this.world,this._gameObjectDataList,this._materialList),this._lockConstraint=t.CannonLockConstraint.create(this.world,this._gameObjectDataList,this._lockConstraintDataList),this._distanceConstraint=t.CannonDistanceConstraint.create(this.world,this._gameObjectDataList,this._distanceConstraintDataList),this._hingeConstraint=t.CannonHingeConstraint.create(this.world,this._gameObjectDataList,this._hingeConstraintDataList),this._pointToPointConstraint=t.CannonPointToPointConstraint.create(this.world,this._gameObjectDataList,this._pointToPointConstraintDataList)},e.prototype.addDynamicBody=function(t,e){this._dynamicBody.addBody(t,e)},e.prototype.addKinematicBody=function(t,e){this._kinematicBody.addBody(t,e)},e.prototype.addStaticBody=function(t,e){this._staticBody.addBody(t,e)},e.prototype.addLockConstraint=function(t,e){this._lockConstraint.addConstraint(t,e)},e.prototype.removeLockConstraint=function(t){this._lockConstraint.removeConstraint(t)},e.prototype.addDistanceConstraint=function(t,e){this._distanceConstraint.addConstraint(t,e)},e.prototype.removeDistanceConstraint=function(t){this._distanceConstraint.removeConstraint(t)},e.prototype.addHingeConstraint=function(t,e){this._hingeConstraint.addConstraint(t,e)},e.prototype.removeHingeConstraint=function(t){this._hingeConstraint.removeConstraint(t)},e.prototype.addPointToPointConstraint=function(t,e){this._pointToPointConstraint.addConstraint(t,e)},e.prototype.removePointToPointConstraint=function(t){this._pointToPointConstraint.removeConstraint(t)},e.prototype.removeGameObject=function(t){var e=(this._getMaterial(t),this._gameObjectDataList.findBodyByGameObject(t));e&&this.world.remove(e),this._gameObjectDataList.remove(t),this._materialList.remove(t)},e.prototype.removeConstraints=function(e){var r=this;this._lockConstraint.removeConstraint(e),this._distanceConstraint.removeConstraint(e),this._hingeConstraint.removeConstraint(e),this._pointToPointConstraintDataList.filter(function(r){var n=r.entityObject;return t.JudgeUtils.isEqual(n,e)}).forEach(function(t){var e=t.pointToPointConstraint;r._pointToPointConstraint.removeConstraint(e)})},e.prototype.update=function(e){this._gameObjectDataList.updateBodyTransformData(),this.world.step(t.Director.getInstance().getDeltaTime()/1e3),this._gameObjectDataList.updateGameObjectTransformData()},e.prototype._getMaterial=function(t){return this._materialList.findMaterialByGameObject(t)},e.prototype._getNumberData=function(t,e){var r=this._gameObjectDataList.findBodyByGameObject(t);return r?r[e]:null},e.prototype._setNumberData=function(t,e,r){var n=this._gameObjectDataList.findBodyByGameObject(t);return n?void(n[e]=r):null},e.prototype._getVec3Data=function(e,r){var n=this._gameObjectDataList.findBodyByGameObject(e);return n?t.CannonUtils.convertToWonderVector3(n[r]):null},e.prototype._setVec3Data=function(e,r,n){var o=this._gameObjectDataList.findBodyByGameObject(e);
return o?void(o[r]=t.CannonUtils.convertToCannonVector3(n)):null},e.prototype._getMaterialData=function(t,e){var r=this._getMaterial(t);return r?this._materialList.getContactMaterialData(this.world,r,e):null},e.prototype._setMaterialData=function(e,r,n){var o=(this.world,this._getMaterial(e));return o?void this._materialList.setContactMaterialData(this.world,o,r,n):void t.Log.warn("no material find, please add material first")},__decorate([t.require(function(e,r){var n=[],o=null,i=this._getMaterial(e);if(!i)return null;n=this._materialList.getContactMaterials(this.world,i),o=n[0];for(var a=0,s=n;a<s.length;a++){var c=s[a];t.assert(c===o,t.Log.info.FUNC_SHOULD("the data of contact material which contains the same material","be the same"))}})],e.prototype,"_getMaterialData",null),e}();t.CannonAdapter=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(t,e,r){this.world=null,this.materialList=null,this.gameObjectList=null,this.world=t,this.gameObjectList=e,this.materialList=r}return e.prototype.addBody=function(e,r){var n=this.createBody(r);return r.children.getCount()>0?this._addCompounds(e,r.children,n):n.addShape(this._createShape(e.getComponent(t.Collider).shape)),this.afterAddShape(n,r),n.material=this._createMaterial(e,r.friction,r.restitution),n.position=t.CannonUtils.convertToCannonVector3(r.position),n.quaternion=t.CannonUtils.convertToCannonQuaternion(r.rotation),this.world.addBody(n),this.gameObjectList.add(e,n),this._bindCollideEvent(n,r.onCollisionStart,r.onContact,r.onCollisionEnd),n},e.prototype.afterAddShape=function(t,e){},e.prototype._createShape=function(e){var r=null;return e instanceof t.AABBShape?r=new CANNON.Box(t.CannonUtils.convertToCannonVector3(e.halfExtents)):e instanceof t.SphereShape&&(r=new CANNON.Sphere(e.radius)),r},e.prototype._bindCollideEvent=function(t,e,r,n){var o=this;t.addEventListener("collide",function(t){var i=o.gameObjectList.findGameObjectByBody(t.body),a=null;i&&(a=i,e(a),r(a),n(a))})},e.prototype._createMaterial=function(t,e,r){var n=null,o=null;return(n=this._getMaterial(t))?n:(o=new CANNON.Material("material"),this._addMaterial(t,o,e,r),o)},e.prototype._getMaterial=function(t){return this.materialList.findMaterialByGameObject(t)},e.prototype._addMaterial=function(t,e,r,n){this.materialList.add(t,e),this.materialList.addContactMaterial(this.world,e,r,n)},e.prototype._addCompounds=function(e,r,n){var o=this,i=e.transform.position,a=e.transform.rotation;r.forEach(function(e){n.addShape(o._createShape(e.getComponent(t.Collider).shape),t.CannonUtils.convertToCannonVector3(e.transform.position.copy().sub(i)),t.CannonUtils.convertToCannonQuaternion(e.transform.rotation.copy().sub(a)))},this)},__decorate([t.virtual],e.prototype,"afterAddShape",null),__decorate([t.require(function(e,r,n){r.forEach(function(e){t.assert(!!e.getComponent(t.Collider),t.Log.info.FUNC_MUST_DEFINE("collider component")),t.assert(!!e.getComponent(t.Collider).shape,t.Log.info.FUNC_SHOULD("create collider.shape"))})})],e.prototype,"_addCompounds",null),e}();t.CannonBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t,e,r){var n=new this(t,e,r);return n},r.prototype.createBody=function(e){var r=e.mass,n=e.linearDamping,o=e.angularDamping,i=e.velocity,a=e.angularVelocity;return new CANNON.Body({mass:r,linearDamping:n,angularDamping:o,velocity:t.CannonUtils.convertToCannonVector3(i),angularVelocity:t.CannonUtils.convertToCannonVector3(a)})},r.prototype.afterAddShape=function(e,r){var n=r.impulse,o=r.force,i=r.hitPoint;n&&i&&e.applyImpulse(t.CannonUtils.convertToCannonVector3(n),t.CannonUtils.convertToCannonVector3(i)),o&&i&&e.applyForce(t.CannonUtils.convertToCannonVector3(o),t.CannonUtils.convertToCannonVector3(i))},r}(t.CannonBody);t.CannonDynamicBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t,e,r){var n=new this(t,e,r);return n},r.prototype.createBody=function(e){var r=e.mass,n=e.velocity,o=e.angularVelocity;return new CANNON.Body({type:CANNON.Body.KINEMATIC,mass:r,velocity:t.CannonUtils.convertToCannonVector3(n),angularVelocity:t.CannonUtils.convertToCannonVector3(o)})},r}(t.CannonBody);t.CannonKinematicBody=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e,r){var n=new this(t,e,r);return n},e.prototype.createBody=function(t){return new CANNON.Body({mass:0})},e}(t.CannonBody);t.CannonStaticBody=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(t,e,r){this.world=null,this.gameObjectList=null,this.constraintDataList=null,this.world=t,this.gameObjectList=e,this.constraintDataList=r}return e.prototype.addConstraint=function(t,e){var r=null,n=this.gameObjectList.findBodyByGameObject(t);r=this.createCannonConstraint(n,e),this.world.addConstraint(r),this.addToConstraintDataList(t,e,r)},e.prototype.findBody=function(t){return this.gameObjectList.findBodyByGameObject(t.entityObject)},__decorate([t.require(function(e,r){t.assert(null!==this.gameObjectList.findBodyByGameObject(e),t.Log.info.FUNC_SHOULD("add rigid body")),t.assert(this.findBody(r.connectedBody),t.Log.info.FUNC_SHOULD("add connectedBody"))})],e.prototype,"addConstraint",null),e}();t.CannonConstraint=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.removeConstraint=function(t){var e=this.constraintDataList.findConstraintByGameObject(t);e&&this.world.removeConstraint(e),this.constraintDataList.remove(t)},e.prototype.addToConstraintDataList=function(t,e,r){this.constraintDataList.add(t,r)},e}(t.CannonConstraint);t.CannonSingleConstraint=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e,r){var n=new this(t,e,r);return n},e.prototype.createCannonConstraint=function(t,e){var r=null,n=this.findBody(e.connectedBody);return r=e.maxForce?new CANNON.LockConstraint(t,n,e.maxForce):new CANNON.LockConstraint(t,n)},e}(t.CannonSingleConstraint);t.CannonLockConstraint=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t,e,r){var n=new this(t,e,r);return n},r.prototype.removeConstraint=function(t){var e=this.constraintDataList.findCannonConstraintByPointToPointConstraint(t);e&&this.world.removeConstraint(e),this.constraintDataList.remove(t)},r.prototype.createCannonConstraint=function(e,r){var n=null,o=this.findBody(r.connectedBody),i=t.CannonUtils.convertToCannonVector3(r.pivotA),a=t.CannonUtils.convertToCannonVector3(r.pivotB);return n=r.maxForce?new CANNON.PointToPointConstraint(e,i,o,a,r.maxForce):new CANNON.PointToPointConstraint(e,i,o,a)},r.prototype.addToConstraintDataList=function(t,e,r){this.constraintDataList.add(t,e,r)},r}(t.CannonConstraint);t.CannonPointToPointConstraint=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t,e,r){var n=new this(t,e,r);return n},e.prototype.createCannonConstraint=function(t,e){var r=null,n=this.findBody(e.connectedBody);return r=new CANNON.DistanceConstraint(t,n,null!==e.distance?e.distance:void 0,null!==e.maxForce?e.maxForce:void 0)},e}(t.CannonSingleConstraint);t.CannonDistanceConstraint=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t,e,r){var n=new this(t,e,r);return n},r.prototype.createCannonConstraint=function(e,r){var n=null,o=this.findBody(r.connectedBody),i=t.CannonUtils.convertToCannonVector3(r.pivotA),a=t.CannonUtils.convertToCannonVector3(r.axisA),s=t.CannonUtils.convertToCannonVector3(r.pivotB),c=t.CannonUtils.convertToCannonVector3(r.axisB),u={};return r.pivotA&&(u.pivotA=i),r.axisA&&(u.axisA=a),r.pivotB&&(u.pivotB=s),r.axisB&&(u.axisB=c),r.maxForce&&(u.maxForce=r.maxForce),n=new CANNON.HingeConstraint(e,o,u)},r}(t.CannonSingleConstraint);t.CannonHingeConstraint=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._shadowMapWidth=null,this._shadowMapHeight=null,this.color=t.Color.create("#ffffff"),this.castShadow=!1,this.shadowCameraNear=.1,this.shadowCameraFar=5e3,this.shadowBias=t.ShaderChunk.NULL,this.shadowDarkness=0,this.shadowMap=null,this.shadowMapRenderer=null}return __extends(r,e),Object.defineProperty(r.prototype,"position",{get:function(){return this.entityObject.transform.position},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"shadowMapWidth",{get:function(){var e=t.GPUDetector.getInstance().maxCubemapTextureSize;return!this._shadowMapWidth||this._shadowMapWidth>e?e:this._shadowMapWidth},set:function(t){this._shadowMapWidth=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"shadowMapHeight",{get:function(){var e=t.GPUDetector.getInstance().maxCubemapTextureSize;return!this._shadowMapHeight||this._shadowMapHeight>e?e:this._shadowMapHeight},set:function(t){this._shadowMapHeight=t},enumerable:!0,configurable:!0}),r}(t.Component);t.Light=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.type="ambientLight",e}(t.Light);t.AmbientLight=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.intensity=1,this._beforeInitSubscription=null}return __extends(r,e),r.prototype.initWhenCreate=function(){var e=this;this._beforeInitSubscription=t.EventManager.fromEvent(t.EEngineEvent.BEFORE_GAMEOBJECT_INIT).subscribe(function(){e.beforeInitHandler()})},r.prototype.dispose=function(){this.shadowMap&&this.shadowMap.dispose(),t.Director.getInstance().scene.removeRenderTargetRenderer(this.shadowMapRenderer),this._beforeInitSubscription&&this._beforeInitSubscription.dispose()},r.prototype.beforeInitHandler=function(){this.castShadow&&(this.shadowMap=this.createShadowMap(),this.shadowMapRenderer=this.createShadowMapRenderer(),t.Director.getInstance().scene.addRenderTargetRenderer(this.shadowMapRenderer))},__decorate([t.execOnlyOnce("_isBeforeInit")],r.prototype,"beforeInitHandler",null),r}(t.Light);t.SourceLight=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._shadowRenderList=null,this.shadowCameraLeft=-1e3,this.shadowCameraRight=1e3,this.shadowCameraTop=1e3,this.shadowCameraBottom=-1e3}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(r.prototype,"shadowRenderList",{get:function(){return this._shadowRenderList},set:function(t){this._shadowRenderList=wdCb.Collection.create(t)},enumerable:!0,configurable:!0}),r.prototype.createShadowMap=function(){return t.TwoDShadowMapTexture.create()},r.prototype.createShadowMapRenderer=function(){return t.TwoDShadowMapRenderTargetRenderer.create(this)},r.type="directionLight",r.defaultPosition=t.Vector3.create(0,0,1),__decorate([t.requireSetter(function(e){t.assert(t.JudgeUtils.isArrayExactly(e),t.Log.info.FUNC_MUST_BE("shadowRenderList","array"))})],r.prototype,"shadowRenderList",null),r}(t.SourceLight);t.DirectionLight=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._rangeLevel=null,this._shadowRenderList=wdCb.Hash.create(),this._attenuation=t.Attenuation.create()}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(r.prototype,"rangeLevel",{get:function(){return this._rangeLevel},set:function(t){this._rangeLevel=t,this._attenuation.rangeLevel=this._rangeLevel},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"range",{get:function(){return this._attenuation.range},set:function(t){this._attenuation.range=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"constant",{get:function(){return this._attenuation.constant},set:function(t){this._attenuation.constant=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"linear",{get:function(){return this._attenuation.linear},set:function(t){this._attenuation.linear=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"quadratic",{get:function(){return this._attenuation.quadratic},set:function(t){this._attenuation.quadratic=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"shadowRenderList",{get:function(){return this._shadowRenderList},set:function(t){t=t;for(var e in t)if(t.hasOwnProperty(e)){var r=t[e];this._shadowRenderList.addChild(e,wdCb.Collection.create(r))}},enumerable:!0,configurable:!0}),r.prototype.createShadowMap=function(){return t.CubemapShadowMapTexture.create()},r.prototype.createShadowMapRenderer=function(){return t.CubemapShadowMapRenderTargetRenderer.create(this)},r.type="pointLight",__decorate([t.requireSetter(function(e){t.assert(t.JudgeUtils.isDirectObject(e),t.Log.info.FUNC_MUST_BE("shadowRenderList","object"));for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];t.assert(t.JudgeUtils.isArrayExactly(n)||e instanceof wdCb.Hash,t.Log.info.FUNC_MUST_BE("renderList in each direction of shadowRenderList","array"))}})],r.prototype,"shadowRenderList",null),r}(t.SourceLight);t.PointLight=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._constant=1,this._range=null,this._linear=0,this._quadratic=0,this._rangeLevel=0}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"constant",{get:function(){return this._constant},set:function(t){this._constant=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"range",{get:function(){return this._range},set:function(t){this._range=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"linear",{get:function(){return this._linear},set:function(t){this._linear=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"quadratic",{get:function(){return this._quadratic},set:function(t){this._quadratic=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rangeLevel",{get:function(){return this._rangeLevel},set:function(t){this._rangeLevel=t,this.setByRangeLevel()},enumerable:!0,configurable:!0}),e.prototype.setByRangeLevel=function(){switch(this._rangeLevel){case 0:this._range=7,this._linear=.7,this._quadratic=1.8;break;case 1:this._range=13,this._linear=.35,this._quadratic=.44;break;case 2:this._range=20,this._linear=.22,this._quadratic=.2;break;case 3:this._range=32,this._linear=.14,this._quadratic=.07;break;case 4:this._range=50,this._linear=.09,this._quadratic=.032;break;case 5:this._range=65,this._linear=.07,this._quadratic=.017;break;case 6:this._range=100,this._linear=.045,this._quadratic=.0075;break;case 7:this._range=160,this._linear=.027,this._quadratic=.0028;break;case 8:this._range=200,this._linear=.022,this._quadratic=.0019;break;case 9:this._range=325,this._linear=.014,this._quadratic=7e-4;break;case 10:this._range=600,this._linear=.007,this._quadratic=2e-4;break;case 11:this._range=3250,this._linear=.0014,this._quadratic=7e-6;break;default:t.Log.error(!0,"over light range")}},e}();t.Attenuation=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.PHONG="PHONG"]="PHONG",t[t.BLINN="BLINN"]="BLINN",t[t.LAMBERT="LAMBERT"]="LAMBERT",t[t.CONSTANT="CONSTANT"]="CONSTANT"}(t.ELightModel||(t.ELightModel={}));t.ELightModel}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.context=null}return __extends(r,e),Object.defineProperty(r.prototype,"dirty",{get:function(){var t=this.getUIRenderer();return t?t.dirty:!0},set:function(t){if(t){var e=this.getUIRenderer();if(!e)return;e.dirty=t}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"width",{get:function(){return this.entityObject?this.entityObject.transform.width:null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this.entityObject?this.entityObject.transform.height:null},enumerable:!0,configurable:!0}),r.prototype.init=function(){this.context=this.getContext()},r.prototype.addToObject=function(t){e.prototype.addToObject.call(this,t),t.uiManager.addChild(this)},r.prototype.removeFromObject=function(t){e.prototype.removeFromObject.call(this,t),t.uiManager.removeChild(this)},r.prototype.update=function(t){var e=this.context;this.shouldNotUpdate()||(e.save(),this._setCanvasTransformForRotation(),this.draw(t),e.restore())},r.prototype.draw=function(t){},r.prototype.shouldNotUpdate=function(){return!1},r.prototype.getContext=function(){return this.getUIRenderer().context},r.prototype.getCanvas=function(){return this.getUIRenderer().canvas},r.prototype.getUIRenderer=function(){return this.entityObject?this.entityObject.getComponent(t.UIRenderer):null},r.prototype.drawInCenterPoint=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=t[0],n=t[1];if(5===t.length){var o=t[2],i=t[3],a=t[4];r.drawImage(n,o.x-i/2,o.y-a/2,i,a)}else if(9===t.length){var s=t[2],c=t[3],u=t[4],l=t[5],o=t[6],i=t[7],a=t[8];r.drawImage(n,s,c,u,l,o.x-i/2,o.y-a/2,i,a)}},r.prototype._setCanvasTransformForRotation=function(){var t=this.entityObject.transform.rotationMatrix;this.context.setTransform(t.a,t.b,t.c,t.d,t.tx,t.ty)},__decorate([t.virtual],r.prototype,"dirty",null),__decorate([t.require(function(e){t.assert(null!==this.context,t.Log.info.FUNC_SHOULD("set context"))})],r.prototype,"update",null),__decorate([t.virtual],r.prototype,"draw",null),__decorate([t.virtual],r.prototype,"shouldNotUpdate",null),r}(t.Component);t.UI=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(t.EFontXAlignment||(t.EFontXAlignment={}));t.EFontXAlignment}(wd||(wd={}));var wd;!function(t){!function(t){t[t.TOP=0]="TOP",t[t.MIDDLE=1]="MIDDLE",t[t.BOTTOM=2]="BOTTOM"}(t.EFontYAlignment||(t.EFontYAlignment={}));t.EFontYAlignment}(wd||(wd={}));var wd;!function(t){!function(t){t[t.AUTO="auto"]="AUTO"}(t.EFontDimension||(t.EFontDimension={}));t.EFontDimension}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.needFormat=!1,this._isFirstUpdate=!0,this._sizeChangeEventSubscription=null}return __extends(r,e),r.prototype.init=function(){var r=this;e.prototype.init.call(this),this._sizeChangeEventSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.UI_WIDTH_CHANGE).merge(t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.UI_HEIGHT_CHANGE)).subscribe(function(){r.dirty=!0,r.needFormat=!0})},r.prototype.dispose=function(){this._sizeChangeEventSubscription&&this._sizeChangeEventSubscription.dispose()},r.prototype.update=function(t){this._isFirstUpdate?this._isFirstUpdate=!1:this.needFormat&&this.reFormat(),this.needFormat=!1,e.prototype.update.call(this,t)},r.prototype.reFormat=function(){},r.prototype.getLeftCornerPosition=function(){var e=this.entityObject.transform,r=e.position;return t.Vector2.create(r.x-e.width/2,r.y-e.height/2)},__decorate([t.virtual],r.prototype,"reFormat",null),r}(t.UI);t.Font=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=/([a-zA-Z0-9]+|\S)/,r=/^[a-zA-Z0-9]/,n=/[a-zA-Z0-9]+$/,o=/\s+$/,i=function(i){function a(){i.apply(this,arguments),this._text="",this._fontSize=10,this._fontFamily="sans-serif",this._xAlignment=t.EFontXAlignment.LEFT,this._yAlignment=t.EFontYAlignment.TOP,this._fillEnabled=!0,this._fillStyle="rgba(0, 0, 0, 1)",this._strokeEnabled=!1,this._strokeStyle=null,this._strokeSize=null,this._fontClientHeightCache=wdCb.Hash.create(),this._lineHeight=null,this._strArr=[]}return __extends(a,i),a.create=function(){var t=new this;return t},Object.defineProperty(a.prototype,"text",{get:function(){return this._text},set:function(t){t!==this._text&&(this._text=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"fontSize",{get:function(){return this._fontSize},set:function(t){t!==this._fontSize&&(this._fontSize=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"fontFamily",{get:function(){return this._fontFamily},set:function(t){t!==this._fontFamily&&(this._fontFamily=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"xAlignment",{get:function(){return this._xAlignment},set:function(t){t!==this._xAlignment&&(this._xAlignment=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"yAlignment",{get:function(){return this._yAlignment},set:function(t){t!==this._yAlignment&&(this._yAlignment=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),a.prototype.init=function(){i.prototype.init.call(this),this._formatText(),this._lineHeight=this._getDefaultLineHeight()},a.prototype.setFillStyle=function(t){this._fillStyle=t},a.prototype.enableStroke=function(t,e){this._strokeEnabled=!0,this._fillEnabled=!1,this._strokeStyle=t,this._strokeSize=e},a.prototype.enableFill=function(t){this._fillEnabled=!0,this._strokeEnabled=!1,this._fillStyle=t},a.prototype.setLineHeight=function(t){this._lineHeight=t},a.prototype.reFormat=function(){this._formatText(),this._lineHeight=this._getDefaultLineHeight()},a.prototype.draw=function(){var t=this.context;t.font=this.fontSize+"px '"+this.fontFamily+"'",t.textBaseline="top",t.textAlign="start",this._strArr.length>1?this._drawMultiLine():this._drawSingleLine()},a.prototype._formatText=function(){var t=this.width;if(this._trimStr(),0!==t){this._strArr=this._text.split("\n");for(var e=0;e<this._strArr.length;e++){var r=this._strArr[e],n=this._measure(r);n>t&&r.length>1&&this._formatMultiLine(e,r,n,t)}}},a.prototype._trimStr=function(){this._text=this._text.replace(o,"")},a.prototype._formatMultiLine=function(t,o,i,a){var s=this,c=100,u=this,l=null,h=o.length*(a/i)|0,p=o.substr(h),f=0,d=i-this._measure(p),_=0,y=function(){for(;d>a&&c>f;)h*=a/d,h=Math.floor(h),p=o.substr(h),d=i-s._measure(p),f+=1;f=0},g=function(){for(;a>d&&c>f;){if(p){var t=e.exec(p);_=t?t[0].length:1}h+=_,p=o.substr(h),d=i-s._measure(p),f+=1}},m=function(){if(r.test(p)){var t=o.substr(0,h),e=n.exec(t);e&&(h-=e[0].length)}else h-=_;0===h&&(h=1)},v=function(){p=o.substr(h),l=o.substr(0,h),u._strArr[t]=p,u._strArr.splice(t,0,l)};y(),g(),m(),v()},a.prototype._measure=function(t){var e=this.context;return e.font=this.fontSize+"px '"+this.fontFamily+"'",e.measureText(t).width},a.prototype._getDefaultLineHeight=function(){return this._computeLineHeight("normal")},a.prototype._computeLineHeight=function(t){var e=wdCb.DomQuery.create("<div></div>"),r=e.get(0),n=null;return r.style.cssText="\n             font-family: "+this.fontFamily+";\n             font-size: "+this.fontSize+"px;\n             position: absolute;\n             left: -100px;\n             top: -100px;\n             line-height: "+t+";\n             ",e.prependTo("body"),r.innerHTML="abc!",n=r.clientHeight,e.remove(),n},a.prototype._getFontClientHeight=function(){var t=this.fontSize,e=this.fontFamily,r=t+"."+e,n=this._fontClientHeightCache.getChild(r),o=null;return n?n:(o=this._computeLineHeight(1),this._fontClientHeightCache.addChild(r,o),o)},a.prototype._drawMultiLine=function(){var e=this.context,r=this.getLeftCornerPosition(),n=r.x,o=r.y,i=this._lineHeight,a=this._getFontClientHeight(),s=this,c=this._strArr.length,u=(c-1)*i+a;s.yAlignment===t.EFontYAlignment.BOTTOM?o=o+s.height-u:s.yAlignment===t.EFontYAlignment.MIDDLE&&(o+=(s.height-u)/2);for(var l=0,h=this._strArr;l<h.length;l++){var p=h[l];s.xAlignment===t.EFontXAlignment.RIGHT?n=n+s.width-s._measure(p):s.xAlignment==t.EFontXAlignment.CENTER&&(n+=(s.width-s._measure(p))/2),s._fillEnabled?(e.fillStyle=s._fillStyle,e.fillText(p,n,o)):s._strokeEnabled&&(e.strokeStyle=s._strokeStyle,e.lineWidth=s._strokeSize,e.strokeText(p,n,o)),n=r.x,o+=i}},a.prototype._drawSingleLine=function(){var e=this.context,r=this.getLeftCornerPosition(),n=r.x,o=r.y,i=this._getFontClientHeight(),a=this,s=i,c=this._strArr[0];a.yAlignment===t.EFontYAlignment.BOTTOM?o=o+a.height-s:a.yAlignment===t.EFontYAlignment.MIDDLE&&(o+=(a.height-s)/2),a.xAlignment===t.EFontXAlignment.RIGHT?n=n+a.width-a._measure(c):a.xAlignment==t.EFontXAlignment.CENTER&&(n+=(a.width-a._measure(c))/2),a._fillEnabled?(e.fillStyle=a._fillStyle,e.fillText(c,n,o)):a._strokeEnabled&&(e.strokeStyle=a._strokeStyle,e.lineWidth=a._strokeSize,e.strokeText(c,n,o))},a}(t.Font);t.PlainFont=i}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._text="",this._xAlignment=t.EFontXAlignment.LEFT,this.fntId=null,this.bitmapId=null,this._charFontList=wdCb.Collection.create()}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"text",{get:function(){return this._text},set:function(t){t!==this._text&&(this._text=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"xAlignment",{get:function(){return this._xAlignment},set:function(t){t!==this._xAlignment&&(this._xAlignment=t,this.dirty=!0,this.needFormat=!0)},enumerable:!0,configurable:!0}),r.prototype.init=function(){var r=this._getFntObj(),n=this._getImageAsset();return r?n?(e.prototype.init.call(this),this._createAndAddFontCharUIObjects(r,n.source),void this._formatText(r)):(t.Log.log("impossible to create font: not find bitmap file"),!1):(t.Log.log("impossible to create font: not find fnt file"),!1)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._removeAllCharFont()},r.prototype.reFormat=function(){var e=this._getFntObj(),r=this._getImageAsset();return this._removeAllCharFont(),e?r?(this._createAndAddFontCharUIObjects(e,r.source),void this._formatText(e)):(t.Log.log("impossible to create font: not find bitmap file"),
!1):(t.Log.log("impossible to create font: not find fnt file"),!1)},r.prototype._getFntObj=function(){return t.LoaderManager.getInstance().get(this.fntId)},r.prototype._getImageAsset=function(){return t.LoaderManager.getInstance().get(this.bitmapId)},r.prototype._createAndAddFontCharUIObjects=function(e,r){for(var n=this.text,o=e.fontDefDictionary,i=0,a=0,s=this.getLeftCornerPosition(),c=this.getUIRenderer(),u=null,l=null,h=0,p=n.length;p>h;h++){var f=String(n.charCodeAt(h)),d=n[h];if(this._isNewLine(d)){var _=this._createAndAddFontCharObjectOfNewLineChar(h,d,c);u=_.charFontUIObject,l=_.charFont,this._setCharFontUIObjectPosition(u,s.x+i,s.y+a),l.startPosX=i,l.xAdvance=0,i=0,a+=e.commonHeight}else{var y=this._getFontDef(o,f),g=null;y?(g=this._createAndAddFontCharObjectOfCommonChar(y,r,h,d,c),u=g.charFontUIObject,l=g.charFont,this._setCharFontUIObjectPosition(u,s.x+i+y.xOffset,s.y+a+y.yOffset),l.startPosX=i,l.xAdvance=y.xAdvance,i+=y.xAdvance):t.Log.log("character not found "+d)}}},r.prototype._createAndAddFontCharObjectOfNewLineChar=function(e,r,n){var o=this._findCharFontUIObject(e),i=null;if(o)i=o.getComponent(t.CharFont);else{var a=this._createCharFont(e,n);o=a.charFontUIObject,i=a.charFont,this._addCharFontUIObject(o)}return i["char"]=r,{charFontUIObject:o,charFont:i}},r.prototype._createAndAddFontCharObjectOfCommonChar=function(e,r,n,o,i){var a=t.RectRegion.create(e.rect.x,e.rect.y,e.rect.width,e.rect.height),s=this._findCharFontUIObject(n),c=null;if(s)c=s.getComponent(t.CharFont);else{var u=this._createCharFont(n,i),l=null;s=u.charFontUIObject,l=s.transform,c=u.charFont,c.image=r,c.rectRegion=a,l.width=a.width,l.height=a.height,this._addCharFontUIObject(s)}return c["char"]=o,{charFontUIObject:s,charFont:c}},r.prototype._formatText=function(t){this.width>0&&this._formatMultiLine(t),this._formatAlign()},r.prototype._formatMultiLine=function(e){for(var r=(this.entityObject,null),n=null,o=this.getLeftCornerPosition(),i=0,a=0,s=e.commonHeight,c=1,u=this.text.length;u>c;c++)if(r=this._findCharFontUIObject(c),n=r.getComponent(t.CharFont),this._isNewLine(n["char"])&&(n.isNewLine=!0,n.isFullLine=!1,this._translateCharFontUIObject(r,-i,a),i=0),this._isExceedWidth(o,n,i)){var l=this._findCharFontUIObject(c-1);if(l){var h=l.getComponent(t.CharFont);h.isNewLine=!0,this._isSpaceUnicode(h["char"])||(h.isFullLine=!0)}i=this._getLetterPosXLeft(n),a+=s,this._translateCharFontUIObject(r,-i,a)}else this._translateCharFontUIObject(r,-i,a)},r.prototype._formatAlign=function(){var e=this.getLeftCornerPosition(),r=this;if(this._xAlignment!=t.EFontXAlignment.LEFT){var n=[];this._charFontList.forEach(function(o){var i=o.getComponent(t.CharFont);return i.isNewLine?i.isNewLine&&i.isFullLine?void(n=[]):(r._alignLine(e,n,n[n.length-1]),void(n=[])):void n.push(i)}),n.length>0&&r._alignLine(e,n,n[n.length-1])}},r.prototype._createCharFont=function(e,r){var n=t.UIObject.create(),o=t.CharFont.create();return n.addComponent(o),n.addComponent(r),n.addTag(String(e)),n.init(),{charFontUIObject:n,charFont:o}},r.prototype._addCharFontUIObject=function(t){this._charFontList.addChild(t),this.entityObject.addChild(t)},r.prototype._findCharFontUIObject=function(t){return this.entityObject.findChildByTag(String(t))},r.prototype._isSpaceUnicode=function(t){var e=t.charCodeAt(0);return 32==e||133==e||160==e||5760==e||e>=8192&&8202>=e||8232==e||8233==e||8239==e||8287==e||12288==e},r.prototype._isNewLine=function(t){return 10==t.charCodeAt(0)},r.prototype._getLetterPosXLeft=function(t){return t.startPosX},r.prototype._getLetterPosXRight=function(e,r){return t.CoordinateUtils.convertCenterPositionXToLeftCornerPositionX(r.x,r.width)-e.x+r.xAdvance},r.prototype._getFontDef=function(t,e){return t[e]},r.prototype._isExceedWidth=function(t,e,r){return this._getLetterPosXRight(t,e)-r>this.width},r.prototype._alignLine=function(e,r,n){var o=this;r=this._trimBottomSpaceChar(r),n=r[r.length-1],r.forEach(function(r){var i=null,a=o._getLetterPosXRight(e,n);switch(o._xAlignment){case t.EFontXAlignment.CENTER:i=(o.width-a)/2;break;case t.EFontXAlignment.RIGHT:i=o.width-a}r.x=r.x+i})},r.prototype._trimBottomSpaceChar=function(t){var e=t.length-1;for(this._isNewLine(t[e]["char"])&&(e-=1);e>=0&&this._isSpaceUnicode(t[e]["char"]);)e-=1;return t=t.splice(0,e+1)},r.prototype._setCharFontUIObjectPosition=function(e,r,n){var o=e.transform;e.transform.position=t.CoordinateUtils.convertLeftCornerPositionToCenterPosition(t.Vector2.create(r,n),o.width,o.height)},r.prototype._translateCharFontUIObject=function(t,e,r){t.transform.translate(e,r)},r.prototype._removeAllCharFont=function(){this._charFontList.forEach(function(t){t.dispose()}),this._charFontList.removeAllChildren()},__decorate([t.require(function(e){if(this.width>0)for(var r=1,n=this.text.length;n>r;r++){var o=this.entityObject.findChildByTag(String(r));t.assert(!!o,"char not has corresponding entityObject"),t.assert(o.hasComponent(t.CharFont),t.Log.info.FUNC_SHOULD("char entityObject","contain CharFont component"))}})],r.prototype,"_formatText",null),r}(t.Font);t.BitmapFont=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._char=null,this.startPosX=null,this.xAdvance=null,this.image=null,this.rectRegion=null,this.isNewLine=!1,this.isFullLine=!1,this._subscription=null}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"x",{get:function(){return this.entityObject.transform.position.x},set:function(e){var r=this.entityObject.transform.position;this.entityObject.transform.position=t.Vector2.create(e,r.y)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this.entityObject.transform.position.y},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"char",{get:function(){return this._char},set:function(e){return null!==this._char?void t.Log.log(t.Log.info.FUNC_NOT_SUPPORT("change char")):void(this._char=e)},enumerable:!0,configurable:!0}),r.prototype.init=function(){var r=this;e.prototype.init.call(this),this._subscription=wdFrp.fromArray([t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_TRANSLATE),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_ROTATE),t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.TRANSFORM_SCALE)]).mergeAll().subscribe(function(){r.dirty=!0})},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._subscription.dispose()},r.prototype.shouldNotUpdate=function(){return null===this.rectRegion||0===this.width&&0===this.height},r.prototype.draw=function(t){var e=null,r=null,n=null,o=null;e=this.entityObject.transform,r=e.position,n=this.width,o=this.height,this.drawInCenterPoint(this.context,this.image,this.rectRegion.x,this.rectRegion.y,this.rectRegion.width,this.rectRegion.height,r,n,o)},__decorate([t.execOnlyOnce("_isInit")],r.prototype,"init",null),r}(t.Font);t.CharFont=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._percent=0,this.borderStyle="rgba(0, 0, 0, 1)",this.fillStyle="rgba(255, 0, 0, 1)",this.radius=5,this._offScreenCanvas=null,this._offScreenContext=null}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"percent",{get:function(){return this._percent},set:function(t){this._percent!==t&&(this._percent=t,this.dirty=!0)},enumerable:!0,configurable:!0}),r.prototype.init=function(){e.prototype.init.call(this),this._createOffScreenCanvas(),this._drawProgressBar()},r.prototype.shouldNotUpdate=function(){return this.percent<=0},r.prototype.draw=function(t){var e=this.entityObject.transform.position;this._drawFromLeft(e),this._drawBorder(e)},r.prototype._drawFromLeft=function(e){var r=this._offScreenCanvas,n=this.width*this.percent;this.drawInCenterPoint(this.context,r,0,0,n,this.height,t.Vector2.create(e.x-this.width/2+n/2,e.y),n,this.height)},r.prototype._drawBorder=function(e){t.RoundedRectUtils.drawRoundedRect(this.context,this.borderStyle,null,e.x-this.width/2,e.y-this.height/2,this.width,this.height,this.radius)},r.prototype._createOffScreenCanvas=function(){var t=wdCb.DomQuery.create("<canvas></canvas>");t.attr("width",this.context.canvas.width),t.attr("height",this.context.canvas.height),this._offScreenCanvas=t.get(0),this._offScreenContext=this._offScreenCanvas.getContext("2d")},r.prototype._drawProgressBar=function(){this._offScreenContext.clearRect(0,0,this._offScreenCanvas.width,this._offScreenCanvas.height),t.RoundedRectUtils.drawRoundedRect(this._offScreenContext,this.borderStyle,this.fillStyle,0,0,this.width,this.height,this.radius)},__decorate([t.require(function(e){t.assert(this.percent>=0&&this.percent<=1,t.Log.info.FUNC_SHOULD("percent"," >= 0 and <= 1"))})],r.prototype,"draw",null),r}(t.UI);t.ProgressBar=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){function e(){var t=null,e=null;return"undefined"==typeof document?!1:(t=document.createElement("canvas"),t.width=1,t.height=1,e=t.getContext("2d"),e.fillStyle="#000",e.fillRect(0,0,1,1),e.globalCompositeOperation="multiply",e.fillStyle="#fff",e.fillRect(0,0,1,1),0===e.getImageData(0,0,1,1).data[0])}var r=function(r){function n(){r.apply(this,arguments),this._source=null,this.color=null,this.targetSource=null,this.targetColor=null}return __extends(n,r),n.create=function(){var t=new this;return t},Object.defineProperty(n.prototype,"source",{get:function(){return this._source},set:function(t){t!==this._source&&(this._source=t,this.dirty=!0)},enumerable:!0,configurable:!0}),n.prototype.shouldNotUpdate=function(){return null===this._getDrawSource()&&null===this._getDrawColor()},n.prototype.draw=function(t){var e=this._getDrawColor(),r=this._getDrawSource();if(null!==e){var n=this.entityObject.transform.position;this._setFillStyle(e.toString()),e.a<1&&this._setGlobalAlpha(this.context,e.a),this.context.fillRect(n.x-this.width/2,n.y-this.height/2,this.width,this.height),r&&this._blendColorWithSource()}else this.drawInCenterPoint(this.context,r.source,this.entityObject.transform.position,this.width,this.height)},n.prototype._setFillStyle=function(t){this.context.fillStyle=t},n.prototype._getDrawSource=function(){return this.targetSource?this.targetSource:this.source},n.prototype._getDrawColor=function(){return this.targetColor?this.targetColor:this.color},n.prototype._blendByMultiply=function(){this._setGlobalCompositeOperation(this.context,"multiply"),this.drawInCenterPoint(this.context,this._getDrawSource().source,this.entityObject.transform.position,this.width,this.height)},n.prototype._blendByPerPixel=function(){var t=this.context,e=this.getCanvas(),r=this.color.r,n=this.color.g,o=this.color.b,i=null,a=null;t.globalCompositeOperation="copy",this.drawInCenterPoint(this.context,this._getDrawSource().source,this.entityObject.transform.position,this.width,this.height),i=t.getImageData(0,0,e.width,e.height),a=i.data;for(var s=0,c=a.length;c>s;s+=4)a[s]*=r,a[s+1]*=n,a[s+2]*=o;t.putImageData(i,0,0)},n.prototype._setGlobalCompositeOperation=function(t,e){t.globalCompositeOperation=e},n.prototype._setGlobalAlpha=function(t,e){t.globalAlpha=e},n.constructorForBlend=function(t){return t._blendColorWithSource=e()?t._blendByMultiply:t._blendByPerPixel,!0},n.constructorInitForBlend=n.constructorForBlend(n.prototype),__decorate([t.require(function(){t.assert(!!this._getDrawSource(),t.Log.info.FUNC_SHOULD("source","exist"))})],n.prototype,"_blendByMultiply",null),__decorate([t.require(function(){t.assert(!!this._getDrawSource(),t.Log.info.FUNC_SHOULD("source","exist"))})],n.prototype,"_blendByPerPixel",null),n}(t.UI);t.Image=r}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.p_transitionMode=null,this.transitionManager=t.TransitionManager.create(this)}return __extends(r,e),Object.defineProperty(r.prototype,"transitionMode",{get:function(){return this.p_transitionMode},set:function(t){this.p_transitionMode=t},enumerable:!0,configurable:!0}),r}(t.UI);t.InteractionUI=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._text=null,this._mousedownSubscription=null,this._mouseupSubscription=null,this._mouseoverSubscription=null,this._mouseoutSubscription=null,this._stateMachine=t.UIStateMachine.create(this)}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(r.prototype,"text",{get:function(){var e=null;return null===this.entityObject?this._text:(e=this.getObject(t.EButtonObjectName.TEXT),e?e.getComponent(t.PlainFont).text:null)},set:function(e){var r=null;this._text=e,null!==this.entityObject&&this.getUIRenderer()&&(r=this.getObject(t.EButtonObjectName.TEXT),r?r.getComponent(t.PlainFont).text=e:this.entityObject.addChild(this._createFontObject()))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isDisabled",{get:function(){return this._stateMachine.currentState===t.EUIState.DISABLED},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"currentState",{get:function(){return this._stateMachine.currentState},enumerable:!0,configurable:!0}),r.prototype.initWhenCreate=function(){this.transitionMode=t.ETransitionMode.SPRITE,this.text="button"},r.prototype.init=function(){e.prototype.init.call(this),this._hasFontObject()||this.entityObject.addChild(this._createFontObject()),this.entityObject.addChild(this._createBackgroundObject()),this._bindEvent()},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._mousedownSubscription.dispose(),this._mouseupSubscription.dispose(),this._mouseoverSubscription.dispose(),this._mouseoutSubscription.dispose()},r.prototype.getObject=function(t){return this.entityObject.findChildByName(t)},r.prototype.getObjectTransition=function(t){return this.transitionManager.getObjectTransition(t)},r.prototype.enable=function(){this._stateMachine.changeState(t.EUIState.NORMAL)},r.prototype.disable=function(){this._stateMachine.changeState(t.EUIState.DISABLED)},r.prototype.update=function(e){var r=this.transitionManager.getObjectTarget(t.EButtonObjectName.BACKGROUND);if(r)switch(this.p_transitionMode){case t.ETransitionMode.SPRITE:this.getObject(t.EButtonObjectName.BACKGROUND).getComponent(t.Image).targetSource=r;break;case t.ETransitionMode.COLOR:this.getObject(t.EButtonObjectName.BACKGROUND).getComponent(t.Image).targetColor=r;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("transitionMode"))}else{var n=this.getObject(t.EButtonObjectName.BACKGROUND).getComponent(t.Image);switch(this.p_transitionMode){case t.ETransitionMode.SPRITE:n.targetSource=null;break;case t.ETransitionMode.COLOR:n.targetColor=null;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("transitionMode"))}}},r.prototype._createBackgroundObject=function(){var e=t.UIObject.create(),r=t.Image.create(),n=this.entityObject.transform;return e.addComponent(r),e.addComponent(this.getUIRenderer()),e.transform.width=n.width,e.transform.height=n.height,e.transform.zIndex=1,e.name=t.EButtonObjectName.BACKGROUND,e},r.prototype._createFontObject=function(){var e=t.UIObject.create(),r=t.PlainFont.create(),n=this.entityObject.transform;return r.text=this._text,r.enableFill("#000000"),r.xAlignment=t.EFontXAlignment.CENTER,r.yAlignment=t.EFontYAlignment.MIDDLE,e.addComponent(r),e.addComponent(this.getUIRenderer()),e.transform.width=n.width,e.transform.height=n.height,e.transform.zIndex=2,e.name=t.EButtonObjectName.TEXT,e},r.prototype._hasFontObject=function(){return!!this.getObject(t.EButtonObjectName.TEXT)},r.prototype._bindEvent=function(){var e=this;this._mousedownSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MOUSE_DOWN).filter(function(t){return!e.isDisabled}).subscribe(function(r){e._stateMachine.changeState(t.EUIState.PRESSED)}),this._mouseupSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MOUSE_UP).filter(function(t){return!e.isDisabled}).subscribe(function(t){e._stateMachine.backState()}),this._mouseoverSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MOUSE_OVER).filter(function(t){return!e.isDisabled}).subscribe(function(r){e._stateMachine.changeState(t.EUIState.HIGHLIGHT)}),this._mouseoutSubscription=t.EventManager.fromEvent(this.entityObject,t.EEngineEvent.MOUSE_OUT).filter(function(t){return!e.isDisabled}).subscribe(function(t){e._stateMachine.backState()})},__decorate([t.require(function(e){t.assert(this.getObject(t.EButtonObjectName.BACKGROUND).hasComponent(t.Image),t.Log.info.FUNC_SHOULD("Button UIObject","contain Image component"))})],r.prototype,"update",null),r}(t.InteractionUI);t.Button=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BACKGROUND="background"]="BACKGROUND",t[t.TEXT="text"]="TEXT"}(t.EButtonObjectName||(t.EButtonObjectName={}));t.EButtonObjectName}(wd||(wd={}));var wd;!function(t){!function(t){t[t.NORMAL=0]="NORMAL",t[t.HIGHLIGHT=1]="HIGHLIGHT",t[t.PRESSED=2]="PRESSED",t[t.DISABLED=3]="DISABLED"}(t.EUIState||(t.EUIState={}));t.EUIState}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this._ui=null,this._stateHistory=wdCb.Stack.create(),this._ui=t}return e.create=function(t){var e=new this(t);return e},Object.defineProperty(e.prototype,"transitionManager",{get:function(){return this._ui.transitionManager},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentState",{get:function(){return this._stateHistory.top||t.EUIState.NORMAL},enumerable:!0,configurable:!0}),e.prototype.changeState=function(t){this._stateHistory.push(t),this.transitionManager.changeState(t),this._ui.dirty=!0},e.prototype.backState=function(){var e=null;this._stateHistory.pop(),e=this._stateHistory.top,e||(e=t.EUIState.NORMAL),this.transitionManager.changeState(e),this._ui.dirty=!0},e}();t.UIStateMachine=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._target=null}return Object.defineProperty(e.prototype,"target",{get:function(){return null===this._target&&this.changeState(t.EUIState.NORMAL),this._target},set:function(t){this._target=t},enumerable:!0,configurable:!0}),e}();t.Transition=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.normalSprite=null,this.highlightSprite=null,this.pressedSprite=null,this.disabledSprite=null}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.changeState=function(e){switch(e){case t.EUIState.NORMAL:this.target=this.normalSprite;break;case t.EUIState.HIGHLIGHT:this.target=this.highlightSprite;break;case t.EUIState.PRESSED:this.target=this.pressedSprite;break;case t.EUIState.DISABLED:this.target=this.disabledSprite;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("state"))}},r}(t.Transition);t.SpriteTransition=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.normalColor=null,this.highlightColor=null,this.pressedColor=null,this.disabledColor=null}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.changeState=function(e){switch(e){case t.EUIState.NORMAL:this.target=this.normalColor;break;case t.EUIState.HIGHLIGHT:this.target=this.highlightColor;break;case t.EUIState.PRESSED:this.target=this.pressedColor;break;case t.EUIState.DISABLED:this.target=this.disabledColor;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("state"))}},r}(t.Transition);t.ColorTransition=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.SPRITE=0]="SPRITE",t[t.COLOR=1]="COLOR"}(t.ETransitionMode||(t.ETransitionMode={}));t.ETransitionMode}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){this._ui=null,this._spriteTransitionMap=wdCb.Hash.create(),this._colorTransitionMap=wdCb.Hash.create(),this._ui=t}return e.create=function(t){var e=new this(t);return e},e.prototype.getObjectTransition=function(t){var e=this._getTransitionMap().getChild(t);return e||(e=this._createTransitionInstance(),this._getTransitionMap().addChild(t,e)),e},e.prototype.getObjectTarget=function(t){return this.getObjectTransition(t).target},e.prototype.changeState=function(t){wdFrp.fromArray([this._spriteTransitionMap,this._colorTransitionMap]).subscribe(function(e){e.forEach(function(e){e.changeState(t)})})},e.prototype._getTransitionMap=function(){var e=null;switch(this._ui.transitionMode){case t.ETransitionMode.SPRITE:e=this._spriteTransitionMap;break;case t.ETransitionMode.COLOR:e=this._colorTransitionMap;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("transitionMode"))}return e},e.prototype._createTransitionInstance=function(){var e=null;switch(this._ui.transitionMode){case t.ETransitionMode.SPRITE:e=t.SpriteTransition.create();break;case t.ETransitionMode.COLOR:e=t.ColorTransition.create();break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("transitionMode"))}return e},e}();t.TransitionManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.drawRoundedRect=function(t,e,r,n,o,i,a,s){t.save(),t.beginPath(),i>0?t.moveTo(n+s,o):t.moveTo(n-s,o),t.arcTo(n+i,o,n+i,o+a,s),t.arcTo(n+i,o+a,n,o+a,s),t.arcTo(n,o+a,n,o,s),i>0?t.arcTo(n,o,n+s,o,s):t.arcTo(n,o,n-s,o,s),t.closePath(),t.strokeStyle=e,t.fillStyle=r,e&&t.stroke(),r&&t.fill(),t.restore()},t}();t.RoundedRectUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.isView=function(t){return!!t&&t.offset&&t.width&&t.height&&this.isFunction(t.getContext)},r.isEqual=function(t,e){return!t&&e||t&&!e?!1:t.uid&&e.uid?t.uid===e.uid:t===e},r.isPowerOfTwo=function(t){return 0===(t&t-1)&&0!==t},r.isFloatArray=function(e){return"[object Float32Array]"===t.EntityObject.prototype.toString.call(e)||"[object Float16Array]"===t.EntityObject.prototype.toString.call(e)},r.isInterface=function(t,e){return!!t[e]},r.isSpacePartitionObject=function(e){return e.hasComponent(t.SpacePartition)},r.isSelf=function(t,e){return t.uid===e.uid},r.isComponenet=function(t){return void 0!==t.entityObject},r.isDom=function(t){return null!==Object.prototype.toString.call(t).match(/\[object HTML\w+/)},r}(wdCb.JudgeUtils);t.JudgeUtils=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){}return e.clamp=function(t,e,r){return e>t?e:t>r?r:t},e.bigThan=function(t,e){return e>t?e:t},e.generateZeroToOne=function(){return Math.random()},e.generateInteger=function(t,e){var e=e+1;return Math.floor(Math.random()*(e-t)+t)},e.mod=function(t,e){var r=Math.floor(t/e);return t-=r*e,0>t&&(t+=e),t},e.maxFloorIntegralMultiple=function(t,e){return 0==e?t:e>t?0:Math.floor(t/e)*e},__decorate([t.require(function(e,r){t.assert(r>e,t.Log.info.FUNC_SHOULD("min","< max"))})],e,"generateInteger",null),__decorate([t.ensure(function(e){t.assert(e>=0)})],e,"mod",null),__decorate([t.require(function(e,r){t.assert(e>=0&&r>=0,t.Log.info.FUNC_SHOULD("param",">= 0"))}),t.ensure(function(e){t.assert(e>=0)})],e,"maxFloorIntegralMultiple",null),e}();t.MathUtils=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){}return e.convertWebGLPositionToCanvasPosition=function(e){var r=t.DeviceManager.getInstance().view;return t.Vector2.create(r.width/2+e.x,r.height/2-e.y)},e.convertCanvasPositionToWebGLPosition=function(e){var r=t.DeviceManager.getInstance().view;return t.Vector3.create(e.x-r.width/2,r.height/2-e.y,0)},e.convertLeftCornerPositionToCenterPosition=function(e,r,n){return t.Vector2.create(this.convertLeftCornerPositionXToCenterPositionX(e.x,r),this.convertLeftCornerPositionYToCenterPositionY(e.y,n))},e.convertLeftCornerPositionXToCenterPositionX=function(t,e){return t+e/2},e.convertLeftCornerPositionYToCenterPositionY=function(t,e){return t+e/2},e.convertCenterPositionToLeftCornerPosition=function(e,r,n){return t.Vector2.create(this.convertCenterPositionXToLeftCornerPositionX(e.x,r),this.convertCenterPositionYToLeftCornerPositionY(e.y,n))},e.convertCenterPositionXToLeftCornerPositionX=function(t,e){return t-e/2},e.convertCenterPositionYToLeftCornerPositionY=function(t,e){return t-e/2},__decorate([t.require(function(){t.assert(!!t.DeviceManager.getInstance().view,t.Log.info.FUNC_SHOULD("set view"))})],e,"convertWebGLPositionToCanvasPosition",null),__decorate([t.require(function(){t.assert(!!t.DeviceManager.getInstance().view,t.Log.info.FUNC_SHOULD("set view"))})],e,"convertCanvasPositionToWebGLPosition",null),e}();t.CoordinateUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(wdCb.Log);t.Log=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this.elapsed=null,this.pauseElapsed=0,this.pauseTime=null,this.startTime=null}return e.prototype.start=function(){this.startTime=this.getNow(),this.pauseElapsed=null},e.prototype.stop=function(){this.startTime=null},e.prototype.pause=function(){this.pauseTime=this.getNow()},e.prototype.resume=function(){this.pauseElapsed+=this.getNow()-this.pauseTime,this.pauseTime=null},e.prototype.computeElapseTime=function(t){return this.pauseElapsed?this.elapsed=t-this.pauseElapsed-this.startTime:this.elapsed=t-this.startTime,this.elapsed<0&&(this.elapsed=0),this.elapsed},__decorate([t.ensure(function(){t.assert(this.elapsed>=0,t.Log.info.FUNC_SHOULD("elapsed:"+this.elapsed,">= 0"))})],e.prototype,"computeElapseTime",null),e}();t.TimeController=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=60,r=1e3,n=function(n){function o(){n.apply(this,arguments),this.gameTime=null,this.fps=null,this.isTimeChange=!1,this.deltaTime=null,this._lastTime=null}return __extends(o,n),o.create=function(){var t=new this;return t},o.prototype.tick=function(t){this.deltaTime=null!==this._lastTime?t-this._lastTime:t,this._updateFps(this.deltaTime),this.gameTime=t/r,this._lastTime=t},o.prototype.start=function(){n.prototype.start.call(this),this.isTimeChange=!0,this.elapsed=0},o.prototype.resume=function(){n.prototype.resume.call(this),this.isTimeChange=!0},o.prototype.getNow=function(){return t.root.performance.now()},o.prototype._updateFps=function(t){null===this._lastTime?this.fps=e:this.fps=1e3/t},o}(t.TimeController);t.DirectorTimeController=n}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.getNow=function(){return t.Director.getInstance().isTimeChange?t.Director.getInstance().elapsed:t.root.performance.now()},r}(t.TimeController);t.CommonTimeController=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(t){this.texture=null,this.frameBufferOperator=null,this.texture=t}return e.prototype.initWhenCreate=function(){this.frameBufferOperator=t.FrameBuffer.create(this.texture.width,this.texture.height)},e.prototype.init=function(){this.texture.createEmptyTexture(),this.initFrameBuffer()},e.prototype.render=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=t[0];if(this.beforeRender(),1===t.length)this.renderFrameBufferTexture(r);else{var n=t[1];this.renderFrameBufferTexture(r,n)}this.afterRender()},e.prototype.dispose=function(){this.frameBufferOperator.dispose(),
this.disposeFrameBuffer(),this.texture.dispose()},e.prototype.beforeRender=function(){},e.prototype.afterRender=function(){},__decorate([t.virtual],e.prototype,"beforeRender",null),__decorate([t.virtual],e.prototype,"afterRender",null),e}();t.RenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.frameBuffer=null,this.renderBuffer=null,this._lastCamera=null}return __extends(r,e),r.prototype.initFrameBuffer=function(){var e=this.frameBufferOperator,r=t.DeviceManager.getInstance().gl;this.frameBuffer=e.createFrameBuffer(),this.renderBuffer=e.createRenderBuffer(),e.bindFrameBuffer(this.frameBuffer),e.attachTexture(r.TEXTURE_2D,this.texture.glTexture),e.attachRenderBuffer("DEPTH_ATTACHMENT",this.renderBuffer),e.check(),e.unBind()},r.prototype.renderFrameBufferTexture=function(t,e){var r=this.createCamera(e);this._lastCamera&&this._lastCamera.dispose(),this._lastCamera=r,this.beforeRenderFrameBufferTexture(r),this.frameBufferOperator.bindFrameBuffer(this.frameBuffer),this.texture.bindToUnit(0),this.frameBufferOperator.setViewport(),this.getRenderList().forEach(function(e){e.render(t,r)}),t.clear(),this.renderRenderer(t),this.frameBufferOperator.unBind(),this.frameBufferOperator.restoreViewport()},r.prototype.disposeFrameBuffer=function(){var e=t.DeviceManager.getInstance().gl;e.deleteFramebuffer(this.frameBuffer),e.deleteRenderbuffer(this.renderBuffer)},r}(t.RenderTargetRenderer);t.TwoDRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(),e},r.prototype.beforeRenderFrameBufferTexture=function(t){},r.prototype.getRenderList=function(){return this.texture.renderList},r.prototype.renderRenderer=function(e){this._setSceneSide(t.ESide.BACK),e.render(),this._setSceneSide(null)},r.prototype.createCamera=function(e){var r=null,n=null,o=e.getComponent(t.CameraController),i=null,a=null;return n=this.texture.getPlane(),i=n.getReflectionMatrix().applyMatrix(o.worldToCameraMatrix),a=this._setClipPlane(i,o.pMatrix,n),r=t.PerspectiveCamera.create(),r.worldToCameraMatrix=i.copy(),r.pMatrix=a,t.GameObject.create().addComponent(t.BasicCameraController.create(r)).init()},r.prototype._setSceneSide=function(e){var r=t.Director.getInstance().scene;r.side=e},r.prototype._setClipPlane=function(e,r,n){var o=r.copy(),i=t.Vector4.create(),a=this._getClipPlaneInCameraSpace(e,n),s=t.Vector4.create();return i.x=(Math.sign(a.x)+o.values[8])/o.values[0],i.y=(Math.sign(a.y)+o.values[9])/o.values[5],i.z=-1,i.w=(1+o.values[10])/o.values[14],s=a.multiplyScalar(2/a.dot(i)),o.values[2]=s.x,o.values[6]=s.y,o.values[10]=s.z+1,o.values[14]=s.w,o},r.prototype._getClipPlaneInCameraSpace=function(e,r){var n=t.Vector4.create(),o=e.multiplyPoint(this.texture.getPosition()),i=e.copy().invert().transpose().multiplyPoint(r.normal).normalize();return n.set(i.x,i.y,i.z,-o.dot(i)),n},r}(t.TwoDRenderTargetRenderer);t.MirrorRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(t){e.call(this,t.shadowMap),this._light=null,this._shadowMapRendererUtils=null,this._light=t}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(),e},r.prototype.initWhenCreate=function(){this._shadowMapRendererUtils=t.TwoDShadowMapRenderTargetRendererUtils.create(this._light,this.texture),e.prototype.initWhenCreate.call(this)},r.prototype.init=function(){var r=this;this._handleShadowRendererList(),this._shadowMapRendererUtils.bindEndLoop(function(){r._light.shadowRenderList.forEach(function(t){r._shadowMapRendererUtils.clearTwoDShadowMapData(t)})}),this._shadowMapRendererUtils.createShaderWithShaderLib(t.BuildTwoDShadowMapShaderLib.create()),e.prototype.init.call(this)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._shadowMapRendererUtils.unBindEndLoop()},r.prototype.beforeRenderFrameBufferTexture=function(t){var e=this;this._light.shadowRenderList.removeRepeatItems().forEach(function(r){e._shadowMapRendererUtils.setShadowMapData(r,t)})},r.prototype.getRenderList=function(){return this._light.shadowRenderList},r.prototype.renderRenderer=function(t){t.render()},r.prototype.beforeRender=function(){this._shadowMapRendererUtils.beforeRender()},r.prototype.afterRender=function(){this._shadowMapRendererUtils.afterRender()},r.prototype.createCamera=function(){var e=t.OrthographicCamera.create(),r=this._light,n=t.GameObject.create();return e.left=r.shadowCameraLeft,e.right=r.shadowCameraRight,e.top=r.shadowCameraTop,e.bottom=r.shadowCameraBottom,e.near=r.shadowCameraNear,e.far=r.shadowCameraFar,n.addComponent(t.BasicCameraController.create(e)),n.transform.translate(r.position),n.transform.lookAt(0,0,0),n.init(),n},r.prototype._handleShadowRendererList=function(){var t=this,e=this,r=[];this._light.shadowRenderList.forEach(function(e){r=r.concat(t._shadowMapRendererUtils.addAllChildren(e))},this),this._light.shadowRenderList.addChildren(r),this._light.shadowRenderList.removeChild(function(t){return e._shadowMapRendererUtils.isContainer(t)})},r}(t.TwoDRenderTargetRenderer);t.TwoDShadowMapRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._frameBufferList=wdCb.Collection.create(),this._renderBufferList=wdCb.Collection.create(),this._lastCameraList=null,this._lastPosition=null}return __extends(r,e),r.prototype.initFrameBuffer=function(){for(var e=this.frameBufferOperator,r=t.DeviceManager.getInstance().gl,n=0;6>n;n++){var o=e.createFrameBuffer(),i=e.createRenderBuffer();this._frameBufferList.addChild(o),this._renderBufferList.addChild(i),e.bindFrameBuffer(o),e.attachTexture(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,this.texture.glTexture),e.attachRenderBuffer("DEPTH_ATTACHMENT",i),e.check()}e.unBind()},r.prototype.renderFrameBufferTexture=function(t,e){var r=null,n=null,o=null,i=this.getPosition(),a=null;a=this.getRenderList(),this.texture.bindToUnit(0),this._needCreateCamera(i)&&(o=wdCb.Collection.create());for(var s=0;6>s;s++)n=a.getChild(this._convertIndexToFaceKey(s)),this._isEmpty(n)||(this._needCreateCamera(i)?(r=this.createCamera(s),o.addChild(r)):r=this._lastCameraList.getChild(s),this.frameBufferOperator.bindFrameBuffer(this._frameBufferList.getChild(s)),this.frameBufferOperator.setViewport(),n.forEach(function(e){e.render(t,r)}),t.clear(),t.render());this._needCreateCamera(i)&&(this._lastCameraList&&this._lastCameraList.forEach(function(t){t.dispose()}),this._lastCameraList=o,this._lastPosition=i),this.frameBufferOperator.unBind(),this.frameBufferOperator.restoreViewport()},r.prototype.disposeFrameBuffer=function(){var e=t.DeviceManager.getInstance().gl;this._frameBufferList.forEach(function(t){return e.deleteFramebuffer(t)}),this._renderBufferList.forEach(function(t){return e.deleteRenderbuffer(t)})},r.prototype.createCamera=function(e){var r=t.PerspectiveCamera.create(),n=t.GameObject.create(),o=this.getPosition();return r.fovy=90,this.setCamera(r),n.addComponent(t.BasicCameraController.create(r)),n.transform.translate(o),this._lookAtFace(n,o,e),n.init(),n},r.prototype._isEmpty=function(t){return!t||t.length&&0===t.length||t.getCount&&0===t.getCount()},r.prototype._convertIndexToFaceKey=function(t){var e=null;switch(t){case 0:e="px";break;case 1:e="nx";break;case 2:e="py";break;case 3:e="ny";break;case 4:e="pz";break;case 5:e="nz"}return e},r.prototype._lookAtFace=function(t,e,r){switch(r){case 0:t.transform.lookAt(e.x+1,e.y,e.z,0,-1,0);break;case 1:t.transform.lookAt(e.x-1,e.y,e.z,0,-1,0);break;case 2:t.transform.lookAt(e.x,e.y+1,e.z,0,0,1);break;case 3:t.transform.lookAt(e.x,e.y-1,e.z,0,0,-1);break;case 4:t.transform.lookAt(e.x,e.y,e.z+1,0,-1,0);break;case 5:t.transform.lookAt(e.x,e.y,e.z-1,0,-1,0)}},r.prototype._needCreateCamera=function(t){return null===this._lastPosition||null===this._lastCameraList?!0:!t.isEqual(this._lastPosition)},r}(t.RenderTargetRenderer);t.CubemapRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(t){e.call(this,t.shadowMap),this._light=null,this._shadowMapRendererUtils=null,this._light=t}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(),e},r.prototype.initWhenCreate=function(){this._shadowMapRendererUtils=t.CubemapShadowMapRenderTargetRendererUtils.create(this._light,this.texture),e.prototype.initWhenCreate.call(this)},r.prototype.init=function(){var r=this;this._handleShadowRendererList(),this._shadowMapRendererUtils.bindEndLoop(function(){r._light.shadowRenderList.forEach(function(t){t.forEach(function(t){r._shadowMapRendererUtils.clearCubemapShadowMapData(t)})})}),this._shadowMapRendererUtils.createShaderWithShaderLib(t.BuildCubemapShadowMapShaderLib.create()),e.prototype.init.call(this)},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._shadowMapRendererUtils.unBindEndLoop()},r.prototype.getRenderList=function(){return this._light.shadowRenderList},r.prototype.beforeRender=function(){var t=this._shadowMapRendererUtils;this._convertRenderListToCollection(this.getRenderList()).removeRepeatItems().forEach(function(e){t.setShadowMapData(e)}),this._shadowMapRendererUtils.beforeRender()},r.prototype.afterRender=function(){this._shadowMapRendererUtils.afterRender()},r.prototype.setCamera=function(t){var e=this._light;t.aspect=e.shadowMapWidth/e.shadowMapHeight,t.near=e.shadowCameraNear,t.far=e.shadowCameraFar},r.prototype.getPosition=function(){return this._light.position},r.prototype._convertRenderListToCollection=function(t){var e=wdCb.Collection.create();return t.forEach(function(t){e.addChildren(t)}),e},r.prototype._handleShadowRendererList=function(){var t=this,e=wdCb.Hash.create();this._light.shadowRenderList.forEach(function(r,n){var o=[];r.forEach(function(e){o=o.concat(t._shadowMapRendererUtils.addAllChildren(e))}),e.addChild(n,o)},this),this._light.shadowRenderList.forEach(function(t,r){t.addChildren(e.getChild(r))}),this._light.shadowRenderList.forEach(function(e){e.removeChild(function(e){return t._shadowMapRendererUtils.isContainer(e)})})},r}(t.CubemapRenderTargetRenderer);t.CubemapShadowMapRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(t){var e=new this(t);return e.initWhenCreate(),e},e.prototype.getRenderList=function(){return this.texture.renderList},e.prototype.setCamera=function(t){t.aspect=1,t.near=this.texture.near,t.far=this.texture.far},e.prototype.getPosition=function(){return this.texture.getPosition()},e}(t.CubemapRenderTargetRenderer);t.DynamicCubemapRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e){this.texture=null,this.light=null,this._endLoopSubscription=null,this._shader=null,this.light=t,this.texture=e}return e.prototype.initWhenCreate=function(){this.texture.width=this.light.shadowMapWidth,this.texture.height=this.light.shadowMapHeight},e.prototype.init=function(){this.texture.init()},e.prototype.setShadowMapData=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=e[0],o=n.getComponent(t.Geometry).material,i=null;2===e.length&&(i=e[1]),t.Log.error(!(o instanceof t.LightMaterial),t.Log.info.FUNC_MUST_BE("material","LightMaterial when set shadowMap")),this.setMaterialShadowMapData(o,n,i)},e.prototype.bindEndLoop=function(e){this._endLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.ENDLOOP).subscribe(function(){e()})},e.prototype.unBindEndLoop=function(){this._endLoopSubscription&&this._endLoopSubscription.dispose()},e.prototype.beforeRender=function(){var e=t.Director.getInstance().scene;e.useProgram(this._shader)},e.prototype.afterRender=function(){var e=t.Director.getInstance().scene;e.unUseProgram()},e.prototype.createShaderWithShaderLib=function(e){this._shader=t.CommonShader.create(),this._shader.addLib(t.CommonShaderLib.create()),this._shader.addLib(t.CommonVerticeShaderLib.create()),this._shader.addLib(e)},e.prototype.isContainer=function(e){return!e.hasComponent(t.Geometry)},e.prototype.addAllChildren=function(t){var e=[],r=function(t){t.forEach(function(t){e.push(t),r(t)})};return r(t),e},e.prototype.setShadowMap=function(e,r){var n=null;e.hasComponent(t.Geometry)&&(n=e.getComponent(t.Geometry).material,n.hasShadowMap(r)||(t.Log.error(!(n instanceof t.LightMaterial),t.Log.info.FUNC_MUST_BE("material","LightMaterial when set shadowMap")),this.addShadowMap(n,r)))},e}();t.ShadowMapRenderTargetRendererUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t,e){var r=new this(t,e);return r.initWhenCreate(),r},r.prototype.initWhenCreate=function(){var t=this;e.prototype.initWhenCreate.call(this),this.light.shadowRenderList.forEach(function(e){e.forEach(function(e){t.setShadowMap(e,t.texture)})})},r.prototype.clearCubemapShadowMapData=function(e){var r=e.getComponent(t.Geometry).material;r.clearCubemapShadowMapData()},r.prototype.setMaterialShadowMapData=function(t,e,r){t.addCubemapShadowMapData({shadowBias:this.light.shadowBias,shadowDarkness:this.light.shadowDarkness,lightPos:this.light.position,farPlane:this.light.shadowCameraFar}),t.buildCubemapShadowMapData={lightPos:this.light.position,farPlane:this.light.shadowCameraFar}},r.prototype.addShadowMap=function(t,e){t.addCubemapShadowMap(e)},__decorate([t.require(function(e){var r=e.getComponent(t.Geometry).material;t.assert(r instanceof t.LightMaterial,t.Log.info.FUNC_MUST_BE("material","LightMaterial when set shadowMap"))})],r.prototype,"clearCubemapShadowMapData",null),r}(t.ShadowMapRenderTargetRendererUtils);t.CubemapShadowMapRenderTargetRendererUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t,e){var r=new this(t,e);return r.initWhenCreate(),r},r.prototype.initWhenCreate=function(){var t=this;e.prototype.initWhenCreate.call(this),this.light.shadowRenderList.forEach(function(e){t.setShadowMap(e,t.texture)})},r.prototype.clearTwoDShadowMapData=function(e){var r=e.getComponent(t.Geometry).material;r.clearTwoDShadowMapData()},r.prototype.setMaterialShadowMapData=function(e,r,n){var o=n.getComponent(t.CameraController);e.addTwoDShadowMapData({shadowBias:this.light.shadowBias,shadowDarkness:this.light.shadowDarkness,shadowSize:[this.light.shadowMapWidth,this.light.shadowMapHeight],lightPos:this.light.position,vpMatrixFromLight:o.worldToCameraMatrix.applyMatrix(o.pMatrix,!0)}),e.buildTwoDShadowMapData={vpMatrixFromLight:o.worldToCameraMatrix.applyMatrix(o.pMatrix,!0)}},r.prototype.addShadowMap=function(t,e){t.addTwoDShadowMap(e)},__decorate([t.require(function(e){var r=e.getComponent(t.Geometry).material;t.assert(r instanceof t.LightMaterial,t.Log.info.FUNC_MUST_BE("material","LightMaterial when set shadowMap"))})],r.prototype,"clearTwoDShadowMapData",null),r}(t.ShadowMapRenderTargetRendererUtils);t.TwoDShadowMapRenderTargetRendererUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.frameBuffer=null,this._indexBuffer=null,this._vertexBuffer=null,this._shader=null,this._isRendered=!1}return __extends(r,e),r.prototype.needRender=function(){return this._isRendered?!1:(this._isRendered=!0,!0)},r.prototype.init=function(){e.prototype.init.call(this),this._vertexBuffer=t.ArrayBuffer.create(new Float32Array([1,1,-1,1,-1,-1,1,-1]),2,t.EBufferType.FLOAT),this._indexBuffer=t.ElementBuffer.create(new Uint16Array([0,1,2,0,2,3]),t.EBufferType.UNSIGNED_SHORT),this._shader=this.createShader(),this._shader.init()},r.prototype.dispose=function(){e.prototype.dispose.call(this),this._indexBuffer.dispose(),this._vertexBuffer.dispose(),this._shader.dispose()},r.prototype.initFrameBuffer=function(){var e=this.frameBufferOperator,r=t.DeviceManager.getInstance().gl;this.frameBuffer=e.createFrameBuffer(),e.bindFrameBuffer(this.frameBuffer),e.attachTexture(r.TEXTURE_2D,this.texture.glTexture),e.check(),e.unBind()},r.prototype.renderFrameBufferTexture=function(t){this.frameBufferOperator.bindFrameBuffer(this.frameBuffer),this.texture.bindToUnit(0),this.frameBufferOperator.setViewport(),t.addCommand(this._createRenderCommand()),t.clear(),t.render(),this.frameBufferOperator.unBind(),this.frameBufferOperator.restoreViewport()},r.prototype.disposeFrameBuffer=function(){var e=t.DeviceManager.getInstance().gl;e.deleteFramebuffer(this.frameBuffer)},r.prototype._createRenderCommand=function(){var e=t.ProceduralCommand.create();return e.vertexBuffer=this._vertexBuffer,e.indexBuffer=this._indexBuffer,e.shader=this._shader,e},__decorate([t.virtual],r.prototype,"needRender",null),r}(t.RenderTargetRenderer);t.ProceduralRenderTargetRenderer=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){this.skyboxCommand=null}return t.prototype.init=function(){},t}();t.Renderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._commandQueue=wdCb.Collection.create(),this._clearOptions={color:t.Color.create("#000000")}}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.addCommand=function(t){this._commandQueue.hasChild(t)||(this._commandQueue.addChild(t),t.init())},r.prototype.hasCommand=function(){return this._commandQueue.getCount()>0||!!this.skyboxCommand},r.prototype.clear=function(){t.DeviceManager.getInstance().clear(this._clearOptions)},r.prototype.render=function(){var e=t.DeviceManager.getInstance(),r=[];this._commandQueue.forEach(function(t){t.blend?r.push(t):t.execute()}),r.length>0&&(e.depthWrite=!1,this._renderSortedTransparentCommands(r),e.depthWrite=!0),this.skyboxCommand&&(e.depthFunc=t.EDepthFunction.LEQUAL,this.skyboxCommand.execute(),e.depthFunc=t.EDepthFunction.LESS),this._clearCommand()},r.prototype.init=function(){var e=t.DeviceManager.getInstance();e.depthTest=!0,e.blend=!1,e.setColorWrite(!0,!0,!0,!0),e.side=t.ESide.FRONT,e.depthWrite=!0},r.prototype.setClearColor=function(t){this._setClearOptions({color:t})},r.prototype._renderSortedTransparentCommands=function(e){var r=this,n=t.Director.getInstance().scene.currentCamera.transform.position.z;e.sort(function(t,e){return r._getObjectToCameraZDistance(n,e)-r._getObjectToCameraZDistance(n,t)}).forEach(function(t){t.execute()})},r.prototype._getObjectToCameraZDistance=function(t,e){return t-e.z},r.prototype._clearCommand=function(){this._commandQueue.removeAllChildren(),this.skyboxCommand=null},r.prototype._setClearOptions=function(t){wdCb.ExtendUtils.extend(this._clearOptions,t)},__decorate([t.require(function(e){t.assert(!!t.Director.getInstance().scene.currentCamera,t.Log.info.FUNC_NOT_EXIST("current camera"))})],r.prototype,"_renderSortedTransparentCommands",null),r}(t.Renderer);t.WebGLRenderer=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.POINTS="POINTS"]="POINTS",t[t.LINES="LINES"]="LINES",t[t.LINE_LOOP="LINE_LOOP"]="LINE_LOOP",t[t.LINE_STRIP="LINE_STRIP"]="LINE_STRIP",t[t.TRIANGLES="TRIANGLES"]="TRIANGLES",t[t.TRIANGLE_STRIP="TRIANGLE_STRIP"]="TRIANGLE_STRIP",t[t.TRANGLE_FAN="TRIANGLE_FAN"]="TRANGLE_FAN"}(t.EDrawMode||(t.EDrawMode={}));t.EDrawMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BYTE="BYTE"]="BYTE",t[t.UNSIGNED_BYTE="UNSIGNED_BYTE"]="UNSIGNED_BYTE",t[t.SHORT="SHORT"]="SHORT",t[t.UNSIGNED_SHORT="UNSIGNED_SHORT"]="UNSIGNED_SHORT",t[t.INT="INT"]="INT",t[t.UNSIGNED_INT="UNSIGNED_INT"]="UNSIGNED_INT",t[t.FLOAT="FLOAT"]="FLOAT"}(t.EBufferType||(t.EBufferType={}));t.EBufferType}(wd||(wd={}));var wd;!function(t){!function(t){t[t.VERTICE="VERTICE"]="VERTICE",t[t.INDICE="INDICE"]="INDICE",t[t.NORMAL="NORMAL"]="NORMAL",t[t.TEXCOORD="TEXCOORD"]="TEXCOORD",t[t.TANGENT="TANGENT"]="TANGENT",t[t.COLOR="COLOR"]="COLOR"}(t.EBufferDataType||(t.EBufferDataType={}));t.EBufferDataType}(wd||(wd={}));var wd;!function(t){!function(t){t[t.STREAM_DRAW="STREAM_DRAW"]="STREAM_DRAW",t[t.STATIC_DRAW="STATIC_DRAW"]="STATIC_DRAW",t[t.DYNAMIC_DRAW="DYNAMIC_DRAW"]="DYNAMIC_DRAW"}(t.EBufferUsage||(t.EBufferUsage={}));t.EBufferUsage}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.buffer=null,this.type=null,this.count=null}return e.prototype.dispose=function(){t.DeviceManager.getInstance().gl.deleteBuffer(this.buffer),delete this.buffer},e}();t.Buffer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._typeSize=null,this.data=null,this._type=null}return __extends(r,e),r.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=new this;return r.initWhenCreate.apply(r,t),r},Object.defineProperty(r.prototype,"typeSize",{get:function(){return this._typeSize},enumerable:!0,configurable:!0}),r.prototype.initWhenCreate=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=t.DeviceManager.getInstance().gl;if(this.buffer=n.createBuffer(),!this.buffer)return t.Log.log("Failed to create the this.buffer object"),null;if(0!==e.length){var o=e[0],i=e[1],a=e[2]||t.EBufferUsage.STATIC_DRAW;return o&&this._checkDataType(o,i)?(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.buffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,o,n[a]),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),this.type=n[i],this._type=i,this.count=o.length,this.data=o,this._typeSize=this._getInfo(i).size,this.buffer):null}},r.prototype.resetData=function(e,r){void 0===r&&(r=this._type);var n=t.DeviceManager.getInstance().gl;return n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.buffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e,n.DYNAMIC_DRAW),this.type=n[r],this._type=r,this.data=e,this.count=e.length,this._typeSize=this._getInfo(r).size,this},r.prototype._checkDataType=function(t,e){var r=this._getInfo(e);return t instanceof r.typeClass},r.prototype._getInfo=function(e){var r=null;switch(e){case t.EBufferType.UNSIGNED_BYTE:r={typeClass:Uint8Array,size:1};break;case t.EBufferType.SHORT:r={typeClass:Int16Array,size:2};break;case t.EBufferType.UNSIGNED_SHORT:r={typeClass:Uint16Array,size:2};break;case t.EBufferType.INT:r={typeClass:Int32Array,size:4};break;case t.EBufferType.UNSIGNED_INT:r={typeClass:Uint32Array,size:4};break;case t.EBufferType.FLOAT:r={typeClass:Float32Array,size:4};break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EBufferType"))}return r},__decorate([t.require(function(e,r){void 0===r&&(r=this._type),t.assert(this.buffer,t.Log.info.FUNC_MUST("create gl buffer"))})],r.prototype,"resetData",null),r}(t.Buffer);t.ElementBuffer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.size=null,this.data=null,this._type=null}return __extends(r,e),r.create=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=new this;return r.initWhenCreate.apply(r,t),r},r.prototype.initWhenCreate=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=t.DeviceManager.getInstance().gl;if(this.buffer=n.createBuffer(),!this.buffer)return t.Log.log("Failed to create the this.buffer object"),null;if(0!==e.length){var o=e[0],i=e[1],a=e[2],s=e[3]||t.EBufferUsage.STATIC_DRAW;return o?(n.bindBuffer(n.ARRAY_BUFFER,this.buffer),n.bufferData(n.ARRAY_BUFFER,o,n[s]),n.bindBuffer(n.ARRAY_BUFFER,null),this.size=i,this.type=n[a],this._type=a,this.count=o.length/i,this.data=o,this.buffer):null}},r.prototype.resetData=function(e,r,n){void 0===r&&(r=this.size),void 0===n&&(n=this._type);var o=t.DeviceManager.getInstance().gl;return o.bindBuffer(o.ARRAY_BUFFER,this.buffer),o.bufferData(o.ARRAY_BUFFER,e,o.DYNAMIC_DRAW),this.size=r,this.type=o[n],this._type=n,this.count=e.length/r,this.data=e,this},__decorate([t.require(function(e,r,n){void 0===r&&(r=this.size),void 0===n&&(n=this._type),t.assert(this.buffer,t.Log.info.FUNC_MUST("create gl buffer"))})],r.prototype,"resetData",null),r}(t.Buffer);t.ArrayBuffer=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=wdCb.Hash.create();e.addChild(t.EBufferDataType.VERTICE,"vertices"),e.addChild(t.EBufferDataType.INDICE,"indices"),e.addChild(t.EBufferDataType.NORMAL,"normals"),e.addChild(t.EBufferDataType.TEXCOORD,"texCoords"),e.addChild(t.EBufferDataType.COLOR,"colors"),e.addChild(t.EBufferDataType.TANGENT,"tangents");var r=function(){function r(){}return r.getGeometryDataName=function(t){var r=e.getChild(t);return r},__decorate([t.ensure(function(e,r){t.Log.error(void 0===e,t.Log.info.FUNC_NOT_EXIST(r,"in BufferDataTable"))})],r,"getGeometryDataName",null),r}();t.BufferDataTable=r}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this._program=null,this._shader=null,this._getAttribLocationCache=wdCb.Hash.create(),this._getUniformLocationCache=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},e.prototype.use=function(){t.DeviceManager.getInstance().gl.useProgram(this._program)},e.prototype.getUniformLocation=function(e){var r=null;return this._shader.dirty||(r=this._getUniformLocationCache.getChild(e),void 0===r)?(r=t.DeviceManager.getInstance().gl.getUniformLocation(this._program,e),this._getUniformLocationCache.addChild(e,r),r):r},e.prototype.sendUniformData=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=t.DeviceManager.getInstance().gl,o=null,i=null,a=null;if(i=e[1],a=e[2],t.JudgeUtils.isString(e[0])){var s=e[0];o=this.getUniformLocation(s)}else o=e[0];if(!this.isUniformDataNotExistByLocation(o)&&null!==a)switch(i){case t.EVariableType.FLOAT_1:n.uniform1f(o,Number(a));break;case t.EVariableType.FLOAT_2:a=this._convertToArray2(a),n.uniform2f(o,a[0],a[1]);break;case t.EVariableType.FLOAT_3:a=this._convertToArray3(a),n.uniform3f(o,a[0],a[1],a[2]);break;case t.EVariableType.FLOAT_4:a=this._convertToArray4(a),n.uniform4f(o,a[0],a[1],a[2],a[3]);break;case t.EVariableType.FLOAT_MAT3:n.uniformMatrix3fv(o,!1,a.values);break;case t.EVariableType.FLOAT_MAT4:n.uniformMatrix4fv(o,!1,a.values);break;case t.EVariableType.NUMBER_1:case t.EVariableType.SAMPLER_CUBE:case t.EVariableType.SAMPLER_2D:n.uniform1i(o,Number(a));break;case t.EVariableType.SAMPLER_ARRAY:this._sendSampleArray(n,o,a);break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EVariableType:",i))}},e.prototype.sendAttributeData=function(e,r,n){var o=t.DeviceManager.getInstance().gl,i=null,a=null;if(i=this._getAttribLocation(o,e),-1!==i&&null!==n)switch(a=n,r){case t.EVariableType.BUFFER:o.bindBuffer(o.ARRAY_BUFFER,a.buffer),o.vertexAttribPointer(i,a.size,a.type,!1,0,0),o.enableVertexAttribArray(i);break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EVariableType:",r))}},e.prototype.sendStructureData=function(t,e,r){this.sendUniformData(t,e,r)},e.prototype.initWithShader=function(e){var r=t.DeviceManager.getInstance().gl,n=null,o=null;return this._program=t.DeviceManager.getInstance().gl.createProgram(),n=e.createVsShader(),o=e.createFsShader(),this._shader=e,r.attachShader(this._program,n),
r.attachShader(this._program,o),r.bindAttribLocation(this._program,0,"a_position"),r.linkProgram(this._program),t.Log.error(r.getProgramParameter(this._program,r.LINK_STATUS)===!1,r.getProgramInfoLog(this._program)),r.deleteShader(n),r.deleteShader(o),this},e.prototype.dispose=function(){var e=t.DeviceManager.getInstance().gl;e.deleteProgram(this._program),this._program=void 0},e.prototype.isUniformDataNotExistByLocation=function(t){return null===t},e.prototype._convertToArray2=function(e){return t.JudgeUtils.isArray(e)?e:[e.x,e.y]},e.prototype._convertToArray3=function(e){return t.JudgeUtils.isArray(e)?e:[e.x,e.y,e.z]},e.prototype._convertToArray4=function(e){return t.JudgeUtils.isArray(e)?e:[e.x,e.y,e.z,e.w]},e.prototype._getAttribLocation=function(t,e){var r=null;return this._shader.dirty||(r=this._getAttribLocationCache.getChild(e),void 0===r)?(r=t.getAttribLocation(this._program,e),this._getAttribLocationCache.addChild(e,r),r):r},e.prototype._sendSampleArray=function(t,e,r){t.uniform1iv(e,r)},__decorate([t.require(function(e,r,n){n&&(t.assert(n instanceof t.ArrayBuffer,t.Log.info.FUNC_MUST_BE("ArrayBuffer")),t.assert(r===t.EVariableType.BUFFER,t.Log.info.FUNC_SHOULD("type","be EVariableType.BUFFER, but actual is "+r)))})],e.prototype,"sendAttributeData",null),__decorate([t.require(function(e){t.assert(t.JudgeUtils.isArray(e)||e instanceof t.Vector2,t.Log.info.FUNC_MUST_BE("shader->attributes->value","Array<Array<any>> or Array<Vector2> stucture"))})],e.prototype,"_convertToArray2",null),__decorate([t.require(function(e){t.assert(t.JudgeUtils.isArray(e)||e instanceof t.Vector3,t.Log.info.FUNC_MUST_BE("shader->attributes->value","Array<Array<any>> or Array<Vector3> stucture"))})],e.prototype,"_convertToArray3",null),__decorate([t.require(function(e){t.assert(t.JudgeUtils.isArray(e)||e instanceof t.Vector4,t.Log.info.FUNC_MUST_BE("shader->attributes->value","Array<Array<any>> or Array<Vector4> stucture"))})],e.prototype,"_convertToArray4",null),__decorate([t.require(function(e,r,n){t.assert(t.JudgeUtils.isArrayExactly(n),t.Log.info.FUNC_SHOULD("data","be array, but actual is "+n));for(var o=0,i=n;o<i.length;o++){var a=i[o];t.assert(t.JudgeUtils.isNumber(a),t.Log.info.FUNC_SHOULD("data","be Array<number>, but actual is "+n))}})],e.prototype,"_sendSampleArray",null),e}();t.Program=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this.drawMode=t.EDrawMode.TRIANGLES,this.blend=!1,this.z=null}return e.prototype.init=function(){},e.prototype.drawElements=function(e){var r=0,n=t.DeviceManager.getInstance().gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.buffer),t.GlUtils.drawElements(n[this.drawMode],e.count,e.type,e.typeSize*r)},__decorate([t.virtual],e.prototype,"init",null),e}();t.RenderCommand=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._mMatrix=null,this._vMatrix=null,this._pMatrix=null,this.buffers=null,this.material=null,this.animation=null,this._normalMatrixCache=null,this._mvpMatrixCache=null}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"program",{get:function(){return this.material.program},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"normalMatrix",{get:function(){return this.mMatrix.invertTo3x3().transpose()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"mvpMatrix",{get:function(){return this.mMatrix.applyMatrix(this.vMatrix,!0).applyMatrix(this.pMatrix,!1)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"mMatrix",{get:function(){return this._mMatrix},set:function(t){this._mMatrix=t,this._normalMatrixCache=null,this._mvpMatrixCache=null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"vMatrix",{get:function(){return this._vMatrix},set:function(t){this._vMatrix=t,this._mvpMatrixCache=null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pMatrix",{get:function(){return this._pMatrix},set:function(t){this._pMatrix=t,this._mvpMatrixCache=null},enumerable:!0,configurable:!0}),r.prototype.execute=function(){var t=this.material;t.bindAndUpdateTexture(),t.updateShader(this),this._draw(t)},r.prototype._draw=function(e){var r=0,n=null,o=null,i=t.DeviceManager.getInstance().gl;this._setEffects(e),o=this.buffers.getChild(t.EBufferDataType.INDICE),o?this.drawElements(o):(n=this.buffers.getChild(t.EBufferDataType.VERTICE),t.GlUtils.drawArrays(i[this.drawMode],r,n.count))},r.prototype._setEffects=function(e){var r=t.DeviceManager.getInstance();r.setColorWrite(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),r.polygonOffsetMode=e.polygonOffsetMode,r.side=this._getSide(),r.blend=e.blend,e.blendFuncSeparate&&e.blendEquationSeparate?(r.setBlendFuncSeparate(e.blendFuncSeparate),r.setBlendEquationSeparate(e.blendEquationSeparate)):(r.setBlendFunc(e.blendSrc,e.blendDst),r.setBlendEquation(e.blendEquation))},r.prototype._getSide=function(){var e=t.Director.getInstance().scene;return e.side?e.side:this.material.side},__decorate([t.requireGetter(function(){t.assert(!!this.mMatrix,t.Log.info.FUNC_NOT_EXIST("mMatrix"))}),t.cacheGetter(function(){return null!==this._normalMatrixCache},function(){return this._normalMatrixCache},function(t){this._normalMatrixCache=t})],r.prototype,"normalMatrix",null),__decorate([t.requireGetter(function(){t.assert(!!this.mMatrix&&!!this.vMatrix&&!!this.pMatrix,t.Log.info.FUNC_NOT_EXIST("mMatrix or vMatrix or pMatrix"))}),t.cacheGetter(function(){return null!==this._mvpMatrixCache},function(){return this._mvpMatrixCache},function(t){this._mvpMatrixCache=t})],r.prototype,"mvpMatrix",null),__decorate([t.require(function(t){t.blendFuncSeparate&&t.blendEquationSeparate||wdCb.Log.error(!t.blendSrc||!t.blendDst||!t.blendEquation,wdCb.Log.info.FUNC_MUST("material.blendSrc || material.blendDst || material.blendEquation","be set"))})],r.prototype,"_setEffects",null),r}(t.RenderCommand);t.QuadCommand=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.shader=null,this.indexBuffer=null,this.vertexBuffer=null}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.init=function(){this.blend=!1,this.drawMode=t.EDrawMode.TRIANGLES},r.prototype.execute=function(){this.shader.update(this),this.drawElements(this.indexBuffer)},r}(t.RenderCommand);t.ProceduralCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.drawElements=function(e,r,n,o){t.DebugStatistics.count.drawCalls++,this._getGl().drawElements(e,r,n,o)},e.drawArrays=function(e,r,n){t.DebugStatistics.count.drawCalls++,this._getGl().drawArrays(e,r,n)},e._getGl=function(){return t.DeviceManager.getInstance().gl},e}();t.GlUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e){this.width=null,this.height=null,this._originScissorTest=null,this.width=t,this.height=e}return e.create=function(t,e){var r=new this(t,e);return r},Object.defineProperty(e.prototype,"gl",{get:function(){return t.DeviceManager.getInstance().gl},enumerable:!0,configurable:!0}),e.prototype.createFrameBuffer=function(){return this.gl.createFramebuffer()},e.prototype.bindFrameBuffer=function(t){var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t)},e.prototype.setViewport=function(){var e=t.DeviceManager.getInstance();e.setViewport(0,0,this.width,this.height),this._originScissorTest=e.scissorTest,e.scissorTest=!1},e.prototype.restoreViewport=function(){var e=t.DeviceManager.getInstance(),r=e.view;e.setViewport(0,0,r.width,r.height),e.scissorTest=this._originScissorTest},e.prototype.dispose=function(){this.unBind()},e.prototype.unBind=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},e.prototype.createRenderBuffer=function(){var e=this.gl,r=e.createRenderbuffer();return t.Log.error(!r,"Failed to create renderbuffer object"),r},e.prototype.attachTexture=function(t,e){var r=this.gl;r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t,e,0)},e.prototype.attachRenderBuffer=function(t,e){var r=this.gl;r.bindRenderbuffer(r.RENDERBUFFER,e),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,this.width,this.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r[t],r.RENDERBUFFER,e)},e.prototype.check=function(){var e=this.gl,r=e.checkFramebufferStatus(e.FRAMEBUFFER);r!==e.FRAMEBUFFER_COMPLETE&&t.Log.error(!0,"Frame buffer object is incomplete:"+r.toString())},e}();t.FrameBuffer=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this._attributes=wdCb.Hash.create(),this._uniforms=wdCb.Hash.create(),this._vsSource="",this._fsSource="",this.program=t.Program.create(),this.libDirty=!1,this.libs=wdCb.Collection.create(),this.sourceBuilder=this.createShaderSourceBuilder(),this._definitionDataDirty=!1}return Object.defineProperty(e.prototype,"attributes",{get:function(){return this._attributes},set:function(t){this._isNotEqual(t,this._attributes)&&(this._definitionDataDirty=!0),this._attributes=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uniforms",{get:function(){return this._uniforms},set:function(t){this._isNotEqual(t,this._uniforms)&&(this._definitionDataDirty=!0),this._uniforms=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"vsSource",{get:function(){return this._vsSource},set:function(t){t!==this._vsSource&&(this._definitionDataDirty=!0),this._vsSource=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fsSource",{get:function(){return this._fsSource},set:function(t){t!==this._fsSource&&(this._definitionDataDirty=!0),this._fsSource=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dirty",{get:function(){return this.libDirty||this._definitionDataDirty},enumerable:!0,configurable:!0}),e.prototype.createVsShader=function(){var e=t.DeviceManager.getInstance().gl;return this._initShader(e.createShader(e.VERTEX_SHADER),this.vsSource)},e.prototype.createFsShader=function(){var e=t.DeviceManager.getInstance().gl;return this._initShader(e.createShader(e.FRAGMENT_SHADER),this.fsSource)},e.prototype.init=function(t){this.libs.forEach(function(t){t.init()}),this.judgeRefreshShader(t)},e.prototype.dispose=function(){this.program.dispose(),this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.libs.forEach(function(t){t.dispose()})},e.prototype.hasLib=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];if(e[0]instanceof t.ShaderLib){var n=e[0];return this.libs.hasChild(n)}var o=e[0];return this.libs.hasChildWithFunc(function(t){return t instanceof o})},e.prototype.addLib=function(t){this.libs.addChild(t),t.shader=this,this.libDirty=!0},e.prototype.addShaderLibToTop=function(t){this.libs.unShiftChild(t),t.shader=this,this.libDirty=!0},e.prototype.getLib=function(t){return this.libs.findOne(function(e){return e instanceof t})},e.prototype.getLibs=function(){return this.libs},e.prototype.removeLib=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return this.libDirty=!0,this.libs.removeChild(t[0])},e.prototype.removeAllLibs=function(){this.libDirty=!0,this.libs.removeAllChildren()},e.prototype.sortLib=function(t){this.libDirty=!0,this.libs.sort(t,!0)},e.prototype.judgeRefreshShader=function(t){this.libDirty&&this.buildDefinitionData(null,t),this._definitionDataDirty&&this.program.initWithShader(this),this.libDirty=!1,this._definitionDataDirty=!1},e.prototype._initShader=function(e,r){var n=t.DeviceManager.getInstance().gl;return n.shaderSource(e,r),n.compileShader(e),n.getShaderParameter(e,n.COMPILE_STATUS)?e:(t.Log.log(n.getShaderInfoLog(e)),t.Log.log("attributes:\n",this.attributes),t.Log.log("uniforms:\n",this.uniforms),t.Log.log("source:\n",r),void 0)},e.prototype._isNotEqual=function(t,e){var r=!1;return t.forEach(function(t,n){var o=e.getChild(n);return o&&t.type===o.type&&t.value===o.value?void 0:(r=!0,wdCb.$BREAK)}),r},__decorate([t.ensure(function(){var e=this;this.libs.forEach(function(r){t.assert(t.JudgeUtils.isEqual(r.shader,e),t.Log.info.FUNC_SHOULD("set ShaderLib.shader to be this"))}),t.assert(this.libDirty===!0,t.Log.info.FUNC_SHOULD("libDirty","be true"))})],e.prototype,"addLib",null),__decorate([t.ensure(function(e,r){var n=this;t.assert(t.JudgeUtils.isEqual(r,this.libs.getChild(0)),t.Log.info.FUNC_SHOULD("add shader lib to the top")),this.libs.forEach(function(e){t.assert(t.JudgeUtils.isEqual(e.shader,n),t.Log.info.FUNC_SHOULD("set ShaderLib.shader to be this"))}),t.assert(this.libDirty===!0,t.Log.info.FUNC_SHOULD("libDirty","be true"))})],e.prototype,"addShaderLibToTop",null),e}();t.Shader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.update=function(t,e){var r=this.program;this.judgeRefreshShader(e),this.program.use(),this.libs.forEach(function(n){n.sendShaderVariables(r,t,e)}),e.sendTexture(r)},r.prototype.read=function(t){this.sourceBuilder.clearShaderDefinition(),this.sourceBuilder.read(t),this.libDirty=!0},r.prototype.getSampler2DUniformsAfterRead=function(){return this.sourceBuilder.uniforms.filter(function(e,r){return e.type===t.EVariableType.SAMPLER_2D})},r.prototype.buildDefinitionData=function(t,e){this.sourceBuilder.build(),this.attributes=this.sourceBuilder.attributes,this.uniforms=this.sourceBuilder.uniforms,this.vsSource=this.sourceBuilder.vsSource,this.fsSource=this.sourceBuilder.fsSource},r.prototype.createShaderSourceBuilder=function(){return t.CustomShaderSourceBuilder.create()},r}(t.Shader);t.CustomShader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.prototype.buildDefinitionData=function(t,e){this.libs.forEach(function(r){r.setShaderDefinition(t,e)}),this.sourceBuilder.clearShaderDefinition(),this.sourceBuilder.build(this.libs),this.attributes=this.sourceBuilder.attributes,this.uniforms=this.sourceBuilder.uniforms,this.vsSource=this.sourceBuilder.vsSource,this.fsSource=this.sourceBuilder.fsSource},r.prototype.createShaderSourceBuilder=function(){return t.EngineShaderSourceBuilder.create()},r}(t.Shader);t.EngineShader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.update=function(t,e){var r=this.program;this.judgeRefreshShader(e),this.program.use(),this.libs.forEach(function(n){n.sendShaderVariables(r,t,e)}),e.sendTexture(r)},e}(t.EngineShader);t.CommonShader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.prototype.init=function(){this.addLib(t.CommonProceduralShaderLib.create()),e.prototype.init.call(this,null)},r.prototype.update=function(t){var e=this.program;this.judgeRefreshShader(null),this.program.use(),this.libs.forEach(function(r){r.sendShaderVariables(e,t)})},r}(t.EngineShader);t.ProceduralShader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.ProceduralShader);t.CommonProceduralShader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(e){t.call(this),this._texture=null,this._texture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.update=function(e){t.prototype.update.call(this,e),this._texture.mapManager.bindAndUpdate(),this._texture.mapManager.sendData(this.program)},e}(t.ProceduralShader);t.CustomProceduralShader=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this.attributes=wdCb.Hash.create(),this.uniforms=wdCb.Hash.create(),this.vsSource=null,this.fsSource=null}return e.prototype.dispose=function(){this.clearShaderDefinition()},e.prototype.convertAttributesData=function(){var e=this;this.attributes.filter(function(e){return e.value!==t.EVariableCategory.ENGINE&&t.JudgeUtils.isArrayExactly(e.value)}).forEach(function(t,r){t.value=e._convertArrayToArrayBuffer(t.type,t.value)})},e.prototype._convertArrayToArrayBuffer=function(e,r){var n=this._getBufferSize(e);return t.ArrayBuffer.create(new Float32Array(r),n,t.EBufferType.FLOAT)},e.prototype._getBufferSize=function(e){var r=null;switch(e){case t.EVariableType.FLOAT_1:case t.EVariableType.NUMBER_1:r=1;break;case t.EVariableType.FLOAT_2:r=2;break;case t.EVariableType.FLOAT_3:r=3;break;case t.EVariableType.FLOAT_4:r=4;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("EVariableType",e))}return r},__decorate([t.require(function(){this.attributes.forEach(function(e){t.assert(!t.JudgeUtils.isFloatArray(e.value),t.Log.info.FUNC_SHOULD_NOT("attribute->value","be Float array"))})})],e.prototype,"convertAttributesData",null),__decorate([t.require(function(e,r){t.assert(t.JudgeUtils.isArrayExactly(r),t.Log.info.FUNC_SHOULD("value:"+r,"be array"))})],e.prototype,"_convertArrayToArrayBuffer",null),e}();t.ShaderSourceBuilder=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.read=function(e){e.attributes&&(this.attributes=wdCb.Hash.create(e.attributes)),e.uniforms&&(this.uniforms=wdCb.Hash.create(e.uniforms)),this.vsSource=t.LoaderManager.getInstance().get(e.vsSourceId),this.fsSource=t.LoaderManager.getInstance().get(e.fsSourceId)},r.prototype.build=function(){this.convertAttributesData()},r.prototype.clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSource=null,this.fsSource=null},r}(t.ShaderSourceBuilder);t.CustomShaderSourceBuilder=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.vsSourceDefineList=wdCb.Collection.create(),this.fsSourceDefineList=wdCb.Collection.create()}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.build=function(t){this._readLibSource(t),null===this.vsSource&&this._buildVsSource(),null===this.fsSource&&this._buildFsSource(),this.convertAttributesData()},r.prototype.clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSourceDefineList.removeAllChildren(),this.fsSourceDefineList.removeAllChildren(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null},r.prototype._readLibSource=function(t){var e=t.filter(function(t){return null!==t.vsSource||null!==t.fsSource});this._judgeAndSetVsSource(e),this._judgeAndSetFsSource(e),this._judgeAndSetPartSource(t)},r.prototype._judgeAndSetVsSource=function(t){var e=t.findOne(function(t){return null!==t.vsSource});e&&(this.vsSource=e.vsSource)},r.prototype._judgeAndSetFsSource=function(t){var e=t.findOne(function(t){return null!==t.fsSource});e&&(this.fsSource=e.fsSource)},r.prototype._judgeAndSetPartSource=function(t){var e=this.vsSource,r=this.fsSource,n=this.attributes,o=this.uniforms,i=this.vsSourceDefineList,a=this.fsSourceDefineList,s="",c="",u="",l="",h="",p="",f="",d="",_="",y="",g="",m="";t.forEach(function(t){n.addChildren(t.attributes),o.addChildren(t.uniforms),null===e&&(s+=t.vsSourceTop,c+=t.vsSourceDefine,u+=t.vsSourceVarDeclare,l+=t.vsSourceFuncDeclare,h+=t.vsSourceFuncDefine,p+=t.vsSourceBody,i.addChildren(t.vsSourceDefineList)),null===r&&(f+=t.fsSourceTop,d+=t.fsSourceDefine,_+=t.fsSourceVarDeclare,y+=t.fsSourceFuncDeclare,g+=t.fsSourceFuncDefine,m+=t.fsSourceBody,a.addChildren(t.fsSourceDefineList))}),null===e&&(this.vsSourceTop=s,this.vsSourceDefine=c,this.vsSourceVarDeclare=u,this.vsSourceFuncDeclare=l,this.vsSourceFuncDefine=h,this.vsSourceBody=p),null===r&&(this.fsSourceTop=f,this.fsSourceDefine=d,this.fsSourceVarDeclare=_,this.fsSourceFuncDeclare=y,this.fsSourceFuncDefine=g,this.fsSourceBody=m)},r.prototype._buildVsSource=function(){this.vsSource=this._buildVsSourceTop()+this._buildVsSourceDefine()+this._buildVsSourceVarDeclare()+this._buildVsSourceFuncDeclare()+this._buildVsSourceFuncDefine()+this._buildVsSourceBody()},r.prototype._buildFsSource=function(){this.fsSource=this._buildFsSourceTop()+this._buildFsSourceDefine()+this._buildFsSourceVarDeclare()+this._buildFsSourceFuncDeclare()+this._buildFsSourceFuncDefine()+this._buildFsSourceBody()},r.prototype._buildVsSourceTop=function(){return this._getPrecisionSource()+this.vsSourceTop},r.prototype._buildVsSourceDefine=function(){return this._buildSourceDefine(this.vsSourceDefineList)+this.vsSourceDefine},r.prototype._buildVsSourceVarDeclare=function(){return this._generateAttributeSource()+this._generateUniformSource(this.vsSourceVarDeclare,this.vsSourceFuncDefine,this.vsSourceBody)+this.vsSourceVarDeclare},r.prototype._buildVsSourceFuncDeclare=function(){return this.vsSourceFuncDeclare},r.prototype._buildVsSourceFuncDefine=function(){return this.vsSourceFuncDefine},r.prototype._buildVsSourceBody=function(){return t.ShaderSnippet.main_begin+this.vsSourceBody+t.ShaderSnippet.main_end},r.prototype._buildFsSourceTop=function(){return this._getPrecisionSource()+this.fsSourceTop},r.prototype._buildFsSourceDefine=function(){return this._buildSourceDefine(this.fsSourceDefineList)+this.fsSourceDefine},r.prototype._buildFsSourceVarDeclare=function(){return this._generateUniformSource(this.fsSourceVarDeclare,this.fsSourceFuncDefine,this.fsSourceBody)+this.fsSourceVarDeclare},r.prototype._buildFsSourceFuncDeclare=function(){return this.fsSourceFuncDeclare},r.prototype._buildFsSourceFuncDefine=function(){return this.fsSourceFuncDefine},r.prototype._buildFsSourceBody=function(){return t.ShaderSnippet.main_begin+this.fsSourceBody+t.ShaderSnippet.main_end},r.prototype._buildSourceDefine=function(t){var e="";return t.forEach(function(t){e+=void 0===t.value?"#define "+t.name+"\n":"#define "+t.name+" "+t.value+"\n"}),e},r.prototype._getPrecisionSource=function(){var e=t.GPUDetector.getInstance().precision,r=null;switch(e){case t.EGPUPrecision.HIGHP:r=t.ShaderChunk.highp_fragment.top;break;case t.EGPUPrecision.MEDIUMP:r=t.ShaderChunk.mediump_fragment.top;break;case t.EGPUPrecision.LOWP:r=t.ShaderChunk.lowp_fragment.top;break;default:r=""}return r},r.prototype._generateAttributeSource=function(){var e="";return this.attributes.filter(function(t,e){return!!t}).forEach(function(r,n){e+="attribute "+t.VariableTypeTable.getVariableType(r.type)+" "+n+";\n"}),e},r.prototype._generateUniformSource=function(e,r,n){var o="",i=this;return this.uniforms.filter(function(o,a){return!!o&&o.type!==t.EVariableType.STRUCTURE&&o.type!==t.EVariableType.STRUCTURES&&!i._isExistInSource(a,e)&&(i._isExistInSource(a,r)||i._isExistInSource(a,n))}).forEach(function(e,r){o+="uniform "+t.VariableTypeTable.getVariableType(e.type)+" "+r+";\n"}),o},r.prototype._isExistInSource=function(t,e){return-1!==e.indexOf(t)},__decorate([t.require(function(e){t.assert(null===this.vsSource,t.Log.info.FUNC_SHOULD("vsSource","be null")),t.assert(null===this.fsSource,t.Log.info.FUNC_SHOULD("fsSource","be null"))})],r.prototype,"build",null),r}(t.ShaderSourceBuilder);t.EngineShaderSourceBuilder=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.FLOAT_1="FLOAT_1"]="FLOAT_1",t[t.FLOAT_2="FLOAT_2"]="FLOAT_2",t[t.FLOAT_3="FLOAT_3"]="FLOAT_3",t[t.FLOAT_4="FLOAT_4"]="FLOAT_4",t[t.FLOAT_MAT3="FLOAT_MAT3"]="FLOAT_MAT3",t[t.FLOAT_MAT4="FLOAT_MAT4"]="FLOAT_MAT4",t[t.BUFFER="BUFFER"]="BUFFER",t[t.SAMPLER_CUBE="SAMPLER_CUBE"]="SAMPLER_CUBE",t[t.SAMPLER_2D="SAMPLER_2D"]="SAMPLER_2D",t[t.NUMBER_1="NUMBER_1"]="NUMBER_1",t[t.STRUCTURE="STRUCTURE"]="STRUCTURE",t[t.STRUCTURES="STRUCTURES"]="STRUCTURES",t[t.SAMPLER_ARRAY="SAMPLER_ARRAY"]="SAMPLER_ARRAY"}(t.EVariableType||(t.EVariableType={}));t.EVariableType}(wd||(wd={}));var wd;!function(t){!function(t){t[t.POSITION="POSITION"]="POSITION",t[t.NORMAL="NORMAL"]="NORMAL",t[t.TEXCOORD="TEXCOORD"]="TEXCOORD",t[t.TANGENT="TANGENT"]="TANGENT",t[t.COLOR="COLOR"]="COLOR",t[t.MODEL="MODEL"]="MODEL",t[t.VIEW="VIEW"]="VIEW",t[t.PROJECTION="PROJECTION"]="PROJECTION",t[t.MODEL_VIEW="MODEL_VIEW"]="MODEL_VIEW",t[t.MODEL_VIEW_PROJECTION="MODEL_VIEW_PROJECTION"]="MODEL_VIEW_PROJECTION",t[t.MODEL_INVERSE="MODEL_INVERSE"]="MODEL_INVERSE",t[t.VIEW_INVERSE="VIEW_INVERSE"]="VIEW_INVERSE",t[t.PROJECTION_INVERSE="PROJECTION_INVERSE"]="PROJECTION_INVERSE",t[t.MODEL_VIEW_INVERSE="MODEL_VIEW_INVERSE"]="MODEL_VIEW_INVERSE",t[t.MODEL_VIEW_PROJECTION_INVERSE="MODEL_VIEW_PROJECTION_INVERSE"]="MODEL_VIEW_PROJECTION_INVERSE",t[t.MODEL_INVERSE_TRANSPOSE="MODEL_INVERSE_TRANSPOSE"]="MODEL_INVERSE_TRANSPOSE",t[t.MODEL_VIEW_INVERSE_TRANSPOSE="MODEL_VIEW_INVERSE_TRANSPOSE"]="MODEL_VIEW_INVERSE_TRANSPOSE",t[t.VIEWPORT="VIEWPORT"]="VIEWPORT"}(t.EVariableSemantic||(t.EVariableSemantic={}));t.EVariableSemantic}(wd||(wd={}));var wd;!function(t){!function(t){t[t.ENGINE="ENGINE"]="ENGINE",t[t.CUSTOM="CUSTOM"]="CUSTOM"}(t.EVariableCategory||(t.EVariableCategory={}));t.EVariableCategory}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.a_position={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_positionVec2={type:t.EVariableType.FLOAT_2,value:t.EVariableCategory.ENGINE},e.a_currentFramePosition={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_nextFramePosition={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_normal={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_currentFrameNormal={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_nextFrameNormal={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_color={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.a_texCoord={type:t.EVariableType.FLOAT_2,value:t.EVariableCategory.ENGINE},e.a_tangent={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_mMatrix={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_vMatrix={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_pMatrix={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_normalMatrix={type:t.EVariableType.FLOAT_MAT3,value:t.EVariableCategory.ENGINE},e.u_samplerCube0={type:t.EVariableType.SAMPLER_CUBE,value:t.EVariableCategory.ENGINE},e.u_sampler2D0={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_sampler2D1={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_lightMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_diffuseMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_specularMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_emissionMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_normalMapSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_mirrorSampler={type:t.EVariableType.SAMPLER_2D,value:t.EVariableCategory.ENGINE},e.u_cameraPos={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_refractionRatio={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_reflectivity={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_map0SourceRegion={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_map1SourceRegion={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_diffuseSourceRegion={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_map0RepeatRegion={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_map1RepeatRegion={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_diffuseRepeatRegion={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_combineMode={type:t.EVariableType.NUMBER_1,value:t.EVariableCategory.ENGINE},e.u_mixRatio={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE
},e.u_lightMapIntensity={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_diffuse={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_specular={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_emission={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_shininess={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_lightModel={type:t.EVariableType.NUMBER_1,value:t.EVariableCategory.ENGINE},e.u_isBothSide={type:t.EVariableType.NUMBER_1,value:t.EVariableCategory.ENGINE},e.u_opacity={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_ambient={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_directionLights={type:t.EVariableType.STRUCTURES,value:t.EVariableCategory.ENGINE},e.u_pointLights={type:t.EVariableType.STRUCTURES,value:t.EVariableCategory.ENGINE},e.u_vpMatrixFromLight={type:t.EVariableType.FLOAT_MAT4,value:t.EVariableCategory.ENGINE},e.u_lightPos={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_farPlane={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_interpolation={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_tilesHeightNumber={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_tilesWidthNumber={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_amplitude={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_jointColor={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_time={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_speed={type:t.EVariableType.FLOAT_2,value:t.EVariableCategory.ENGINE},e.u_shift={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_alphaThreshold={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_fireColor={type:t.EVariableType.STRUCTURE,value:t.EVariableCategory.ENGINE},e.u_layerHeightDatas={type:t.EVariableType.STRUCTURES,value:t.EVariableCategory.ENGINE},e.u_layerSampler2Ds={type:t.EVariableType.SAMPLER_ARRAY,value:t.EVariableCategory.ENGINE},e.u_herb1Color={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_herb2Color={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_herb3Color={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_groundColor={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_ampScale={type:t.EVariableType.FLOAT_1,value:t.EVariableCategory.ENGINE},e.u_woodColor={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_roadColor={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e.u_skyColor={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_cloudColor={type:t.EVariableType.FLOAT_4,value:t.EVariableCategory.ENGINE},e.u_brickColor={type:t.EVariableType.FLOAT_3,value:t.EVariableCategory.ENGINE},e}();t.VariableLib=e}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create();e.addChild(t.EVariableType.FLOAT_1,"float"),e.addChild(t.EVariableType.FLOAT_2,"vec2"),e.addChild(t.EVariableType.FLOAT_3,"vec3"),e.addChild(t.EVariableType.FLOAT_4,"vec4"),e.addChild(t.EVariableType.FLOAT_MAT3,"mat3"),e.addChild(t.EVariableType.FLOAT_MAT4,"mat4"),e.addChild(t.EVariableType.NUMBER_1,"int"),e.addChild(t.EVariableType.SAMPLER_CUBE,"samplerCube"),e.addChild(t.EVariableType.SAMPLER_2D,"sampler2D");var r=function(){function r(){}return r.getVariableType=function(r){var n=e.getChild(r);return t.Log.error(void 0===n,t.Log.info.FUNC_NOT_EXIST(r,"in VariableTypeTable")),n},r}();t.VariableTypeTable=r}(wd||(wd={}));var wd;!function(t){var e=wdCb.Hash.create();e.addChild("lightMap","u_lightMapSampler"),e.addChild("diffuseMap","u_diffuseMapSampler"),e.addChild("specularMap","u_specularMapSampler"),e.addChild("emissionMap","u_emissionMapSampler"),e.addChild("normalMap","u_normalMapSampler"),e.addChild("mirrorReflectionMap","u_mirrorSampler");var r=function(){function r(){}return r.getVariableName=function(r){var n=e.getChild(r);return t.Log.error(void 0===n,t.Log.info.FUNC_NOT_EXIST(r,"in VariableNameTable")),n},r}();t.VariableNameTable=r}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this.shader=null}return e.prototype.sendShaderVariables=function(t,e,r){},e.prototype.init=function(){},e.prototype.dispose=function(){},__decorate([t.virtual],e.prototype,"sendShaderVariables",null),__decorate([t.virtual],e.prototype,"init",null),__decorate([t.virtual],e.prototype,"dispose",null),e}();t.ShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(e,r,n){var o=this.shader;o.attributes.forEach(function(n,o){t.CustomShaderLibUtils.sendAttributeDataWithSemantic(o,n.type,n.value,e,r)}),o.uniforms.forEach(function(n,o){n.type!==t.EVariableType.SAMPLER_2D&&t.CustomShaderLibUtils.sendUniformDataWithSemantic(o,n.type,n.value,e,r)})},r}(t.ShaderLib);t.CustomShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.type=null,this.attributes=wdCb.Hash.create(),this.uniforms=wdCb.Hash.create(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null,this.vsSourceDefineList=wdCb.Collection.create(),this.fsSourceDefineList=wdCb.Collection.create()}return __extends(n,e),n.prototype.setShaderDefinition=function(t,e){var r=null,n=null;this._clearShaderDefinition(),r=this.getVsChunk(),n=this.getFsChunk(),r&&this.setVsSource(r),n&&this.setFsSource(n)},n.prototype.sendAttributeData=function(e,r,n){e.sendAttributeData(r,t.EVariableType.BUFFER,n)},n.prototype.sendUniformData=function(e,r,n){e.sendUniformData(r,t.VariableLib[r].type,n)},n.prototype.getVsChunk=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=0===t.length?this.type:t[0];return this._getChunk(n,r.vs)},n.prototype.getFsChunk=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var n=0===t.length?this.type:t[0];return this._getChunk(n,r.fs)},n.prototype.setVsSource=function(e,n){void 0===n&&(n="="),t.JudgeUtils.isString(e)?this.vsSource=e:this._setSource(e,r.vs,n)},n.prototype.setFsSource=function(e,n){void 0===n&&(n="="),t.JudgeUtils.isString(e)?this.fsSource=e:this._setSource(e,r.fs,n)},n.prototype.addAttributeVariable=function(t){this._addVariable(this.attributes,t)},n.prototype.addUniformVariable=function(t){this._addVariable(this.uniforms,t)},n.prototype._addVariable=function(e,r){r.forEach(function(r){t.Log.assert(t.VariableLib[r],t.Log.info.FUNC_SHOULD(r,"exist in VariableLib")),e.addChild(r,t.VariableLib[r])})},n.prototype._clearShaderDefinition=function(){this.attributes.removeAllChildren(),this.uniforms.removeAllChildren(),this.vsSourceDefineList.removeAllChildren(),this.fsSourceDefineList.removeAllChildren(),this.vsSourceTop="",this.vsSourceDefine="",this.vsSourceVarDeclare="",this.vsSourceFuncDeclare="",this.vsSourceFuncDefine="",this.vsSourceBody="",this.vsSource=null,this.fsSourceTop="",this.fsSourceDefine="",this.fsSourceVarDeclare="",this.fsSourceFuncDeclare="",this.fsSourceFuncDefine="",this.fsSourceBody="",this.fsSource=null},n.prototype._getChunk=function(e,n){var o=null;return e?(o=e.indexOf(".glsl")>-1?""+wdCb.PathUtils.basename(e,".glsl"):n===r.vs?e+"_vertex":e+"_fragment",t.ShaderChunk[o]?t.ShaderChunk[o]:t.ShaderChunk.empty):null},n.prototype._setSource=function(e,r,n){if(e)switch(n){case"+":this[r+"SourceTop"]+=e.top,this[r+"SourceDefine"]+=e.define,this[r+"SourceVarDeclare"]+=e.varDeclare,this[r+"SourceFuncDeclare"]+=e.funcDeclare,this[r+"SourceFuncDefine"]+=e.funcDefine,this[r+"SourceBody"]+=e.body;break;case"=":this[r+"SourceTop"]=e.top,this[r+"SourceDefine"]=e.define,this[r+"SourceVarDeclare"]=e.varDeclare,this[r+"SourceFuncDeclare"]=e.funcDeclare,this[r+"SourceFuncDefine"]=e.funcDefine,this[r+"SourceBody"]=e.body;break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("opertor:",n))}},__decorate([t.virtual],n.prototype,"setShaderDefinition",null),__decorate([t.require(function(e,r,n){t.assert(!!t.VariableLib[r],r+" should exist in VariableLib")})],n.prototype,"sendUniformData",null),__decorate([t.require(function(){t.assert(null===this.vsSource,t.Log.info.FUNC_SHOULD("vsSource","be null"))})],n.prototype,"setVsSource",null),__decorate([t.require(function(){t.assert(null===this.fsSource,t.Log.info.FUNC_SHOULD("fsSource","be null"))})],n.prototype,"setFsSource",null),n}(t.ShaderLib);t.EngineShaderLib=e;var r;!function(t){t[t.vs="vs"]="vs",t[t.fs="fs"]="fs"}(r||(r={}))}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="common"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(t,e,r){this.sendUniformData(t,"u_mMatrix",e.mMatrix),this.sendUniformData(t,"u_vMatrix",e.vMatrix),this.sendUniformData(t,"u_pMatrix",e.pMatrix)},r.prototype.setShaderDefinition=function(r,n){e.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable(["u_mMatrix","u_vMatrix","u_pMatrix"]),this.vsSourceDefine=t.ShaderChunk.common_define.define+t.ShaderChunk.common_vertex.define,this.vsSourceFuncDefine=t.ShaderChunk.common_function.funcDefine+t.ShaderChunk.common_vertex.funcDefine,this.fsSourceDefine=t.ShaderChunk.common_define.define+t.ShaderChunk.common_fragment.define,this.fsSourceFuncDefine=t.ShaderChunk.common_function.funcDefine+t.ShaderChunk.common_fragment.funcDefine},r}(t.EngineShaderLib);t.CommonShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="commonVertice"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(t,e,r){this._sendAttributeVariables(t,e)},r.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addAttributeVariable(["a_position"])},r.prototype._sendAttributeVariables=function(e,r){var n=r.buffers.getChild(t.EBufferDataType.VERTICE);n&&this.sendAttributeData(e,"a_position",n)},r}(t.EngineShaderLib);t.CommonVerticeShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="commonNormal"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(t,e,r){this._sendAttributeVariables(t,e)},r.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addAttributeVariable(["a_normal"])},r.prototype._sendAttributeVariables=function(e,r){var n=r.buffers.getChild(t.EBufferDataType.NORMAL);n&&this.sendAttributeData(e,"a_normal",n)},r}(t.EngineShaderLib);t.CommonNormalShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="basic"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(e,r,n){var o=r.buffers.getChild(t.EBufferDataType.COLOR);o&&(this.sendAttributeData(e,"a_color",o),this.sendUniformData(e,"u_opacity",n.opacity))},r.prototype.setShaderDefinition=function(r,n){e.prototype.setShaderDefinition.call(this,r,n),this.addAttributeVariable(["a_color"]),this.addUniformVariable(["u_opacity"]),this.vsSourceBody=t.ShaderSnippet.setPos_mvp+t.ShaderChunk.basic_vertex.body},r}(t.EngineShaderLib);t.BasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="basicEnd"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){},e}(t.EngineShaderLib);t.BasicEndShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="morphCommon"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(t,e,r){var n=e.animation;this.sendUniformData(t,"u_interpolation",n.interpolation)},r.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_interpolation"])},__decorate([t.require(function(e,r,n){t.assert(!!r.animation,t.Log.info.FUNC_SHOULD("entityObject","add MorphAnimation component"))})],r.prototype,"sendShaderVariables",null),r}(t.EngineShaderLib);t.MorphCommonShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="morphVertice"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(e,r,n){var o=r.buffers.getChild(t.EBufferDataType.VERTICE);o&&(this.sendAttributeData(e,"a_currentFramePosition",o[0]),this.sendAttributeData(e,"a_nextFramePosition",o[1]))},r.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addAttributeVariable(["a_currentFramePosition","a_nextFramePosition"])},__decorate([t.require(function(e,r,n){t.assert(!!r.animation,t.Log.info.FUNC_SHOULD("entityObject","add MorphAnimation component"))})],r.prototype,"sendShaderVariables",null),r}(t.EngineShaderLib);t.MorphVerticeShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="morphNormal"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(e,r,n){var o=r.buffers.getChild(t.EBufferDataType.NORMAL);o&&(this.sendAttributeData(e,"a_currentFrameNormal",o[0]),this.sendAttributeData(e,"a_nextFrameNormal",o[1]))},r.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addAttributeVariable(["a_currentFrameNormal","a_nextFrameNormal"])},r}(t.EngineShaderLib);t.MorphNormalShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="skybox"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_samplerCube0"])},e}(t.EngineShaderLib);t.SkyboxShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.prototype.sendShaderVariables=function(e,r,n){this.sendUniformData(e,"u_normalMatrix",r.normalMatrix),this.sendUniformData(e,"u_cameraPos",t.Director.getInstance().scene.currentCamera.transform.position)},r.prototype.setShaderDefinition=function(r,n){e.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable(["u_samplerCube0","u_cameraPos","u_normalMatrix"]),this.vsSourceBody=t.ShaderSnippet.setPos_mvp+this.getVsChunk().body},r.prototype.setEnvMapSource=function(){var t=this.getVsChunk("envMap_forBasic"),e=this.getFsChunk("envMap_forBasic");this.vsSourceTop=t.top,this.vsSourceDefine=t.define,this.vsSourceVarDeclare=t.varDeclare,this.vsSourceFuncDeclare=t.funcDeclare,this.vsSourceFuncDefine=t.funcDefine,this.vsSourceBody+=t.body,this.setFsSource(e)},r}(t.EngineShaderLib);t.EnvMapForBasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="basic_envMap_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.EnvMapForBasicShaderLib);t.BasicEnvMapForBasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="reflection_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.EnvMapForBasicShaderLib);t.ReflectionForBasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="refraction_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(e,r,n){t.prototype.sendShaderVariables.call(this,e,r,n),this.sendUniformData(e,"u_refractionRatio",n.refractionRatio)},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_refractionRatio"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.EnvMapForBasicShaderLib);t.RefractionForBasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="fresnel_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(e,r,n){t.prototype.sendShaderVariables.call(this,e,r,n),this.sendUniformData(e,"u_refractionRatio",n.refractionRatio),this.sendUniformData(e,"u_reflectivity",n.reflectivity)},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_refractionRatio","u_reflectivity"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.EnvMapForBasicShaderLib);t.FresnelForBasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.prototype.sendShaderVariables=function(t,e,r){},r.prototype.setShaderDefinition=function(r,n){e.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable(["u_samplerCube0"]),this.vsSourceBody=t.ShaderSnippet.setPos_mvp+this.getVsChunk().body},r.prototype.setEnvMapSource=function(){var t=this.getVsChunk("envMap_forLight"),e=this.getFsChunk("envMap_forLight");this.vsSourceTop=t.top,this.vsSourceDefine=t.define,this.vsSourceVarDeclare=t.varDeclare,this.vsSourceFuncDeclare=t.funcDeclare,this.vsSourceFuncDefine=t.funcDefine,this.vsSourceBody+=t.body,this.setFsSource(e)},r}(t.EngineShaderLib);t.EnvMapForLightShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="basic_forLight_envMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.EnvMapForLightShaderLib);t.BasicEnvMapForLightShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="reflection_forLight"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.EnvMapForLightShaderLib);t.ReflectionForLightShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="refraction_forLight"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(e,r,n){t.prototype.sendShaderVariables.call(this,e,r,n),this.sendUniformData(e,"u_refractionRatio",n.refractionRatio)},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_refractionRatio"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},e}(t.EnvMapForLightShaderLib);t.RefractionForLightShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="fresnel_forLight"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(r,n,o){e.prototype.sendShaderVariables.call(this,r,n,o),null!==o.reflectivity?this.sendUniformData(r,"u_reflectivity",o.reflectivity):(this.sendUniformData(r,"u_reflectivity",t.ShaderChunk.NULL),this.sendUniformData(r,"u_refractionRatio",o.refractionRatio))},r.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_refractionRatio","u_reflectivity"]),this.setEnvMapSource(),this.setFsSource(this.getFsChunk(),"+")},r}(t.EnvMapForLightShaderLib);t.FresnelForLightShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.prototype.sendShaderVariables=function(e,r,n){var o=r.buffers.getChild(t.EBufferDataType.TEXCOORD),i=null,a=null;o&&(this.sendAttributeData(e,"a_texCoord",o),i=n.mapList,a=i.getChild(0),this.sendUniformData(e,"u_map0SourceRegion",a.sourceRegionForGLSL),this.sendUniformData(e,"u_map0RepeatRegion",a.repeatRegion),this.sendMapShaderVariables(e,r,n))},r.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addAttributeVariable(["a_texCoord"]),this.addUniformVariable(["u_sampler2D0","u_map0SourceRegion","u_map0RepeatRegion"]),this._setMapSource()},r.prototype.sendMapShaderVariables=function(t,e,r){},r.prototype._setMapSource=function(){var t=this.getVsChunk("map_forBasic"),e=this.getFsChunk("map_forBasic");this.vsSourceTop=t.top,this.vsSourceDefine=t.define,this.vsSourceVarDeclare=t.varDeclare,this.vsSourceFuncDeclare=t.funcDeclare,this.vsSourceFuncDefine=t.funcDefine,this.vsSourceBody=t.body,this.setFsSource(e)},__decorate([t.virtual],r.prototype,"sendMapShaderVariables",null),r}(t.EngineShaderLib);t.MapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="map_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e}(t.MapShaderLib);t.BasicMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="multi_map_forBasic"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendMapShaderVariables=function(t,e,r){var n=r.mapList,o=n.getChild(1);this.sendUniformData(t,"u_combineMode",r.mapCombineMode),this.sendUniformData(t,"u_mixRatio",r.mapMixRatio),this.sendUniformData(t,"u_map1SourceRegion",o.sourceRegionForGLSL),this.sendUniformData(t,"u_map1RepeatRegion",o.repeatRegion)},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_sampler2D1","u_combineMode","u_mixRatio","u_map1SourceRegion","u_map1RepeatRegion"]),this.vsSourceVarDeclare+=this.getVsChunk().varDeclare,this.vsSourceBody+=this.getVsChunk().body,this.fsSourceVarDeclare=this.getFsChunk().varDeclare,this.fsSourceFuncDefine=this.getFsChunk().funcDefine,this.fsSourceBody=this.getFsChunk().body},e}(t.MapShaderLib);t.MultiMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="mirror_forBasic"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(t,e,r){},r.prototype.setShaderDefinition=function(r,n){e.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([t.VariableNameTable.getVariableName("mirrorReflectionMap")])},r}(t.EngineShaderLib);t.MirrorForBasicShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.prototype.setShaderDefinition=function(t){e.prototype.setShaderDefinition.call(this,t,null)},__decorate([t.virtual],r.prototype,"setShaderDefinition",null),r}(t.EngineShaderLib);t.ProceduralShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="lightCommon"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.setVsSource(this.getVsChunk("light_common.glsl")),this.setVsSource(this.getVsChunk(),"+"),this.setFsSource(this.getFsChunk("light_common.glsl")),this.setFsSource(this.getFsChunk(),"+")},e}(t.EngineShaderLib);t.LightCommonShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="light"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(e,r,n){
this.sendUniformData(e,"u_normalMatrix",r.normalMatrix),this.sendUniformData(e,"u_cameraPos",t.Director.getInstance().scene.currentCamera.transform.position),this.sendUniformData(e,"u_shininess",n.shininess),this.sendUniformData(e,"u_opacity",n.opacity),this.sendUniformData(e,"u_lightModel",this._convertLightModelToGLSLVariable(n.lightModel)),this._sendLightVariables(e)},r.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_normalMatrix","u_cameraPos","u_shininess","u_ambient","u_opacity","u_isBothSide","u_lightModel"]),this._setLightDefinition(r)},r.prototype._sendLightVariables=function(e){var r=t.Director.getInstance().scene,n=r.directionLights,o=r.ambientLight,i=r.pointLights;o&&this.sendUniformData(e,"u_ambient",o.getComponent(t.AmbientLight).color.toVector4()),i&&this._sendPointLightVariables(e,i),n&&this._sendDirectionLightVariables(e,n)},r.prototype._sendPointLightVariables=function(e,r){r.forEach(function(r,n){var o=r.getComponent(t.PointLight);e.sendStructureData("u_pointLights["+n+"].position",t.EVariableType.FLOAT_3,o.position),e.sendStructureData("u_pointLights["+n+"].color",t.EVariableType.FLOAT_4,o.color.toVector4()),e.sendStructureData("u_pointLights["+n+"].intensity",t.EVariableType.FLOAT_1,o.intensity),e.sendStructureData("u_pointLights["+n+"].constant",t.EVariableType.FLOAT_1,o.constant),e.sendStructureData("u_pointLights["+n+"].linear",t.EVariableType.FLOAT_1,o.linear),e.sendStructureData("u_pointLights["+n+"].quadratic",t.EVariableType.FLOAT_1,o.quadratic),null!==o.range?e.sendStructureData("u_pointLights["+n+"].range",t.EVariableType.FLOAT_1,o.range):e.sendStructureData("u_pointLights["+n+"].range",t.EVariableType.FLOAT_1,t.ShaderChunk.NULL)})},r.prototype._sendDirectionLightVariables=function(e,r){var n=this;r.forEach(function(r,o){var i=r.getComponent(t.DirectionLight);n._isZero(i.position)?e.sendStructureData("u_directionLights["+o+"].position",t.EVariableType.FLOAT_3,t.DirectionLight.defaultPosition):e.sendStructureData("u_directionLights["+o+"].position",t.EVariableType.FLOAT_3,i.position),e.sendStructureData("u_directionLights["+o+"].color",t.EVariableType.FLOAT_4,i.color.toVector4()),e.sendStructureData("u_directionLights["+o+"].intensity",t.EVariableType.FLOAT_1,i.intensity)})},r.prototype._isZero=function(t){var e=t.values;return 0===e[0]&&0===e[1]&&0===e[2]},r.prototype._setLightDefinition=function(e){var r=t.Director.getInstance().scene,n=r.directionLights,o=r.pointLights,i=0,a=0;n&&(this.addUniformVariable(["u_directionLights"]),i=n.getCount()),o&&(this.addUniformVariable(["u_pointLights"]),a=o.getCount()),this._addDefine(this.vsSourceDefineList,i,a),this._addDefine(this.fsSourceDefineList,i,a),e.side===t.ESide.BOTH&&this.fsSourceDefineList.addChildren([{name:"BOTH_SIDE"}])},r.prototype._addDefine=function(t,e,r){t.addChildren([{name:"DIRECTION_LIGHTS_COUNT",value:e},{name:"POINT_LIGHTS_COUNT",value:r}])},r.prototype._convertLightModelToGLSLVariable=function(e){switch(e){case t.ELightModel.BLINN:return 1;case t.ELightModel.PHONG:return 2;case t.ELightModel.CONSTANT:return 3;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("lightModel:"+e))}},__decorate([t.require(function(e){t.assert(e!==t.ELightModel.LAMBERT,t.Log.info.FUNC_SHOULD_NOT("lightModel","=== ELightModel.LAMBERT"))})],r.prototype,"_convertLightModelToGLSLVariable",null),r}(t.EngineShaderLib);t.LightShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="lightEnd"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){},e}(t.EngineShaderLib);t.LightEndShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.sendShaderVariables=function(t,e,r){},e}(t.EngineShaderLib);t.BaseLightMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(e,r,n){var o=r.buffers.getChild(t.EBufferDataType.TEXCOORD);o&&this.sendAttributeData(e,"a_texCoord",o)},r.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addAttributeVariable(["a_texCoord"])},r}(t.EngineShaderLib);t.CommonLightMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="lightMap"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(t,e,r){this.sendUniformData(t,"u_lightMapIntensity",r.lightMapIntensity)},r.prototype.setShaderDefinition=function(r,n){e.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([t.VariableNameTable.getVariableName("lightMap"),"u_lightMapIntensity"])},r}(t.BaseLightMapShaderLib);t.LightMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="diffuseMap"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(t,e,r){var n=r.diffuseMap;return this.sendUniformData(t,"u_diffuseSourceRegion",n.sourceRegionForGLSL),this.sendUniformData(t,"u_diffuseRepeatRegion",n.repeatRegion),this},r.prototype.setShaderDefinition=function(r,n){e.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([t.VariableNameTable.getVariableName("diffuseMap"),"u_diffuseSourceRegion","u_diffuseRepeatRegion"])},__decorate([t.require(function(e,r,n){var o=n.diffuseMap;t.assert(!!o,t.Log.info.FUNC_MUST_DEFINE("diffuseMap")),t.assert(!!o.sourceRegionForGLSL&&!!o.repeatRegion,t.Log.info.FUNC_SHOULD("material.diffuseMap","has sourceRegionForGLSL,repeatRegion data"))})],r.prototype,"sendShaderVariables",null),r}(t.BaseLightMapShaderLib);t.DiffuseMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="specularMap"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.setShaderDefinition=function(r,n){e.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([t.VariableNameTable.getVariableName("specularMap")])},r}(t.BaseLightMapShaderLib);t.SpecularMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="emissionMap"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.setShaderDefinition=function(r,n){e.prototype.setShaderDefinition.call(this,r,n),this.addUniformVariable([t.VariableNameTable.getVariableName("emissionMap")])},r}(t.BaseLightMapShaderLib);t.EmissionMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="normalMap"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(r,n,o){var i=null;e.prototype.sendShaderVariables.call(this,r,n,o),i=n.buffers.getChild(t.EBufferDataType.TANGENT),i&&this.sendAttributeData(r,"a_tangent",i)},r.prototype.setShaderDefinition=function(r,n){e.prototype.setShaderDefinition.call(this,r,n),this.addAttributeVariable(["a_tangent"]),this.addUniformVariable([t.VariableNameTable.getVariableName("normalMap")])},r}(t.BaseLightMapShaderLib);t.NormalMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noLightMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){},e}(t.EngineShaderLib);t.NoLightMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noDiffuseMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){this.sendUniformData(t,"u_diffuse",r.color.toVector4())},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_diffuse"])},e}(t.EngineShaderLib);t.NoDiffuseMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noSpecularMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){this.sendUniformData(t,"u_specular",r.specularColor.toVector4())},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_specular"])},e}(t.EngineShaderLib);t.NoSpecularMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noEmissionMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){this.sendUniformData(t,"u_emission",r.emissionColor.toVector4())},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_emission"])},e}(t.EngineShaderLib);t.NoEmissionMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noNormalMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){},e}(t.EngineShaderLib);t.NoNormalMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.setFsSource(this.getFsChunk("commonBuildShadowMap_fragment.glsl")),this.setFsSource(this.getFsChunk(),"+")},e}(t.EngineShaderLib);t.BuildShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="buildTwoDShadowMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){this.sendUniformData(t,"u_vpMatrixFromLight",r.buildTwoDShadowMapData.vpMatrixFromLight)},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_vpMatrixFromLight"])},e}(t.BuildShadowMapShaderLib);t.BuildTwoDShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="buildCubemapShadowMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){this.sendUniformData(t,"u_lightPos",r.buildCubemapShadowMapData.lightPos),this.sendUniformData(t,"u_farPlane",r.buildCubemapShadowMapData.farPlane)},e.prototype.setShaderDefinition=function(e,r){t.prototype.setShaderDefinition.call(this,e,r),this.addUniformVariable(["u_lightPos","u_farPlane"])},e}(t.BuildShadowMapShaderLib);t.BuildCubemapShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="totalShadowMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){},e}(t.EngineShaderLib);t.TotalShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._softTypeChangeSubscription=null}return __extends(r,e),r.prototype.init=function(){var e=this.shader;this._softTypeChangeSubscription=t.EventManager.fromEvent(t.Director.getInstance().scene.gameObjectScene,t.EEngineEvent.SHADOWMAP_SOFTTYPE_CHANGE).subscribe(function(){e.libDirty=!0})},r.prototype.dispose=function(){this._softTypeChangeSubscription&&this._softTypeChangeSubscription.dispose()},r.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this._setShadowMapSource()},r.prototype._setShadowMapSource=function(){var e=t.Director.getInstance().scene,r=e.directionLights?e.directionLights.filter(function(e){return e.getComponent(t.DirectionLight).castShadow}).getCount():0,n=e.pointLights?e.pointLights.filter(function(e){return e.getComponent(t.PointLight).castShadow}).getCount():0;e.shadowMap.softType===t.EShadowMapSoftType.PCF&&this.fsSourceDefineList.addChildren([{name:"SHADOWMAP_TYPE_PCF"}]),this.vsSourceDefineList.addChild({name:"TWOD_SHADOWMAP_COUNT",value:r}),this.fsSourceDefineList.addChildren([{name:"TWOD_SHADOWMAP_COUNT",value:r},{name:"CUBEMAP_SHADOWMAP_COUNT",value:n}])},r}(t.EngineShaderLib);t.ShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="twoDShadowMap"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(e,r,n){n.twoDShadowMapDatas.forEach(function(r,n){e.sendStructureData("u_vpMatrixFromLight["+n+"]",t.EVariableType.FLOAT_MAT4,r.vpMatrixFromLight),e.sendStructureData("u_twoDShadowSize["+n+"]",t.EVariableType.FLOAT_2,r.shadowSize),e.sendStructureData("u_twoDShadowBias["+n+"]",t.EVariableType.FLOAT_1,r.shadowBias),e.sendStructureData("u_twoDShadowDarkness["+n+"]",t.EVariableType.FLOAT_1,r.shadowDarkness),e.sendStructureData("u_twoDLightPos["+n+"]",t.EVariableType.FLOAT_3,r.lightPos)})},r}(t.ShadowMapShaderLib);t.TwoDShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="cubemapShadowMap"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(e,r,n){n.cubemapShadowMapDatas.forEach(function(r,n){e.sendStructureData("u_cubemapLightPos["+n+"]",t.EVariableType.FLOAT_3,r.lightPos),e.sendStructureData("u_farPlane["+n+"]",t.EVariableType.FLOAT_1,r.farPlane),e.sendStructureData("u_cubemapShadowBias["+n+"]",t.EVariableType.FLOAT_1,r.shadowBias),e.sendStructureData("u_cubemapShadowDarkness["+n+"]",t.EVariableType.FLOAT_1,r.shadowDarkness)})},r}(t.ShadowMapShaderLib);t.CubemapShadowMapShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="noShadowMap"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e,r){},e}(t.EngineShaderLib);t.NoShadowMapShaderLib=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){}return e.sendUniformData=function(e,r,n,o){r===t.EVariableType.STRUCTURE?this._sendStructureData(e,n,o):o.sendUniformData(e,r,n)},e.sendUniformDataWithSemantic=function(e,r,n,o,i){r===t.EVariableType.STRUCTURE?this._sendStructureDataWithSemantic(e,n,o,i):o.sendUniformData(e,r,this._getUniformData(n,i))},e.sendAttributeDataWithSemantic=function(t,e,r,n,o){n.sendAttributeData(t,this._getAttributeType(e),this._getAttributeData(r,e,o))},e._sendStructureData=function(t,e,r){for(var n in e)if(e.hasOwnProperty(n)){var o=e[n];r.sendStructureData(t+"."+n,o.type,o.value)}},e._sendStructureDataWithSemantic=function(t,e,r,n){for(var o in e)if(e.hasOwnProperty(o)){var i=e[o];r.sendStructureData(t+"."+o,i.type,this._getUniformData(i.value,n))}},e._getAttributeData=function(e,r,n){switch(e){case t.EVariableSemantic.POSITION:return n.buffers.getChild(t.EBufferDataType.VERTICE);case t.EVariableSemantic.TEXCOORD:return n.buffers.getChild(t.EBufferDataType.TEXCOORD);case t.EVariableSemantic.COLOR:return n.buffers.getChild(t.EBufferDataType.COLOR);case t.EVariableSemantic.NORMAL:return n.buffers.getChild(t.EBufferDataType.NORMAL);case t.EVariableSemantic.TANGENT:return n.buffers.getChild(t.EBufferDataType.TANGENT);default:return e}},e._getAttributeType=function(e){return t.EVariableType.BUFFER},e._getUniformData=function(e,r){switch(e){case t.EVariableSemantic.MODEL:return r.mMatrix;case t.EVariableSemantic.VIEW:return r.vMatrix;case t.EVariableSemantic.PROJECTION:return r.pMatrix;case t.EVariableSemantic.MODEL_VIEW_PROJECTION:return r.mvpMatrix;case t.EVariableSemantic.MODEL_INVERSE:return r.mMatrix.copy().invert();case t.EVariableSemantic.VIEW_INVERSE:return r.vMatrix.copy().invert();case t.EVariableSemantic.PROJECTION_INVERSE:return r.pMatrix.copy().invert();case t.EVariableSemantic.MODEL_VIEW_INVERSE:return r.mMatrix.applyMatrix(r.vMatrix,!0).invert();case t.EVariableSemantic.MODEL_VIEW_PROJECTION_INVERSE:return r.mMatrix.applyMatrix(r.vMatrix,!0).applyMatrix(r.pMatrix,!1).invert();case t.EVariableSemantic.MODEL_INVERSE_TRANSPOSE:return r.normalMatrix;case t.EVariableSemantic.MODEL_VIEW_INVERSE_TRANSPOSE:return r.mMatrix.applyMatrix(r.vMatrix,!0).invertTo3x3().transpose();case t.EVariableSemantic.VIEWPORT:return t.DeviceManager.getInstance().viewport;default:return e}},__decorate([t.require(function(e,r,n,o){t.assert(r!==t.EVariableType.SAMPLER_2D&&r!==t.EVariableType.SAMPLER_CUBE,t.Log.info.FUNC_SHOULD_NOT("type","be SAMPLER_2D or SAMPLER_CUBE, but actual is "+r)),t.assert(r!==t.EVariableType.STRUCTURES,t.Log.info.FUNC_NOT_SUPPORT("type === STRUCTURES")),r===t.EVariableType.STRUCTURE&&t.assert(t.JudgeUtils.isDirectObject(n),t.Log.info.FUNC_MUST_BE("value","object when type === STRUCTURE"))})],e,"sendUniformData",null),__decorate([t.require(function(e,r,n,o,i){t.assert(r!==t.EVariableType.SAMPLER_2D&&r!==t.EVariableType.SAMPLER_CUBE,t.Log.info.FUNC_SHOULD_NOT("type","be SAMPLER_2D or SAMPLER_CUBE, but actual is "+r)),t.assert(r!==t.EVariableType.STRUCTURES,t.Log.info.FUNC_NOT_SUPPORT("type === STRUCTURES")),r===t.EVariableType.STRUCTURE&&t.assert(t.JudgeUtils.isDirectObject(n),t.Log.info.FUNC_MUST_BE("value","object when type === STRUCTURE"))})],e,"sendUniformDataWithSemantic",null),__decorate([t.require(function(e,r,n){switch(t.assert("INDICE"!==e,t.Log.info.FUNC_NOT_SUPPORT("semantic:INDICE")),e){case"POSITION":case"COLOR":case"NORMAL":case"TANGENT":t.assert(r===t.EVariableType.FLOAT_3,t.Log.info.FUNC_SHOULD("type","be EVariableType.FLOAT_3"));break;case"TEXCOORD":t.assert(r===t.EVariableType.FLOAT_2,t.Log.info.FUNC_SHOULD("type","be EVariableType.FLOAT_2"))}}),t.ensure(function(e){t.assert(e&&e instanceof t.Buffer,t.Log.info.FUNC_SHOULD("attributeData","be Buffer, but actual is "+e))})],e,"_getAttributeData",null),e}();t.CustomShaderLibUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.main_begin="void main(void){\n",t.main_end="}\n",t.setPos_mvp="gl_Position = u_pMatrix * u_vMatrix * u_mMatrix * vec4(a_position, 1.0);\n",t}();t.ShaderSnippet=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._blendType=null,this._blendSrc=t.EBlendFunc.ONE,this._blendDst=t.EBlendFunc.ZERO,this._blendEquation=t.EBlendEquation.ADD,this._color=t.Color.create("#ffffff"),this.shader=this.createShader(),this.redWrite=!0,this.greenWrite=!0,this.blueWrite=!0,this.alphaWrite=!0,this.polygonOffsetMode=t.EPolygonOffsetMode.NONE,this.side=t.ESide.FRONT,this.blend=!1,this.blendFuncSeparate=null,this.blendEquationSeparate=[t.EBlendEquation.ADD,t.EBlendEquation.ADD],this.shading=t.EShading.FLAT,this.mapManager=t.MapManager.create(this),this.geometry=null}return Object.defineProperty(e.prototype,"program",{get:function(){return this.shader.program},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendType",{get:function(){return this._blendType?this._blendType:this.blendSrc===t.EBlendFunc.ONE&&this.blendDst===t.EBlendFunc.ZERO&&this.blendEquation===t.EBlendEquation.ADD?t.EBlendType.NONE:this.blendSrc===t.EBlendFunc.SRC_ALPHA&&this.blendDst===t.EBlendFunc.ONE_MINUS_SRC_ALPHA&&this.blendEquation===t.EBlendEquation.ADD?t.EBlendType.NORMAL:this.blendSrc===t.EBlendFunc.ONE&&this.blendDst===t.EBlendFunc.ONE&&this.blendEquation===t.EBlendEquation.ADD?t.EBlendType.ADDITIVE:this.blendSrc===t.EBlendFunc.SRC_ALPHA&&this.blendDst===t.EBlendFunc.ONE&&this.blendEquation===t.EBlendEquation.ADD?t.EBlendType.ADDITIVEALPHA:this.blendSrc===t.EBlendFunc.DST_COLOR&&this.blendDst===t.EBlendFunc.ZERO&&this.blendEquation===t.EBlendEquation.ADD?t.EBlendType.MULTIPLICATIVE:this.blendSrc===t.EBlendFunc.ONE&&this.blendDst===t.EBlendFunc.ONE_MINUS_SRC_ALPHA&&this.blendEquation===t.EBlendEquation.ADD?t.EBlendType.PREMULTIPLIED:t.EBlendType.NORMAL},set:function(e){switch(e){case t.EBlendType.NONE:this.blend=!1,this.blendSrc=t.EBlendFunc.ONE,this.blendDst=t.EBlendFunc.ZERO,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.NORMAL:this.blend=!0,this.blendSrc=t.EBlendFunc.SRC_ALPHA,this.blendDst=t.EBlendFunc.ONE_MINUS_SRC_ALPHA,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.PREMULTIPLIED:this.blend=!0,this.blendSrc=t.EBlendFunc.ONE,this.blendDst=t.EBlendFunc.ONE_MINUS_SRC_ALPHA,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.ADDITIVE:this.blend=!0,this.blendSrc=t.EBlendFunc.ONE,this.blendDst=t.EBlendFunc.ONE,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.ADDITIVEALPHA:this.blend=!0,this.blendSrc=t.EBlendFunc.SRC_ALPHA,this.blendDst=t.EBlendFunc.ONE,this.blendEquation=t.EBlendEquation.ADD;break;case t.EBlendType.MULTIPLICATIVE:this.blend=!0,this.blendSrc=t.EBlendFunc.DST_COLOR,this.blendDst=t.EBlendFunc.ZERO,this.blendEquation=t.EBlendEquation.ADD;break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("blendType"))}this._blendType=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"envMap",{get:function(){return this.mapManager.getEnvMap()},set:function(t){this.mapManager.setEnvMap(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendSrc",{get:function(){return this._blendSrc},set:function(t){this._blendSrc=t,this.blendFuncSeparate=null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendDst",{get:function(){return this._blendDst},set:function(t){this._blendDst=t,this.blendFuncSeparate=null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendEquation",{get:function(){return this._blendEquation},set:function(t){this._blendEquation=t,this.blendEquationSeparate=null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(e){this._isColorEqual(e,this._color)||(this.geometry&&this.geometry.entityObject&&t.EventManager.trigger(this.geometry.entityObject,t.EEngineEvent.MATERIAL_COLOR_CHANGE),this._color=e)},enumerable:!0,configurable:!0}),e.prototype.init=function(){this.shader.init(this),this.mapManager.init()},e.prototype.dispose=function(){this.shader.dispose(),this.mapManager.dispose()},e.prototype.bindAndUpdateTexture=function(){this.mapManager.bindAndUpdate()},e.prototype.sendTexture=function(t){this.mapManager.sendData(t)},e.prototype.updateShader=function(e){var r=t.Director.getInstance().scene;r.isUseProgram?r.shader.update(e,this):this.shader.update(e,this)},e.prototype._isColorEqual=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a},e}();t.Material=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.refractionRatio=0,this.reflectivity=null,this.mapCombineMode=t.ETextureCombineMode.MIX,this.mapMixRatio=.5}return __extends(r,e),r.prototype.init=function(){this._addTopShaderLib(),this.addShaderLib(),e.prototype.init.call(this)},r.prototype.addShaderLib=function(){},r.prototype.addNormalShaderLib=function(){this._hasAnimation()&&!this.shader.hasLib(t.MorphNormalShaderLib)?this._addShaderLibToTop(t.MorphNormalShaderLib.create()):this.shader.hasLib(t.CommonNormalShaderLib)||this._addShaderLibToTop(t.CommonNormalShaderLib.create())},r.prototype.setBlendByOpacity=function(t){1>t&&t>=0?this.blend=!0:this.blend=!1},r.prototype.createShader=function(){return t.CommonShader.create()},r.prototype._addTopShaderLib=function(){this.shader.addLib(t.CommonShaderLib.create()),this._hasAnimation()?(this.shader.addLib(t.MorphCommonShaderLib.create()),this.shader.addLib(t.MorphVerticeShaderLib.create())):this.shader.addLib(t.CommonVerticeShaderLib.create())},r.prototype._addShaderLibToTop=function(t){this.shader.addShaderLibToTop(t)},r.prototype._hasAnimation=function(){if(this.geometry instanceof t.ModelGeometry){var e=this.geometry;return e.hasAnimation()}return!1},__decorate([t.require(function(){t.assert(!(this.mirrorMap&&this.envMap),t.Log.info.FUNC_SHOULD_NOT("mirrorMap and envMap","be set both"))})],r.prototype,"init",null),__decorate([t.virtual],r.prototype,"addShaderLib",null),r}(t.Material);t.EngineMaterial=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._opacity=1}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"mapList",{get:function(){return this.mapManager.getMapList()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"map",{set:function(e){if(e instanceof t.Texture||e instanceof t.TextureAsset)this.mapManager.addMap(e);else for(var r=arguments[0],n=0,o=r;n<o.length;n++){var i=o[n];this.mapManager.addMap(i)}},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"mirrorMap",{get:function(){return this.mapManager.getMirrorMap()},set:function(t){this.mapManager.setMirrorMap(t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"opacity",{get:function(){return this._opacity},set:function(t){this.setBlendByOpacity(t),this._opacity=t},enumerable:!0,configurable:!0}),r.prototype.addShaderLib=function(){var e=null;this.shader.addLib(t.BasicShaderLib.create()),this._setMapShaderLib(),e=this.envMap,e&&this._setEnvMapShaderLib(e),this._setMirrorMapShaderLib(),this.shader.addLib(t.BasicEndShaderLib.create())},r.prototype._setMapShaderLib=function(){var e=this.mapManager,r=e.getMapCount();r>0&&(r>1?this.shader.addLib(t.MultiMapShaderLib.create()):this.shader.addLib(t.BasicMapShaderLib.create()))},r.prototype._setEnvMapShaderLib=function(e){switch(this.addNormalShaderLib(),e.mode){case t.EEnvMapMode.BASIC:this.shader.addLib(t.BasicEnvMapForBasicShaderLib.create());break;case t.EEnvMapMode.REFLECTION:this.shader.addLib(t.ReflectionForBasicShaderLib.create());break;case t.EEnvMapMode.REFRACTION:this.shader.addLib(t.RefractionForBasicShaderLib.create());break;case t.EEnvMapMode.FRESNEL:this.shader.addLib(t.FresnelForBasicShaderLib.create());break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EEnvMapMode"))}},r.prototype._setMirrorMapShaderLib=function(){this.mirrorMap&&this.shader.addLib(t.MirrorForBasicShaderLib.create());
},__decorate([t.ensureGetter(function(e){t.assert(e.getCount()<=2,wdCb.Log.info.FUNC_SUPPORT("only","map.count <= 2"))})],r.prototype,"mapList",null),__decorate([t.requireSetter(function(e){if(e instanceof t.Texture||e instanceof t.TextureAsset);else{var r=arguments[0];wdCb.Log.error(r.length>2,wdCb.Log.info.FUNC_SUPPORT("only","map.count <= 2"))}})],r.prototype,"map",null),r}(t.EngineMaterial);t.BasicMaterial=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.initWhenCreate=function(){this.side=t.ESide.BACK},r.prototype.addShaderLib=function(){this.shader.addLib(t.SkyboxShaderLib.create())},r}(t.EngineMaterial);t.SkyboxMaterial=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._lightMap=null,this._diffuseMap=null,this._specularMap=null,this._emissionMap=null,this._normalMap=null,this._shininess=32,this._opacity=1,this.lightModel=t.ELightModel.PHONG,this.twoDShadowMapDatas=wdCb.Collection.create(),this.cubemapShadowMapDatas=wdCb.Collection.create(),this.buildTwoDShadowMapData=null,this.buildCubemapShadowMapData=null,this.specularColor=t.Color.create("#ffffff"),this.emissionColor=t.Color.create("rgba(0,0,0,0)"),this.lightMapIntensity=1,this._twoDShadowMapSamplerIndex=0,this._cubemapShadowMapSamplerIndex=0}return __extends(r,e),r.create=function(){var t=new this;return t},Object.defineProperty(r.prototype,"lightMap",{get:function(){return this._lightMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("lightMap")}),this._lightMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"diffuseMap",{get:function(){return this._diffuseMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("diffuseMap")}),this._diffuseMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"specularMap",{get:function(){return this._specularMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("specularMap")}),this._specularMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"emissionMap",{get:function(){return this._emissionMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("emissionMap")}),this._emissionMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"normalMap",{get:function(){return this._normalMap},set:function(e){this.mapManager.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("normalMap")}),this._normalMap=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"shininess",{get:function(){return Number(this._shininess)<=0?32:this._shininess},set:function(t){this._shininess=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"opacity",{get:function(){return this._opacity},set:function(t){this.setBlendByOpacity(t),this._opacity=t},enumerable:!0,configurable:!0}),r.prototype.addTwoDShadowMap=function(t){this.mapManager.addMap(t,{samplerData:this._twoDShadowMapSamplerIndex}),this._twoDShadowMapSamplerIndex++},r.prototype.addCubemapShadowMap=function(t){this.mapManager.addMap(t,{samplerData:this._cubemapShadowMapSamplerIndex}),this._cubemapShadowMapSamplerIndex++},r.prototype.hasShadowMap=function(t){return this.mapManager.hasMap(t)},r.prototype.addTwoDShadowMapData=function(t){this.twoDShadowMapDatas.addChild(t)},r.prototype.addCubemapShadowMapData=function(t){this.cubemapShadowMapDatas.addChild(t)},r.prototype.clearTwoDShadowMapData=function(){this.twoDShadowMapDatas.removeAllChildren()},r.prototype.clearCubemapShadowMapData=function(){this.cubemapShadowMapDatas.removeAllChildren()},r.prototype.addExtendShaderLib=function(){},r.prototype.addShaderLib=function(){var e=null;this.addNormalShaderLib(),this.shader.addLib(t.LightCommonShaderLib.create()),this._setLightMapShaderLib(),this.shader.addLib(t.LightShaderLib.create()),e=this.envMap,e&&this._setEnvMapShaderLib(e),this.addExtendShaderLib(),this.shader.addLib(t.LightEndShaderLib.create())},r.prototype._setLightMapShaderLib=function(){var e=t.Director.getInstance().scene;this.shader.addLib(t.CommonLightMapShaderLib.create()),this._lightMap?this.shader.addLib(t.LightMapShaderLib.create()):this.shader.addLib(t.NoLightMapShaderLib.create()),this._diffuseMap?this.shader.addLib(t.DiffuseMapShaderLib.create()):this.shader.addLib(t.NoDiffuseMapShaderLib.create()),this._specularMap?this.shader.addLib(t.SpecularMapShaderLib.create()):this.shader.addLib(t.NoSpecularMapShaderLib.create()),this._emissionMap?this.shader.addLib(t.EmissionMapShaderLib.create()):this.shader.addLib(t.NoEmissionMapShaderLib.create()),this._normalMap?this.shader.addLib(t.NormalMapShaderLib.create()):this.shader.addLib(t.NoNormalMapShaderLib.create()),e.shadowMap.enable&&(this._hasTwoDShadowMap()||this._hasCubemapShadowMap())?(this._hasTwoDShadowMap()&&this.shader.addLib(t.TwoDShadowMapShaderLib.create()),this._hasCubemapShadowMap()&&this.shader.addLib(t.CubemapShadowMapShaderLib.create()),this.shader.addLib(t.TotalShadowMapShaderLib.create())):this.shader.addLib(t.NoShadowMapShaderLib.create())},r.prototype._setEnvMapShaderLib=function(e){switch(e.mode){case t.EEnvMapMode.BASIC:this.shader.addLib(t.BasicEnvMapForLightShaderLib.create());break;case t.EEnvMapMode.REFLECTION:this.shader.addLib(t.ReflectionForLightShaderLib.create());break;case t.EEnvMapMode.REFRACTION:this.shader.addLib(t.RefractionForLightShaderLib.create());break;case t.EEnvMapMode.FRESNEL:this.shader.addLib(t.FresnelForLightShaderLib.create());break;default:t.Log.error(!0,t.Log.info.FUNC_INVALID("EEnvMapMode"))}},r.prototype._hasTwoDShadowMap=function(){return this.mapManager.hasMap(function(e){return e instanceof t.TwoDShadowMapTexture})},r.prototype._hasCubemapShadowMap=function(){return this.mapManager.hasMap(function(e){return e instanceof t.CubemapShadowMapTexture})},__decorate([t.requireSetter(function(e){t.assert(e instanceof t.ImageTexture||e instanceof t.ProceduralTexture,t.Log.info.FUNC_SHOULD("lightMap","be ImageTexture or ProceduralTexture"))})],r.prototype,"lightMap",null),__decorate([t.requireSetter(function(e){t.assert(e instanceof t.ImageTexture||e instanceof t.ProceduralTexture,t.Log.info.FUNC_SHOULD("diffuseMap","be ImageTexture or ProceduralTexture"))})],r.prototype,"diffuseMap",null),__decorate([t.requireSetter(function(e){t.assert(e instanceof t.ImageTexture||e instanceof t.ProceduralTexture,t.Log.info.FUNC_SHOULD("specularMap","be ImageTexture or ProceduralTexture"))})],r.prototype,"specularMap",null),__decorate([t.requireSetter(function(e){t.assert(e instanceof t.ImageTexture||e instanceof t.ProceduralTexture,t.Log.info.FUNC_SHOULD("emissionMap","be ImageTexture or ProceduralTexture"))})],r.prototype,"emissionMap",null),__decorate([t.requireSetter(function(e){t.assert(e instanceof t.ImageTexture,t.Log.info.FUNC_SHOULD("normalMap","be ImageTexture"))})],r.prototype,"normalMap",null),__decorate([t.virtual],r.prototype,"addExtendShaderLib",null),r}(t.EngineMaterial);t.LightMaterial=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.init=function(){this.shader.addLib(t.CustomShaderLib.create()),e.prototype.init.call(this)},r.prototype.read=function(e){var r=this;this.shader.read(t.LoaderManager.getInstance().get(e)),this.shader.getSampler2DUniformsAfterRead().forEach(function(e,n){r.mapManager.addMap(t.LoaderManager.getInstance().get(e.textureId),{samplerVariableName:n})})},r.prototype.createShader=function(){return t.CustomShader.create()},__decorate([t.ensure(function(){t.assert(1===this.shader.getLibs().getCount()&&this.shader.hasLib(t.CustomShaderLib),t.Log.info.FUNC_SHOULD("only has CustomShaderLib, not has other shader libs"))})],r.prototype,"init",null),r}(t.Material);t.ShaderMaterial=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.FLAT=0]="FLAT",t[t.SMOOTH=1]="SMOOTH"}(t.EShading||(t.EShading={}));t.EShading}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(t){this._material=null,this._mapTable=wdCb.Hash.create(),this._arrayMapList=wdCb.Collection.create(),this._mirrorMap=null,this._textureDirty=!1,this._allMapsCache=null,this._allSingleMapsCache=null,this._material=t}return e.create=function(t){var e=new this(t);return e},e.prototype.init=function(){for(var t=this._getAllMaps(),e=0,r=t.length;r>e;e++){var n=t[e];n.init()}},e.prototype.addMap=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null;if(e[0]instanceof t.TextureAsset){var o=e[0];n=o.toTexture()}else e[0]instanceof t.Texture&&(n=e[0]);if(2===e.length){var i=e[1];this._setMapOption(n,i)}n.material=this._material,this._mapTable.appendChild("map",n),this._textureDirty=!0},e.prototype.addArrayMap=function(t,e){this._arrayMapList.addChild({samplerName:t,mapArray:e}),this._textureDirty=!0},e.prototype.getMapList=function(){var e=this._mapTable.getChild("map");return e?this._mapTable.getChild("map").filter(function(e){return e instanceof t.BasicTexture||e instanceof t.ProceduralTexture}):wdCb.Collection.create()},e.prototype.hasMap=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null;return n=this._mapTable.getChild("map"),n?t.JudgeUtils.isFunction(e[0])?n.hasChildWithFunc(e[0]):n.hasChild(e[0]):!1},e.prototype.getMapCount=function(){return this.getMapList().getCount()},e.prototype.getEnvMap=function(){return this._getMapByType("envMap")},e.prototype.setEnvMap=function(t){this._setMap("envMap",t)},e.prototype.getMirrorMap=function(){return this._mirrorMap},e.prototype.setMirrorMap=function(e){this.addMap(e,{samplerVariableName:t.VariableNameTable.getVariableName("mirrorReflectionMap")}),this._mirrorMap=e},e.prototype.isMirrorMap=function(t){return t===this._mirrorMap},e.prototype.removeAllChildren=function(){this._mapTable.removeAllChildren(),this._arrayMapList.removeAllChildren(),this._textureDirty=!0},e.prototype.dispose=function(){for(var t=this._getAllMaps(),e=0,r=t.length;r>e;e++){var n=t[e];n.dispose()}this.removeAllChildren()},e.prototype.bindAndUpdate=function(){for(var t=this._getAllMaps(),e=0,r=t.length;r>e;e++){var n=t[e];n.bindToUnit(e),n.needUpdate&&n.update(e)}},e.prototype.sendData=function(t){this._sendSingleMapData(t),this._sendArrayMapData(t)},e.prototype._sendSingleMapData=function(t){for(var e=this._getAllSingleMaps(),r=e.length,n=0;r>n;n++){var o=e[n];o.sendData(t,o.getSamplerName(n),n)}},e.prototype._sendArrayMapData=function(e){var r=this,n=this._getMaxUnitOfBindedSingleMap();this._arrayMapList.forEach(function(o){var i=o.mapArray.length;e.sendUniformData(o.samplerName+"[0]",t.EVariableType.SAMPLER_ARRAY,r._generateArrayMapUnitArray(n,n+i)),n+=i})},e.prototype._generateArrayMapUnitArray=function(t,e){for(var r=[];e>t;)r.push(t),t++;return r},e.prototype._getAllMaps=function(){return[].concat(this._getAllSingleMaps(),this._getAllArrayMaps())},e.prototype._getMaxUnitOfBindedSingleMap=function(){return this._getAllSingleMaps().length},e.prototype._getAllSingleMaps=function(){return this._mapTable.toArray()},e.prototype._getAllArrayMaps=function(){var t=[];return this._arrayMapList.forEach(function(e){t=t.concat(e.mapArray)}),t},e.prototype._getMapByType=function(t){return this._mapTable.getChild(t)},e.prototype._setMap=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=t[0],n=t[1];if(!n)return void this._removeMap(r,n);if(3===arguments.length){var o=t[1];this._setMapOption(n,o)}n.material=this._material,this._mapTable.addChild(r,n)},e.prototype._removeMap=function(t,e){this._mapTable.removeChild(t),this._textureDirty=!0},e.prototype._setMapOption=function(t,e){t.variableData=e},__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];t.assert(e[0]instanceof t.TextureAsset||e[0]instanceof t.Texture,t.Log.info.FUNC_SHOULD("arguments[0]","be TextureAsset || Texture"))})],e.prototype,"addMap",null),__decorate([t.ensure(function(e){e.forEach(function(e){t.assert(e instanceof t.BasicTexture||e instanceof t.ProceduralTexture,t.Log.info.FUNC_SHOULD("mapList","only contain BasicTexture or ProceduralTexture"))})})],e.prototype,"getMapList",null),__decorate([t.ensure(function(e,r,n){t.assert(e.length===n-r,t.Log.info.FUNC_SHOULD("length","be "+(n-r)+", but actual is "+e.length)),t.assert(e[0]===r,t.Log.info.FUNC_SHOULD("first element","be "+r+", but actual is "+e[0])),t.assert(e[e.length-1]===n-1,t.Log.info.FUNC_SHOULD("last element","be "+(n-1)+", but actual is "+e[e.length-1]))})],e.prototype,"_generateArrayMapUnitArray",null),__decorate([t.ensure(function(e){for(var r=0,n=e;r<n.length;r++){var o=n[r];t.assert(o instanceof t.Texture,t.Log.info.FUNC_SHOULD("each element","be Texture"))}}),t.cache(function(){return!this._textureDirty&&this._allMapsCache},function(){return this._allMapsCache},function(t){this._allMapsCache=t,this._textureDirty=!1})],e.prototype,"_getAllMaps",null),__decorate([t.cache(function(){return!this._textureDirty&&this._allSingleMapsCache},function(){return this._allSingleMapsCache},function(t){this._allSingleMapsCache=t,this._textureDirty=!1})],e.prototype,"_getAllSingleMaps",null),__decorate([t.ensure(function(e){for(var r=0,n=e;r<n.length;r++){var o=n[r];t.assert(o instanceof t.Texture,t.Log.info.FUNC_SHOULD("each element","be Texture"))}})],e.prototype,"_getAllArrayMaps",null),e}();t.MapManager=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.UNKNOW=0]="UNKNOW",t[t.FONT=1]="FONT"}(t.EAssetType||(t.EAssetType={}));t.EAssetType}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._container=wdCb.Hash.create()}return e.prototype.load=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=e[0],o=null,i=this,a=null,s=null;return o=1===e.length?t.JudgeUtils.isArrayExactly(n)?n.join("-"):n:e[1],a=this._container.getChild(o),s=a?wdFrp.just(a):this.loadAsset(n,o)["do"](function(t){i._container.addChild(o,t)},function(t){i._errorHandle(n,t)},null)},e.prototype.get=function(t){return this._container.getChild(t)},e.prototype.has=function(t){return this._container.hasChild(t)},e.prototype.dispose=function(){this._container.removeAllChildren()},e.prototype._errorHandle=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null,o=null;n=t.JudgeUtils.isArrayExactly(e[0])?e[0].join(","):e[0],o=e[1],t.Log.log("load "+n+" asset fail:"+o)},e}();t.Loader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.loadAsset=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=e[0];return t.AjaxLoader.load(n,"text")},r._instance=null,__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],r.prototype,"loadAsset",null),r}(t.Loader);t.GLSLLoader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.loadAsset=function(){for(var t=this,e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=this,o=e[0];return wdFrp.fromPromise(new RSVP.Promise(function(e,r){var i=n._createScript();i.async=!1,i.addEventListener("error",function(t){r("load js file error. url:"+o)}),i.readyState?i.onreadystatechange=function(){("loaded"===i.readyState||"complete"===i.readyState)&&(i.onreadystatechange=null,e(o))}:i.onload=function(){e(o)},i.src=o,t._appendScript(i)}))},r.prototype._createScript=function(){var t=document.createElement("script");return t.type="text/javascript",t},r.prototype._appendScript=function(t){document.getElementsByTagName("head")[0].appendChild(t)},r._instance=null,__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],r.prototype,"loadAsset",null),r}(t.Loader);t.JsLoader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.loadAsset=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=e[0];return t.AjaxLoader.load(n,"json")},r._instance=null,__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],r.prototype,"loadAsset",null),r}(t.Loader);t.JSONLoader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.loadAsset=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null;return n=t.JudgeUtils.isString(e[0])?[e[0]]:e[0],wdFrp.fromPromise(new RSVP.Promise(function(e,r){t.Video.create({urlArr:n,onLoad:function(r){e(t.VideoTextureAsset.create(r))},onError:function(t){r(t)}})}))},r._instance=null,r}(t.Loader);t.VideoLoader=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.loadAsset=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=null,o=null,i=e[0];switch(n=wdCb.PathUtils.extname(i).toLowerCase()){case".jpg":case".jpeg":case".gif":case".bmp":o=t.ImageLoader.load(i).map(function(e){var r=t.ImageTextureAsset.create(e);return r.format=t.ETextureFormat.RGB,r});break;case".png":o=t.ImageLoader.load(i).map(function(e){return t.ImageTextureAsset.create(e)});break;case".dds":o=t.CompressedTextureLoader.load(i);break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT(n))}return o},r._instance=null,__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],r.prototype,"loadAsset",null),r}(t.Loader);t.TextureLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.load=function(e){return wdFrp.fromPromise(new RSVP.Promise(function(r,n){var o=null;o=new t.root.Image,o.onload=function(){this.onload=null,r(o)},o.onerror=function(){n("error")},o.src=e}))},e}();t.ImageLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.load=function(t,e){return wdFrp.fromPromise(new RSVP.Promise(function(r,n){wdCb.AjaxUtils.ajax({type:"get",url:t,contentType:"text/plain; charset=utf-8",dataType:e,success:function(t){r(t)},error:function(e,r){n("url:"+t+"\nreadyState:"+e.readyState+"\nstatus:"+e.status+"\nmessage:"+r.message+"\nresponseText:"+e.responseText)}})}))},t}();t.AjaxLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.getPath=function(t,e){return wdCb.PathUtils.dirname(t)+"/"+e},t}();t.ModelLoaderUtils=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.load=function(e){var r=this;return t.AjaxLoader.load(e,"arraybuffer").map(function(e){var n=t.DDSParser.parse(e,!0),o=t.CompressedTextureAsset.create();return o.width=n.width,o.height=n.height,o.mipmaps=n.mipmaps,1==n.mipmapCount&&(o.minFilter=t.ETextureFilterMode.LINEAR),o.format=r._getCompressedFormat(n.format),o})},e._getCompressedFormat=function(e){var r=t.GPUDetector.getInstance().extensionCompressedTextureS3TC;if(e===t.ETextureFormat.RGBA)return e;if(!r)return null;switch(e){case t.ETextureFormat.RGB_S3TC_DXT1:e=r.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case t.ETextureFormat.RGBA_S3TC_DXT1:e=r.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case t.ETextureFormat.RGBA_S3TC_DXT3:e=r.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case t.ETextureFormat.RGBA_S3TC_DXT5:e=r.COMPRESSED_RGBA_S3TC_DXT5_EXT}return e},e}();t.CompressedTextureLoader=e}(wd||(wd={}));var wd;!function(t){var e=542327876,r=131072,n=512,o=4,i=function(){function i(){}return i.parse=function(i,s){void 0===s&&(s=!0);var c=new a,u=this._fourCCToInt32("DXT1"),l=this._fourCCToInt32("DXT3"),h=this._fourCCToInt32("DXT5"),p=31,f=0,d=1,_=2,y=3,g=4,m=7,v=20,b=21,C=22,E=23,w=24,T=25,O=26,S=28,x=new Int32Array(i,0,p),D=null,L=null,M=null,A=null,R=null,P=null,N=null;if(x[f]!==e)return t.Log.error(!0,"Invalid magic number in DDS header."),c;if(!x[v]&o)return t.Log.error(!0,"Unsupported format, must contain a FourCC code."),c;switch(L=x[b],M=!1,L){case u:D=8,c.format=t.ETextureFormat.RGB_S3TC_DXT1;break;case l:D=16,c.format=t.ETextureFormat.RGBA_S3TC_DXT3;break;case h:D=16,c.format=t.ETextureFormat.RGBA_S3TC_DXT5;break;default:if(!(32==x[C]&&16711680&x[E]&&65280&x[w]&&255&x[T]&&4278190080&x[O]))return t.Log.error(!0,"Unsupported FourCC code "+this._int32ToFourCC(L)),c;M=!0,D=64,c.format=t.ETextureFormat.RGBA}c.mipmapCount=1,x[_]&r&&s!==!1&&(c.mipmapCount=Math.max(1,x[m])),c.isCubemap=x[S]&n?!0:!1,c.width=x[g],c.height=x[y],A=x[d]+4,R=c.width,P=c.height,N=c.isCubemap?6:1;for(var F=0;N>F;F++){for(var U=0;U<c.mipmapCount;U++){var j=null,I=null,B=null;M?(I=this._loadARGBMip(i,A,R,P),B=I.length):(B=Math.max(4,R)/4*Math.max(4,P)/4*D,I=new Uint8Array(i,A,B)),j={data:I,width:R,height:P},c.mipmaps.addChild(j),A+=B,R=Math.max(.5*R,1),P=Math.max(.5*P,1)}R=c.width,P=c.height}return c},i._fourCCToInt32=function(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)},i._int32ToFourCC=function(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)},i._loadARGBMip=function(t,e,r,n){for(var o=r*n*4,i=new Uint8Array(t,e,o),a=new Uint8Array(o),s=0,c=0,u=0;n>u;u++)for(var l=0;r>l;l++){var h=null,p=null,f=null,d=null;h=i[c],c++,p=i[c],c++,f=i[c],c++,d=i[c],c++,a[s]=f,s++,a[s]=p,s++,a[s]=h,s++,a[s]=d,s++}return a},i}();t.DDSParser=i;var a=function(){function t(){this.mipmaps=wdCb.Collection.create(),this.width=0,this.height=0,this.format=null,this.mipmapCount=1,this.isCubemap=!1}return t}();t.DDSData=a}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._width=null,this._height=null,this.generateMipmaps=!0,this.sourceRegionMethod=t.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL,this.format=t.ETextureFormat.RGBA,this.source=e.defaultTexture,this.repeatRegion=t.RectRegion.create(0,0,1,1),this.sourceRegion=null,this.sourceRegionMapping=t.ETextureSourceRegionMapping.CANVAS,this.flipY=!0,this.premultiplyAlpha=!1,this.unpackAlignment=4,this.wrapS=t.ETextureWrapMode.CLAMP_TO_EDGE,this.wrapT=t.ETextureWrapMode.CLAMP_TO_EDGE,this.magFilter=t.ETextureFilterMode.LINEAR,this.minFilter=t.ETextureFilterMode.LINEAR_MIPMAP_LINEAR,this.type=t.ETextureType.UNSIGNED_BYTE,this.mipmaps=wdCb.Collection.create(),this.anisotropy=0,this.needUpdate=!0}return Object.defineProperty(e.prototype,"width",{get:function(){return null===this._width?this.source?this.source.width:null:this._width},set:function(t){this._width=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return null===this._height?this.source?this.source.height:null:this._height},set:function(t){this._height=t},enumerable:!0,configurable:!0}),e.prototype.copyToCubemapTexture=function(e){e.generateMipmaps=this.generateMipmaps,e.minFilter=this.minFilter,e.magFilter=this.magFilter,e.width=this.width,e.height=this.height,e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.anisotropy=this.anisotropy,e.premultiplyAlpha=this.premultiplyAlpha,e.unpackAlignment=this.unpackAlignment,e.needUpdate=this.needUpdate,e.mode=t.EEnvMapMode.BASIC},e.prototype.copyTo=function(e){return t.Log.error(!e,t.Log.info.FUNC_MUST_DEFINE("texture")),e.source=this.source,e.width=this.width,e.height=this.height,e.mipmaps=this.mipmaps.copy(),e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.minFilter=this.minFilter,e.anisotropy=this.anisotropy,e.format=this.format,e.type=this.type,e.repeatRegion=this.repeatRegion.copy(),e.sourceRegion=this.sourceRegion&&this.sourceRegion.copy(),e.sourceRegionMapping=this.sourceRegionMapping,e.sourceRegionMethod=this.sourceRegionMethod,e.generateMipmaps=this.generateMipmaps,e.premultiplyAlpha=this.premultiplyAlpha,e.flipY=this.flipY,e.unpackAlignment=this.unpackAlignment,e.needUpdate=this.needUpdate,e},e.defaultTexture=null,e}();t.TextureAsset=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(t){e.call(this),this.source=t}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.toTexture=function(){return t.ImageTexture.create(this)},r.prototype.toCubemapFaceTexture=function(){return t.CubemapFaceImageTexture.create(this)},r.prototype.copyToCubemapFaceTexture=function(e){e.source=this.source,e.type=this.type,e.format=this.format,e.width=this.width,e.height=this.height,e.sourceRegion=this.sourceRegion,e.sourceRegionMethod=t.ETextureSourceRegionMethod.DRAW_IN_CANVAS},r}(t.TextureAsset);t.ImageTextureAsset=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(t){e.call(this),this.video=null,this.video=t,this.source=this.video.source}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(),e},r.prototype.initWhenCreate=function(){this.width=0,this.height=0,this.generateMipmaps=!1,this.minFilter=null,this.magFilter=null,this.sourceRegion=null,this.sourceRegionMethod=null},r.prototype.toTexture=function(){return t.VideoTexture.create(this)},r.prototype.toCubemapFaceTexture=function(){return t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("video texture","cubemap"))},r.prototype.copyToCubemapFaceTexture=function(e){t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("video texture","cubemap"))},r}(t.TextureAsset);t.VideoTextureAsset=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.initWhenCreate=function(){this.generateMipmaps=!1,this.flipY=!1},r.prototype.toTexture=function(){return t.CompressedTexture.create(this)},r.prototype.toCubemapFaceTexture=function(){return t.CubemapFaceCompressedTexture.create(this)},r.prototype.copyToCubemapFaceTexture=function(t){t.type=this.type,t.format=this.format,t.width=this.width,t.height=this.height,t.mipmaps=this.mipmaps,t.minFilter=this.minFilter},r}(t.TextureAsset);t.CompressedTextureAsset=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.NEAREST="NEAREST"]="NEAREST",t[t.NEAREST_MIPMAP_MEAREST="NEAREST_MIPMAP_MEAREST"]="NEAREST_MIPMAP_MEAREST",t[t.NEAREST_MIPMAP_LINEAR="NEAREST_MIPMAP_LINEAR"]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR="LINEAR"]="LINEAR",t[t.LINEAR_MIPMAP_NEAREST="LINEAR_MIPMAP_NEAREST"]="LINEAR_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_LINEAR="LINEAR_MIPMAP_LINEAR"]="LINEAR_MIPMAP_LINEAR"}(t.ETextureFilterMode||(t.ETextureFilterMode={}));t.ETextureFilterMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.REPEAT="REPEAT"]="REPEAT",t[t.MIRRORED_REPEAT="MIRRORED_REPEAT"]="MIRRORED_REPEAT",t[t.CLAMP_TO_EDGE="CLAMP_TO_EDGE"]="CLAMP_TO_EDGE";
}(t.ETextureWrapMode||(t.ETextureWrapMode={}));t.ETextureWrapMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.RGB="RGB"]="RGB",t[t.RGBA="RGBA"]="RGBA",t[t.ALPHA="ALPHA"]="ALPHA",t[t.LUMINANCE="LUMINANCE"]="LUMINANCE",t[t.LUMINANCE_ALPHA="LUMINANCE_ALPHA"]="LUMINANCE_ALPHA",t[t.RGB_S3TC_DXT1="RGB_S3TC_DXT1"]="RGB_S3TC_DXT1",t[t.RGBA_S3TC_DXT1="RGBA_S3TC_DXT1"]="RGBA_S3TC_DXT1",t[t.RGBA_S3TC_DXT3="RGBA_S3TC_DXT3"]="RGBA_S3TC_DXT3",t[t.RGBA_S3TC_DXT5="RGBA_S3TC_DXT5"]="RGBA_S3TC_DXT5"}(t.ETextureFormat||(t.ETextureFormat={}));t.ETextureFormat}(wd||(wd={}));var wd;!function(t){!function(t){t[t.UNSIGNED_BYTE="UNSIGNED_BYTE"]="UNSIGNED_BYTE",t[t.UNSIGNED_SHORT_5_6_5="UNSIGNED_SHORT_5_6_5"]="UNSIGNED_SHORT_5_6_5",t[t.UNSIGNED_SHORT_4_4_4_4="UNSIGNED_SHORT_4_4_4_4"]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1="UNSIGNED_SHORT_5_5_5_1"]="UNSIGNED_SHORT_5_5_5_1"}(t.ETextureType||(t.ETextureType={}));t.ETextureType}(wd||(wd={}));var wd;!function(t){!function(t){t[t.BASIC=0]="BASIC",t[t.REFLECTION=1]="REFLECTION",t[t.REFRACTION=2]="REFRACTION",t[t.FRESNEL=3]="FRESNEL"}(t.EEnvMapMode||(t.EEnvMapMode={}));t.EEnvMapMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.MIX=0]="MIX",t[t.MULTIPLY=1]="MULTIPLY",t[t.ADD=2]="ADD"}(t.ETextureCombineMode||(t.ETextureCombineMode={}));t.ETextureCombineMode}(wd||(wd={}));var wd;!function(t){!function(t){t[t.CANVAS=0]="CANVAS",t[t.UV=1]="UV"}(t.ETextureSourceRegionMapping||(t.ETextureSourceRegionMapping={}));t.ETextureSourceRegionMapping}(wd||(wd={}));var wd;!function(t){!function(t){t[t.CHANGE_TEXCOORDS_IN_GLSL=0]="CHANGE_TEXCOORDS_IN_GLSL",t[t.DRAW_IN_CANVAS=1]="DRAW_IN_CANVAS"}(t.ETextureSourceRegionMethod||(t.ETextureSourceRegionMethod={}));t.ETextureSourceRegionMethod}(wd||(wd={}));var wd;!function(t){!function(t){t[t.TEXTURE_2D="TEXTURE_2D"]="TEXTURE_2D",t[t.TEXTURE_CUBE_MAP="TEXTURE_CUBE_MAP"]="TEXTURE_CUBE_MAP"}(t.ETextureTarget||(t.ETextureTarget={}));t.ETextureTarget}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.assetCount=0,this.currentLoadedCount=0,this._assetTable=wdCb.Hash.create()}return e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},e.prototype.load=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=this;if(t.JudgeUtils.isString(e[0])){var o=e[0],i=o;return this._createLoadSingleAssetStream(o,i)}var a=e[0];return wdFrp.fromArray(a).flatMap(function(e){return n._createLoadMultiAssetStream(e.type||t.EAssetType.UNKNOW,e.url,e.id)})},e.prototype.reset=function(){this.assetCount=0,this.currentLoadedCount=0},e.prototype.dispose=function(){this.reset(),t.LoaderFactory.createAllLoader().forEach(function(t){t.dispose()})},e.prototype.get=function(t){var e=this._assetTable.getChild(t);return e?e.get(t):null},e.prototype._createLoadMultiAssetStream=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];var r=t[0],n=t[1],o=t[2],i=this._getLoader(r,n),a=this;return i.has(o)||a.assetCount++,this._addToAssetTable(i.load(n,o).map(function(t){return a.currentLoadedCount++,{currentLoadedCount:a.currentLoadedCount,assetCount:a.assetCount}}),o,i)},e.prototype._createLoadSingleAssetStream=function(e,r){var n=this._getLoader(t.EAssetType.UNKNOW,e);return this._addToAssetTable(n.load(e,r),r,n)},e.prototype._getLoader=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=e[0],o=null;return o=t.JudgeUtils.isArrayExactly(e[1])?wdCb.PathUtils.extname(e[1][0]):wdCb.PathUtils.extname(e[1]),t.LoaderFactory.create(n,o.toLowerCase())},e.prototype._addToAssetTable=function(t,e,r){var n=this;return t["do"](null,null,function(){n._assetTable.addChild(e,r)})},e._instance=null,e}();t.LoaderManager=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.create=function(e,r){var n=null;switch(e){case t.EAssetType.FONT:n=t.FontLoader.getInstance();break;case t.EAssetType.UNKNOW:n=this._getLoaderByExtname(r);break;default:wdCb.Log.error(!0,wdCb.Log.info.FUNC_UNKNOW("asset type:"+e))}return n},e.createAllLoader=function(){return wdCb.Collection.create([t.JsLoader.getInstance(),t.GLSLLoader.getInstance(),t.TextureLoader.getInstance(),t.VideoLoader.getInstance(),t.FontLoader.getInstance(),t.FntLoader.getInstance()])},e._getLoaderByExtname=function(e){var r=null;switch(e){case".json":r=t.JSONLoader.getInstance();break;case".js":r=t.JsLoader.getInstance();break;case".glsl":r=t.GLSLLoader.getInstance();break;case".jpg":case".jpeg":case".png":case".dds":case".gif":case".bmp":r=t.TextureLoader.getInstance();break;case".mp4":case".ogv":case".webm":r=t.VideoLoader.getInstance();break;case".gltf":r=t.GLTFLoader.getInstance();break;case".wd":r=t.WDLoader.getInstance();break;case".eot":case".ttf":case".woff":case".svg":r=t.FontLoader.getInstance();break;case".fnt":r=t.FntLoader.getInstance();break;default:t.Log.error(!0,t.Log.info.FUNC_UNKNOW("extname:"+e))}return r},e}();t.LoaderFactory=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._gltfAssembler=t.GLTFAssembler.create(),this._gltfParser=t.GLTFParser.create(),this._arrayBufferMap=wdCb.Hash.create(),this._imageMap=wdCb.Hash.create()}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.loadAsset=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=e[0],o=this,i=null;return t.AjaxLoader.load(n,"json").flatMap(function(t){return i=t,o._createLoadAllAssetsStream(n,t)}).concat(wdFrp.callFunc(function(){return o._gltfAssembler.build(o._gltfParser.parse(i,o._arrayBufferMap,o._imageMap))}))},r.prototype._createLoadAllAssetsStream=function(t,e){return wdFrp.fromArray([this._createLoadBuffersStream(t,e),this._createLoadImageAssetStream(t,e)]).mergeAll()},r.prototype._createLoadBuffersStream=function(e,r){var n=this._arrayBufferMap;return this._createLoadAssetStream(e,r,r.buffers,n,function(e,r){return t.AjaxLoader.load(r,"arraybuffer")["do"](function(r){t.Log.error(!(r instanceof ArrayBuffer),t.Log.info.FUNC_SHOULD("Buffer:"+e,"be an array buffer")),t.Log.error(r.byteLength!==r.byteLength,t.Log.info.FUNC_SHOULD("Buffer:"+e+"'s length is "+r.byteLength+", but it","be "+r.byteLength)),n.addChild(e,r)})})},r.prototype._createLoadImageAssetStream=function(e,r){var n=this._imageMap;return this._createLoadAssetStream(e,r,r.images,n,function(e,r){return t.ImageLoader.load(r)["do"](function(t){n.addChild(e,t)})})},r.prototype._createLoadAssetStream=function(e,r,n,o,i){var a=[];if(n){var s=null;for(s in n)if(n.hasOwnProperty(s)){var c=n[s];if(t.GLTFUtils.isBase64(c.uri))o.addChild(s,t.GLTFUtils.decodeArrayBuffer(c.uri));else{var u=t.ModelLoaderUtils.getPath(e,c.uri);a.push(i(s,u))}}}return wdFrp.fromArray(a).mergeAll()},r._instance=null,__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],r.prototype,"loadAsset",null),r}(t.Loader);t.GLTFLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._result=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},e.prototype.build=function(t){return this._buildMetadata(t),this._buildModels(t),this._result},e.prototype._buildMetadata=function(t){var e=wdCb.Hash.create();for(var r in t.metadata)t.metadata.hasOwnProperty(r)&&e.addChild(r,t.metadata[r]);this._result.addChild("metadata",e)},e.prototype._buildModels=function(e){var r=wdCb.Collection.create(),n=this,o=function(e){var r=t.GameObject.create();return e.name&&(r.name=e.name),n._isModelContainer(e)&&r.addTag(t.EWDTag.CONTAINER),n._addComponentsFromGLTF(r,e.components),r.addComponent(t.MeshRenderer.create()),e.children&&e.children.forEach(function(t){r.addChild(o(t))}),r};e.objects&&(e.objects.forEach(function(t){r.addChild(o(t))}),this._result.addChild("models",r))},e.prototype._isModelContainer=function(t){return t.isContainer},e.prototype._addComponentsFromGLTF=function(t,e){var r=this;e.forEach(function(e){r._isTransform(e)?t.transform=r._createTransform(e):r._isCamera(e)?t.addComponent(r._createCamera(e)):r._isLight(e)?t.addComponent(r._createLight(e)):r._isGeometry(e)?t.addComponent(r._createGeometry(e)):r._isArticulatedAnimation(e)&&t.addComponent(r._createArticulatedAnimation(e))})},e.prototype._isTransform=function(t){return!!t.matrix||!!t.position},e.prototype._isCamera=function(t){return!!t.camera},e.prototype._isLight=function(t){return!!t.lightColor&&!!t.type},e.prototype._isGeometry=function(t){return!!t.material},e.prototype._isArticulatedAnimation=function(e){return t.GLTFUtils.isIGLTFArticulatedAnimation(e)},e.prototype._createTransform=function(e){var r=t.ThreeDTransform.create();return e.matrix?(r.localPosition=e.matrix.getTranslation(),r.localRotation=e.matrix.getRotation(),r.localScale=e.matrix.getScale()):(r.localPosition=e.position,r.localRotation=e.rotation,r.localScale=e.scale),r},e.prototype._createCamera=function(e){return t.BasicCameraController.create(e.camera)},e.prototype._createLight=function(e){var r=null;switch(e.type){case"ambient":r=t.AmbientLight.create(),r.color=e.lightColor;break;case"directional":r=t.DirectionLight.create(),r.color=e.lightColor;break;case"point":r=t.PointLight.create(),r.color=e.lightColor,t.GLTFUtils.addData(r,"range",e.distance),t.GLTFUtils.addData(r,"constant",e.constantAttenuation),t.GLTFUtils.addData(r,"linear",e.linearAttenuation),t.GLTFUtils.addData(r,"quadratic",e.quadraticAttenuation)}return r},e.prototype._createGeometry=function(e){var r=t.ModelGeometry.create();return r.vertices=e.vertices,r.faces=e.faces,t.GLTFUtils.addData(r,"colors",e.colors),t.GLTFUtils.addData(r,"texCoords",e.texCoords),r.drawMode=e.drawMode,r.material=this._createMaterial(e.material),r},e.prototype._createMaterial=function(e){var r=null;switch(e.type){case"BasicMaterial":r=this._createBasicMaterial(e);break;case"LightMaterial":r=this._createLightMaterial(e);break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("material type:"+e.type))}return r},e.prototype._createBasicMaterial=function(e){var r=t.BasicMaterial.create();return this._setBasicDataOfMaterial(r,e),r},e.prototype._createLightMaterial=function(e){var r=t.LightMaterial.create();return this._setBasicDataOfMaterial(r,e),e.transparent===!0&&void 0!==e.opacity&&(r.opacity=e.opacity,r.blendType=t.EBlendType.NORMAL),e.lightModel===t.ELightModel.LAMBERT?(t.Log.log(t.Log.info.FUNC_NOT_SUPPORT("LAMBERT light model, use PHONG light model instead")),r.lightModel=t.ELightModel.PHONG):r.lightModel=e.lightModel,t.GLTFUtils.addData(r,"color",e.diffuseColor),t.GLTFUtils.addData(r,"specularColor",e.specularColor),t.GLTFUtils.addData(r,"emissionColor",e.emissionColor),t.GLTFUtils.addData(r,"diffuseMap",e.diffuseMap),t.GLTFUtils.addData(r,"specularMap",e.specularMap),t.GLTFUtils.addData(r,"emissionMap",e.emissionMap),t.GLTFUtils.addData(r,"shininess",e.shininess),r},e.prototype._setBasicDataOfMaterial=function(e,r){r.doubleSided&&r.doubleSided===!0?e.side=t.ESide.BOTH:e.side=t.ESide.FRONT},e.prototype._createArticulatedAnimation=function(e){var r=t.ArticulatedAnimation.create();return r.data=wdCb.Hash.create(e),r},e}();t.GLTFAssembler=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this._data={},this._arrayBufferMap=null,this._imageMap=null,this._json=null,this._geometryParser=t.GLTFGeometryParser.create(),this._articulatedAnimationParser=t.GLTFArticulatedAnimationParser.create()}return e.create=function(){var t=new this;return t},e.prototype.parse=function(t,e,r){return this._json=t,this._arrayBufferMap=e,this._imageMap=r,t.asset&&this._parseMetadata(),this._parseObjects(),t.animations&&this._articulatedAnimationParser.parse(t,this._data.objects,this._arrayBufferMap),this._data},e.prototype._parseMetadata=function(){var t={},e=this._json;for(var r in e.asset)e.asset.hasOwnProperty(r)&&(t[r]=e.asset[r]);this._data.metadata=t},e.prototype._parseObjects=function(){var e=this,r=this._json,n=wdCb.Collection.create(),o=function(n,i){var a=t.GLTFUtils.createObjectData();if(a.id=n,i.name&&(a.name=i.name),i.meshes&&i.meshes.length>0){var s=null;i.meshes.length>1&&t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT("multi mesh(geometry), just use the first mesh(geometry)")),s=r.meshes[i.meshes[0]],!i.name&&s.name&&(a.name=s.name),e._geometryParser.parse(r,a,s,e._arrayBufferMap,e._imageMap)}if(i.extensions&&i.extensions.KHR_materials_common&&i.extensions.KHR_materials_common.light&&a.components.addChild(e._parseLight(i.extensions.KHR_materials_common.light)),i.camera&&a.components.addChild(e._parseCamera(i.camera)),i.matrix?a.components.addChild(e._parseTransform(i.matrix)):i.rotation&&i.scale&&i.translation&&a.components.addChild(e._parseTransform(i.translation,i.rotation,i.scale)),i.children)for(var c=0,u=i.children;c<u.length;c++){var l=u[c];a.children.addChild(o(l,r.nodes[l]))}return a};if(!r.scenes[r.scene])return void(this._data.objects=n);for(var i=0,a=r.scenes[r.scene].nodes;i<a.length;i++){var s=a[i];n.addChild(o(s,r.nodes[s]))}this._data.objects=n},e.prototype._parseLight=function(e){var r=this._json.extensions.KHR_materials_common.lights[e],n={};return t.GLTFUtils.addData(n,"type",r.type),this._parseLightDataByType(n,r,n.type),n},e.prototype._parseLightDataByType=function(e,r,n){var o=r[n];switch(n){case"ambient":case"directional":e.lightColor=t.GLTFUtils.getColor(o.color);break;case"point":e.lightColor=t.GLTFUtils.getColor(o.color),t.GLTFUtils.addData(e,"distance",o.distance),t.GLTFUtils.addData(e,"constantAttenuation",o.constantAttenuation),t.GLTFUtils.addData(e,"linearAttenuation",o.linearAttenuation),t.GLTFUtils.addData(e,"quadraticAttenuation",o.quadraticAttenuation)}},e.prototype._parseCamera=function(t){var e=this._json.cameras[t],r={};return this._parseCameraDataByType(r,e),r},e.prototype._parseCameraDataByType=function(e,r){var n=null,o=r.type,i=r[o];switch(o){case"perspective":if(i=r[o],n=t.PerspectiveCamera.create(),n.near=i.znear,n.far=i.zfar,i.aspectRatio)n.aspect=i.aspectRatio;else{var a=t.DeviceManager.getInstance().view;n.aspect=a.width/a.height}n.fovy=i.yfov,e.camera=n;break;case"orthographic":n=t.OrthographicCamera.create(),n.near=i.znear,n.far=i.zfar,n.left=-i.xmag,n.right=i.xmag,n.top=i.ymag,n.bottom=-i.ymag,e.camera=n;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("camera type:"+o))}},e.prototype._parseTransform=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n={};if(1===e.length){var o=e[0];n.matrix=t.Matrix4.create(new Float32Array(o))}else if(3===e.length){var i=e[0],a=e[1],s=e[2];n.position=t.Vector3.create(i[0],i[1],i[2]),n.rotation=t.Quaternion.create(a[0],a[1],a[2],a[3]),n.scale=t.Vector3.create(s[0],s[1],s[2])}return n},__decorate([t.require(function(e){var r=this._json.extensions.KHR_materials_common.lights;t.assert(r&&r[e],t.Log.info.FUNC_NOT_EXIST("lightId:"+e))})],e.prototype,"_parseLight",null),__decorate([t.require(function(e){var r=this._json.cameras;t.assert(r&&r[e],t.Log.info.FUNC_NOT_EXIST("cameraId:"+e))})],e.prototype,"_parseCamera",null),e}();t.GLTFParser=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this._arrayBufferMap=null,this._imageMap=null,this._json=null,this._materialParser=t.GLTFMaterialParser.create()}return e.create=function(){var t=new this;return t},e.prototype.parse=function(e,r,n,o,i){if(this._json=e,this._arrayBufferMap=o,this._imageMap=i,n.primitives.length>1){for(var a=0,s=n.primitives;a<s.length;a++){var c=s[a],u=t.GLTFUtils.createObjectData();this._setChildObjectNameWithMultiPrimitives(u,c),u.components.addChild(this._parseGeometry(c)),r.children.addChild(u)}r.isContainer=!0}else 1===n.primitives.length&&r.components.addChild(this._parseGeometry(n.primitives[0]))},e.prototype._setChildObjectNameWithMultiPrimitives=function(t,e){t.name=e.material},e.prototype._parseGeometry=function(e){var r=this._json,n=this._arrayBufferMap,o=null,i=null,a={},s=null,c=null,u=null,l=null,h=null;for(var p in e.attributes)if(e.attributes.hasOwnProperty(p)){var f=e.attributes[p];if(o=r.accessors[f],i=t.GLTFUtils.getBufferArrFromAccessor(r,o,n),"POSITION"===p)s=[],this._addGeometryData(s,i);else if(p.indexOf("TEXCOORD_")>-1)c=[],this._addGeometryData(c,i),this._normalizeTexCoords(c);else if("NORMAL"===p){l=[];for(var d=0,_=i;d<_.length;d++){var y=_[d];l.push(y)}}else"COLOR"===p&&(u=[],this._addGeometryData(u,i))}return h=this._getFaces(r,e.indices,l),t.GLTFUtils.addData(a,"vertices",s),t.GLTFUtils.addData(a,"colors",u),t.GLTFUtils.addData(a,"texCoords",c),t.GLTFUtils.addData(a,"faces",h),t.GLTFUtils.addData(a,"drawMode",this._parseDrawMode(e.mode)),a.material=this._materialParser.parse(r,e.material,this._imageMap),a},e.prototype._addGeometryData=function(t,e){for(var r=0,n=e.length;n>r;r++)t.push(e[r])},e.prototype._getFaces=function(e,r,n){var o=null,i=null,a=null,s=[];if(!r)return[];o=e.accessors[r],i=t.GLTFUtils.getBufferArrFromAccessor(e,o,this._arrayBufferMap);for(var c=0,u=i.length;u>c;c+=3){var l=i[c],h=i[c+1],p=i[c+2],f=[l,h,p];a=t.Face3.create(l,h,p),t.GeometryUtils.hasData(n)&&this._addNormalData(a.vertexNormals,n,f),s.push(a)}return s},e.prototype._addNormalData=function(t,e,r){var n=r[0],o=r[1],i=r[2];t.addChildren([this._getThreeComponentData(e,n),this._getThreeComponentData(e,o),this._getThreeComponentData(e,i)])},e.prototype._getThreeComponentData=function(e,r){var n=3*r;return t.Vector3.create(e[n],e[n+1],e[n+2])},e.prototype._parseDrawMode=function(e){var r=null;if(!e)return null;switch(e){case 0:r=t.EDrawMode.POINTS;break;case 1:r=t.EDrawMode.LINES;break;case 2:r=t.EDrawMode.LINE_LOOP;break;case 3:r=t.EDrawMode.LINE_STRIP;break;case 4:r=t.EDrawMode.TRIANGLES;break;case 5:r=t.EDrawMode.TRIANGLE_STRIP;break;case 6:r=t.EDrawMode.TRANGLE_FAN;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("mode:"+e))}return r},e.prototype._normalizeTexCoords=function(t){if(t)for(var e=0,r=t.length/2;r>e;e++)t[2*e+1]=1-t[2*e+1]},__decorate([t.require(function(e,r,n){var o=null,i=null;return r?(o=e.accessors[r],i=t.GLTFUtils.getBufferArrFromAccessor(e,o,this._arrayBufferMap),void t.assert(i.length%3===0,t.Log.info.FUNC_SHOULD("indices' count","3 times"))):[]})],e.prototype,"_getFaces",null),e}();t.GLTFGeometryParser=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this._imageMap=null,this._json=null}return e.create=function(){var t=new this;return t},e.prototype.parse=function(e,r,n){var o=null,i=null;if(this._json=e,this._imageMap=n,!this._isUseKHRMaterialExtension()){t.Log.log("no KHR_materials_common extension found, will use default material instead");var a={type:"BasicMaterial",doubleSided:!1};return a}var s={};return o=e.materials[r],t.Log.error(!o.extensions||!o.extensions.KHR_materials_common,t.Log.info.FUNC_SHOULD("materials","define KHR_materials_common extensions")),i=o.extensions.KHR_materials_common,t.GLTFUtils.addData(s,"doubleSided",i.doubleSided),t.GLTFUtils.addData(s,"transparent",Boolean(i.transparent)),s.type=this._getMaterialType(i.technique),s.lightModel=this._getLightModel(i.technique),this._addMaterialExtensionValues(s,i.values),s},e.prototype._isUseKHRMaterialExtension=function(){var t=this._json.extensionsUsed;return t?t.indexOf("KHR_materials_common")>-1:!1},e.prototype._getMaterialType=function(e){var r=null;switch(e){case"PHONG":case"BLINN":case"CONSTANT":case"LAMBERT":r="LightMaterial";break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("technique:"+e))}return r},e.prototype._getLightModel=function(e){var r=null;switch(e){case"PHONG":r=t.ELightModel.PHONG;break;case"BLINN":r=t.ELightModel.BLINN;break;case"CONSTANT":r=t.ELightModel.CONSTANT;break;case"LAMBERT":r=t.ELightModel.LAMBERT;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("technique:"+e))}return r},e.prototype._addMaterialExtensionValues=function(e,r){r&&(r.ambient&&t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT("ambient of material")),this._addMaterialLightColor(e,"diffuse",r.diffuse),this._addMaterialLightColor(e,"specular",r.specular),this._addMaterialLightColor(e,"emission",r.emission),r.shininess&&(e.shininess=r.shininess.value),r.transparency&&(e.opacity=r.transparency.value))},e.prototype._addMaterialLightColor=function(e,r,n){n&&(t.JudgeUtils.isArrayExactly(n)?e[r+"Color"]=t.GLTFUtils.getColor(n):this._isColor(n.type)?e[r+"Color"]=t.GLTFUtils.getColor(n.value):e[r+"Map"]=this._getTexture(n.value))},e.prototype._isColor=function(t){return 35666===Number(t)},e.prototype._getTexture=function(e){var r=null,n=null;return this._json.textures&&this._json.textures[e]?(r=this._json.textures[e],n=this._createTextureAsset(r.target,r.source),r.internalFormat!==r.format&&t.Log.warn("texture.internalFormat("+r.internalFormat+") !== texture.format("+r.format+"), here take texture.format value as their value"),r.format&&(n.format=this._getTextureFormat(r.format)),r.type&&(n.type=this._getTextureType(r.type)),this._addTextureSampler(n,r.sampler),n.toTexture()):null},e.prototype._createTextureAsset=function(e,r){var n=null,o=this._imageMap.getChild(r);switch(o||t.Log.warn("no image found in loader(id:"+r+")"),e){case 3553:n=t.ImageTextureAsset.create(o);break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("target except TEXTURE_2D"))}return n},e.prototype._getTextureType=function(e){var r=null;switch(e){case 5121:r=t.ETextureType.UNSIGNED_BYTE;break;case 33635:r=t.ETextureType.UNSIGNED_SHORT_5_6_5;break;case 32819:r=t.ETextureType.UNSIGNED_SHORT_4_4_4_4;break;case 32820:r=t.ETextureType.UNSIGNED_SHORT_5_5_5_1;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("texture->type:"+e))}return r},e.prototype._getTextureFormat=function(e){var r=null;switch(e){case 6406:r=t.ETextureFormat.ALPHA;break;case 6407:r=t.ETextureFormat.RGB;break;case 6408:r=t.ETextureFormat.RGBA;break;case 6409:r=t.ETextureFormat.LUMINANCE;break;case 6410:r=t.ETextureFormat.LUMINANCE_ALPHA;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("texture->format:"+e))}return r},e.prototype._addTextureSampler=function(t,e){var r=this._json.samplers[e];t.wrapT=this._getTextureWrap(r.wrapT),t.wrapS=this._getTextureWrap(r.wrapS),t.minFilter=this._getTextureFilter(r.minFilter),t.magFilter=this._getTextureFilter(r.magFilter)},e.prototype._getTextureFilter=function(e){var r=null;switch(e){case 9728:r=t.ETextureFilterMode.NEAREST;break;case 9729:r=t.ETextureFilterMode.LINEAR;break;case 9984:r=t.ETextureFilterMode.NEAREST_MIPMAP_MEAREST;break;case 9985:r=t.ETextureFilterMode.LINEAR_MIPMAP_NEAREST;break;case 9986:r=t.ETextureFilterMode.NEAREST_MIPMAP_LINEAR;break;case 9987:r=t.ETextureFilterMode.LINEAR_MIPMAP_LINEAR;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("texture filter:"+e))}return r},e.prototype._getTextureWrap=function(e){var r=null;switch(e){case 33071:r=t.ETextureWrapMode.CLAMP_TO_EDGE;break;case 33648:r=t.ETextureWrapMode.MIRRORED_REPEAT;break;case 10497:r=t.ETextureWrapMode.REPEAT;break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("texture wrap:"+e))}return r},__decorate([t.require(function(e,r){t.assert(!!this._json.samplers[r],t.Log.info.FUNC_NOT_EXIST("samplerId:"+r))})],e.prototype,"_addTextureSampler",null),e}();t.GLTFMaterialParser=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this._arrayBufferMap=null,this._json=null,this._translationArrayOffset=null,this._rotationArrayOffset=null,this._scaleArrayOffset=null}return e.create=function(){var t=new this;return t},e.prototype.parse=function(e,r,n){var o=this,i=wdCb.Hash.create(),a=this;this._json=e,this._arrayBufferMap=n;var s=function(s){if(e.animations.hasOwnProperty(s)){for(var c=e.animations[s],u=wdCb.Hash.create(),l=0,h=c.channels.length;h>l;l++){var p=c.channels[l],f=p.target.id;u.appendChild(f,p)}u.forEach(function(u,l){var h=wdCb.Collection.create(),p=a._findNode(r,l),f=null,d=null;if(null===p)return void t.Log.warn("can't find node whose id is "+l+" to attach to animation named "+s);a._addAnimationToNode(i,l,p,a._getAnimName(c,s),h),f=a._getInputData(c,u),d=t.GLTFUtils.getBufferArrFromAccessor(e,e.accessors[f],n),o._translationArrayOffset=0,o._rotationArrayOffset=0,o._scaleArrayOffset=0;for(var _=0;_<d.length;_++){var y={};y.time=o._convertSecondToMillisecond(d[_]),y.targets=o._getKeyFrameDataTargets(c,u),h.addChild(y)}})}};for(var c in e.animations)s(c);this._addAnimationComponent(i)},e.prototype._getAnimName=function(t,e){return t.name?t.name:e},e.prototype._getInputData=function(t,e){var r=null;return e.forEach(function(e){var n=t.samplers[e.sampler];return n?(r=t.parameters[n.input],wdCb.$BREAK):void 0}),r},e.prototype._addAnimationToNode=function(t,e,r,n,o){t.hasChild(e)||t.addChild(e,{node:r,animationData:{}}),t.getChild(e).animationData[n]=o},e.prototype._getKeyFrameDataTargets=function(e,r){var n=this,o=wdCb.Collection.create();return r.forEach(function(r){var i=e.samplers[r.sampler],a=null,s=null,c=null,u={};if(i){switch(c=r.target.path,a=e.parameters[i.output],s=t.GLTFUtils.getBufferArrFromAccessor(n._json,n._json.accessors[a],n._arrayBufferMap),u.interpolationMethod=n._convertTointerpolationMethod(i.interpolation),c){case"translation":u.target=t.EArticulatedAnimationTarget.TRANSLATION,u.data=t.Vector3.create(s[n._translationArrayOffset],s[n._translationArrayOffset+1],s[n._translationArrayOffset+2]),n._translationArrayOffset+=3;break;case"rotation":u.target=t.EArticulatedAnimationTarget.ROTATION,u.data=t.Quaternion.create(s[n._rotationArrayOffset],s[n._rotationArrayOffset+1],s[n._rotationArrayOffset+2],s[n._rotationArrayOffset+3]),n._rotationArrayOffset+=4;break;case"scale":u.target=t.EArticulatedAnimationTarget.SCALE,u.data=t.Vector3.create(s[n._scaleArrayOffset],s[n._scaleArrayOffset+1],s[n._scaleArrayOffset+2]),n._scaleArrayOffset+=3;break;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("path:"+c))}o.addChild(u)}}),o},e.prototype._findNode=function(t,e){var r=function(t){var n=t.findOne(function(t){return t.id===e});return n?n:(t.forEach(function(t){return n=r(t.children),n?wdCb.$BREAK:void 0}),n)};return r(t)},e.prototype._addAnimationComponent=function(t){t.forEach(function(t){var e=t.node,r=t.animationData;e.components.addChild(r)})},e.prototype._convertSecondToMillisecond=function(t){return 1e3*t},e.prototype._convertTointerpolationMethod=function(e){switch(e){case"LINEAR":return t.EKeyFrameInterpolation.LINEAR;default:t.Log.error(!0,t.Log.info.FUNC_NOT_SUPPORT("interpolation:"+e))}},__decorate([t.require(function(e,r){var n=wdCb.Collection.create();for(var o in e.samplers)if(e.samplers.hasOwnProperty(o)){var i=e.samplers[o];n.addChild(i.input)}t.assert(1===n.removeRepeatItems().getCount(),t.Log.info.FUNC_SHOULD("all sampler->input","be the same"))})],e.prototype,"_getInputData",null),__decorate([t.ensure(function(e,r){r.forEach(function(e){var r=e.node;e.animationData;t.assert(r.components.filter(function(e){return t.GLTFUtils.isIGLTFArticulatedAnimation(e)}).getCount()<=1,t.Log.info.FUNC_SHOULD("node","only has 1 IGLTFArticulatedAnimation component"))})})],e.prototype,"_addAnimationComponent",null),e}();t.GLTFArticulatedAnimationParser=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.addData=function(t,e,r){void 0!==r&&null!==r&&(t[e]=r)},e.isBase64=function(t){return t.length<5?!1:"data:"===t.substr(0,5)},e.decodeArrayBuffer=function(t){for(var e=t.split(",")[1],r=atob(e),n=r.length,o=new Uint8Array(new ArrayBuffer(n)),i=0;n>i;i++)o[i]=r.charCodeAt(i);return o.buffer},e.createObjectData=function(){return{id:null,isContainer:!1,components:wdCb.Collection.create(),children:wdCb.Collection.create()}},e.getColor=function(e){var r=t.Color.create();return r.r=Number(e[0]),r.g=Number(e[1]),r.b=Number(e[2]),4===e.length&&(r.a=Number(e[3])),r},e.getBufferArrFromAccessor=function(e,r,n){var o=e.bufferViews[r.bufferView],i=n.getChild(o.buffer),a=r.byteOffset+o.byteOffset,s=r.count*this.getAccessorTypeSize(r);switch(r.componentType){case 5120:return new Int8Array(i,a,s);case 5121:return new Uint8Array(i,a,s);case 5122:return new Int16Array(i,a,s);case 5123:return new Uint16Array(i,a,s);case 5126:return new Float32Array(i,a,s);default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("componentType:"+r.componentType))}},e.getAccessorTypeSize=function(t){var e=t.type;switch(e){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}},e.isIGLTFArticulatedAnimation=function(e){if(!t.JudgeUtils.isDirectObject(e))return!1;for(var r in e)return e[r]instanceof wdCb.Collection&&e[r].getCount()>0&&void 0!==e[r].getChild(0).time},e}();t.GLTFUtils=e}(wd||(wd={}));var wd;!function(t){!function(t){t[t.CONTAINER="CONTAINER"]="CONTAINER"}(t.EWDTag||(t.EWDTag={}));t.EWDTag}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._wdParser=t.WDParser.create(),this._wdBuilder=t.WDBuilder.create(),this._parseData=null}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.loadAsset=function(){for(var e=this,r=[],n=0;n<arguments.length;n++)r[n-0]=arguments[n];var o=r[0],i=this;return t.AjaxLoader.load(o,"json").flatMap(function(t){return i._parseData=i._wdParser.parse(t),e._createLoadMapStream(o)}).concat(wdFrp.callFunc(function(){return i._wdBuilder.build(i._parseData)}))},r.prototype._createLoadMapStream=function(e){var r=[],n=this._parseData;return n.materials.forEach(function(n){var o=[];n.diffuseMapUrl&&o.push(["diffuseMap",n.diffuseMapUrl]),n.specularMapUrl&&o.push(["specularMap",n.specularMapUrl]),
n.normalMapUrl&&o.push(["normalMap",n.normalMapUrl]),r.push(wdFrp.fromArray(o).flatMap(function(r){var o=r[0],i=r[1];return t.TextureLoader.getInstance().load(t.ModelLoaderUtils.getPath(e,i))["do"](function(t){n[o]=t.toTexture()},null,null)}))}),wdFrp.fromArray(r).mergeAll()},r._instance=null,__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],r.prototype,"loadAsset",null),r}(t.Loader);t.WDLoader=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._data={},this._objectParser=t.WDObjectParser.create()}return e.create=function(){var t=new this;return t},e.prototype.parse=function(t){return this._parseMetadata(t),this._parseScene(t),this._parseMaterial(t),this._parseObject(t),this._data},e.prototype._parseMetadata=function(t){this._data.metadata=t.metadata},e.prototype._parseObject=function(t){this._objectParser.parse(this._data,t)},e.prototype._parseScene=function(t){this._data.scene=t.scene,t.scene.ambientColor&&(this._data.scene.ambientColor=this._createColor(t.scene.ambientColor))},e.prototype._parseMaterial=function(t){var e=this;this._data.materials=wdCb.Hash.create(t.materials),this._data.materials.forEach(function(t){t.diffuseColor&&(t.diffuseColor=e._createColor(t.diffuseColor)),t.specularColor&&(t.specularColor=e._createColor(t.specularColor))})},e.prototype._createColor=function(e){return t.Color.create("rgb("+e.join(",").replace(/^(\d+),/g,"$1.0,").replace(/,(\d+),/g,",$1.0,").replace(/,(\d+)$/g,",$1.0")+")")},e}();t.WDParser=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){}return e.create=function(){var t=new this;return t},e.prototype.parse=function(t,e){var r=null,n=this;t.objects=wdCb.Collection.create(e.objects),r=function(t){n._isObjectContainer(t)?t.isContainer=!0:(t.isContainer=!1,n._parseFromIndices(t)),t.children&&(t.children=wdCb.Collection.create(t.children),t.children.forEach(function(e){e.parent=t,r(e)}))},t.objects.forEach(function(t){t.parent=null,r(t),n._removeObjectContainerData(t)})},e.prototype._isObjectContainer=function(e){return!t.GeometryUtils.hasData(e.verticeIndices)},e.prototype._parseFromIndices=function(t){this._duplicateVertexWithDifferentUvs(t),this._parseObjectFromIndices(t),this._removeRebundantIndiceData(t)},e.prototype._duplicateVertexWithDifferentUvs=function(e){var r=[],n=wdCb.Hash.create(),o=e.verticeIndices,i=e.uvIndices;if(t.GeometryUtils.hasData(i))for(var a=0,s=o.length;s>a;a++){var c=o[a];this._isSameVertexWithDifferentUvsByCompareToFirstOne(r,i[a],c)&&(this._isUvIndiceEqualTheOneOfAddedVertex(n,c,i[a])?o[a]=this._getVerticeIndexOfAddedVertexByFindContainer(n,c,i[a]):this._addVertexData(e,n,c,a),c=o[a]),r[c]=i[a]}},e.prototype._isSameVertexWithDifferentUvsByCompareToFirstOne=function(t,e,r){return void 0!==t[r]&&t[r]!==e},e.prototype._addVertexData=function(e,r,n,o){var i=e.verticeIndices,a=e.uvIndices,s=e.normalIndices,c=this._findData(e,"vertices"),u=this._findData(e,"normals"),l=this._findData(e,"morphTargets"),h=null;if(this._addThreeComponent(c,n),h=this._getVerticeIndexOfAddedVertex(c),i[o]=h,t.GeometryUtils.hasData(l))for(var p=0,f=l;p<f.length;p++){var d=f[p];this._addThreeComponent(d.vertices,n),t.GeometryUtils.hasData(d.normals)&&this._addDuplicateNormalOfAddedVertex(d.normals,s,o,n)}t.GeometryUtils.hasData(u)&&(this._addDuplicateNormalOfAddedVertex(u,s,o,n),t.GeometryUtils.hasData(s)&&(s[o]=h)),r.appendChild(String(n),[a[o],h])},e.prototype._addDuplicateNormalOfAddedVertex=function(e,r,n,o){return t.GeometryUtils.hasData(r)?void this._addThreeComponent(e,e,r[n]):void this._addThreeComponent(e,e,o)},e.prototype._isUvIndiceEqualTheOneOfAddedVertex=function(t,e,r){var n=t.getChild(String(e));return n?n.hasChildWithFunc(function(t){var e=t[0];t[1];return e===r}):!1},e.prototype._getVerticeIndexOfAddedVertexByFindContainer=function(t,e,r){var n=t.getChild(String(e));return n.findOne(function(t){var e=t[0];t[1];return e===r})[1]},e.prototype._getVerticeIndexOfAddedVertex=function(t){return t.length/3-1},e.prototype._addThreeComponent=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(2===t.length){var r=t[0],n=t[1];r.push(r[3*n],r[3*n+1],r[3*n+2])}else{var o=t[0],i=t[1],n=t[2];o.push(i[3*n],i[3*n+1],i[3*n+2])}},e.prototype._parseObjectFromIndices=function(e){for(var r=[],n=[],o=null,i=this._findData(e,"vertices"),a=this._findData(e,"uvs"),s=this._findData(e,"normals"),c=this._findData(e,"colors"),u=0,l=e.verticeIndices.length;l>u;u+=3){var h=e.verticeIndices[u],p=e.verticeIndices[u+1],f=e.verticeIndices[u+2],d=[u,u+1,u+2],_=[h,p,f];o=t.Face3.create(h,p,f),t.GeometryUtils.hasData(e.uvIndices)&&t.GeometryUtils.hasData(a)&&this._setUV(r,a,e.uvIndices,d,_),t.GeometryUtils.hasData(s)&&this._setNormal(o.vertexNormals,s,e.normalIndices,d,_),n.push(o)}e.vertices=i,t.GeometryUtils.hasData(e.uvIndices)?e.uvs=r:e.uvs=a,e.colors=c,e.faces=n,this._setMorphTargets(e,e.verticeIndices,e.normalIndices)},e.prototype._getAnimName=function(t){var e=/([a-z]+)_?(\d+)/,r="default",n=t.match(e);return n&&n.length>1?n[1]:r},e.prototype._removeRebundantIndiceData=function(t){delete t.verticeIndices,delete t.uvIndices,delete t.normalIndices},e.prototype._removeObjectContainerData=function(t){var e=null;(e=function(t){t.isContainer&&(delete t.vertices,delete t.uvs,delete t.colors),t.children&&t.children.forEach(function(t){e(t)})})(t)},e.prototype._findData=function(t,e){var r=null;do r=t[e];while(!r&&null!==(t=t.parent));return r},e.prototype._setUV=function(t,e,r,n,o){var i=null,a=null,s=null,c=n[0],u=n[1],l=n[2],h=o[0],p=o[1],f=o[2];i=r[c],a=r[u],s=r[l],this._setTwoComponentData(t,e,h,i),this._setTwoComponentData(t,e,p,a),this._setTwoComponentData(t,e,f,s)},e.prototype._setTwoComponentData=function(t,e,r,n){t[2*r]=e[2*n],t[2*r+1]=e[2*n+1]},e.prototype._setThreeComponentData=function(t,e,r,n){t[3*r]=e[3*n],t[3*r+1]=e[3*n+1],t[3*r+2]=e[3*n+2]},e.prototype._getThreeComponentData=function(e,r){var n=3*r;return t.Vector3.create(e[n],e[n+1],e[n+2])},e.prototype._setNormal=function(e,r,n,o,i){var a=o[0],s=o[1],c=o[2];return t.GeometryUtils.hasData(n)?void this._addNormalData(e,r,[n[a],n[s],n[c]]):void this._addNormalData(e,r,i)},e.prototype._addNormalData=function(t,e,r){var n=r[0],o=r[1],i=r[2];if(t instanceof wdCb.Collection)t.addChildren([this._getThreeComponentData(e,n),this._getThreeComponentData(e,o),this._getThreeComponentData(e,i)]);else for(var a=t,s=0,c=[this._getThreeComponentData(e,n),this._getThreeComponentData(e,o),this._getThreeComponentData(e,i)];s<c.length;s++){var u=c[s];a.push(u.x,u.y,u.z)}},e.prototype._setMorphTargets=function(e,r,n){var o=this._findData(e,"morphTargets"),i=null,a=null;if(t.GeometryUtils.hasData(o)){i=wdCb.Hash.create(),a=wdCb.Hash.create();for(var s=0,c=o;s<c.length;s++){var u=c[s],l=this._getAnimName(u.name);if(i.appendChild(l,u.vertices),t.GeometryUtils.hasData(u.normals))if(t.GeometryUtils.hasData(n)){for(var h=[],p=0,f=r.length;f>p;p++)this._setThreeComponentData(h,u.normals,r[p],n[p]);a.appendChild(l,h)}else a.appendChild(l,u.normals)}}e.morphTargets=i,e.morphNormals=a},__decorate([t.require(function(e,r,n){t.assert(this._isUvIndiceEqualTheOneOfAddedVertex(e,r,n),t.Log.info.FUNC_SHOULD("uvIndex","equal the one of added vertex"))})],e.prototype,"_getVerticeIndexOfAddedVertexByFindContainer",null),__decorate([t.ensure(function(e,r){t.assert(!r.verticeIndices,t.Log.info.FUNC_SHOULD("object.verticeIndices","be removed")),t.assert(!r.uvIndices,t.Log.info.FUNC_SHOULD("object.uvIndices","be removed")),t.assert(!r.normalIndices,t.Log.info.FUNC_SHOULD("object.normalIndices","be removed"))})],e.prototype,"_removeRebundantIndiceData",null),e}();t.WDObjectParser=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this._result=wdCb.Hash.create()}return e.create=function(){var t=new this;return t},e.prototype.build=function(t){return this._buildMetadata(t),this._buildScene(t),this._buildModels(t),this._result},e.prototype._buildMetadata=function(t){var e=wdCb.Hash.create();for(var r in t.metadata)t.metadata.hasOwnProperty(r)&&e.addChild(r,t.metadata[r]);this._result.addChild("metadata",e)},e.prototype._buildScene=function(t){var e=wdCb.Hash.create();t.scene.ambientColor&&e.addChild("ambientColor",t.scene.ambientColor),this._result.addChild("scene",e)},e.prototype._buildModels=function(e){var r=wdCb.Collection.create(),n=this,o=null;o=function(r,i){r.forEach(function(r){var a=null,s=null;s=t.GameObject.create(),n._isModelContainer(r)?s.addTag(t.EWDTag.CONTAINER):(a=t.ModelGeometry.create(),a.vertices=r.vertices,a.faces=r.faces,a.texCoords=r.uvs,a.colors=r.colors,r.material&&(a.material=n._buildMaterial(r.material,e.materials)),a.morphTargets=r.morphTargets,a.morphFaceNormals=r.morphNormals,a.morphVertexNormals=r.morphNormals,t.GeometryUtils.hasData(a.morphTargets)&&s.addComponent(t.MorphAnimation.create()),s.addComponent(a)),s.name=r.name,s.addComponent(t.MeshRenderer.create()),i.addChild(s),r.children&&o(r.children,s)})},o(e.objects,r),this._result.addChild("models",r)},e.prototype._isModelContainer=function(t){return t.isContainer},e.prototype._buildMaterial=function(e,r){var n="LightMaterial",o=null,i=null,a=null;return s=r.findOne(function(t,r){return r===e}),o=s[1],i=o.type||n,wdCb.Log.error(!t[i],wdCb.Log.info.FUNC_NOT_EXIST("materialClass:"+i)),a=t[i].create(),a.name=e,o.diffuseColor&&(a.color=o.diffuseColor),o.specularColor&&(a.specularColor=o.specularColor),o.diffuseMap&&(a.diffuseMap=o.diffuseMap),o.specularMap&&(a.specularMap=o.specularMap),o.normalMap&&(a.normalMap=o.normalMap),null!==o.shininess&&(a.shininess=o.shininess),null!==o.opacity&&(a.opacity=o.opacity),a;var s},e}();t.WDBuilder=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e={".eot":"embedded-opentype",".ttf":"truetype",".woff":"woff",".svg":"svg"},r=function(r){function n(){r.apply(this,arguments),this._familyName=null}return __extends(n,r),n.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},n.prototype.dispose=function(){r.prototype.dispose.call(this),wdCb.DomQuery.create("#"+this._familyName).remove()},n.prototype.loadAsset=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=e[1],o=this;return this._familyName=n,wdFrp.fromPromise(new RSVP.Promise(function(r,i){o._addStyleElement(e,n),document.fonts?document.fonts.load("1em "+n).then(function(){r()},function(t){i(t)}):(t.Log.warn("your browser not support document.fonts api, so it can't ensure that the font is loaded"),r())}))},n.prototype._getType=function(t){return e[wdCb.PathUtils.extname(t).toLowerCase()]},n.prototype._addStyleElement=function(e,r){var n=wdCb.DomQuery.create('<style id="'+r+'"></style>'),o=null;if(n.prependTo("body"),o="@font-face { font-family:"+r+"; src:",t.JudgeUtils.isArrayExactly(e[0])){for(var i=e[0],a=0,s=i;a<s.length;a++){var c=s[a];o+="url('"+c+"') format('"+this._getType(c)+"'),"}o=o.replace(/,$/,";")}else{var c=e[0];o+="url('"+c+"') format('"+this._getType(c)+"');"}n.get(0).textContent+=o+"};"},n._instance=null,__decorate([t.require(function(r){var n=wdCb.PathUtils.extname(r).toLowerCase();t.assert(!!e[n],t.Log.info.FUNC_UNKNOW("type:"+n))})],n.prototype,"_getType",null),n}(t.Loader);t.FontLoader=r}(wd||(wd={}));var wd;!function(t){var e=/common [^\n]*(\n|$)/gi,r=/page [^\n]*(\n|$)/gi,n=/char [^\n]*(\n|$)/gi,o=/\w+=[^ \r\n]+/gi,i=/^[\-]?\d+$/,a=function(){function a(){}return a.create=function(){var t=new this;return t},a.prototype.parseFnt=function(n,o){var i={},a=null,s=null;return a=this._parseStrToObj(n.match(e)[0]),i.commonHeight=a.lineHeight,1!==a.pages&&t.Log.log("only supports 1 page"),s=this._parseStrToObj(n.match(r)[0]),0!==s.id&&t.Log.log("file could not be found"),i.atlasName=wdCb.PathUtils.changeBasename(o,s.file),this._parseChar(n,i),i},a.prototype._parseStrToObj=function(t){var e=t.match(o),r={};if(e)for(var n=0,a=e;n<a.length;n++){var s=a[n],c=s.indexOf("="),u=s.substring(0,c),l=s.substring(c+1);l.match(i)?l=parseInt(l):'"'==l[0]&&(l=l.substring(1,l.length-1)),r[u]=l}return r},a.prototype._parseChar=function(t,e){for(var r=t.match(n),o={},i=0,a=r;i<a.length;i++){var s=a[i],c=this._parseStrToObj(s),u=c.id;o[u]={rect:{x:c.x,y:c.y,width:c.width,height:c.height},xOffset:c.xoffset,yOffset:c.yoffset,xAdvance:c.xadvance}}e.fontDefDictionary=o},a}();t.FntParser=a}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._parser=t.FntParser.create()}return __extends(r,e),r.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},r.prototype.loadAsset=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=e[0],o=this;return t.AjaxLoader.load(n,"text").map(function(t){return o._parser.parseFnt(t,n)})},r._instance=null,__decorate([t.require(function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];t.assert(!t.JudgeUtils.isArrayExactly(e[0]),t.Log.info.FUNC_MUST_BE("url","string"))})],r.prototype,"loadAsset",null),r}(t.Loader);t.FntLoader=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this.view=null,this.gl=null,this.viewport=t.RectRegion.create(),this._scissorTest=null,this._depthTest=null,this._depthFunc=null,this._side=null,this.polygonOffset=null,this._polygonOffsetMode=null,this._depthWrite=null,this._blend=null,this._writeRed=null,this._writeGreen=null,this._writeBlue=null,this._writeAlpha=null,this._blendSrc=null,this._blendDst=null,this._blendEquation=null,this._blendFuncSeparate=null,this._blendEquationSeparate=null}return e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},Object.defineProperty(e.prototype,"scissorTest",{get:function(){return this._scissorTest},set:function(t){var e=this.gl;t?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),this._scissorTest=t},enumerable:!0,configurable:!0}),e.prototype.setScissor=function(t,e,r,n){this.gl.scissor(t,e,r,n),this.scissorTest||(this.scissorTest=!0)},e.prototype.setViewport=function(t,e,r,n){this.viewport.set(t,e,r,n),this.gl.viewport(t,e,r,n)},Object.defineProperty(e.prototype,"depthTest",{get:function(){return this._depthTest},set:function(t){var e=this.gl;this._depthTest!==t&&(t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._depthTest=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(t){var e=this.gl;this._depthFunc!==t&&(e.depthFunc(e[t]),this._depthFunc=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"side",{get:function(){return this._side},set:function(e){var n=this.gl;if(this._side!==e){switch(e){case r.NONE:n.enable(n.CULL_FACE),n.cullFace(n.FRONT_AND_BACK);break;case r.BOTH:n.disable(n.CULL_FACE);break;case r.FRONT:n.enable(n.CULL_FACE),n.cullFace(n.BACK);break;case r.BACK:n.enable(n.CULL_FACE),n.cullFace(n.FRONT);break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("side",e))}this._side=e}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"polygonOffsetMode",{get:function(){return this._polygonOffsetMode},set:function(e){var r=this.gl;if(this._polygonOffsetMode!==e){switch(e){case n.NONE:r.polygonOffset(0,0),r.disable(r.POLYGON_OFFSET_FILL);break;case n.IN:r.enable(r.POLYGON_OFFSET_FILL),r.polygonOffset(1,1);break;case n.OUT:r.enable(r.POLYGON_OFFSET_FILL),r.polygonOffset(-1,-1);break;case n.CUSTOM:r.enable(r.POLYGON_OFFSET_FILL),t.Log.error(!this.polygonOffset,t.Log.info.FUNC_MUST_DEFINE("polygonOffset")),r.polygonOffset(this.polygonOffset.x,this.polygonOffset.y)}this._polygonOffsetMode=e}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthWrite",{get:function(){return this._depthWrite},set:function(t){this._depthWrite!==t&&(this.gl.depthMask(t),this._depthWrite=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blend",{get:function(){return this._blend},set:function(t){var e=this.gl;this._blend!==t&&(t?e.enable(e.BLEND):e.disable(e.BLEND),this._blend=t)},enumerable:!0,configurable:!0}),e.prototype.setBlendFunc=function(t,e){(this._blendSrc!==t||this._blendDst!==e)&&(this._blend&&this.gl.blendFunc(this.gl[t],this.gl[e]),this._blendSrc=t,this._blendDst=e)},e.prototype.setBlendEquation=function(t){this._blendEquation!==t&&(this._blend&&this.gl.blendEquation(this.gl[t]),this._blendEquation=t)},e.prototype.setBlendFuncSeparate=function(t){var e=this.gl;this._blendFuncSeparate&&this._blendFuncSeparate[0]===t[0]&&this._blendFuncSeparate[1]===t[1]||(this._blend&&e.blendFuncSeparate(e[t[0]],e[t[1]],e[t[2]],e[t[3]]),this._blendFuncSeparate=t)},e.prototype.setBlendEquationSeparate=function(t){var e=this.gl;this._blendEquationSeparate&&this._blendEquationSeparate[0]===t[0]&&this._blendEquationSeparate[1]===t[1]||(this._blend&&e.blendEquationSeparate(e[t[0]],e[t[1]]),this._blendEquationSeparate=t)},e.prototype.setColorWrite=function(t,e,r,n){(this._writeRed!==t||this._writeGreen!==e||this._writeBlue!==r||this._writeAlpha!==n)&&(this.gl.colorMask(t,e,r,n),this._writeRed=t,this._writeGreen=e,this._writeBlue=r,this._writeAlpha=n)},e.prototype.clear=function(t){var e=this.gl,r=t.color;e.clearColor(r.r,r.g,r.b,r.a),this.setColorWrite(!0,!0,!0,!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)},e.prototype.createGL=function(e){var r=null;r=e?wdCb.DomQuery.create(e).get(0):wdCb.DomQuery.create("<canvas></canvas>").prependTo("body").get(0),this.view=t.ViewWebGL.create(r),this.gl=this.view.getContext()},e.prototype.setScreen=function(){var e=t.Main.screenSize,r=null,n=null,o=null,i=null;e===t.EScreenSize.FULL?(r=0,n=0,o=t.root.innerWidth,i=t.root.innerHeight,wdCb.DomQuery.create("body").css("margin","0")):(r=e.x||0,n=e.y||0,o=e.width||t.root.innerWidth,i=e.height||t.root.innerHeight),this.view.x=r,this.view.y=n,this.view.width=o,this.view.height=i,this.setViewport(0,0,o,i)},e._instance=null,__decorate([t.require(function(){t.assert(null!==t.Main.screenSize,t.Log.info.FUNC_NOT_EXIST("Main.screenSize"))})],e.prototype,"setScreen",null),e}();t.DeviceManager=e,function(t){t[t.NEVER="NEVER"]="NEVER",t[t.ALWAYS="ALWAYS"]="ALWAYS",t[t.LESS="LESS"]="LESS",t[t.LEQUAL="LEQUAL"]="LEQUAL",t[t.EQUAL="EQUAL"]="EQUAL",t[t.GEQUAL="GEQUAL"]="GEQUAL",t[t.GREATER="GREATER"]="GREATER",t[t.NOTEQUAL="NOTEQUAL"]="NOTEQUAL"}(t.EDepthFunction||(t.EDepthFunction={}));t.EDepthFunction;!function(t){t[t.NONE=0]="NONE",t[t.BOTH=1]="BOTH",t[t.BACK=2]="BACK",t[t.FRONT=3]="FRONT"}(t.ESide||(t.ESide={}));var r=t.ESide;!function(t){t[t.NONE=0]="NONE",t[t.IN=1]="IN",t[t.OUT=2]="OUT",t[t.CUSTOM=3]="CUSTOM"}(t.EPolygonOffsetMode||(t.EPolygonOffsetMode={}));var n=t.EPolygonOffsetMode;!function(t){t[t.ZERO="ZEOR"]="ZERO",t[t.ONE="ONE"]="ONE",t[t.SRC_COLOR="SRC_COLOR"]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR="ONE_MINUS_SRC_COLOR"]="ONE_MINUS_SRC_COLOR",t[t.DST_COLOR="DST_COLOR"]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR="ONE_MINUS_DST_COLOR"]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA="SRC_ALPHA"]="SRC_ALPHA",t[t.SRC_ALPHA_SATURATE="SRC_ALPHA_SATURATE"]="SRC_ALPHA_SATURATE",t[t.ONE_MINUS_SRC_ALPHA="ONE_MINUS_SRC_ALPHA"]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA="DST_ALPHA"]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPH="ONE_MINUS_DST_ALPHA"]="ONE_MINUS_DST_ALPH"}(t.EBlendFunc||(t.EBlendFunc={}));t.EBlendFunc;!function(t){t[t.ADD="FUNC_ADD"]="ADD",t[t.SUBTRACT="FUNC_SUBTRACT"]="SUBTRACT",t[t.REVERSE_SUBTRAC="FUNC_REVERSE_SUBTRACT"]="REVERSE_SUBTRAC"}(t.EBlendEquation||(t.EBlendEquation={}));t.EBlendEquation;!function(t){t[t.NONE=0]="NONE",t[t.NORMAL=1]="NORMAL",t[t.ADDITIVE=2]="ADDITIVE",t[t.ADDITIVEALPHA=3]="ADDITIVEALPHA",t[t.MULTIPLICATIVE=4]="MULTIPLICATIVE",t[t.PREMULTIPLIED=5]="PREMULTIPLIED"}(t.EBlendType||(t.EBlendType={}));t.EBlendType;!function(t){t[t.UI="UI"]="UI"}(t.ECanvasType||(t.ECanvasType={}));t.ECanvasType}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.maxTextureUnit=null,this.maxTextureSize=null,this.maxCubemapTextureSize=null,this.maxAnisotropy=null,this.extensionCompressedTextureS3TC=null,this.extensionTextureFilterAnisotropic=null,this.precision=null,this._isDetected=!1}return e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},Object.defineProperty(e.prototype,"gl",{get:function(){return t.DeviceManager.getInstance().gl},enumerable:!0,configurable:!0}),e.prototype.detect=function(){this._isDetected=!0,this._detectExtension(),this._detectCapabilty()},e.prototype._detectExtension=function(){this.extensionCompressedTextureS3TC=this._getExtension("WEBGL_compressed_texture_s3tc"),this.extensionTextureFilterAnisotropic=this._getExtension("EXT_texture_filter_anisotropic")},e.prototype._detectCapabilty=function(){var t=this.gl;this.maxTextureUnit=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubemapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxAnisotropy=this._getMaxAnisotropy(),this._detectPrecision()},e.prototype._getExtension=function(t){var e,r=this.gl;switch(t){case"EXT_texture_filter_anisotropic":e=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":e=r.getExtension("WEBGL_compressed_texture_s3tc")||r.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":e=r.getExtension("WEBGL_compressed_texture_pvrtc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:e=r.getExtension(t)}return e},e.prototype._getMaxAnisotropy=function(){var t=this.extensionTextureFilterAnisotropic,e=this.gl;return null!==t?e.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0},e.prototype._detectPrecision=function(){var e=this.gl,n=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),o=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),i=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),a=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT),s=n.precision>0&&i.precision>0,c=o.precision>0&&a.precision>0;s?this.precision=r.HIGHP:c?(this.precision=r.MEDIUMP,t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT("gpu","highp, using mediump"))):(this.precision=r.LOWP,t.Log.warn(t.Log.info.FUNC_NOT_SUPPORT("gpu","highp and mediump, using lowp")))},e._instance=null,e}();t.GPUDetector=e,function(t){t[t.HIGHP=0]="HIGHP",t[t.MEDIUMP=1]="MEDIUMP",t[t.LOWP=2]="LOWP"}(t.EGPUPrecision||(t.EGPUPrecision={}));var r=t.EGPUPrecision}(wd||(wd={}));var wd;!function(t){!function(t){t[t.FULL=0]="FULL"}(t.EScreenSize||(t.EScreenSize={}));t.EScreenSize}(wd||(wd={}));var wd;!function(t){var e=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.x=null,this.y=null,this.x=t,this.y=e}return t.create=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null);var r=new this(t,e);return r},t}();t.Point=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t,e,r,n,o){this._faceNormal=null,this.aIndex=null,this.bIndex=null,this.cIndex=null,this.vertexNormals=null,this.aIndex=t,this.bIndex=e,this.cIndex=r,this._faceNormal=n,this.vertexNormals=o}return e.create=function(t,e,r,n,o){void 0===n&&(n=null),void 0===o&&(o=wdCb.Collection.create());var i=new this(t,e,r,n,o);return i},Object.defineProperty(e.prototype,"faceNormal",{get:function(){return null!==this._faceNormal?this._faceNormal:t.Vector3.create(0,0,0)},set:function(t){this._faceNormal=t},enumerable:!0,configurable:!0}),e.prototype.hasFaceNormal=function(){return null!==this._faceNormal},e.prototype.hasVertexNormal=function(){return this.vertexNormals.getCount()>0},e.prototype.copy=function(){var t=this._faceNormal?this._faceNormal.copy():null,r=null;return this.vertexNormals&&(r=wdCb.Collection.create(),this.vertexNormals.forEach(function(t){r.addChild(t.copy())})),e.create(this.aIndex,this.bIndex,this.cIndex,t,r)},e}();t.Face3=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"width",{get:function(){return this.z},set:function(t){this.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.w},set:function(t){this.w=t},enumerable:!0,configurable:!0}),e.prototype.copy=function(){return this.copyHelper(e.create())},e.prototype.isNotEmpty=function(){return 0!==this.x||0!==this.y||0!==this.width||0!==this.height},e}(t.Vector4);t.RectRegion=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(t){this._dom=null,this._dom=t}return t.create=function(t){var e=new this(t);return e},Object.defineProperty(t.prototype,"offset",{get:function(){for(var t=this._dom,e={x:t.offsetLeft,y:t.offsetTop};t=t.offsetParent;)e.x+=t.offsetLeft,e.y+=t.offsetTop;return e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dom",{get:function(){return this._dom},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._dom.width},set:function(t){this._dom.width=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._dom.height},set:function(t){this._dom.height=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"x",{get:function(){return Number(this._dom.style.left.slice(0,-2))},set:function(t){this._dom.style.position="absolute",this._dom.style.left=t+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return Number(this._dom.style.top.slice(0,-2))},set:function(t){this._dom.style.position="absolute",this._dom.style.top=t+"px"},enumerable:!0,configurable:!0}),t.prototype.getContext=function(){return this._dom.getContext("webgl")||this._dom.getContext("experimental-webgl")},t}();t.ViewWebGL=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this._r=null,this._g=null,this._b=null,this._a=null,this._colorString=null,this._colorVec3Cache=null,this._colorVec4Cache=null}return e.create=function(t){var e=new this;return e.initWhenCreate(t),e},Object.defineProperty(e.prototype,"dirty",{set:function(t){t&&this._clearCache()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"r",{get:function(){return this._r},set:function(t){this._r!==t&&(this.dirty=!0,this._r=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"g",{get:function(){return this._g},set:function(t){this._g!==t&&(this.dirty=!0,this._g=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"b",{get:function(){return this._b},set:function(t){this._b!==t&&(this.dirty=!0,this._b=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"a",{get:function(){return this._a},set:function(t){this._a!==t&&(this.dirty=!0,this._a=t)},enumerable:!0,configurable:!0}),e.prototype.initWhenCreate=function(t){t&&(this._colorString=t,this._setColor(t))},e.prototype.toVector3=function(){return t.Vector3.create(this.r,this.g,this.b)},e.prototype.toVector4=function(){return t.Vector4.create(this.r,this.g,this.b,this.a)},e.prototype.toString=function(){return this._colorString},e.prototype._setColor=function(t){var e=/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*([^\)]+)\)$/i,r=/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/i,n=/^rgb\((\d+\.\d+),\s*(\d+\.\d+),\s*(\d+\.\d+)\)$/i,o=/^\#([0-9a-f]{6})$/i,i=null;return e.test(t)?(i=e.exec(t),this.r=this._getColorValue(i,1),this.g=this._getColorValue(i,2),this.b=this._getColorValue(i,3),this.a=Number(i[4]),this):r.test(t)?(i=r.exec(t),this.r=this._getColorValue(i,1),this.g=this._getColorValue(i,2),this.b=this._getColorValue(i,3),this.a=1,this):n.test(t)?(i=n.exec(t),this.r=parseFloat(i[1]),this.g=parseFloat(i[2]),this.b=parseFloat(i[3]),this.a=1,this):o.test(t)?(i=o.exec(t),this._setHex(parseInt(i[1],16)),this):void 0},e.prototype._getColorValue=function(t,e,r){return void 0===r&&(r=255),Math.min(r,parseInt(t[e],10))/r},e.prototype._setHex=function(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this.a=1,this},e.prototype._clearCache=function(){this._colorVec3Cache=null,this._colorVec4Cache=null},__decorate([t.cache(function(){return null!==this._colorVec3Cache},function(){return this._colorVec3Cache},function(t){this._colorVec3Cache=t})],e.prototype,"toVector3",null),__decorate([t.cache(function(){return null!==this._colorVec4Cache},function(){return this._colorVec4Cache},function(t){this._colorVec4Cache=t})],e.prototype,"toVector4",null),e}();t.Color=e}(wd||(wd={}));var __decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(){function e(){this.material=null,this.width=null,this.height=null,this.variableData=null,this.wrapS=null,this.wrapT=null,this.magFilter=null,this.minFilter=null,this.glTexture=null,this.needUpdate=null,this.target=t.ETextureTarget.TEXTURE_2D}return Object.defineProperty(e.prototype,"geometry",{get:function(){return this.material.geometry},enumerable:!0,configurable:!0}),e.prototype.bindToUnit=function(e){var r=t.DeviceManager.getInstance().gl,n=t.GPUDetector.getInstance().maxTextureUnit;return e>=n&&t.Log.warn("trying to use "+e+" texture units, but GPU only supports "+n+" units"),r.activeTexture(r["TEXTURE"+String(e)]),r.bindTexture(r[this.target],this.glTexture),this},e.prototype.sendData=function(t,e,r){
t.sendUniformData(e,this.getSamplerType(),r)},e.prototype.dispose=function(){var e=t.DeviceManager.getInstance().gl;e.deleteTexture(this.glTexture),delete this.glTexture},e.prototype.filterFallback=function(e){return e===t.ETextureFilterMode.NEAREST||e===t.ETextureFilterMode.NEAREST_MIPMAP_MEAREST||e===t.ETextureFilterMode.NEAREST_MIPMAP_LINEAR?t.ETextureFilterMode.NEAREST:t.ETextureFilterMode.LINEAR},e.prototype.getSamplerNameByVariableData=function(e,r){var n=null;return this.variableData?this.variableData.samplerVariableName&&(n=this.variableData.samplerVariableName):n=r===t.EVariableType.SAMPLER_2D?"u_sampler2D"+e:"u_samplerCube"+e,n},e.prototype.getSamplerType=function(){var e=null;switch(this.target){case t.ETextureTarget.TEXTURE_2D:e=t.EVariableType.SAMPLER_2D;break;case t.ETextureTarget.TEXTURE_CUBE_MAP:e=t.EVariableType.SAMPLER_CUBE}return e},e.prototype.isSourcePowerOfTwo=function(){return t.TextureUtils.isPowerOfTwo(this.width,this.height)},e.prototype.setTextureParameters=function(e,r){var n=t.DeviceManager.getInstance().gl;r?(n.texParameteri(e,n.TEXTURE_WRAP_S,n[this.wrapS]),n.texParameteri(e,n.TEXTURE_WRAP_T,n[this.wrapT]),n.texParameteri(e,n.TEXTURE_MAG_FILTER,n[this.magFilter]),n.texParameteri(e,n.TEXTURE_MIN_FILTER,n[this.minFilter])):(n.texParameteri(e,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(e,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(e,n.TEXTURE_MAG_FILTER,n[this.filterFallback(this.magFilter)]),n.texParameteri(e,n.TEXTURE_MIN_FILTER,n[this.filterFallback(this.minFilter)]))},__decorate([t.virtual],e.prototype,"isSourcePowerOfTwo",null),e}();t.Texture=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.isPowerOfTwo=function(e,r){return t.JudgeUtils.isPowerOfTwo(e)&&t.JudgeUtils.isPowerOfTwo(r)},e}();t.TextureUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.isDrawPartOfTexture=function(e,r){return e&&e.isNotEmpty()&&r===t.ETextureSourceRegionMethod.DRAW_IN_CANVAS},r.drawPartOfTextureByCanvas=function(t,e,r,n,o,i,a,s,c,u,l){var h=wdCb.DomQuery.create("<canvas></canvas>").get(0),p=null;return h.width=e,h.height=r,p=h.getContext("2d"),p.drawImage(t,n,o,i,a,s,c,u,l),h},r.isSourcePowerOfTwo=function(t,e,r,n){return this.isDrawPartOfTexture(t,e)?this.isPowerOfTwo(t.width,t.height):this.isPowerOfTwo(r,n)},r.needClampMaxSize=function(t,e,r){return e>t||r>t},r.clampToMaxSize=function(e,r){var n=null,o=null,i=null,a=null;return n=Math.max(e.width,e.height),o=Math.floor(e.width*r/n),i=Math.floor(e.height*r/n),a=this.drawPartOfTextureByCanvas(e,o,i,0,0,e.width,e.height,0,0,o,i),t.Log.log("source is too big (width:"+e.width+", height:"+e.height+"), resize it to be width:"+a.width+", height:"+a.height+"."),a},r}(t.TextureUtils);t.BasicTextureUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.prototype.initWhenCreate=function(){this.needUpdate=!1},r.prototype.init=function(){return this.minFilter=t.ETextureFilterMode.LINEAR,this.magFilter=t.ETextureFilterMode.LINEAR,this.wrapS=t.ETextureWrapMode.CLAMP_TO_EDGE,this.wrapT=t.ETextureWrapMode.CLAMP_TO_EDGE,this},r.prototype.update=function(){},r.prototype.getPosition=function(){return this.geometry.entityObject.transform.position},r.prototype.setEmptyTexture=function(e){var r=t.DeviceManager.getInstance().gl;t.Log.error(!e,"Failed to create texture object"),r.bindTexture(r[this.target],e),this.setTextureParameters(r[this.target],this.isSourcePowerOfTwo())},r}(t.Texture);t.RenderTargetTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._renderList=null,this.width=256,this.height=256}return __extends(r,e),Object.defineProperty(r.prototype,"renderList",{get:function(){return this._renderList},set:function(e){t.JudgeUtils.isArrayExactly(e)?this._renderList=wdCb.Collection.create(e):e instanceof wdCb.Collection?this._renderList=e:t.Log.error(!0,t.Log.info.FUNC_MUST_BE("renderList","array or wdCb.Collection"))},enumerable:!0,configurable:!0}),r.prototype.createEmptyTexture=function(){var e=t.DeviceManager.getInstance().gl,r=e.createTexture();this.setEmptyTexture(r),e.texImage2D(e[this.target],0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null),this.glTexture=r},r}(t.RenderTargetTexture);t.TwoDRenderTargetTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.setTextureParameters=function(e){var r=t.DeviceManager.getInstance().gl,n=t.Director.getInstance().scene;n.shadowMap.softType===t.EShadowMapSoftType.PCF&&(r.texParameteri(e,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(e,r.TEXTURE_MIN_FILTER,r.NEAREST))},e}();t.ShadowMapTextureUtils=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._plane=null}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addRenderTargetRenderer(t.MirrorRenderTargetRenderer.create(this)),this},r.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_2D)},r.prototype.getPlane=function(){var e=null,r=null,n=null;return this._plane&&!this.geometry.entityObject.transform.dirtyLocal?this._plane:(t.Log.error(!(this.geometry instanceof t.PlaneGeometry),t.Log.info.FUNC_MUST_BE("geometry","PlaneGeometry")),e=this.geometry.geometryData.normals,r=this.geometry.entityObject.transform.localRotation.multiplyVector3(t.Vector3.create(e[0],e[1],e[2])).normalize(),n=this.getPosition(),this._plane=t.Plane.create(r.x,r.y,r.z,-n.dot(r)),this._plane)},r}(t.TwoDRenderTargetTexture);t.MirrorTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.getSamplerName=function(e){return t.Log.error(!t.JudgeUtils.isNumber(this.variableData.samplerData),t.Log.info.FUNC_MUST_BE("shadowMapTexture->variableData.samplerData","samplerIndex")),"u_twoDShadowMapSampler["+this.variableData.samplerData+"]"},r.prototype.setTextureParameters=function(r,n){e.prototype.setTextureParameters.call(this,r,n),t.ShadowMapTextureUtils.setTextureParameters(r)},r}(t.TwoDRenderTargetTexture);t.TwoDShadowMapTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.target=t.ETextureTarget.TEXTURE_CUBE_MAP}return __extends(r,e),r.prototype.createEmptyTexture=function(){var e=t.DeviceManager.getInstance().gl,r=e.createTexture(),n=null;for(this.setEmptyTexture(r),n=0;6>n;n++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,e.RGBA,this.width,this.height,0,e.RGBA,e.UNSIGNED_BYTE,null);this.glTexture=r},r}(t.RenderTargetTexture);t.CubemapRenderTargetTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.getSamplerName=function(e){return t.Log.error(!t.JudgeUtils.isNumber(this.variableData.samplerData),t.Log.info.FUNC_MUST_BE("shadowMapTexture->variableData.samplerData","samplerIndex")),"u_cubemapShadowMapSampler["+this.variableData.samplerData+"]"},r}(t.CubemapRenderTargetTexture);t.CubemapShadowMapTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._renderList=null,this.size=256,this.near=.1,this.far=100,this.mode=null}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(r.prototype,"renderList",{get:function(){return this._renderList},set:function(e){t.JudgeUtils.isDirectObject(e)?this._renderList=wdCb.Hash.create(e):e instanceof wdCb.Hash?this._renderList=e:t.Log.error(!0,t.Log.info.FUNC_MUST_BE("renderList","array or wdCb.Collection"))},enumerable:!0,configurable:!0}),r.prototype.init=function(){return e.prototype.init.call(this),this.width=this.size,this.height=this.size,t.Director.getInstance().scene.addRenderTargetRenderer(t.DynamicCubemapRenderTargetRenderer.create(this)),this},r.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_CUBE)},r}(t.CubemapRenderTargetTexture);t.DynamicCubemapTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.repeatRegion=t.RectRegion.create(0,0,1,1)}return __extends(r,e),Object.defineProperty(r.prototype,"sourceRegionForGLSL",{get:function(){return t.RectRegion.create(0,0,1,1)},enumerable:!0,configurable:!0}),r.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_2D)},r}(t.TwoDRenderTargetTexture);t.ProceduralTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.p_sourceRegionMethod=null,this.generateMipmaps=null,this.format=null,this.source=null,this.repeatRegion=null,this.sourceRegion=null,this.sourceRegionMapping=null,this.flipY=null,this.premultiplyAlpha=null,this.unpackAlignment=null,this.type=null,this.mipmaps=null,this.anisotropy=null}return __extends(r,e),Object.defineProperty(r.prototype,"sourceRegionMethod",{get:function(){return this.p_sourceRegionMethod},set:function(t){this.p_sourceRegionMethod=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"sourceRegionForGLSL",{get:function(){return this.sourceRegion&&this.sourceRegionMethod===t.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL?this._convertSourceRegionToUV(this.sourceRegion):t.RectRegion.create(0,0,1,1)},enumerable:!0,configurable:!0}),r.prototype.initWhenCreate=function(){for(var e=[],r=0;r<arguments.length;r++)e[r-0]=arguments[r];var n=t.DeviceManager.getInstance().gl;this.glTexture=n.createTexture(),this.needUpdate=!0},r.prototype.init=function(){},r.prototype.update=function(){var e=t.DeviceManager.getInstance().gl,r=this.isSourcePowerOfTwo();return e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,this.unpackAlignment),this.needClampMaxSize()&&(this.clampToMaxSize(),r=this.isSourcePowerOfTwo(),r||t.Log.warn("texture size is not power of two after clampToMaxSize()")),this.setTextureParameters(e[this.target],r),this.allocateSourceToTexture(r),this.generateMipmaps&&r&&e.generateMipmap(e[this.target]),this.needUpdate=!1,this},r.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_2D)},r.prototype.needClampMaxSize=function(){return this.source?t.BasicTextureUtils.needClampMaxSize(t.GPUDetector.getInstance().maxTextureSize,this.source.width,this.source.height):!1},r.prototype.clampToMaxSize=function(){this.source=t.BasicTextureUtils.clampToMaxSize(this.source,t.GPUDetector.getInstance().maxTextureSize)},r.prototype.setTextureParameters=function(t,r){e.prototype.setTextureParameters.call(this,t,r),this._setAnisotropy(t)},r.prototype.isSourcePowerOfTwo=function(){return t.BasicTextureUtils.isSourcePowerOfTwo(this.sourceRegion,this.sourceRegionMethod,this.width,this.height)},r.prototype._setAnisotropy=function(e){var r=t.GPUDetector.getInstance(),n=t.DeviceManager.getInstance().gl;r.extensionTextureFilterAnisotropic&&this.anisotropy>1&&n.texParameterf(e,r.extensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(this.anisotropy,r.maxAnisotropy))},r.prototype._convertSourceRegionCanvasMapToUV=function(e){var r=this.width,n=this.height,o=null;return o=t.RectRegion.create(e.x/r,e.y/n,e.width/r,e.height/n),o.y=1-o.y-o.height,o},r.prototype._convertSourceRegionToUV=function(e){return this.sourceRegionMapping===t.ETextureSourceRegionMapping.CANVAS?this._convertSourceRegionCanvasMapToUV(e):this.sourceRegionMapping===t.ETextureSourceRegionMapping.UV?e:void 0},__decorate([t.virtual],r.prototype,"needClampMaxSize",null),r}(t.Texture);t.BasicTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.initWhenCreate=function(e){t.prototype.initWhenCreate.call(this),e.copyTo(this)},e}(t.BasicTexture);t.TwoDTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.prototype.allocateSourceToTexture=function(e){var r=null,n=null,o=t.DeviceManager.getInstance().gl;e&&this.mipmaps.getCount()>0?(r=t.DrawMipmapTwoDTextureCommand.create(),r.mipmaps=this.mipmaps,r.format=this.format,r.type=this.type,r.sourceRegion=this.sourceRegion,r.sourceRegionMethod=this.sourceRegionMethod,r.glTarget=o.TEXTURE_2D,r.execute(),this.generateMipmaps=!1):(n=t.DrawNoMipmapTwoDTextureCommand.create(),n.source=this.source,n.format=this.format,n.type=this.type,n.sourceRegion=this.sourceRegion,n.sourceRegionMethod=this.sourceRegionMethod,n.glTarget=o.TEXTURE_2D,n.execute())},r}(t.TwoDTexture);t.CommonTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this;return e.initWhenCreate(t),e},r.prototype.initWhenCreate=function(r){if(arguments[0]instanceof t.ImageTextureAsset){var n=arguments[0];e.prototype.initWhenCreate.call(this,n)}else{var o=arguments[0];e.prototype.initWhenCreate.call(this,t.ImageTextureAsset.create(o))}},r}(t.CommonTexture);t.ImageTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this._video=null,this._startLoopSubscription=null}return __extends(r,e),r.create=function(t){var e=new this;return e.initWhenCreate(t),e},r.prototype.initWhenCreate=function(t){e.prototype.initWhenCreate.call(this,t),this._video=t.video},r.prototype.init=function(){var r=this;return e.prototype.init.call(this),this._startLoopSubscription=t.EventManager.fromEvent(t.EEngineEvent.STARTLOOP).subscribe(function(){r._video.isStop?r.needUpdate=!1:r.needUpdate=!0}),this},r.prototype.dispose=function(){this._startLoopSubscription&&this._startLoopSubscription.dispose()},r.prototype.needClampMaxSize=function(){return!1},r}(t.CommonTexture);t.VideoTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(r){e.call(this),this.assets=null,this.textures=wdCb.Collection.create(),this.mode=null,this.target=t.ETextureTarget.TEXTURE_CUBE_MAP,this._areAllCompressedAsset=!1,this.assets=r}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(t),e},r.prototype.initWhenCreate=function(t){e.prototype.initWhenCreate.call(this),this._areAssetsAllCompressedAsset(t)?this._areAllCompressedAsset=!0:this._areAllCompressedAsset=!1,this._createTextures(t),this._getRepresentAsset(t).copyToCubemapTexture(this),this._areAllCompressedAsset?(this.generateMipmaps=!1,this._hasNoMipmapCompressedAsset()&&(this.minFilter=this.filterFallback(this.minFilter))):this.generateMipmaps=!0,this.flipY=!1},r.prototype.getSamplerName=function(e){return this.getSamplerNameByVariableData(e,t.EVariableType.SAMPLER_CUBE)},r.prototype.allocateSourceToTexture=function(t){this._areAllCompressedAsset?this.textures.forEach(function(t,e){t.draw(e)}):this.textures.forEach(function(t,e){t.draw(e)})},r.prototype.needClampMaxSize=function(){var t=!1;return this.textures.forEach(function(e){return e.needClampMaxSize()?(t=!0,wdCb.$BREAK):void 0}),t},r.prototype.isSourcePowerOfTwo=function(){var t=!0;return this.textures.forEach(function(e){return e.isSourcePowerOfTwo()?void 0:(t=!1,wdCb.$BREAK)}),t},r.prototype.clampToMaxSize=function(){this.textures.forEach(function(t){t.clampToMaxSize()})},r.prototype._hasNoMipmapCompressedAsset=function(){var t=this;return this._areAllCompressedAsset?this.textures.filter(function(e){return!t._isMipmapFilter(e.minFilter)}).getCount()>0:!1},r.prototype._isMipmapFilter=function(e){return e===t.ETextureFilterMode.LINEAR_MIPMAP_LINEAR||e===t.ETextureFilterMode.LINEAR_MIPMAP_NEAREST||e===t.ETextureFilterMode.NEAREST_MIPMAP_LINEAR||e===t.ETextureFilterMode.NEAREST_MIPMAP_MEAREST},r.prototype._getRepresentAsset=function(t){return t[0].asset},r.prototype._areAssetsAllImageAssets=function(e){for(var r=[],n=0,o=e;n<o.length;n++){var i=o[n];i.asset instanceof t.ImageTextureAsset&&r.push(i)}return 6===r.length},r.prototype._areAssetsAllCompressedAsset=function(e){for(var r=[],n=0,o=e;n<o.length;n++){var i=o[n];i.asset instanceof t.CompressedTextureAsset&&r.push(i)}return 6===r.length},r.prototype._createTextures=function(e){for(var r=this,n=0,o=e;n<o.length;n++){var i=o[n],a=i.asset.toCubemapFaceTexture();if(i.sourceRegion&&a instanceof t.CubemapFaceImageTexture){var s=a;s.sourceRegion=i.sourceRegion}i.type&&(a.type=i.type),r.textures.addChild(a)}},r.prototype._areTextureSizOfAllFaceseEqual=function(t){for(var e=[],r=[],n=0,o=t;n<o.length;n++){var i=o[n];i.sourceRegion?(e.push(i.sourceRegion.width),r.push(i.sourceRegion.height)):(e.push(i.asset.width),r.push(i.asset.height))}return this._areAllElementsEqual(e)&&this._areAllElementsEqual(r)},r.prototype._hasSourceRegion=function(t){for(var e=0,r=t;e<r.length;e++){var n=r[e];if(n.sourceRegion)return!0}return!1},r.prototype._areAllElementsEqual=function(t){for(var e=t[0],r=0,n=t;r<n.length;r++){var o=n[r];if(o!==e)return!1}return!0},__decorate([t.require(function(e){t.assert(6===e.length,t.Log.info.FUNC_MUST("cubemap","has 6 assets")),t.assert(this._areAssetsAllImageAssets(e)||this._areAssetsAllCompressedAsset(e),t.Log.info.FUNC_MUST_BE("cubemap six face's assets","all ImageTextureAsset or all CompressedTextureAsset")),this._areAssetsAllCompressedAsset(e)&&t.assert(!this._hasSourceRegion(e),t.Log.info.FUNC_SHOULD_NOT("compressed face","contain sourceRegion data")),t.assert(this._areTextureSizOfAllFaceseEqual(e),t.Log.info.FUNC_MUST_BE("all cubemap faces' texture size","equal"))})],r.prototype,"initWhenCreate",null),r}(t.BasicTexture);t.CubemapTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.type=t.ETextureType.UNSIGNED_BYTE,this.format=null,this.width=null,this.height=null}return e}();t.CubemapFaceTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.sourceRegion=null,this.source=null}return __extends(r,e),r.create=function(t){var e=new this;return e.initWhenCreate(t),e},Object.defineProperty(r.prototype,"sourceRegionMethod",{get:function(){return t.ETextureSourceRegionMethod.DRAW_IN_CANVAS},set:function(t){},enumerable:!0,configurable:!0}),r.prototype.initWhenCreate=function(t){t.copyToCubemapFaceTexture(this)},r.prototype.isSourcePowerOfTwo=function(){return t.BasicTextureUtils.isSourcePowerOfTwo(this.sourceRegion,this.sourceRegionMethod,this.width,this.height)},r.prototype.needClampMaxSize=function(){return this.source?t.BasicTextureUtils.needClampMaxSize(t.GPUDetector.getInstance().maxCubemapTextureSize,this.source.width,this.source.height):!1},r.prototype.clampToMaxSize=function(){var e=t.GPUDetector.getInstance().maxCubemapTextureSize;this.source=t.BasicTextureUtils.clampToMaxSize(this.source,e)},r.prototype.draw=function(e){var r=t.DrawNoMipmapTwoDTextureCommand.create(),n=t.DeviceManager.getInstance().gl;r.source=this.source,r.sourceRegion=this.sourceRegion,r.sourceRegionMethod=this.sourceRegionMethod,r.glTarget=n.TEXTURE_CUBE_MAP_POSITIVE_X+e,r.format=this.format,r.type=this.type,r.execute()},__decorate([t.requireSetter(function(e){t.assert(e===t.ETextureSourceRegionMethod.DRAW_IN_CANVAS,t.Log.info.FUNC_SUPPORT("cubemap twoD face texture->sourceRegionMethod only","DRAW_IN_CANVAS"))})],r.prototype,"sourceRegionMethod",null),r}(t.CubemapFaceTexture);t.CubemapFaceImageTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.mipmaps=null,this.minFilter=null}return __extends(r,e),r.create=function(t){var e=new this;return e.initWhenCreate(t),e},r.prototype.initWhenCreate=function(t){t.copyToCubemapFaceTexture(this)},r.prototype.isSourcePowerOfTwo=function(){return t.BasicTextureUtils.isSourcePowerOfTwo(null,null,this.width,this.height)},r.prototype.needClampMaxSize=function(){return t.BasicTextureUtils.needClampMaxSize(t.GPUDetector.getInstance().maxCubemapTextureSize,this.width,this.height)},r.prototype.clampToMaxSize=function(){t.Log.warn("CubemapFaceCompressedTexture's texture size is over maxCubemapTextureSize")},r.prototype.draw=function(e){var r=t.DrawCompressedTextureCommand.create(),n=t.DeviceManager.getInstance().gl;r.glTarget=n.TEXTURE_CUBE_MAP_POSITIVE_X+e,r.type=this.type,r.format=this.format,r.mipmaps=this.mipmaps,r.execute()},r}(t.CubemapFaceTexture);t.CubemapFaceCompressedTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this;return e.initWhenCreate(t),e},Object.defineProperty(r.prototype,"sourceRegionMethod",{get:function(){return t.Log.assert(this.p_sourceRegionMethod===t.ETextureSourceRegionMethod.DRAW_IN_CANVAS,"compressed texture not support ETextureSourceRegionMethod.DRAW_IN_CANVAS, will use ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL instead"),t.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL},enumerable:!0,configurable:!0}),r.prototype.allocateSourceToTexture=function(e){var r=t.DeviceManager.getInstance().gl,n=t.DrawCompressedTextureCommand.create();n.glTarget=r.TEXTURE_2D,n.type=this.type,n.format=this.format,n.mipmaps=this.mipmaps,n.sourceRegion=this.sourceRegion,n.sourceRegionMethod=this.sourceRegionMethod,n.execute(),this.mipmaps.getCount()>1&&(this.generateMipmaps=!1)},r.prototype.needClampMaxSize=function(){return!1},r}(t.TwoDTexture);t.CompressedTexture=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){this.format=null,this.type=null,this.sourceRegion=null,this.sourceRegionMethod=t.ETextureSourceRegionMethod.CHANGE_TEXCOORDS_IN_GLSL,this.glTarget=null}return e.prototype.getDrawTarget=function(e,r){void 0===r&&(r=this.sourceRegion);var n=null;return n=t.BasicTextureUtils.isDrawPartOfTexture(r,this.sourceRegionMethod)?t.BasicTextureUtils.drawPartOfTextureByCanvas(e,r.width,r.height,r.x,r.y,r.width,r.height,0,0,r.width,r.height):e},e}();t.DrawTextureCommand=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.mipmaps=null}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.execute=function(){var e=t.DeviceManager.getInstance().gl,r=this;t.Log.error(null===this.format,t.Log.info.FUNC_NOT_SUPPORT(this.format)),this.format!==t.ETextureFormat.RGBA?this.mipmaps.forEach(function(t,n){e.compressedTexImage2D(r.glTarget,n,r.format,t.width,t.height,0,r.getDrawTarget(t.data))}):this.mipmaps.forEach(function(t,n){e.texImage2D(r.glTarget,n,e[r.format],t.width,t.height,0,e[r.format],e[r.type],r.getDrawTarget(t.data))})},r}(t.DrawTextureCommand);t.DrawCompressedTextureCommand=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.source=null}return __extends(r,e),r.prototype.drawTexture=function(e,r){var n=t.DeviceManager.getInstance().gl;n.texImage2D(this.glTarget,e,n[this.format],n[this.format],n[this.type],this.getDrawTarget(r))},r}(t.DrawTextureCommand);t.DrawTwoDTextureCommand=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.mipmaps=null}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.execute=function(){var t=this;this.mipmaps.forEach(function(e,r){t.drawTexture(r,e)})},e}(t.DrawTwoDTextureCommand);t.DrawMipmapTwoDTextureCommand=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.execute=function(){this.drawTexture(0,this.source)},e}(t.DrawTwoDTextureCommand);t.DrawNoMipmapTwoDTextureCommand=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(t){var e=t.urlArr,r=t.onLoad,n=void 0===r?function(t){}:r,o=t.onError,i=void 0===o?function(t){}:o;this.url=null,this.source=null,this.isStop=!1,this._urlArr=null,this._onLoad=null,this._onError=null,this._urlArr=wdCb.Collection.create(e),this._onLoad=n,this._onError=i}return e.create=function(t){var e=new this(t);return e.initWhenCreate(),e},e.prototype.initWhenCreate=function(){this.url=this._getCanPlayUrl(),this.source=document.createElement("video"),this.source.src=this.url,this._bindEvent()},e.prototype.play=function(){this.isStop=!1,this.source.play()},e.prototype._getCanPlayUrl=function(){var e=this,r=null,n=[];return this._urlArr.forEach(function(t){var o=wdCb.PathUtils.extname(t);return n.push(o),e._canplay(o)?(r=t,wdCb.$BREAK):void 0}),t.Log.error(null===r,t.Log.info.FUNC_NOT_SUPPORT("browser",n.join(","))),r},e.prototype._canplay=function(e){var r=document.createElement("video"),n=null;switch(e){case".mp4":n='video/mp4; codecs="avc1.42e01e, mp4a.40.2"';break;case".ogv":n='video/ogg; codecs="theora, vorbis"';break;case".webm":n='video/webm; codecs="vp8, vorbis"';break;default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT(e))}return!!r.canPlayType&&""!==r.canPlayType(n)},e.prototype._bindEvent=function(){var t=this;this.source.addEventListener("canplaythrough",function(){t._onLoad(t)},!1),this.source.addEventListener("error",function(){t._onError("errorCode "+t.source.error.code)},!1),this.source.addEventListener("ended",function(){t.isStop=!0},!1)},e}();t.Video=e}(wd||(wd={}));var wd;!function(t){var e=function(){function e(){}return e.getInstance=function(){return null===this._instance&&(this._instance=new this),this._instance},e.prototype.play=function(e){var r=t.VideoLoader.getInstance().get(e),n=null;t.Log.error(!r,t.Log.info.FUNC_NOT_EXIST("video asset which id is "+e)),n=r.video,n.play()},e._instance=null,e}();t.VideoManager=e}(wd||(wd={}));var wd;!function(t){t.JudgeUtils.isNodeJs()?t.root=global:t.root=window}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.type="common_proceduralTexture"}return __extends(e,t),e.create=function(){var t=new this;return t},e.prototype.sendShaderVariables=function(t,e){this.sendAttributeData(t,"a_positionVec2",e.vertexBuffer)},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addAttributeVariable(["a_positionVec2"])},e}(t.ProceduralShaderLib);t.CommonProceduralShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t;
}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(t){e.call(this),this.type="fire_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=t}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.sendShaderVariables=function(e,r){var n=this._proceduralTexture;n.computeTime(),this.sendUniformData(e,"u_time",n.time),this.sendUniformData(e,"u_speed",n.speed),this.sendUniformData(e,"u_shift",n.shift),this.sendUniformData(e,"u_alphaThreshold",n.alphaThreshold),n.fireColorMap.forEach(function(r,n){e.sendStructureData("u_fireColor."+n,t.EVariableType.FLOAT_3,r.toVector3())})},r.prototype.setShaderDefinition=function(t){e.prototype.setShaderDefinition.call(this,t),this.addUniformVariable(["u_time","u_speed","u_shift","u_alphaThreshold","u_fireColor"])},r}(t.ProceduralShaderLib);t.FireProceduralShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(),e},r.prototype.needRender=function(){return!0},r.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.FireProceduralShaderLib.create(this.texture)),e},r}(t.ProceduralRenderTargetRenderer);t.FireProceduralRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this._fireColorMap=null,this.fireColorType=r.RED,this.speed=t.Vector2.create(.5,.3),this.alphaThreshold=.5,this.shift=1,this.time=0}return __extends(n,e),n.create=function(){var t=new this;return t.initWhenCreate(),t},Object.defineProperty(n.prototype,"fireColorMap",{get:function(){switch(this.fireColorType){case r.CUSTOM:return this._fireColorMap;case r.RED:return wdCb.Hash.create({c1:t.Color.create("rgb(0.5, 0.0, 0.1)"),c2:t.Color.create("rgb(0.9, 0.0, 0.0)"),c3:t.Color.create("rgb(0.2, 0.0, 0.0)"),c4:t.Color.create("rgb(1.0, 0.9, 0.0)"),c5:t.Color.create("rgb(0.1, 0.1, 0.1)"),c6:t.Color.create("rgb(0.9, 0.9, 0.9)")});case r.BLUE:return wdCb.Hash.create({c1:t.Color.create("rgb(0.1, 0.0, 0.5)"),c2:t.Color.create("rgb(0.0, 0.0, 0.5)"),c3:t.Color.create("rgb(0.1, 0.0, 0.2)"),c4:t.Color.create("rgb(0.0, 0.0, 1.0)"),c5:t.Color.create("rgb(0.1, 0.2, 0.3)"),c6:t.Color.create("rgb(0.0, 0.2, 0.9)")});case r.PURPLE:return wdCb.Hash.create({c1:t.Color.create("rgb(0.5, 0.0, 1.0)"),c2:t.Color.create("rgb(0.9, 0.0, 1.0)"),c3:t.Color.create("rgb(0.2, 0.0, 1.0)"),c4:t.Color.create("rgb(1.0, 0.9, 1.0)"),c5:t.Color.create("rgb(0.1, 0.1, 1.0)"),c6:t.Color.create("rgb(0.9, 0.9, 1.0)")});case r.GREEN:return wdCb.Hash.create({c1:t.Color.create("rgb(0.5, 1.0, 0.0)"),c2:t.Color.create("rgb(0.5, 1.0, 0.0)"),c3:t.Color.create("rgb(0.3, 0.4, 0.0)"),c4:t.Color.create("rgb(0.5, 1.0, 0.0)"),c5:t.Color.create("rgb(0.2, 0.0, 0.0)"),c6:t.Color.create("rgb(0.5, 1.0, 0.0)")});default:t.Log.error(!0,t.Log.info.FUNC_UNEXPECT("fireColorType:"+this.fireColorType))}},set:function(t){this._fireColorMap=t},enumerable:!0,configurable:!0}),n.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.FireProceduralRenderTargetRenderer.create(this)),this},n.prototype.computeTime=function(){this.time+=.1},__decorate([t.requireSetter(function(e){t.assert(6===e.getCount(),t.Log.info.FUNC_SHOULD("contain 6 colors"))}),t.ensureGetter(function(e){t.assert(6===e.getCount(),t.Log.info.FUNC_SHOULD("contain 6 colors"))})],n.prototype,"fireColorMap",null),n}(t.ProceduralTexture);t.FireProceduralTexture=e,function(t){t[t.CUSTOM=0]="CUSTOM",t[t.RED=1]="RED",t[t.PURPLE=2]="PURPLE",t[t.GREEN=3]="GREEN",t[t.BLUE=4]="BLUE"}(t.EFireProceduralTextureColorType||(t.EFireProceduralTextureColorType={}));var r=t.EFireProceduralTextureColorType}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(),e},r.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.MarbleProceduralShaderLib.create(this.texture)),e},r}(t.ProceduralRenderTargetRenderer);t.MarbleProceduralRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.tilesHeightNumber=3,this.tilesWidthNumber=3,this.amplitude=9,this.jointColor=t.Color.create("rgb(0.72, 0.72, 0.72)")}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.MarbleProceduralRenderTargetRenderer.create(this)),this},r}(t.ProceduralTexture);t.MarbleProceduralTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(e){t.call(this),this.type="marble_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.sendShaderVariables=function(t,e){var r=this._proceduralTexture;this.sendUniformData(t,"u_tilesHeightNumber",r.tilesHeightNumber),this.sendUniformData(t,"u_tilesWidthNumber",r.tilesWidthNumber),this.sendUniformData(t,"u_amplitude",r.amplitude),this.sendUniformData(t,"u_jointColor",r.jointColor.toVector3())},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_tilesHeightNumber","u_tilesWidthNumber","u_amplitude","u_jointColor"])},e}(t.ProceduralShaderLib);t.MarbleProceduralShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(),e},r.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.GrassProceduralShaderLib.create(this.texture)),e},r}(t.ProceduralRenderTargetRenderer);t.GrassProceduralRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.herb1Color=t.Color.create("rgb(0.29, 0.38, 0.02)"),this.herb2Color=t.Color.create("rgb(0.36, 0.49, 0.09)"),this.herb3Color=t.Color.create("rgb(0.51, 0.6, 0.28)"),this.groundColor=t.Color.create("rgb(1.0,1.0,1.0)")}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.GrassProceduralRenderTargetRenderer.create(this)),this},r}(t.ProceduralTexture);t.GrassProceduralTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(e){t.call(this),this.type="grass_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.sendShaderVariables=function(t,e){var r=this._proceduralTexture;this.sendUniformData(t,"u_herb1Color",r.herb1Color.toVector3()),this.sendUniformData(t,"u_herb2Color",r.herb2Color.toVector3()),this.sendUniformData(t,"u_herb3Color",r.herb3Color.toVector3()),this.sendUniformData(t,"u_groundColor",r.groundColor.toVector3())},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_herb1Color","u_herb2Color","u_herb3Color","u_groundColor"])},e}(t.ProceduralShaderLib);t.GrassProceduralShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(),e},r.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.WoodProceduralShaderLib.create(this.texture)),e},r}(t.ProceduralRenderTargetRenderer);t.WoodProceduralRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.ampScale=100,this.woodColor=t.Color.create("rgb(0.32, 0.17, 0.09)")}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.WoodProceduralRenderTargetRenderer.create(this)),this},r}(t.ProceduralTexture);t.WoodProceduralTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(e){t.call(this),this.type="wood_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.sendShaderVariables=function(t,e){var r=this._proceduralTexture;this.sendUniformData(t,"u_ampScale",r.ampScale),this.sendUniformData(t,"u_woodColor",r.woodColor.toVector3())},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_ampScale","u_woodColor"])},e}(t.ProceduralShaderLib);t.WoodProceduralShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(),e},r.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.RoadProceduralShaderLib.create(this.texture)),e},r}(t.ProceduralRenderTargetRenderer);t.RoadProceduralRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.roadColor=t.Color.create("rgb(0.53, 0.53, 0.53)")}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.RoadProceduralRenderTargetRenderer.create(this)),this},r}(t.ProceduralTexture);t.RoadProceduralTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(e){t.call(this),this.type="road_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.sendShaderVariables=function(t,e){var r=this._proceduralTexture;this.sendUniformData(t,"u_roadColor",r.roadColor.toVector3())},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_roadColor"])},e}(t.ProceduralShaderLib);t.RoadProceduralShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(),e},r.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.CloudProceduralShaderLib.create(this.texture)),e},r}(t.ProceduralRenderTargetRenderer);t.CloudProceduralRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.skyColor=t.Color.create("rgb(0.15, 0.68, 1.0)"),this.cloudColor=t.Color.create("rgb(1.0, 1.0, 1.0)")}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.CloudProceduralRenderTargetRenderer.create(this)),this},r}(t.ProceduralTexture);t.CloudProceduralTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(e){t.call(this),this.type="cloud_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.sendShaderVariables=function(t,e){var r=this._proceduralTexture;this.sendUniformData(t,"u_skyColor",r.skyColor.toVector4()),this.sendUniformData(t,"u_cloudColor",r.cloudColor.toVector4())},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_skyColor","u_cloudColor"])},e}(t.ProceduralShaderLib);t.CloudProceduralShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(),e},r.prototype.createShader=function(){var e=t.CommonProceduralShader.create();return e.addLib(t.BrickProceduralShaderLib.create(this.texture)),e},r}(t.ProceduralRenderTargetRenderer);t.BrickProceduralRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.tilesHeightNumber=15,this.tilesWidthNumber=5,this.brickColor=t.Color.create("rgb(0.77, 0.47, 0.40)"),this.jointColor=t.Color.create("rgb(0.72, 0.72, 0.72)")}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.BrickProceduralRenderTargetRenderer.create(this)),this},r}(t.ProceduralTexture);t.BrickProceduralTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(t){function e(e){t.call(this),this.type="brick_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=e}return __extends(e,t),e.create=function(t){var e=new this(t);return e},e.prototype.sendShaderVariables=function(t,e){var r=this._proceduralTexture;this.sendUniformData(t,"u_tilesWidthNumber",r.tilesWidthNumber),this.sendUniformData(t,"u_tilesHeightNumber",r.tilesHeightNumber),this.sendUniformData(t,"u_brickColor",r.brickColor.toVector3()),this.sendUniformData(t,"u_jointColor",r.jointColor.toVector3())},e.prototype.setShaderDefinition=function(e){t.prototype.setShaderDefinition.call(this,e),this.addUniformVariable(["u_tilesHeightNumber","u_tilesWidthNumber","u_brickColor","u_jointColor"])},e}(t.ProceduralShaderLib);t.BrickProceduralShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments)}return __extends(r,e),r.create=function(t){var e=new this(t);return e.initWhenCreate(),e},r.prototype.needRender=function(){return this.texture.isAnimate?!0:e.prototype.needRender.call(this)},r.prototype.createShader=function(){var e=t.CustomProceduralShader.create(this.texture);return e.addLib(t.CustomProceduralShaderLib.create(this.texture)),e},r}(t.ProceduralRenderTargetRenderer);t.CustomProceduralRenderTargetRenderer=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.mapManager=t.MapManager.create(null),this.uniformMap=wdCb.Hash.create(),this.fsSource=null,this.isAnimate=!1}return __extends(r,e),r.create=function(){var t=new this;return t.initWhenCreate(),t},r.prototype.init=function(){return e.prototype.init.call(this),t.Director.getInstance().scene.addProceduralRenderTargetRenderer(t.CustomProceduralRenderTargetRenderer.create(this)),this},r.prototype.read=function(e){var r=t.LoaderManager.getInstance().get(e),n=r.uniforms;this.fsSource=t.LoaderManager.getInstance().get(r.fsSourceId);for(var o in n)if(n.hasOwnProperty(o)){var i=n[o];i.type===t.EVariableType.SAMPLER_2D?this.mapManager.addMap(t.LoaderManager.getInstance().get(i.textureId),{samplerVariableName:o}):this.uniformMap.addChild(o,i)}},__decorate([t.require(function(e){var r=t.LoaderManager.getInstance().get(e),n=r.uniforms;for(var o in n)if(n.hasOwnProperty(o)){var i=n[o];t.assert(i.type!==t.EVariableType.SAMPLER_CUBE,t.Log.info.FUNC_NOT_SUPPORT("uniforms","EVariableType.SAMPLER_CUBE type"))}}),t.ensure(function(){t.assert(null!==this.fsSource,t.Log.info.FUNC_SHOULD("read fragment glsl source"))})],r.prototype,"read",null),r}(t.ProceduralTexture);t.CustomProceduralTexture=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},wd;!function(t){var e=function(e){function r(t){e.call(this),this.type="custom_proceduralTexture",this._proceduralTexture=null,this._proceduralTexture=t}return __extends(r,e),r.create=function(t){var e=new this(t);return e},r.prototype.sendShaderVariables=function(e,r){var n=this._proceduralTexture,o=n.uniformMap;o.forEach(function(r,n){t.CustomShaderLibUtils.sendUniformData(n,r.type,r.value,e)})},r.prototype.setShaderDefinition=function(t){var r=this._proceduralTexture;e.prototype.setShaderDefinition.call(this,t),this.setFsSource(r.fsSource)},r}(t.ProceduralShaderLib);t.CustomProceduralShaderLib=e}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function n(){e.apply(this,arguments),this.layer=r.create()}return __extends(n,e),n.create=function(){var t=new this;return t},n.prototype.init=function(){this.mapManager.addArrayMap("u_layerSampler2Ds",this.layer.mapArray),e.prototype.init.call(this)},n.prototype.addExtendShaderLib=function(){this.layer.mapDataList.getCount()>0&&this.shader.addLib(t.TerrainLayerShaderLib.create())},n}(t.LightMaterial);t.TerrainMaterial=e;var r=function(){function e(){this._mapDataList=wdCb.Collection.create()}return e.create=function(){var t=new this;return t},Object.defineProperty(e.prototype,"mapDataList",{get:function(){return this._mapDataList},set:function(t){this._mapDataList=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mapArray",{get:function(){var t=[];return this._mapDataList.forEach(function(e){t.push(e.diffuseMap)}),t},enumerable:!0,configurable:!0}),__decorate([t.requireSetter(function(e){e.forEach(function(e){t.assert(e.minHeight<e.maxHeight,t.Log.info.FUNC_SHOULD("minHeight","< maxHeight"))}),e.forEach(function(r){e.filter(function(t){return t.minHeight!==r.minHeight||t.maxHeight!==r.maxHeight}).forEach(function(e){t.assert(r.minHeight>=e.maxHeight||r.maxHeight<=e.minHeight,t.Log.info.FUNC_SHOULD_NOT("height range","overlap"))})})})],e.prototype,"mapDataList",null),__decorate([t.ensureGetter(function(e){for(var r=0,n=e;r<n.length;r++){var o=n[r];t.assert(o instanceof t.Texture,t.Log.info.FUNC_SHOULD("return Array<Texture>"))}})],e.prototype,"mapArray",null),e}();t.Layer=r}(wd||(wd={}));var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},__decorate=this&&this.__decorate||function(t,e,r,n){var o,i=arguments.length,a=3>i?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,r,n);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>i?o(a):i>3?o(e,r,a):o(e,r))||a);return i>3&&a&&Object.defineProperty(e,r,a),a},wd;!function(t){var e=function(e){function r(){e.apply(this,arguments),this.type="terrainLayer"}return __extends(r,e),r.create=function(){var t=new this;return t},r.prototype.sendShaderVariables=function(e,r,n){n.layer.mapDataList.forEach(function(r,n){e.sendStructureData("u_layerHeightDatas["+n+"].minHeight",t.EVariableType.FLOAT_1,r.minHeight),e.sendStructureData("u_layerHeightDatas["+n+"].maxHeight",t.EVariableType.FLOAT_1,r.maxHeight)})},r.prototype.setShaderDefinition=function(t,r){e.prototype.setShaderDefinition.call(this,t,r),this.addUniformVariable(["u_layerHeightDatas","u_layerSampler2Ds"]),this.fsSourceDefineList.addChildren([{name:"LAYER_COUNT",value:r.layer.mapDataList.getCount()}])},__decorate([t.require(function(e,r){t.assert(!!r,t.Log.info.FUNC_NOT_EXIST("param:material")),t.assert(r.layer.mapDataList.getCount()>=0,t.Log.info.FUNC_SHOULD("TerrainMaterial->layer->mapDataList->count",">= 0"))})],r.prototype,"setShaderDefinition",null),r}(t.EngineShaderLib);t.TerrainLayerShaderLib=e}(wd||(wd={}));var wd;!function(t){var e=function(){function t(){}return t.empty={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.NULL=-1,t.morphNormal_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 a_normal = a_currentFrameNormal + (a_nextFrameNormal - a_currentFrameNormal) * u_interpolation;\n"},t.morphVertice_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 a_position = a_currentFramePosition + (a_nextFramePosition - a_currentFramePosition) * u_interpolation;\n"},t.basicEnd_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragColor = vec4(totalColor.rgb, totalColor.a * u_opacity);\n"},t.basic_fragment={top:"",define:"",varDeclare:"varying vec3 v_color;\n",funcDeclare:"",funcDefine:"",body:"vec4 totalColor = vec4(v_color, 1.0);\n"},t.basic_vertex={top:"",define:"",varDeclare:"varying vec3 v_color;\n",funcDeclare:"",funcDefine:"",body:"v_color = a_color;\n"},t.common_define={top:"",define:"#define NULL -1.0\n",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.common_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.common_function={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"mat2 transpose(mat2 m) {\n  return mat2(  m[0][0], m[1][0],   // new col 0\n                m[0][1], m[1][1]    // new col 1\n             );\n  }\nmat3 transpose(mat3 m) {\n  return mat3(  m[0][0], m[1][0], m[2][0],  // new col 0\n                m[0][1], m[1][1], m[2][1],  // new col 1\n                m[0][2], m[1][2], m[2][2]   // new col 1\n             );\n  }\n",body:""},t.common_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.highp_fragment={top:"precision highp float;\nprecision highp int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.lowp_fragment={top:"precision lowp float;\nprecision lowp int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.mediump_fragment={top:"precision mediump float;\nprecision mediump int;\n",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.lightCommon_fragment={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n#if POINT_LIGHTS_COUNT > 0\nstruct PointLight {\n    vec3 position;\n    vec4 color;\n    float intensity;\n\n    float range;\n    float constant;\n    float linear;\n    float quadratic;\n};\nuniform PointLight u_pointLights[POINT_LIGHTS_COUNT];\n\n#endif\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\nstruct DirectionLight {\n    vec3 position;\n\n    float intensity;\n\n    vec4 color;\n};\nuniform DirectionLight u_directionLights[DIRECTION_LIGHTS_COUNT];\n#endif\n",funcDeclare:"",funcDefine:"",body:""},t.lightCommon_vertex={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n#if POINT_LIGHTS_COUNT > 0\nstruct PointLight {\n    vec3 position;\n    vec4 color;\n    float intensity;\n\n    float range;\n    float constant;\n    float linear;\n    float quadratic;\n};\nuniform PointLight u_pointLights[POINT_LIGHTS_COUNT];\n\n#endif\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\nstruct DirectionLight {\n    vec3 position;\n\n    float intensity;\n\n    vec4 color;\n};\nuniform DirectionLight u_directionLights[DIRECTION_LIGHTS_COUNT];\n#endif\n",funcDeclare:"",funcDefine:"",body:"v_worldPosition = vec3(u_mMatrix * vec4(a_position, 1.0));\n"},t.lightEnd_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragColor = vec4(totalColor.rgb, totalColor.a * u_opacity);\n"},t.light_common={top:"",define:"",varDeclare:"",funcDeclare:"vec3 getDirectionLightDirByLightPos(vec3 lightPos);\nvec3 getPointLightDirByLightPos(vec3 lightPos);\nvec3 getPointLightDirByLightPos(vec3 lightPos, vec3 worldPosition);\n",funcDefine:"vec3 getDirectionLightDirByLightPos(vec3 lightPos){\n    return lightPos - vec3(0.0);\n    //return vec3(0.0) - lightPos;\n}\nvec3 getPointLightDirByLightPos(vec3 lightPos){\n    return lightPos - v_worldPosition;\n}\nvec3 getPointLightDirByLightPos(vec3 lightPos, vec3 worldPosition){\n    return lightPos - worldPosition;\n}\n",body:""},t.light_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float getBlinnShininess(float shininess, vec3 normal, vec3 lightDir, vec3 viewDir, float dotResultBetweenNormAndLight){\n        vec3 halfAngle = normalize(lightDir + viewDir);\n        float blinnTerm = dot(normal, halfAngle);\n\n        blinnTerm = clamp(blinnTerm, 0.0, 1.0);\n        blinnTerm = dotResultBetweenNormAndLight != 0.0 ? blinnTerm : 0.0;\n        blinnTerm = pow(blinnTerm, shininess);\n\n        return blinnTerm;\n}\n\nfloat getPhongShininess(float shininess, vec3 normal, vec3 lightDir, vec3 viewDir, float dotResultBetweenNormAndLight){\n        vec3 reflectDir = reflect(-lightDir, normal);\n        float phongTerm = dot(viewDir, reflectDir);\n\n        phongTerm = clamp(phongTerm, 0.0, 1.0);\n        phongTerm = dotResultBetweenNormAndLight != 0.0 ? phongTerm : 0.0;\n        phongTerm = pow(phongTerm, shininess);\n\n        return phongTerm;\n}\n\nvec4 calcLight(vec3 lightDir, vec4 color, float intensity, float attenuation, vec3 normal, vec3 viewDir)\n{\n        vec4 materialLight = getMaterialLight();\n        vec4 materialDiffuse = getMaterialDiffuse();\n        vec4 materialSpecular = getMaterialSpecular();\n        vec4 materialEmission = getMaterialEmission();\n\n        float dotResultBetweenNormAndLight = dot(normal, lightDir);\n        float diff = max(dotResultBetweenNormAndLight, 0.0);\n\n        vec4 emissionColor = materialEmission;\n\n        vec4 ambientColor = (u_ambient + materialLight) * materialDiffuse;\n\n\n        if(u_lightModel == 3){\n            return emissionColor + ambientColor;\n        }\n\n\n        vec4 diffuseColor = color * materialDiffuse * intensity;\n\n        diffuseColor = vec4(diff * vec3(diffuseColor), diffuseColor.a);\n\n\n        float spec = 0.0;\n\n        if(u_lightModel == 2){\n                spec = getPhongShininess(u_shininess, normal, lightDir, viewDir, diff);\n        }\n        else if(u_lightModel == 1){\n                spec = getBlinnShininess(u_shininess, normal, lightDir, viewDir, diff);\n        }\n\n        vec4 specularColor = spec * materialSpecular * intensity;\n\n\n        return emissionColor + ambientColor + attenuation * (diffuseColor + specularColor);\n}\n\n\n\n\n\n#if POINT_LIGHTS_COUNT > 0\n        vec4 calcPointLight(vec3 lightDir, PointLight light, vec3 normal, vec3 viewDir)\n{\n        //lightDir is not normalize computing distance\n        float distance = length(lightDir);\n\n        float attenuation = 0.0;\n\n        if(light.range == NULL || distance < light.range)\n        {\n            attenuation = 1.0 / (light.constant + light.linear * distance + light.quadratic * (distance * distance));\n        }\n\n        lightDir = normalize(lightDir);\n\n        return calcLight(lightDir, light.color, light.intensity, attenuation, normal, viewDir);\n}\n#endif\n\n\n\n#if DIRECTION_LIGHTS_COUNT > 0\n        vec4 calcDirectionLight(vec3 lightDir, DirectionLight light, vec3 normal, vec3 viewDir)\n{\n        float attenuation = 1.0;\n\n        lightDir = normalize(lightDir);\n\n        return calcLight(lightDir, light.color, light.intensity, attenuation, normal, viewDir);\n}\n#endif\n\n\n\nvec4 calcTotalLight(vec3 norm, vec3 viewDir){\n    vec4 totalLight = vec4(0.0);\n\n    #if POINT_LIGHTS_COUNT > 0\n                for(int i = 0; i < POINT_LIGHTS_COUNT; i++){\n                totalLight += calcPointLight(getPointLightDir(i), u_pointLights[i], norm, viewDir);\n        }\n    #endif\n\n    #if DIRECTION_LIGHTS_COUNT > 0\n                for(int i = 0; i < DIRECTION_LIGHTS_COUNT; i++){\n                totalLight += calcDirectionLight(getDirectionLightDir(i), u_directionLights[i], norm, viewDir);\n        }\n    #endif\n\n        return totalLight;\n}\n",
body:"vec3 normal = normalize(getNormal());\n\n#ifdef BOTH_SIDE\nnormal = normal * (-1.0 + 2.0 * float(gl_FrontFacing));\n#endif\n\nvec3 viewDir = normalize(getViewDir());\n\nvec4 totalColor = calcTotalLight(normal, viewDir);\n\ntotalColor *= vec4(getShadowVisibility(), 1.0);\n"},t.light_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_Position = u_pMatrix * u_vMatrix * vec4(v_worldPosition, 1.0);\n"},t.map_forBasic_fragment={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= vec4(texture2D(u_sampler2D0, v_mapCoord0).xyz, 1.0);\n"},t.map_forBasic_vertex={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord0 = a_texCoord * u_map0SourceRegion.zw + u_map0SourceRegion.xy;\n\n    v_mapCoord0 = sourceTexCoord0 * u_map0RepeatRegion.zw + u_map0RepeatRegion.xy;\n"},t.multi_map_forBasic_fragment={top:"",define:"",varDeclare:"varying vec2 v_mapCoord0;\nvarying vec2 v_mapCoord1;\n",funcDeclare:"",funcDefine:"vec4 getMapColor(){\n            vec4 color0 = vec4(texture2D(u_sampler2D0, v_mapCoord0).xyz, 1.0);\n            vec4 color1 = vec4(texture2D(u_sampler2D1, v_mapCoord1).xyz, 1.0);\n\n            if(u_combineMode == 0){\n                return mix(color0, color1, u_mixRatio);\n            }\n            else if(u_combineMode == 1){\n                return color0 * color1;\n            }\n            else if(u_combineMode == 2){\n                return color0 + color1;\n            }\n		}\n",body:"totalColor *= getMapColor();\n"},t.multi_map_forBasic_vertex={top:"",define:"",varDeclare:"varying vec2 v_mapCoord1;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord1 = a_texCoord * u_map1SourceRegion.zw + u_map1SourceRegion.xy;\n\n    v_mapCoord1 = sourceTexCoord1 * u_map1RepeatRegion.zw + u_map1RepeatRegion.xy;\n"},t.mirror_forBasic_fragment={top:"",define:"",varDeclare:"varying vec4 v_mirrorCoord;\n",funcDeclare:"",funcDefine:"//todo add more blend way to mix mirror color and textureColor\n		float blendOverlay(float base, float blend) {\n			return( base < 0.5 ? ( 2.0 * base * blend ) : (1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n		}\n		vec4 getMirrorColor(in vec4 materialColor){\n			vec4 color = texture2DProj(u_mirrorSampler, v_mirrorCoord);\n\n			color = vec4(blendOverlay(materialColor.r, color.r), blendOverlay(materialColor.g, color.g), blendOverlay(materialColor.b, color.b), 1.0);\n\n			return color;\n		}\n",body:"totalColor = getMirrorColor(totalColor);\n"},t.mirror_forBasic_vertex={top:"",define:"",varDeclare:"varying vec4 v_mirrorCoord;\n",funcDeclare:"",funcDefine:"",body:"mat4 textureMatrix = mat4(\n                        0.5, 0.0, 0.0, 0.0,\n                        0.0, 0.5, 0.0, 0.0,\n                        0.0, 0.0, 0.5, 0.0,\n                        0.5, 0.5, 0.5, 1.0\n);\n\nv_mirrorCoord = textureMatrix * gl_Position;\n"},t.skybox_fragment={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"gl_FragColor = textureCube(u_samplerCube0, v_dir);\n"},t.skybox_vertex={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"vec4 pos = u_pMatrix * mat4(mat3(u_vMatrix)) * u_mMatrix * vec4(a_position, 1.0);\n\n    gl_Position = pos.xyww;\n\n    v_dir = a_position;\n"},t.diffuseMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_diffuseMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialDiffuse() {\n        return texture2D(u_diffuseMapSampler, v_diffuseMapTexCoord);\n    }\n",body:""},t.diffuseMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_diffuseMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"vec2 sourceTexCoord = a_texCoord * u_diffuseSourceRegion.zw + u_diffuseSourceRegion.xy;\n    v_diffuseMapTexCoord = sourceTexCoord * u_diffuseRepeatRegion.zw + u_diffuseRepeatRegion.xy;\n"},t.emissionMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_emissionMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialEmission() {\n        return texture2D(u_emissionMapSampler, v_emissionMapTexCoord);\n    }\n",body:""},t.emissionMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_emissionMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_emissionMapTexCoord = a_texCoord;\n"},t.lightMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_lightMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialLight() {\n        return texture2D(u_lightMapSampler, v_lightMapTexCoord) * u_lightMapIntensity;\n    }\n",body:""},t.lightMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_lightMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_lightMapTexCoord = a_texCoord;\n"},t.noDiffuseMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialDiffuse() {\n        return u_diffuse;\n    }\n",body:""},t.noEmissionMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialEmission() {\n        return u_emission;\n    }\n",body:""},t.noLightMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialLight() {\n        return vec4(0.0);\n    }\n",body:""},t.noNormalMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_normal;\n",funcDeclare:"vec3 getNormal();\n\n",funcDefine:"#if POINT_LIGHTS_COUNT > 0\nvec3 getPointLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return getPointLightDirByLightPos(u_pointLights[x].position);\n        }\n    }\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvec3 getDirectionLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return getDirectionLightDirByLightPos(u_directionLights[x].position);\n        }\n    }\n\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n\nvec3 getViewDir(){\n    return normalize(u_cameraPos - v_worldPosition);\n}\nvec3 getNormal(){\n    return v_normal;\n}\n\n",body:""},t.noNormalMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_normal;\n",funcDeclare:"",funcDefine:"",body:"//v_normal = normalize( vec3(u_normalMatrix * vec4(a_normal, 1.0)));\n    v_normal = normalize( u_normalMatrix * a_normal);\n"},t.noSpecularMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec4 getMaterialSpecular() {\n        return u_specular;\n    }\n",body:""},t.normalMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_normalMapTexCoord;\nvarying vec3 v_viewDir;\n#if POINT_LIGHTS_COUNT > 0\nvarying vec3 v_pointLightDir[POINT_LIGHTS_COUNT];\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvarying vec3 v_directionLightDir[DIRECTION_LIGHTS_COUNT];\n#endif\n\n",funcDeclare:"vec3 getNormal();\n\nvec3 getLightDir(vec3 lightPos);\n\n",funcDefine:"#if POINT_LIGHTS_COUNT > 0\nvec3 getPointLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= POINT_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return v_pointLightDir[x];\n        }\n    }\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\n\nvec3 getDirectionLightDir(int index){\n    //workaround '[] : Index expression must be constant' error\n    for (int x = 0; x <= DIRECTION_LIGHTS_COUNT; x++) {\n        if(x == index){\n            return v_directionLightDir[x];\n        }\n    }\n\n    /*!\n    solve error in window7 chrome/firefox:\n    not all control paths return a value.\n    failed to create d3d shaders\n    */\n    return vec3(0.0);\n}\n#endif\n\n\nvec3 getViewDir(){\n    return v_viewDir;\n}\nvec3 getNormal(){\n        // Obtain normal from normal map in range [0,1]\n        vec3 normal = texture2D(u_normalMapSampler, v_normalMapTexCoord).rgb;\n\n        // Transform normal vector to range [-1,1]\n        return normalize(normal * 2.0 - 1.0);  // this normal is in tangent space\n}\n",body:""},t.normalMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_normalMapTexCoord;\n	varying vec3 v_viewDir;\n\n\n#if POINT_LIGHTS_COUNT > 0\nvarying vec3 v_pointLightDir[POINT_LIGHTS_COUNT];\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\nvarying vec3 v_directionLightDir[DIRECTION_LIGHTS_COUNT];\n#endif\n\n",funcDeclare:"",funcDefine:"mat3 computeTBN(){\n            //vec3 T = normalize(normalMatrix * tangent);\n            //vec3 B = normalize(normalMatrix * bitangent);\n            //vec3 N = normalize(normalMatrix * normal);\n\n            vec3 T = normalize(u_normalMatrix * a_tangent);\n            vec3 N = normalize(u_normalMatrix * a_normal);\n            // re-orthogonalize T with respect to N\n            T = normalize(T - dot(T, N) * N);\n            // then retrieve perpendicular vector B with the cross product of T and N\n            vec3 B = cross(T, N);\n\n\n            return transpose(mat3(T, B, N));\n        }\n",body:"mat3 TBN = computeTBN();\n\n    //v_tangentLightPos = TBN * light.position;\n    //v_tangentCameraPos  = TBN * u_cameraPos;\n    //v_tangentPos  = TBN * v_position;\n\n\n    vec3 tangentPosition = TBN * vec3(u_mMatrix * vec4(a_position, 1.0));\n\n    v_normalMapTexCoord = a_texCoord;\n\n    v_viewDir = normalize(TBN * u_cameraPos - tangentPosition);\n\n\n#if POINT_LIGHTS_COUNT > 0\n       for(int i = 0; i < POINT_LIGHTS_COUNT; i++){\n            //not normalize for computing distance\n            v_pointLightDir[i] = TBN * getPointLightDirByLightPos(u_pointLights[i].position, tangentPosition);\n       }\n#endif\n\n#if DIRECTION_LIGHTS_COUNT > 0\n       for(int i = 0; i < DIRECTION_LIGHTS_COUNT; i++){\n            v_directionLightDir[i] = normalize(- TBN * getDirectionLightDirByLightPos(u_directionLights[i].position));\n       }\n#endif\n\n"},t.specularMap_fragment={top:"",define:"",varDeclare:"varying vec2 v_specularMapTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getMaterialSpecular() {\n        return texture2D(u_specularMapSampler, v_specularMapTexCoord);\n    }\n",body:""},t.specularMap_vertex={top:"",define:"",varDeclare:"varying vec2 v_specularMapTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_specularMapTexCoord = a_texCoord;\n"},t.basic_envMap_forBasic_fragment={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, v_dir);\n"},t.basic_envMap_forBasic_vertex={top:"",define:"",varDeclare:"varying vec3 v_dir;\n",funcDeclare:"",funcDefine:"",body:"v_dir = a_position;\n"},t.envMap_forBasic_fragment={top:"",define:"",varDeclare:"varying vec3 v_normal;\nvarying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"vec3 inDir = normalize(v_position - u_cameraPos);\n"},t.envMap_forBasic_vertex={top:"",define:"",varDeclare:"varying vec3 v_normal;\nvarying vec3 v_position;\n",funcDeclare:"",funcDefine:"",body:"v_normal = normalize( u_normalMatrix * a_normal);\n    v_position = vec3(u_mMatrix * vec4(a_position, 1.0));\n"},t.fresnel_forBasic_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float computeFresnelRatio(vec3 inDir, vec3 normal, float refractionRatio){\n    float f = pow(1.0 - refractionRatio, 2.0) / pow(1.0 + refractionRatio, 2.0);\n    float fresnelPower = 5.0;\n    float ratio = f + (1.0 - f) * pow((1.0 - dot(inDir, normal)), fresnelPower);\n\n    return ratio / 100.0;\n}\nvec4 getEnvMapTotalColor(vec3 inDir, vec3 normal){\n    vec3 reflectDir = reflect(inDir, normal);\n    vec3 refractDir = refract(inDir, normal, u_refractionRatio);\n\n    vec4 reflectColor = textureCube(u_samplerCube0, reflectDir);\n    vec4 refractColor = textureCube(u_samplerCube0, refractDir);\n\n    vec4 totalColor = vec4(0.0);\n\n	if(u_reflectivity != NULL){\n        totalColor = mix(reflectColor, refractColor, u_reflectivity);\n	}\n	else{\n        totalColor = mix(reflectColor, refractColor, computeFresnelRatio(inDir, normal, u_refractionRatio));\n	}\n\n	return totalColor;\n}\n",body:"totalColor *= getEnvMapTotalColor(inDir, normalize(v_normal));\n"},t.reflection_forBasic_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, reflect(inDir, normalize(v_normal)));\n"},t.refraction_forBasic_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, refract(inDir, normalize(v_normal), u_refractionRatio));\n"},t.buildCubemapShadowMap_fragment={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n",funcDeclare:"",funcDefine:"",body:"\n// get distance between fragment and light source\n    float lightDistance = length(v_worldPosition - u_lightPos);\n\n    // map to [0,1] range by dividing by farPlane\n    lightDistance = lightDistance / u_farPlane;\n\n\ngl_FragData[0] = packDepth(lightDistance);\n\n\n//gl_FragColor = vec4(0.5, 0.0, 1.0, 1.0);\n//gl_FragData[0] = vec4(lightDistance, 1.0, 1.0, 1.0);\n"},t.buildCubemapShadowMap_vertex={top:"",define:"",varDeclare:"varying vec3 v_worldPosition;\n",funcDeclare:"",funcDefine:"",body:"v_worldPosition = vec3(u_mMatrix * vec4(a_position, 1.0));\n    gl_Position = u_pMatrix * u_vMatrix * vec4(v_worldPosition, 1.0);\n"},t.buildTwoDShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_FragData[0] = packDepth(gl_FragCoord.z);\n"},t.buildTwoDShadowMap_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"gl_Position = u_vpMatrixFromLight * u_mMatrix * vec4(a_position, 1.0);\n//gl_Position = u_pMatrix* u_vMatrix * u_mMatrix * vec4(a_position, 1.0);\n"},t.commonBuildShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"// Packing a float in GLSL with multiplication and mod\nvec4 packDepth(in float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n\n    return res;\n}\n",body:""},t.cubemapShadowMap_fragment={top:"",define:"",varDeclare:"uniform samplerCube u_cubemapShadowMapSampler[ CUBEMAP_SHADOWMAP_COUNT ];\n	uniform float u_cubemapShadowDarkness[ CUBEMAP_SHADOWMAP_COUNT ];\n	uniform float u_cubemapShadowBias[ CUBEMAP_SHADOWMAP_COUNT ];\n	uniform float u_farPlane[ CUBEMAP_SHADOWMAP_COUNT ];\n	uniform vec3 u_cubemapLightPos[ CUBEMAP_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"// PCF\nfloat getCubemapShadowVisibilityByPCF(float currentDepth, vec3 fragToLight, samplerCube cubemapShadowMapSampler, float shadowBias, float farPlane, float shadowDarkness){\n    //only support in opengl es 3.0+\n    //vec3 sampleOffsetDirections[20] = vec3[]\n    //(\n       //vec3( 1,  1,  1), vec3( 1, -1,  1), vec3(-1, -1,  1), vec3(-1,  1,  1),\n       //vec3( 1,  1, -1), vec3( 1, -1, -1), vec3(-1, -1, -1), vec3(-1,  1, -1),\n       //vec3( 1,  1,  0), vec3( 1, -1,  0), vec3(-1, -1,  0), vec3(-1,  1,  0),\n       //vec3( 1,  0,  1), vec3(-1,  0,  1), vec3( 1,  0, -1), vec3(-1,  0, -1),\n       //vec3( 0,  1,  1), vec3( 0, -1,  1), vec3( 0, -1, -1), vec3( 0,  1, -1)\n    //);\n\n    vec3 sampleOffsetDirections[20];\n\n    sampleOffsetDirections[0] = vec3( 1,  1,  1);\n    sampleOffsetDirections[1] = vec3( 1,  -1,  1);\n    sampleOffsetDirections[2] = vec3( -1,  -1,  1);\n    sampleOffsetDirections[3] = vec3( -1,  1,  1);\n\n    sampleOffsetDirections[4] = vec3( 1,  1,  -1);\n    sampleOffsetDirections[5] = vec3( 1,  -1,  -1);\n    sampleOffsetDirections[6] = vec3( -1,  -1,  -1);\n    sampleOffsetDirections[7] = vec3( -1,  1,  -1);\n\n    sampleOffsetDirections[8] = vec3( 1,  1,  0);\n    sampleOffsetDirections[9] = vec3( 1,  -1,  0);\n    sampleOffsetDirections[10] = vec3( -1,  -1,  0);\n    sampleOffsetDirections[11] = vec3( -1,  1,  0);\n\n    sampleOffsetDirections[12] = vec3( 1,  0,  1);\n    sampleOffsetDirections[13] = vec3( -1,  0,  1);\n    sampleOffsetDirections[14] = vec3( 1,  0,  -1);\n    sampleOffsetDirections[15] = vec3( -1,  0,  -1);\n\n    sampleOffsetDirections[16] = vec3( 0,  1,  1);\n    sampleOffsetDirections[17] = vec3( 0,  -1,  1);\n    sampleOffsetDirections[18] = vec3( 0,  -1,  -1);\n    sampleOffsetDirections[19] = vec3( 0,  1,  -1);\n\n    float shadow = 0.0;\n    int samples = 20;\n\n    //float diskRadius = 0.00000;\n    //Another interesting trick we can apply here is that we can change the diskRadius based on how far the viewer is away from a fragment; this way we can increase the offset radius by the distance to the viewer, making the shadows softer when far away and sharper when close by.\n    float viewDistance = length(u_cameraPos - v_worldPosition);\n    float diskRadius = (1.0 + (viewDistance / farPlane)) / 25.0;\n\n    //for(int i = 0; i < samples; ++i)\n    for(int i = 0; i < 20; ++i)\n    {\n        float pcfDepth = unpackDepth(textureCube(cubemapShadowMapSampler, fragToLight + sampleOffsetDirections[i] * diskRadius));\n        pcfDepth *= farPlane;   // Undo mapping [0;1]\n        shadow += currentDepth - shadowBias > pcfDepth  ? shadowDarkness : 1.0;\n    }\n    shadow /= float(samples);\n\n    return shadow;\n}\n\n\nfloat getCubemapShadowVisibility(vec3 lightDir, samplerCube cubemapShadowMapSampler, vec3 lightPos, float farPlane, float shadowBias, float  shadowDarkness) {\n// Get vector between fragment position and light position\n    vec3 fragToLight= v_worldPosition - lightPos;\n    // Use the light to fragment vector to sample from the depth map\n    // Now get current linear depth as the length between the fragment and light position\n    float currentDepth = length(fragToLight);\n\n    #if defined(SHADOWMAP_TYPE_PCF)\n    return getCubemapShadowVisibilityByPCF(currentDepth, fragToLight, cubemapShadowMapSampler, getShadowBias(lightDir, shadowBias), farPlane, shadowDarkness);\n    #endif\n\n    float closestDepth = unpackDepth(textureCube(cubemapShadowMapSampler, fragToLight));\n\n    // It is currently in linear range between [0,1]. Re-transform back to original value\n    closestDepth *= farPlane;\n\n\n    return float(currentDepth > closestDepth + getShadowBias(lightDir, shadowBias) ? shadowDarkness : 1.0);\n}\n",body:""},t.noShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"vec3 getShadowVisibility() {\n        return vec3(1.0);\n    }\n",body:""},t.totalShadowMap_fragment={top:"",define:"",varDeclare:"",funcDeclare:"float getShadowBias(vec3 lightDir, float shadowBias);\nfloat unpackDepth(vec4 rgbaDepth);\n",funcDefine:"float getShadowBias(vec3 lightDir, float shadowBias){\n    float bias = shadowBias;\n\n    if(shadowBias == NULL){\n        bias = 0.005;\n    }\n\n\n     /*!\n     A shadow bias of 0.005 solves the issues of our scene by a large extent, but some surfaces that have a steep angle to the light source might still produce shadow acne. A more solid approach would be to change the amount of bias based on the surface angle towards the light: something we can solve with the dot product:\n     */\n\n     return max(bias * (1.0 - dot(normalize(getNormal()), lightDir)), bias);\n\n    //return bias;\n}\n\nfloat unpackDepth(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n\nvec3 getShadowVisibility() {\n    vec3 shadowColor = vec3(1.0);\n    vec3 twoDLightDir = vec3(0.0);\n    vec3 cubemapLightDir = vec3(0.0);\n\n\n    //to normalMap, the lightDir use the origin one instead of normalMap's lightDir here(the lightDir is used for computing shadowBias, the origin one is enough for it)\n\n    #if TWOD_SHADOWMAP_COUNT > 0\n	for( int i = 0; i < TWOD_SHADOWMAP_COUNT; i ++ ) {\n        twoDLightDir = getDirectionLightDirByLightPos(u_twoDLightPos[i]);\n\n	////if is opposite to direction of light rays, no shadow\n\n        shadowColor *= getTwoDShadowVisibility(twoDLightDir, u_twoDShadowMapSampler[i], v_positionFromLight[i], u_twoDShadowBias[i], u_twoDShadowDarkness[i], u_twoDShadowSize[i]);\n	}\n	#endif\n\n\n	#if CUBEMAP_SHADOWMAP_COUNT > 0\n	for( int i = 0; i < CUBEMAP_SHADOWMAP_COUNT; i ++ ) {\n        cubemapLightDir = getPointLightDirByLightPos(u_cubemapLightPos[i]);\n\n	////if is opposite to direction of light rays, no shadow\n\n        shadowColor *= getCubemapShadowVisibility(cubemapLightDir, u_cubemapShadowMapSampler[i], u_cubemapLightPos[i], u_farPlane[i], u_cubemapShadowBias[i], u_cubemapShadowDarkness[i]);\n	}\n	#endif\n\n	return shadowColor;\n}\n\n",body:""},t.twoDShadowMap_fragment={top:"",define:"",varDeclare:"varying vec4 v_positionFromLight[ TWOD_SHADOWMAP_COUNT ];\n	uniform sampler2D u_twoDShadowMapSampler[ TWOD_SHADOWMAP_COUNT ];\n	uniform float u_twoDShadowDarkness[ TWOD_SHADOWMAP_COUNT ];\n	uniform float u_twoDShadowBias[ TWOD_SHADOWMAP_COUNT ];\n	uniform vec2 u_twoDShadowSize[ TWOD_SHADOWMAP_COUNT ];\n	uniform vec3 u_twoDLightPos[ TWOD_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"// PCF\nfloat getTwoDShadowVisibilityByPCF(float currentDepth, vec2 shadowCoord, sampler2D twoDShadowMapSampler, float shadowBias, float shadowDarkness, vec2 shadowMapSize){\n\n    float shadow = 0.0;\n    vec2 texelSize = vec2(1.0 / shadowMapSize[0], 1.0 / shadowMapSize[1]);\n\n    for(int x = -1; x <= 1; ++x)\n    {\n        for(int y = -1; y <= 1; ++y)\n        {\n            float pcfDepth = unpackDepth(texture2D(twoDShadowMapSampler, shadowCoord + vec2(x, y) * texelSize));\n            shadow += currentDepth - shadowBias > pcfDepth  ? shadowDarkness : 1.0;\n        }\n    }\n    shadow /= 9.0;\n\n    return shadow;\n}\n\n\n\nfloat getTwoDShadowVisibility(vec3 lightDir, sampler2D twoDShadowMapSampler, vec4 v_positionFromLight, float shadowBias, float shadowDarkness, vec2 shadowSize) {\n    //project texture\n    vec3 shadowCoord = (v_positionFromLight.xyz / v_positionFromLight.w) / 2.0 + 0.5;\n    //vec3 shadowCoord = vec3(0.5, 0.5, 0.5);\n\n    #ifdef SHADOWMAP_TYPE_PCF\n    // Percentage-close filtering\n    // (9 pixel kernel)\n    return getTwoDShadowVisibilityByPCF(shadowCoord.z, shadowCoord.xy, twoDShadowMapSampler, getShadowBias(lightDir, shadowBias), shadowDarkness, shadowSize);\n\n    #else\n    return shadowCoord.z > unpackDepth(texture2D(twoDShadowMapSampler, shadowCoord.xy)) + getShadowBias(lightDir, shadowBias) ? shadowDarkness : 1.0;\n    #endif\n}\n",body:""},t.twoDShadowMap_vertex={top:"",define:"",varDeclare:"varying vec4 v_positionFromLight[ TWOD_SHADOWMAP_COUNT ];\nuniform mat4 u_vpMatrixFromLight[ TWOD_SHADOWMAP_COUNT ];\n",funcDeclare:"",funcDefine:"",body:"for( int i = 0; i < TWOD_SHADOWMAP_COUNT; i ++ ) {\n    v_positionFromLight[i] = u_vpMatrixFromLight[i] * vec4(v_worldPosition, 1.0);\n	}\n"},t.basic_envMap_forLight_fragment={top:"",define:"",varDeclare:"varying vec3 v_basicEnvMap_dir;\n",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, v_basicEnvMap_dir);\n"},t.basic_envMap_forLight_vertex={top:"",define:"",varDeclare:"varying vec3 v_basicEnvMap_dir;\n",funcDeclare:"",funcDefine:"",body:"v_basicEnvMap_dir = a_position;\n"},t.envMap_forLight_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"vec3 inDir = normalize(v_worldPosition - u_cameraPos);\n"},t.envMap_forLight_vertex={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:""},t.fresnel_forLight_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float computeFresnelRatio(vec3 inDir, vec3 normal, float refractionRatio){\n    float f = pow(1.0 - refractionRatio, 2.0) / pow(1.0 + refractionRatio, 2.0);\n    float fresnelPower = 5.0;\n    float ratio = f + (1.0 - f) * pow((1.0 - dot(inDir, normal)), fresnelPower);\n\n    return ratio / 100.0;\n}\n\nvec4 getEnvMapTotalColor(vec3 inDir, vec3 normal){\n    vec3 reflectDir = reflect(inDir, normal);\n    vec3 refractDir = refract(inDir, normal, u_refractionRatio);\n\n    vec4 reflectColor = textureCube(u_samplerCube0, reflectDir);\n    vec4 refractColor = textureCube(u_samplerCube0, refractDir);\n\n    vec4 totalColor = vec4(0.0);\n\n	if(u_reflectivity != NULL){\n        totalColor = mix(reflectColor, refractColor, u_reflectivity);\n	}\n	else{\n        totalColor = mix(reflectColor, refractColor, computeFresnelRatio(inDir, normal, u_refractionRatio));\n	}\n\n	return totalColor;\n}\n",body:"totalColor *= getEnvMapTotalColor(inDir, normalize(getNormal()));\n"},t.reflection_forLight_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, reflect(inDir, normalize(getNormal())));\n"},t.refraction_forLight_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"",body:"totalColor *= textureCube(u_samplerCube0, refract(inDir, getNormal(), u_refractionRatio));\n"},t.terrainLayer_fragment={top:"",define:"",varDeclare:"struct LayerHeightData {\n    float minHeight;\n    float maxHeight;\n};\nuniform LayerHeightData u_layerHeightDatas[LAYER_COUNT];\n//sampler2D can't be contained in struct\nuniform sampler2D u_layerSampler2Ds[LAYER_COUNT];\n\n\nvarying vec2 v_layerTexCoord;\n",funcDeclare:"",funcDefine:"vec4 getLayerTextureColor(in sampler2D layerSampler2Ds[LAYER_COUNT], in LayerHeightData layerHeightDatas[LAYER_COUNT]){\n    vec4 color = vec4(0.0);\n    bool isInLayer = false;\n\n    float height = v_worldPosition.y;\n\n    for(int i = 0; i < LAYER_COUNT; i++){\n        if(height >= layerHeightDatas[i].minHeight && height <= layerHeightDatas[i].maxHeight){\n            //todo blend color\n            color += texture2D(layerSampler2Ds[i], v_layerTexCoord);\n\n            isInLayer = true;\n\n            break;\n        }\n    }\n\n    return isInLayer ? color : vec4(1.0);\n}\n",body:"\ntotalColor *= getLayerTextureColor(u_layerSampler2Ds, u_layerHeightDatas);\n"},t.terrainLayer_vertex={top:"",define:"",varDeclare:"varying vec2 v_layerTexCoord;\n",funcDeclare:"",funcDefine:"",body:"v_layerTexCoord = a_texCoord;\n"},t.cloud_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"gl_FragColor = mix(u_skyColor, u_cloudColor, fbm(v_texCoord * 12.0));\n"},t.brick_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"float brickW = 1.0 / u_tilesWidthNumber;\n	float brickH = 1.0 / u_tilesWidthNumber;\n	float jointWPercentage = 0.01;\n	float jointHPercentage = 0.05;\n	vec3 color = u_brickColor;\n	float yi = v_texCoord.y / brickH;\n	float nyi = round(yi);\n	float xi = v_texCoord.x / brickW;\n\n	if (mod(floor(yi), 2.0) == 0.0){\n		xi = xi - 0.5;\n	}\n\n	float nxi = round(xi);\n	vec2 brickv_texCoord = vec2((xi - floor(xi)) / brickH, (yi - floor(yi)) /  brickW);\n\n	if (yi < nyi + jointHPercentage && yi > nyi - jointHPercentage){\n		color = mix(u_jointColor, vec3(0.37, 0.25, 0.25), (yi - nyi) / jointHPercentage + 0.2);\n	}\n	else if (xi < nxi + jointWPercentage && xi > nxi - jointWPercentage){\n		color = mix(u_jointColor, vec3(0.44, 0.44, 0.44), (xi - nxi) / jointWPercentage + 0.2);\n	}\n	else {\n		float u_brickColorSwitch = mod(floor(yi) + floor(xi), 3.0);\n\n		if (u_brickColorSwitch == 0.0)\n			color = mix(color, vec3(0.33, 0.33, 0.33), 0.3);\n		else if (u_brickColorSwitch == 2.0)\n			color = mix(color, vec3(0.11, 0.11, 0.11), 0.3);\n	}\n\n	gl_FragColor = vec4(color, 1.0);\n"},t.common_proceduralTexture_fragment={top:"",define:"",varDeclare:"",funcDeclare:"",funcDefine:"float rand(vec2 n) {\n	return fract(cos(dot(n, vec2(12.9898, 4.1414))) * 43758.5453);\n}\nfloat noise(vec2 n) {\n	const vec2 d = vec2(0.0, 1.0);\n	vec2 b = floor(n), f = smoothstep(vec2(0.0), vec2(1.0), fract(n));\n	return mix(mix(rand(b), rand(b + d.yx), f.x), mix(rand(b + d.xy), rand(b + d.yy), f.x), f.y);\n}\n\nfloat turbulence(vec2 P)\n{\n	float val = 0.0;\n	float freq = 1.0;\n	for (int i = 0; i < 4; i++)\n	{\n		val += abs(noise(P*freq) / freq);\n		freq *= 2.07;\n	}\n	return val;\n}\n\nfloat fbm(vec2 n) {\n	float total = 0.0, amplitude = 1.0;\n	for (int i = 0; i < 4; i++) {\n		total += noise(n) * amplitude;\n		n += n;\n		amplitude *= 0.5;\n	}\n	return total;\n}\n\nfloat round(float number){\n	return sign(number)*floor(abs(number) + 0.5);\n}\n",body:""},t.common_proceduralTexture_vertex={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nconst vec2 MADD=vec2(0.5,0.5);\n",funcDeclare:"",funcDefine:"",body:"v_texCoord=a_positionVec2*MADD+MADD;\n\n    gl_Position=vec4(a_positionVec2, 0.0 ,1.0);\n"},t.fire_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nstruct FireColor {\n    vec3 c1;\n    vec3 c2;\n    vec3 c3;\n    vec3 c4;\n    vec3 c5;\n    vec3 c6;\n};\nuniform FireColor u_fireColor;\n",funcDeclare:"",funcDefine:"",body:"vec2 p = v_texCoord * 8.0;\n	float q = fbm(p - u_time * 0.1);\n	vec2 r = vec2(fbm(p + q + u_time * u_speed.x - p.x - p.y), fbm(p + q - u_time * u_speed.y));\n	vec3 c = mix(u_fireColor.c1, u_fireColor.c2, fbm(p + r)) + mix(u_fireColor.c3, u_fireColor.c4, r.x) - mix(u_fireColor.c5, u_fireColor.c6, r.y);\n	vec3 color = c * cos(u_shift * v_texCoord.y);\n	float luminance = dot(color.rgb, vec3(0.3, 0.59, 0.11));\n\n	gl_FragColor = vec4(color, luminance * u_alphaThreshold + (1.0 - u_alphaThreshold));\n"},t.grass_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"vec3 color = mix(u_groundColor, u_herb1Color, rand(gl_FragCoord.xy * 4.0));\n	color = mix(color, u_herb2Color, rand(gl_FragCoord.xy * 8.0));\n	color = mix(color, u_herb3Color, rand(gl_FragCoord.xy));\n	color = mix(color, u_herb1Color, fbm(gl_FragCoord.xy * 16.0));\n\n	gl_FragColor = vec4(color, 1.0);\n"},t.marble_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\nconst vec3 TILE_SIZE = vec3(1.1, 1.0, 1.1);\n//const vec3 TILE_PCT = vec3(0.98, 1.0, 0.98);\n",funcDeclare:"",funcDefine:"vec3 marble_color(float x)\n{\n	vec3 col;\n	x = 0.5*(x + 1.);\n	x = sqrt(x);\n	x = sqrt(x);\n	x = sqrt(x);\n	col = vec3(.2 + .75*x);\n	col.b *= 0.95;\n	return col;\n}\n",body:"vec3 color;\n	float brickW = 1.0 / u_tilesHeightNumber;\n	float brickH = 1.0 / u_tilesWidthNumber;\n	float jointWPercentage = 0.01;\n	float jointHPercentage = 0.01;\n	float yi = v_texCoord.y / brickH;\n	float nyi = round(yi);\n	float xi = v_texCoord.x / brickW;\n\n	if (mod(floor(yi), 2.0) == 0.0){\n		xi = xi - 0.5;\n	}\n\n	float nxi = round(xi);\n	vec2 brickv_texCoord = vec2((xi - floor(xi)) / brickH, (yi - floor(yi)) / brickW);\n\n	if (yi < nyi + jointHPercentage && yi > nyi - jointHPercentage){\n		color = mix(u_jointColor, vec3(0.37, 0.25, 0.25), (yi - nyi) / jointHPercentage + 0.2);\n	}\n	else if (xi < nxi + jointWPercentage && xi > nxi - jointWPercentage){\n		color = mix(u_jointColor, vec3(0.44, 0.44, 0.44), (xi - nxi) / jointWPercentage + 0.2);\n	}\n	else {\n		float t = 6.28 * brickv_texCoord.x / (TILE_SIZE.x + noise(vec2(v_texCoord)*6.0));\n		t += u_amplitude * turbulence(brickv_texCoord.xy);\n		t = sin(t);\n		color = marble_color(t);\n	}\n\n	gl_FragColor = vec4(color, 1.0);\n"},t.road_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"float ratioy = mod(gl_FragCoord.y * 100.0 , fbm(v_texCoord * 2.0));\n	vec3 color = u_roadColor * ratioy;\n\n	gl_FragColor = vec4(color, 1.0);\n"},t.wood_proceduralTexture_fragment={top:"",define:"",varDeclare:"varying vec2 v_texCoord;\n",funcDeclare:"",funcDefine:"",body:"float ratioy = mod(v_texCoord.x * u_ampScale, 2.0 + fbm(v_texCoord * 0.8));\n	vec3 wood = u_woodColor * ratioy;\n\n	gl_FragColor = vec4(wood, 1.0);\n"
},t}();t.ShaderChunk=e}(wd||(wd={}));